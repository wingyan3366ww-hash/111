<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#8B7CF7">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ÁπîÂ§¢">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="description" content="AI‰∫íÂãïÂ∞èË™™Èñ±ËÆÄÂô® - ÂâµÂª∫‰Ω†ÁöÑÂ∞àÂ±¨ÊïÖ‰∫ã">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%238B7CF7' width='100' height='100' rx='20'/><text x='50' y='65' text-anchor='middle' fill='white' font-size='50'>Áπî</text></svg>">
  <title>ÁπîÂ§¢ - AI‰∫íÂãïÂ∞èË™™Èñ±ËÆÄÂô® v5.2</title>
  <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
:root{--primary:#8B7CF7;--primary-light:#A89CFF;--primary-dark:#6B5CE7;--bg-primary:#0F0F1A;--bg-secondary:#1A1A2E;--bg-tertiary:#252540;--bg-card:#1E1E32;--text-primary:#E5E7EB;--text-secondary:#9CA3AF;--text-tertiary:#6B7280;--divider:#2D2D44;--success:#10B981;--warning:#F59E0B;--error:#EF4444;--info:#3B82F6;--font-size:16px;--line-height:1.8}
[data-theme="light"]{--primary:#6B5CE7;--primary-light:#8B7CF7;--bg-primary:#FFFFFF;--bg-secondary:#F5F5F7;--bg-tertiary:#E8E8ED;--bg-card:#FFFFFF;--text-primary:#1A1A2E;--text-secondary:#6B7280;--text-tertiary:#9CA3AF;--divider:#E5E7EB}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,BlinkMacSystemFont,"PingFang SC",sans-serif;font-size:16px;background:#000;color:var(--text-primary);height:100vh;height:100dvh;overflow:hidden;user-select:none}
.app{width:100%;max-width:420px;height:100vh;height:100dvh;margin:0 auto;display:flex;flex-direction:column;background:var(--bg-primary);position:relative;box-shadow:0 0 50px rgba(139,124,247,0.2);overflow:hidden}
@media(min-width:421px) and (min-height:901px){.app{max-height:900px;margin-top:calc((100vh - 900px)/2);border-radius:40px}}
.app.fullscreen{max-width:100%;max-height:100%;border-radius:0;margin:0}
.status-bar{height:44px;background:var(--bg-secondary);display:flex;justify-content:space-between;align-items:center;padding:0 20px;font-size:14px;font-weight:500;flex-shrink:0}
.views{flex:1;position:relative;overflow:hidden}
.view{position:absolute;inset:0;display:flex;flex-direction:column;overflow:hidden;opacity:0;transform:translateX(100%);transition:all .3s ease;pointer-events:none;background:var(--bg-primary)}
.view.active{opacity:1;transform:translateX(0);pointer-events:auto;z-index:1}
.view.out{transform:translateX(-30%);opacity:.5;z-index:0}
.nav{height:52px;background:var(--bg-secondary);display:flex;justify-content:space-between;align-items:center;padding:0 16px;border-bottom:1px solid var(--divider);flex-shrink:0}
.nav-back{color:var(--primary);font-size:24px;cursor:pointer;padding:8px;margin:-8px}
.nav-title{font-size:17px;font-weight:600;flex:1;text-align:center}
.nav-right{display:flex;gap:4px}
.nav-btn{width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;color:var(--text-secondary);border-radius:8px;transition:all .2s}
.nav-btn:hover{color:var(--primary);background:rgba(139,124,247,.1)}
.list-nav{height:52px;background:var(--bg-secondary);display:flex;justify-content:space-between;align-items:center;padding:0 16px;border-bottom:1px solid var(--divider);flex-shrink:0}
.list-nav-title{font-size:22px;font-weight:700;background:linear-gradient(135deg,var(--primary),var(--primary-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.search-bar{padding:12px 16px;background:var(--bg-secondary);flex-shrink:0}
.search-wrap{background:var(--bg-tertiary);border-radius:10px;padding:10px 14px;display:flex;align-items:center;gap:10px}
.search-wrap:focus-within{box-shadow:0 0 0 2px var(--primary)}
.search-input{flex:1;border:none;background:transparent;font-size:15px;outline:none;color:var(--text-primary)}
.search-input::placeholder{color:var(--text-tertiary)}
.progress-wrap{padding:0 16px 8px;background:var(--bg-secondary);display:flex;align-items:center;gap:8px;flex-shrink:0}
.progress-bar{flex:1;height:4px;background:var(--bg-tertiary);border-radius:2px;overflow:hidden;cursor:pointer}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--primary-dark),var(--primary));border-radius:2px;transition:width .3s}
.progress-text{font-size:11px;color:var(--text-tertiary);min-width:32px}
.scroll{flex:1;overflow-y:auto;padding:12px 16px}
.scroll::-webkit-scrollbar{display:none}
.card{display:flex;padding:14px;background:var(--bg-card);border-radius:12px;margin-bottom:12px;cursor:pointer;transition:all .2s;position:relative;border:1px solid transparent}
.card-menu-btn{position:absolute;top:8px;right:8px;width:28px;height:28px;border-radius:50%;background:var(--bg-tertiary);display:flex;align-items:center;justify-content:center;font-size:16px;color:var(--text-secondary);opacity:0.7;transition:all .2s;z-index:2}
.card-menu-btn:hover{opacity:1;background:var(--primary);color:white}
.card:hover{transform:translateY(-2px);box-shadow:0 4px 20px rgba(139,124,247,.15)}
.card:active{transform:scale(.98)}
.card.pinned::before{content:'üìå';position:absolute;top:-6px;left:-6px;font-size:16px}
.card.selected{border-color:var(--primary)}
.card-cover{width:56px;height:70px;border-radius:8px;margin-right:12px;flex-shrink:0;background:linear-gradient(135deg,var(--primary-dark),var(--primary));display:flex;align-items:center;justify-content:center;font-size:24px;background-size:cover;background-position:center;overflow:hidden;position:relative}
.card-cover img{width:100%;height:100%;object-fit:cover}
.card-cover .cover-emoji{font-size:24px}
.upload-btn{position:absolute;bottom:4px;right:4px;width:20px;height:20px;background:rgba(0,0,0,0.6);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;cursor:pointer;opacity:0;transition:opacity 0.2s}
.card-cover:hover .upload-btn,.char-avatar:hover .upload-btn{opacity:1}
.content.has-bg{background-size:cover;background-position:center;background-attachment:fixed}
.content.has-bg::before{content:'';position:absolute;inset:0;background:rgba(15,15,26,0.85);z-index:0}
.content.has-bg .msg{position:relative;z-index:1}
.card-info{flex:1;min-width:0}
.card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px}
.card-title{font-size:15px;font-weight:600}
.card-time{font-size:11px;color:var(--text-tertiary)}
.card-preview{font-size:12px;color:var(--text-secondary);margin-bottom:6px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;line-height:1.4}
.card-meta{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.card-instruction{font-size:10px;color:var(--primary);background:rgba(139,124,247,.15);padding:2px 6px;border-radius:4px}
.card-stats{font-size:10px;color:var(--text-tertiary)}
.card-tags{display:flex;gap:4px;margin-top:4px}
.tag{font-size:9px;padding:2px 5px;border-radius:3px;background:var(--bg-tertiary);color:var(--text-secondary)}
.tab-bar{display:flex;background:var(--bg-secondary);border-top:1px solid var(--divider);padding:6px 0;padding-bottom:calc(6px + env(safe-area-inset-bottom, 0px));flex-shrink:0}
.tab-item{flex:1;display:flex;flex-direction:column;align-items:center;padding:4px 0;cursor:pointer}
.tab-item .tab-icon{font-size:20px;margin-bottom:2px;transition:transform .2s}
.tab-item .tab-label{font-size:10px;color:var(--text-tertiary)}
.tab-item.active .tab-icon{transform:scale(1.1)}
.tab-item.active .tab-label{color:var(--primary)}
.content{flex:1;overflow-y:auto;padding:16px;font-family:"Noto Serif SC",Georgia,serif;font-size:var(--font-size);line-height:var(--line-height);word-break:break-word;overflow-wrap:break-word}
.content::-webkit-scrollbar{display:none}
.content.sys{font-family:-apple-system,sans-serif;font-size:15px;line-height:1.5}
.content p{margin-bottom:16px;word-break:break-word;overflow-wrap:break-word}
.content strong{color:var(--primary-light)}
.content blockquote{border-left:3px solid var(--primary);padding-left:12px;margin:12px 0;color:var(--text-secondary);word-break:break-word;overflow-wrap:break-word}
.content pre{white-space:pre-wrap;word-break:break-word;overflow-wrap:break-word;background:var(--bg-tertiary);padding:12px;border-radius:8px;overflow-x:auto;max-width:100%}
.content code{word-break:break-all}
/* Â∞èË™™Èñ±ËÆÄÂºè UI */
.msg{margin-bottom:24px;word-break:break-word;overflow-wrap:break-word;max-width:100%}
.msg.user{margin:24px 0}
.msg-user-action{text-align:center;padding:16px 0}
.msg-user-action .action-divider{color:var(--primary);font-size:13px;margin-bottom:8px;display:flex;align-items:center;justify-content:center;gap:12px}
.msg-user-action .action-divider::before,.msg-user-action .action-divider::after{content:'';flex:1;max-width:60px;height:1px;background:linear-gradient(90deg,transparent,var(--primary),transparent)}
.msg-user-action .action-content{color:var(--primary-light);font-style:italic;font-size:calc(var(--font-size) * 0.95)}
.msg-ai-story{padding:0 4px}
.msg-ai-story p{text-indent:2em;margin-bottom:1em}
.msg-ai-story p:first-child{text-indent:0}
/* ÊîπÂñÑÈÅ∏È†ÖÂàóË°®È°ØÁ§∫ */
.msg-ai-story br{display:block;content:'';margin-top:0.5em}
.msg-ai-story ol,.msg-ai-story ul{margin:1em 0;padding-left:2em;text-indent:0}
.msg-ai-story li{margin-bottom:0.5em;text-indent:0}
/* Á¢∫‰øùÂúàËôüÈÅ∏È†ÖÊ≠£Á¢∫ÊèõË°å - ‰ΩøÁî®Êõ¥Á≤æÁ¢∫ÁöÑÈÅ∏ÊìáÂô® */
.msg-ai-story{white-space:pre-line}
.msg-timestamp{text-align:center;font-size:11px;color:var(--text-tertiary);margin-top:12px}
.msg-floor{position:absolute;right:8px;top:8px;font-size:10px;color:var(--text-tertiary);font-family:sans-serif;opacity:0.6}
.msg{position:relative}
/* Ê∂àÊÅØÊªëÂãïÊìç‰Ωú */
.msg-swipe-wrapper{position:relative;overflow:visible;margin-bottom:0}
.msg-swipe-content{transition:transform .2s ease;position:relative;z-index:1;background:var(--bg-primary)}
.msg-swipe-actions{position:absolute;top:50%;transform:translateY(-50%);height:auto;display:flex;align-items:center;gap:6px;z-index:0;pointer-events:auto}
.msg-swipe-actions.left{left:-8px;padding-left:8px}
.msg-swipe-actions.right{right:-8px;padding-right:8px}
.msg-swipe-btn{padding:10px 14px;border-radius:8px;font-size:13px;border:none;cursor:pointer;white-space:nowrap;box-shadow:0 2px 8px rgba(0,0,0,0.2);min-width:60px;text-align:center}
.msg-swipe-btn.edit{background:var(--primary);color:white}
.msg-swipe-btn.delete{background:var(--error);color:white}
.msg-swipe-btn.regen{background:var(--warning);color:white}
/* Lorebook Ê®£Âºè */
.lore-trigger-toast{position:fixed;top:60px;left:50%;transform:translateX(-50%);background:rgba(139,124,247,0.95);color:white;padding:8px 16px;border-radius:20px;font-size:12px;z-index:1001;animation:slideDown .3s ease;display:flex;align-items:center;gap:6px}
@keyframes slideDown{from{opacity:0;transform:translateX(-50%) translateY(-10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.lorebook-card{background:var(--bg-card);border-radius:12px;padding:14px;margin-bottom:12px;border-left:3px solid var(--primary)}
.lorebook-card.disabled{opacity:0.5;border-left-color:var(--text-tertiary)}
.lorebook-card-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.lorebook-card-status{width:8px;height:8px;border-radius:50%;background:var(--success)}
.lorebook-card.disabled .lorebook-card-status{background:var(--text-tertiary)}
.lorebook-card-title{flex:1;font-size:14px;font-weight:600}
.lorebook-card-lock{font-size:12px}
.lorebook-card-triggers{font-size:12px;color:var(--text-secondary);margin-bottom:6px}
.lorebook-card-stats{font-size:11px;color:var(--text-tertiary);display:flex;gap:12px}
.lorebook-card-actions{display:flex;gap:8px;margin-top:10px}
.lorebook-condition{display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-tertiary);border-radius:6px;margin-bottom:8px;flex-wrap:wrap}
.lorebook-condition select,.lorebook-condition input{padding:6px 8px;border:1px solid var(--divider);border-radius:4px;background:var(--bg-card);color:var(--text-primary);font-size:13px}
.lorebook-condition input[type="number"]{width:60px}
.time-div{display:flex;align-items:center;justify-content:center;margin:20px 0;color:var(--text-tertiary);font-size:13px;cursor:pointer}
.time-div::before,.time-div::after{content:'';flex:1;height:1px;background:var(--divider);margin:0 12px}
.typing{display:flex;align-items:center;gap:4px;padding:12px 0}
.typing-dot{width:8px;height:8px;background:var(--primary);border-radius:50%;animation:typing 1.4s infinite ease-in-out}
.typing-dot:nth-child(1){animation-delay:0s}
.typing-dot:nth-child(2){animation-delay:.2s}
.typing-dot:nth-child(3){animation-delay:.4s}
@keyframes typing{0%,60%,100%{transform:translateY(0);opacity:.4}30%{transform:translateY(-6px);opacity:1}}
@keyframes highlight{0%,100%{background:transparent}50%{background:rgba(139,124,247,0.3)}}
.typing-cursor{display:inline-block;width:2px;height:1em;background:var(--primary);margin-left:2px;animation:blink 1s infinite}
@keyframes blink{0%,50%{opacity:1}51%,100%{opacity:0}}
.quick-cmds{display:flex;gap:8px;padding:10px 16px;background:var(--bg-secondary);overflow-x:auto;border-top:1px solid var(--divider);flex-shrink:0}
.quick-cmds::-webkit-scrollbar{display:none}
.quick-cmd{padding:6px 14px;background:var(--bg-tertiary);border-radius:16px;font-size:13px;color:var(--text-secondary);white-space:nowrap;cursor:pointer;border:none;transition:all .2s}
.quick-cmd:hover{background:var(--primary);color:white}
.quick-cmd.add{background:transparent;border:1px dashed var(--text-tertiary);color:var(--text-tertiary)}
.quick-cmd-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:8px}
.quick-cmd-item .drag-handle{cursor:grab;color:var(--text-tertiary);font-size:14px}
.quick-cmd-item .cmd-info{flex:1;min-width:0}
.quick-cmd-item .cmd-label{font-size:14px;font-weight:500;color:var(--text-primary)}
.quick-cmd-item .cmd-content{font-size:11px;color:var(--text-tertiary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.quick-cmd-item .cmd-actions{display:flex;gap:6px}
.quick-cmd-item .cmd-actions button{padding:4px 8px;font-size:12px;border:none;border-radius:4px;cursor:pointer}
.quick-cmd-item .cmd-actions .edit-btn{background:var(--bg-secondary);color:var(--text-secondary)}
.quick-cmd-item .cmd-actions .del-btn{background:rgba(239,68,68,0.1);color:#ef4444}
.persona-bar{background:var(--bg-secondary);padding:8px 16px;display:flex;align-items:center;gap:8px;border-top:1px solid var(--divider);flex-shrink:0}
.persona-selector{flex:1;display:flex;align-items:center;gap:8px;padding:6px 12px;background:var(--bg-tertiary);border-radius:12px;cursor:pointer;transition:all .2s}
.persona-selector:hover{background:rgba(139,124,247,.1);box-shadow:0 0 0 1px var(--primary)}
.persona-avatar{font-size:18px}
.persona-info{flex:1;min-width:0}
.persona-label{font-size:11px;color:var(--text-tertiary)}
.persona-name{font-size:13px;color:var(--text-primary);font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.persona-dropdown{font-size:12px;color:var(--text-tertiary)}
.input-bar{background:var(--bg-secondary);padding:10px 16px;display:flex;align-items:flex-end;gap:10px;border-top:1px solid var(--divider);flex-shrink:0}
.input-wrap{flex:1;background:var(--bg-tertiary);border-radius:20px;min-height:40px;max-height:120px;display:flex;align-items:center;padding:0 16px}
.input-field{flex:1;border:none;background:transparent;padding:10px 0;font-size:15px;outline:none;color:var(--text-primary)}
.input-field::placeholder{color:var(--text-tertiary)}
.send-btn{width:40px;height:40px;background:var(--primary);border:none;border-radius:50%;color:white;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.send-btn:hover{background:var(--primary-light);transform:scale(1.05)}
.send-btn:disabled{background:var(--bg-tertiary);opacity:.5;cursor:not-allowed}
.lore-section{margin-bottom:16px}
.lore-header{display:flex;justify-content:space-between;align-items:center;padding:10px 0;cursor:pointer}
.lore-header-left{display:flex;align-items:center;gap:8px;font-size:15px;font-weight:600}
.lore-count{font-size:12px;color:var(--text-tertiary);font-weight:normal}
.lore-toggle{color:var(--text-tertiary);transition:transform .3s;font-size:12px}
.lore-toggle.collapsed{transform:rotate(-90deg)}
.lore-list{max-height:1000px;overflow:hidden;transition:all .3s ease}
.lore-list.collapsed{max-height:0;opacity:0}
.lore-item{display:flex;align-items:flex-start;padding:12px;background:var(--bg-card);border-radius:10px;margin-bottom:8px;cursor:pointer;position:relative}
.lore-actions{position:absolute;right:8px;top:50%;transform:translateY(-50%);display:flex;gap:8px;font-size:14px;opacity:0.6}
.lore-actions:hover{opacity:1}
.lore-item:hover{background:var(--bg-tertiary)}
.lore-checkbox{width:20px;height:20px;border:2px solid var(--text-tertiary);border-radius:4px;margin-right:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer}
.lore-checkbox.checked{background:var(--primary);border-color:var(--primary)}
.lore-checkbox.checked::after{content:'‚úì';color:white;font-size:12px}
.lore-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;margin-right:12px;font-size:18px;flex-shrink:0}
.lore-icon.char{background:rgba(59,130,246,.2)}
.lore-icon.loc{background:rgba(16,185,129,.2)}
.lore-icon.item{background:rgba(249,115,22,.2)}
.lore-icon.set{background:rgba(168,85,247,.2)}
.lore-content{flex:1;min-width:0}
.lore-name{font-size:14px;font-weight:600;margin-bottom:2px;display:flex;align-items:center;gap:8px}
.lore-affection{font-size:11px}
.lore-affection.pos{color:var(--success)}
.lore-affection.neg{color:var(--error)}
.lore-desc{font-size:12px;color:var(--text-secondary);margin-bottom:4px}
.lore-status{font-size:11px;color:var(--text-tertiary)}
.timeline-current{background:var(--bg-card);padding:12px 16px;border-radius:10px;margin-bottom:20px;display:flex;align-items:center;gap:8px}
.timeline-label{font-size:13px;color:var(--text-secondary)}
.timeline-value{font-size:15px;font-weight:600;color:var(--primary)}
.timeline-list{position:relative;padding-left:24px}
.timeline-list::before{content:'';position:absolute;left:8px;top:0;bottom:0;width:2px;background:var(--divider)}
.timeline-item{position:relative;margin-bottom:20px;cursor:pointer}
.timeline-item::before{content:'';position:absolute;left:-24px;top:6px;width:12px;height:12px;border-radius:50%;background:var(--bg-tertiary);border:2px solid var(--text-tertiary)}
.timeline-item.current::before{background:var(--primary);border-color:var(--primary);box-shadow:0 0 0 4px rgba(139,124,247,.2)}
.timeline-date{font-size:14px;font-weight:600;margin-bottom:6px}
.timeline-events{font-size:13px;color:var(--text-secondary)}
.timeline-event{display:flex;align-items:center;gap:6px;margin-bottom:4px}
.timeline-event-dot{width:4px;height:4px;background:var(--text-tertiary);border-radius:50%}
.tabs-bar{display:flex;background:var(--bg-secondary);padding:0 16px;flex-shrink:0;border-bottom:1px solid var(--divider)}
.tab-btn{padding:12px 20px;font-size:14px;color:var(--text-secondary);cursor:pointer;border:none;border-bottom:2px solid transparent;background:none}
.tab-btn.active{color:var(--primary);border-bottom-color:var(--primary)}
.section-title{font-size:13px;color:var(--text-tertiary);padding:12px 0;display:flex;align-items:center;gap:8px}
.f-card{background:var(--bg-card);border-radius:10px;padding:14px;margin-bottom:10px;cursor:pointer;transition:transform .2s}
.f-card:hover{transform:translateX(4px)}
.f-card.warning{border-left:3px solid var(--warning)}
.f-card.resolved{opacity:.6}
.f-card-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.f-card-icon{font-size:14px}
.f-card-title{font-size:14px;font-weight:600;flex:1}
.f-card-desc{font-size:13px;color:var(--text-secondary);margin-bottom:8px;word-break:break-word;overflow-wrap:break-word}
.f-card-meta{display:flex;align-items:center;gap:12px;font-size:11px;color:var(--text-tertiary);flex-wrap:wrap}
.save-card{background:var(--bg-card);border-radius:10px;padding:14px;margin-bottom:10px}
.save-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.save-card-title{font-size:14px;font-weight:600;display:flex;align-items:center;gap:8px}
.save-card-tag{font-size:10px;padding:2px 8px;border-radius:4px;background:var(--success);color:white}
.save-card-tag.be{background:var(--error)}
.save-card-tag.key{background:var(--warning)}
.save-card-preview{font-size:12px;color:var(--text-secondary);margin-bottom:8px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.save-card-meta{font-size:11px;color:var(--text-tertiary);display:flex;gap:12px;flex-wrap:wrap}
.save-card-actions{display:flex;gap:8px;margin-top:10px}
.action-btn{flex:1;padding:8px;border:none;border-radius:6px;font-size:12px;cursor:pointer}
.action-btn.primary{background:var(--primary);color:white}
.action-btn.secondary{background:var(--bg-tertiary);color:var(--text-secondary)}
.action-btn.danger{background:var(--error);color:white}
.font-option{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:12px 8px;background:var(--bg-tertiary);border:2px solid var(--divider);border-radius:8px;cursor:pointer;transition:all .2s;color:var(--text-primary)}
.font-option:hover{border-color:var(--primary);background:rgba(139,124,247,.1)}
.font-option.active{border-color:var(--primary);background:rgba(139,124,247,.2)}
.inst-card{background:var(--bg-card);border-radius:12px;padding:16px;margin-bottom:12px}
.inst-header{display:flex;align-items:flex-start;margin-bottom:12px}
.inst-icon{font-size:28px;margin-right:12px}
.inst-info{flex:1}
.inst-name{font-size:15px;font-weight:600;margin-bottom:4px}
.inst-meta{font-size:12px;color:var(--text-secondary)}
.inst-binding{font-size:12px;color:var(--text-tertiary);margin-top:4px}
.inst-preview{font-size:12px;color:var(--text-secondary);padding:8px;background:var(--bg-tertiary);border-radius:6px;margin-bottom:12px;max-height:60px;overflow:hidden}
.inst-actions{display:flex;gap:8px}
.settings-section{margin-bottom:24px}
.settings-section-title{font-size:13px;color:var(--text-tertiary);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.settings-card{background:var(--bg-card);border-radius:12px;overflow:hidden}
.settings-item{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--divider);cursor:pointer}
.settings-item:last-child{border-bottom:none}
.settings-item:hover{background:var(--bg-tertiary)}
.settings-item-label{font-size:15px}
.settings-item-value{font-size:14px;color:var(--text-secondary);display:flex;align-items:center;gap:4px}
.settings-item.danger .settings-item-label{color:var(--error)}
.toggle{width:44px;height:24px;background:var(--bg-tertiary);border-radius:12px;position:relative;cursor:pointer}
.toggle.active{background:var(--primary)}
.toggle::after{content:'';width:20px;height:20px;background:white;border-radius:50%;position:absolute;top:2px;left:2px;transition:left .2s}
.toggle.active::after{left:22px}
.immersive{position:fixed;inset:0;background:#0A0A12;z-index:1000;display:none;flex-direction:column}
.immersive.active{display:flex}
.immersive-content{flex:1;display:flex;align-items:center;justify-content:center;padding:40px 32px;font-family:"Noto Serif SC",serif;font-size:20px;line-height:2;color:#E5E7EB;text-align:justify;overflow-y:auto;word-break:break-word;overflow-wrap:break-word}
.immersive-footer{padding:16px 20px;display:flex;align-items:center;gap:16px;background:rgba(0,0,0,.5)}
.immersive-progress{flex:1;height:4px;background:rgba(255,255,255,.1);border-radius:2px}
.immersive-progress-fill{height:100%;background:var(--primary);border-radius:2px}
.immersive-hint{font-size:12px;color:rgba(255,255,255,.4)}
.immersive-close{width:36px;height:36px;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,.6);cursor:pointer;font-size:20px;border-radius:50%}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;opacity:0;visibility:hidden;transition:all .3s}
.overlay.active{opacity:1;visibility:visible}
.bottom-sheet{position:fixed;bottom:0;left:50%;transform:translateX(-50%) translateY(100%);width:100%;max-width:420px;background:var(--bg-secondary);border-radius:20px 20px 0 0;padding:20px;transition:transform .3s ease;z-index:101;max-height:70vh;overflow-y:auto;box-sizing:border-box}
.bottom-sheet.active{transform:translateX(-50%) translateY(0)}
.bottom-sheet-handle{width:40px;height:4px;background:var(--bg-tertiary);border-radius:2px;margin:0 auto 16px}
.bottom-sheet-title{font-size:17px;font-weight:600;margin-bottom:16px}
.sheet-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.sheet-item{text-align:center;padding:16px 8px;background:var(--bg-tertiary);border-radius:12px;cursor:pointer}
.sheet-item:hover{background:var(--primary);color:white}
.sheet-item-icon{font-size:24px;margin-bottom:6px}
.sheet-item-label{font-size:12px}
.modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(.9);background:var(--bg-secondary);border-radius:16px;padding:20px;width:calc(100% - 32px);max-width:360px;max-height:calc(100vh - 100px);overflow-y:auto;z-index:102;opacity:0;visibility:hidden;transition:all .3s;box-sizing:border-box}
.modal.active{opacity:1;visibility:visible;transform:translate(-50%,-50%) scale(1)}
.modal-title{font-size:18px;font-weight:600;margin-bottom:12px}
.modal-content{font-size:14px;color:var(--text-secondary);margin-bottom:20px;line-height:1.6;max-height:40vh;overflow-y:auto;word-break:break-word;overflow-wrap:break-word}
.modal-input{width:100%;padding:12px 16px;background:var(--bg-tertiary);border:1px solid var(--divider);border-radius:8px;font-size:15px;color:var(--text-primary);outline:none;margin-bottom:16px}
.modal-input:focus{border-color:var(--primary)}
.modal-actions{display:flex;gap:12px}
.modal-btn{flex:1;padding:12px;border:none;border-radius:8px;font-size:15px;cursor:pointer}
.modal-btn.cancel{background:var(--bg-tertiary);color:var(--text-secondary)}
.modal-btn.confirm{background:var(--primary);color:white}
.modal-btn.danger{background:var(--error);color:white}
/* v19: Ê®°ÂºèÈÅ∏ÊìáÂç°Áâá */
.mode-card{background:var(--bg-tertiary);border:2px solid var(--divider);border-radius:12px;padding:12px;text-align:center;cursor:pointer;transition:all 0.2s}
.mode-card:hover{border-color:var(--primary);background:var(--bg-secondary)}
.mode-card.active{border-color:var(--primary);background:rgba(123,97,255,0.1)}
/* v19: Ë≥áÊ∫êÈù¢Êùø */
.sim-resource-bar{display:flex;gap:12px;padding:10px 16px;background:var(--bg-secondary);border-bottom:1px solid var(--divider);overflow-x:auto;flex-wrap:wrap}
.sim-resource-item{display:flex;align-items:center;gap:4px;font-size:13px;white-space:nowrap}
.sim-resource-icon{font-size:16px}
.sim-resource-value{font-weight:600;color:var(--text-primary)}
.sim-resource-name{color:var(--text-secondary);font-size:11px}
.sim-resource-change{font-size:11px;margin-left:2px}
.sim-resource-change.up{color:var(--success)}
.sim-resource-change.down{color:var(--error)}
.sim-day-badge{background:var(--primary);color:white;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:600}
.context-menu{position:fixed;background:var(--bg-card);border-radius:12px;padding:8px 0;box-shadow:0 4px 20px rgba(0,0,0,.4);z-index:200;min-width:160px;opacity:0;visibility:hidden;transform:scale(.95);transition:all .2s}
.context-menu.active{opacity:1;visibility:visible;transform:scale(1)}
.context-menu-item{padding:12px 16px;font-size:14px;cursor:pointer;display:flex;align-items:center;gap:10px}
.context-menu-item:hover{background:var(--bg-tertiary)}
.context-menu-item.danger{color:var(--error)}
.context-menu-divider{height:1px;background:var(--divider);margin:4px 0}
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--bg-card);color:var(--text-primary);padding:12px 20px;border-radius:8px;font-size:14px;box-shadow:0 4px 20px rgba(0,0,0,.3);opacity:0;transition:all .3s;z-index:300;display:flex;align-items:center;gap:8px}
.toast.active{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.success{border-left:3px solid var(--success)}
.toast.error{border-left:3px solid var(--error)}
.toast.warning{border-left:3px solid var(--warning)}
.loading{position:fixed;inset:0;background:rgba(15,15,26,.8);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:500;opacity:0;visibility:hidden;transition:all .3s}
.loading.active{opacity:1;visibility:visible}
.loading-spinner{width:40px;height:40px;border:3px solid var(--bg-tertiary);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{margin-top:16px;font-size:14px;color:var(--text-secondary)}
.empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;text-align:center}
.empty-icon{font-size:64px;opacity:.5;margin-bottom:16px}
.empty-title{font-size:18px;font-weight:600;margin-bottom:8px}
.empty-desc{font-size:14px;color:var(--text-secondary);margin-bottom:24px;max-width:260px}
.empty-btn{padding:12px 24px;background:var(--primary);color:white;border:none;border-radius:8px;font-size:15px;cursor:pointer}
.api-card{background:var(--bg-card);border-radius:12px;padding:16px;margin-bottom:12px;border:2px solid transparent;cursor:pointer}
.api-card:hover{background:var(--bg-tertiary)}
.api-card.active{border-color:var(--primary)}
.api-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.api-name{font-size:15px;font-weight:600}
.api-badge{font-size:10px;padding:2px 8px;background:var(--primary);color:white;border-radius:4px}
.api-info{font-size:12px;color:var(--text-secondary)}
.form-group{margin-bottom:16px}
.form-label{display:block;font-size:13px;color:var(--text-secondary);margin-bottom:6px}
.form-input{width:100%;padding:12px 16px;background:var(--bg-tertiary);border:1px solid var(--divider);border-radius:8px;font-size:15px;color:var(--text-primary);outline:none}
.form-input:focus{border-color:var(--primary)}
.form-select{width:100%;padding:12px 16px;background:var(--bg-tertiary);border:1px solid var(--divider);border-radius:8px;font-size:15px;color:var(--text-primary);outline:none;cursor:pointer;appearance:none}
.form-textarea{width:100%;padding:12px 16px;background:var(--bg-tertiary);border:1px solid var(--divider);border-radius:8px;font-size:14px;color:var(--text-primary);outline:none;resize:vertical;min-height:80px;font-family:inherit;line-height:1.5}
.form-textarea:focus{border-color:var(--primary)}
.hidden{display:none!important}
/* PWA ÂÆâË£ùÊ©´ÂπÖÂãïÁï´ */
#install-banner>div{animation:slideUp .3s ease}
@keyframes slideUp{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}
/* ÊñáÂ≠óÊ∫¢Âá∫‰øÆÂæ© */
.scroll{word-break:break-word;overflow-wrap:break-word}
.lore-desc,.lore-name,.inst-preview,.card-preview,.save-card-preview{word-break:break-word;overflow-wrap:break-word}
/* ====== v7 ËßíËâ≤Âç°ÁâáÁ≥ªÁµ± CSS ====== */
.char-card{background:var(--bg-card);border-radius:16px;margin-bottom:12px;border:1px solid var(--divider);overflow:hidden;transition:all .3s}
.char-card.expanded{box-shadow:0 8px 32px rgba(139,124,247,.15)}
.char-header{display:flex;align-items:center;padding:14px;cursor:pointer;transition:background .2s}
.char-header:active{background:rgba(255,255,255,.03)}
.char-avatar{width:52px;height:52px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--primary-light));display:flex;align-items:center;justify-content:center;font-size:22px;margin-right:12px;flex-shrink:0;position:relative;background-size:cover;background-position:center;overflow:hidden;cursor:pointer}
.char-avatar img{width:100%;height:100%;object-fit:cover}
.char-avatar-rank{position:absolute;bottom:-4px;right:-4px;background:var(--warning);color:#000;font-size:9px;padding:2px 6px;border-radius:8px;font-weight:600}
.char-info{flex:1;min-width:0}
.char-name{font-size:16px;font-weight:600;display:flex;align-items:center;gap:8px}
.char-title{font-size:10px;background:linear-gradient(135deg,#d4a574,#e8c9a0);color:#000;padding:2px 8px;border-radius:4px;font-weight:500}
.char-brief{font-size:12px;color:var(--text-secondary);margin-top:3px}
.char-quick{display:flex;gap:10px;margin-top:6px}
.char-quick-item{display:flex;align-items:center;gap:3px;font-size:11px}
.char-quick-val{font-weight:600}
.char-expand{width:28px;height:28px;border-radius:50%;background:var(--bg-secondary);display:flex;align-items:center;justify-content:center;transition:transform .3s;flex-shrink:0;font-size:12px}
.char-card.expanded .char-expand{transform:rotate(180deg)}
.char-content{max-height:0;overflow:hidden;transition:max-height .4s ease}
.char-card.expanded .char-content{max-height:800px}
.char-inner{padding:0 14px 14px}
.char-tabs{display:flex;gap:4px;background:var(--bg-secondary);padding:4px;border-radius:10px;margin-bottom:12px}
.char-tab{flex:1;padding:8px;border-radius:8px;font-size:12px;text-align:center;cursor:pointer;transition:all .2s;color:var(--text-secondary)}
.char-tab.active{background:var(--primary);color:white;font-weight:500}
.char-tab-content{display:none;animation:fadeIn .3s}
.char-tab-content.active{display:block}
@keyframes charFadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.char-section{margin-bottom:14px}
.char-section-title{font-size:11px;color:var(--text-tertiary);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.char-section-title::after{content:'';flex:1;height:1px;background:var(--divider)}
.char-stat-bar{margin-bottom:10px}
.char-stat-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.char-stat-label{font-size:12px;color:var(--text-secondary);display:flex;align-items:center;gap:4px}
.char-stat-value{font-size:13px;font-weight:600}
.char-stat-track{height:5px;background:var(--bg-secondary);border-radius:3px;overflow:hidden}
.char-stat-fill{height:100%;border-radius:3px;transition:width .5s}
.char-stat-fill.purple{background:linear-gradient(90deg,#8b5cf6,#a78bfa)}
.char-stat-fill.gold{background:linear-gradient(90deg,#d4a574,#e8c9a0)}
.char-stat-fill.blue{background:linear-gradient(90deg,#3b82f6,#60a5fa)}
.char-stat-fill.red{background:linear-gradient(90deg,#ef4444,#f87171)}
.char-stat-fill.green{background:linear-gradient(90deg,#22c55e,#4ade80)}
.char-stat-fill.pink{background:linear-gradient(90deg,#ec4899,#f472b6)}
.char-favor{background:var(--bg-secondary);border-radius:12px;padding:12px;margin-bottom:10px}
.char-favor-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.char-favor-title{font-size:13px;font-weight:500}
.char-favor-level{font-size:11px;color:var(--warning);background:rgba(245,158,11,.15);padding:3px 8px;border-radius:10px}
.char-favor-item{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.char-favor-item:last-child{margin-bottom:0}
.char-favor-icon{width:26px;height:26px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0}
.char-favor-icon.surface{background:rgba(139,124,247,.2)}
.char-favor-icon.real{background:rgba(239,68,68,.2)}
.char-favor-info{flex:1}
.char-favor-label{font-size:11px;color:var(--text-secondary)}
.char-favor-track{height:4px;background:rgba(255,255,255,.1);border-radius:2px;margin-top:3px;overflow:hidden}
.char-favor-fill{height:100%;border-radius:2px;transition:width .5s}
.char-favor-fill.surface{background:var(--primary)}
.char-favor-fill.real{background:var(--error)}
.char-favor-fill.true{background:var(--success)}
.char-favor-val{font-size:13px;font-weight:600;min-width:28px;text-align:right}
.char-desc{font-size:12px;line-height:1.6;color:var(--text-secondary);background:var(--bg-secondary);padding:12px;border-radius:10px;border-left:3px solid var(--primary)}
.char-tags{display:flex;flex-wrap:wrap;gap:5px;margin-top:10px}
.char-tag{font-size:10px;padding:4px 8px;border-radius:10px;background:var(--bg-secondary);color:var(--text-secondary)}
.char-tag.danger{background:rgba(239,68,68,.15);color:#f87171}
.char-tag.warning{background:rgba(234,179,8,.15);color:#fbbf24}
.char-tag.info{background:rgba(59,130,246,.15);color:#60a5fa}
.char-tag.success{background:rgba(34,197,94,.15);color:#4ade80}
.char-mini-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:10px}
.char-mini-stat{background:var(--bg-secondary);padding:8px;border-radius:8px;text-align:center}
.char-mini-val{font-size:16px;font-weight:600}
.char-mini-label{font-size:10px;color:var(--text-tertiary);margin-top:2px}
.char-relation{display:flex;align-items:center;padding:10px;background:var(--bg-secondary);border-radius:10px;margin-bottom:8px}
.char-relation-avatar{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#3b82f6,#60a5fa);display:flex;align-items:center;justify-content:center;font-size:16px;margin-right:10px}
.char-relation-info{flex:1}
.char-relation-name{font-size:13px;font-weight:500}
.char-relation-type{font-size:11px;color:var(--text-secondary)}
.char-relation-status{font-size:10px;padding:3px 8px;border-radius:10px}
.char-relation-status.ally{background:rgba(34,197,94,.2);color:var(--success)}
.char-relation-status.enemy{background:rgba(239,68,68,.2);color:var(--error)}
.char-relation-status.neutral{background:rgba(255,255,255,.1);color:var(--text-secondary)}
.char-actions{display:flex;gap:8px;margin-top:12px}
.char-action-btn{flex:1;padding:10px;border-radius:10px;border:none;font-size:12px;cursor:pointer;transition:all .2s}
.char-action-btn.primary{background:var(--primary);color:white}
.char-action-btn.secondary{background:var(--bg-secondary);color:var(--text-primary)}
.char-action-btn:active{transform:scale(.97)}
/* Êï∏ÂÄºËÆäÂåñÂãïÁï´ */
.char-value-change{position:fixed;font-size:14px;font-weight:600;animation:charFloatUp 1.5s ease forwards;pointer-events:none;z-index:9999}
.char-value-change.up{color:var(--success)}
.char-value-change.down{color:var(--error)}
@keyframes charFloatUp{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-24px)}}
/* ËßíËâ≤ÂàóË°®Á©∫ÁãÄÊÖã */
.char-empty{text-align:center;padding:40px 20px;color:var(--text-secondary)}
.char-empty-icon{font-size:48px;margin-bottom:12px}
.char-empty-title{font-size:15px;font-weight:500;margin-bottom:6px;color:var(--text-primary)}
.char-empty-desc{font-size:13px}
/* ËßíËâ≤Êõ¥Êñ∞‰∏≠ÊèêÁ§∫ */
.char-updating{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.8);padding:12px 20px;border-radius:12px;font-size:13px;display:flex;align-items:center;gap:8px}
.char-updating-spin{width:16px;height:16px;border:2px solid var(--primary);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite}
/* Êåá‰ª§ÁîüÊàêÂêëÂ∞éÊ®£Âºè */
.wizard-progress{display:flex;align-items:center;padding:16px;background:var(--bg-secondary);border-bottom:1px solid var(--divider)}
.wizard-progress-bar{flex:1;height:6px;background:var(--bg-tertiary);border-radius:3px;overflow:hidden;margin-right:12px}
.wizard-progress-fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--primary-light));border-radius:3px;transition:width .3s}
.wizard-progress-text{font-size:12px;color:var(--text-secondary);white-space:nowrap}
.wizard-content{flex:1;overflow-y:auto;padding:16px}
.wizard-section{margin-bottom:24px}
.wizard-section-title{font-size:16px;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.wizard-section-desc{font-size:13px;color:var(--text-secondary);margin-bottom:16px;line-height:1.6}
.wizard-options{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px}
.wizard-option{padding:10px 16px;background:var(--bg-tertiary);border:2px solid transparent;border-radius:10px;font-size:14px;cursor:pointer;transition:all .2s}
.wizard-option:hover{border-color:var(--primary-light)}
.wizard-option.selected{background:rgba(139,124,247,.2);border-color:var(--primary);color:var(--primary-light)}
.wizard-option.template{display:flex;flex-direction:column;padding:16px;min-width:calc(50% - 4px)}
.wizard-option.template .template-icon{font-size:28px;margin-bottom:8px}
.wizard-option.template .template-name{font-weight:600;margin-bottom:4px}
.wizard-option.template .template-desc{font-size:11px;color:var(--text-tertiary)}
.wizard-input{width:100%;padding:12px 16px;background:var(--bg-tertiary);border:1px solid var(--divider);border-radius:10px;font-size:14px;color:var(--text-primary);outline:none;margin-bottom:12px}
.wizard-input:focus{border-color:var(--primary)}
.wizard-textarea{min-height:100px;resize:vertical;font-family:inherit;line-height:1.6}
.wizard-ai-box{background:var(--bg-card);border-radius:12px;padding:16px;margin-top:16px;border-left:3px solid var(--primary)}
.wizard-ai-header{display:flex;align-items:center;gap:8px;margin-bottom:12px;font-size:13px;color:var(--primary-light)}
.wizard-ai-content{font-size:14px;line-height:1.7;color:var(--text-secondary)}
.wizard-ai-options{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
.wizard-ai-btn{padding:8px 16px;background:var(--bg-tertiary);border:none;border-radius:8px;font-size:13px;color:var(--text-primary);cursor:pointer;transition:all .2s}
.wizard-ai-btn:hover{background:var(--primary);color:white}
.wizard-ai-btn.loading{opacity:.6;pointer-events:none}
.wizard-char-list{margin-top:16px}
.wizard-char-card{background:var(--bg-card);border-radius:10px;padding:12px;margin-bottom:8px;display:flex;align-items:center;gap:12px}
.wizard-char-avatar{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--primary-light));display:flex;align-items:center;justify-content:center;font-size:18px}
.wizard-char-info{flex:1}
.wizard-char-name{font-size:14px;font-weight:600}
.wizard-char-role{font-size:12px;color:var(--text-secondary)}
.wizard-char-actions{display:flex;gap:8px}
.wizard-char-btn{width:28px;height:28px;border-radius:6px;background:var(--bg-tertiary);border:none;font-size:12px;cursor:pointer}
.wizard-example{background:var(--bg-tertiary);border-radius:10px;padding:12px;margin-top:12px;font-size:13px;color:var(--text-secondary);line-height:1.6;max-height:150px;overflow-y:auto}
.wizard-example-title{font-size:12px;color:var(--text-tertiary);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.wizard-footer{display:flex;gap:12px;padding:16px;background:var(--bg-secondary);border-top:1px solid var(--divider)}
.wizard-btn{flex:1;padding:14px;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;transition:all .2s}
.wizard-btn.primary{background:var(--primary);color:white}
.wizard-btn.secondary{background:var(--bg-tertiary);color:var(--text-secondary)}
.wizard-btn:disabled{opacity:.5;cursor:not-allowed}
.wizard-btn:active:not(:disabled){transform:scale(.98)}
.wizard-preview{background:var(--bg-card);border-radius:12px;padding:16px;margin-top:16px}
.wizard-preview-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.wizard-preview-title{font-size:14px;font-weight:600}
.wizard-preview-stats{font-size:12px;color:var(--text-tertiary)}
.wizard-preview-content{background:var(--bg-tertiary);border-radius:8px;padding:12px;font-size:13px;line-height:1.7;max-height:300px;overflow-y:auto;white-space:pre-wrap;font-family:monospace}
.wizard-chat{display:flex;flex-direction:column;gap:12px;margin-top:16px}
.wizard-chat-msg{max-width:85%;padding:12px 16px;border-radius:16px;font-size:14px;line-height:1.6}
.wizard-chat-msg.ai{background:var(--bg-card);border-bottom-left-radius:4px;align-self:flex-start}
.wizard-chat-msg.user{background:var(--primary);color:white;border-bottom-right-radius:4px;align-self:flex-end}
.wizard-chat-input{display:flex;gap:8px;margin-top:12px}
.wizard-chat-field{flex:1;padding:12px 16px;background:var(--bg-tertiary);border:none;border-radius:20px;font-size:14px;color:var(--text-primary);outline:none}
.wizard-chat-send{width:40px;height:40px;background:var(--primary);border:none;border-radius:50%;color:white;font-size:16px;cursor:pointer}
/* Prompt ÂàÜÊûêÂäüËÉΩÊ®£Âºè */
.analyze-import{display:flex;gap:12px;margin-bottom:16px}
.analyze-import-btn{flex:1;padding:40px 16px;background:var(--bg-card);border:2px dashed var(--divider);border-radius:12px;cursor:pointer;text-align:center;transition:all .2s}
.analyze-import-btn:hover{border-color:var(--primary);background:rgba(139,124,247,.05)}
.analyze-import-btn .icon{font-size:32px;margin-bottom:8px}
.analyze-import-btn .label{font-size:14px;color:var(--text-secondary)}
.analyze-textarea{width:100%;min-height:200px;padding:16px;background:var(--bg-tertiary);border:1px solid var(--divider);border-radius:12px;font-size:14px;color:var(--text-primary);font-family:monospace;line-height:1.6;resize:vertical;outline:none}
.analyze-textarea:focus{border-color:var(--primary)}
.analyze-stats{display:flex;gap:16px;margin:16px 0;padding:12px 16px;background:var(--bg-card);border-radius:10px}
.analyze-stat{text-align:center}
.analyze-stat-value{font-size:20px;font-weight:700;color:var(--primary)}
.analyze-stat-label{font-size:11px;color:var(--text-tertiary)}
.analyze-score{text-align:center;padding:24px;background:var(--bg-card);border-radius:16px;margin-bottom:20px}
.analyze-score-ring{width:120px;height:120px;margin:0 auto 12px;position:relative}
.analyze-score-ring svg{transform:rotate(-90deg)}
.analyze-score-ring circle{fill:none;stroke-width:8}
.analyze-score-ring .bg{stroke:var(--bg-tertiary)}
.analyze-score-ring .fill{stroke:var(--primary);stroke-linecap:round;transition:stroke-dashoffset .5s}
.analyze-score-value{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.analyze-score-num{font-size:36px;font-weight:700}
.analyze-score-label{font-size:12px;color:var(--text-tertiary)}
.analyze-score-text{font-size:14px;color:var(--text-secondary)}
.analyze-modules{margin-bottom:20px}
.analyze-module{background:var(--bg-card);border-radius:12px;margin-bottom:8px;overflow:hidden}
.analyze-module-header{display:flex;align-items:center;padding:14px 16px;cursor:pointer}
.analyze-module-icon{font-size:18px;margin-right:10px}
.analyze-module-name{flex:1;font-size:14px;font-weight:500}
.analyze-module-score{display:flex;align-items:center;gap:8px}
.analyze-module-bar{width:60px;height:6px;background:var(--bg-tertiary);border-radius:3px;overflow:hidden}
.analyze-module-bar-fill{height:100%;border-radius:3px;transition:width .3s}
.analyze-module-bar-fill.high{background:var(--success)}
.analyze-module-bar-fill.medium{background:var(--warning)}
.analyze-module-bar-fill.low{background:var(--error)}
.analyze-module-num{font-size:13px;font-weight:600;min-width:28px;text-align:right}
.analyze-module-status{font-size:14px;margin-left:4px}
.analyze-module-body{padding:0 16px 14px;display:none}
.analyze-module.expanded .analyze-module-body{display:block}
.analyze-module-issues{margin-bottom:12px}
.analyze-issue{display:flex;align-items:flex-start;gap:8px;padding:8px 0;border-bottom:1px solid var(--divider);font-size:13px}
.analyze-issue:last-child{border-bottom:none}
.analyze-issue-icon{flex-shrink:0}
.analyze-issue-text{flex:1;color:var(--text-secondary);line-height:1.5}
.analyze-module-actions{display:flex;gap:8px}
.analyze-module-btn{padding:8px 16px;background:var(--bg-tertiary);border:none;border-radius:8px;font-size:13px;color:var(--text-primary);cursor:pointer;transition:all .2s}
.analyze-module-btn:hover{background:var(--primary);color:white}
.analyze-module-btn.primary{background:var(--primary);color:white}
.analyze-suggestions{background:var(--bg-card);border-radius:12px;padding:16px;margin-bottom:20px;border-left:3px solid var(--primary)}
.analyze-suggestions-title{font-size:14px;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.analyze-suggestions-content{font-size:14px;line-height:1.7;color:var(--text-secondary)}
.analyze-compare{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px}
.analyze-compare-col{background:var(--bg-tertiary);border-radius:10px;padding:12px;max-height:300px;overflow-y:auto}
.analyze-compare-title{font-size:12px;font-weight:600;margin-bottom:8px;color:var(--text-tertiary);display:flex;align-items:center;gap:6px}
.analyze-compare-content{font-size:12px;line-height:1.6;white-space:pre-wrap;font-family:monospace;color:var(--text-secondary)}
.analyze-compare-content .added{background:rgba(16,185,129,.2);color:var(--success)}
.analyze-compare-content .removed{background:rgba(239,68,68,.2);color:var(--error);text-decoration:line-through}
.analyze-actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:16px}
.analyze-chat{margin-top:20px;padding-top:20px;border-top:1px solid var(--divider)}
/* Ê∂àÊÅØÁãÄÊÖãÂç°ÁâáÊ®£Âºè */
.msg-story{line-height:1.8}
.msg-status-section{margin-top:16px;border-top:1px solid var(--divider);padding-top:12px}
.msg-status-header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--bg-tertiary);border-radius:10px;cursor:pointer;transition:all .2s}
.msg-status-header:hover{background:var(--bg-card)}
.msg-status-header .title{display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500;color:var(--text-secondary)}
.msg-status-header .toggle{font-size:12px;color:var(--text-tertiary);transition:transform .2s}
.msg-status-header.expanded .toggle{transform:rotate(180deg)}
.msg-status-cards{display:none;margin-top:10px;gap:10px}
.msg-status-header.expanded+.msg-status-cards{display:flex;flex-direction:column}
.status-card{background:var(--bg-card);border-radius:12px;padding:14px;border:1px solid var(--divider)}
.status-card-header{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.status-card-avatar{width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--primary-light));display:flex;align-items:center;justify-content:center;font-size:20px;color:white;flex-shrink:0}
.status-card-avatar img{width:100%;height:100%;object-fit:cover;border-radius:10px}
.status-card-info{flex:1;min-width:0}
.status-card-name{font-size:15px;font-weight:600;display:flex;align-items:center;gap:6px}
.status-card-title{font-size:12px;color:var(--primary-light);background:rgba(139,124,247,.15);padding:2px 8px;border-radius:4px}
.status-card-meta{font-size:12px;color:var(--text-tertiary);margin-top:2px}
.status-card-stats{display:flex;flex-direction:column;gap:8px}
.status-stat-row{display:flex;align-items:center;gap:10px}
.status-stat-label{font-size:12px;color:var(--text-secondary);min-width:70px}
.status-stat-bar{flex:1;height:6px;background:var(--bg-tertiary);border-radius:3px;overflow:hidden}
.status-stat-fill{height:100%;border-radius:3px;transition:width .3s}
.status-stat-fill.high{background:linear-gradient(90deg,var(--success),#34d399)}
.status-stat-fill.medium{background:linear-gradient(90deg,var(--warning),#fbbf24)}
.status-stat-fill.low{background:linear-gradient(90deg,var(--error),#f87171)}
.status-stat-fill.primary{background:linear-gradient(90deg,var(--primary),var(--primary-light))}
.status-stat-value{font-size:12px;font-weight:600;min-width:28px;text-align:right}
.status-card-footer{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;padding-top:10px;border-top:1px solid var(--divider)}
.status-tag{font-size:11px;padding:3px 8px;background:var(--bg-tertiary);border-radius:4px;color:var(--text-secondary)}
.status-tag.mood{background:rgba(59,130,246,.15);color:var(--info)}
.status-tag.note{background:rgba(245,158,11,.15);color:var(--warning)}
.msg-format-warning{display:flex;align-items:center;gap:8px;padding:10px 14px;background:rgba(245,158,11,.1);border-radius:8px;margin-top:12px;font-size:12px;color:var(--warning)}
.msg-format-warning .icon{font-size:16px}
  </style>
</head>
<body>
<div class="app" id="app">
  <div class="status-bar">
    <span id="status-time">09:41</span>
    <div style="display:flex;gap:4px;font-size:12px"><span>üì∂</span><span>üîã</span></div>
  </div>
  <div class="views">
    <!-- ÊïÖ‰∫ãÂàóË°® -->
    <div class="view active" id="view-stories">
      <div class="list-nav">
        <span class="list-nav-title">ÁπîÂ§¢</span>
        <div style="display:flex;gap:4px">
          <div class="nav-btn" onclick="toggleScreen()" title="ÂàáÊèõÊ®°Âºè">üñ•Ô∏è</div>
          <div class="nav-btn" onclick="createStory()" title="Êñ∞Âª∫">‚ûï</div>
        </div>
      </div>
      <div class="search-bar">
        <div class="search-wrap">
          <span style="color:var(--text-tertiary)">üîç</span>
          <input type="text" class="search-input" placeholder="ÊêúÁ¥¢ÊïÖ‰∫ã" id="story-search" oninput="filterStories()">
        </div>
      </div>
      <div class="scroll" id="story-list"></div>
      <div class="tab-bar">
        <div class="tab-item active" onclick="switchTab('stories')"><span class="tab-icon">üìö</span><span class="tab-label">ÊïÖ‰∫ã</span></div>
        <div class="tab-item" onclick="switchTab('instructions')"><span class="tab-icon">üìú</span><span class="tab-label">Êåá‰ª§</span></div>
        <div class="tab-item" onclick="switchTab('settings')"><span class="tab-icon">‚öôÔ∏è</span><span class="tab-label">Ë®≠ÁΩÆ</span></div>
      </div>
    </div>
    <!-- Èñ±ËÆÄÈ†Å -->
    <div class="view" id="view-reading">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">‚Äπ</div>
        <span class="nav-title" id="reading-title">ÊïÖ‰∫ã</span>
        <div class="nav-right">
          <div class="nav-btn" onclick="goTo('view-characters')" title="ËßíËâ≤ÁãÄÊÖã" id="btn-characters">üë•</div>
          <div class="nav-btn" onclick="goTo('view-lore')" title="Ë≥áÊñôÂ∫´">üìñ</div>
          <div class="nav-btn" onclick="goTo('view-search')" title="ÊêúÁ¥¢">üîç</div>
          <div class="nav-btn" onclick="showSheet()" title="Ë®≠ÁΩÆ">‚öôÔ∏è</div>
          <div class="nav-btn" onclick="showMore(event)" title="Êõ¥Â§ö">‚ãØ</div>
        </div>
      </div>
      <!-- v19: Á∂ìÁáüÊ®°ÂºèË≥áÊ∫êÈù¢Êùø -->
      <div class="sim-resource-bar" id="sim-resource-bar" style="display:none">
        <div class="sim-day-badge" id="sim-day-badge">üìÖ Á¨¨ 1 Â§©</div>
        <!-- Ë≥áÊ∫êÈ†ÖÁõÆÂãïÊÖãÊ∏≤Êüì -->
      </div>
      <div class="progress-wrap">
        <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
        <span class="progress-text" id="progress-text">0%</span>
      </div>
      <div class="content" id="content-area"></div>
      <div class="quick-cmds" id="quick-cmds">
        <!-- ÂãïÊÖãÊ∏≤Êüì -->
      </div>
      <div class="persona-bar">
        <div class="persona-selector" onclick="showPersonaSelector()">
          <span class="persona-avatar" id="current-persona-avatar">üë§</span>
          <div class="persona-info">
            <div class="persona-label">Áï∂ÂâçË∫´‰ªΩ</div>
            <div class="persona-name" id="current-persona-name">ÁÑ°ÁâπÂÆöË∫´‰ªΩ</div>
          </div>
          <span class="persona-dropdown">‚ñº</span>
        </div>
      </div>
      <div class="input-bar">
        <div class="input-wrap"><input type="text" class="input-field" id="user-input" placeholder="Ëº∏ÂÖ•‰Ω†ÁöÑË°åÂãïÊàñÂ∞çË©±..." onkeydown="handleInputKey(event)"></div>
        <button class="send-btn" id="send-btn" onclick="send()">‚Üë</button>
      </div>
    </div>
    <!-- Ë≥áÊñôÂ∫´ -->
    <div class="view" id="view-lore">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">‚Äπ</div>
        <span class="nav-title">‰∏ñÁïåËßÄË≥áÊñôÂ∫´</span>
        <div class="nav-right">
          <div class="nav-btn" onclick="aiExtractLore()">ü§ñ</div>
          <div class="nav-btn" onclick="addLore()">‚ûï</div>
        </div>
      </div>
      <div class="search-bar">
        <div class="search-wrap">
          <span style="color:var(--text-tertiary)">üîç</span>
          <input type="text" class="search-input" placeholder="ÊêúÁ¥¢Ë≥áÊñô" id="lore-search" oninput="filterLore()">
        </div>
      </div>
      <div class="scroll sys" id="lore-list"></div>
      <div class="input-bar" style="justify-content:center">
        <span style="font-size:12px;color:var(--text-tertiary)" id="lore-count">Â∑≤ÈÅ∏ 0 È†Ö</span>
      </div>
    </div>
    <!-- ÊôÇÈñìËª∏ -->
    <div class="view" id="view-timeline">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">‚Äπ</div>
        <span class="nav-title">ÊïÖ‰∫ãÊôÇÈñìËª∏</span>
        <div class="nav-right">
          <div class="nav-btn" onclick="addTimeline()">‚ûï</div>
          <div class="nav-btn" onclick="timeJump()">‚è≠Ô∏è</div>
        </div>
      </div>
      <div class="scroll sys" id="timeline-content"></div>
    </div>
    <!-- ‰ºèÁ≠Ü/‰∫ã‰ª∂ -->
    <div class="view" id="view-foreshadow">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">‚Äπ</div>
        <span class="nav-title">‰ºèÁ≠ÜËàá‰∫ã‰ª∂</span>
        <div class="nav-right">
          <div class="nav-btn" onclick="aiAnalyzeForeshadow()">ü§ñ</div>
          <div class="nav-btn" onclick="addForeshadowOrEvent()">‚ûï</div>
        </div>
      </div>
      <div class="tabs-bar">
        <button class="tab-btn active" onclick="switchFTab('foreshadow',this)">‰ºèÁ≠Ü</button>
        <button class="tab-btn" onclick="switchFTab('events',this)">‰∫ã‰ª∂</button>
      </div>
      <div class="scroll sys" id="foreshadow-content"></div>
    </div>
    <!-- Â≠òÊ™î -->
    <div class="view" id="view-saves">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">‚Äπ</div>
        <span class="nav-title">Â≠òÊ™îÁÆ°ÁêÜ</span>
        <div class="nav-right"><div class="nav-btn" onclick="toast('Â≠òÊ™îË®≠ÁΩÆ')">‚öôÔ∏è</div></div>
      </div>
      <div class="scroll sys" id="saves-content"></div>
      <div class="input-bar"><button class="action-btn primary" style="flex:1" onclick="createSave()">üíæ ÂâµÂª∫Êñ∞Â≠òÊ™î</button></div>
    </div>
    <!-- ÊêúÁ¥¢ -->
    <div class="view" id="view-search">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">‚Äπ</div>
        <span class="nav-title">ÊêúÁ¥¢</span>
        <div class="nav-right"><div class="nav-btn" style="font-size:13px;width:auto;padding:0 8px" onclick="showAdvancedSearch()">È´òÁ¥ö</div></div>
      </div>
      <div class="search-bar">
        <div class="search-wrap">
          <span style="color:var(--text-tertiary)">üîç</span>
          <input type="text" class="search-input" placeholder="ÊêúÁ¥¢ÊïÖ‰∫ãÂÖßÂÆπ" id="content-search" oninput="doContentSearch()">
        </div>
      </div>
      <div class="scroll sys" id="search-results"><div class="empty"><div class="empty-icon">üîç</div><div class="empty-title">Ëº∏ÂÖ•ÈóúÈçµË©ûÊêúÁ¥¢</div></div></div>
    </div>
    <!-- Êåá‰ª§ÁÆ°ÁêÜ -->
    <div class="view" id="view-instructions">
      <div class="list-nav">
        <span class="list-nav-title" style="background:none;-webkit-text-fill-color:var(--text-primary)">Êåá‰ª§ÁÆ°ÁêÜ</span>
        <div style="display:flex;gap:4px">
          <div class="nav-btn" onclick="startAnalyze()" title="ÂàÜÊûêPrompt">üîç</div>
          <div class="nav-btn" onclick="startWizard()" title="AIÁîüÊàêÊåá‰ª§">ü™Ñ</div>
          <div class="nav-btn" onclick="importInst()">‚ûï</div>
        </div>
      </div>
      <div class="scroll sys" id="inst-list"></div>
      <div class="tab-bar">
        <div class="tab-item" onclick="switchTab('stories')"><span class="tab-icon">üìö</span><span class="tab-label">ÊïÖ‰∫ã</span></div>
        <div class="tab-item active" onclick="switchTab('instructions')"><span class="tab-icon">üìú</span><span class="tab-label">Êåá‰ª§</span></div>
        <div class="tab-item" onclick="switchTab('settings')"><span class="tab-icon">‚öôÔ∏è</span><span class="tab-label">Ë®≠ÁΩÆ</span></div>
      </div>
    </div>
    <!-- Ë®≠ÁΩÆ -->
    <div class="view" id="view-settings">
      <div class="list-nav">
        <span class="list-nav-title" style="background:none;-webkit-text-fill-color:var(--text-primary)">Ë®≠ÁΩÆ</span>
      </div>
      <div class="scroll sys" style="padding-bottom:80px">
        <div class="settings-section">
          <div class="settings-section-title">üé® Â§ñËßÄ</div>
          <div class="settings-card">
            <div class="settings-item" onclick="toggleTheme()"><span class="settings-item-label">‰∏ªÈ°å</span><span class="settings-item-value" id="theme-val">Ê∑±Ëâ≤Ê®°Âºè ‚Ä∫</span></div>
            <div class="settings-item" onclick="toggleScreen()"><span class="settings-item-label">Â±èÂπïÊ®°Âºè</span><span class="settings-item-value" id="screen-val">ÊâãÊ©üÊ®°Êì¨Âô® ‚Ä∫</span></div>
            <div class="settings-item" onclick="setChatBackground()"><span class="settings-item-label">ËÅäÂ§©ËÉåÊôØ</span><span class="settings-item-value" id="chat-bg-val">ÈªòË™ç ‚Ä∫</span></div>
            <div class="settings-item" onclick="showFontSettings()"><span class="settings-item-label">Â≠óÈ´îÂ§ßÂ∞è</span><span class="settings-item-value" id="font-size-val">16px ‚Ä∫</span></div>
            <div class="settings-item" onclick="showLineHeightSettings()"><span class="settings-item-label">Ë°åÈñìË∑ù</span><span class="settings-item-value" id="line-height-val">1.8x ‚Ä∫</span></div>
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">ü§ñ AIË®≠ÁΩÆ</div>
          <div class="settings-card">
            <div class="settings-item" onclick="goTo('view-api')"><span class="settings-item-label">API È†êË®≠ÁÆ°ÁêÜ</span><span class="settings-item-value">‚Ä∫</span></div>
            <div class="settings-item" onclick="showContextSettings()"><span class="settings-item-label">‰∏ä‰∏ãÊñáË®≠ÁΩÆ</span><span class="settings-item-value" id="context-val">20Ê¢ùÊ∂àÊÅØ ‚Ä∫</span></div>
            <div class="settings-item" onclick="showMaxTokensSettings()"><span class="settings-item-label">ÊúÄÂ§ßÁîüÊàêÈï∑Â∫¶</span><span class="settings-item-value" id="max-tokens-val">4096 ‚Ä∫</span></div>
            <div class="settings-item" onclick="showStreamingSettings()"><span class="settings-item-label">ÊµÅÂºèÈüøÊáâ</span><span class="settings-item-value" id="streaming-val">Â∑≤ÈñãÂïü ‚Ä∫</span></div>
            <div class="settings-item" onclick="showDefaultAIParams()"><span class="settings-item-label">AI ÂèÉÊï∏ÈªòË™çÂÄº</span><span class="settings-item-value" id="ai-params-val">T:0.8 ‚Ä∫</span></div>
            <div class="settings-item" onclick="showTemplateVarsSettings()"><span class="settings-item-label">Ê®°ÊùøËÆäÈáè</span><span class="settings-item-value" id="template-vars-val">Ë®≠ÁΩÆ ‚Ä∫</span></div>
            <div class="settings-item"><span class="settings-item-label">‰∏ÄËá¥ÊÄßÊ™¢Êü•</span><div class="toggle active" id="tog-consist" onclick="toggleSet('consist')"></div></div>
            <div class="settings-item"><span class="settings-item-label">Ëá™ÂãïÁ´†ÁØÄÁ∏ΩÁµê</span><div class="toggle active" id="tog-summary" onclick="toggleSet('summary')"></div></div>
            <div class="settings-item"><span class="settings-item-label">Ë°åÂãïÂª∫Ë≠∞</span><div class="toggle active" id="tog-suggest" onclick="toggleSet('suggest')"></div></div>
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">‚å®Ô∏è Ëº∏ÂÖ•</div>
          <div class="settings-card">
            <div class="settings-item" onclick="showTypingSpeedSettings()"><span class="settings-item-label">ÊâìÂ≠óÊ©üÊïàÊûú</span><span class="settings-item-value" id="typing-speed-val">30ms ‚Ä∫</span></div>
            <div class="settings-item" onclick="toggleSendKey()"><span class="settings-item-label">ÁôºÈÄÅÂø´Êç∑Èçµ</span><span class="settings-item-value" id="send-key-val">Enter ‚Ä∫</span></div>
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">üåê Ë™ûË®Ä</div>
          <div class="settings-card">
            <div class="settings-item" onclick="showChineseConvertSettings()"><span class="settings-item-label">Á∞°ÁπÅËΩâÊèõ</span><span class="settings-item-value" id="cn-convert-val">‰∏çËΩâÊèõ ‚Ä∫</span></div>
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">üíæ Êï∏Êìö</div>
          <div class="settings-card">
            <div class="settings-item" onclick="exportAll()"><span class="settings-item-label">Â∞éÂá∫ÊâÄÊúâÊï∏Êìö</span><span class="settings-item-value">‚Ä∫</span></div>
            <div class="settings-item" onclick="importAll()"><span class="settings-item-label">Â∞éÂÖ•Êï∏Êìö</span><span class="settings-item-value">‚Ä∫</span></div>
            <div class="settings-item danger" onclick="clearAll()"><span class="settings-item-label">Ê∏ÖÁ©∫ÊâÄÊúâÊï∏Êìö</span><span class="settings-item-value">‚Ä∫</span></div>
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">üì± ÊáâÁî®</div>
          <div class="settings-card">
            <div class="settings-item" onclick="installPWA()"><span class="settings-item-label">ÂÆâË£ùÂà∞Ê°åÈù¢</span><span class="settings-item-value" id="pwa-install-status">‚Ä∫</span></div>
            <div class="settings-item" onclick="debugApiTest()"><span class="settings-item-label">üîß API ÈÄ£Êé•Ë™øË©¶</span><span class="settings-item-value">‚Ä∫</span></div>
            <div class="settings-item"><span class="settings-item-label">ÈóúÊñºÁπîÂ§¢</span><span class="settings-item-value">v5.1 ‚Ä∫</span></div>
          </div>
        </div>
      </div>
      <div class="tab-bar">
        <div class="tab-item" onclick="switchTab('stories')"><span class="tab-icon">üìö</span><span class="tab-label">ÊïÖ‰∫ã</span></div>
        <div class="tab-item" onclick="switchTab('instructions')"><span class="tab-icon">üìú</span><span class="tab-label">Êåá‰ª§</span></div>
        <div class="tab-item active" onclick="switchTab('settings')"><span class="tab-icon">‚öôÔ∏è</span><span class="tab-label">Ë®≠ÁΩÆ</span></div>
      </div>
    </div>
    <!-- APIË®≠ÁΩÆ -->
    <div class="view" id="view-api">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">‚Äπ</div>
        <span class="nav-title">API È†êË®≠ÁÆ°ÁêÜ</span>
        <div class="nav-right"><div class="nav-btn" onclick="addApi()">‚ûï</div></div>
      </div>
      <div class="scroll sys" id="api-list"></div>
    </div>
    <!-- Á´†ÁØÄÁÆ°ÁêÜ -->
    <div class="view" id="view-chapters">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">‚Äπ</div>
        <span class="nav-title">Á´†ÁØÄÁÆ°ÁêÜ</span>
        <div class="nav-right"><div class="nav-btn" onclick="addChapter()">‚ûï</div></div>
      </div>
      <div class="scroll sys" id="chapter-list"></div>
    </div>
    <!-- Êõ∏Á±§ÂàóË°® -->
    <div class="view" id="view-bookmarks">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">‚Äπ</div>
        <span class="nav-title">Êõ∏Á±§ÂàóË°®</span>
        <div class="nav-right"></div>
      </div>
      <div class="scroll sys" id="bookmark-list"></div>
    </div>
    <!-- ÂàÜÊîØÁÆ°ÁêÜ -->
    <div class="view" id="view-branches">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">‚Äπ</div>
        <span class="nav-title">ÂàÜÊîØÁÆ°ÁêÜ</span>
        <div class="nav-right"><div class="nav-btn" onclick="createBranch()">‚ûï</div></div>
      </div>
      <div class="scroll sys" id="branch-list"></div>
    </div>
    <!-- Lorebook Ë®≠ÂÆöÂ∫´ -->
    <div class="view" id="view-lorebook">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">‚Äπ</div>
        <span class="nav-title">üîÆ Lorebook</span>
        <div class="nav-right">
          <div class="nav-btn" onclick="importFromLore()" title="ÂæûË≥áÊñôÂ∫´Â∞éÂÖ•">üì•</div>
          <div class="nav-btn" onclick="addLorebook()">‚ûï</div>
        </div>
      </div>
      <div style="padding:8px 16px;background:var(--bg-secondary);border-bottom:1px solid var(--divider)">
        <div style="font-size:12px;color:var(--text-tertiary)">Áï∂Â∞çË©±ÂåÖÂê´ÈóúÈçµË©ûÊôÇÔºåËá™ÂãïÊ≥®ÂÖ•Áõ∏ÈóúË®≠ÂÆöÂà∞ AI ‰∏ä‰∏ãÊñá</div>
      </div>
      <div class="scroll sys" id="lorebook-list"></div>
    </div>
    <!-- v7: ËßíËâ≤Âç°ÁâáË¶ñÂúñ -->
    <div class="view" id="view-characters">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">‚Äπ</div>
        <span class="nav-title">ËßíËâ≤ÁãÄÊÖã</span>
        <div class="nav-right">
          <div class="nav-btn" onclick="showCharacterMenu()" title="Êõ¥Â§ö">‚ãØ</div>
          <div class="nav-btn" onclick="addCharacterManual()" title="ÊâãÂãïÊ∑ªÂä†">‚ûï</div>
        </div>
      </div>
      <div class="scroll sys" id="character-list" style="position:relative"></div>
      <div class="input-bar" style="justify-content:space-between;padding:8px 16px">
        <span style="font-size:12px;color:var(--text-tertiary)" id="char-count">0 ‰ΩçËßíËâ≤</span>
        <button class="action-btn primary" style="padding:8px 16px;font-size:13px" onclick="refreshCharacters()">ü§ñ AI Êõ¥Êñ∞ÁãÄÊÖã</button>
      </div>
    </div>
    <!-- Êåá‰ª§ÁîüÊàêÂêëÂ∞é -->
    <div class="view" id="view-wizard">
      <div class="nav">
        <div class="nav-back" onclick="exitWizard()">‚Äπ</div>
        <span class="nav-title" id="wizard-title">Êåá‰ª§ÁîüÊàêÂêëÂ∞é</span>
        <div class="nav-right">
          <div class="nav-btn" onclick="showWizardHelp()" title="Âπ´Âä©">‚ùì</div>
        </div>
      </div>
      <div class="wizard-progress">
        <div class="wizard-progress-bar"><div class="wizard-progress-fill" id="wizard-progress-fill" style="width:12.5%"></div></div>
        <span class="wizard-progress-text" id="wizard-progress-text">1/8 Âü∫Á§éË®≠ÂÆö</span>
      </div>
      <div class="wizard-content" id="wizard-content">
        <!-- ÂãïÊÖãÂÖßÂÆπ -->
      </div>
      <div class="wizard-footer">
        <button class="wizard-btn secondary" id="wizard-prev" onclick="wizardPrev()" disabled>‰∏ä‰∏ÄÊ≠•</button>
        <button class="wizard-btn primary" id="wizard-next" onclick="wizardNext()">‰∏ã‰∏ÄÊ≠•</button>
      </div>
    </div>
    <!-- Prompt ÂàÜÊûêÈ†ÅÈù¢ -->
    <div class="view" id="view-analyze">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">‚Äπ</div>
        <span class="nav-title">Prompt ÂàÜÊûê</span>
        <div class="nav-right">
          <div class="nav-btn" onclick="showAnalyzeHelp()" title="Âπ´Âä©">‚ùì</div>
        </div>
      </div>
      <div class="wizard-content" id="analyze-content">
        <!-- ÂãïÊÖãÂÖßÂÆπ -->
      </div>
    </div>
  </div>
</div>
<!-- Ê≤âÊµ∏Ê®°Âºè -->
<div class="immersive" id="immersive">
  <div class="immersive-content" id="immersive-content" onclick="nextImm()"></div>
  <div class="immersive-footer">
    <div class="immersive-progress"><div class="immersive-progress-fill" id="imm-progress"></div></div>
    <span class="immersive-hint">ËºïËß∏ÁπºÁ∫å ‚ñ∂</span>
    <div class="immersive-close" onclick="exitImm()">‚úï</div>
  </div>
</div>
<!-- Èö±ËóèÁöÑÊñá‰ª∂Ëº∏ÂÖ• -->
<input type="file" id="image-upload" accept="image/*" style="display:none" onchange="handleImageUpload(event)">
<input type="file" id="analyze-file" accept=".txt,.md,.docx" style="display:none" onchange="handleAnalyzeFile(event)">
<!-- ÈÅÆÁΩ© -->
<div class="overlay" id="overlay" onclick="closeAll()"></div>
<!-- Â∫ïÈÉ®Èù¢Êùø -->
<div class="bottom-sheet" id="sheet">
  <div class="bottom-sheet-handle"></div>
  <div class="bottom-sheet-title">ÊïÖ‰∫ãË®≠ÁΩÆ</div>
  <div class="sheet-grid">
    <div class="sheet-item" onclick="goTo('view-characters');closeAll()"><div class="sheet-item-icon">üë•</div><div class="sheet-item-label">ËßíËâ≤ÁãÄÊÖã</div></div>
    <div class="sheet-item" onclick="showSceneManager()"><div class="sheet-item-icon">üé¨</div><div class="sheet-item-label">Â†¥ÊôØÁÆ°ÁêÜ</div></div>
    <div class="sheet-item" onclick="goTo('view-timeline');closeAll()"><div class="sheet-item-icon">üìÖ</div><div class="sheet-item-label">ÊôÇÈñìËª∏</div></div>
    <div class="sheet-item" onclick="goTo('view-foreshadow');closeAll()"><div class="sheet-item-icon">üìå</div><div class="sheet-item-label">‰ºèÁ≠Ü‰∫ã‰ª∂</div></div>
    <div class="sheet-item" onclick="goTo('view-chapters');closeAll()"><div class="sheet-item-icon">üìë</div><div class="sheet-item-label">Á´†ÁØÄÁÆ°ÁêÜ</div></div>
    <div class="sheet-item" onclick="goTo('view-saves');closeAll()"><div class="sheet-item-icon">üíæ</div><div class="sheet-item-label">Â≠òÊ™îÁÆ°ÁêÜ</div></div>
    <div class="sheet-item" onclick="goTo('view-branches');closeAll()"><div class="sheet-item-icon">üîÄ</div><div class="sheet-item-label">ÂàÜÊîØÁÆ°ÁêÜ</div></div>
    <div class="sheet-item" onclick="goTo('view-lorebook');closeAll()"><div class="sheet-item-icon">üîÆ</div><div class="sheet-item-label">Lorebook</div></div>
    <div class="sheet-item" onclick="showStoryAIParams()"><div class="sheet-item-icon">üéõÔ∏è</div><div class="sheet-item-label">AIÂèÉÊï∏</div></div>
    <div class="sheet-item" onclick="showMemoryManager()"><div class="sheet-item-icon">üß†</div><div class="sheet-item-label">Ë®òÊÜ∂ÁÆ°ÁêÜ</div></div>
    <div class="sheet-item" onclick="showFindReplace()"><div class="sheet-item-icon">üîç</div><div class="sheet-item-label">Êü•ÊâæÊõøÊèõ</div></div>
    <div class="sheet-item" onclick="showStats()"><div class="sheet-item-icon">üìä</div><div class="sheet-item-label">Áµ±Ë®àÈù¢Êùø</div></div>
    <div class="sheet-item" onclick="enterImm()"><div class="sheet-item-icon">üé≠</div><div class="sheet-item-label">Ê≤âÊµ∏Ê®°Âºè</div></div>
    <div class="sheet-item" onclick="exportStory()"><div class="sheet-item-icon">üì§</div><div class="sheet-item-label">Â∞éÂá∫ÊïÖ‰∫ã</div></div>
  </div>
</div>
<!-- Êõ¥Â§öËèúÂñÆ -->
<div class="context-menu" id="more-menu">
  <div class="context-menu-item" onclick="goTo('view-timeline');hideMenu()">üìÖ ÊôÇÈñìËª∏</div>
  <div class="context-menu-item" onclick="goTo('view-foreshadow');hideMenu()">üìå ‰ºèÁ≠Ü/‰∫ã‰ª∂</div>
  <div class="context-menu-item" onclick="goTo('view-chapters');hideMenu()">üìë Á´†ÁØÄÂàóË°®</div>
  <div class="context-menu-item" onclick="goTo('view-bookmarks');hideMenu()">üîñ Êõ∏Á±§ÂàóË°®</div>
  <div class="context-menu-divider"></div>
  <!-- v19: Á∂ìÁáüÊ®°ÂºèÈÅ∏È†Ö -->
  <div class="context-menu-item sim-only" onclick="showSimResourceModal();hideMenu()" style="display:none">üéÆ Ë≥áÊ∫êÁÆ°ÁêÜ</div>
  <div class="context-menu-item sim-only" onclick="simNextDay();hideMenu()" style="display:none">‚è≠Ô∏è ÈÄ≤ÂÖ•‰∏ã‰∏ÄÂ§©</div>
  <div class="context-menu-item sim-only" onclick="showSimImportModal();hideMenu()" style="display:none">üì• Â∞éÂÖ•Â≠òÊ™î</div>
  <div class="context-menu-item sim-only" onclick="showSimExportModal();hideMenu()" style="display:none">üì§ Â∞éÂá∫Â≠òÊ™î</div>
  <div class="context-menu-divider sim-only" style="display:none"></div>
  <div class="context-menu-item" onclick="aiConsistencyCheck();hideMenu()">üîç AI‰∏ÄËá¥ÊÄßÊ™¢Êü•</div>
  <div class="context-menu-item" onclick="aiChapterSummary();hideMenu()">üìù AIÁ´†ÁØÄÁ∏ΩÁµê</div>
  <div class="context-menu-item" onclick="aiSuggestions();hideMenu()">üí° AIË°åÂãïÂª∫Ë≠∞</div>
  <div class="context-menu-divider"></div>
  <div class="context-menu-item" onclick="exportStory();hideMenu()">üì§ Â∞éÂá∫ÊïÖ‰∫ã</div>
  <div class="context-menu-item" onclick="enterImm();hideMenu()">üé≠ Ê≤âÊµ∏Ê®°Âºè</div>
</div>
<!-- Ê∂àÊÅØËèúÂñÆ -->
<div class="context-menu" id="msg-menu">
  <div class="context-menu-item" onclick="editMsg()">‚úèÔ∏è Á∑®ËºØ</div>
  <div class="context-menu-item" onclick="regenerateMsg()">üîÑ ÈáçÊñ∞ÁîüÊàê</div>
  <div class="context-menu-item" onclick="markForeshadow()">üìå Ê®ôË®ò‰ºèÁ≠Ü</div>
  <div class="context-menu-item" onclick="addPlotTag()">üè∑Ô∏è Ê∑ªÂä†Ê®ôÁ±§</div>
  <div class="context-menu-divider"></div>
  <div class="context-menu-item" onclick="rollbackTo()">‚Ü©Ô∏è ÂõûÊ∫ØÂà∞Ê≠§</div>
  <div class="context-menu-item" onclick="copyMsg()">üìã Ë§áË£Ω</div>
  <div class="context-menu-item" onclick="addBookmark()">üîñ Ê∑ªÂä†Êõ∏Á±§</div>
  <div class="context-menu-divider"></div>
  <div class="context-menu-item danger" onclick="deleteMsg()">üóëÔ∏è Âà™Èô§Ê∂àÊÅØ</div>
</div>
<!-- ËßíËâ≤ËèúÂñÆ -->
<div class="context-menu" id="char-menu">
  <div class="context-menu-item" onclick="refreshCharacters();hideMenu()">üîÑ AI Êõ¥Êñ∞ÁãÄÊÖã</div>
  <div class="context-menu-divider"></div>
  <div class="context-menu-item" onclick="importCharacterCard();hideMenu()">üì• Â∞éÂÖ•ËßíËâ≤Âç°</div>
  <div class="context-menu-item" onclick="exportAllCharacters();hideMenu()">üì§ Â∞éÂá∫ÊâÄÊúâËßíËâ≤</div>
  <div class="context-menu-divider"></div>
  <div class="context-menu-item danger" onclick="clearAllCharacters();hideMenu()">üóëÔ∏è Ê∏ÖÁ©∫ÊâÄÊúâËßíËâ≤</div>
</div>
<!-- ÊïÖ‰∫ãËèúÂñÆ -->
<div class="context-menu" id="story-menu">
  <div class="context-menu-item" onclick="editStoryCover()">üñºÔ∏è Êõ¥ÊèõÂ∞ÅÈù¢</div>
  <div class="context-menu-item" onclick="toggleStoryPin()">üìå ÁΩÆÈ†Ç/ÂèñÊ∂àÁΩÆÈ†Ç</div>
  <div class="context-menu-divider"></div>
  <div class="context-menu-item danger" onclick="deleteStoryFromMenu()">üóëÔ∏è Âà™Èô§ÊïÖ‰∫ã</div>
</div>
<!-- Á¢∫Ë™çÊ°Ü -->
<div class="modal" id="confirm-modal">
  <div class="modal-title" id="confirm-title">Á¢∫Ë™ç</div>
  <div class="modal-content" id="confirm-content">Á¢∫ÂÆöË¶ÅÂü∑Ë°åÊ≠§Êìç‰ΩúÂóéÔºü</div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('confirm-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" id="confirm-btn" onclick="confirmAction()">Á¢∫ÂÆö</button>
  </div>
</div>
<!-- Ëº∏ÂÖ•Ê°Ü -->
<div class="modal" id="input-modal">
  <div class="modal-title" id="input-title">Ëº∏ÂÖ•</div>
  <div class="modal-content" id="input-desc"></div>
  <input type="text" class="modal-input" id="modal-input" placeholder="">
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('input-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="confirmInput()">Á¢∫ÂÆö</button>
  </div>
</div>
<!-- Êñ∞Âª∫ÊïÖ‰∫ã -->
<div class="modal" id="new-story-modal" style="max-width:420px">
  <div class="modal-title">Êñ∞Âª∫ÊïÖ‰∫ã</div>
  <div class="form-group"><label class="form-label">ÊïÖ‰∫ãÊ®ôÈ°å</label><input type="text" class="form-input" id="new-title" placeholder="Ëº∏ÂÖ•ÊïÖ‰∫ãÊ®ôÈ°å"></div>
  <div class="form-group"><label class="form-label">Á∞°‰ªãÔºàÂèØÈÅ∏Ôºâ</label><textarea class="form-textarea" id="new-desc" placeholder="Á∞°ÂñÆÊèèËø∞ÈÄôÂÄãÊïÖ‰∫ã..."></textarea></div>
  <div class="form-group">
    <label class="form-label">ÊïÖ‰∫ãÊ®°Âºè</label>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <div class="mode-card active" id="mode-normal" onclick="selectStoryMode('normal')">
        <div style="font-size:24px;margin-bottom:4px">üìñ</div>
        <div style="font-weight:600;font-size:13px">ÊôÆÈÄöÊ®°Âºè</div>
        <div style="font-size:11px;color:var(--text-tertiary)">ËßíËâ≤ÁãÄÊÖãËøΩËπ§</div>
      </div>
      <div class="mode-card" id="mode-simulation" onclick="selectStoryMode('simulation')">
        <div style="font-size:24px;margin-bottom:4px">üéÆ</div>
        <div style="font-weight:600;font-size:13px">Á∂ìÁáüÊ®°Âºè</div>
        <div style="font-size:11px;color:var(--text-tertiary)">Ë≥áÊ∫êÈù¢Êùø+Â≠òÊ™î</div>
      </div>
    </div>
  </div>
  <div id="sim-mode-options" style="display:none">
    <div class="form-group">
      <label class="form-label">ÂàùÂßãË≥áÊ∫êÔºàÂèØÁ®çÂæåÁ∑®ËºØÔºâ</label>
      <div id="new-sim-resources" style="display:flex;flex-direction:column;gap:6px">
        <div style="display:flex;gap:6px;align-items:center">
          <input type="text" class="form-input" style="width:60px" placeholder="üí∞" maxlength="2" value="üí∞">
          <input type="text" class="form-input" style="flex:1" placeholder="ÂêçÁ®±" value="ÈáëÂπ£">
          <input type="number" class="form-input" style="width:80px" placeholder="Êï∏ÂÄº" value="10000">
          <button onclick="removeSimResource(this)" style="background:none;border:none;color:var(--error);cursor:pointer">‚úï</button>
        </div>
      </div>
      <button onclick="addSimResource()" style="margin-top:8px;background:var(--bg-tertiary);border:none;padding:6px 12px;border-radius:6px;color:var(--text-secondary);cursor:pointer;font-size:12px">‚ûï Ê∑ªÂä†Ë≥áÊ∫ê</button>
    </div>
  </div>
  <div class="form-group"><label class="form-label">Ê®ôÁ±§ÔºàÁ©∫Ê†ºÂàÜÈöîÔºâ</label><input type="text" class="form-input" id="new-tags" placeholder="ÂÆÆÈ¨• Âè§È¢® ÊàÄÊÑõ"></div>
  <div class="form-group"><label class="form-label">Á∂ÅÂÆöÊåá‰ª§</label><select class="form-select" id="new-inst"><option value="">‰∏çÁ∂ÅÂÆöÊåá‰ª§</option></select></div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('new-story-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveNewStory()">ÂâµÂª∫</button>
  </div>
</div>
<!-- APIË®≠ÁΩÆ -->
<div class="modal" id="api-modal" style="max-width:400px">
  <div class="modal-title">API Ë®≠ÁΩÆ</div>
  <div class="form-group"><label class="form-label">È†êË®≠ÂêçÁ®±</label><input type="text" class="form-input" id="api-name" placeholder="‰æãÂ¶Ç: Claude API"></div>
  <div class="form-group"><label class="form-label">API È°ûÂûã</label><select class="form-select" id="api-type" onchange="updateApiFields()"><option value="anthropic">Anthropic (Claude)</option><option value="openai">OpenAI (GPT)</option><option value="custom">Ëá™ÂÆöÁæ© API</option></select></div>
  <div class="form-group"><label class="form-label">API Key</label><input type="password" class="form-input" id="api-key" placeholder="sk-..."></div>
  <div class="form-group"><label class="form-label">Ê®°Âûã</label><input type="text" class="form-input" id="api-model" list="model-list" placeholder="ÈÅ∏ÊìáÊàñËº∏ÂÖ•Ê®°ÂûãÂêçÁ®±"><datalist id="model-list"><option value="claude-sonnet-4-20250514">Claude Sonnet 4</option><option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option><option value="claude-3-opus-20240229">Claude 3 Opus</option></datalist></div>
  <div class="form-group hidden" id="api-url-group"><label class="form-label">API URL</label><input type="text" class="form-input" id="api-url" placeholder="https://api.example.com"><div style="margin-top:6px"><label style="font-size:12px;color:var(--text-secondary);display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="api-url-autocomplete" checked> Ëá™ÂãïË£úÂÖ® /v1/chat/completions</label></div></div>
  <div class="form-group"><button type="button" class="action-btn secondary" style="width:100%" onclick="testApi()">üîó Ê∏¨Ë©¶ÈÄ£Êé•</button><div id="api-test-result" style="margin-top:8px;font-size:12px;display:none"></div></div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('api-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveApi()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- v19: Á∂ìÁáüÊ®°Âºè - Ë≥áÊ∫êÁÆ°ÁêÜ Modal -->
<div class="modal" id="sim-resource-modal" style="max-width:min(95%,420px)">
  <div class="modal-title">üéÆ Ë≥áÊ∫êÁÆ°ÁêÜ</div>
  <div style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">
    Ëá™ÂÆöÁæ©ËøΩËπ§ÁöÑË≥áÊ∫êÊï∏ÂÄºÔºåÊúÉÈ°ØÁ§∫Âú®È†ÇÈÉ®Èù¢Êùø
  </div>
  <div class="form-group">
    <label class="form-label">Áï∂ÂâçÂ§©Êï∏/ÂõûÂêà</label>
    <div style="display:flex;gap:8px;align-items:center">
      <input type="number" class="form-input" id="sim-current-day" min="1" value="1" style="width:100px">
      <button onclick="simDayMinus()" style="background:var(--bg-tertiary);border:none;padding:8px 12px;border-radius:6px;cursor:pointer">‚àí</button>
      <button onclick="simDayPlus()" style="background:var(--bg-tertiary);border:none;padding:8px 12px;border-radius:6px;cursor:pointer">+</button>
    </div>
  </div>
  <div class="form-group">
    <label class="form-label">Ë≥áÊ∫êÂàóË°®</label>
    <div id="sim-resource-list" style="display:flex;flex-direction:column;gap:8px;max-height:250px;overflow-y:auto">
      <!-- ÂãïÊÖãÊ∏≤Êüì -->
    </div>
    <button onclick="addSimResourceInModal()" style="margin-top:10px;background:var(--bg-tertiary);border:none;padding:8px 14px;border-radius:6px;color:var(--text-secondary);cursor:pointer;font-size:13px;width:100%">‚ûï Ê∑ªÂä†Êñ∞Ë≥áÊ∫ê</button>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('sim-resource-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveSimResources()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- v19: Á∂ìÁáüÊ®°Âºè - Â≠òÊ™îÂ∞éÂÖ• Modal -->
<div class="modal" id="sim-import-modal" style="max-width:min(95%,500px)">
  <div class="modal-title">üì• Â∞éÂÖ•Â≠òÊ™î</div>
  <div style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">
    Ë≤ºÂÖ•ÊñáÈÅä prompt ÁîüÊàêÁöÑÂ≠òÊ™îÂÖßÂÆπÔºåÊúÉËá™ÂãïËß£ÊûêË≥áÊ∫êÊï∏ÂÄº
  </div>
  <div class="form-group">
    <label class="form-label">Â≠òÊ™îÂÖßÂÆπ</label>
    <textarea class="form-input" id="sim-import-content" style="min-height:200px;font-family:monospace;font-size:12px" placeholder="Ë≤ºÂÖ•Â≠òÊ™îÂÖßÂÆπ..."></textarea>
  </div>
  <div class="form-group">
    <label class="form-label">Ëß£ÊûêË¶èÂâáÔºàÊ≠£ÂâáË°®ÈÅîÂºèÔºåÂèØÈÅ∏Ôºâ</label>
    <input type="text" class="form-input" id="sim-import-regex" placeholder="‰æãÂ¶ÇÔºöüí∞ ÁèæÈáëÔºö([\\d,]+)ÂÖÉ">
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">ÁïôÁ©∫Ââá‰ΩøÁî®ÈªòË™çË¶èÂâáËß£ÊûêÂ∏∏Ë¶ãÊ†ºÂºè</div>
  </div>
  <div id="sim-import-preview" style="display:none;background:var(--bg-tertiary);padding:12px;border-radius:8px;margin-bottom:12px">
    <div style="font-size:12px;font-weight:600;margin-bottom:8px">üìä Ëß£ÊûêÈ†êË¶Ω</div>
    <div id="sim-import-preview-content"></div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn" style="background:var(--bg-tertiary);color:var(--text-secondary)" onclick="parseSimImport()">üîç Ëß£ÊûêÈ†êË¶Ω</button>
    <button class="modal-btn cancel" onclick="closeModal('sim-import-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="applySimImport()">Â∞éÂÖ•</button>
  </div>
</div>
<!-- v19: Á∂ìÁáüÊ®°Âºè - Â≠òÊ™îÂ∞éÂá∫ Modal -->
<div class="modal" id="sim-export-modal" style="max-width:min(95%,500px)">
  <div class="modal-title">üì§ Â∞éÂá∫Â≠òÊ™î</div>
  <div style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">
    ÁîüÊàêÁï∂ÂâçÁãÄÊÖãÁöÑÂ≠òÊ™îÔºåÂèØË≤ºÂà∞Êñ∞Â∞çË©±ÁπºÁ∫åÈÅäÊà≤
  </div>
  <div class="form-group">
    <label class="form-label">Â≠òÊ™îÊ†ºÂºè</label>
    <select class="form-select" id="sim-export-format" onchange="generateSimExport()">
      <option value="simple">Á∞°ÊΩîÊ†ºÂºè</option>
      <option value="detailed">Ë©≥Á¥∞Ê†ºÂºè</option>
      <option value="custom">Ëá™ÂÆöÁæ©Ê®°Êùø</option>
    </select>
  </div>
  <div class="form-group" id="sim-export-template-group" style="display:none">
    <label class="form-label">Ëá™ÂÆöÁæ©Ê®°Êùø</label>
    <textarea class="form-input" id="sim-export-template" style="min-height:100px;font-family:monospace;font-size:12px" placeholder="‰ΩøÁî® {day} {resources} {summary} Á≠âËÆäÈáè"></textarea>
  </div>
  <div class="form-group">
    <label class="form-label">Â≠òÊ™îÂÖßÂÆπ</label>
    <textarea class="form-input" id="sim-export-content" style="min-height:200px;font-family:monospace;font-size:12px" readonly></textarea>
  </div>
  <div class="modal-actions">
    <button class="modal-btn" style="background:var(--bg-tertiary);color:var(--text-secondary)" onclick="copySimExport()">üìã Ë§áË£Ω</button>
    <button class="modal-btn confirm" onclick="closeModal('sim-export-modal')">ÂÆåÊàê</button>
  </div>
</div>
<!-- Toast -->
<div class="toast" id="toast"><span id="toast-text"></span></div>
<!-- Loading -->
<div class="loading" id="loading"><div class="loading-spinner"></div><div class="loading-text" id="loading-text">ËôïÁêÜ‰∏≠...</div></div>
<!-- ‰∏ä‰∏ãÊñáË®≠ÁΩÆ Modal -->
<div class="modal" id="context-modal">
  <div class="modal-title">‰∏ä‰∏ãÊñáË®≠ÁΩÆ</div>
  <div class="form-group">
    <label class="form-label">‰∏ä‰∏ãÊñáÊ∂àÊÅØÊï∏Èáè</label>
    <p style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">ÁôºÈÄÅÁµ¶ AI ÁöÑÊ≠∑Âè≤Ê∂àÊÅØÊï∏ÈáèÔºåË∂äÂ§öË∂äËÉΩÁêÜËß£‰∏ä‰∏ãÊñáÔºå‰ΩÜÊúÉÊ∂àËÄóÊõ¥Â§ö Token</p>
    <input type="number" class="form-input" id="context-count" min="1" max="500" placeholder="Ëº∏ÂÖ•Êï∏ÈáèÔºå‰æãÂ¶ÇÔºö20">
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">Âª∫Ë≠∞ÁØÑÂúçÔºö10-50ÔºåÊúÄÂ§ßÊîØÊåÅ 500</div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('context-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveContextSettings()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- ÊúÄÂ§ß Token Modal -->
<div class="modal" id="max-tokens-modal">
  <div class="modal-title">ÊúÄÂ§ßÁîüÊàêÈï∑Â∫¶</div>
  <div class="form-group">
    <label class="form-label">Max Tokens</label>
    <p style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">AI ÂñÆÊ¨°ÂõûÂæ©ÁöÑÊúÄÂ§ßÈï∑Â∫¶ÔºåË∂äÂ§ßÂõûÂæ©Ë∂äÈï∑‰ΩÜ‰πüË∂äÊÖ¢</p>
    <input type="number" class="form-input" id="max-tokens-input" min="100" placeholder="Ëº∏ÂÖ•Êï∏ÈáèÔºå‰æãÂ¶ÇÔºö4096">
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">Âª∫Ë≠∞ÁØÑÂúçÔºö1024-8192ÔºåÂèØÊ†πÊìöÊ®°ÂûãÊîØÊåÅËá™Ë°åË™øÊï¥</div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('max-tokens-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveMaxTokensSettings()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- ÊâìÂ≠óÊ©üÊïàÊûú Modal -->
<div class="modal" id="typing-modal">
  <div class="modal-title">ÊâìÂ≠óÊ©üÊïàÊûú</div>
  <div class="form-group">
    <label class="form-label">ÊâìÂ≠óÈÄüÂ∫¶</label>
    <p style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">ÊØèÂÄãÂ≠óÈ°ØÁ§∫ÁöÑÈñìÈöîÊôÇÈñìÔºå0 ÁÇ∫ÈóúÈñâÊâìÂ≠óÊ©üÊïàÊûú</p>
    <select class="form-select" id="typing-speed-select">
      <option value="0">ÈóúÈñâ</option>
      <option value="10">10msÔºàÂø´ÈÄüÔºâ</option>
      <option value="20">20ms</option>
      <option value="30">30msÔºàÊé®Ëñ¶Ôºâ</option>
      <option value="50">50ms</option>
      <option value="80">80msÔºàÊÖ¢ÈÄüÔºâ</option>
    </select>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('typing-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveTypingSpeedSettings()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- ÊµÅÂºèÈüøÊáâË®≠ÁΩÆ Modal -->
<div class="modal" id="streaming-modal">
  <div class="modal-title">‚ö° ÊµÅÂºèÈüøÊáâ</div>
  <div class="form-group">
    <label class="form-label">ÂïüÁî®ÊµÅÂºèÈüøÊáâ</label>
    <p style="font-size:12px;color:var(--text-tertiary);margin-bottom:12px">AI ÈÇäÁîüÊàêÈÇäÈ°ØÁ§∫ÔºåÂπæÁßíÈêòÂ∞±ËÉΩÈñãÂßãÈñ±ËÆÄÔºå‰∏¶ÂèØÈö®ÊôÇÂÅúÊ≠¢ÁîüÊàê</p>
    <div style="display:flex;align-items:center;gap:12px">
      <div class="toggle active" id="toggle-streaming" onclick="toggleStreamingEnabled()"></div>
      <span id="toggle-streaming-text" style="font-size:13px;color:var(--text-secondary)">Â∑≤ÈñãÂïü</span>
    </div>
  </div>
  <div id="streaming-advanced-options">
    <div class="form-group">
      <label class="form-label">ÊâìÂ≠óÊ©üÂª∂ÈÅ≤</label>
      <p style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">Êî∂Âà∞ÊñáÂ≠óÂæåÁöÑÈ°ØÁ§∫Âª∂ÈÅ≤ÔºåËÆìÊµÅÂºèÈ°ØÁ§∫Êõ¥Âπ≥Êªë</p>
      <select class="form-select" id="streaming-chunk-delay-select">
        <option value="0">ÁÑ°Âª∂ÈÅ≤ÔºàÁ´ãÂç≥È°ØÁ§∫Ôºâ</option>
        <option value="10">10msÔºàÊ•µÂø´Ôºâ</option>
        <option value="20">20msÔºàÊé®Ëñ¶Ôºâ</option>
        <option value="30">30ms</option>
        <option value="50">50msÔºàÂπ≥ÊªëÔºâ</option>
      </select>
    </div>
    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;font-size:12px;color:var(--text-secondary);margin-top:12px">
      <div style="font-weight:600;margin-bottom:6px">üí° ÊèêÁ§∫</div>
      <div style="line-height:1.6">
        ‚Ä¢ ÊµÅÂºèÈüøÊáâÂèØÂ§ßÂπÖÊ∏õÂ∞ëÁ≠âÂæÖÊôÇÈñì<br>
        ‚Ä¢ ÈÉ®ÂàÜ API ÂèØËÉΩ‰∏çÊîØÊåÅÊµÅÂºèÔºåÊúÉËá™ÂãïÈôçÁ¥ö<br>
        ‚Ä¢ ÂÅúÊ≠¢ÁîüÊàêÊôÇÊúÉË©¢ÂïèÊòØÂê¶‰øùÂ≠òÂ∑≤ÁîüÊàêÂÖßÂÆπ
      </div>
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('streaming-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveStreamingSettings()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- Â≠óÈ´îÂ§ßÂ∞è Modal -->
<div class="modal" id="font-size-modal">
  <div class="modal-title">üìù Â≠óÈ´îÂ§ßÂ∞è</div>
  <div class="form-group">
    <label class="form-label">ÈÅ∏ÊìáÂ≠óÈ´îÂ§ßÂ∞è</label>
    <p style="font-size:12px;color:var(--text-tertiary);margin-bottom:12px">Ë™øÊï¥ÊïÖ‰∫ãÂÖßÂÆπÁöÑÂ≠óÈ´îÂ§ßÂ∞èÔºåÊâæÂà∞ÊúÄËàíÈÅ©ÁöÑÈñ±ËÆÄÈ´îÈ©ó</p>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
      <button class="font-option" data-size="14" onclick="selectFontSize(14)">
        <span style="font-size:14px">Â∞è</span>
        <span style="font-size:11px;color:var(--text-tertiary)">14px</span>
      </button>
      <button class="font-option" data-size="16" onclick="selectFontSize(16)">
        <span style="font-size:16px">‰∏≠</span>
        <span style="font-size:11px;color:var(--text-tertiary)">16px</span>
      </button>
      <button class="font-option" data-size="18" onclick="selectFontSize(18)">
        <span style="font-size:18px">Â§ß</span>
        <span style="font-size:11px;color:var(--text-tertiary)">18px</span>
      </button>
      <button class="font-option" data-size="20" onclick="selectFontSize(20)">
        <span style="font-size:20px">ÁâπÂ§ß</span>
        <span style="font-size:11px;color:var(--text-tertiary)">20px</span>
      </button>
    </div>
    <div style="margin-top:16px;padding:16px;background:var(--bg-tertiary);border-radius:8px">
      <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">È†êË¶ΩÊïàÊûú</div>
      <div id="font-preview" style="font-family:'Noto Serif SC',Georgia,serif;line-height:1.8">
        Èôõ‰∏ãÁ∑©Ê≠•Ë°åËá≥Âæ°Ëä±ÂúíÔºåÂè™Ë¶ãÊ°ÉËä±ÁÅºÁÅºÔºåÂ´£ÁÑ∂Á∂ªÊîæÊñºÊûùÈ†≠„ÄÇ
      </div>
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('font-size-modal')">ÈóúÈñâ</button>
  </div>
</div>
<!-- Ë°åÈñìË∑ù Modal -->
<div class="modal" id="line-height-modal">
  <div class="modal-title">üìè Ë°åÈñìË∑ù</div>
  <div class="form-group">
    <label class="form-label">ÈÅ∏ÊìáË°åÈñìË∑ù</label>
    <p style="font-size:12px;color:var(--text-tertiary);margin-bottom:12px">Ë™øÊï¥Ë°åËàáË°å‰πãÈñìÁöÑË∑ùÈõ¢ÔºåÂΩ±ÈüøÈñ±ËÆÄÁØÄÂ•è</p>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
      <button class="font-option" data-lh="1.5" onclick="selectLineHeight(1.5)">
        <span>Á∑äÊπä</span>
        <span style="font-size:11px;color:var(--text-tertiary)">1.5x</span>
      </button>
      <button class="font-option" data-lh="1.8" onclick="selectLineHeight(1.8)">
        <span>Ê®ôÊ∫ñ</span>
        <span style="font-size:11px;color:var(--text-tertiary)">1.8x</span>
      </button>
      <button class="font-option" data-lh="2.0" onclick="selectLineHeight(2.0)">
        <span>ÂØ¨È¨Ü</span>
        <span style="font-size:11px;color:var(--text-tertiary)">2.0x</span>
      </button>
      <button class="font-option" data-lh="2.2" onclick="selectLineHeight(2.2)">
        <span>ÁâπÂØ¨</span>
        <span style="font-size:11px;color:var(--text-tertiary)">2.2x</span>
      </button>
    </div>
    <div style="margin-top:16px;padding:16px;background:var(--bg-tertiary);border-radius:8px">
      <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">È†êË¶ΩÊïàÊûú</div>
      <div id="line-height-preview" style="font-family:'Noto Serif SC',Georgia,serif;font-size:16px">
        Èôõ‰∏ãÁ∑©Ê≠•Ë°åËá≥Âæ°Ëä±ÂúíÔºåÂè™Ë¶ãÊ°ÉËä±ÁÅºÁÅºÔºåÂ´£ÁÑ∂Á∂ªÊîæÊñºÊûùÈ†≠„ÄÇËä±Áì£Èö®È¢®È£ÑËêΩÔºåÂ¶ÇÁ≤âËâ≤ÁöÑÈõ™ÔºåËºïÊüîÂú∞ËêΩÂú®‰Ω†ÁöÑËÇ©È†≠„ÄÇ
      </div>
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('line-height-modal')">ÈóúÈñâ</button>
  </div>
</div>
<!-- Lorebook Á∑®ËºØ Modal -->
<div class="modal" id="lorebook-modal" style="max-width:min(95%,450px);max-height:85vh;overflow-y:auto">
  <div class="modal-title">üîÆ Á∑®ËºØ Lorebook Ê¢ùÁõÆ</div>
  <input type="hidden" id="lorebook-id">
  <div class="form-group">
    <label class="form-label">ÂêçÁ®±</label>
    <input type="text" class="form-input" id="lorebook-name" placeholder="‰æãÂ¶ÇÔºöÂ§úÂØí - Âü∫Êú¨‰∫∫Ë®≠">
  </div>
  <div class="form-group">
    <label class="form-label">Ëß∏ÁôºÈóúÈçµË©ûÔºàÈÄóËôüÂàÜÈöîÔºâ</label>
    <input type="text" class="form-input" id="lorebook-keywords" placeholder="‰æãÂ¶ÇÔºöÂ§úÂØí, ÁöáÂ§´, Èï∑Ê®ÇÂÆÆ‰∏ª‰∫∫">
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">Áï∂Â∞çË©±‰∏≠Âá∫ÁèæÈÄô‰∫õË©ûÊôÇÊúÉËß∏ÁôºÊ≥®ÂÖ•</div>
  </div>
  <div class="form-group">
    <label class="form-label">ÂÖßÂÆπ</label>
    <textarea class="form-input" id="lorebook-content" style="min-height:120px" placeholder="Ë¶ÅÊ≥®ÂÖ•ÁöÑË®≠ÂÆöÂÖßÂÆπ..."></textarea>
  </div>
  <div class="form-group">
    <div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer" onclick="toggleLorebookAdvanced()">
      <label class="form-label" style="margin:0">‚öôÔ∏è ÈÄ≤ÈöéË®≠ÁΩÆ</label>
      <span id="lorebook-advanced-toggle" style="color:var(--text-tertiary)">‚ñº</span>
    </div>
    <div id="lorebook-advanced" style="display:none;margin-top:12px">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
        <div>
          <label style="font-size:12px;color:var(--text-secondary)">Ê™¢Ê∏¨Ê∑±Â∫¶</label>
          <select class="form-select" id="lorebook-depth" style="margin-top:4px">
            <option value="1">ÊúÄËøë 1 Ê¢ùÊ∂àÊÅØ</option>
            <option value="2" selected>ÊúÄËøë 2 Ê¢ùÊ∂àÊÅØ</option>
            <option value="3">ÊúÄËøë 3 Ê¢ùÊ∂àÊÅØ</option>
            <option value="5">ÊúÄËøë 5 Ê¢ùÊ∂àÊÅØ</option>
          </select>
        </div>
        <div>
          <label style="font-size:12px;color:var(--text-secondary)">ÂÑ™ÂÖàÁ¥ö</label>
          <input type="number" class="form-input" id="lorebook-priority" value="100" style="margin-top:4px">
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
        <div>
          <label style="font-size:12px;color:var(--text-secondary)">ÂÜ∑ÂçªÔºàÊ∂àÊÅØÊï∏Ôºâ</label>
          <input type="number" class="form-input" id="lorebook-cooldown" value="0" min="0" style="margin-top:4px">
        </div>
        <div>
          <label style="font-size:12px;color:var(--text-secondary)">ÊúÄÂ§ßËß∏ÁôºÊ¨°Êï∏</label>
          <input type="number" class="form-input" id="lorebook-max-triggers" value="0" min="0" style="margin-top:4px" placeholder="0=ÁÑ°Èôê">
        </div>
      </div>
      <label style="font-size:13px;color:var(--text-secondary);display:flex;align-items:center;gap:6px;cursor:pointer">
        <input type="checkbox" id="lorebook-one-time"> ‰∏ÄÊ¨°ÊÄßËß∏ÁôºÔºàËß∏ÁôºÂæåËá™ÂãïÁ¶ÅÁî®Ôºâ
      </label>
    </div>
  </div>
  <div class="form-group">
    <div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer" onclick="toggleLorebookConditions()">
      <label class="form-label" style="margin:0">üîê Ëß∏ÁôºÊ¢ù‰ª∂ÔºàÂèØÈÅ∏Ôºâ</label>
      <span id="lorebook-conditions-toggle" style="color:var(--text-tertiary)">‚ñº</span>
    </div>
    <div id="lorebook-conditions" style="display:none;margin-top:12px">
      <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">Èô§‰∫ÜÈóúÈçµË©ûÂåπÈÖçÔºåÈÇÑÈúÄÊªøË∂≥‰ª•‰∏ãÊ¢ù‰ª∂ÊâçÊúÉËß∏Áôº</div>
      <div id="lorebook-condition-list"></div>
      <button class="action-btn secondary" style="width:100%;margin-top:8px" onclick="addLorebookCondition()">‚ûï Ê∑ªÂä†Ê¢ù‰ª∂</button>
      <div style="margin-top:12px">
        <label style="font-size:12px;color:var(--text-secondary)">Ê¢ù‰ª∂ÈÇèËºØ</label>
        <div style="display:flex;gap:16px;margin-top:6px">
          <label style="font-size:13px;display:flex;align-items:center;gap:4px;cursor:pointer">
            <input type="radio" name="lorebook-logic" value="AND" checked> ÂÖ®ÈÉ®ÊªøË∂≥ (AND)
          </label>
          <label style="font-size:13px;display:flex;align-items:center;gap:4px;cursor:pointer">
            <input type="radio" name="lorebook-logic" value="OR"> ‰ªª‰∏ÄÊªøË∂≥ (OR)
          </label>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('lorebook-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveLorebook()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- Á∑®ËºØÊåá‰ª§ Modal -->
<div class="modal" id="edit-inst-modal" style="max-width:500px">
  <div class="modal-title">‚úèÔ∏è Á∑®ËºØÊåá‰ª§</div>
  <div class="form-group">
    <label class="form-label">Êåá‰ª§ÂêçÁ®±</label>
    <input type="text" class="form-input" id="edit-inst-name" placeholder="Ëº∏ÂÖ•Êåá‰ª§ÂêçÁ®±">
  </div>
  <div class="form-group">
    <label class="form-label">Êåá‰ª§ÂÖßÂÆπ</label>
    <textarea class="form-input" id="edit-inst-content" style="min-height:300px;resize:vertical;font-family:monospace;font-size:13px" placeholder="Ëº∏ÂÖ•Êåá‰ª§ÂÖßÂÆπ..."></textarea>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('edit-inst-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveEditInst()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- Á∑®ËºØÊ∂àÊÅØ Modal -->
<div class="modal" id="edit-msg-modal" style="max-width:min(90%,400px)">
  <div class="modal-title">Á∑®ËºØÊ∂àÊÅØ</div>
  <div class="form-group">
    <textarea class="form-input" id="edit-msg-content" style="min-height:200px;resize:vertical" placeholder="Á∑®ËºØÊ∂àÊÅØÂÖßÂÆπ..."></textarea>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('edit-msg-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveEditMsg()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- ÈáçÊñ∞ÁîüÊàê Modal -->
<div class="modal" id="regen-modal">
  <div class="modal-title">üîÑ ÈáçÊñ∞ÁîüÊàê</div>
  <div class="form-group">
    <label class="form-label">Ë£úÂÖÖË™™ÊòéÔºàÂèØÈÅ∏Ôºâ</label>
    <textarea class="form-input" id="regen-note" style="min-height:80px" placeholder="‰æãÂ¶ÇÔºöÊèèÂØ´Êõ¥Á¥∞ËÜ©‰∏Ä‰∫õ„ÄÅË™ûÊ∞£Êõ¥Âº∑Á°¨..."></textarea>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('regen-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="doRegenerate()">ÈáçÊñ∞ÁîüÊàê</button>
  </div>
</div>
<!-- Ë®òÊÜ∂ÁÆ°ÁêÜ Modal -->
<div class="modal" id="memory-modal" style="max-width:min(95%,480px)">
  <div class="modal-title">üß† Ë®òÊÜ∂ÁÆ°ÁêÜ</div>
  <div style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">
    ÁÆ°ÁêÜÊïÖ‰∫ãË®òÊÜ∂ÔºåÂ£ìÁ∏ÆËàäÊ∂àÊÅØÊàñÁîüÊàêÊªæÂãïÊëòË¶ÅÔºå‰øùÊåÅ AI Â∞çÂäáÊÉÖÁöÑÈÄ£Ë≤´ÁêÜËß£„ÄÇ
  </div>
  <div class="form-group">
    <label class="form-label">üìä Áï∂ÂâçÁãÄÊÖã</label>
    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;font-size:13px">
      <div style="display:flex;justify-content:space-between;margin-bottom:4px">
        <span>Á∏ΩÊ∂àÊÅØÊï∏Ôºö<strong id="memory-msg-count">0</strong> Ê¢ù</span>
        <span id="memory-token-estimate" style="color:var(--text-tertiary)"></span>
      </div>
      <div>Â∑≤Â£ìÁ∏ÆÔºö<span id="memory-compressed">0</span> Ê¢ù</div>
      <div>ÊëòË¶ÅÊï∏Ôºö<span id="memory-summary-count">0</span> Ê¢ù 
        <span style="color:var(--primary);cursor:pointer;margin-left:8px" onclick="viewSummaries()">üìñ Êü•Áúã</span>
        <span style="color:var(--primary);cursor:pointer;margin-left:8px" onclick="searchSummaries()">üîç ÊêúÁ¥¢</span>
      </div>
      <div>ÊªæÂãïÊëòË¶ÅÔºö<span id="memory-rolling-count">0</span> Ê¢ù <span style="color:var(--text-tertiary);font-size:11px">(‰∏çÂà™Èô§ÂéüÊñá)</span></div>
      <div id="memory-protected-info" style="color:var(--warning);font-size:12px;margin-top:6px"></div>
    </div>
  </div>
  
  <!-- ÂäüËÉΩÈÅ∏È†ÖÂç° -->
  <div style="display:flex;gap:8px;margin-bottom:12px">
    <button class="modal-btn secondary" id="mem-tab-compress" onclick="switchMemTab('compress')" style="flex:1;font-size:12px;padding:8px">üóúÔ∏è Â£ìÁ∏Æ</button>
    <button class="modal-btn" id="mem-tab-rolling" onclick="switchMemTab('rolling')" style="flex:1;font-size:12px;padding:8px;background:var(--bg-tertiary)">üìú ÊªæÂãï</button>
    <button class="modal-btn" id="mem-tab-analyze" onclick="switchMemTab('analyze')" style="flex:1;font-size:12px;padding:8px;background:var(--bg-tertiary)">üîç ÂàÜÊûê</button>
  </div>
  
  <!-- Â£ìÁ∏ÆÈÅ∏È†Ö -->
  <div id="mem-panel-compress">
    <div class="form-group">
      <label class="form-label">Â£ìÁ∏ÆÊñπÂºè</label>
      <select class="form-select" id="compress-mode" onchange="updateCompressOptions()">
        <option value="count">ÊåâÊ∂àÊÅØÊï∏Èáè</option>
        <option value="chapter">ÊåâÁ´†ÁØÄÂ£ìÁ∏Æ</option>
      </select>
    </div>
    <div class="form-group" id="compress-count-group">
      <label class="form-label">Â£ìÁ∏ÆÊï∏Èáè</label>
      <select class="form-select" id="compress-count">
        <option value="10">Â£ìÁ∏ÆÊúÄÊó© 10 Ê¢ùÊ∂àÊÅØ</option>
        <option value="20">Â£ìÁ∏ÆÊúÄÊó© 20 Ê¢ùÊ∂àÊÅØ</option>
        <option value="50">Â£ìÁ∏ÆÊúÄÊó© 50 Ê¢ùÊ∂àÊÅØ</option>
        <option value="all">Â£ìÁ∏ÆÊâÄÊúâËàäÊ∂àÊÅØÔºà‰øùÁïôÊúÄËøë20Ê¢ùÔºâ</option>
      </select>
    </div>
    <div class="form-group" id="compress-chapter-group" style="display:none">
      <label class="form-label">ÈÅ∏ÊìáÁ´†ÁØÄ</label>
      <select class="form-select" id="compress-chapter"></select>
      <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">Â∞áÂ£ìÁ∏ÆË©≤Á´†ÁØÄ‰πãÂâçÁöÑÊâÄÊúâÊ∂àÊÅØ</div>
    </div>
    <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:12px;padding:8px;background:var(--bg-tertiary);border-radius:6px">
      üí° Â∏∂Êúâ‰ºèÁ≠ÜÊ®ôË®ò„ÄÅÊõ∏Á±§„ÄÅÂäáÊÉÖÊ®ôÁ±§ÁöÑÈáçË¶ÅÊ∂àÊÅØÊúÉËá™ÂãïË∑≥ÈÅé‰øùË≠∑„ÄÇ
    </div>
  </div>
  
  <!-- ÊªæÂãïÊëòË¶ÅÈÅ∏È†Ö -->
  <div id="mem-panel-rolling" style="display:none">
    <div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">
      Ëá™ÂãïÁÇ∫Â∞çË©±ÁîüÊàêËÉåÊôØÊëòË¶ÅÔºå<strong>‰∏çÂà™Èô§ÂéüÊñá</strong>ÔºåÂπ´Âä© AI Êõ¥Â•ΩÂú∞ÁêÜËß£‰∏ä‰∏ãÊñá„ÄÇ
    </div>
    <div class="form-group">
      <label class="form-label">Ëá™ÂãïÊªæÂãïÊëòË¶Å</label>
      <div style="display:flex;align-items:center;gap:12px">
        <div class="toggle" id="tog-rolling-summary" onclick="toggleRollingSummary()"></div>
        <span style="font-size:13px;color:var(--text-secondary)">ÊØè <input type="number" id="rolling-interval" value="30" min="10" max="100" style="width:50px;padding:4px;border:1px solid var(--divider);border-radius:4px;background:var(--bg-tertiary);color:var(--text-primary)"> Ê¢ùÊ∂àÊÅØËá™ÂãïÁîüÊàê</span>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">ÊâãÂãïÊìç‰Ωú</label>
      <button class="modal-btn secondary" onclick="generateRollingSummary()" style="width:100%;margin-bottom:8px">üìú Á´ãÂç≥ÁîüÊàêÊªæÂãïÊëòË¶Å</button>
      <button class="modal-btn" onclick="mergeSummaries()" style="width:100%;background:var(--bg-tertiary)">üîó Âêà‰ΩµÂ§öÊ¢ùÊëòË¶Å</button>
    </div>
  </div>
  
  <!-- Êô∫ËÉΩÂàÜÊûêÈÅ∏È†Ö -->
  <div id="mem-panel-analyze" style="display:none">
    <div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">
      ËÆì AI ÂàÜÊûêÁï∂ÂâçÂ∞çË©±ÔºåË≠òÂà•Âì™‰∫õÂÖßÂÆπÈáçË¶Å„ÄÅÂì™‰∫õÂèØ‰ª•ÂÆâÂÖ®Â£ìÁ∏Æ„ÄÇ
    </div>
    <button class="modal-btn secondary" onclick="analyzeMemory()" style="width:100%;margin-bottom:12px">üîç AI Êô∫ËÉΩÂàÜÊûê</button>
    <div id="memory-analysis-result" style="display:none;background:var(--bg-tertiary);padding:12px;border-radius:8px;font-size:13px;max-height:200px;overflow-y:auto"></div>
  </div>
  
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('memory-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" id="mem-compress-btn" onclick="compressMemory()">ü§ñ Êô∫ËÉΩÂ£ìÁ∏Æ</button>
  </div>
</div>
<!-- ÊëòË¶ÅÊü•Áúã Modal -->
<div class="modal" id="summaries-modal" style="max-width:min(95%,500px)">
  <div class="modal-title">üìö Ë®òÊÜ∂ÊëòË¶Å</div>
  <div id="summaries-list" style="max-height:60vh;overflow-y:auto"></div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('summaries-modal')">ÈóúÈñâ</button>
    <button class="modal-btn" style="background:var(--error)" onclick="clearAllSummaries()">üóëÔ∏è Ê∏ÖÁ©∫ÊëòË¶Å</button>
  </div>
</div>
<!-- ÊëòË¶ÅÊêúÁ¥¢ Modal -->
<div class="modal" id="summary-search-modal" style="max-width:min(95%,500px)">
  <div class="modal-title">üîç ÊêúÁ¥¢Ë®òÊÜ∂ÊëòË¶Å</div>
  <div class="form-group">
    <input type="text" class="form-input" id="summary-search-input" placeholder="Ëº∏ÂÖ•ÈóúÈçµË©ûÊêúÁ¥¢ÊëòË¶ÅÂÖßÂÆπ" oninput="doSummarySearch()">
  </div>
  <div id="summary-search-results" style="max-height:50vh;overflow-y:auto">
    <div class="empty"><div class="empty-icon">üîç</div><div class="empty-title">Ëº∏ÂÖ•ÈóúÈçµË©ûÊêúÁ¥¢</div></div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('summary-search-modal')">ÈóúÈñâ</button>
  </div>
</div>
<!-- Êü•ÊâæÊõøÊèõ Modal -->
<div class="modal" id="find-replace-modal">
  <div class="modal-title">üîç Êü•ÊâæËàáÊõøÊèõ</div>
  <div class="form-group">
    <label class="form-label">Êü•Êâæ</label>
    <input type="text" class="form-input" id="find-text" placeholder="Ëº∏ÂÖ•Ë¶ÅÊü•ÊâæÁöÑÊñáÂ≠ó">
  </div>
  <div class="form-group">
    <label class="form-label">ÊõøÊèõÁÇ∫</label>
    <input type="text" class="form-input" id="replace-text" placeholder="Ëº∏ÂÖ•ÊõøÊèõÂæåÁöÑÊñáÂ≠ó">
  </div>
  <div class="form-group">
    <label style="font-size:13px;color:var(--text-secondary);display:flex;align-items:center;gap:6px;cursor:pointer">
      <input type="checkbox" id="find-case-sensitive"> ÂçÄÂàÜÂ§ßÂ∞èÂØ´
    </label>
  </div>
  <div id="find-result" style="font-size:13px;color:var(--text-tertiary);margin-bottom:12px"></div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('find-replace-modal')">ÈóúÈñâ</button>
    <button class="modal-btn secondary" onclick="findNext()">Êü•Êâæ‰∏ã‰∏ÄÂÄã</button>
    <button class="modal-btn confirm" onclick="replaceAll()">ÂÖ®ÈÉ®ÊõøÊèõ</button>
  </div>
</div>
<!-- Áµ±Ë®àÈù¢Êùø Modal -->
<div class="modal" id="stats-modal">
  <div class="modal-title">üìä Áµ±Ë®àÈù¢Êùø</div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;text-align:center">
      <div style="font-size:24px;font-weight:bold;color:var(--primary)" id="stats-chars">0</div>
      <div style="font-size:12px;color:var(--text-tertiary)">Á∏ΩÂ≠óÊï∏</div>
    </div>
    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;text-align:center">
      <div style="font-size:24px;font-weight:bold;color:var(--primary)" id="stats-msgs">0</div>
      <div style="font-size:12px;color:var(--text-tertiary)">Ê∂àÊÅØÊï∏</div>
    </div>
    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;text-align:center">
      <div style="font-size:24px;font-weight:bold;color:var(--primary)" id="stats-tokens">0</div>
      <div style="font-size:12px;color:var(--text-tertiary)">Á∏Ω Tokens</div>
    </div>
    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;text-align:center">
      <div style="font-size:24px;font-weight:bold;color:var(--primary)" id="stats-time">0h</div>
      <div style="font-size:12px;color:var(--text-tertiary)">ÈÅäÁé©ÊôÇÈï∑</div>
    </div>
  </div>
  <div style="margin-top:16px;padding:12px;background:var(--bg-tertiary);border-radius:8px;font-size:13px">
    <div style="margin-bottom:8px"><strong>Áî®Êà∂Ëº∏ÂÖ•Ôºö</strong><span id="stats-user-chars">0</span> Â≠ó</div>
    <div><strong>AI ÁîüÊàêÔºö</strong><span id="stats-ai-chars">0</span> Â≠ó</div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn confirm" onclick="closeModal('stats-modal')">ÈóúÈñâ</button>
  </div>
</div>
<!-- Ê∑ªÂä†Á´†ÁØÄ Modal -->
<div class="modal" id="chapter-modal">
  <div class="modal-title">üìë Ê∑ªÂä†Á´†ÁØÄ</div>
  <div class="form-group">
    <label class="form-label">Á´†ÁØÄÊ®ôÈ°å</label>
    <input type="text" class="form-input" id="chapter-title" placeholder="‰æãÂ¶ÇÔºöÁ¨¨‰∏ÄÁ´†„ÉªÂÖ•ÂÆÆ">
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('chapter-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveChapter()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- Ê∑ªÂä†Êõ∏Á±§ Modal -->
<div class="modal" id="bookmark-modal">
  <div class="modal-title">üîñ Ê∑ªÂä†Êõ∏Á±§</div>
  <div class="form-group">
    <label class="form-label">Êõ∏Á±§ÂêçÁ®±</label>
    <input type="text" class="form-input" id="bookmark-name" placeholder="‰æãÂ¶ÇÔºöÈáçË¶ÅÂäáÊÉÖÈªû">
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('bookmark-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveBookmark()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- Ê∑ªÂä†Ê®ôÁ±§ Modal -->
<div class="modal" id="tag-modal">
  <div class="modal-title">üè∑Ô∏è Ê∑ªÂä†ÂäáÊÉÖÊ®ôÁ±§</div>
  <div class="form-group">
    <label class="form-label">Ê®ôÁ±§È°ûÂûã</label>
    <select class="form-select" id="tag-type">
      <option value="key">üîë ÈóúÈçµÂäáÊÉÖ</option>
      <option value="scene">üé¨ ÂêçÂ†¥Èù¢</option>
      <option value="clue">üîç Á∑öÁ¥¢</option>
      <option value="turning">üîÑ ËΩâÊäòÈªû</option>
      <option value="emotion">üíï ÊÉÖÊÑüÊà≤</option>
    </select>
  </div>
  <div class="form-group">
    <label class="form-label">ÂÇôË®ªÔºàÂèØÈÅ∏Ôºâ</label>
    <input type="text" class="form-input" id="tag-note" placeholder="Á∞°Áü≠ÊèèËø∞">
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('tag-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="savePlotTag()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- ÂâµÂª∫ÂàÜÊîØ Modal -->
<div class="modal" id="branch-modal">
  <div class="modal-title">üîÄ ÂâµÂª∫ÂàÜÊîØ</div>
  <div class="form-group">
    <label class="form-label">ÂàÜÊîØÂêçÁ®±</label>
    <input type="text" class="form-input" id="branch-name" placeholder="‰æãÂ¶ÇÔºöÈÅ∏ÊìáÂπ´Âä©Â§úÂØí">
  </div>
  <div class="form-group">
    <label class="form-label">ÂàÜÊîØÊèèËø∞ÔºàÂèØÈÅ∏Ôºâ</label>
    <textarea class="form-input" id="branch-desc" style="min-height:60px" placeholder="ÈÄôÂÄãÂàÜÊîØÁöÑÁâπÈªû..."></textarea>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('branch-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveBranch()">ÂâµÂª∫</button>
  </div>
</div>
<!-- AI ‰∏ÄËá¥ÊÄßÊ™¢Êü• Modal -->
<div class="modal" id="ai-check-modal" style="max-width:min(90%,400px)">
  <div class="modal-title">üîç AI ‰∏ÄËá¥ÊÄßÊ™¢Êü•</div>
  <div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">
    AI Â∞áÂàÜÊûêÊïÖ‰∫ãÂÖßÂÆπÔºåÊ™¢Êü•ÊòØÂê¶Â≠òÂú®Ë®≠ÂÆöÁüõÁõæ„ÄÅÊôÇÈñìÁ∑öÈåØË™§„ÄÅËßíËâ≤Ë°åÁÇ∫‰∏ç‰∏ÄËá¥Á≠âÂïèÈ°å„ÄÇ
  </div>
  <div id="ai-check-result" style="background:var(--bg-tertiary);padding:12px;border-radius:8px;min-height:100px;max-height:300px;overflow-y:auto;font-size:13px;white-space:pre-wrap">
    ÈªûÊìä„ÄåÈñãÂßãÊ™¢Êü•„ÄçÈÄ≤Ë°åÂàÜÊûê...
  </div>
  <div class="modal-actions" style="flex-wrap:wrap;gap:8px">
    <button class="modal-btn secondary" id="ai-fix-btn" style="display:none;flex:0 0 auto" onclick="showAiFix()">üîß ÊáâÁî®‰øÆÂæ©</button>
    <button class="modal-btn cancel" onclick="closeModal('ai-check-modal')">ÈóúÈñâ</button>
    <button class="modal-btn confirm" onclick="doAiConsistencyCheck()">ÈñãÂßãÊ™¢Êü•</button>
  </div>
</div>
<!-- AI ‰øÆÂæ©Âª∫Ë≠∞ Modal -->
<div class="modal" id="ai-fix-modal" style="max-width:min(90%,400px)">
  <div class="modal-title">üîß AI ‰øÆÂæ©Âª∫Ë≠∞</div>
  <div style="font-size:14px;margin-bottom:16px">
    ÈÅ∏ÊìáÂ¶Ç‰ΩïËôïÁêÜÁôºÁèæÁöÑÂïèÈ°åÔºö
  </div>
  <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px">
    <button class="action-btn secondary" style="text-align:left;padding:12px" onclick="applyAiFix('auto')">ü§ñ <strong>AI Ëá™Âãï‰øÆÂæ©</strong><br><span style="font-size:12px;color:var(--text-secondary)">Âú®‰∏ãÊ¨° AI ÂõûË¶Ü‰∏≠Ëá™ÁÑ∂Âú∞Á≥æÊ≠£ÂïèÈ°å</span></button>
    <button class="action-btn secondary" style="text-align:left;padding:12px" onclick="applyAiFix('note')">üìù <strong>Ê∑ªÂä†Ë®≠ÂÆöÁ≠ÜË®ò</strong><br><span style="font-size:12px;color:var(--text-secondary)">Ë®òÈåÑÂà∞‰∏ñÁïåËßÄË≥áÊñôÂ∫´‰æõÊó•ÂæåÂèÉËÄÉ</span></button>
    <button class="action-btn secondary" style="text-align:left;padding:12px" onclick="applyAiFix('ignore')">üîï <strong>ÂøΩÁï•ÈÄôÊ¨°</strong><br><span style="font-size:12px;color:var(--text-secondary)">ÈÄôÂÄã„ÄåÂïèÈ°å„ÄçÂèØËÉΩÊòØÊïÖÊÑèË®≠Ë®àÁöÑ</span></button>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('ai-fix-modal')">ÂèñÊ∂à</button>
  </div>
</div>
<!-- v7: ËßíËâ≤ÁãÄÊÖãÊõ¥Êñ∞ Modal -->
<div class="modal" id="char-update-modal" style="max-width:min(90%,420px)">
  <div class="modal-title">ü§ñ AI ËßíËâ≤ÂàÜÊûê</div>
  <div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">
    AI ÊúÉÂàÜÊûêÊïÖ‰∫ãÂÖßÂÆπÔºåËá™ÂãïË≠òÂà•ËßíËâ≤‰∏¶ÊèêÂèñÂ±¨ÊÄß„ÄÇÈÄôÂèØËÉΩÈúÄË¶Å‰∏Ä‰∫õÊôÇÈñì„ÄÇ
  </div>
  <div id="char-update-result" style="background:var(--bg-tertiary);padding:12px;border-radius:8px;min-height:80px;max-height:250px;overflow-y:auto;font-size:12px;white-space:pre-wrap">
    ÈªûÊìä„ÄåÈñãÂßãÂàÜÊûê„ÄçËÆì AI Ë≠òÂà•ËßíËâ≤...
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('char-update-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" id="char-update-btn" onclick="doCharacterUpdate()">ÈñãÂßãÂàÜÊûê</button>
  </div>
</div>
<!-- v7: ÊâãÂãïÊ∑ªÂä†ËßíËâ≤ Modal -->
<div class="modal" id="char-add-modal" style="max-width:min(90%,400px)">
  <div class="modal-title">‚ûï Ê∑ªÂä†ËßíËâ≤</div>
  <div class="form-group">
    <label class="form-label">ËßíËâ≤ÂêçÁ®± *</label>
    <input type="text" class="form-input" id="char-add-name" placeholder="‰æãÂ¶ÇÔºöÂ§úÂØí">
  </div>
  <div class="form-group">
    <label class="form-label">È†≠Èäú/Ë∫´‰ªΩ</label>
    <input type="text" class="form-input" id="char-add-title" placeholder="‰æãÂ¶ÇÔºöÁöáÂ§´">
  </div>
  <div class="form-group">
    <label class="form-label">È†≠ÂÉè Emoji</label>
    <input type="text" class="form-input" id="char-add-avatar" placeholder="‰æãÂ¶ÇÔºöüåô" maxlength="4">
  </div>
  <div class="form-group">
    <label class="form-label">Á∞°‰ªã</label>
    <textarea class="form-textarea" id="char-add-desc" rows="2" placeholder="Á∞°Áü≠ÊèèËø∞ËßíËâ≤ËÉåÊôØ..."></textarea>
  </div>
  <div class="form-group">
    <label class="form-label">Â±¨ÊÄßÔºàÊØèË°å‰∏ÄÂÄãÔºåÊ†ºÂºèÔºöÂ±¨ÊÄßÂêç:Êï∏ÂÄºÔºâ</label>
    <textarea class="form-textarea" id="char-add-stats" rows="4" placeholder="Â•ΩÊÑü:50&#10;Âø†Ë™†:60&#10;ÈáéÂøÉ:30"></textarea>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('char-add-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveCharacterManual()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- v7: ËßíËâ≤Ë©≥ÊÉÖ/Á∑®ËºØ Modal -->
<div class="modal" id="char-detail-modal" style="max-width:min(90%,420px)">
  <div class="modal-title" id="char-detail-title">ËßíËâ≤Ë©≥ÊÉÖ</div>
  <div id="char-detail-content" style="max-height:50vh;overflow-y:auto"></div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('char-detail-modal')">ÈóúÈñâ</button>
    <button class="modal-btn" onclick="exportCurrentCharacter()">üì§ Â∞éÂá∫</button>
    <button class="modal-btn secondary" onclick="editCharacter()">Á∑®ËºØ</button>
    <button class="modal-btn" style="background:var(--error);color:white" onclick="deleteCharacter()">Âà™Èô§</button>
  </div>
</div>
<!-- v7: ËßíËâ≤Ê≠∑Âè≤Ë®òÈåÑ Modal -->
<div class="modal" id="char-history-modal" style="max-width:min(90%,400px)">
  <div class="modal-title">üìú Â±¨ÊÄßËÆäÂåñÊ≠∑Âè≤</div>
  <div id="char-history-content" style="max-height:50vh;overflow-y:auto"></div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('char-history-modal')">ÈóúÈñâ</button>
  </div>
</div>
<!-- AI Á´†ÁØÄÁ∏ΩÁµê Modal -->
<div class="modal" id="ai-summary-modal" style="max-width:min(90%,400px)">
  <div class="modal-title">üìù AI Á´†ÁØÄÁ∏ΩÁµê</div>
  <div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">
    AI Â∞áËá™ÂãïÁîüÊàêÁï∂ÂâçÊïÖ‰∫ãÈÄ≤Â∫¶ÁöÑÊëòË¶ÅÔºåÂåÖÊã¨‰∏ªË¶Å‰∫ã‰ª∂„ÄÅËßíËâ≤ÁãÄÊÖãËÆäÂåñÁ≠â„ÄÇ
  </div>
  <div id="ai-summary-result" style="background:var(--bg-tertiary);padding:12px;border-radius:8px;min-height:100px;max-height:300px;overflow-y:auto;font-size:13px;white-space:pre-wrap">
    ÈªûÊìä„ÄåÁîüÊàêÁ∏ΩÁµê„ÄçÈñãÂßã...
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('ai-summary-modal')">ÈóúÈñâ</button>
    <button class="modal-btn secondary" onclick="copySummary()">Ë§áË£Ω</button>
    <button class="modal-btn confirm" onclick="doAiChapterSummary()">ÁîüÊàêÁ∏ΩÁµê</button>
  </div>
</div>
<!-- AI Ë°åÂãïÂª∫Ë≠∞ Modal -->
<div class="modal" id="ai-suggest-modal" style="max-width:min(90%,400px)">
  <div class="modal-title">üí° AI Ë°åÂãïÂª∫Ë≠∞</div>
  <div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">
    Âç°Èóú‰∫ÜÔºüËÆì AI ÁÇ∫‰Ω†Êèê‰æõ‰∏Ä‰∫õÂèØËÉΩÁöÑË°åÂãïÊñπÂêë„ÄÇ
  </div>
  <div id="ai-suggest-result" style="background:var(--bg-tertiary);padding:12px;border-radius:8px;min-height:100px;max-height:300px;overflow-y:auto;font-size:13px;white-space:pre-wrap">
    ÈªûÊìä„ÄåÁç≤ÂèñÂª∫Ë≠∞„ÄçÈñãÂßã...
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('ai-suggest-modal')">ÈóúÈñâ</button>
    <button class="modal-btn confirm" onclick="doAiSuggestions()">Áç≤ÂèñÂª∫Ë≠∞</button>
  </div>
</div>
<!-- È´òÁ¥öÊêúÁ¥¢ Modal -->
<div class="modal" id="advanced-search-modal">
  <div class="modal-title">üîç È´òÁ¥öÊêúÁ¥¢</div>
  <div class="form-group">
    <label class="form-label">ÈóúÈçµË©û</label>
    <input type="text" class="form-input" id="adv-search-keyword" placeholder="Ëº∏ÂÖ•ÊêúÁ¥¢ÈóúÈçµË©û">
  </div>
  <div class="form-group">
    <label class="form-label">ÊêúÁ¥¢ÁØÑÂúç</label>
    <select class="form-select" id="adv-search-scope">
      <option value="all">ÂÖ®ÈÉ®ÂÖßÂÆπ</option>
      <option value="user">ÂÉÖÁî®Êà∂Ëº∏ÂÖ•</option>
      <option value="ai">ÂÉÖ AI ÂõûÂæ©</option>
    </select>
  </div>
  <div class="form-group">
    <label style="font-size:13px;color:var(--text-secondary);display:flex;align-items:center;gap:6px;cursor:pointer">
      <input type="checkbox" id="adv-search-case"> ÂçÄÂàÜÂ§ßÂ∞èÂØ´
    </label>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('advanced-search-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="doAdvancedSearch()">ÊêúÁ¥¢</button>
  </div>
</div>
<!-- Ë≥áÊñôÁ∑®ËºØ Modal -->
<div class="modal" id="lore-modal">
  <div class="modal-title">üìñ Ë≥áÊñôË®≠ÂÆö</div>
  <div class="form-group">
    <label class="form-label">ÂêçÁ®±</label>
    <input type="text" class="form-input" id="lore-name" placeholder="‰æãÂ¶ÇÔºöÂ§úÂØí„ÄÅÈ≥≥ÂÑÄÂÆÆ">
  </div>
  <div class="form-group">
    <label class="form-label">È°ûÂûã</label>
    <select class="form-select" id="lore-category">
      <option value="character">üë• ËßíËâ≤</option>
      <option value="location">üó∫Ô∏è Âú∞Èªû</option>
      <option value="item">üì¶ Áâ©ÂìÅ</option>
      <option value="setting">üìú Ë®≠ÂÆö</option>
    </select>
  </div>
  <div class="form-group">
    <label class="form-label">Á∞°‰ªã</label>
    <input type="text" class="form-input" id="lore-desc" placeholder="Á∞°Áü≠ÊèèËø∞">
  </div>
  <div class="form-group">
    <label class="form-label">Ë©≥Á¥∞ÂÖßÂÆπ</label>
    <textarea class="form-input" id="lore-content-input" style="min-height:100px" placeholder="Ë©≥Á¥∞Ë®≠ÂÆöÂÖßÂÆπÔºåÊúÉ‰ΩúÁÇ∫‰∏ä‰∏ãÊñáÁôºÈÄÅÁµ¶ AI"></textarea>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('lore-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveLore()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- ÊôÇÈñìËª∏Á∑®ËºØ Modal -->
<div class="modal" id="timeline-modal">
  <div class="modal-title">üìÖ Ê∑ªÂä†ÊôÇÈñìÈªû</div>
  <div class="form-group">
    <label class="form-label">ÊôÇÈñìÊ®ôË®ò</label>
    <input type="text" class="form-input" id="timeline-label" placeholder="‰æãÂ¶ÇÔºöÊò≠È≥≥ÂÖÉÂπ¥„Éª‰∏ÄÊúà‰∫åÊó•">
  </div>
  <div class="form-group">
    <label class="form-label">‰∫ã‰ª∂ÊèèËø∞</label>
    <textarea class="form-input" id="timeline-event" style="min-height:60px" placeholder="ÈÄôÂÄãÊôÇÈñìÈªûÁôºÁîü‰∫Ü‰ªÄÈ∫º"></textarea>
  </div>
  <div class="form-group">
    <label style="font-size:13px;color:var(--text-secondary);display:flex;align-items:center;gap:6px;cursor:pointer">
      <input type="checkbox" id="timeline-set-current" checked> Ë®≠ÁÇ∫Áï∂ÂâçÊïÖ‰∫ãÊôÇÈñì
    </label>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('timeline-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveTimeline()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- iOS ÂÆâË£ùÊåáÂºï Modal -->
<div class="modal" id="ios-install-modal">
  <div class="modal-title">üì± Âú® iPhone ‰∏äÂÆâË£ù</div>
  <div class="modal-content" style="text-align:center">
    <p style="margin-bottom:16px;font-size:15px">Ë´ãÊåâÁÖß‰ª•‰∏ãÊ≠•È©üÂÆâË£ùÂà∞‰∏ªÁï´Èù¢Ôºö</p>
    <div style="text-align:left;background:var(--bg-tertiary);padding:16px;border-radius:8px;margin-bottom:16px">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
        <span style="font-size:24px">1Ô∏è‚É£</span>
        <span>ÈªûÊìäÂ∫ïÈÉ®ÁöÑ <strong>ÂàÜ‰∫´ÊåâÈàï</strong> <span style="font-size:18px">‚¨ÜÔ∏è</span></span>
      </div>
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
        <span style="font-size:24px">2Ô∏è‚É£</span>
        <span>Âêë‰∏ãÊªëÂãïÔºåÈªûÊìä <strong>„ÄåÂä†ÂÖ•‰∏ªÁï´Èù¢„Äç</strong></span>
      </div>
      <div style="display:flex;align-items:center;gap:12px">
        <span style="font-size:24px">3Ô∏è‚É£</span>
        <span>ÈªûÊìä <strong>„ÄåÊñ∞Â¢û„Äç</strong> ÂÆåÊàêÂÆâË£ù</span>
      </div>
    </div>
    <p style="font-size:12px;color:var(--text-tertiary)">ÂÆâË£ùÂæåÔºåÁπîÂ§¢ÊúÉÂÉèÊôÆÈÄö App ‰∏ÄÊ®£Âá∫ÁèæÂú®ÊÇ®ÁöÑ‰∏ªÁï´Èù¢</p>
  </div>
  <div class="modal-actions">
    <button class="modal-btn confirm" onclick="closeModal('ios-install-modal')">Áü•ÈÅì‰∫Ü</button>
  </div>
</div>
<!-- ÂêëÂ∞éËßíËâ≤Á∑®ËºØ Modal -->
<div class="modal" id="wizard-char-modal">
  <div class="modal-title">üë§ ËßíËâ≤Ë®≠ÂÆö</div>
  <input type="hidden" id="wiz-char-idx" value="-1">
  <div class="form-group">
    <label class="form-label">ËßíËâ≤ÂêçÁ®±</label>
    <input type="text" class="form-input" id="wiz-char-name" placeholder="Â¶ÇÔºöÂ§úÂØí„ÄÅÈõ≤ÊÉú...">
  </div>
  <div class="form-group">
    <label class="form-label">Ë∫´‰ªΩÂú∞‰Ωç</label>
    <input type="text" class="form-input" id="wiz-char-role" placeholder="Â¶ÇÔºöÁöáÂ§´„ÄÅË≤ºË∫´‰æçÂ•≥...">
  </div>
  <div class="form-group">
    <label class="form-label">ÊÄßÊ†ºÁâπÈªû</label>
    <input type="text" class="form-input" id="wiz-char-personality" placeholder="Â¶ÇÔºöÊ∑±Ê≤âËÖπÈªë„ÄÅÂø†Ë™†Ê©üÊïè...">
  </div>
  <div class="form-group">
    <label class="form-label">Ëàá‰∏ªËßíÈóú‰øÇ</label>
    <input type="text" class="form-input" id="wiz-char-relation" placeholder="Â¶ÇÔºöË°®Èù¢ÊÅ≠È†ÜÊöóÊá∑ÈáéÂøÉ„ÄÅÁµïÂ∞çÂø†Ë™†...">
  </div>
  <div class="form-group">
    <label class="form-label">Ë©≥Á¥∞ÊèèËø∞ÔºàÂèØÈÅ∏Ôºâ</label>
    <textarea class="form-input" id="wiz-char-desc" style="min-height:80px" placeholder="ËßíËâ≤ÁöÑÊõ¥Â§öÁ¥∞ÁØÄ..."></textarea>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('wizard-char-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveWizardChar()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- ËÅäÂ§©ËÉåÊôØ Modal -->
<div class="modal" id="chat-bg-modal">
  <div class="modal-title">üñºÔ∏è ËÅäÂ§©ËÉåÊôØË®≠ÁΩÆ</div>
  <div class="form-group">
    <label class="form-label">ÈÅ∏ÊìáËÉåÊôØ</label>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
      <div class="bg-option" data-bg="none" onclick="selectBg('none')" style="aspect-ratio:3/4;background:var(--bg-primary);border:2px solid var(--divider);border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--text-tertiary)">ÈªòË™ç</div>
      <div class="bg-option" data-bg="gradient1" onclick="selectBg('gradient1')" style="aspect-ratio:3/4;background:linear-gradient(135deg,#1a1a2e,#16213e);border:2px solid var(--divider);border-radius:8px;cursor:pointer"></div>
      <div class="bg-option" data-bg="gradient2" onclick="selectBg('gradient2')" style="aspect-ratio:3/4;background:linear-gradient(135deg,#0f0f1a,#1e1e32);border:2px solid var(--divider);border-radius:8px;cursor:pointer"></div>
      <div class="bg-option" data-bg="gradient3" onclick="selectBg('gradient3')" style="aspect-ratio:3/4;background:linear-gradient(135deg,#1a0a0a,#2a1515);border:2px solid var(--divider);border-radius:8px;cursor:pointer"></div>
      <div class="bg-option" data-bg="gradient4" onclick="selectBg('gradient4')" style="aspect-ratio:3/4;background:linear-gradient(135deg,#0a1a0a,#152a15);border:2px solid var(--divider);border-radius:8px;cursor:pointer"></div>
      <div class="bg-option" data-bg="custom" onclick="uploadChatBg()" style="aspect-ratio:3/4;background:var(--bg-tertiary);border:2px dashed var(--divider);border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px">üì∑</div>
    </div>
    <div id="current-bg-preview" style="display:none;margin-bottom:12px">
      <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:6px">Áï∂ÂâçËá™ÂÆöÁæ©ËÉåÊôØÔºö</div>
      <div id="bg-preview-img" style="width:100%;aspect-ratio:16/9;background-size:cover;background-position:center;border-radius:8px"></div>
      <button class="modal-btn cancel" style="margin-top:8px;width:100%" onclick="clearChatBg()">Ê∏ÖÈô§Ëá™ÂÆöÁæ©ËÉåÊôØ</button>
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('chat-bg-modal')">ÈóúÈñâ</button>
  </div>
</div>
<!-- ÊïÖ‰∫ãÁ¥öÂà• AI ÂèÉÊï∏Ë®≠ÁΩÆ Modal -->
<div class="modal" id="story-ai-params-modal" style="max-height:85vh;overflow-y:auto">
  <div class="modal-title">üéõÔ∏è Êú¨ÊïÖ‰∫ã AI ÂèÉÊï∏</div>
  <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:16px">ÁÇ∫Áï∂ÂâçÊïÖ‰∫ãË®≠ÁΩÆÁç®Á´ãÁöÑ AI ÂèÉÊï∏Ôºå‰∏çÂΩ±ÈüøÂÖ∂‰ªñÊïÖ‰∫ã</div>
  
  <div style="padding:10px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px">
    <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
      <input type="checkbox" id="story-ai-use-custom" onchange="toggleStoryAICustom(this.checked)" style="width:18px;height:18px">
      <span style="font-size:13px">‰ΩøÁî®Ëá™ÂÆöÁæ©ÂèÉÊï∏ÔºàÂê¶Ââá‰ΩøÁî®ÂÖ®Â±ÄÈªòË™çÂÄºÔºâ</span>
    </label>
  </div>
  
  <div id="story-ai-params-container" style="opacity:0.5;pointer-events:none">
    <div class="form-group">
      <label class="form-label" style="display:flex;justify-content:space-between;align-items:center">
        <span>üé® ÂâµÊÑèÂ∫¶ (Temperature)</span>
        <span id="story-temp-value" style="color:var(--primary);font-weight:600">0.8</span>
      </label>
      <input type="range" id="story-temp-slider" min="0" max="200" value="80" style="width:100%" oninput="updateStoryAIParam('temperature',this.value/100)">
      <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-tertiary);margin-top:4px">
        <span>‰øùÂÆàÁ©©ÂÆö</span>
        <span>ÂâµÊÑèÂ•îÊîæ</span>
      </div>
    </div>
    
    <div class="form-group">
      <label class="form-label" style="display:flex;justify-content:space-between;align-items:center">
        <span>üìä Ë©ûÂΩôÂ§öÊ®£ÊÄß (Top P)</span>
        <span id="story-topp-value" style="color:var(--primary);font-weight:600">0.9</span>
      </label>
      <input type="range" id="story-topp-slider" min="0" max="100" value="90" style="width:100%" oninput="updateStoryAIParam('topP',this.value/100)">
      <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-tertiary);margin-top:4px">
        <span>Á≤æÊ∫ñ</span>
        <span>Â§öÊ®£</span>
      </div>
    </div>
    
    <div class="form-group">
      <label class="form-label" style="display:flex;justify-content:space-between;align-items:center">
        <span>üîÑ Ê∏õÂ∞ëÈáçË§á (Frequency Penalty)</span>
        <span id="story-freq-value" style="color:var(--primary);font-weight:600">0.3</span>
      </label>
      <input type="range" id="story-freq-slider" min="0" max="200" value="30" style="width:100%" oninput="updateStoryAIParam('frequencyPenalty',this.value/100)">
      <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-tertiary);margin-top:4px">
        <span>ÂÖÅË®±ÈáçË§á</span>
        <span>Âº∑Âà∂Â§öÊ®£</span>
      </div>
    </div>
    
    <div class="form-group">
      <label class="form-label" style="display:flex;justify-content:space-between;align-items:center">
        <span>üí° ÈºìÂãµÊñ∞Ë©±È°å (Presence Penalty)</span>
        <span id="story-pres-value" style="color:var(--primary);font-weight:600">0.1</span>
      </label>
      <input type="range" id="story-pres-slider" min="0" max="200" value="10" style="width:100%" oninput="updateStoryAIParam('presencePenalty',this.value/100)">
      <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-tertiary);margin-top:4px">
        <span>Âª∂Á∫åË©±È°å</span>
        <span>ÂºïÂÖ•Êñ∞Ë©±È°å</span>
      </div>
    </div>
    
    <div style="padding:12px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px">
      <div style="font-size:12px;font-weight:600;margin-bottom:8px">üéØ Âø´ÈÄüÈ†êË®≠</div>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
        <button class="modal-btn" style="padding:8px;font-size:12px" onclick="applyStoryAIPreset('creative')">üé® ÂâµÊÑèÂØ´‰Ωú</button>
        <button class="modal-btn" style="padding:8px;font-size:12px" onclick="applyStoryAIPreset('balanced')">‚öñÔ∏è Âπ≥Ë°°Ê®°Âºè</button>
        <button class="modal-btn" style="padding:8px;font-size:12px" onclick="applyStoryAIPreset('precise')">üéØ Á≤æÊ∫ñÊïò‰∫ã</button>
        <button class="modal-btn" style="padding:8px;font-size:12px" onclick="applyStoryAIPreset('wild')">üå™Ô∏è Â§©È¶¨Ë°åÁ©∫</button>
      </div>
    </div>
  </div>
  
  <div id="story-ai-current-info" style="padding:10px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px;font-size:12px">
    <div style="font-weight:600;margin-bottom:6px">üìã Áï∂ÂâçÁîüÊïàÂèÉÊï∏</div>
    <div id="story-ai-effective-params" style="color:var(--text-secondary)"></div>
  </div>
  
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('story-ai-params-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveStoryAIParams()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- AI ÂèÉÊï∏Ë®≠ÁΩÆ ModalÔºàÂÖ®Â±ÄÈªòË™çÂÄºÔºâ -->
<div class="modal" id="ai-params-modal" style="max-height:85vh;overflow-y:auto">
  <div class="modal-title">üéõÔ∏è AI ÂèÉÊï∏ÈªòË™çÂÄº</div>
  <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:16px">Ë®≠ÁΩÆÊñ∞ÊïÖ‰∫ãÁöÑÈªòË™ç AI ÂèÉÊï∏ÔºåÂ∑≤ÊúâÊïÖ‰∫ãÂèØÂú®ÊïÖ‰∫ãË®≠ÁΩÆ‰∏≠ÂñÆÁç®Ë™øÊï¥</div>
  
  <div class="form-group">
    <label class="form-label" style="display:flex;justify-content:space-between;align-items:center">
      <span>üé® ÂâµÊÑèÂ∫¶ (Temperature)</span>
      <span id="temp-value" style="color:var(--primary);font-weight:600">0.8</span>
    </label>
    <input type="range" id="temp-slider" min="0" max="200" value="80" style="width:100%" oninput="updateAIParam('temperature',this.value/100)">
    <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-tertiary);margin-top:4px">
      <span>‰øùÂÆàÁ©©ÂÆö</span>
      <span>ÂâµÊÑèÂ•îÊîæ</span>
    </div>
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:6px">0.0-0.5 ÈÅ©ÂêàÂäáÊÉÖÊé®ÈÄ≤Ôºå0.7-1.0 ÈÅ©ÂêàÂâµÊÑèÂØ´‰ΩúÔºå1.0+ Êõ¥Èö®Ê©ü</div>
  </div>
  
  <div class="form-group">
    <label class="form-label" style="display:flex;justify-content:space-between;align-items:center">
      <span>üìä Ë©ûÂΩôÂ§öÊ®£ÊÄß (Top P)</span>
      <span id="topp-value" style="color:var(--primary);font-weight:600">0.9</span>
    </label>
    <input type="range" id="topp-slider" min="0" max="100" value="90" style="width:100%" oninput="updateAIParam('topP',this.value/100)">
    <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-tertiary);margin-top:4px">
      <span>Á≤æÊ∫ñ</span>
      <span>Â§öÊ®£</span>
    </div>
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:6px">ÊéßÂà∂Ë©ûÂΩôÈÅ∏ÊìáÁØÑÂúçÔºå0.9-1.0 ËºÉÂ∏∏Áî®</div>
  </div>
  
  <div class="form-group">
    <label class="form-label" style="display:flex;justify-content:space-between;align-items:center">
      <span>üîÑ Ê∏õÂ∞ëÈáçË§á (Frequency Penalty)</span>
      <span id="freq-value" style="color:var(--primary);font-weight:600">0.3</span>
    </label>
    <input type="range" id="freq-slider" min="0" max="200" value="30" style="width:100%" oninput="updateAIParam('frequencyPenalty',this.value/100)">
    <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-tertiary);margin-top:4px">
      <span>ÂÖÅË®±ÈáçË§á</span>
      <span>Âº∑Âà∂Â§öÊ®£</span>
    </div>
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:6px">Ê∏õÂ∞ëÈáçË§áÁî®Ë©ûÔºå0.2-0.5 ËºÉÈÅ©Âêà</div>
  </div>
  
  <div class="form-group">
    <label class="form-label" style="display:flex;justify-content:space-between;align-items:center">
      <span>üí° ÈºìÂãµÊñ∞Ë©±È°å (Presence Penalty)</span>
      <span id="pres-value" style="color:var(--primary);font-weight:600">0.1</span>
    </label>
    <input type="range" id="pres-slider" min="0" max="200" value="10" style="width:100%" oninput="updateAIParam('presencePenalty',this.value/100)">
    <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-tertiary);margin-top:4px">
      <span>Âª∂Á∫åË©±È°å</span>
      <span>ÂºïÂÖ•Êñ∞Ë©±È°å</span>
    </div>
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:6px">ÈºìÂãµ AI Ë´áË´ñÊñ∞ÂÖßÂÆπÔºå0.0-0.3 ËºÉÈÅ©Âêà</div>
  </div>
  
  <div style="padding:12px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px">
    <div style="font-size:12px;font-weight:600;margin-bottom:8px">üéØ Êé®Ëñ¶È†êË®≠</div>
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
      <button class="modal-btn" style="padding:8px;font-size:12px" onclick="applyAIPreset('creative')">üé® ÂâµÊÑèÂØ´‰Ωú</button>
      <button class="modal-btn" style="padding:8px;font-size:12px" onclick="applyAIPreset('balanced')">‚öñÔ∏è Âπ≥Ë°°Ê®°Âºè</button>
      <button class="modal-btn" style="padding:8px;font-size:12px" onclick="applyAIPreset('precise')">üéØ Á≤æÊ∫ñÊïò‰∫ã</button>
      <button class="modal-btn" style="padding:8px;font-size:12px" onclick="applyAIPreset('wild')">üå™Ô∏è Â§©È¶¨Ë°åÁ©∫</button>
    </div>
  </div>
  
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('ai-params-modal')">ÈóúÈñâ</button>
  </div>
</div>
<!-- Âø´Êç∑Êåá‰ª§ÁÆ°ÁêÜ Modal -->
<div class="modal" id="quick-cmd-modal" style="max-height:85vh;overflow-y:auto">
  <div class="modal-title">‚ö° Âø´Êç∑Êåá‰ª§ÁÆ°ÁêÜ</div>
  <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:16px">
    Ëá™ÂÆöÁæ©Âø´Êç∑ÊåâÈàïÔºåÈªûÊìäÂæåÊúÉËá™ÂãïÁôºÈÄÅÂ∞çÊáâÊåá‰ª§Áµ¶ AI
  </div>
  
  <div id="quick-cmd-list" style="margin-bottom:16px">
    <!-- ÂãïÊÖãÊ∏≤Êüì -->
  </div>
  
  <div style="padding:12px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px">
    <div style="font-size:12px;font-weight:600;margin-bottom:10px">‚ûï Ê∑ªÂä†Êñ∞Êåá‰ª§</div>
    <div class="form-group" style="margin-bottom:10px">
      <input type="text" class="form-input" id="new-cmd-label" placeholder="ÊåâÈàïÈ°ØÁ§∫ÊñáÂ≠óÔºàÂ¶ÇÔºöÂõûÊÜ∂Ôºâ" maxlength="10">
    </div>
    <div class="form-group" style="margin-bottom:10px">
      <input type="text" class="form-input" id="new-cmd-content" placeholder="ÁôºÈÄÅÁµ¶AIÁöÑÊåá‰ª§ÔºàÂ¶ÇÔºöÂõûÊÜ∂ÈÅéÂéªÁöÑ‰∫ãÊÉÖÔºâ">
    </div>
    <button class="modal-btn confirm" style="width:100%" onclick="addQuickCommand()">Ê∑ªÂä†</button>
  </div>
  
  <div style="padding:10px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px;font-size:11px;color:var(--text-tertiary)">
    <div style="font-weight:600;margin-bottom:6px">üí° ÊèêÁ§∫</div>
    <div>‚Ä¢ ÊãñÂãïÊåá‰ª§ÂèØË™øÊï¥È†ÜÂ∫è</div>
    <div>‚Ä¢ È°ØÁ§∫ÊñáÂ≠óÂª∫Ë≠∞ 2-4 ÂÄãÂ≠ó</div>
    <div>‚Ä¢ Êåá‰ª§ÂÖßÂÆπÊúÉÁõ¥Êé•ÁôºÈÄÅÁµ¶ AI</div>
  </div>
  
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="resetQuickCommands()">ÊÅ¢Âæ©ÈªòË™ç</button>
    <button class="modal-btn confirm" onclick="closeModal('quick-cmd-modal')">ÂÆåÊàê</button>
  </div>
</div>
<!-- Á∑®ËºØÂø´Êç∑Êåá‰ª§ Modal -->
<div class="modal" id="edit-cmd-modal">
  <div class="modal-title">‚úèÔ∏è Á∑®ËºØÂø´Êç∑Êåá‰ª§</div>
  <input type="hidden" id="edit-cmd-id">
  <div class="form-group">
    <label class="form-label">ÊåâÈàïÈ°ØÁ§∫ÊñáÂ≠ó</label>
    <input type="text" class="form-input" id="edit-cmd-label" placeholder="Â¶ÇÔºöÂõûÊÜ∂" maxlength="10">
  </div>
  <div class="form-group">
    <label class="form-label">ÁôºÈÄÅÁµ¶AIÁöÑÊåá‰ª§</label>
    <input type="text" class="form-input" id="edit-cmd-content" placeholder="Â¶ÇÔºöÂõûÊÜ∂ÈÅéÂéªÁöÑ‰∫ãÊÉÖ">
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('edit-cmd-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveEditQuickCommand()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- Â†¥ÊôØÁÆ°ÁêÜ Modal -->
<div class="modal" id="scene-modal" style="max-height:85vh;overflow-y:auto">
  <div class="modal-title">üé¨ Â†¥ÊôØÁÆ°ÁêÜ</div>
  <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:16px">
    Ë®≠ÁΩÆÁï∂ÂâçÂ†¥ÊôØ‰∏≠Âú®Â†¥ÁöÑËßíËâ≤ÔºåAI ÊúÉËÆìÈÄô‰∫õËßíËâ≤‰∫íÂãï
  </div>
  
  <div style="margin-bottom:16px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <span style="font-size:13px;font-weight:600">Áï∂ÂâçÂ†¥ÊôØ</span>
      <select class="form-select" id="current-scene" style="width:auto;min-width:120px" onchange="switchScene(this.value)">
        <option value="">ÁÑ°Â†¥ÊôØ</option>
      </select>
    </div>
    <div style="font-size:11px;color:var(--text-tertiary)">ÈÅ∏ÊìáÂ†¥ÊôØÂæåÔºåAI ÊúÉÊ†πÊìöÂú®Â†¥ËßíËâ≤ÈÄ≤Ë°åÂ§öËßíËâ≤‰∫íÂãï</div>
  </div>
  
  <div style="padding:12px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px">
    <div style="font-size:12px;font-weight:600;margin-bottom:10px">üìã Â†¥ÊôØÂàóË°®</div>
    <div id="scene-list" style="max-height:200px;overflow-y:auto">
      <!-- ÂãïÊÖãÊ∏≤Êüì -->
    </div>
    <button class="modal-btn" style="width:100%;margin-top:10px" onclick="createNewScene()">‚ûï ÂâµÂª∫Êñ∞Â†¥ÊôØ</button>
  </div>
  
  <div id="scene-detail-section" style="display:none">
    <div style="padding:12px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px">
      <div style="font-size:12px;font-weight:600;margin-bottom:10px">üë• Âú®Â†¥ËßíËâ≤</div>
      <div id="scene-characters" style="max-height:200px;overflow-y:auto">
        <!-- ÂãïÊÖãÊ∏≤Êüì -->
      </div>
    </div>
  </div>
  
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('scene-modal')">ÈóúÈñâ</button>
  </div>
</div>
<!-- ÂâµÂª∫/Á∑®ËºØÂ†¥ÊôØ Modal -->
<div class="modal" id="scene-edit-modal">
  <div class="modal-title" id="scene-edit-title">ÂâµÂª∫Â†¥ÊôØ</div>
  <input type="hidden" id="scene-edit-id">
  <div class="form-group">
    <label class="form-label">Â†¥ÊôØÂêçÁ®±</label>
    <input type="text" class="form-input" id="scene-edit-name" placeholder="Â¶ÇÔºöÊó©Êúù„ÄÅÂÆ¥ÊúÉ„ÄÅÂæåÂÆÆËä±Âúí...">
  </div>
  <div class="form-group">
    <label class="form-label">Â†¥ÊôØÊèèËø∞ÔºàÂèØÈÅ∏Ôºâ</label>
    <textarea class="form-textarea" id="scene-edit-desc" rows="2" placeholder="ÊèèËø∞ÈÄôÂÄãÂ†¥ÊôØÁöÑÊ∞õÂúç„ÄÅÊôÇÈñì„ÄÅÂú∞ÈªûÁ≠â..."></textarea>
  </div>
  <div class="form-group">
    <label class="form-label">ÈÅ∏ÊìáÂú®Â†¥ËßíËâ≤</label>
    <div id="scene-char-selector" style="max-height:200px;overflow-y:auto;padding:8px;background:var(--bg-tertiary);border-radius:8px">
      <!-- ÂãïÊÖãÊ∏≤ÊüìËßíËâ≤Ë§áÈÅ∏Ê°Ü -->
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('scene-edit-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveScene()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- Á∞°ÁπÅËΩâÊèõË®≠ÁΩÆ Modal -->
<div class="modal" id="cn-convert-modal">
  <div class="modal-title">üåê Á∞°ÁπÅËΩâÊèõ</div>
  <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:16px">
    ÊåáÁ§∫ AI ‰ΩøÁî®ÊåáÂÆöÁöÑ‰∏≠ÊñáËÆäÈ´îÈÄ≤Ë°åÂõûË¶Ü
  </div>
  <div class="form-group">
    <label class="form-label">Ëº∏Âá∫Ë™ûË®Ä</label>
    <select class="form-select" id="cn-convert-mode" onchange="updateCnConvertPreview()">
      <option value="none">‰∏çÊåáÂÆöÔºàAI ÈªòË™çÔºâ</option>
      <option value="s2t">ÁπÅÈ´î‰∏≠ÊñáÔºàÂè∞ÁÅ£/È¶ôÊ∏ØÔºâ</option>
      <option value="t2s">ÁÆÄ‰Ωì‰∏≠ÊñáÔºà‰∏≠ÂõΩÂ§ßÈôÜÔºâ</option>
    </select>
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:6px">
      ÈÄöÈÅé System Prompt ÊåáÁ§∫ AI Áî®Âì™Á®Æ‰∏≠ÊñáÂõûË¶Ü
    </div>
  </div>
  <div style="padding:10px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px;font-size:12px">
    <div style="font-weight:600;margin-bottom:6px">üí° ÊïàÊûúË™™Êòé</div>
    <div id="cn-convert-preview" style="color:var(--text-secondary)">
      ‰∏çÈÄ≤Ë°åËΩâÊèõÔºåAI Â∞á‰ΩøÁî®ÈªòË™çË™ûË®ÄËº∏Âá∫
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('cn-convert-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveChineseConvert()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- Ê®°ÊùøËÆäÈáèË®≠ÁΩÆ Modal -->
<div class="modal" id="template-vars-modal">
  <div class="modal-title">üìù Ê®°ÊùøËÆäÈáèË®≠ÁΩÆ</div>
  <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:16px">
    Ë®≠ÁΩÆÈÄô‰∫õËÆäÈáèÂæåÔºåÂèØ‰ª•Âú®Êåá‰ª§Âíå Lorebook ‰∏≠‰ΩøÁî® <code style="background:var(--bg-tertiary);padding:2px 4px;border-radius:3px">{{ËÆäÈáèÂêç}}</code> ÂºïÁî®
  </div>
  
  <div class="form-group">
    <label class="form-label">{{user}} - Áé©ÂÆ∂Á®±Âëº</label>
    <input type="text" class="form-input" id="var-player-name" placeholder="‰Ω†„ÄÅÈôõ‰∏ã„ÄÅÂ∞ë‰ø†..." value="">
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">AI Á®±ÂëºÁé©ÂÆ∂ÊôÇ‰ΩøÁî®ÁöÑÂêçÂ≠ó</div>
  </div>
  
  <div class="form-group">
    <label class="form-label">{{location}} - Áï∂ÂâçÂú∞Èªû</label>
    <input type="text" class="form-input" id="var-location" placeholder="Èï∑Ê®ÇÂÆÆ„ÄÅËÅöË≥¢Ëéä..." value="">
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">ÊïÖ‰∫ãÁï∂ÂâçÁôºÁîüÁöÑÂú∞Èªû</div>
  </div>
  
  <div style="padding:12px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px">
    <div style="font-size:12px;font-weight:600;margin-bottom:8px">üìã ÂèØÁî®ËÆäÈáèÂàóË°®</div>
    <div style="font-size:11px;color:var(--text-secondary);line-height:1.8">
      <div><code>{{user}}</code> ‚Üí Áé©ÂÆ∂Á®±Âëº</div>
      <div><code>{{location}}</code> ‚Üí Áï∂ÂâçÂú∞Èªû</div>
      <div><code>{{time}}</code> ‚Üí ÊïÖ‰∫ãÊôÇÈñìÔºàÂæûÊôÇÈñìËª∏ËÆÄÂèñÔºâ</div>
      <div><code>{{date}}</code> ‚Üí ÁèæÂØ¶Êó•Êúü</div>
      <div><code>{{char:ËßíËâ≤Âêç}}</code> ‚Üí ÊåáÂÆöËßíËâ≤ÁöÑ‰ø°ÊÅØ</div>
    </div>
  </div>
  
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('template-vars-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveTemplateVars()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- Persona ÈÅ∏ÊìáÂô® Modal -->
<div class="modal" id="persona-selector-modal">
  <div class="modal-title">üë§ ÈÅ∏ÊìáË∫´‰ªΩ</div>
  <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:16px">
    ÈÅ∏Êìá‰Ω†Âú®ÊïÖ‰∫ã‰∏≠ÊâÆÊºîÁöÑËßíËâ≤Ë∫´‰ªΩÔºåAI ÊúÉÊ†πÊìö‰Ω†ÁöÑË∫´‰ªΩË™øÊï¥ÂõûÊáâ
  </div>
  <div id="persona-list" style="max-height:calc(85vh - 200px);overflow-y:auto;margin-bottom:16px">
    <!-- ÂãïÊÖãÊ∏≤Êüì -->
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('persona-selector-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn" onclick="showPersonaManager()" style="background:var(--bg-tertiary);color:var(--text-primary)">‚öôÔ∏è ÁÆ°ÁêÜË∫´‰ªΩ</button>
  </div>
</div>
<!-- Persona Á∑®ËºØ Modal -->
<div class="modal" id="persona-edit-modal">
  <div class="modal-title" id="persona-edit-title">‚ú® ÂâµÂª∫Êñ∞Ë∫´‰ªΩ</div>
  <input type="hidden" id="persona-edit-id" value="">

  <div style="max-height:calc(85vh - 160px);overflow-y:auto;margin-bottom:16px">
    <div class="form-group">
      <label class="form-label">È†≠ÂÉè</label>
      <input type="text" class="form-input" id="persona-avatar" placeholder="üë∏" maxlength="2">
      <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">Ëº∏ÂÖ•‰∏ÄÂÄã emoji ÊàñÁïôÁ©∫‰ΩøÁî®ÈªòË™ç üë§</div>
    </div>

    <div class="form-group">
      <label class="form-label">ÂêçÁ®± *</label>
      <input type="text" class="form-input" id="persona-name" placeholder="ÊûóÂ©âÂÑø">
    </div>

    <div class="form-group">
      <label class="form-label">Á∞°‰ªã</label>
      <input type="text" class="form-input" id="persona-description" placeholder="Ê±üÂçóÂØåÂïÜ‰πãÂ•≥ÔºåÁü•Êõ∏ÈÅîÁêÜÔºåÊ∫´Â©âÂèØ‰∫∫">
    </div>

    <div class="form-group">
      <label class="form-label">ËÉåÊôØÊïÖ‰∫ã</label>
      <textarea class="form-input" id="persona-background" placeholder="ÊûóÂÆ∂ÊòØÊ±üÂçóÈ¶ñÂØåÔºåÂ©âÂÑøËá™ÂπºÈ£ΩËÆÄË©©Êõ∏..." rows="3"></textarea>
    </div>

    <div class="form-group">
      <label class="form-label">Ë™™Ë©±È¢®Ê†º</label>
      <input type="text" class="form-input" id="persona-speech-style" placeholder="Ë™™Ë©±Ê∫´ÊüîÔºåÂ∏∏Áî®„ÄåÂ•¥ÂÆ∂„ÄçËá™Á®±">
    </div>

    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;font-size:12px;color:var(--text-secondary)">
      <div style="font-weight:600;margin-bottom:6px">üí° ÊèêÁ§∫</div>
      <div style="line-height:1.6">
        ‚Ä¢ Ë®≠ÁΩÆË©≥Á¥∞ÁöÑËÉåÊôØÊïÖ‰∫ãÂèØ‰ª•ËÆì AI Êõ¥Â•ΩÂú∞ÁêÜËß£‰Ω†ÁöÑËßíËâ≤<br>
        ‚Ä¢ Ë™™Ë©±È¢®Ê†ºÊúÉÂΩ±Èüø AI Â∞ç‰Ω†ÁöÑÂõûÊáâÊñπÂºè<br>
        ‚Ä¢ ÂàáÊèõË∫´‰ªΩÂæåÔºåÂª∫Ë≠∞ÈñãÂïüÊñ∞Â∞çË©±‰ª•Áç≤ÂæóÊúÄ‰Ω≥ÊïàÊûú
      </div>
    </div>
  </div>

  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('persona-edit-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="savePersona()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- Persona ÁÆ°ÁêÜ Modal -->
<div class="modal" id="persona-manager-modal">
  <div class="modal-title">‚öôÔ∏è ÁÆ°ÁêÜË∫´‰ªΩ</div>
  <div id="persona-manager-list" style="max-height:calc(85vh - 200px);overflow-y:auto;margin-bottom:16px">
    <!-- ÂãïÊÖãÊ∏≤Êüì -->
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('persona-manager-modal')">ÈóúÈñâ</button>
    <button class="modal-btn confirm" onclick="createNewPersona()">+ ÂâµÂª∫Êñ∞Ë∫´‰ªΩ</button>
  </div>
</div>
<!-- Èö±ËóèËº∏ÂÖ• -->
<input type="file" id="file-input" accept=".md,.txt,.json" style="display:none">
<input type="file" id="import-input" accept=".json" style="display:none">
<script>
// ÂÖ®Â±ÄÁãÄÊÖã
let db, story=null, msgs=[], hist=['view-stories'], generating=false, typingCtrl=null, selMsgId=null, confirmCb=null, inputCb=null, editApiId=null;
let settings={theme:'dark',screen:'phone',consist:true,summary:true,suggest:true,typingSpeed:30,contextCount:20,maxTokens:4096,sendKey:'enter',chatBg:'none',chatBgImage:'',fontSize:16,lineHeight:1.8,
  // AI ÂèÉÊï∏
  temperature:0.8,topP:0.9,frequencyPenalty:0.3,presencePenalty:0.1,
  // Ê®°ÊùøËÆäÈáè
  playerName:'‰Ω†',currentLocation:'',
  // Á∞°ÁπÅËΩâÊèõ
  chineseConvert:'none',
  // ÊµÅÂºèÈüøÊáâ
  enableStreaming:true,streamingChunkDelay:20
};

// ÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded',async()=>{
  await initDB();
  await loadSettings();
  await renderStories();
  await renderInst();
  await renderApi();
  await renderQuickCommands();
  initTypingCancel(); // ÂàùÂßãÂåñÊâìÂ≠óÊ©üÂèñÊ∂àÂäüËÉΩ
  initMsgSwipe(); // È†êÂÖàÂàùÂßãÂåñÊªëÂãï‰∫ã‰ª∂ÂßîÊâò
  updateTime();
  setInterval(updateTime,60000);
});

// Êï∏ÊìöÂ∫´
async function initDB(){
  db=new Dexie('ZhimengDB');
  db.version(7).stores({
    stories:'id,title,createdAt,updatedAt,isPinned',
    messages:'id,storyId,branchId,[storyId+branchId],createdAt',
    branches:'id,storyId,parentBranchId,createdAt',
    instructions:'id,createdAt',
    storyInstructions:'[storyId+instructionId],storyId,instructionId',
    loreEntries:'id,storyId,category,createdAt',
    foreshadowing:'id,storyId,messageId,isResolved,createdAt',
    events:'id,storyId,messageId,createdAt',
    characterStates:'id,storyId,loreEntryId',
    timeline:'id,storyId,messageId,order',
    saves:'id,storyId,slotIndex,isAuto,createdAt',
    apiPresets:'id,isActive,createdAt',
    settings:'key',
    chapters:'id,storyId,messageId,order,createdAt',
    bookmarks:'id,storyId,messageId,createdAt',
    plotTags:'id,storyId,messageId,type,createdAt',
    // v7 Êñ∞Â¢ûÔºöËßíËâ≤Á≥ªÁµ±
    characters:'id,storyId,name,createdAt,updatedAt',
    characterSnapshots:'id,storyId,createdAt',
    characterHistory:'id,storyId,characterId,createdAt',
    // v13 Êñ∞Â¢ûÔºöLorebook Á≥ªÁµ±
    lorebook:'id,storyId,name,isEnabled,priority,createdAt',
    lorebookTriggerLog:'id,storyId,lorebookId,createdAt',
    // v16 Êñ∞Â¢ûÔºöÂø´Êç∑Êåá‰ª§
    quickCommands:'id,order,createdAt',
    // v16 Êñ∞Â¢ûÔºöÂ†¥ÊôØÁ≥ªÁµ±
    scenes:'id,storyId,name,isActive,createdAt',
    // v22 Êñ∞Â¢ûÔºöPersona Á≥ªÁµ±
    personas:'id,name,createdAt'
  });
  await db.open();
  // ÂàùÂßãÂåñÈªòË™çÂø´Êç∑Êåá‰ª§
  await initDefaultQuickCommands();
  // ÂàùÂßãÂåñÈªòË™ç Persona
  await initDefaultPersona();
}

// Ë®≠ÁΩÆ
async function loadSettings(){
  try{
    const s=await db.settings.toArray();
    s.forEach(x=>{if(x.key in settings)settings[x.key]=x.value});
    applySettings();
  }catch(e){}
}
async function saveSetting(k,v){await db.settings.put({key:k,value:v});settings[k]=v;}
function applySettings(){
  document.documentElement.setAttribute('data-theme',settings.theme);
  document.getElementById('theme-val').textContent=settings.theme==='dark'?'Ê∑±Ëâ≤Ê®°Âºè ‚Ä∫':'Ê∑∫Ëâ≤Ê®°Âºè ‚Ä∫';
  const app=document.getElementById('app');
  if(settings.screen==='fullscreen'){app.classList.add('fullscreen');document.getElementById('screen-val').textContent='ÂÖ®Â±èÊ®°Âºè ‚Ä∫';}
  else{app.classList.remove('fullscreen');document.getElementById('screen-val').textContent='ÊâãÊ©üÊ®°Êì¨Âô® ‚Ä∫';}
  ['consist','summary','suggest'].forEach(k=>{const t=document.getElementById('tog-'+k);if(t){if(settings[k])t.classList.add('active');else t.classList.remove('active');}});
  // Êñ∞Â¢ûË®≠ÁΩÆÈ†ÖÁöÑÈ°ØÁ§∫
  const ctxVal=document.getElementById('context-val');if(ctxVal)ctxVal.textContent=settings.contextCount+'Ê¢ùÊ∂àÊÅØ ‚Ä∫';
  const maxVal=document.getElementById('max-tokens-val');if(maxVal)maxVal.textContent=settings.maxTokens+' ‚Ä∫';
  const typVal=document.getElementById('typing-speed-val');if(typVal)typVal.textContent=settings.typingSpeed===0?'ÈóúÈñâ ‚Ä∫':settings.typingSpeed+'ms ‚Ä∫';
  const keyVal=document.getElementById('send-key-val');if(keyVal)keyVal.textContent=settings.sendKey==='enter'?'Enter ‚Ä∫':'Ctrl+Enter ‚Ä∫';
  // ËÅäÂ§©ËÉåÊôØÈ°ØÁ§∫
  const bgVal=document.getElementById('chat-bg-val');
  if(bgVal){
    if(settings.chatBg==='custom'&&settings.chatBgImage)bgVal.textContent='Ëá™ÂÆöÁæ© ‚Ä∫';
    else if(settings.chatBg==='none')bgVal.textContent='ÈªòË™ç ‚Ä∫';
    else bgVal.textContent='Êº∏ËÆäËâ≤ ‚Ä∫';
  }
  // Â≠óÈ´îÂ§ßÂ∞èÂíåË°åÈñìË∑ù
  const fontVal=document.getElementById('font-size-val');if(fontVal)fontVal.textContent=settings.fontSize+'px ‚Ä∫';
  const lhVal=document.getElementById('line-height-val');if(lhVal)lhVal.textContent=settings.lineHeight+'x ‚Ä∫';
  // ÊáâÁî®Â≠óÈ´îÂíåË°åÈ´òÂà∞ CSS ËÆäÈáè
  document.documentElement.style.setProperty('--font-size', settings.fontSize + 'px');
  document.documentElement.style.setProperty('--line-height', settings.lineHeight);
  // AI ÂèÉÊï∏È°ØÁ§∫
  const aiParamsVal=document.getElementById('ai-params-val');if(aiParamsVal)aiParamsVal.textContent=`T:${settings.temperature} ‚Ä∫`;
  // Ê®°ÊùøËÆäÈáèÈ°ØÁ§∫
  const templateVal=document.getElementById('template-vars-val');if(templateVal)templateVal.textContent=settings.playerName?settings.playerName+' ‚Ä∫':'Ë®≠ÁΩÆ ‚Ä∫';
  // Á∞°ÁπÅËΩâÊèõÈ°ØÁ§∫
  const cnVal=document.getElementById('cn-convert-val');
  if(cnVal){
    if(settings.chineseConvert==='s2t')cnVal.textContent='‚Üí ÁπÅÈ´î ‚Ä∫';
    else if(settings.chineseConvert==='t2s')cnVal.textContent='‚Üí ÁÆÄ‰Ωì ‚Ä∫';
    else cnVal.textContent='‰∏çËΩâÊèõ ‚Ä∫';
  }
  // ÊµÅÂºèÈüøÊáâÈ°ØÁ§∫
  const streamVal=document.getElementById('streaming-val');if(streamVal)streamVal.textContent=settings.enableStreaming?'Â∑≤ÈñãÂïü ‚Ä∫':'Â∑≤ÈóúÈñâ ‚Ä∫';
}
function toggleTheme(){settings.theme=settings.theme==='dark'?'light':'dark';saveSetting('theme',settings.theme);applySettings();toast('‰∏ªÈ°åÂ∑≤ÂàáÊèõ');}
function toggleScreen(){settings.screen=settings.screen==='phone'?'fullscreen':'phone';saveSetting('screen',settings.screen);applySettings();}
function toggleSet(k){settings[k]=!settings[k];saveSetting(k,settings[k]);applySettings();}
function toggleSendKey(){settings.sendKey=settings.sendKey==='enter'?'ctrl+enter':'enter';saveSetting('sendKey',settings.sendKey);applySettings();toast('ÁôºÈÄÅÂø´Êç∑ÈçµÂ∑≤ÂàáÊèõ');}

// Â≠óÈ´îÂ§ßÂ∞èË®≠ÁΩÆ
function showFontSettings(){
  showModal('font-size-modal');
  updateFontOptions();
  document.getElementById('font-preview').style.fontSize = settings.fontSize + 'px';
}
function updateFontOptions(){
  document.querySelectorAll('#font-size-modal .font-option').forEach(btn=>{
    const size = parseInt(btn.dataset.size);
    if(size === settings.fontSize) btn.classList.add('active');
    else btn.classList.remove('active');
  });
}
function selectFontSize(size){
  settings.fontSize = size;
  saveSetting('fontSize', size);
  applySettings();
  updateFontOptions();
  document.getElementById('font-preview').style.fontSize = size + 'px';
  toast('Â≠óÈ´îÂ§ßÂ∞èÂ∑≤Êõ¥ÊîπÁÇ∫ ' + size + 'px');
}

// Ë°åÈñìË∑ùË®≠ÁΩÆ
function showLineHeightSettings(){
  showModal('line-height-modal');
  updateLineHeightOptions();
  document.getElementById('line-height-preview').style.lineHeight = settings.lineHeight;
}
function updateLineHeightOptions(){
  document.querySelectorAll('#line-height-modal .font-option').forEach(btn=>{
    const lh = parseFloat(btn.dataset.lh);
    if(lh === settings.lineHeight) btn.classList.add('active');
    else btn.classList.remove('active');
  });
}
function selectLineHeight(lh){
  settings.lineHeight = lh;
  saveSetting('lineHeight', lh);
  applySettings();
  updateLineHeightOptions();
  document.getElementById('line-height-preview').style.lineHeight = lh;
  toast('Ë°åÈñìË∑ùÂ∑≤Êõ¥ÊîπÁÇ∫ ' + lh + 'x');
}

// ============ AI ÂèÉÊï∏Ë®≠ÁΩÆ ============
function showAIParamsSettings(){
  showModal('ai-params-modal');
  // Êõ¥Êñ∞ÊªëÂ°äÂÄº
  document.getElementById('temp-slider').value = settings.temperature * 100;
  document.getElementById('temp-value').textContent = settings.temperature.toFixed(1);
  document.getElementById('topp-slider').value = settings.topP * 100;
  document.getElementById('topp-value').textContent = settings.topP.toFixed(1);
  document.getElementById('freq-slider').value = settings.frequencyPenalty * 100;
  document.getElementById('freq-value').textContent = settings.frequencyPenalty.toFixed(1);
  document.getElementById('pres-slider').value = settings.presencePenalty * 100;
  document.getElementById('pres-value').textContent = settings.presencePenalty.toFixed(1);
}

function updateAIParam(param, value){
  value = parseFloat(value);
  settings[param] = value;
  saveSetting(param, value);
  
  // Êõ¥Êñ∞È°ØÁ§∫
  switch(param){
    case 'temperature':
      document.getElementById('temp-value').textContent = value.toFixed(1);
      break;
    case 'topP':
      document.getElementById('topp-value').textContent = value.toFixed(1);
      break;
    case 'frequencyPenalty':
      document.getElementById('freq-value').textContent = value.toFixed(1);
      break;
    case 'presencePenalty':
      document.getElementById('pres-value').textContent = value.toFixed(1);
      break;
  }
  applySettings();
}

function applyAIPreset(preset){
  const presets = {
    creative: { temperature: 1.0, topP: 0.95, frequencyPenalty: 0.5, presencePenalty: 0.3 },
    balanced: { temperature: 0.8, topP: 0.9, frequencyPenalty: 0.3, presencePenalty: 0.1 },
    precise: { temperature: 0.5, topP: 0.8, frequencyPenalty: 0.2, presencePenalty: 0.0 },
    wild: { temperature: 1.5, topP: 1.0, frequencyPenalty: 0.7, presencePenalty: 0.5 }
  };
  
  const p = presets[preset];
  if(!p) return;
  
  settings.temperature = p.temperature;
  settings.topP = p.topP;
  settings.frequencyPenalty = p.frequencyPenalty;
  settings.presencePenalty = p.presencePenalty;
  
  saveSetting('temperature', p.temperature);
  saveSetting('topP', p.topP);
  saveSetting('frequencyPenalty', p.frequencyPenalty);
  saveSetting('presencePenalty', p.presencePenalty);
  
  // Êõ¥Êñ∞ UI
  showAIParamsSettings();
  applySettings();
  
  const names = { creative: 'ÂâµÊÑèÂØ´‰Ωú', balanced: 'Âπ≥Ë°°Ê®°Âºè', precise: 'Á≤æÊ∫ñÊïò‰∫ã', wild: 'Â§©È¶¨Ë°åÁ©∫' };
  toast(`Â∑≤Â•óÁî®„Äå${names[preset]}„ÄçÈ†êË®≠`);
}

// ÂÖ®Â±ÄÈªòË™ç AI ÂèÉÊï∏Ë®≠ÁΩÆÔºàÂà•ÂêçÔºâ
function showDefaultAIParams(){
  showAIParamsSettings();
}

// ============ ÊïÖ‰∫ãÁ¥öÂà• AI ÂèÉÊï∏Ë®≠ÁΩÆ ============
let storyAIParamsTemp = null; // Ëá®ÊôÇÂ≠òÂÑ≤Á∑®ËºØ‰∏≠ÁöÑÂèÉÊï∏

function showStoryAIParams(){
  if(!story){toast('Ë´ãÂÖàÊâìÈñã‰∏ÄÂÄãÊïÖ‰∫ã','warning');return;}
  closeAll();
  
  // ËÆÄÂèñÊïÖ‰∫ãÁöÑ AI ÂèÉÊï∏
  const hasCustom = story.aiParams && story.aiParams.useCustom;
  const params = story.aiParams || {
    useCustom: false,
    temperature: settings.temperature,
    topP: settings.topP,
    frequencyPenalty: settings.frequencyPenalty,
    presencePenalty: settings.presencePenalty
  };
  
  storyAIParamsTemp = {...params};
  
  // Ë®≠ÁΩÆ checkbox
  document.getElementById('story-ai-use-custom').checked = hasCustom;
  toggleStoryAICustom(hasCustom);
  
  // Ë®≠ÁΩÆÊªëÂ°äÂÄº
  document.getElementById('story-temp-slider').value = params.temperature * 100;
  document.getElementById('story-temp-value').textContent = params.temperature.toFixed(1);
  document.getElementById('story-topp-slider').value = params.topP * 100;
  document.getElementById('story-topp-value').textContent = params.topP.toFixed(1);
  document.getElementById('story-freq-slider').value = params.frequencyPenalty * 100;
  document.getElementById('story-freq-value').textContent = params.frequencyPenalty.toFixed(1);
  document.getElementById('story-pres-slider').value = params.presencePenalty * 100;
  document.getElementById('story-pres-value').textContent = params.presencePenalty.toFixed(1);
  
  // Êõ¥Êñ∞Áï∂ÂâçÁîüÊïàÂèÉÊï∏È°ØÁ§∫
  updateEffectiveParamsDisplay();
  
  showModal('story-ai-params-modal');
}

function toggleStoryAICustom(checked){
  const container = document.getElementById('story-ai-params-container');
  if(checked){
    container.style.opacity = '1';
    container.style.pointerEvents = 'auto';
    storyAIParamsTemp.useCustom = true;
  } else {
    container.style.opacity = '0.5';
    container.style.pointerEvents = 'none';
    storyAIParamsTemp.useCustom = false;
  }
  updateEffectiveParamsDisplay();
}

function updateStoryAIParam(param, value){
  value = parseFloat(value);
  storyAIParamsTemp[param] = value;
  
  // Êõ¥Êñ∞È°ØÁ§∫
  switch(param){
    case 'temperature':
      document.getElementById('story-temp-value').textContent = value.toFixed(1);
      break;
    case 'topP':
      document.getElementById('story-topp-value').textContent = value.toFixed(1);
      break;
    case 'frequencyPenalty':
      document.getElementById('story-freq-value').textContent = value.toFixed(1);
      break;
    case 'presencePenalty':
      document.getElementById('story-pres-value').textContent = value.toFixed(1);
      break;
  }
  updateEffectiveParamsDisplay();
}

function applyStoryAIPreset(preset){
  const presets = {
    creative: { temperature: 1.0, topP: 0.95, frequencyPenalty: 0.5, presencePenalty: 0.3 },
    balanced: { temperature: 0.8, topP: 0.9, frequencyPenalty: 0.3, presencePenalty: 0.1 },
    precise: { temperature: 0.5, topP: 0.8, frequencyPenalty: 0.2, presencePenalty: 0.0 },
    wild: { temperature: 1.5, topP: 1.0, frequencyPenalty: 0.7, presencePenalty: 0.5 }
  };
  
  const p = presets[preset];
  if(!p) return;
  
  storyAIParamsTemp.temperature = p.temperature;
  storyAIParamsTemp.topP = p.topP;
  storyAIParamsTemp.frequencyPenalty = p.frequencyPenalty;
  storyAIParamsTemp.presencePenalty = p.presencePenalty;
  
  // Êõ¥Êñ∞ÊªëÂ°ä
  document.getElementById('story-temp-slider').value = p.temperature * 100;
  document.getElementById('story-temp-value').textContent = p.temperature.toFixed(1);
  document.getElementById('story-topp-slider').value = p.topP * 100;
  document.getElementById('story-topp-value').textContent = p.topP.toFixed(1);
  document.getElementById('story-freq-slider').value = p.frequencyPenalty * 100;
  document.getElementById('story-freq-value').textContent = p.frequencyPenalty.toFixed(1);
  document.getElementById('story-pres-slider').value = p.presencePenalty * 100;
  document.getElementById('story-pres-value').textContent = p.presencePenalty.toFixed(1);
  
  updateEffectiveParamsDisplay();
  
  const names = { creative: 'ÂâµÊÑèÂØ´‰Ωú', balanced: 'Âπ≥Ë°°Ê®°Âºè', precise: 'Á≤æÊ∫ñÊïò‰∫ã', wild: 'Â§©È¶¨Ë°åÁ©∫' };
  toast(`Â∑≤Â•óÁî®„Äå${names[preset]}„ÄçÈ†êË®≠`);
}

async function saveStoryAIParams(){
  if(!story) return;
  
  story.aiParams = {
    useCustom: storyAIParamsTemp.useCustom,
    temperature: storyAIParamsTemp.temperature,
    topP: storyAIParamsTemp.topP,
    frequencyPenalty: storyAIParamsTemp.frequencyPenalty,
    presencePenalty: storyAIParamsTemp.presencePenalty
  };
  story.updatedAt = Date.now();
  
  await db.stories.put(story);
  closeModal('story-ai-params-modal');
  
  if(story.aiParams.useCustom){
    toast(`Â∑≤‰øùÂ≠òÊú¨ÊïÖ‰∫ãÁöÑ AI ÂèÉÊï∏ (T:${story.aiParams.temperature})`,'success');
  } else {
    toast('Â∑≤Ë®≠ÁÇ∫‰ΩøÁî®ÂÖ®Â±ÄÈªòË™çÂèÉÊï∏','success');
  }
}

function updateEffectiveParamsDisplay(){
  const el = document.getElementById('story-ai-effective-params');
  if(!el) return;
  
  let params;
  let source;
  
  if(storyAIParamsTemp && storyAIParamsTemp.useCustom){
    params = storyAIParamsTemp;
    source = 'Êú¨ÊïÖ‰∫ãËá™ÂÆöÁæ©';
  } else {
    params = settings;
    source = 'ÂÖ®Â±ÄÈªòË™çÂÄº';
  }
  
  el.innerHTML = `
    <div style="margin-bottom:4px">‰æÜÊ∫êÔºö<span style="color:var(--primary)">${source}</span></div>
    <div>Temperature: ${params.temperature.toFixed(1)} | Top P: ${params.topP.toFixed(1)} | Freq: ${params.frequencyPenalty.toFixed(1)} | Pres: ${params.presencePenalty.toFixed(1)}</div>
  `;
}

// Áç≤ÂèñÁï∂ÂâçÊáâË©≤‰ΩøÁî®ÁöÑ AI ÂèÉÊï∏ÔºàÂÑ™ÂÖàÊïÖ‰∫ãÁ¥öÂà•ÔºåÂÖ∂Ê¨°ÂÖ®Â±ÄÈªòË™çÔºâ
function getAIParams(){
  if(story && story.aiParams && story.aiParams.useCustom){
    return {
      temperature: story.aiParams.temperature,
      topP: story.aiParams.topP,
      frequencyPenalty: story.aiParams.frequencyPenalty,
      presencePenalty: story.aiParams.presencePenalty
    };
  }
  return {
    temperature: settings.temperature || 0.8,
    topP: settings.topP || 0.9,
    frequencyPenalty: settings.frequencyPenalty || 0.3,
    presencePenalty: settings.presencePenalty || 0.1
  };
}

// ============ Ê®°ÊùøËÆäÈáèË®≠ÁΩÆ ============
function showTemplateVarsSettings(){
  showModal('template-vars-modal');
  document.getElementById('var-player-name').value = settings.playerName || '';
  document.getElementById('var-location').value = settings.currentLocation || '';
}

function saveTemplateVars(){
  const playerName = document.getElementById('var-player-name').value.trim();
  const location = document.getElementById('var-location').value.trim();
  
  settings.playerName = playerName;
  settings.currentLocation = location;
  
  saveSetting('playerName', playerName);
  saveSetting('currentLocation', location);
  
  closeModal('template-vars-modal');
  applySettings();
  toast('Ê®°ÊùøËÆäÈáèÂ∑≤‰øùÂ≠ò', 'success');
}

// ÊõøÊèõÊ®°ÊùøËÆäÈáè
function replaceTemplateVars(text){
  if(!text) return text;
  
  // {{user}} - Áé©ÂÆ∂Á®±Âëº
  text = text.replace(/\{\{user\}\}/gi, settings.playerName || '‰Ω†');
  
  // {{location}} - Áï∂ÂâçÂú∞Èªû
  text = text.replace(/\{\{location\}\}/gi, settings.currentLocation || 'Ê≠§Ëôï');
  
  // {{time}} - ÊïÖ‰∫ãÊôÇÈñìÔºàÊ∑ªÂä†storyÂ≠òÂú®ÊÄßÊ™¢Êü•Ôºâ
  const storyTime = story && story.storyTime ? story.storyTime : '';
  text = text.replace(/\{\{time\}\}/gi, storyTime || 'Áï∂Ââç');
  
  // {{date}} - ÁèæÂØ¶Êó•Êúü
  const today = new Date();
  const dateStr = `${today.getFullYear()}Âπ¥${today.getMonth()+1}Êúà${today.getDate()}Êó•`;
  text = text.replace(/\{\{date\}\}/gi, dateStr);
  
  // {{char:ËßíËâ≤Âêç}} - ÊåáÂÆöËßíËâ≤ÁöÑ‰ø°ÊÅØÔºàÁï∞Ê≠•ÔºåÈÄôË£°Âè™ÂÅöÁ∞°ÂñÆÊõøÊèõÔºâ
  text = text.replace(/\{\{char:([^}]+)\}\}/gi, (match, charName) => {
    return `„Äê${charName}„Äë`;
  });
  
  return text;
}

// ÂúñÁâá‰∏äÂÇ≥Áõ∏Èóú
let imageUploadTarget = null; // 'storyCover' | 'charAvatar' | 'chatBg' | {type: 'charAvatar', charId: xxx}

// Â£ìÁ∏ÆÂúñÁâá
async function compressImage(file, maxWidth = 400, quality = 0.8) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        
        if (width > maxWidth) {
          height = (height * maxWidth) / width;
          width = maxWidth;
        }
        
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        const dataUrl = canvas.toDataURL('image/jpeg', quality);
        resolve(dataUrl);
      };
      img.onerror = reject;
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// ËôïÁêÜÂúñÁâá‰∏äÂÇ≥
async function handleImageUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  try {
    showLoading('ËôïÁêÜÂúñÁâá‰∏≠...');
    const maxWidth = imageUploadTarget === 'chatBg' ? 1920 : 400;
    const dataUrl = await compressImage(file, maxWidth, 0.85);
    
    if (imageUploadTarget === 'storyCover' && story) {
      await db.stories.update(story.id, { coverImage: dataUrl });
      story.coverImage = dataUrl;
      await renderStories();
      toast('Â∞ÅÈù¢Â∑≤Êõ¥Êñ∞', 'success');
    } else if (imageUploadTarget === 'chatBg') {
      settings.chatBg = 'custom';
      settings.chatBgImage = dataUrl;
      await saveSetting('chatBg', 'custom');
      await saveSetting('chatBgImage', dataUrl);
      applyChatBg();
      closeModal('chat-bg-modal');
      toast('ËÉåÊôØÂ∑≤Êõ¥Êñ∞', 'success');
    } else if (typeof imageUploadTarget === 'object' && imageUploadTarget.type === 'charAvatar') {
      const charId = imageUploadTarget.charId;
      await db.characters.update(charId, { avatarImage: dataUrl, updatedAt: Date.now() });
      renderCharacters();
      toast('È†≠ÂÉèÂ∑≤Êõ¥Êñ∞', 'success');
    }
    
    hideLoading();
  } catch (e) {
    hideLoading();
    toast('ÂúñÁâáËôïÁêÜÂ§±Êïó: ' + e.message, 'error');
  }
  
  // Ê∏ÖÁ©∫ input
  event.target.value = '';
}

// ‰∏äÂÇ≥ÊïÖ‰∫ãÂ∞ÅÈù¢
function uploadStoryCover() {
  if (!story) return toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã');
  imageUploadTarget = 'storyCover';
  document.getElementById('image-upload').click();
}

// ‰∏äÂÇ≥ËßíËâ≤È†≠ÂÉè
function uploadCharAvatar(charId) {
  imageUploadTarget = { type: 'charAvatar', charId };
  document.getElementById('image-upload').click();
}

// ËÅäÂ§©ËÉåÊôØË®≠ÁΩÆ
function setChatBackground() {
  // Êõ¥Êñ∞ÈÅ∏‰∏≠ÁãÄÊÖã
  document.querySelectorAll('.bg-option').forEach(el => {
    el.style.borderColor = el.dataset.bg === settings.chatBg ? 'var(--primary)' : 'var(--divider)';
  });
  // È°ØÁ§∫Ëá™ÂÆöÁæ©ËÉåÊôØÈ†êË¶Ω
  const preview = document.getElementById('current-bg-preview');
  const previewImg = document.getElementById('bg-preview-img');
  if (settings.chatBg === 'custom' && settings.chatBgImage) {
    preview.style.display = 'block';
    previewImg.style.backgroundImage = `url(${settings.chatBgImage})`;
  } else {
    preview.style.display = 'none';
  }
  showModal('chat-bg-modal');
}

function selectBg(bg) {
  if (bg === 'custom') return; // Áî± uploadChatBg ËôïÁêÜ
  settings.chatBg = bg;
  saveSetting('chatBg', bg);
  applyChatBg();
  // Êõ¥Êñ∞ÈÅ∏‰∏≠ÁãÄÊÖã
  document.querySelectorAll('.bg-option').forEach(el => {
    el.style.borderColor = el.dataset.bg === bg ? 'var(--primary)' : 'var(--divider)';
  });
  applySettings();
  toast('ËÉåÊôØÂ∑≤Êõ¥Êñ∞', 'success');
}

function uploadChatBg() {
  imageUploadTarget = 'chatBg';
  document.getElementById('image-upload').click();
}

function clearChatBg() {
  settings.chatBg = 'none';
  settings.chatBgImage = '';
  saveSetting('chatBg', 'none');
  saveSetting('chatBgImage', '');
  applyChatBg();
  document.getElementById('current-bg-preview').style.display = 'none';
  document.querySelectorAll('.bg-option').forEach(el => {
    el.style.borderColor = el.dataset.bg === 'none' ? 'var(--primary)' : 'var(--divider)';
  });
  applySettings();
  toast('Â∑≤ÊÅ¢Âæ©ÈªòË™çËÉåÊôØ', 'success');
}

function applyChatBg() {
  const content = document.getElementById('content-area');
  if (!content) return;
  
  content.classList.remove('has-bg');
  content.style.backgroundImage = '';
  content.style.background = '';
  
  if (settings.chatBg === 'custom' && settings.chatBgImage) {
    content.classList.add('has-bg');
    content.style.backgroundImage = `url(${settings.chatBgImage})`;
  } else if (settings.chatBg === 'gradient1') {
    content.style.background = 'linear-gradient(135deg, #1a1a2e, #16213e)';
  } else if (settings.chatBg === 'gradient2') {
    content.style.background = 'linear-gradient(135deg, #0f0f1a, #1e1e32)';
  } else if (settings.chatBg === 'gradient3') {
    content.style.background = 'linear-gradient(135deg, #1a0a0a, #2a1515)';
  } else if (settings.chatBg === 'gradient4') {
    content.style.background = 'linear-gradient(135deg, #0a1a0a, #152a15)';
  }
}

// ËôïÁêÜËº∏ÂÖ•Ê°ÜÊåâÈçµ‰∫ã‰ª∂
function handleInputKey(event){
  if(event.key==='Enter'){
    if(settings.sendKey==='ctrl+enter'){
      if(event.ctrlKey||event.metaKey){
        event.preventDefault();
        send();
      }
    }else{
      // ÈªòË™ç Enter ÁôºÈÄÅ
      if(!event.ctrlKey&&!event.metaKey&&!event.shiftKey){
        event.preventDefault();
        send();
      }
    }
  }
}

// ‰∏ä‰∏ãÊñáË®≠ÁΩÆ
function showContextSettings(){
  document.getElementById('context-count').value=settings.contextCount||20;
  showModal('context-modal');
}
function saveContextSettings(){
  const val=parseInt(document.getElementById('context-count').value)||20;
  settings.contextCount=Math.max(1,Math.min(500,val));
  saveSetting('contextCount',settings.contextCount);
  applySettings();
  closeModal('context-modal');
  toast('‰∏ä‰∏ãÊñáË®≠ÁΩÆÂ∑≤‰øùÂ≠ò');
}

// ÊúÄÂ§ß Token Ë®≠ÁΩÆ
function showMaxTokensSettings(){
  document.getElementById('max-tokens-input').value=settings.maxTokens||4096;
  showModal('max-tokens-modal');
}
function saveMaxTokensSettings(){
  const val=parseInt(document.getElementById('max-tokens-input').value)||4096;
  settings.maxTokens=Math.max(100,val);
  saveSetting('maxTokens',settings.maxTokens);
  applySettings();
  closeModal('max-tokens-modal');
  toast('ÊúÄÂ§ßÁîüÊàêÈï∑Â∫¶Â∑≤‰øùÂ≠ò');
}

// ÊâìÂ≠óÊ©üÊïàÊûúË®≠ÁΩÆ
function showTypingSpeedSettings(){
  document.getElementById('typing-speed-select').value=settings.typingSpeed||30;
  showModal('typing-modal');
}
function saveTypingSpeedSettings(){
  settings.typingSpeed=parseInt(document.getElementById('typing-speed-select').value);
  saveSetting('typingSpeed',settings.typingSpeed);
  applySettings();
  closeModal('typing-modal');
  toast('ÊâìÂ≠óÊ©üÊïàÊûúÂ∑≤‰øùÂ≠ò');
}

// ÊµÅÂºèÈüøÊáâË®≠ÁΩÆ
function showStreamingSettings(){
  const toggle=document.getElementById('toggle-streaming');
  const text=document.getElementById('toggle-streaming-text');
  const options=document.getElementById('streaming-advanced-options');
  if(settings.enableStreaming){
    toggle.classList.add('active');
    text.textContent='Â∑≤ÈñãÂïü';
    options.style.display='block';
  }else{
    toggle.classList.remove('active');
    text.textContent='Â∑≤ÈóúÈñâ';
    options.style.display='none';
  }
  document.getElementById('streaming-chunk-delay-select').value=settings.streamingChunkDelay||20;
  showModal('streaming-modal');
}
function toggleStreamingEnabled(){
  const toggle=document.getElementById('toggle-streaming');
  const text=document.getElementById('toggle-streaming-text');
  const options=document.getElementById('streaming-advanced-options');
  const enabled=toggle.classList.contains('active');
  if(enabled){
    toggle.classList.remove('active');
    text.textContent='Â∑≤ÈóúÈñâ';
    options.style.display='none';
  }else{
    toggle.classList.add('active');
    text.textContent='Â∑≤ÈñãÂïü';
    options.style.display='block';
  }
}
function saveStreamingSettings(){
  const enabled=document.getElementById('toggle-streaming').classList.contains('active');
  settings.enableStreaming=enabled;
  settings.streamingChunkDelay=parseInt(document.getElementById('streaming-chunk-delay-select').value)||20;
  saveSetting('enableStreaming',settings.enableStreaming);
  saveSetting('streamingChunkDelay',settings.streamingChunkDelay);
  applySettings();
  closeModal('streaming-modal');
  toast('ÊµÅÂºèÈüøÊáâË®≠ÁΩÆÂ∑≤‰øùÂ≠ò','success');
}

// ÊôÇÈñì
function updateTime(){const n=new Date();document.getElementById('status-time').textContent=`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;}

// Â∞éËà™
function goTo(id){
  const cur=document.querySelector('.view.active'),tar=document.getElementById(id);
  if(!tar||cur===tar)return;
  hist.push(id);
  cur.classList.remove('active');cur.classList.add('out');
  tar.classList.add('active');
  setTimeout(()=>cur.classList.remove('out'),300);
  // ËºâÂÖ•Êï∏Êìö
  if(id==='view-lore')renderLore();
  else if(id==='view-timeline')renderTimeline();
  else if(id==='view-foreshadow')renderForeshadow();
  else if(id==='view-saves')renderSaves();
  else if(id==='view-api')renderApi();
  else if(id==='view-chapters')renderChapters();
  else if(id==='view-bookmarks')renderBookmarks();
  else if(id==='view-branches')renderBranches();
  else if(id==='view-characters')renderCharacters(); // v7
  else if(id==='view-lorebook')renderLorebook(); // v13
  else if(id==='view-search')initContentSearch(); // v17 ‰øÆÂæ©
}
function goBack(){
  if(hist.length>1){
    hist.pop();
    const prev=hist[hist.length-1];
    const cur=document.querySelector('.view.active'),tar=document.getElementById(prev);
    cur.classList.remove('active');tar.classList.add('active');
  }
}
function switchTab(t){
  document.querySelectorAll('.tab-bar .tab-item').forEach(x=>x.classList.remove('active'));
  if(t==='stories'){goTo('view-stories');document.querySelectorAll('.tab-bar')[0]?.querySelector('.tab-item')?.classList.add('active');}
  else if(t==='instructions'){goTo('view-instructions');}
  else if(t==='settings'){goTo('view-settings');}
}

// ÊïÖ‰∫ãÂàóË°®
async function renderStories(){
  const c=document.getElementById('story-list');
  let list=await db.stories.orderBy('updatedAt').reverse().toArray();
  list.sort((a,b)=>(a.isPinned&&!b.isPinned)?-1:(!a.isPinned&&b.isPinned)?1:0);
  if(!list.length){c.innerHTML=`<div class="empty"><div class="empty-icon">üìö</div><div class="empty-title">ÈÇÑÊ≤íÊúâÊïÖ‰∫ã</div><div class="empty-desc">ÈªûÊìäÂè≥‰∏äËßí ‚ûï ÂâµÂª∫‰Ω†ÁöÑÁ¨¨‰∏ÄÂÄã‰∫íÂãïÊïÖ‰∫ã</div><button class="empty-btn" onclick="createStory()">ÂâµÂª∫ÊïÖ‰∫ã</button></div>`;return;}
  c.innerHTML=list.map(s=>{
    const t=timeAgo(s.updatedAt),stats=s.statistics||{totalChars:0},tags=(s.tags||[]).map(x=>`<span class="tag">${esc(x)}</span>`).join('');
    // ÊîØÊåÅÂ∞ÅÈù¢ÂúñÁâá
    const coverEmoji = esc(s.cover) || 'üìñ';
    const coverContent = s.coverImage 
      ? `<img src="${s.coverImage}" alt="Â∞ÅÈù¢" onerror="this.outerHTML='<span class=cover-emoji>${coverEmoji}</span>'">` 
      : `<span class="cover-emoji">${coverEmoji}</span>`;
    return `<div class="card ${s.isPinned?'pinned':''}" onclick="openStory('${s.id}')"><div class="card-cover">${coverContent}</div><div class="card-info"><div class="card-header"><span class="card-title">${esc(s.title)}</span><span class="card-time">${t}</span></div><div class="card-preview">${esc(s.preview||'ÈñãÂßã‰Ω†ÁöÑÂÜíÈö™...')}</div><div class="card-meta">${s.instructionName?`<span class="card-instruction">üìú ${esc(s.instructionName)}</span>`:''}<span class="card-stats">üìä ${fmtNum(stats.totalChars)}Â≠ó</span></div>${tags?`<div class="card-tags">${tags}</div>`:''}</div><div class="card-menu-btn" onclick="event.stopPropagation();showStoryMenu('${s.id}')">‚ãØ</div></div>`;
  }).join('');
}
function filterStories(){const q=document.getElementById('story-search').value.toLowerCase();document.querySelectorAll('#story-list .card').forEach(c=>{const t=c.querySelector('.card-title')?.textContent.toLowerCase()||'';c.style.display=t.includes(q)?'':'none';});}

// v19: Á∂ìÁáüÊ®°ÂºèÁõ∏Èóú
let selectedStoryMode = 'normal';

function selectStoryMode(mode){
  selectedStoryMode = mode;
  document.getElementById('mode-normal').classList.toggle('active', mode === 'normal');
  document.getElementById('mode-simulation').classList.toggle('active', mode === 'simulation');
  document.getElementById('sim-mode-options').style.display = mode === 'simulation' ? 'block' : 'none';
}

function addSimResource(){
  const container = document.getElementById('new-sim-resources');
  const div = document.createElement('div');
  div.style.cssText = 'display:flex;gap:6px;align-items:center';
  div.innerHTML = `
    <input type="text" class="form-input" style="width:60px" placeholder="üìä" maxlength="2">
    <input type="text" class="form-input" style="flex:1" placeholder="ÂêçÁ®±">
    <input type="number" class="form-input" style="width:80px" placeholder="Êï∏ÂÄº" value="0">
    <button onclick="removeSimResource(this)" style="background:none;border:none;color:var(--error);cursor:pointer">‚úï</button>
  `;
  container.appendChild(div);
}

function removeSimResource(btn){
  btn.parentElement.remove();
}

async function createStory(){
  const insts=await db.instructions.toArray();
  const sel=document.getElementById('new-inst');
  sel.innerHTML='<option value="">‰∏çÁ∂ÅÂÆöÊåá‰ª§</option>'+insts.map(i=>`<option value="${i.id}">${esc(i.name)}</option>`).join('');
  document.getElementById('new-title').value='';
  document.getElementById('new-desc').value='';
  document.getElementById('new-tags').value='';
  // v19: ÈáçÁΩÆÊ®°ÂºèÈÅ∏Êìá
  selectedStoryMode = 'normal';
  selectStoryMode('normal');
  // ÈáçÁΩÆÂàùÂßãË≥áÊ∫ê
  document.getElementById('new-sim-resources').innerHTML = `
    <div style="display:flex;gap:6px;align-items:center">
      <input type="text" class="form-input" style="width:60px" placeholder="üí∞" maxlength="2" value="üí∞">
      <input type="text" class="form-input" style="flex:1" placeholder="ÂêçÁ®±" value="ÈáëÂπ£">
      <input type="number" class="form-input" style="width:80px" placeholder="Êï∏ÂÄº" value="10000">
      <button onclick="removeSimResource(this)" style="background:none;border:none;color:var(--error);cursor:pointer">‚úï</button>
    </div>
  `;
  showModal('new-story-modal');
}
async function saveNewStory(){
  const title=document.getElementById('new-title').value.trim();
  if(!title){toast('Ë´ãËº∏ÂÖ•ÊïÖ‰∫ãÊ®ôÈ°å','warning');return;}
  const desc=document.getElementById('new-desc').value.trim();
  const tagsStr=document.getElementById('new-tags').value.trim();
  const tags=tagsStr?tagsStr.split(/\s+/):[];
  const instId=document.getElementById('new-inst').value;
  const storyId=crypto.randomUUID(),branchId='main_'+crypto.randomUUID(),now=Date.now();
  const s={id:storyId,title,description:desc,cover:'üìñ',tags,currentBranchId:branchId,currentMessageId:null,storyTime:'',isPinned:false,preview:'',createdAt:now,updatedAt:now,statistics:{totalChars:0,totalMessages:0},draft:'',autoSave:{enabled:true,interval:20,maxCount:5}};
  
  // v19: ‰øùÂ≠òÊ®°ÂºèÂíåË≥áÊ∫ê
  s.mode = selectedStoryMode;
  if(selectedStoryMode === 'simulation'){
    s.simDay = 1;
    s.simResources = [];
    const rows = document.querySelectorAll('#new-sim-resources > div');
    rows.forEach(row => {
      const inputs = row.querySelectorAll('input');
      if(inputs.length >= 3){
        const icon = inputs[0].value.trim() || 'üìä';
        const name = inputs[1].value.trim();
        const value = parseFloat(inputs[2].value) || 0;
        if(name) s.simResources.push({icon, name, value, prevValue: value});
      }
    });
  }
  
  if(instId){const inst=await db.instructions.get(instId);if(inst){s.instructionName=inst.name;await db.storyInstructions.put({storyId,instructionId:instId,order:0});}}
  await db.branches.put({id:branchId,storyId,name:'‰∏ªÁ∑ö',parentBranchId:null,createdAt:now});
  await db.stories.put(s);
  closeModal('new-story-modal');
  toast('ÊïÖ‰∫ãÂâµÂª∫ÊàêÂäüÔºÅ','success');
  await renderStories();
  openStory(storyId);
}

async function openStory(id){
  showLoading('ËºâÂÖ•ÊïÖ‰∫ã...');
  try{
    story=await db.stories.get(id);
    if(!story){toast('ÊïÖ‰∫ã‰∏çÂ≠òÂú®','error');hideLoading();return;}
    msgs=await db.messages.where('[storyId+branchId]').equals([id,story.currentBranchId]).sortBy('createdAt');
    document.getElementById('reading-title').textContent=story.title;
    renderMsgs();
    applyChatBg(); // ÊáâÁî®ËÅäÂ§©ËÉåÊôØ
    // v19: Á∂ìÁáüÊ®°Âºè UI ÂàáÊèõ
    updateSimulationUI();
    // v22: ËºâÂÖ• Persona
    await initDefaultPersona();
    goTo('view-reading');
    hideLoading();
  }catch(e){console.error(e);toast('ËºâÂÖ•Â§±Êïó','error');hideLoading();}
}

// v21: Êõ¥Êñ∞Á∂ìÁáüÊ®°Âºè UIÔºàÈõôËªå‰∏¶Ë°åÔºöË≥áÊ∫êÈù¢Êùø + ËßíËâ≤Á≥ªÁµ±ÈÉΩÂèØÁî®Ôºâ
function updateSimulationUI(){
  const isSimMode = story?.mode === 'simulation';
  const resourceBar = document.getElementById('sim-resource-bar');
  const btnCharacters = document.getElementById('btn-characters');
  
  if(isSimMode){
    resourceBar.style.display = 'flex';
    // v21: Á∂ìÁáüÊ®°Âºè‰∏ã‰πü‰øùÁïôËßíËâ≤ÁãÄÊÖãÊåâÈàïÔºàÈõôËªå‰∏¶Ë°åÔºâ
    btnCharacters.style.display = '';
    renderSimResourceBar();
  } else {
    resourceBar.style.display = 'none';
    btnCharacters.style.display = '';
  }
}

// v19: Ê∏≤ÊüìË≥áÊ∫êÈù¢Êùø
function renderSimResourceBar(){
  const bar = document.getElementById('sim-resource-bar');
  if(!story || story.mode !== 'simulation') return;
  
  const day = story.simDay || 1;
  const resources = story.simResources || [];
  
  let html = `<div class="sim-day-badge" onclick="showSimResourceModal()">üìÖ Á¨¨ ${day} Â§©</div>`;
  
  resources.forEach(r => {
    const change = r.value - (r.prevValue || r.value);
    let changeHtml = '';
    if(change !== 0){
      const cls = change > 0 ? 'up' : 'down';
      const sign = change > 0 ? '+' : '';
      changeHtml = `<span class="sim-resource-change ${cls}">${sign}${formatNumber(change)}</span>`;
    }
    html += `
      <div class="sim-resource-item" onclick="showSimResourceModal()">
        <span class="sim-resource-icon">${r.icon}</span>
        <span class="sim-resource-value">${formatNumber(r.value)}</span>
        ${changeHtml}
      </div>
    `;
  });
  
  bar.innerHTML = html;
}

function formatNumber(n){
  if(Math.abs(n) >= 10000) return (n/10000).toFixed(1) + 'Ëê¨';
  if(Math.abs(n) >= 1000) return n.toLocaleString();
  return n.toString();
}

// v19: È°ØÁ§∫Ë≥áÊ∫êÁÆ°ÁêÜ Modal
function showSimResourceModal(){
  if(!story || story.mode !== 'simulation'){
    toast('Ê≠§ÊïÖ‰∫ã‰∏çÊòØÁ∂ìÁáüÊ®°Âºè','warning');
    return;
  }
  
  document.getElementById('sim-current-day').value = story.simDay || 1;
  
  const list = document.getElementById('sim-resource-list');
  const resources = story.simResources || [];
  
  list.innerHTML = resources.map((r, idx) => `
    <div style="display:flex;gap:6px;align-items:center" data-idx="${idx}">
      <input type="text" class="form-input" style="width:50px;text-align:center" value="${r.icon}" maxlength="2">
      <input type="text" class="form-input" style="flex:1" value="${esc(r.name)}">
      <input type="number" class="form-input" style="width:90px" value="${r.value}">
      <button onclick="removeSimResourceInModal(this)" style="background:none;border:none;color:var(--error);cursor:pointer;font-size:16px">‚úï</button>
    </div>
  `).join('');
  
  showModal('sim-resource-modal');
}

function addSimResourceInModal(){
  const list = document.getElementById('sim-resource-list');
  const div = document.createElement('div');
  div.style.cssText = 'display:flex;gap:6px;align-items:center';
  div.innerHTML = `
    <input type="text" class="form-input" style="width:50px;text-align:center" placeholder="üìä" maxlength="2">
    <input type="text" class="form-input" style="flex:1" placeholder="Ë≥áÊ∫êÂêçÁ®±">
    <input type="number" class="form-input" style="width:90px" placeholder="Êï∏ÂÄº" value="0">
    <button onclick="removeSimResourceInModal(this)" style="background:none;border:none;color:var(--error);cursor:pointer;font-size:16px">‚úï</button>
  `;
  list.appendChild(div);
}

function removeSimResourceInModal(btn){
  btn.parentElement.remove();
}

function simDayMinus(){
  const input = document.getElementById('sim-current-day');
  input.value = Math.max(1, parseInt(input.value) - 1);
}

function simDayPlus(){
  const input = document.getElementById('sim-current-day');
  input.value = parseInt(input.value) + 1;
}

async function saveSimResources(){
  if(!story) return;
  
  const day = parseInt(document.getElementById('sim-current-day').value) || 1;
  const rows = document.querySelectorAll('#sim-resource-list > div');
  const resources = [];
  
  rows.forEach(row => {
    const inputs = row.querySelectorAll('input');
    if(inputs.length >= 3){
      const icon = inputs[0].value.trim() || 'üìä';
      const name = inputs[1].value.trim();
      const value = parseFloat(inputs[2].value) || 0;
      // ‰øùÁïô‰πãÂâçÁöÑ prevValue Áî®ÊñºË®àÁÆóËÆäÂåñ
      const oldResource = story.simResources?.find(r => r.name === name);
      if(name) resources.push({
        icon, 
        name, 
        value, 
        prevValue: oldResource?.value ?? value
      });
    }
  });
  
  story.simDay = day;
  story.simResources = resources;
  
  await db.stories.update(story.id, {simDay: day, simResources: resources});
  
  renderSimResourceBar();
  closeModal('sim-resource-modal');
  toast('Ë≥áÊ∫êÂ∑≤Êõ¥Êñ∞','success');
}

// v19: Âø´ÈÄüÊõ¥Êñ∞Ë≥áÊ∫êÔºà+1Â§©Ôºâ
async function simNextDay(){
  if(!story || story.mode !== 'simulation') return;
  
  // ‰øùÂ≠òÁï∂ÂâçÂÄºÁÇ∫ prevValue
  const resources = (story.simResources || []).map(r => ({
    ...r,
    prevValue: r.value
  }));
  
  story.simDay = (story.simDay || 1) + 1;
  story.simResources = resources;
  
  await db.stories.update(story.id, {simDay: story.simDay, simResources: resources});
  renderSimResourceBar();
  toast(`ÈÄ≤ÂÖ•Á¨¨ ${story.simDay} Â§©`,'info');
}

// v19: Â≠òÊ™îÂ∞éÂÖ•
function showSimImportModal(){
  if(!story || story.mode !== 'simulation'){
    toast('Ê≠§ÊïÖ‰∫ã‰∏çÊòØÁ∂ìÁáüÊ®°Âºè','warning');
    return;
  }
  document.getElementById('sim-import-content').value = '';
  document.getElementById('sim-import-regex').value = '';
  document.getElementById('sim-import-preview').style.display = 'none';
  showModal('sim-import-modal');
}

function parseSimImport(){
  const content = document.getElementById('sim-import-content').value;
  const customRegex = document.getElementById('sim-import-regex').value;
  
  if(!content.trim()){
    toast('Ë´ãË≤ºÂÖ•Â≠òÊ™îÂÖßÂÆπ','warning');
    return;
  }
  
  const result = {day: null, resources: []};
  
  // ÂòóË©¶Ëß£ÊûêÂ§©Êï∏
  const dayPatterns = [
    /Á¨¨\s*(\d+)\s*Â§©/,
    /Day\s*(\d+)/i,
    /ÈÅäÊà≤Êó•Êúü.*?(\d+)Â§©/,
    /Â∑≤ÈÅäÁé©.*?(\d+)\s*Â§©/
  ];
  for(const p of dayPatterns){
    const m = content.match(p);
    if(m) { result.day = parseInt(m[1]); break; }
  }
  
  // ÂòóË©¶Ëß£ÊûêË≥áÊ∫ê
  const resourcePatterns = [
    // üí∞ ÁèæÈáëÔºö100,000ÂÖÉ
    /([üí∞üì¶üë•üíé‚≠êüîÆ‚ù§Ô∏èüçñüòäüìäüé¥])\s*([^Ôºö:]+)[Ôºö:]\s*([\d,]+)/g,
    // ÁèæÈáëÔºö100,000ÂÖÉ
    /([^\sÔºö:]+)[Ôºö:]\s*([\d,]+)\s*ÂÖÉ?/g
  ];
  
  if(customRegex){
    try{
      const regex = new RegExp(customRegex, 'g');
      let m;
      while((m = regex.exec(content)) !== null){
        if(m[1] && m[2]){
          result.resources.push({icon:'üìä', name:m[1], value:parseInt(m[2].replace(/,/g,''))});
        }
      }
    }catch(e){
      toast('Ê≠£ÂâáË°®ÈÅîÂºèÈåØË™§: '+e.message,'error');
      return;
    }
  } else {
    // ‰ΩøÁî®ÈªòË™çÊ®°Âºè
    for(const p of resourcePatterns){
      p.lastIndex = 0; // ÈáçÁΩÆÊ≠£ÂâáË°®ÈÅîÂºèÁãÄÊÖã
      let m;
      while((m = p.exec(content)) !== null){
        const isEmoji = /[\u{1F300}-\u{1F9FF}]/u.test(m[1]);
        if(isEmoji){
          result.resources.push({
            icon: m[1],
            name: m[2].trim(),
            value: parseInt(m[3].replace(/,/g,''))
          });
        } else if(m[1] && m[2]){
          result.resources.push({
            icon: 'üìä',
            name: m[1].trim(),
            value: parseInt(m[2].replace(/,/g,''))
          });
        }
      }
    }
  }
  
  // ÂéªÈáç
  const seen = new Set();
  result.resources = result.resources.filter(r => {
    if(seen.has(r.name)) return false;
    seen.add(r.name);
    return true;
  });
  
  // È°ØÁ§∫È†êË¶Ω
  const preview = document.getElementById('sim-import-preview');
  const previewContent = document.getElementById('sim-import-preview-content');
  
  let html = '';
  if(result.day) html += `<div>üìÖ Â§©Êï∏ÔºöÁ¨¨ ${result.day} Â§©</div>`;
  if(result.resources.length){
    html += '<div style="margin-top:8px">Ë≥áÊ∫êÔºö</div>';
    html += result.resources.map(r => 
      `<div style="margin-left:12px">${r.icon} ${r.name}Ôºö${r.value.toLocaleString()}</div>`
    ).join('');
  }
  
  if(!html) html = '<div style="color:var(--text-tertiary)">Êú™ËÉΩËß£ÊûêÂá∫‰ªª‰ΩïÊï∏ÊìöÔºåË´ãÊ™¢Êü•Ê†ºÂºèÊàñ‰ΩøÁî®Ëá™ÂÆöÁæ©Ê≠£Ââá</div>';
  
  previewContent.innerHTML = html;
  preview.style.display = 'block';
  
  // ‰øùÂ≠òËß£ÊûêÁµêÊûú‰æõÂ∞éÂÖ•‰ΩøÁî®
  preview.dataset.result = JSON.stringify(result);
}

async function applySimImport(){
  const preview = document.getElementById('sim-import-preview');
  if(!preview.dataset.result){
    parseSimImport();
  }
  
  try{
    const result = JSON.parse(preview.dataset.result || '{}');
    
    if(result.day) story.simDay = result.day;
    if(result.resources?.length){
      story.simResources = result.resources.map(r => ({...r, prevValue: r.value}));
    }
    
    await db.stories.update(story.id, {
      simDay: story.simDay,
      simResources: story.simResources
    });
    
    renderSimResourceBar();
    closeModal('sim-import-modal');
    toast('Â≠òÊ™îÂ∞éÂÖ•ÊàêÂäüÔºÅ','success');
  }catch(e){
    toast('Â∞éÂÖ•Â§±Êïó: '+e.message,'error');
  }
}

// v19: Â≠òÊ™îÂ∞éÂá∫
function showSimExportModal(){
  if(!story || story.mode !== 'simulation'){
    toast('Ê≠§ÊïÖ‰∫ã‰∏çÊòØÁ∂ìÁáüÊ®°Âºè','warning');
    return;
  }
  document.getElementById('sim-export-format').value = 'simple';
  document.getElementById('sim-export-template-group').style.display = 'none';
  generateSimExport();
  showModal('sim-export-modal');
}

function generateSimExport(){
  const format = document.getElementById('sim-export-format').value;
  const templateGroup = document.getElementById('sim-export-template-group');
  templateGroup.style.display = format === 'custom' ? 'block' : 'none';
  
  const day = story.simDay || 1;
  const resources = story.simResources || [];
  const title = story.title;
  
  let content = '';
  
  if(format === 'simple'){
    content = `„Äê${title}„ÄëÂ≠òÊ™î\n`;
    content += `üìÖ Á¨¨ ${day} Â§©\n\n`;
    content += `„ÄêÁï∂ÂâçÁãÄÊÖã„Äë\n`;
    resources.forEach(r => {
      content += `${r.icon} ${r.name}Ôºö${r.value.toLocaleString()}\n`;
    });
  } else if(format === 'detailed'){
    content = `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
    content += `„Äê${title}„ÄëÂÆåÊï¥Â≠òÊ™î\n`;
    content += `Â≠òÊ™îÊôÇÈñìÔºö${new Date().toLocaleString()}\n`;
    content += `ÈÅäÊà≤Êó•ÊúüÔºöÁ¨¨ ${day} Â§©\n`;
    content += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
    content += `„ÄêÁï∂ÂâçÁãÄÊÖã„Äë\n`;
    resources.forEach(r => {
      content += `${r.icon} ${r.name}Ôºö${r.value.toLocaleString()}\n`;
    });
    content += `\n„ÄêÊïÖ‰∫ãÊëòË¶Å„Äë\n`;
    if(story.summaries?.length){
      story.summaries.forEach((s, i) => {
        content += `\n--- Ë®òÊÜ∂ÁâáÊÆµ ${i+1} ---\n${s.content}\n`;
      });
    } else {
      content += `ÔºàÊö´ÁÑ°ÊëòË¶ÅÔºâ\n`;
    }
    content += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
    content += `Â∞áÊ≠§Â≠òÊ™îÂÆåÊï¥Ë≤ºÁµ¶Êñ∞Â∞çË©±Âç≥ÂèØÁπºÁ∫åÈÅäÊà≤\n`;
    content += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`;
  } else {
    // Ëá™ÂÆöÁæ©Ê®°Êùø
    const template = document.getElementById('sim-export-template').value;
    content = template
      .replace(/{day}/g, day)
      .replace(/{title}/g, title)
      .replace(/{resources}/g, resources.map(r => `${r.icon} ${r.name}Ôºö${r.value.toLocaleString()}`).join('\n'))
      .replace(/{summary}/g, story.summaries?.map(s=>s.content).join('\n\n') || 'ÔºàÊö´ÁÑ°Ôºâ');
  }
  
  document.getElementById('sim-export-content').value = content;
}

async function copySimExport(){
  const content = document.getElementById('sim-export-content').value;
  try{
    await navigator.clipboard.writeText(content);
    toast('Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÊùø','success');
  }catch(e){
    toast('Ë§áË£ΩÂ§±ÊïóÔºåË´ãÊâãÂãïÈÅ∏ÂèñË§áË£Ω','error');
  }
}
function renderMsgs(){
  const c=document.getElementById('content-area');
  if(!msgs.length){c.innerHTML=`<div class="empty" style="padding:60px 20px"><div class="empty-icon">‚ú®</div><div class="empty-title">ÊïÖ‰∫ãÂç≥Â∞áÈñãÂßã</div><div class="empty-desc">Ëº∏ÂÖ•‰Ω†ÁöÑÁ¨¨‰∏ÄÂÄãË°åÂãïÔºåÊàñÈªûÊìä„ÄåÁπºÁ∫å„ÄçËÆìAIÈñãÂßãË¨õËø∞...</div></div>`;updateProgress();return;}
  let html='',lastTime=null,floor=0;
  msgs.forEach((m,idx)=>{
    floor++;
    if(m.storyTime&&m.storyTime!==lastTime){html+=`<div class="time-div">${esc(m.storyTime)}</div>`;lastTime=m.storyTime;}
    const isUser=m.role==='user';
    const isLast = idx === msgs.length - 1;
    
    html+=`<div class="msg-swipe-wrapper" data-msg-id="${m.id}">`;
    
    // Â∑¶ÂÅ¥Êìç‰ΩúÊåâÈàïÔºàÂè≥ÊªëÈ°ØÁ§∫Ôºâ
    html+=`<div class="msg-swipe-actions left">
      <button class="msg-swipe-btn edit" onclick="editMsgById('${m.id}')">‚úèÔ∏è Á∑®ËºØ</button>
    </div>`;
    
    // Âè≥ÂÅ¥Êìç‰ΩúÊåâÈàïÔºàÂ∑¶ÊªëÈ°ØÁ§∫Ôºâ
    html+=`<div class="msg-swipe-actions right">
      ${!isUser?`<button class="msg-swipe-btn regen" onclick="regenerateMsgById('${m.id}')">üîÑ ÈáçÁîüÊàê</button>`:''}
      <button class="msg-swipe-btn delete" onclick="deleteMsgById('${m.id}')">üóëÔ∏è Âà™Èô§</button>
    </div>`;
    
    html+=`<div class="msg-swipe-content">`;
    
    if(isUser){
      // Â∞èË™™ÂºèÔºöÁî®Êà∂Ë°åÂãïÂ±Ö‰∏≠È°ØÁ§∫
      html+=`<div class="msg user" data-id="${m.id}" oncontextmenu="showMsgMenu(event,'${m.id}')">
        <span class="msg-floor">#${floor}</span>
        <div class="msg-user-action">
          <div class="action-divider">‰Ω†ÁöÑË°åÂãï</div>
          <div class="action-content">„Äå${esc(m.content).replace(/^[„Äå„Äç]|[„Äå„Äç]$/g,'')}„Äç</div>
        </div>
      </div>`;
    }else{
      // AI Ê∂àÊÅØÔºöÂàÜÈõ¢ÂäáÊÉÖÂíåÁãÄÊÖã
      const parsed = parseAIResponse(m.content||'');
      html+=`<div class="msg" data-id="${m.id}" oncontextmenu="showMsgMenu(event,'${m.id}')">`;
      html+=`<span class="msg-floor">#${floor}</span>`;
      html+=`<div class="msg-ai-story">${marked.parse(parsed.story)}</div>`;
      if(parsed.characters && parsed.characters.length > 0){
        html+=renderStatusCards(parsed.characters, m.id);
      }
      if(parsed.formatWarning){
        html+=`<div class="msg-format-warning"><span class="icon">‚ö†Ô∏è</span>AI Êú™ÊåâÊ†ºÂºèËº∏Âá∫ÁãÄÊÖãÊï∏ÊìöÔºåÂ∑≤È°ØÁ§∫ÂéüÊñá</div>`;
      }
      if(m.tokens){
        html+=`<div class="msg-timestamp">${m.tokens} tokens</div>`;
      }
      html+=`</div>`;
    }
    
    html+=`</div></div>`;
  });
  c.innerHTML=html;
  c.scrollTop=c.scrollHeight;
  updateProgress();
  // ÂàùÂßãÂåñÊªëÂãïÊâãÂã¢
  initMsgSwipe();
}

// Ëß£Êûê AI ÂõûË¶ÜÔºåÂàÜÈõ¢ÂäáÊÉÖÂíåËßíËâ≤ÁãÄÊÖã
function parseAIResponse(content){
  let story = content;
  let characters = [];
  let formatWarning = false;
  
  // ÂòóË©¶ÂåπÈÖç JSON ‰ª£Á¢ºÂ°ä
  const jsonMatch = content.match(/```json\s*([\s\S]*?)\s*```/);
  if(jsonMatch){
    try{
      const jsonStr = jsonMatch[1];
      const data = JSON.parse(jsonStr);
      if(data.characters && Array.isArray(data.characters)){
        characters = data.characters;
        // ÁßªÈô§ JSON ÈÉ®ÂàÜÔºåÂè™‰øùÁïôÂäáÊÉÖ
        story = content.replace(/```json\s*[\s\S]*?\s*```/, '').trim();
        // ÁßªÈô§ÂèØËÉΩÁöÑÂàÜÈöîÁ∑ö
        story = story.replace(/[-‚îÄ]{3,}\s*(?:ÁãÄÊÖãÊõ¥Êñ∞|ËßíËâ≤ÁãÄÊÖã|ÁèæÊúâÂæåÂÆÆ|ÁãÄÊÖã)\s*[-‚îÄ]{3,}/gi, '').trim();
      }
    }catch(e){
      console.log('JSON parse error:', e);
      formatWarning = true;
    }
  }else{
    // Ê™¢Êü•ÊòØÂê¶ÊúâÁãÄÊÖãÂÖßÂÆπ‰ΩÜÊ≤íÁî® JSON Ê†ºÂºè
    const hasStatusMarker = /[-‚îÄ]{3,}\s*(?:ÁãÄÊÖãÊõ¥Êñ∞|ËßíËâ≤ÁãÄÊÖã|ÁèæÊúâÂæåÂÆÆ|ÁãÄÊÖã|ÁèæÊúâËßíËâ≤)\s*[-‚îÄ]{3,}/i.test(content);
    const hasCharacterBlock = /„Äê[^„Äë]+„Äë[^\n]+/.test(content);
    if(hasStatusMarker || hasCharacterBlock){
      // ÂòóË©¶Ëß£ÊûêËàäÊ†ºÂºè
      const parsed = parseOldFormatStatus(content);
      if(parsed.characters.length > 0){
        characters = parsed.characters;
        story = parsed.story;
      }else{
        formatWarning = hasStatusMarker; // ÊúâÊ®ôË®ò‰ΩÜËß£ÊûêÂ§±ÊïóÊâçË≠¶Âëä
      }
    }
  }
  
  return { story, characters, formatWarning };
}

// Ëß£ÊûêËàäÊ†ºÂºèÁãÄÊÖãÔºà„ÄêËßíËâ≤„ÄëÊ†ºÂºèÔºâ
function parseOldFormatStatus(content){
  let story = content;
  let characters = [];
  
  // ÊâæÂà∞ÁãÄÊÖãÂàÜÈöîÁ∑ö
  const statusMatch = content.match(/([-‚îÄ]{3,}\s*(?:ÁãÄÊÖãÊõ¥Êñ∞|ËßíËâ≤ÁãÄÊÖã|ÁèæÊúâÂæåÂÆÆ|ÁãÄÊÖã|ÁèæÊúâËßíËâ≤)\s*[-‚îÄ]{3,})([\s\S]*?)(?=[-‚îÄ]{3,}|$)/i);
  if(statusMatch){
    story = content.slice(0, content.indexOf(statusMatch[0])).trim();
    const statusText = statusMatch[2];
    
    // Ëß£Êûê„ÄêËßíËâ≤„ÄëÊ†ºÂºè
    const charBlocks = statusText.split(/(?=„Äê[^„Äë]+„Äë)/);
    charBlocks.forEach(block => {
      if(!block.trim()) return;
      const nameMatch = block.match(/„Äê([^„Äë]+)„Äë\s*([^\s„Äê]+)?/);
      if(nameMatch){
        const char = {
          name: nameMatch[2] || nameMatch[1],
          title: nameMatch[1].includes('„Äë') ? '' : nameMatch[1],
          stats: {},
          tags: []
        };
        
        // ÊèêÂèñÊï∏ÂÄºÂ±¨ÊÄß
        const statPatterns = [
          /Â•ΩÊÑü[Â∫¶]?\s*(\d+)/g,
          /Ë°®Èù¢Â•ΩÊÑü\s*(\d+)/g,
          /ÁúüÂØ¶Â•ΩÊÑü\s*(\d+)/g,
          /ÂØµÊÑõ[Â∫¶]?\s*(\d+)/g,
          /Âø†Ë™†[Â∫¶]?\s*(\d+)/g,
          /ÈáéÂøÉ[ÂÄº]?\s*(\d+)/g,
          /Êô∫Ë¨Ä\s*(\d+)/g,
          /ÂÆπË≤å\s*(\d+)/g,
          /ÂÅ•Â∫∑\s*(\d+)/g
        ];
        
        const statNames = ['Â•ΩÊÑü', 'Ë°®Èù¢Â•ΩÊÑü', 'ÁúüÂØ¶Â•ΩÊÑü', 'ÂØµÊÑõÂ∫¶', 'Âø†Ë™†', 'ÈáéÂøÉ', 'Êô∫Ë¨Ä', 'ÂÆπË≤å', 'ÂÅ•Â∫∑'];
        statPatterns.forEach((pattern, i) => {
          const match = block.match(pattern);
          if(match){
            char.stats[statNames[i]] = parseInt(match[1]);
          }
        });
        
        // ÊèêÂèñÊÉÖÁ∑í
        const moodMatch = block.match(/ÊÉÖÁ∑í[Ôºö:]\s*([^\s|ÔΩú]+)/);
        if(moodMatch) char.mood = moodMatch[1];
        
        // ÊèêÂèñÂ±ÖÊâÄ
        const locationMatch = block.match(/Â±ÖÊâÄ[Ôºö:¬∑]?\s*([^\s|ÔΩú]+)/);
        if(locationMatch) char.location = locationMatch[1];
        
        if(Object.keys(char.stats).length > 0 || char.mood){
          characters.push(char);
        }
      }
    });
  }
  
  return { story, characters };
}

// Ê∏≤ÊüìÁãÄÊÖãÂç°Áâá
function renderStatusCards(characters, msgId){
  if(!characters || characters.length === 0) return '';
  
  let html = `<div class="msg-status-section">`;
  html += `<div class="msg-status-header" onclick="toggleStatusCards(this)">`;
  html += `<span class="title">üë• ËßíËâ≤ÁãÄÊÖãÊõ¥Êñ∞ (${characters.length})</span>`;
  html += `<span class="toggle">‚ñº</span>`;
  html += `</div>`;
  html += `<div class="msg-status-cards">`;
  
  characters.forEach(char => {
    html += `<div class="status-card">`;
    html += `<div class="status-card-header">`;
    html += `<div class="status-card-avatar">${char.avatar || 'üë§'}</div>`;
    html += `<div class="status-card-info">`;
    html += `<div class="status-card-name">${esc(char.name)}`;
    if(char.title) html += `<span class="status-card-title">${esc(char.title)}</span>`;
    html += `</div>`;
    if(char.location) html += `<div class="status-card-meta">üìç ${esc(char.location)}</div>`;
    html += `</div></div>`;
    
    // Ê∏≤ÊüìÊï∏ÂÄºÂ±¨ÊÄß
    if(char.stats && Object.keys(char.stats).length > 0){
      html += `<div class="status-card-stats">`;
      Object.entries(char.stats).forEach(([key, value]) => {
        const numValue = typeof value === 'number' ? value : parseInt(value) || 0;
        const fillClass = numValue >= 70 ? 'high' : numValue >= 40 ? 'medium' : numValue > 0 ? 'low' : 'primary';
        html += `<div class="status-stat-row">`;
        html += `<span class="status-stat-label">${esc(key)}</span>`;
        html += `<div class="status-stat-bar"><div class="status-stat-fill ${fillClass}" style="width:${Math.min(100, numValue)}%"></div></div>`;
        html += `<span class="status-stat-value">${numValue}</span>`;
        html += `</div>`;
      });
      html += `</div>`;
    }
    
    // Ê∏≤ÊüìÊ®ôÁ±§ÔºàÊÉÖÁ∑í„ÄÅÂÇôË®ªÁ≠âÔºâ
    const hasTags = char.mood || char.note || (char.tags && char.tags.length > 0);
    if(hasTags){
      html += `<div class="status-card-footer">`;
      if(char.mood) html += `<span class="status-tag mood">üòê ${esc(char.mood)}</span>`;
      if(char.note) html += `<span class="status-tag note">üí≠ ${esc(char.note)}</span>`;
      if(char.tags) char.tags.forEach(tag => {
        html += `<span class="status-tag">${esc(tag)}</span>`;
      });
      html += `</div>`;
    }
    
    html += `</div>`;
  });
  
  html += `</div></div>`;
  return html;
}

// ÂàáÊèõÁãÄÊÖãÂç°ÁâáÂ±ïÈñã/Êî∂Ëµ∑
function toggleStatusCards(header){
  header.classList.toggle('expanded');
}

function updateProgress(){const n=msgs.length;document.getElementById('progress-fill').style.width=(n>0?100:0)+'%';document.getElementById('progress-text').textContent=n>0?n+'Ê¢ù':'0%';}

// ============ Ê∂àÊÅØÊªëÂãïÊìç‰Ωú ============
let activeSwipeWrapper = null;
let swipeInitialized = false;

function initMsgSwipe(){
  // ‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâòÔºåÂè™ÂàùÂßãÂåñ‰∏ÄÊ¨°
  if(swipeInitialized) return;
  swipeInitialized = true;
  
  const contentArea = document.getElementById('content-area');
  if(!contentArea) return;
  
  let startX = 0, currentX = 0, isDragging = false, currentWrapper = null;
  
  contentArea.addEventListener('touchstart', e => {
    const wrapper = e.target.closest('.msg-swipe-wrapper');
    if(!wrapper) return;
    
    const content = wrapper.querySelector('.msg-swipe-content');
    if(!content) return;
    
    if(activeSwipeWrapper && activeSwipeWrapper !== wrapper){
      resetSwipe(activeSwipeWrapper);
    }
    
    currentWrapper = wrapper;
    startX = e.touches[0].clientX;
    isDragging = true;
    content.style.transition = 'none';
  }, {passive: true});
  
  contentArea.addEventListener('touchmove', e => {
    if(!isDragging || !currentWrapper) return;
    const content = currentWrapper.querySelector('.msg-swipe-content');
    if(!content) return;
    
    currentX = e.touches[0].clientX;
    const diff = currentX - startX;
    const maxSwipe = 100;
    const clampedDiff = Math.max(-maxSwipe, Math.min(maxSwipe, diff));
    content.style.transform = `translateX(${clampedDiff}px)`;
  }, {passive: true});
  
  contentArea.addEventListener('touchend', e => {
    if(!isDragging || !currentWrapper) return;
    const content = currentWrapper.querySelector('.msg-swipe-content');
    if(!content) return;
    
    isDragging = false;
    content.style.transition = 'transform .2s ease';
    
    const diff = currentX - startX;
    const threshold = 50;
    
    if(diff > threshold){
      content.style.transform = 'translateX(80px)';
      activeSwipeWrapper = currentWrapper;
    } else if(diff < -threshold){
      content.style.transform = 'translateX(-100px)';
      activeSwipeWrapper = currentWrapper;
    } else {
      content.style.transform = 'translateX(0)';
      activeSwipeWrapper = null;
    }
    currentWrapper = null;
  });
  
  // ÈªûÊìäÂÖ∂‰ªñÂú∞ÊñπÈáçÁΩÆÊªëÂãï
  contentArea.addEventListener('click', e => {
    if(!e.target.closest('.msg-swipe-btn') && activeSwipeWrapper){
      resetSwipe(activeSwipeWrapper);
      activeSwipeWrapper = null;
    }
  });
}

function resetSwipe(wrapper){
  const content = wrapper.querySelector('.msg-swipe-content');
  if(content){
    content.style.transition = 'transform .2s ease';
    content.style.transform = 'translateX(0)';
  }
}

function editMsgById(msgId){
  selMsgId = msgId;
  editMsg();
  if(activeSwipeWrapper){
    resetSwipe(activeSwipeWrapper);
    activeSwipeWrapper = null;
  }
}

async function deleteMsgById(msgId){
  selMsgId = msgId;
  await deleteMsg();
  if(activeSwipeWrapper){
    activeSwipeWrapper = null;
  }
}

async function regenerateMsgById(msgId){
  selMsgId = msgId;
  await regenerateMsg();
  if(activeSwipeWrapper){
    resetSwipe(activeSwipeWrapper);
    activeSwipeWrapper = null;
  }
}

// ÁôºÈÄÅÊ∂àÊÅØ
async function send(){
  const input=document.getElementById('user-input'),content=input.value.trim();
  if(!content||generating)return;
  if(!story){toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã','warning');return;}

  generating=true;
  const sendBtn=document.getElementById('send-btn');
  sendBtn.disabled=true;

  // ‰øùÂ≠òÁî®Êà∑Ê∂àÊÅØ
  const userMsgId=crypto.randomUUID();
  const userMsg={id:userMsgId,storyId:story.id,branchId:story.currentBranchId,role:'user',content,createdAt:Date.now()};
  await db.messages.put(userMsg);
  msgs.push(userMsg);
  input.value='';
  renderMsgs();

  // Ê£ÄÊü•ÊòØÂê¶ÂêØÁî®ÊµÅÂºèÂìçÂ∫î
  const useStreaming=settings.enableStreaming;

  if(useStreaming){
    // ÊµÅÂºèÂìçÂ∫îÊ®°Âºè
    await sendWithStreaming(content,sendBtn);
  }else{
    // ‰º†ÁªüÊ®°Âºè
    await sendTraditional(content);
  }

  generating=false;
  sendBtn.disabled=false;
}

// ‰º†ÁªüÈùûÊµÅÂºèÂèëÈÄÅ
async function sendTraditional(content){
  showTyping();
  try{
    const resp=await callAI(content);
    hideTyping();
    const aiMsgId=crypto.randomUUID();
    const aiMsg={id:aiMsgId,storyId:story.id,branchId:story.currentBranchId,role:'assistant',content:resp.content,tokens:resp.tokens||0,storyTime:story.storyTime||'',createdAt:Date.now()};
    await db.messages.put(aiMsg);
    msgs.push(aiMsg);
    await db.stories.update(story.id,{updatedAt:Date.now(),preview:resp.content.slice(0,100),currentMessageId:aiMsgId,'statistics.totalMessages':msgs.length,'statistics.totalChars':(story.statistics?.totalChars||0)+resp.content.length});
    await typewriter(aiMsg);
    checkAutoRollingSummary();
  }catch(e){
    console.error(e);
    hideTyping();
    toast('ÁîüÊàêÂ§±Êïó: '+e.message,'error');
  }
}

// ÊµÅÂºèÂèëÈÄÅ
async function sendWithStreaming(content,sendBtn){
  const preset=await db.apiPresets.filter(p=>p.isActive).first();
  if(!preset){toast('Ë´ãÂÖàÈÖçÁΩÆ‰∏¶ÈÅ∏Êìá‰∏ÄÂÄã API È†êË®≠','error');return;}

  // ÊûÑÂª∫Á≥ªÁªüÊèêÁ§∫ÂíåÊ∂àÊÅØ
  let sysPrompt=await buildSysPrompt();
  const triggeredLorebook=await getTriggeredLorebook(content);
  if(triggeredLorebook.length>0){
    sysPrompt+='\n\n### Áõ∏ÈóúË®≠ÂÆöÔºàËá™ÂãïËß∏ÁôºÔºâ\n';
    for(const entry of triggeredLorebook){
      if(entry.name && entry.content){
        sysPrompt+=`\n#### ${entry.name}\n${entry.content}\n`;
      }
      await db.lorebook.update(entry.id,{triggerCount:(entry.triggerCount||0)+1,lastTriggered:Date.now()});
      if(entry.oneTime)await db.lorebook.update(entry.id,{isEnabled:false});
    }
    showLorebookTriggerToast(triggeredLorebook);
  }

  const contextCount=settings.contextCount||20;
  const messages=msgs.slice(-contextCount).map(m=>({role:m.role,content:m.content}));
  if(!messages.length||messages[messages.length-1].content!==content)messages.push({role:'user',content});

  // ÂàõÂª∫Á©∫ÁöÑAIÊ∂àÊÅØÂÖÉÁ¥†
  const c=document.getElementById('content-area');
  const aiMsgId=crypto.randomUUID();
  const msgDiv=document.createElement('div');
  msgDiv.className='msg';
  msgDiv.dataset.id=aiMsgId;
  c.appendChild(msgDiv);

  // ÊõøÊç¢ÂèëÈÄÅÊåâÈíÆ‰∏∫ÂÅúÊ≠¢ÊåâÈíÆ
  sendBtn.textContent='‚ñ†';
  sendBtn.style.background='var(--error)';
  sendBtn.disabled=false;  // ÈáçË¶ÅÔºöÂêØÁî®ÊåâÈíÆËÆ©Áî®Êà∑ÂèØ‰ª•ÁÇπÂáªÂÅúÊ≠¢
  sendBtn.onclick=()=>stopStreaming();

  let fullContent='';
  let stopped=false;
  const chunkDelay=settings.streamingChunkDelay||20;

  try{
    // ÈÄâÊã©ÂØπÂ∫îÁöÑÊµÅÂºèAPIÂáΩÊï∞
    let streamFunc;
    if(preset.type==='anthropic')streamFunc=callAnthropicStream;
    else if(preset.type==='openai')streamFunc=callOpenAIStream;
    else streamFunc=callCustomStream;

    // Ë∞ÉÁî®ÊµÅÂºèAPI
    const result=await streamFunc(
      preset,
      sysPrompt,
      messages,
      // onChunk: Êî∂Âà∞Êñ∞ÊñáÂ≠óÊó∂
      async(newText,full)=>{
        fullContent=full;
        // ËΩªÂæÆÂª∂Ëøü‰ª•ÂÆûÁé∞Âπ≥ÊªëÊòæÁ§∫
        if(chunkDelay>0){
          await new Promise(r=>setTimeout(r,chunkDelay));
        }
        msgDiv.innerHTML=`<div class="msg-ai-story">${marked.parse(full)}</div>`;
        c.scrollTop=c.scrollHeight;
      },
      // onDone: ÁîüÊàêÂÆåÊàê
      (final)=>{
        fullContent=final;
      },
      // onError: ÂèëÁîüÈîôËØØ
      (error,partial)=>{
        fullContent=partial;
        stopped=true;
      }
    );

    if(result.stopped)stopped=true;

  }catch(e){
    console.error(e);
    stopped=true;

    // Ê£ÄÊü•ÊòØÂê¶ÊòØ‰∏çÊîØÊåÅÊµÅÂºèÁöÑÈîôËØØ
    const errMsg=e.message||'';
    if(errMsg.includes('stream')&&!errMsg.includes('ÂÅúÊ≠¢')){
      toast('Ê≠§ API ‰∏çÊîØÊåÅÊµÅÂºèÈüøÊáâÔºåÂ∑≤Ëá™ÂãïÂàáÊèõÂà∞ÂÇ≥Áµ±Ê®°Âºè','warning');
      // ÈôçÁ∫ßÂà∞ÈùûÊµÅÂºè
      sendBtn.textContent='‚Üë';
      sendBtn.style.background='';
      sendBtn.onclick=()=>send();
      msgDiv.remove();
      await sendTraditional(content);
      return;
    }

    if(!errMsg.includes('ÂÅúÊ≠¢')){
      toast('ÁîüÊàêÂ§±Êïó: '+errMsg,'error');
    }
  }

  // ÊÅ¢Â§çÂèëÈÄÅÊåâÈíÆ
  sendBtn.textContent='‚Üë';
  sendBtn.style.background='';
  sendBtn.onclick=()=>send();

  // Â§ÑÁêÜÁîüÊàêÁöÑÂÜÖÂÆπ
  if(stopped){
    // Áî®Êà∑‰∏≠ÈÄîÂÅúÊ≠¢,ËØ¢ÈóÆÊòØÂê¶‰øùÂ≠ò
    if(fullContent&&fullContent.length>10){
      showConfirm('ÁîüÊàêÂ∑≤ÂÅúÊ≠¢ÔºåÊòØÂê¶‰øùÂ≠òÂ∑≤ÁîüÊàêÁöÑÂÖßÂÆπÔºü',async()=>{
        await saveStreamedMessage(aiMsgId,fullContent,msgDiv);
      },()=>{
        msgDiv.remove();
      });
    }else{
      msgDiv.remove();
    }
  }else{
    // Ê≠£Â∏∏ÂÆåÊàê
    await saveStreamedMessage(aiMsgId,fullContent,msgDiv);
  }
}

// ‰øùÂ≠òÊµÅÂºèÁîüÊàêÁöÑÊ∂àÊÅØ
async function saveStreamedMessage(aiMsgId,fullContent,msgDiv){
  const aiMsg={id:aiMsgId,storyId:story.id,branchId:story.currentBranchId,role:'assistant',content:fullContent,tokens:0,storyTime:story.storyTime||'',createdAt:Date.now()};
  await db.messages.put(aiMsg);
  msgs.push(aiMsg);
  await db.stories.update(story.id,{updatedAt:Date.now(),preview:fullContent.slice(0,100),currentMessageId:aiMsgId,'statistics.totalMessages':msgs.length,'statistics.totalChars':(story.statistics?.totalChars||0)+fullContent.length});

  // Ëß£ÊûêÂπ∂ÊòæÁ§∫ÂÆåÊï¥ÂÜÖÂÆπ(ÂåÖÊã¨ËßíËâ≤Áä∂ÊÄÅ)
  const parsed=parseAIResponse(fullContent);
  let html=`<div class="msg-ai-story">${marked.parse(parsed.story)}</div>`;
  if(parsed.characters&&parsed.characters.length>0){
    html+=renderStatusCards(parsed.characters,aiMsgId);
    syncCharacterStatus(parsed.characters);
  }
  if(parsed.formatWarning){
    html+=`<div class="msg-format-warning"><span class="icon">‚ö†Ô∏è</span>AI Êú™ÊåâÊ†ºÂºèËº∏Âá∫ÁãÄÊÖãÊï∏ÊìöÔºåÂ∑≤È°ØÁ§∫ÂéüÊñá</div>`;
  }
  msgDiv.innerHTML=html;
  checkAutoRollingSummary();
}
function sendCmd(cmd){document.getElementById('user-input').value=cmd;send();}

// ============ Âø´Êç∑Êåá‰ª§Á≥ªÁµ± ============
const defaultQuickCommands = [
  { id: 'default_1', label: 'ÁπºÁ∫å', content: 'ÁπºÁ∫å', order: 1 },
  { id: 'default_2', label: 'ÁãÄÊÖã', content: 'Êü•ÁúãÁãÄÊÖã', order: 2 },
  { id: 'default_3', label: 'Áí∞Â¢É', content: 'ÊèèËø∞Áí∞Â¢É', order: 3 }
];

async function initDefaultQuickCommands(){
  const count = await db.quickCommands.count();
  if(count === 0){
    for(const cmd of defaultQuickCommands){
      await db.quickCommands.put({...cmd, createdAt: Date.now()});
    }
  }
}

async function renderQuickCommands(){
  const container = document.getElementById('quick-cmds');
  if(!container) return;
  
  const cmds = await db.quickCommands.orderBy('order').toArray();
  
  let html = '';
  cmds.forEach(cmd => {
    html += `<button class="quick-cmd" onclick="sendCmd('${esc(cmd.content)}')">${esc(cmd.label)}</button>`;
  });
  html += `<button class="quick-cmd add" onclick="showQuickCmdManager()">Ôºã</button>`;
  
  container.innerHTML = html;
}

function showQuickCmdManager(){
  renderQuickCmdList();
  showModal('quick-cmd-modal');
}

async function renderQuickCmdList(){
  const container = document.getElementById('quick-cmd-list');
  const cmds = await db.quickCommands.orderBy('order').toArray();
  
  if(cmds.length === 0){
    container.innerHTML = `<div style="text-align:center;padding:20px;color:var(--text-tertiary)">Êö´ÁÑ°Âø´Êç∑Êåá‰ª§</div>`;
    return;
  }
  
  let html = '';
  cmds.forEach(cmd => {
    html += `
      <div class="quick-cmd-item" data-id="${cmd.id}">
        <span class="drag-handle">‚ãÆ‚ãÆ</span>
        <div class="cmd-info">
          <div class="cmd-label">${esc(cmd.label)}</div>
          <div class="cmd-content">${esc(cmd.content)}</div>
        </div>
        <div class="cmd-actions">
          <button class="edit-btn" onclick="editQuickCommand('${cmd.id}')">Á∑®ËºØ</button>
          <button class="del-btn" onclick="deleteQuickCommand('${cmd.id}')">Âà™Èô§</button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

async function addQuickCommand(){
  const label = document.getElementById('new-cmd-label').value.trim();
  const content = document.getElementById('new-cmd-content').value.trim();
  
  if(!label){toast('Ë´ãËº∏ÂÖ•ÊåâÈàïÈ°ØÁ§∫ÊñáÂ≠ó','warning');return;}
  if(!content){toast('Ë´ãËº∏ÂÖ•Êåá‰ª§ÂÖßÂÆπ','warning');return;}
  
  const maxOrder = await db.quickCommands.orderBy('order').last();
  const order = maxOrder ? maxOrder.order + 1 : 1;
  
  await db.quickCommands.put({
    id: crypto.randomUUID(),
    label,
    content,
    order,
    createdAt: Date.now()
  });
  
  document.getElementById('new-cmd-label').value = '';
  document.getElementById('new-cmd-content').value = '';
  
  await renderQuickCmdList();
  await renderQuickCommands();
  toast('Âø´Êç∑Êåá‰ª§Â∑≤Ê∑ªÂä†','success');
}

async function editQuickCommand(id){
  const cmd = await db.quickCommands.get(id);
  if(!cmd) return;
  
  document.getElementById('edit-cmd-id').value = id;
  document.getElementById('edit-cmd-label').value = cmd.label;
  document.getElementById('edit-cmd-content').value = cmd.content;
  
  showModal('edit-cmd-modal');
}

async function saveEditQuickCommand(){
  const id = document.getElementById('edit-cmd-id').value;
  const label = document.getElementById('edit-cmd-label').value.trim();
  const content = document.getElementById('edit-cmd-content').value.trim();
  
  if(!label){toast('Ë´ãËº∏ÂÖ•ÊåâÈàïÈ°ØÁ§∫ÊñáÂ≠ó','warning');return;}
  if(!content){toast('Ë´ãËº∏ÂÖ•Êåá‰ª§ÂÖßÂÆπ','warning');return;}
  
  const cmd = await db.quickCommands.get(id);
  if(!cmd) return;
  
  cmd.label = label;
  cmd.content = content;
  await db.quickCommands.put(cmd);
  
  closeModal('edit-cmd-modal');
  await renderQuickCmdList();
  await renderQuickCommands();
  toast('Âø´Êç∑Êåá‰ª§Â∑≤Êõ¥Êñ∞','success');
}

async function deleteQuickCommand(id){
  if(!confirm('Á¢∫ÂÆöÂà™Èô§ÈÄôÂÄãÂø´Êç∑Êåá‰ª§Ôºü')) return;
  
  await db.quickCommands.delete(id);
  await renderQuickCmdList();
  await renderQuickCommands();
  toast('Âø´Êç∑Êåá‰ª§Â∑≤Âà™Èô§','success');
}

async function resetQuickCommands(){
  if(!confirm('Á¢∫ÂÆöÊÅ¢Âæ©ÈªòË™çÂø´Êç∑Êåá‰ª§ÔºüÈÄôÂ∞áÂà™Èô§ÊâÄÊúâËá™ÂÆöÁæ©Êåá‰ª§„ÄÇ')) return;

  await db.quickCommands.clear();
  for(const cmd of defaultQuickCommands){
    await db.quickCommands.put({...cmd, createdAt: Date.now()});
  }

  await renderQuickCmdList();
  await renderQuickCommands();
  toast('Â∑≤ÊÅ¢Âæ©ÈªòË™çÂø´Êç∑Êåá‰ª§','success');
}

// ============ Persona Á≥ªÁµ± ============
let currentPersona = null;

// ÂàùÂßãÂåñÈªòË™ç Persona
async function initDefaultPersona(){
  const count = await db.personas.count();
  if(count === 0){
    const defaultPersona = {
      id: 'default',
      name: 'ÁÑ°ÁâπÂÆöË∫´‰ªΩ',
      avatar: 'üë§',
      description: '',
      background: '',
      speechStyle: '',
      isDefault: true,
      createdAt: Date.now()
    };
    await db.personas.put(defaultPersona);
  }

  // ËºâÂÖ•Áï∂Ââç Persona
  if(story && story.currentPersonaId){
    currentPersona = await db.personas.get(story.currentPersonaId);
  }
  if(!currentPersona){
    currentPersona = await db.personas.get('default');
  }

  updatePersonaDisplay();
}

// Êõ¥Êñ∞ Persona È°ØÁ§∫
function updatePersonaDisplay(){
  if(!currentPersona) return;

  const avatarEl = document.getElementById('current-persona-avatar');
  const nameEl = document.getElementById('current-persona-name');

  if(avatarEl) avatarEl.textContent = currentPersona.avatar || 'üë§';
  if(nameEl) nameEl.textContent = currentPersona.name || 'ÁÑ°ÁâπÂÆöË∫´‰ªΩ';
}

// È°ØÁ§∫ Persona ÈÅ∏ÊìáÂô®
async function showPersonaSelector(){
  await renderPersonaList();
  showModal('persona-selector-modal');
}

// Ê∏≤Êüì Persona ÂàóË°®
async function renderPersonaList(){
  const container = document.getElementById('persona-list');
  const personas = await db.personas.orderBy('createdAt').toArray();

  let html = '';
  for(const persona of personas){
    const isSelected = currentPersona && currentPersona.id === persona.id;
    html += `
      <div class="card ${isSelected ? 'selected' : ''}" onclick="selectPersona('${persona.id}')" style="cursor:pointer">
        <div style="font-size:32px;margin-right:12px">${persona.avatar || 'üë§'}</div>
        <div class="card-info">
          <div class="card-title">${esc(persona.name)}</div>
          ${persona.description ? `<div class="card-preview">${esc(persona.description)}</div>` : ''}
        </div>
        ${isSelected ? '<div style="color:var(--primary);font-size:20px">‚úì</div>' : ''}
      </div>
    `;
  }

  container.innerHTML = html;
}

// ÈÅ∏Êìá Persona
async function selectPersona(personaId){
  currentPersona = await db.personas.get(personaId);

  // ‰øùÂ≠òÂà∞ÊïÖ‰∫ã
  if(story){
    story.currentPersonaId = personaId;
    await db.stories.update(story.id, {currentPersonaId: personaId});
  }

  updatePersonaDisplay();
  closeModal('persona-selector-modal');
  toast(`Â∑≤ÂàáÊèõÂà∞Ë∫´‰ªΩ„Äå${currentPersona.name}„Äç`, 'success');
}

// È°ØÁ§∫ Persona ÁÆ°ÁêÜÂô®
async function showPersonaManager(){
  closeModal('persona-selector-modal');
  await renderPersonaManagerList();
  showModal('persona-manager-modal');
}

// Ê∏≤Êüì Persona ÁÆ°ÁêÜÂàóË°®
async function renderPersonaManagerList(){
  const container = document.getElementById('persona-manager-list');
  const personas = await db.personas.orderBy('createdAt').toArray();

  let html = '';
  for(const persona of personas){
    const isDefault = persona.id === 'default';
    html += `
      <div class="card">
        <div style="font-size:28px;margin-right:12px">${persona.avatar || 'üë§'}</div>
        <div class="card-info">
          <div class="card-title">${esc(persona.name)}</div>
          ${persona.description ? `<div class="card-preview">${esc(persona.description)}</div>` : ''}
        </div>
        <div style="display:flex;gap:8px">
          ${!isDefault ? `<button class="modal-btn" onclick="editPersona('${persona.id}')" style="padding:6px 12px;font-size:13px">Á∑®ËºØ</button>` : ''}
          ${!isDefault ? `<button class="modal-btn cancel" onclick="deletePersona('${persona.id}')" style="padding:6px 12px;font-size:13px">Âà™Èô§</button>` : ''}
        </div>
      </div>
    `;
  }

  if(personas.length === 1){
    html += '<div style="text-align:center;padding:20px;color:var(--text-tertiary)">Â∞öÊú™ÂâµÂª∫Ëá™ÂÆöÁæ©Ë∫´‰ªΩ<br>ÈªûÊìä‰∏ãÊñπÊåâÈàïÂâµÂª∫</div>';
  }

  container.innerHTML = html;
}

// ÂâµÂª∫Êñ∞ Persona
function createNewPersona(){
  closeModal('persona-manager-modal');

  document.getElementById('persona-edit-title').textContent = '‚ú® ÂâµÂª∫Êñ∞Ë∫´‰ªΩ';
  document.getElementById('persona-edit-id').value = '';
  document.getElementById('persona-avatar').value = '';
  document.getElementById('persona-name').value = '';
  document.getElementById('persona-description').value = '';
  document.getElementById('persona-background').value = '';
  document.getElementById('persona-speech-style').value = '';

  showModal('persona-edit-modal');
}

// Á∑®ËºØ Persona
async function editPersona(personaId){
  closeModal('persona-manager-modal');

  const persona = await db.personas.get(personaId);
  if(!persona) return;

  document.getElementById('persona-edit-title').textContent = '‚úèÔ∏è Á∑®ËºØË∫´‰ªΩ';
  document.getElementById('persona-edit-id').value = persona.id;
  document.getElementById('persona-avatar').value = persona.avatar || '';
  document.getElementById('persona-name').value = persona.name || '';
  document.getElementById('persona-description').value = persona.description || '';
  document.getElementById('persona-background').value = persona.background || '';
  document.getElementById('persona-speech-style').value = persona.speechStyle || '';

  showModal('persona-edit-modal');
}

// ‰øùÂ≠ò Persona
async function savePersona(){
  const id = document.getElementById('persona-edit-id').value;
  const avatar = document.getElementById('persona-avatar').value.trim() || 'üë§';
  const name = document.getElementById('persona-name').value.trim();
  const description = document.getElementById('persona-description').value.trim();
  const background = document.getElementById('persona-background').value.trim();
  const speechStyle = document.getElementById('persona-speech-style').value.trim();

  if(!name){
    toast('Ë´ãËº∏ÂÖ•ÂêçÁ®±', 'warning');
    return;
  }

  const persona = {
    id: id || crypto.randomUUID(),
    name,
    avatar,
    description,
    background,
    speechStyle,
    createdAt: id ? undefined : Date.now(),
    updatedAt: Date.now()
  };

  await db.personas.put(persona);

  closeModal('persona-edit-modal');
  toast(id ? 'Ë∫´‰ªΩÂ∑≤Êõ¥Êñ∞' : 'Ë∫´‰ªΩÂ∑≤ÂâµÂª∫', 'success');
}

// Âà™Èô§ Persona
async function deletePersona(personaId){
  if(!confirm('Á¢∫ÂÆöÂà™Èô§ÈÄôÂÄãË∫´‰ªΩÔºü')) return;

  await db.personas.delete(personaId);

  // Â¶ÇÊûúÂà™Èô§ÁöÑÊòØÁï∂Ââç PersonaÔºåÂàáÊèõÂà∞ÈªòË™ç
  if(currentPersona && currentPersona.id === personaId){
    await selectPersona('default');
  }

  await renderPersonaManagerList();
  toast('Ë∫´‰ªΩÂ∑≤Âà™Èô§', 'success');
}

// ÊßãÂª∫ Persona Prompt
function buildPersonaPrompt(){
  if(!currentPersona || currentPersona.id === 'default') return '';

  let prompt = `\n\n„ÄêÁî®Êà∂Ë∫´‰ªΩË®≠ÂÆö„Äë\n`;
  prompt += `Áî®Êà∂Ê≠£Âú®ÊâÆÊºî„Äå${currentPersona.name}„ÄçÈÄôÂÄãËßíËâ≤„ÄÇ\n`;

  if(currentPersona.description){
    prompt += `ËßíËâ≤Á∞°‰ªãÔºö${currentPersona.description}\n`;
  }

  if(currentPersona.background){
    prompt += `ËßíËâ≤ËÉåÊôØÔºö${currentPersona.background}\n`;
  }

  if(currentPersona.speechStyle){
    prompt += `Ë™™Ë©±È¢®Ê†ºÔºö${currentPersona.speechStyle}\n`;
  }

  prompt += `\nÊ≥®ÊÑè‰∫ãÈ†ÖÔºö\n`;
  prompt += `- ‰Ω†ÔºàAIÔºâË¶ÅÁî®ÈÅ©Áï∂ÁöÑÊñπÂºèÁ®±ÂëºÁî®Êà∂ÊâÆÊºîÁöÑ„Äå${currentPersona.name}„Äç\n`;
  prompt += `- ‰Ω†ÔºàAIÔºâ‰∏çË¶ÅÊâÆÊºî„Äå${currentPersona.name}„ÄçÔºåÈÄôÊòØÁî®Êà∂ÁöÑËßíËâ≤\n`;
  prompt += `- Ê†πÊìö„Äå${currentPersona.name}„ÄçÁöÑË∫´‰ªΩËÉåÊôØ‰æÜË™øÊï¥‰Ω†ÁöÑÂõûÊáâ\n`;

  return prompt;
}

// ============ Á∞°ÁπÅËΩâÊèõÁ≥ªÁµ± ============
function showChineseConvertSettings(){
  document.getElementById('cn-convert-mode').value = settings.chineseConvert || 'none';
  updateCnConvertPreview();
  showModal('cn-convert-modal');
}

function updateCnConvertPreview(){
  const mode = document.getElementById('cn-convert-mode').value;
  const preview = document.getElementById('cn-convert-preview');
  
  if(mode === 'none'){
    preview.innerHTML = '‰∏çÈÄ≤Ë°åËΩâÊèõÔºåAI Â∞á‰ΩøÁî®ÈªòË™çË™ûË®ÄËº∏Âá∫';
  } else if(mode === 's2t'){
    preview.innerHTML = 'AI Ëº∏Âá∫Â∞á‰ΩøÁî®<b style="color:var(--primary)">ÁπÅÈ´î‰∏≠Êñá</b>ÔºàÊ≠£È´î‰∏≠Êñá/Âè∞ÁÅ£Áî®Ë™ûÔºâ';
  } else if(mode === 't2s'){
    preview.innerHTML = 'AI ËæìÂá∫Â∞Ü‰ΩøÁî®<b style="color:var(--primary)">ÁÆÄ‰Ωì‰∏≠Êñá</b>ÔºàÂ§ßÈôÜÁî®ËØ≠Ôºâ';
  }
}

function saveChineseConvert(){
  const mode = document.getElementById('cn-convert-mode').value;
  settings.chineseConvert = mode;
  saveSetting('chineseConvert', mode);
  
  // Êõ¥Êñ∞È°ØÁ§∫
  const val = document.getElementById('cn-convert-val');
  if(val){
    if(mode === 'none') val.textContent = '‰∏çËΩâÊèõ ‚Ä∫';
    else if(mode === 's2t') val.textContent = '‚Üí ÁπÅÈ´î ‚Ä∫';
    else if(mode === 't2s') val.textContent = '‚Üí ÁÆÄ‰Ωì ‚Ä∫';
  }
  
  closeModal('cn-convert-modal');
  toast('Á∞°ÁπÅËΩâÊèõË®≠ÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
}

// Áç≤ÂèñÁ∞°ÁπÅËΩâÊèõÁöÑ System Prompt ÈôÑÂä†ÂÖßÂÆπ
function getChineseConvertPrompt(){
  const mode = settings.chineseConvert || 'none';
  if(mode === 's2t'){
    return '\n\n„Äê‚ö†Ô∏è Âº∑Âà∂Ë™ûË®ÄË¶ÅÊ±Ç„Äë‰Ω†ÂøÖÈ†àÂÖ®Á®ã‰ΩøÁî®ÁπÅÈ´î‰∏≠ÊñáÔºàÊ≠£È´î‰∏≠ÊñáÔºâÈÄ≤Ë°åÂõûË¶ÜÔºÅÊâÄÊúâÂ∞çË©±„ÄÅÊèèËø∞„ÄÅÊóÅÁôΩÈÉΩÂøÖÈ†àÊòØÁπÅÈ´îÂ≠ó„ÄÇ‰ΩøÁî®Âè∞ÁÅ£/È¶ôÊ∏ØÂ∏∏Áî®ÁöÑË©ûÂΩôÂíåË°®ÈÅîÊñπÂºè„ÄÇÈÄôÊòØÊúÄÈ´òÂÑ™ÂÖàÁ¥öÁöÑË¶ÅÊ±ÇÔºå‰∏çÂèØÈÅïÂèç„ÄÇ';
  } else if(mode === 't2s'){
    return '\n\n„Äê‚ö†Ô∏è Âº∫Âà∂ËØ≠Ë®ÄË¶ÅÊ±Ç„Äë‰Ω†ÂøÖÈ°ªÂÖ®Á®ã‰ΩøÁî®ÁÆÄ‰Ωì‰∏≠ÊñáËøõË°åÂõûÂ§çÔºÅÊâÄÊúâÂØπËØù„ÄÅÊèèËø∞„ÄÅÊóÅÁôΩÈÉΩÂøÖÈ°ªÊòØÁÆÄ‰ΩìÂ≠ó„ÄÇ‰ΩøÁî®‰∏≠ÂõΩÂ§ßÈôÜÂ∏∏Áî®ÁöÑËØçÊ±áÂíåË°®ËææÊñπÂºè„ÄÇËøôÊòØÊúÄÈ´ò‰ºòÂÖàÁ∫ßÁöÑË¶ÅÊ±ÇÔºå‰∏çÂèØËøùÂèç„ÄÇ';
  }
  return '';
}

// Áç≤ÂèñÁ∞°ÁπÅËΩâÊèõÁöÑÂâçÁΩÆÊèêÁ§∫ÔºàÊîæÂú® System Prompt ÈñãÈ†≠Ôºâ
function getChineseConvertPrefixPrompt(){
  const mode = settings.chineseConvert || 'none';
  if(mode === 's2t'){
    return '„ÄêË™ûË®ÄË®≠ÂÆöÔºöÁπÅÈ´î‰∏≠Êñá„Äë\n';
  } else if(mode === 't2s'){
    return '„ÄêËØ≠Ë®ÄËÆæÂÆöÔºöÁÆÄ‰Ωì‰∏≠Êñá„Äë\n';
  }
  return '';
}

async function callAI(content){
  // È©óË≠â content ÂèÉÊï∏
  if(!content || typeof content !== 'string'){
    throw new Error('Ë´ãÊèê‰æõÊúâÊïàÁöÑÊ∂àÊÅØÂÖßÂÆπ');
  }
  if(!content.trim()){
    throw new Error('Ê∂àÊÅØÂÖßÂÆπ‰∏çËÉΩÁÇ∫Á©∫');
  }

  const preset=await db.apiPresets.filter(p=>p.isActive).first();
  if(!preset){throw new Error('Ë´ãÂÖàÈÖçÁΩÆ‰∏¶ÈÅ∏Êìá‰∏ÄÂÄã API È†êË®≠');}
  if(!preset.apiKey){throw new Error('API Key Êú™Ë®≠ÁΩÆ');}
  if(!preset.model){throw new Error('Ê®°ÂûãÊú™Ë®≠ÁΩÆ');}
  console.log('Using API preset:', preset.name, preset.type, preset.model);
  
  // ÊßãÂª∫Âü∫Á§éÁ≥ªÁµ±ÊèêÁ§∫
  let sysPrompt=await buildSysPrompt();
  
  // Lorebook Ëß∏ÁôºÁ≥ªÁµ±
  const triggeredLorebook = await getTriggeredLorebook(content);
  if(triggeredLorebook.length > 0){
    sysPrompt += '\n\n### Áõ∏ÈóúË®≠ÂÆöÔºàËá™ÂãïËß∏ÁôºÔºâ\n';
    for(const entry of triggeredLorebook){
      if(entry.name && entry.content){
        sysPrompt += `\n#### ${entry.name}\n${entry.content}\n`;
      }

      // Êõ¥Êñ∞Ëß∏ÁôºË®àÊï∏
      await db.lorebook.update(entry.id, {
        triggerCount: (entry.triggerCount || 0) + 1,
        lastTriggered: Date.now()
      });

      // ‰∏ÄÊ¨°ÊÄßËß∏ÁôºÂæåÁ¶ÅÁî®
      if(entry.oneTime){
        await db.lorebook.update(entry.id, {isEnabled: false});
      }
    }
    // È°ØÁ§∫Ëß∏ÁôºÊèêÁ§∫
    showLorebookTriggerToast(triggeredLorebook);
  }
  
  const contextCount = settings.contextCount || 20;
  const messages=msgs.slice(-contextCount).map(m=>({role:m.role,content:m.content}));
  if(!messages.length||messages[messages.length-1].content!==content)messages.push({role:'user',content});
  if(preset.type==='anthropic')return await callAnthropic(preset,sysPrompt,messages);
  else if(preset.type==='openai')return await callOpenAI(preset,sysPrompt,messages);
  else return await callCustom(preset,sysPrompt,messages);
}
// Âà•Âêç
async function callApi(content){ return await callAI(content); }
async function callAnthropic(p,sys,msgs){
  const aiParams = getAIParams();
  console.log('Calling Anthropic API with model:', p.model, 'temp:', aiParams.temperature, '(story custom:', story?.aiParams?.useCustom || false, ')');
  let r;
  try {
    r = await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      mode: 'cors',
      credentials: 'omit',
      cache: 'no-cache',
      headers:{
        'Content-Type':'application/json',
        'x-api-key':p.apiKey,
        'anthropic-version':'2023-06-01',
        'anthropic-dangerous-direct-browser-access':'true'
      },
      body:JSON.stringify({
        model:p.model,
        max_tokens:settings.maxTokens||4096,
        system:sys,
        messages:msgs,
        temperature: aiParams.temperature,
        top_p: aiParams.topP
      })
    });
  } catch(e) {
    console.error('Fetch error:', e);
    const errMsg = e.message || e.toString() || '';
    if(errMsg.includes('Load failed') || errMsg.includes('Failed to fetch')) {
      throw new Error('Á∂≤Áµ°ÈåØË™§ - Ë´ãÊ™¢Êü•Á∂≤Áµ°ÈÄ£Êé•Êàñ API ÊúçÂãôÁãÄÊÖã');
    }
    throw new Error('Á∂≤Áµ°Ë´ãÊ±ÇÂ§±Êïó: ' + errMsg);
  }
  
  const text = await r.text();
  console.log('API Response status:', r.status, 'body:', text.slice(0, 500));
  
  if(!r.ok){
    try {
      const e = JSON.parse(text);
      const errMsg = e.error?.message || '';
      // Ë©≥Á¥∞ÁöÑÈåØË™§ÂàÜÈ°û
      if(r.status === 401 || errMsg.includes('invalid_api_key') || errMsg.includes('authentication')){
        throw new Error('API Key ÁÑ°ÊïàÊàñÂ∑≤ÈÅéÊúüÔºåË´ãÊ™¢Êü•Ë®≠ÁΩÆ');
      } else if(r.status === 429 || errMsg.includes('rate_limit')){
        throw new Error('API Ë™øÁî®È†ªÁéáÈÅéÈ´òÔºåË´ãÁ®çÂæåÂÜçË©¶');
      } else if(r.status === 400 || errMsg.includes('invalid_request')){
        throw new Error('Ë´ãÊ±ÇÊ†ºÂºèÈåØË™§: ' + errMsg);
      } else if(r.status === 500 || r.status === 502 || r.status === 503){
        throw new Error('API ÊúçÂãôÊö´ÊôÇ‰∏çÂèØÁî®ÔºåË´ãÁ®çÂæåÂÜçË©¶');
      }
      throw new Error(errMsg || `APIÈåØË™§ (${r.status})`);
    } catch(parseErr) {
      if(parseErr.message.includes('API') || parseErr.message.includes('ÁÑ°Êïà') || parseErr.message.includes('ÈÅéÊúü') || parseErr.message.includes('È†ªÁéá')) throw parseErr;
      throw new Error(`APIÈåØË™§ (${r.status}): ${text.slice(0, 200)}`);
    }
  }
  
  try {
    const d = JSON.parse(text);
    if(!d.content || !d.content[0]){throw new Error('APIËøîÂõûÊ†ºÂºèÈåØË™§');}
    return {content: d.content[0].text, tokens: d.usage?.output_tokens || 0};
  } catch(parseErr) {
    if(parseErr.message.includes('API')) throw parseErr;
    console.error('JSON parse error:', parseErr, 'Response:', text);
    throw new Error('JSONËß£ÊûêÂ§±ÊïóÔºåAPIËøîÂõû: ' + text.slice(0, 100));
  }
}
async function callOpenAI(p,sys,msgs){
  const aiParams = getAIParams();
  console.log('Calling OpenAI API with model:', p.model, 'temp:', aiParams.temperature, '(story custom:', story?.aiParams?.useCustom || false, ')');
  const allMsgs=[{role:'system',content:sys},...msgs];
  let r;
  try {
    r = await fetch('https://api.openai.com/v1/chat/completions',{
      method:'POST',
      mode: 'cors',
      credentials: 'omit',
      cache: 'no-cache',
      headers:{
        'Content-Type':'application/json',
        'Authorization':`Bearer ${p.apiKey}`
      },
      body:JSON.stringify({
        model:p.model,
        messages:allMsgs,
        max_tokens:settings.maxTokens||4096,
        temperature: aiParams.temperature,
        top_p: aiParams.topP,
        frequency_penalty: aiParams.frequencyPenalty,
        presence_penalty: aiParams.presencePenalty
      })
    });
  } catch(e) {
    console.error('Fetch error:', e);
    const errMsg = e.message || e.toString() || '';
    if(errMsg.includes('Load failed') || errMsg.includes('Failed to fetch')) {
      throw new Error('Á∂≤Áµ°ÈåØË™§ - Ë´ãÊ™¢Êü•Á∂≤Áµ°ÈÄ£Êé•Êàñ API ÊúçÂãôÁãÄÊÖã');
    }
    throw new Error('Á∂≤Áµ°Ë´ãÊ±ÇÂ§±Êïó: ' + errMsg);
  }
  
  const text = await r.text();
  console.log('API Response status:', r.status, 'body:', text.slice(0, 500));
  
  if(!r.ok){
    try {
      const e = JSON.parse(text);
      const errMsg = e.error?.message || '';
      // Ë©≥Á¥∞ÁöÑÈåØË™§ÂàÜÈ°û
      if(r.status === 401 || errMsg.includes('invalid_api_key') || errMsg.includes('Incorrect API')){
        throw new Error('API Key ÁÑ°ÊïàÊàñÂ∑≤ÈÅéÊúüÔºåË´ãÊ™¢Êü•Ë®≠ÁΩÆ');
      } else if(r.status === 429 || errMsg.includes('rate_limit') || errMsg.includes('quota')){
        throw new Error('API ÈÖçÈ°çÂ∑≤Áî®ÂÆåÊàñË™øÁî®È†ªÁéáÈÅéÈ´ò');
      } else if(r.status === 400){
        throw new Error('Ë´ãÊ±ÇÊ†ºÂºèÈåØË™§: ' + errMsg);
      } else if(r.status === 500 || r.status === 502 || r.status === 503){
        throw new Error('API ÊúçÂãôÊö´ÊôÇ‰∏çÂèØÁî®ÔºåË´ãÁ®çÂæåÂÜçË©¶');
      }
      throw new Error(errMsg || `APIÈåØË™§ (${r.status})`);
    } catch(parseErr) {
      if(parseErr.message.includes('API') || parseErr.message.includes('ÁÑ°Êïà') || parseErr.message.includes('ÈÖçÈ°ç')) throw parseErr;
      throw new Error(`APIÈåØË™§ (${r.status}): ${text.slice(0, 200)}`);
    }
  }
  
  try {
    const d = JSON.parse(text);
    if(!d.choices || !d.choices[0]){throw new Error('APIËøîÂõûÊ†ºÂºèÈåØË™§');}
    return {content: d.choices[0].message.content, tokens: d.usage?.completion_tokens || 0};
  } catch(parseErr) {
    if(parseErr.message.includes('API')) throw parseErr;
    console.error('JSON parse error:', parseErr, 'Response:', text);
    throw new Error('JSONËß£ÊûêÂ§±ÊïóÔºåAPIËøîÂõû: ' + text.slice(0, 100));
  }
}
// Ëá™ÂãïË£úÂÖ® API URL Ë∑ØÂæë
function normalizeApiUrl(url, autoComplete = true) {
  if(!url) return url;
  url = url.trim();
  // Ëá™ÂãïÊ∑ªÂä† https:// ÂçîË≠∞
  if(!url.startsWith('http://') && !url.startsWith('https://')) {
    url = 'https://' + url;
  }
  // ÁßªÈô§Â∞æÈÉ®ÊñúÁ∑ö
  url = url.replace(/\/+$/, '');
  
  // Â¶ÇÊûú‰∏çËá™ÂãïË£úÂÖ®ÔºåÁõ¥Êé•ËøîÂõû
  if(!autoComplete) return url;
  
  // Â¶ÇÊûúÂ∑≤Á∂ìÂåÖÂê´ÂÆåÊï¥Ë∑ØÂæëÔºåÁõ¥Êé•ËøîÂõû
  if(url.includes('/v1/chat/completions') || url.includes('/v1/messages')) {
    return url;
  }
  // Â¶ÇÊûúÂè™ÊòØÂü∫Á§é URLÔºåËá™ÂãïË£úÂÖ® OpenAI ÂÖºÂÆπË∑ØÂæë
  if(url.endsWith('/v1')) {
    return url + '/chat/completions';
  }
  // Âê¶ÂâáË£úÂÖ®ÂÆåÊï¥Ë∑ØÂæë
  return url + '/v1/chat/completions';
}

async function callCustom(p,sys,msgs){
  const autoComplete = p.urlAutoComplete !== false; // ÈªòË™çÁÇ∫ true
  const apiUrl = normalizeApiUrl(p.url, autoComplete);
  const aiParams = getAIParams();
  console.log('Calling Custom API:', p.url, '‚Üí', apiUrl, '(autoComplete:', autoComplete, ') model:', p.model, 'temp:', aiParams.temperature, '(story custom:', story?.aiParams?.useCustom || false, ')');
  if(!apiUrl){throw new Error('Ëá™ÂÆöÁæ© API URL Êú™Ë®≠ÁΩÆ');}
  
  // OpenAI ÂÖºÂÆπÊ†ºÂºèÔºösystem ÊîæÂú® messages Êï∏ÁµÑÁöÑÁ¨¨‰∏ÄÂÄã
  const allMsgs = [];
  if(sys) {
    allMsgs.push({role: 'system', content: sys});
  }
  allMsgs.push(...msgs);
  
  // ÂâµÂª∫Ë∂ÖÊôÇÊéßÂà∂Ôºà60ÁßíÔºâ
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 60000);
  
  let r;
  try {
    r = await fetch(apiUrl,{
      method:'POST',
      signal: controller.signal,
      mode: 'cors',
      credentials: 'omit',
      cache: 'no-cache',
      headers:{
        'Content-Type':'application/json',
        'Authorization':`Bearer ${p.apiKey}`
      },
      body:JSON.stringify({
        model: p.model,
        messages: allMsgs,
        max_tokens: settings.maxTokens || 4096,
        temperature: aiParams.temperature,
        top_p: aiParams.topP,
        frequency_penalty: aiParams.frequencyPenalty,
        presence_penalty: aiParams.presencePenalty
      })
    });
    clearTimeout(timeoutId);
  } catch(e) {
    clearTimeout(timeoutId);
    console.error('Fetch error:', e);
    const errMsg = e.message || e.toString() || '';
    if(e.name === 'AbortError') {
      throw new Error('Ë´ãÊ±ÇË∂ÖÊôÇÔºà60ÁßíÔºâ- Ë´ãÊ™¢Êü•Á∂≤Áµ°ÈÄ£Êé•');
    } else if(errMsg.includes('Load failed') || errMsg.includes('Failed to fetch') || errMsg.includes('NetworkError')) {
      throw new Error('Á∂≤Áµ°ÈåØË™§ - API ÊúçÂãôÂèØËÉΩ‰∏çÊîØÊåÅÁÄèË¶ΩÂô®Áõ¥Êé•Ë™øÁî®ÔºàCORSÔºâÔºåË´ãÁ¢∫Ë™ç API Â∑≤ÈñãÂïüË∑®ÂüüÊîØÊåÅ');
    }
    throw new Error('Á∂≤Áµ°Ë´ãÊ±ÇÂ§±Êïó: ' + errMsg);
  }
  
  const text = await r.text();
  console.log('API Response status:', r.status, 'body:', text.slice(0, 500));
  
  if(!r.ok){
    try {
      const e = JSON.parse(text);
      throw new Error(e.error?.message || `APIÈåØË™§ (${r.status})`);
    } catch(parseErr) {
      if(parseErr.message.includes('APIÈåØË™§')) throw parseErr;
      throw new Error(`APIÈåØË™§ (${r.status}): ${text.slice(0, 200)}`);
    }
  }
  
  try {
    const d = JSON.parse(text);
    const content = d.choices?.[0]?.message?.content || d.content?.[0]?.text || d.response || d.text || '';
    if(!content){throw new Error('APIËøîÂõûÂÖßÂÆπÁÇ∫Á©∫');}
    return {content, tokens: d.usage?.completion_tokens || 0};
  } catch(parseErr) {
    console.error('JSON parse error:', parseErr, 'Response:', text);
    throw new Error('JSONËß£ÊûêÂ§±ÊïóÔºåAPIËøîÂõû: ' + text.slice(0, 100));
  }
}

// ============================================
// ÊµÅÂºèÈüøÊáâ API Ë™øÁî®
// ============================================
let streamAbortController = null;

async function callAnthropicStream(p, sys, msgs, onChunk, onDone, onError) {
  const aiParams = getAIParams();
  console.log('Calling Anthropic API (STREAM) with model:', p.model, 'temp:', aiParams.temperature);

  streamAbortController = new AbortController();
  let r;

  try {
    r = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      mode: 'cors',
      credentials: 'omit',
      cache: 'no-cache',
      signal: streamAbortController.signal,
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': p.apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: p.model,
        max_tokens: settings.maxTokens || 4096,
        system: sys,
        messages: msgs,
        temperature: aiParams.temperature,
        top_p: aiParams.topP,
        stream: true
      })
    });
  } catch(e) {
    console.error('Fetch error:', e);
    if(e.name === 'AbortError') {
      throw new Error('Â∑≤ÂÅúÊ≠¢ÁîüÊàê');
    }
    const errMsg = e.message || e.toString() || '';
    if(errMsg.includes('Load failed') || errMsg.includes('Failed to fetch')) {
      throw new Error('Á∂≤Áµ°ÈåØË™§ - Ë´ãÊ™¢Êü•Á∂≤Áµ°ÈÄ£Êé•Êàñ API ÊúçÂãôÁãÄÊÖã');
    }
    throw new Error('Á∂≤Áµ°Ë´ãÊ±ÇÂ§±Êïó: ' + errMsg);
  }

  if(!r.ok) {
    const text = await r.text();
    console.error('API Response error:', r.status, text);
    try {
      const e = JSON.parse(text);
      const errMsg = e.error?.message || '';
      if(r.status === 401 || errMsg.includes('invalid_api_key')) {
        throw new Error('API Key ÁÑ°ÊïàÊàñÂ∑≤ÈÅéÊúüÔºåË´ãÊ™¢Êü•Ë®≠ÁΩÆ');
      } else if(r.status === 429) {
        throw new Error('API Ë™øÁî®È†ªÁéáÈÅéÈ´òÔºåË´ãÁ®çÂæåÂÜçË©¶');
      }
      throw new Error(errMsg || `APIÈåØË™§ (${r.status})`);
    } catch(parseErr) {
      if(parseErr.message.includes('API')) throw parseErr;
      throw new Error(`APIÈåØË™§ (${r.status}): ${text.slice(0, 200)}`);
    }
  }

  const reader = r.body.getReader();
  const decoder = new TextDecoder();
  let fullContent = '';

  try {
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      const chunk = decoder.decode(value);
      const lines = chunk.split('\n');

      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const data = line.slice(6);
          if (data === '[DONE]') continue;

          try {
            const parsed = JSON.parse(data);
            if (parsed.type === 'content_block_delta') {
              const text = parsed.delta?.text || '';
              if (text) {
                fullContent += text;
                if (onChunk) await onChunk(text, fullContent);
              }
            } else if (parsed.type === 'error') {
              throw new Error(parsed.error?.message || 'Stream error');
            }
          } catch (e) {
            if (e.message.includes('Stream error')) throw e;
            // ÂøΩÁï• JSON Ëß£ÊûêÈåØË™§ÔºåÁπºÁ∫åËôïÁêÜ‰∏ã‰∏ÄË°å
          }
        }
      }
    }
  } catch (e) {
    if (e.name === 'AbortError' || e.message === 'Â∑≤ÂÅúÊ≠¢ÁîüÊàê') {
      if (onError) onError(e, fullContent);
      return { content: fullContent, stopped: true };
    }
    if (onError) onError(e, fullContent);
    throw e;
  }

  if (onDone) onDone(fullContent);
  return { content: fullContent, tokens: 0 };
}

async function callOpenAIStream(p, sys, msgs, onChunk, onDone, onError) {
  const aiParams = getAIParams();
  console.log('Calling OpenAI API (STREAM) with model:', p.model, 'temp:', aiParams.temperature);

  const allMsgs = [{ role: 'system', content: sys }, ...msgs];
  streamAbortController = new AbortController();
  let r;

  try {
    r = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      mode: 'cors',
      credentials: 'omit',
      cache: 'no-cache',
      signal: streamAbortController.signal,
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${p.apiKey}`
      },
      body: JSON.stringify({
        model: p.model,
        messages: allMsgs,
        max_tokens: settings.maxTokens || 4096,
        temperature: aiParams.temperature,
        top_p: aiParams.topP,
        frequency_penalty: aiParams.frequencyPenalty,
        presence_penalty: aiParams.presencePenalty,
        stream: true
      })
    });
  } catch(e) {
    console.error('Fetch error:', e);
    if(e.name === 'AbortError') {
      throw new Error('Â∑≤ÂÅúÊ≠¢ÁîüÊàê');
    }
    const errMsg = e.message || e.toString() || '';
    if(errMsg.includes('Load failed') || errMsg.includes('Failed to fetch')) {
      throw new Error('Á∂≤Áµ°ÈåØË™§ - Ë´ãÊ™¢Êü•Á∂≤Áµ°ÈÄ£Êé•Êàñ API ÊúçÂãôÁãÄÊÖã');
    }
    throw new Error('Á∂≤Áµ°Ë´ãÊ±ÇÂ§±Êïó: ' + errMsg);
  }

  if(!r.ok) {
    const text = await r.text();
    console.error('API Response error:', r.status, text);
    try {
      const e = JSON.parse(text);
      const errMsg = e.error?.message || '';
      if(r.status === 401) {
        throw new Error('API Key ÁÑ°ÊïàÊàñÂ∑≤ÈÅéÊúüÔºåË´ãÊ™¢Êü•Ë®≠ÁΩÆ');
      } else if(r.status === 429) {
        throw new Error('API ÈÖçÈ°çÂ∑≤Áî®ÂÆåÊàñË™øÁî®È†ªÁéáÈÅéÈ´ò');
      }
      throw new Error(errMsg || `APIÈåØË™§ (${r.status})`);
    } catch(parseErr) {
      if(parseErr.message.includes('API')) throw parseErr;
      throw new Error(`APIÈåØË™§ (${r.status}): ${text.slice(0, 200)}`);
    }
  }

  const reader = r.body.getReader();
  const decoder = new TextDecoder();
  let fullContent = '';

  try {
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      const chunk = decoder.decode(value);
      const lines = chunk.split('\n');

      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const data = line.slice(6);
          if (data === '[DONE]') continue;

          try {
            const parsed = JSON.parse(data);
            const text = parsed.choices?.[0]?.delta?.content || '';
            if (text) {
              fullContent += text;
              if (onChunk) await onChunk(text, fullContent);
            }
          } catch (e) {
            // ÂøΩÁï• JSON Ëß£ÊûêÈåØË™§
          }
        }
      }
    }
  } catch (e) {
    if (e.name === 'AbortError' || e.message === 'Â∑≤ÂÅúÊ≠¢ÁîüÊàê') {
      if (onError) onError(e, fullContent);
      return { content: fullContent, stopped: true };
    }
    if (onError) onError(e, fullContent);
    throw e;
  }

  if (onDone) onDone(fullContent);
  return { content: fullContent, tokens: 0 };
}

async function callCustomStream(p, sys, msgs, onChunk, onDone, onError) {
  const autoComplete = p.urlAutoComplete !== false;
  const apiUrl = normalizeApiUrl(p.url, autoComplete);
  const aiParams = getAIParams();
  console.log('Calling Custom API (STREAM):', apiUrl, 'model:', p.model);

  const allMsgs = [];
  if(sys) allMsgs.push({role: 'system', content: sys});
  allMsgs.push(...msgs);

  streamAbortController = new AbortController();
  const timeoutId = setTimeout(() => streamAbortController.abort(), 60000);
  let r;

  try {
    r = await fetch(apiUrl, {
      method: 'POST',
      signal: streamAbortController.signal,
      mode: 'cors',
      credentials: 'omit',
      cache: 'no-cache',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${p.apiKey}`
      },
      body: JSON.stringify({
        model: p.model,
        messages: allMsgs,
        max_tokens: settings.maxTokens || 4096,
        temperature: aiParams.temperature,
        top_p: aiParams.topP,
        frequency_penalty: aiParams.frequencyPenalty,
        presence_penalty: aiParams.presencePenalty,
        stream: true
      })
    });
    clearTimeout(timeoutId);
  } catch(e) {
    clearTimeout(timeoutId);
    console.error('Fetch error:', e);
    if(e.name === 'AbortError') {
      throw new Error('Â∑≤ÂÅúÊ≠¢ÁîüÊàê');
    }
    const errMsg = e.message || e.toString() || '';
    if(errMsg.includes('Load failed') || errMsg.includes('Failed to fetch')) {
      throw new Error('Á∂≤Áµ°ÈåØË™§ - API ÊúçÂãôÂèØËÉΩ‰∏çÊîØÊåÅÁÄèË¶ΩÂô®Áõ¥Êé•Ë™øÁî®ÔºàCORSÔºâ');
    }
    throw new Error('Á∂≤Áµ°Ë´ãÊ±ÇÂ§±Êïó: ' + errMsg);
  }

  if(!r.ok) {
    const text = await r.text();
    console.error('API Response error:', r.status, text);
    try {
      const e = JSON.parse(text);
      throw new Error(e.error?.message || `APIÈåØË™§ (${r.status})`);
    } catch(parseErr) {
      if(parseErr.message.includes('APIÈåØË™§')) throw parseErr;
      throw new Error(`APIÈåØË™§ (${r.status}): ${text.slice(0, 200)}`);
    }
  }

  const reader = r.body.getReader();
  const decoder = new TextDecoder();
  let fullContent = '';

  try {
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      const chunk = decoder.decode(value);
      const lines = chunk.split('\n');

      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const data = line.slice(6);
          if (data === '[DONE]') continue;

          try {
            const parsed = JSON.parse(data);
            const text = parsed.choices?.[0]?.delta?.content || '';
            if (text) {
              fullContent += text;
              if (onChunk) await onChunk(text, fullContent);
            }
          } catch (e) {
            // ÂøΩÁï• JSON Ëß£ÊûêÈåØË™§
          }
        }
      }
    }
  } catch (e) {
    if (e.name === 'AbortError' || e.message === 'Â∑≤ÂÅúÊ≠¢ÁîüÊàê') {
      if (onError) onError(e, fullContent);
      return { content: fullContent, stopped: true };
    }
    if (onError) onError(e, fullContent);
    throw e;
  }

  if (onDone) onDone(fullContent);
  return { content: fullContent, tokens: 0 };
}

function stopStreaming() {
  if (streamAbortController) {
    streamAbortController.abort();
    streamAbortController = null;
  }
}

async function buildSysPrompt(){
  if(!story)return'';
  let p='';

  // v22: Á∞°ÁπÅËΩâÊèõÂâçÁΩÆÊèêÁ§∫
  p += getChineseConvertPrefixPrompt();
  
  const bindings=await db.storyInstructions.where('storyId').equals(story.id).toArray();
  for(const b of bindings){
    const i=await db.instructions.get(b.instructionId);
    if(i && i.content){
      p+=i.content+'\n\n';
    }
  }
  
  // v18: Ê∑ªÂä†Ë®òÊÜ∂ÊëòË¶ÅÔºà‰øÆÂæ©Ôºö‰πãÂâçÊëòË¶ÅÊ≤íÊúâË¢´‰ΩøÁî®Ôºâ
  if(story.summaries && story.summaries.length > 0){
    p+='\n### üìö ÊïÖ‰∫ãÂâçÊÉÖÊëòË¶Å\n';
    p+='‰ª•‰∏ãÊòØ‰πãÂâçÂäáÊÉÖÁöÑÈáçË¶ÅÊëòË¶ÅÔºåË´ãÂèÉËÄÉÈÄô‰∫õ‰ø°ÊÅØ‰øùÊåÅÊïÖ‰∫ãÈÄ£Ë≤´ÊÄßÔºö\n\n';
    // ÊåâÊôÇÈñìÈ†ÜÂ∫èÊ∑ªÂä†ÊëòË¶Å
    story.summaries.forEach((s, idx) => {
      if(s && s.content){
        p+=`**„ÄêË®òÊÜ∂ÁâáÊÆµ ${idx + 1}„Äë**\n${s.content}\n\n`;
      }
    });
    p+='---\n\n';
  }
  
  // v22: Ê∑ªÂä†ÊªæÂãïÊëòË¶Å
  if(story.rollingSummaries && story.rollingSummaries.length > 0){
    p+='\n### üìú ÊïÖ‰∫ãËÉåÊôØÊëòË¶Å\n';
    p+='‰ª•‰∏ãÊòØÊúÄËøëÂäáÊÉÖÁöÑËÉåÊôØÊëòË¶ÅÔºåË´ãÂèÉËÄÉÔºö\n\n';
    story.rollingSummaries.forEach((s, idx) => {
      if(s && s.content){
        p+=`**„ÄêËÉåÊôØ ${idx + 1}„Äë** ${s.content}\n\n`;
      }
    });
    p+='---\n\n';
  }
  
  const lore=await db.loreEntries.where('storyId').equals(story.id).filter(e=>e.isSelected).toArray();
  if(lore.length){
    p+='\n### ÂèÉËÄÉË≥áÊñô\n';
    for(const e of lore){
      if(e.name && e.content){
        p+=`\n#### ${e.name}\n${e.content}\n`;
      }
    }
  }
  if(story.storyTime)p+=`\n### Áï∂ÂâçÊôÇÈñì\n${story.storyTime}\n`;
  const fs=await db.foreshadowing.where('storyId').equals(story.id).filter(f=>!f.isResolved).toArray();
  if(fs.length){
    p+='\n### ÂæÖÂõûÊî∂‰ºèÁ≠Ü\n';
    fs.forEach(f=>{
      if(f.title && f.description){
        p+=`- ${f.title}Ôºö${f.description}\n`;
      }
    });
  }
  // Ê∑ªÂä†‰∏ÄËá¥ÊÄß‰øÆÂæ©ÊèêÁ§∫
  if(story.consistencyNote){
    p+='\n### ‰∏ÄËá¥ÊÄß‰øÆÂæ©ÊèêÁ§∫\n'+story.consistencyNote+'\n';
    // ‰ΩøÁî®‰∏ÄÊ¨°ÂæåÊ∏ÖÈô§
    await db.stories.update(story.id,{consistencyNote:null});
    story.consistencyNote=null;
  }
  
  // v21: ÈõôËªå‰∏¶Ë°å - Á∂ìÁáüÊ®°Âºè‰πüÊîØÊåÅËßíËâ≤Á≥ªÁµ±
  const isSimMode = story.mode === 'simulation';
  
  // 1. ËßíËâ≤ÁãÄÊÖã‰ø°ÊÅØÔºàÊâÄÊúâÊ®°ÂºèÈÉΩÁôºÈÄÅÔºâ
  const chars=await db.characters.where('storyId').equals(story.id).toArray();
  if(chars.length){
    p+='\n### Áï∂ÂâçËßíËâ≤ÁãÄÊÖã\n';
    p+='‰ª•‰∏ãÊòØÁï∂ÂâçÂ∑≤Áü•ËßíËâ≤ÁöÑÁãÄÊÖãÔºåË´ãÂú®ÂõûË¶Ü‰∏≠‰øùÊåÅËßíËâ≤Ë°åÁÇ∫ËàáÂÖ∂ÊÄßÊ†º„ÄÅÂ±¨ÊÄß‰∏ÄËá¥Ôºö\n\n';
    chars.forEach(c=>{
      p+=`**${c.name}**`;
      if(c.title)p+=`Ôºà${c.title}Ôºâ`;
      p+='\n';
      if(c.description)p+=`- Á∞°‰ªãÔºö${c.description}\n`;
      if(c.stats&&Object.keys(c.stats).length){
        p+=`- Â±¨ÊÄßÔºö${Object.entries(c.stats).map(([k,v])=>`${k}:${v}`).join('„ÄÅ')}\n`;
      }
      if(c.tags&&c.tags.length){
        p+=`- ÁâπÂæµÔºö${c.tags.join('„ÄÅ')}\n`;
      }
      p+='\n';
    });
  }
  
  // 2. Á∂ìÁáüÊ®°ÂºèÔºöÊ∑ªÂä†Ë≥áÊ∫êÁãÄÊÖãÔºà‰∏çÂº∑Âà∂ JSON Ëº∏Âá∫Ôºâ
  if(isSimMode){
    if(story.simResources && story.simResources.length > 0){
      p+='\n### üìä Áï∂ÂâçË≥áÊ∫êÁãÄÊÖãÔºàÁ¨¨ ' + (story.simDay || 1) + ' Â§©Ôºâ\n';
      story.simResources.forEach(r => {
        p+=`${r.icon} ${r.name}Ôºö${r.value.toLocaleString()}\n`;
      });
      p+='\nË´ãÂú®ÂõûË¶Ü‰∏≠Á∂≠ÊåÅÈÄô‰∫õÊï∏ÊìöÁöÑÂêàÁêÜÊÄßÔºåÂ¶ÇÊúâËÆäÂåñÂèØÂú®ÂõûË¶Ü‰∏≠Ëá™ÁÑ∂Ë™™Êòé„ÄÇ\n';
    }
    // Á∂ìÁáüÊ®°Âºè‰∏çÂº∑Âà∂ JSON Ëº∏Âá∫ÔºåËÆì prompt Ëá™Â∑±ÁöÑÊ†ºÂºèÁîüÊïà
  } else {
    // 3. ÊôÆÈÄöÊ®°ÂºèÔºöË¶ÅÊ±Ç JSON Ê†ºÂºèËº∏Âá∫ËßíËâ≤ÁãÄÊÖã
    p+=`\n### ÁãÄÊÖãËº∏Âá∫Ê†ºÂºèÔºàÈáçË¶ÅÔºâ
ÊØèÊ¨°ÂõûË¶ÜÊôÇÔºåË´ãÂú®ÂäáÊÉÖÂÖßÂÆπ‰πãÂæåÔºåÁî®‰ª•‰∏ã JSON Ê†ºÂºèËº∏Âá∫ËßíËâ≤ÁãÄÊÖãÊõ¥Êñ∞Ôºö

\`\`\`json
{
  "characters": [
    {
      "name": "ËßíËâ≤Âêç",
      "title": "Ë∫´‰ªΩ/Á®±Ëôü",
      "location": "Áï∂Ââç‰ΩçÁΩÆ",
      "stats": {
        "Ë°®Èù¢Â•ΩÊÑü": 0-100,
        "ÁúüÂØ¶Â•ΩÊÑü": 0-100,
        "ÂÖ∂‰ªñÂ±¨ÊÄß": Êï∏ÂÄº
      },
      "mood": "Áï∂ÂâçÊÉÖÁ∑í",
      "note": "Á∞°Áü≠ÂÇôË®ª"
    }
  ]
}
\`\`\`

Ê≥®ÊÑèÔºö
- Âè™Ëº∏Âá∫Êú¨Ê¨°‰∫íÂãï‰∏≠Âá∫ÁèæÊàñÁãÄÊÖãÊúâËÆäÂåñÁöÑËßíËâ≤
- Êï∏ÂÄºÁî® 0-100 Ë°®Á§∫
- Â¶ÇÊûúÊ≤íÊúâËßíËâ≤ÁãÄÊÖãËÆäÂåñÔºåÂèØ‰ª•‰∏çËº∏Âá∫ JSON
- JSON ÂøÖÈ†àÊîæÂú®ÂõûË¶ÜÁöÑÊúÄÂæåÔºåÁî® \`\`\`json Âíå \`\`\` ÂåÖË£π
`;
  }
  
  // v14: ÊáâÁî®Ê®°ÊùøËÆäÈáèÊõøÊèõ
  p = replaceTemplateVars(p);

  // v16: Ê∑ªÂä†Á∞°ÁπÅËΩâÊèõÊåáÁ§∫
  p += getChineseConvertPrompt();

  // v16: Ê∑ªÂä†Áï∂ÂâçÂ†¥ÊôØ‰ø°ÊÅØ
  p += await getActiveScenePrompt();

  // v22: Ê∑ªÂä† Persona ‰ø°ÊÅØ
  p += buildPersonaPrompt();

  return p;
}

// ÊâìÂ≠óÊ©üÊïàÊûú
function showTyping(){const c=document.getElementById('content-area'),d=document.createElement('div');d.id='typing';d.className='typing';d.innerHTML='<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';c.appendChild(d);c.scrollTop=c.scrollHeight;}
function hideTyping(){const t=document.getElementById('typing');if(t)t.remove();}
async function typewriter(m){
  const c=document.getElementById('content-area'),d=document.createElement('div');
  d.className='msg';d.dataset.id=m.id;d.oncontextmenu=e=>showMsgMenu(e,m.id);
  c.appendChild(d);
  const text=m.content;
  const speed=settings.typingSpeed||0;
  
  // Ëß£ÊûêÂÖßÂÆπ
  const parsed = parseAIResponse(text);
  const storyText = parsed.story;
  
  // ÂÆåÊàêÂæåÊ∏≤ÊüìÁöÑÂáΩÊï∏
  const renderFinal = () => {
    let html = `<div class="msg-ai-story">${marked.parse(storyText)}</div>`;
    if(parsed.characters && parsed.characters.length > 0){
      html += renderStatusCards(parsed.characters, m.id);
      // ÂêåÊ≠•ËßíËâ≤ÁãÄÊÖãÂà∞Êï∏ÊìöÂ∫´
      syncCharacterStatus(parsed.characters);
    }
    if(parsed.formatWarning){
      html += `<div class="msg-format-warning"><span class="icon">‚ö†Ô∏è</span>AI Êú™ÊåâÊ†ºÂºèËº∏Âá∫ÁãÄÊÖãÊï∏ÊìöÔºåÂ∑≤È°ØÁ§∫ÂéüÊñá</div>`;
    }
    if(m.tokens){
      html += `<div class="msg-timestamp">${m.tokens} tokens</div>`;
    }
    d.innerHTML = html;
  };
  
  // Â¶ÇÊûúÈÄüÂ∫¶ÁÇ∫ 0ÔºåÁõ¥Êé•È°ØÁ§∫ÂÖ®ÈÉ®ÂÖßÂÆπ
  if(speed===0){
    renderFinal();
    c.scrollTop=c.scrollHeight;
    return;
  }
  
  // ÊâìÂ≠óÊ©üÊïàÊûúÂè™Â∞çÂäáÊÉÖÈÉ®ÂàÜ
  let i=0;
  return new Promise(resolve=>{
    typingCtrl={cancelled:false};
    function type(){
      if(typingCtrl.cancelled){
        renderFinal();
        c.scrollTop=c.scrollHeight;
        resolve();
        return;
      }
      if(i<storyText.length){
        d.innerHTML=`<div class="msg-ai-story"><span>${marked.parse(storyText.slice(0,i+1))}</span><span class="typing-cursor"></span></div>`;
        c.scrollTop=c.scrollHeight;
        i++;
        setTimeout(type,speed);
      }else{
        renderFinal();
        c.scrollTop=c.scrollHeight;
        resolve();
      }
    }
    type();
  });
}

// ÂêåÊ≠•ËßíËâ≤ÁãÄÊÖãÂà∞Êï∏ÊìöÂ∫´
async function syncCharacterStatus(characters){
  if(!story || !characters || characters.length === 0) return;
  
  for(const char of characters){
    try{
      // Êü•ÊâæÊòØÂê¶Â∑≤Â≠òÂú®
      const existing = await db.characters.where('storyId').equals(story.id).filter(c => c.name === char.name).first();
      
      if(existing){
        // Êõ¥Êñ∞ÁèæÊúâËßíËâ≤
        const updates = {};
        if(char.title) updates.title = char.title;
        if(char.location) updates.location = char.location;
        if(char.stats) updates.stats = {...(existing.stats||{}), ...char.stats};
        if(char.mood) updates.mood = char.mood;
        if(char.note) updates.description = char.note;
        if(char.tags && char.tags.length) updates.tags = char.tags;
        updates.updatedAt = Date.now();
        
        await db.characters.update(existing.id, updates);
        console.log('Updated character:', char.name);
      }else{
        // ÂâµÂª∫Êñ∞ËßíËâ≤
        const newChar = {
          id: crypto.randomUUID(),
          storyId: story.id,
          name: char.name,
          title: char.title || '',
          avatar: char.avatar || 'üë§',
          stats: char.stats || {},
          tags: char.tags || [],
          description: char.note || '',
          location: char.location || '',
          mood: char.mood || '',
          createdAt: Date.now(),
          updatedAt: Date.now()
        };
        await db.characters.put(newChar);
        console.log('Created new character:', char.name);
      }
    }catch(e){
      console.error('Error syncing character:', char.name, e);
    }
  }
}

// ============================================
// Lorebook Ëß∏ÁôºÁ≥ªÁµ±
// ============================================

let editLorebookId = null;
let lorebookConditions = [];

// Ê∏≤Êüì Lorebook ÂàóË°®
async function renderLorebook(){
  if(!story) return;
  const c = document.getElementById('lorebook-list');
  const entries = await db.lorebook.where('storyId').equals(story.id).toArray();
  
  // ÊåâÂÑ™ÂÖàÁ¥öÊéíÂ∫è
  entries.sort((a,b) => (b.priority||0) - (a.priority||0));
  
  if(!entries.length){
    c.innerHTML = `<div class="empty" style="padding:40px 20px">
      <div class="empty-icon">üîÆ</div>
      <div class="empty-title">Lorebook ÁÇ∫Á©∫</div>
      <div class="empty-desc">Ê∑ªÂä†Ë®≠ÂÆöÊ¢ùÁõÆÔºåÁï∂Â∞çË©±ÂåÖÂê´ÈóúÈçµË©ûÊôÇËá™ÂãïÊ≥®ÂÖ•</div>
      <button class="action-btn primary" style="margin-top:12px" onclick="addLorebook()">‚ûï Ê∑ªÂä†Ê¢ùÁõÆ</button>
      <button class="action-btn secondary" style="margin-top:8px" onclick="importFromLore()">üì• ÂæûË≥áÊñôÂ∫´Â∞éÂÖ•</button>
    </div>`;
    return;
  }
  
  let html = '';
  for(const entry of entries){
    const hasConditions = entry.conditions && entry.conditions.length > 0;
    const keywords = (entry.keywords || []).slice(0,3).join(', ');
    const moreKeywords = (entry.keywords || []).length > 3 ? ` +${entry.keywords.length-3}` : '';
    
    html += `<div class="lorebook-card ${entry.isEnabled?'':'disabled'}">
      <div class="lorebook-card-header">
        <div class="lorebook-card-status"></div>
        <div class="lorebook-card-title">${esc(entry.name)}</div>
        ${hasConditions ? '<span class="lorebook-card-lock">üîê</span>' : ''}
      </div>
      <div class="lorebook-card-triggers">üè∑Ô∏è ${esc(keywords)}${moreKeywords}</div>
      <div class="lorebook-card-stats">
        <span>Â∑≤Ëß∏Áôº ${entry.triggerCount||0} Ê¨°</span>
        <span>ÂÑ™ÂÖàÁ¥ö ${entry.priority||100}</span>
      </div>
      <div class="lorebook-card-actions">
        <button class="action-btn secondary" onclick="editLorebook('${entry.id}')">Á∑®ËºØ</button>
        <button class="action-btn secondary" onclick="toggleLorebookEnabled('${entry.id}')">${entry.isEnabled?'Á¶ÅÁî®':'ÂïüÁî®'}</button>
        <button class="action-btn secondary" onclick="deleteLorebook('${entry.id}')">üóëÔ∏è</button>
      </div>
    </div>`;
  }
  c.innerHTML = html;
}

// Ê∑ªÂä† Lorebook Ê¢ùÁõÆ
function addLorebook(){
  if(!story){toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã','warning');return;}
  editLorebookId = null;
  lorebookConditions = [];
  document.getElementById('lorebook-id').value = '';
  document.getElementById('lorebook-name').value = '';
  document.getElementById('lorebook-keywords').value = '';
  document.getElementById('lorebook-content').value = '';
  document.getElementById('lorebook-depth').value = '2';
  document.getElementById('lorebook-priority').value = '100';
  document.getElementById('lorebook-cooldown').value = '0';
  document.getElementById('lorebook-max-triggers').value = '0';
  document.getElementById('lorebook-one-time').checked = false;
  document.getElementById('lorebook-condition-list').innerHTML = '';
  document.getElementById('lorebook-advanced').style.display = 'none';
  document.getElementById('lorebook-conditions').style.display = 'none';
  showModal('lorebook-modal');
}

// Á∑®ËºØ Lorebook Ê¢ùÁõÆ
async function editLorebook(id){
  const entry = await db.lorebook.get(id);
  if(!entry) return;
  
  editLorebookId = id;
  lorebookConditions = entry.conditions || [];
  
  document.getElementById('lorebook-id').value = id;
  document.getElementById('lorebook-name').value = entry.name || '';
  document.getElementById('lorebook-keywords').value = (entry.keywords || []).join(', ');
  document.getElementById('lorebook-content').value = entry.content || '';
  document.getElementById('lorebook-depth').value = entry.depth || '2';
  document.getElementById('lorebook-priority').value = entry.priority || '100';
  document.getElementById('lorebook-cooldown').value = entry.cooldown || '0';
  document.getElementById('lorebook-max-triggers').value = entry.maxTriggers || '0';
  document.getElementById('lorebook-one-time').checked = entry.oneTime || false;
  
  // Ë®≠ÁΩÆÊ¢ù‰ª∂ÈÇèËºØ
  const logicRadios = document.querySelectorAll('input[name="lorebook-logic"]');
  logicRadios.forEach(r => r.checked = r.value === (entry.conditionLogic || 'AND'));
  
  // Ê∏≤ÊüìÊ¢ù‰ª∂ÂàóË°®
  renderLorebookConditions();
  
  showModal('lorebook-modal');
}

// ‰øùÂ≠ò Lorebook Ê¢ùÁõÆ
async function saveLorebook(){
  const name = document.getElementById('lorebook-name').value.trim();
  const keywordsStr = document.getElementById('lorebook-keywords').value.trim();
  const content = document.getElementById('lorebook-content').value.trim();
  
  if(!name){toast('Ë´ãËº∏ÂÖ•ÂêçÁ®±','warning');return;}
  if(!keywordsStr){toast('Ë´ãËº∏ÂÖ•Ëß∏ÁôºÈóúÈçµË©û','warning');return;}
  if(!content){toast('Ë´ãËº∏ÂÖ•ÂÖßÂÆπ','warning');return;}
  
  const keywords = keywordsStr.split(/[,Ôºå]/).map(k=>k.trim()).filter(k=>k);
  const conditionLogic = document.querySelector('input[name="lorebook-logic"]:checked')?.value || 'AND';
  
  const entry = {
    id: editLorebookId || crypto.randomUUID(),
    storyId: story.id,
    name,
    keywords,
    content,
    depth: parseInt(document.getElementById('lorebook-depth').value) || 2,
    priority: parseInt(document.getElementById('lorebook-priority').value) || 100,
    cooldown: parseInt(document.getElementById('lorebook-cooldown').value) || 0,
    maxTriggers: parseInt(document.getElementById('lorebook-max-triggers').value) || 0,
    oneTime: document.getElementById('lorebook-one-time').checked,
    conditions: lorebookConditions,
    conditionLogic,
    isEnabled: true,
    triggerCount: 0,
    lastTriggered: null,
    createdAt: editLorebookId ? undefined : Date.now(),
    updatedAt: Date.now()
  };
  
  // ‰øùÁïôÂéüÊúâÁöÑ triggerCount
  if(editLorebookId){
    const existing = await db.lorebook.get(editLorebookId);
    if(existing){
      entry.triggerCount = existing.triggerCount;
      entry.lastTriggered = existing.lastTriggered;
      entry.createdAt = existing.createdAt;
      entry.isEnabled = existing.isEnabled;
    }
  }
  
  await db.lorebook.put(entry);
  closeModal('lorebook-modal');
  toast(editLorebookId ? 'Ê¢ùÁõÆÂ∑≤Êõ¥Êñ∞' : 'Ê¢ùÁõÆÂ∑≤Ê∑ªÂä†', 'success');
  renderLorebook();
}

// ÂàáÊèõÂïüÁî®ÁãÄÊÖã
async function toggleLorebookEnabled(id){
  const entry = await db.lorebook.get(id);
  if(entry){
    await db.lorebook.update(id, {isEnabled: !entry.isEnabled});
    toast(entry.isEnabled ? 'Â∑≤Á¶ÅÁî®' : 'Â∑≤ÂïüÁî®');
    renderLorebook();
  }
}

// Âà™Èô§ Lorebook Ê¢ùÁõÆ
function deleteLorebook(id){
  showConfirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãÊ¢ùÁõÆÂóéÔºü', async()=>{
    await db.lorebook.delete(id);
    toast('Â∑≤Âà™Èô§','success');
    renderLorebook();
  });
}

// ÂæûË≥áÊñôÂ∫´Â∞éÂÖ•
async function importFromLore(){
  if(!story){toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã','warning');return;}
  
  const entries = await db.loreEntries.where('storyId').equals(story.id).toArray();
  if(!entries.length){
    toast('Ë≥áÊñôÂ∫´ÁÇ∫Á©∫ÔºåÊ≤íÊúâÂèØÂ∞éÂÖ•ÁöÑÊ¢ùÁõÆ','warning');
    return;
  }
  
  showConfirm(`Á¢∫ÂÆöË¶ÅÂæûË≥áÊñôÂ∫´Â∞éÂÖ• ${entries.length} ÂÄãÊ¢ùÁõÆÂóéÔºü`, async()=>{
    let count = 0;
    for(const e of entries){
      // Ê™¢Êü•ÊòØÂê¶Â∑≤Â≠òÂú®
      const existing = await db.lorebook.where('storyId').equals(story.id).filter(l=>l.name===e.name).first();
      if(existing) continue;
      
      await db.lorebook.put({
        id: crypto.randomUUID(),
        storyId: story.id,
        name: e.name,
        keywords: [e.name],
        content: e.content || e.description || '',
        depth: 2,
        priority: 100,
        cooldown: 0,
        maxTriggers: 0,
        oneTime: false,
        conditions: [],
        conditionLogic: 'AND',
        isEnabled: true,
        triggerCount: 0,
        lastTriggered: null,
        createdAt: Date.now(),
        updatedAt: Date.now()
      });
      count++;
    }
    toast(`Â∑≤Â∞éÂÖ• ${count} ÂÄãÊ¢ùÁõÆ`,'success');
    renderLorebook();
  });
}

// ÈÄ≤ÈöéË®≠ÁΩÆÈñãÈóú
function toggleLorebookAdvanced(){
  const el = document.getElementById('lorebook-advanced');
  const toggle = document.getElementById('lorebook-advanced-toggle');
  if(el.style.display === 'none'){
    el.style.display = 'block';
    toggle.textContent = '‚ñ≤';
  }else{
    el.style.display = 'none';
    toggle.textContent = '‚ñº';
  }
}

// Ê¢ù‰ª∂Ë®≠ÁΩÆÈñãÈóú
function toggleLorebookConditions(){
  const el = document.getElementById('lorebook-conditions');
  const toggle = document.getElementById('lorebook-conditions-toggle');
  if(el.style.display === 'none'){
    el.style.display = 'block';
    toggle.textContent = '‚ñ≤';
  }else{
    el.style.display = 'none';
    toggle.textContent = '‚ñº';
  }
}

// Ê∑ªÂä†Ê¢ù‰ª∂
async function addLorebookCondition(){
  lorebookConditions.push({
    type: 'stat',
    character: '',
    stat: '',
    operator: '>=',
    value: 50
  });
  renderLorebookConditions();
}

// Ê∏≤ÊüìÊ¢ù‰ª∂ÂàóË°®
async function renderLorebookConditions(){
  const container = document.getElementById('lorebook-condition-list');
  const chars = story ? await db.characters.where('storyId').equals(story.id).toArray() : [];
  
  let html = '';
  lorebookConditions.forEach((cond, idx) => {
    // Áç≤ÂèñËßíËâ≤ÁöÑÂ±¨ÊÄßÂàóË°®
    const charOptions = chars.map(c => `<option value="${esc(c.name)}" ${cond.character===c.name?'selected':''}>${esc(c.name)}</option>`).join('');
    
    // Áç≤ÂèñÈÅ∏‰∏≠ËßíËâ≤ÁöÑÂ±¨ÊÄß
    const selectedChar = chars.find(c => c.name === cond.character);
    const statOptions = selectedChar && selectedChar.stats 
      ? Object.keys(selectedChar.stats).map(s => `<option value="${esc(s)}" ${cond.stat===s?'selected':''}>${esc(s)}</option>`).join('')
      : '<option value="">Ë´ãÂÖàÈÅ∏ÊìáËßíËâ≤</option>';
    
    html += `<div class="lorebook-condition" data-idx="${idx}">
      <select onchange="updateLorebookCondition(${idx},'character',this.value);setTimeout(()=>renderLorebookConditions(),0)">
        <option value="">ÈÅ∏ÊìáËßíËâ≤</option>
        ${charOptions}
      </select>
      <select onchange="updateLorebookCondition(${idx},'stat',this.value)">
        <option value="">ÈÅ∏ÊìáÂ±¨ÊÄß</option>
        ${statOptions}
      </select>
      <select onchange="updateLorebookCondition(${idx},'operator',this.value)">
        <option value=">=" ${cond.operator==='>='?'selected':''}>‚â•</option>
        <option value=">" ${cond.operator==='>'?'selected':''}>></option>
        <option value="<=" ${cond.operator==='<='?'selected':''}>‚â§</option>
        <option value="<" ${cond.operator==='<'?'selected':''}><</option>
        <option value="==" ${cond.operator==='=='?'selected':''}>Ôºù</option>
      </select>
      <input type="number" value="${cond.value}" onchange="updateLorebookCondition(${idx},'value',parseInt(this.value))">
      <span style="cursor:pointer;color:var(--error)" onclick="removeLorebookCondition(${idx})">üóëÔ∏è</span>
    </div>`;
  });
  
  container.innerHTML = html || '<div style="font-size:12px;color:var(--text-tertiary);text-align:center;padding:12px">Êö´ÁÑ°Ê¢ù‰ª∂ÔºåÈªûÊìä‰∏ãÊñπÊåâÈàïÊ∑ªÂä†</div>';
}

// Êõ¥Êñ∞Ê¢ù‰ª∂
function updateLorebookCondition(idx, field, value){
  if(lorebookConditions[idx]){
    lorebookConditions[idx][field] = value;
  }
}

// ÁßªÈô§Ê¢ù‰ª∂
function removeLorebookCondition(idx){
  lorebookConditions.splice(idx, 1);
  renderLorebookConditions();
}

// Ê™¢Ê∏¨ÈóúÈçµË©ûÂåπÈÖç
function checkKeywordMatch(entry, userMessage, recentMessages){
  const keywords = entry.keywords || [];
  const depth = entry.depth || 2;

  // È©óË≠âËº∏ÂÖ•
  if(!userMessage || typeof userMessage !== 'string'){
    userMessage = '';
  }

  // Âêà‰ΩµÊúÄËøëÊ∂àÊÅØ
  let textToCheck = userMessage;
  const recentSlice = recentMessages.slice(-depth);
  recentSlice.forEach(m => {
    textToCheck += ' ' + (m.content || '');
  });
  textToCheck = textToCheck.toLowerCase();
  
  // Ê™¢Êü•ÈóúÈçµË©û
  for(const keyword of keywords){
    if(textToCheck.includes(keyword.toLowerCase())){
      entry._matchedKeyword = keyword;
      return true;
    }
  }
  return false;
}

// Ê™¢Êü•Ëß∏ÁôºÊ¢ù‰ª∂
async function checkLorebookConditions(entry){
  if(!entry.conditions || entry.conditions.length === 0) return true;
  
  const chars = await db.characters.where('storyId').equals(story.id).toArray();
  const results = [];
  
  for(const cond of entry.conditions){
    const char = chars.find(c => c.name === cond.character);
    if(!char || !char.stats) {
      results.push(false);
      continue;
    }
    
    const statValue = char.stats[cond.stat];
    if(statValue === undefined){
      results.push(false);
      continue;
    }
    
    let met = false;
    switch(cond.operator){
      case '>=': met = statValue >= cond.value; break;
      case '>': met = statValue > cond.value; break;
      case '<=': met = statValue <= cond.value; break;
      case '<': met = statValue < cond.value; break;
      case '==': met = statValue === cond.value; break;
    }
    results.push(met);
  }
  
  if(entry.conditionLogic === 'OR'){
    return results.some(r => r);
  }else{
    return results.every(r => r);
  }
}

// Áç≤ÂèñËß∏ÁôºÁöÑ Lorebook ÂÖßÂÆπ
async function getTriggeredLorebook(userMessage){
  if(!story) return [];
  
  const entries = await db.lorebook.where('storyId').equals(story.id).filter(e => e.isEnabled).toArray();
  const triggered = [];
  const recentMsgs = msgs.slice(-5);
  
  for(const entry of entries){
    // Ê™¢Êü•ÈóúÈçµË©û
    if(!checkKeywordMatch(entry, userMessage, recentMsgs)) continue;
    
    // Ê™¢Êü•Ê¢ù‰ª∂
    const conditionsMet = await checkLorebookConditions(entry);
    if(!conditionsMet) continue;
    
    // Ê™¢Êü•ÂÜ∑Âçª
    if(entry.cooldown > 0 && entry.lastTriggered){
      const msgsSinceTrigger = msgs.filter(m => m.createdAt > entry.lastTriggered).length;
      if(msgsSinceTrigger < entry.cooldown) continue;
    }
    
    // Ê™¢Êü•ÊúÄÂ§ßËß∏ÁôºÊ¨°Êï∏
    if(entry.maxTriggers > 0 && (entry.triggerCount || 0) >= entry.maxTriggers) continue;
    
    triggered.push(entry);
  }
  
  // ÊåâÂÑ™ÂÖàÁ¥öÊéíÂ∫è
  triggered.sort((a, b) => (b.priority || 0) - (a.priority || 0));
  
  return triggered;
}

// È°ØÁ§∫Ëß∏ÁôºÊèêÁ§∫
function showLorebookTriggerToast(entries){
  if(!entries || entries.length === 0) return;
  
  const names = entries.map(e => e.name).join('„ÄÅ');
  const toast = document.createElement('div');
  toast.className = 'lore-trigger-toast';
  toast.innerHTML = `<span>üîÆ</span><span>Â∑≤Ëß∏ÁôºÔºö${esc(names)}</span>`;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(-50%) translateY(-10px)';
    setTimeout(() => toast.remove(), 300);
  }, 2500);
}

// ÊâìÂ≠óÊ©üÈªûÊìäÂèñÊ∂àÂ∑≤Êï¥ÂêàÂà∞ initMsgSwipe ÁöÑ‰∫ã‰ª∂ÂßîÊâò‰∏≠
// ÈÄôË£°Ê∑ªÂä†È°çÂ§ñÁöÑÊâìÂ≠óÊ©üÂèñÊ∂àÈÇèËºØ
function initTypingCancel(){
  const contentArea = document.getElementById('content-area');
  if(contentArea){
    contentArea.addEventListener('click', () => {
      if(typingCtrl && !typingCtrl.cancelled) typingCtrl.cancelled = true;
    });
  }
}

// Ë≥áÊñôÂ∫´
async function renderLore(){
  if(!story)return;
  const c=document.getElementById('lore-list');
  const entries=await db.loreEntries.where('storyId').equals(story.id).toArray();
  const grouped={character:[],location:[],item:[],setting:[]};
  entries.forEach(e=>{if(grouped[e.category])grouped[e.category].push(e);});
  const labels={character:{icon:'üë•',label:'ËßíËâ≤'},location:{icon:'üó∫Ô∏è',label:'Âú∞Èªû'},item:{icon:'üì¶',label:'Áâ©ÂìÅ'},setting:{icon:'üìú',label:'Ë®≠ÂÆö'}};
  let html='',selCount=0;
  for(const[cat,items]of Object.entries(grouped)){
    if(!items.length)continue;
    const{icon,label}=labels[cat];
    html+=`<div class="lore-section"><div class="lore-header" onclick="toggleLoreSection(this)"><div class="lore-header-left"><span>${icon}</span><span>${label}</span><span class="lore-count">(${items.length})</span></div><span class="lore-toggle">‚ñº</span></div><div class="lore-list">`;
    for(const e of items){
      if(e.isSelected)selCount++;
      html+=`<div class="lore-item" onclick="toggleLoreSel('${e.id}')"><div class="lore-checkbox ${e.isSelected?'checked':''}" data-id="${e.id}"></div><div class="lore-icon ${cat.slice(0,3)}">${e.icon||icon}</div><div class="lore-content"><div class="lore-name">${esc(e.name)}</div><div class="lore-desc">${esc(e.description||'')}</div></div><div class="lore-actions" onclick="event.stopPropagation()"><span onclick="editLore('${e.id}')">‚úèÔ∏è</span><span onclick="deleteLore('${e.id}')">üóëÔ∏è</span></div></div>`;
    }
    html+='</div></div>';
  }
  if(!html)html='<div class="empty"><div class="empty-icon">üìñ</div><div class="empty-title">Ë≥áÊñôÂ∫´ÁÇ∫Á©∫</div><div class="empty-desc">ÈªûÊìäÂè≥‰∏äËßíÊ∑ªÂä†ËßíËâ≤„ÄÅÂú∞ÈªûÁ≠âË®≠ÂÆö</div><button class="action-btn primary" style="margin-top:12px" onclick="addLore()">‚ûï Ê∑ªÂä†Ë≥áÊñô</button></div>';
  c.innerHTML=html;
  document.getElementById('lore-count').textContent=`Â∑≤ÈÅ∏ ${selCount} È†Ö`;
}
function toggleLoreSection(h){h.querySelector('.lore-toggle').classList.toggle('collapsed');h.nextElementSibling.classList.toggle('collapsed');}
async function toggleLoreSel(id){const e=await db.loreEntries.get(id);if(e){await db.loreEntries.update(id,{isSelected:!e.isSelected});renderLore();}}

let editLoreId=null;
function addLore(){
  if(!story){toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã','warning');return;}
  editLoreId=null;
  document.getElementById('lore-name').value='';
  document.getElementById('lore-category').value='character';
  document.getElementById('lore-desc').value='';
  document.getElementById('lore-content-input').value='';
  showModal('lore-modal');
}
async function editLore(id){
  const e=await db.loreEntries.get(id);
  if(!e)return;
  editLoreId=id;
  document.getElementById('lore-name').value=e.name||'';
  document.getElementById('lore-category').value=e.category||'character';
  document.getElementById('lore-desc').value=e.description||'';
  document.getElementById('lore-content-input').value=e.content||'';
  showModal('lore-modal');
}
async function saveLore(){
  const name=document.getElementById('lore-name').value.trim();
  const category=document.getElementById('lore-category').value;
  const description=document.getElementById('lore-desc').value.trim();
  const content=document.getElementById('lore-content-input').value.trim();
  if(!name){toast('Ë´ãËº∏ÂÖ•ÂêçÁ®±','warning');return;}
  const entry={
    id:editLoreId||crypto.randomUUID(),
    storyId:story.id,
    name,category,description,content,
    isSelected:false,
    createdAt:Date.now()
  };
  await db.loreEntries.put(entry);
  closeModal('lore-modal');
  toast(editLoreId?'Ë≥áÊñôÂ∑≤Êõ¥Êñ∞':'Ë≥áÊñôÂ∑≤Ê∑ªÂä†','success');
  renderLore();
}
async function deleteLore(id){
  showConfirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÊ¢ùË≥áÊñôÂóéÔºü',async()=>{
    await db.loreEntries.delete(id);
    toast('Ë≥áÊñôÂ∑≤Âà™Èô§','success');
    renderLore();
  });
}

// Ë≥áÊñôÊêúÁ¥¢
async function filterLore(){
  const keyword=document.getElementById('lore-search').value.trim().toLowerCase();
  if(!story)return;
  const c=document.getElementById('lore-list');
  const entries=await db.loreEntries.where('storyId').equals(story.id).toArray();
  
  // ÈÅéÊøæ
  const filtered=keyword?entries.filter(e=>
    e.name.toLowerCase().includes(keyword)||
    (e.description||'').toLowerCase().includes(keyword)||
    (e.content||'').toLowerCase().includes(keyword)
  ):entries;
  
  const grouped={character:[],location:[],item:[],setting:[]};
  filtered.forEach(e=>{if(grouped[e.category])grouped[e.category].push(e);});
  const labels={character:{icon:'üë•',label:'ËßíËâ≤'},location:{icon:'üó∫Ô∏è',label:'Âú∞Èªû'},item:{icon:'üì¶',label:'Áâ©ÂìÅ'},setting:{icon:'üìú',label:'Ë®≠ÂÆö'}};
  let html='',selCount=0;
  for(const[cat,items]of Object.entries(grouped)){
    if(!items.length)continue;
    const{icon,label}=labels[cat];
    html+=`<div class="lore-section"><div class="lore-header" onclick="toggleLoreSection(this)"><div class="lore-header-left"><span>${icon}</span><span>${label}</span><span class="lore-count">(${items.length})</span></div><span class="lore-toggle">‚ñº</span></div><div class="lore-list">`;
    for(const e of items){
      if(e.isSelected)selCount++;
      html+=`<div class="lore-item" onclick="toggleLoreSel('${e.id}')"><div class="lore-checkbox ${e.isSelected?'checked':''}" data-id="${e.id}"></div><div class="lore-icon ${cat.slice(0,3)}">${e.icon||icon}</div><div class="lore-content"><div class="lore-name">${esc(e.name)}</div><div class="lore-desc">${esc(e.description||'')}</div></div><div class="lore-actions" onclick="event.stopPropagation()"><span onclick="editLore('${e.id}')">‚úèÔ∏è</span><span onclick="deleteLore('${e.id}')">üóëÔ∏è</span></div></div>`;
    }
    html+='</div></div>';
  }
  if(!html){
    if(keyword)html='<div class="empty"><div class="empty-icon">üîç</div><div class="empty-title">Êú™ÊâæÂà∞ÂåπÈÖçË≥áÊñô</div></div>';
    else html='<div class="empty"><div class="empty-icon">üìñ</div><div class="empty-title">Ë≥áÊñôÂ∫´ÁÇ∫Á©∫</div><div class="empty-desc">ÈªûÊìäÂè≥‰∏äËßíÊ∑ªÂä†ËßíËâ≤„ÄÅÂú∞ÈªûÁ≠âË®≠ÂÆö</div><button class="action-btn primary" style="margin-top:12px" onclick="addLore()">‚ûï Ê∑ªÂä†Ë≥áÊñô</button></div>';
  }
  c.innerHTML=html;
  document.getElementById('lore-count').textContent=`Â∑≤ÈÅ∏ ${selCount} È†Ö`;
}

// AI ÊèêÂèñ‰∏ñÁïåËßÄË®≠ÂÆö
let aiExtractData = null;
async function aiExtractLore(){
  if(!story){toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã','warning');return;}
  
  // Êî∂ÈõÜ‰æÜÊ∫êÊï∏Êìö
  let sourceContent = '';
  
  // 1. ÂæûÊåá‰ª§ Prompt ÊèêÂèñ
  const bindings = await db.storyInstructions.where('storyId').equals(story.id).toArray();
  if(bindings.length > 0){
    const instIds = bindings.map(b => b.instructionId);
    const instructions = await db.instructions.where('id').anyOf(instIds).toArray();
    instructions.forEach(inst => {
      sourceContent += `\n„ÄêÊåá‰ª§Ë®≠ÂÆö„Äë\n${inst.content || ''}\n`;
    });
  }
  
  // 2. ÂæûÊïÖ‰∫ãÂäáÊÉÖÊèêÂèñÔºàÊúÄËøë N Ê¢ùÊ∂àÊÅØÔºâ
  if(msgs && msgs.length > 0){
    const recentMsgs = msgs.slice(-30); // ÊúÄËøë 30 Ê¢ù
    const storyContent = recentMsgs.map(m => m.content).join('\n');
    sourceContent += `\n„ÄêÊïÖ‰∫ãÂäáÊÉÖ„Äë\n${storyContent}\n`;
  }
  
  if(!sourceContent.trim()){
    toast('Ê≤íÊúâÂèØÊèêÂèñÁöÑÂÖßÂÆπ','warning');
    return;
  }
  
  showLoading('AI Ê≠£Âú®ÂàÜÊûê‰∏¶ÊèêÂèñË®≠ÂÆö...');
  
  const prompt = `Ë´ãÂàÜÊûê‰ª•‰∏ãÂÖßÂÆπÔºåÊèêÂèñÂÖ∂‰∏≠ÁöÑ‰∏ñÁïåËßÄË®≠ÂÆö„ÄÇË´ã‰ª• JSON Ê†ºÂºèËøîÂõûÔºåÂåÖÂê´‰ª•‰∏ãÈ°ûÂà•Ôºö

1. charactersÔºàËßíËâ≤ÔºâÔºöÂåÖÂê´ name, description, details
2. locationsÔºàÂú∞ÈªûÔºâÔºöÂåÖÂê´ name, description
3. itemsÔºàÁâ©ÂìÅÔºâÔºöÂåÖÂê´ name, description
4. settingsÔºàË®≠ÂÆö/Ë¶èÂâáÔºâÔºöÂåÖÂê´ name, description

Ê≥®ÊÑèÔºö
- Âè™ÊèêÂèñÊòéÁ¢∫Âá∫ÁèæÊàñÊèêÂèäÁöÑÂÖßÂÆπ
- ÊØèÂÄãÈ°ûÂà•ÊúÄÂ§öÊèêÂèñ 10 ÂÄãÊúÄÈáçË¶ÅÁöÑÊ¢ùÁõÆ
- ÊèèËø∞Ë¶ÅÁ∞°ÊΩî‰ΩÜÂÆåÊï¥

Ë´ãÂè™ËøîÂõû JSONÔºå‰∏çË¶ÅÂÖ∂‰ªñÂÖßÂÆπÔºö
{
  "characters": [{"name": "", "description": ""}],
  "locations": [{"name": "", "description": ""}],
  "items": [{"name": "", "description": ""}],
  "settings": [{"name": "", "description": ""}]
}

ÂæÖÂàÜÊûêÂÖßÂÆπÔºö
${sourceContent.slice(0, 15000)}`;

  try{
    const response = await callAI(prompt);
    hideLoading();
    
    // Ëß£Êûê JSON - response ÊòØÂ∞çË±°ÔºåÈúÄË¶ÅÂèñ content
    const responseText = response.content || response;
    let data;
    const jsonMatch = responseText.match(/\{[\s\S]*\}/);
    if(jsonMatch){
      data = JSON.parse(jsonMatch[0]);
    }else{
      throw new Error('ÁÑ°Ê≥ïËß£Êûê AI ËøîÂõûÁöÑÂÖßÂÆπ');
    }
    
    // È°ØÁ§∫ÊèêÂèñÁµêÊûú‰æõÁî®Êà∂Á¢∫Ë™ç
    aiExtractData = data;
    showAiExtractResults(data);
  }catch(e){
    hideLoading();
    toast('ÊèêÂèñÂ§±Êïó: ' + e.message, 'error');
  }
}

function showAiExtractResults(data){
  const categoryLabels = {
    characters: {icon: 'üë•', label: 'ËßíËâ≤', category: 'character'},
    locations: {icon: 'üó∫Ô∏è', label: 'Âú∞Èªû', category: 'location'},
    items: {icon: 'üì¶', label: 'Áâ©ÂìÅ', category: 'item'},
    settings: {icon: 'üìú', label: 'Ë®≠ÂÆö', category: 'setting'}
  };
  
  let html = '<div style="max-height:400px;overflow-y:auto">';
  let totalCount = 0;
  
  for(const [key, items] of Object.entries(data)){
    if(!items || !items.length) continue;
    const {icon, label, category} = categoryLabels[key] || {icon: 'üìÑ', label: key, category: 'setting'};
    
    html += `<div style="margin-bottom:16px">`;
    html += `<div style="font-weight:600;margin-bottom:8px">${icon} ${label} (${items.length})</div>`;
    
    items.forEach((item, idx) => {
      totalCount++;
      const itemId = `extract-${key}-${idx}`;
      html += `<div style="display:flex;align-items:flex-start;gap:8px;padding:8px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:6px">`;
      html += `<input type="checkbox" id="${itemId}" checked style="margin-top:4px" data-category="${category}" data-name="${esc(item.name)}" data-desc="${esc(item.description || '')}">`;
      html += `<label for="${itemId}" style="flex:1;cursor:pointer">`;
      html += `<div style="font-weight:500">${esc(item.name)}</div>`;
      if(item.description) html += `<div style="font-size:12px;color:var(--text-secondary)">${esc(item.description.slice(0, 100))}${item.description.length > 100 ? '...' : ''}</div>`;
      html += `</label></div>`;
    });
    
    html += `</div>`;
  }
  
  if(totalCount === 0){
    html = '<div style="text-align:center;color:var(--text-secondary);padding:20px">Êú™ÊèêÂèñÂà∞‰ªª‰ΩïË®≠ÂÆö</div>';
  }
  
  html += '</div>';
  
  document.getElementById('confirm-title').textContent = `ü§ñ AI ÊèêÂèñÁµêÊûú (${totalCount} È†Ö)`;
  document.getElementById('confirm-content').innerHTML = html;
  document.getElementById('confirm-content').style.whiteSpace = 'normal';
  document.getElementById('confirm-btn').textContent = '‰øùÂ≠òÈÅ∏‰∏≠È†Ö';
  document.getElementById('confirm-btn').style.display = '';
  confirmCb = saveExtractedLore;
  showModal('confirm-modal');
}

async function saveExtractedLore(){
  const checkboxes = document.querySelectorAll('#confirm-content input[type="checkbox"]:checked');
  let savedCount = 0;
  
  for(const cb of checkboxes){
    const entry = {
      id: crypto.randomUUID(),
      storyId: story.id,
      name: cb.dataset.name,
      category: cb.dataset.category,
      description: cb.dataset.desc,
      content: '',
      isSelected: false,
      createdAt: Date.now()
    };
    await db.loreEntries.put(entry);
    savedCount++;
  }
  
  toast(`Â∑≤‰øùÂ≠ò ${savedCount} Ê¢ùË®≠ÂÆö`, 'success');
  closeModal('confirm-modal');
  renderLore();
}

// ÊêúÁ¥¢ÂäüËÉΩ
async function initContentSearch(){
  const c=document.getElementById('search-results');
  const input=document.getElementById('content-search');
  
  // Ê∏ÖÁ©∫ÊêúÁ¥¢Ê°Ü
  if(input) input.value='';
  
  // Ê™¢Êü•ÊòØÂê¶ÊúâÊïÖ‰∫ã
  if(!story){
    c.innerHTML='<div class="empty"><div class="empty-icon">üìö</div><div class="empty-title">Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã</div><div class="empty-desc">ËøîÂõûÊïÖ‰∫ãÂàóË°®ÈÅ∏Êìá‰∏ÄÂÄãÊïÖ‰∫ãÂæåÂÜçÊêúÁ¥¢</div></div>';
    return;
  }
  
  // Áõ¥Êé•ÂæûÊï∏ÊìöÂ∫´Áç≤ÂèñÊ∂àÊÅØÊï∏Èáè
  const msgCount = await db.messages.where('[storyId+branchId]').equals([story.id, story.currentBranchId]).count();
  
  if(!msgCount){
    c.innerHTML='<div class="empty"><div class="empty-icon">‚ú®</div><div class="empty-title">ÊïÖ‰∫ãÂÖßÂÆπÁÇ∫Á©∫</div><div class="empty-desc">ÈñãÂßãË¨õËø∞ÊïÖ‰∫ãÂæåÊâçËÉΩÊêúÁ¥¢ÂÖßÂÆπ</div></div>';
    return;
  }
  
  c.innerHTML=`<div class="empty"><div class="empty-icon">üîç</div><div class="empty-title">Ëº∏ÂÖ•ÈóúÈçµË©ûÊêúÁ¥¢</div><div class="empty-desc">ÂÖ±Êúâ ${msgCount} Ê¢ùÊ∂àÊÅØÂèØÊêúÁ¥¢</div></div>`;
}

async function doContentSearch(){
  const keyword=document.getElementById('content-search').value.trim().toLowerCase();
  const c=document.getElementById('search-results');
  
  // Ê™¢Êü•ÊòØÂê¶ÊúâÊïÖ‰∫ã
  if(!story){
    c.innerHTML='<div class="empty"><div class="empty-icon">üìö</div><div class="empty-title">Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã</div><div class="empty-desc">ËøîÂõûÊïÖ‰∫ãÂàóË°®ÈÅ∏Êìá‰∏ÄÂÄãÊïÖ‰∫ãÂæåÂÜçÊêúÁ¥¢</div></div>';
    return;
  }
  
  // Áõ¥Êé•ÂæûÊï∏ÊìöÂ∫´ËÆÄÂèñÊâÄÊúâÊ∂àÊÅØÔºà‰∏ç‰æùË≥¥ÂÖ®Â±ÄËÆäÈáèÔºâ
  const allMsgs = await db.messages.where('[storyId+branchId]').equals([story.id, story.currentBranchId]).sortBy('createdAt');
  
  if(!allMsgs||!allMsgs.length){
    c.innerHTML='<div class="empty"><div class="empty-icon">‚ú®</div><div class="empty-title">ÊïÖ‰∫ãÂÖßÂÆπÁÇ∫Á©∫</div><div class="empty-desc">ÈñãÂßãË¨õËø∞ÊïÖ‰∫ãÂæåÊâçËÉΩÊêúÁ¥¢ÂÖßÂÆπ</div></div>';
    return;
  }
  
  if(!keyword){
    c.innerHTML=`<div class="empty"><div class="empty-icon">üîç</div><div class="empty-title">Ëº∏ÂÖ•ÈóúÈçµË©ûÊêúÁ¥¢</div><div class="empty-desc">ÂÖ±Êúâ ${allMsgs.length} Ê¢ùÊ∂àÊÅØÂèØÊêúÁ¥¢</div></div>`;
    return;
  }
  
  // ‰ΩøÁî® includes ÈÄ≤Ë°åÊêúÁ¥¢
  const msgResults=allMsgs.filter(m=>{
    if(!m.content)return false;
    return m.content.toLowerCase().includes(keyword);
  });
  
  // v22: ÂêåÊôÇÊêúÁ¥¢ÊëòË¶Å
  const summaries = story.summaries || [];
  const rollingSummaries = story.rollingSummaries || [];
  const summaryResults = [];
  summaries.forEach((s, i) => {
    if(s.content && s.content.toLowerCase().includes(keyword)){
      summaryResults.push({...s, type: 'Â£ìÁ∏ÆÊëòË¶Å', idx: i});
    }
  });
  rollingSummaries.forEach((s, i) => {
    if(s.content && s.content.toLowerCase().includes(keyword)){
      summaryResults.push({...s, type: 'ÊªæÂãïÊëòË¶Å', idx: i});
    }
  });
  
  if(!msgResults.length && !summaryResults.length){
    c.innerHTML=`<div class="empty"><div class="empty-icon">üîç</div><div class="empty-title">Êú™ÊâæÂà∞ÂåπÈÖçÂÖßÂÆπ</div><div class="empty-desc">ÂòóË©¶ÊêúÁ¥¢ÂÖ∂‰ªñÈóúÈçµË©û<br><span style="font-size:11px;color:var(--text-tertiary)">Ôºà${allMsgs.length} Ê¢ùÊ∂àÊÅØ‰∏≠ÊêúÁ¥¢Ôºâ</span></div></div>`;
    return;
  }
  
  // È°ØÁ§∫ÁµêÊûú
  let html = `<div style="padding:8px;color:var(--text-secondary);font-size:13px">ÊâæÂà∞ ${msgResults.length} Ê¢ùÊ∂àÊÅØ`;
  if(summaryResults.length > 0) html += ` + ${summaryResults.length} Ê¢ùÊëòË¶Å`;
  html += '</div>';
  
  // È°ØÁ§∫ÊëòË¶ÅÁµêÊûúÔºàÂ¶ÇÊûúÊúâÔºâ
  if(summaryResults.length > 0){
    html += '<div style="padding:4px 8px;font-size:12px;color:var(--primary);font-weight:600">üìö ÊëòË¶Å‰∏≠ÁöÑÂåπÈÖç</div>';
    html += summaryResults.map(s => {
      const content = s.content || '';
      const lowerContent = content.toLowerCase();
      const idx = lowerContent.indexOf(keyword);
      const start = Math.max(0, idx - 40);
      const end = Math.min(content.length, idx + keyword.length + 60);
      let preview = content.slice(start, end);
      if(start > 0) preview = '...' + preview;
      if(end < content.length) preview = preview + '...';
      const regex = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      const highlighted = esc(preview).replace(regex, '<mark style="background:var(--warning);color:black;padding:0 2px">$1</mark>');
      return `<div class="card"><div class="card-cover" style="background:var(--info)">üìö</div><div class="card-info"><div class="card-header"><div class="card-title">${s.type} #${s.idx+1}</div><div class="card-time">${fmtDate(s.createdAt)}</div></div><div class="card-preview">${highlighted}</div></div></div>`;
    }).join('');
  }
  
  // È°ØÁ§∫Ê∂àÊÅØÁµêÊûú
  if(msgResults.length > 0){
    if(summaryResults.length > 0) html += '<div style="padding:4px 8px;font-size:12px;color:var(--primary);font-weight:600;margin-top:8px">üí¨ Ê∂àÊÅØ‰∏≠ÁöÑÂåπÈÖç</div>';
    html += msgResults.map(m=>{
      const preview=m.content.slice(0,150);
      const keywordLower = keyword.toLowerCase();
      const previewLower = preview.toLowerCase();
      const idx = previewLower.indexOf(keywordLower);
      let highlighted = esc(preview);
      if(idx >= 0){
        const before = esc(preview.slice(0, idx));
        const match = esc(preview.slice(idx, idx + keyword.length));
        const after = esc(preview.slice(idx + keyword.length));
        highlighted = `${before}<mark style="background:var(--warning);color:black;padding:0 2px;border-radius:2px">${match}</mark>${after}`;
      }
      return `<div class="card" onclick="jumpToMessage('${m.id}')">
        <div class="card-cover" style="background:${m.role==='user'?'var(--primary)':'var(--bg-tertiary)'}">${m.role==='user'?'üë§':'ü§ñ'}</div>
        <div class="card-info">
          <div class="card-header"><div class="card-title">${m.role==='user'?'Áî®Êà∂':'AI'}</div><div class="card-time">${fmtDate(m.createdAt)}</div></div>
          <div class="card-preview">${highlighted}...</div>
        </div>
      </div>`;
    }).join('');
  }
  
  c.innerHTML = html;
}
function showAdvancedSearch(){
  document.getElementById('adv-search-keyword').value=document.getElementById('content-search').value;
  showModal('advanced-search-modal');
}
function doAdvancedSearch(){
  const keyword=document.getElementById('adv-search-keyword').value.trim();
  const scope=document.getElementById('adv-search-scope').value;
  const caseSensitive=document.getElementById('adv-search-case').checked;
  if(!keyword){toast('Ë´ãËº∏ÂÖ•ÈóúÈçµË©û','warning');return;}
  
  closeModal('advanced-search-modal');
  const c=document.getElementById('search-results');
  
  if(!story||!msgs||!msgs.length){
    c.innerHTML='<div class="empty"><div class="empty-icon">üìö</div><div class="empty-title">Ê≤íÊúâÂèØÊêúÁ¥¢ÁöÑÂÖßÂÆπ</div></div>';
    return;
  }
  
  let filtered=msgs;
  if(scope==='user')filtered=msgs.filter(m=>m.role==='user');
  else if(scope==='ai')filtered=msgs.filter(m=>m.role==='assistant');
  
  const results=filtered.filter(m=>{
    if(!m.content)return false;
    const content=caseSensitive?m.content:m.content.toLowerCase();
    const search=caseSensitive?keyword:keyword.toLowerCase();
    return content.includes(search);
  });
  
  if(!results.length){
    c.innerHTML='<div class="empty"><div class="empty-icon">üîç</div><div class="empty-title">Êú™ÊâæÂà∞ÂåπÈÖçÂÖßÂÆπ</div></div>';
    return;
  }
  
  c.innerHTML=`<div style="padding:8px;color:var(--text-secondary);font-size:13px">ÊâæÂà∞ ${results.length} Ê¢ùÁµêÊûú</div>`+results.map(m=>{
    const preview=m.content.slice(0,150);
    return `<div class="card" onclick="jumpToMessage('${m.id}')">
      <div class="card-cover" style="background:${m.role==='user'?'var(--primary)':'var(--bg-tertiary)'}">${m.role==='user'?'üë§':'ü§ñ'}</div>
      <div class="card-info">
        <div class="card-header"><div class="card-title">${m.role==='user'?'Áî®Êà∂':'AI'}</div><div class="card-time">${fmtDate(m.createdAt)}</div></div>
        <div class="card-preview">${esc(preview)}...</div>
      </div>
    </div>`;
  }).join('');
}
function jumpToMessage(msgId){
  goBack();
  setTimeout(()=>{
    const el=document.querySelector(`.msg[data-id="${msgId}"]`);
    if(el){el.scrollIntoView({behavior:'smooth',block:'center'});el.style.animation='highlight 1s';}
  },300);
}

// ÊôÇÈñìËª∏
async function renderTimeline(){
  if(!story)return;
  const c=document.getElementById('timeline-content');
  const tl=await db.timeline.where('storyId').equals(story.id).sortBy('order');
  let html=`<div class="timeline-current"><span>üìÖ</span><span class="timeline-label">Áï∂ÂâçÊôÇÈñìÔºö</span><span class="timeline-value">${esc(story.storyTime||'Êú™Ë®≠ÂÆö')}</span></div>`;
  if(!tl.length)html+='<div class="empty" style="padding:40px 20px"><div class="empty-icon">üìÖ</div><div class="empty-title">ÊôÇÈñìËª∏ÁÇ∫Á©∫</div></div>';
  else{
    html+='<div class="timeline-list">';
    tl.forEach(t=>{
      const cur=t.timeLabel===story.storyTime;
      const evts=(t.events||[]).map(e=>`<div class="timeline-event"><div class="timeline-event-dot"></div><span>${esc(e)}</span></div>`).join('');
      html+=`<div class="timeline-item ${cur?'current':''}"><div class="timeline-date">${esc(t.timeLabel)} ${cur?'‚Üê Áï∂Ââç':''}</div><div class="timeline-events">${evts}</div></div>`;
    });
    html+='</div>';
  }
  html+='<button class="action-btn primary" style="width:100%;margin-top:16px" onclick="addTimeline()">‚ûï Ê∑ªÂä†ÊôÇÈñìÈªû</button>';
  c.innerHTML=html;
}

// ÊôÇÈñìËª∏ÂäüËÉΩ
function addTimeline(){
  if(!story){toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã','warning');return;}
  document.getElementById('timeline-label').value='';
  document.getElementById('timeline-event').value='';
  document.getElementById('timeline-set-current').checked=true;
  showModal('timeline-modal');
}
async function saveTimeline(){
  const label=document.getElementById('timeline-label').value.trim();
  const event=document.getElementById('timeline-event').value.trim();
  const setCurrent=document.getElementById('timeline-set-current').checked;
  if(!label){toast('Ë´ãËº∏ÂÖ•ÊôÇÈñìÊ®ôË®ò','warning');return;}
  
  // Êü•ÊâæÊòØÂê¶Â∑≤Â≠òÂú®Áõ∏ÂêåÊôÇÈñìÈªû
  const existing=await db.timeline.where('storyId').equals(story.id).filter(t=>t.timeLabel===label).first();
  if(existing){
    // Ê∑ªÂä†‰∫ã‰ª∂Âà∞ÁèæÊúâÊôÇÈñìÈªû
    const events=existing.events||[];
    if(event)events.push(event);
    await db.timeline.update(existing.id,{events});
  }else{
    // ÂâµÂª∫Êñ∞ÊôÇÈñìÈªû
    const count=await db.timeline.where('storyId').equals(story.id).count();
    const tl={
      id:crypto.randomUUID(),
      storyId:story.id,
      timeLabel:label,
      events:event?[event]:[],
      order:count,
      messageId:msgs[msgs.length-1]?.id,
      createdAt:Date.now()
    };
    await db.timeline.add(tl);
  }
  
  // Ë®≠ÁÇ∫Áï∂ÂâçÊôÇÈñì
  if(setCurrent){
    story.storyTime=label;
    await db.stories.update(story.id,{storyTime:label});
  }
  
  closeModal('timeline-modal');
  toast('ÊôÇÈñìÈªûÂ∑≤Ê∑ªÂä†','success');
  renderTimeline();
}

async function timeJump(){
  if(!story){toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã','warning');return;}
  showInputDialog('ÊôÇÈñìË∑≥Ë∫ç','Ëº∏ÂÖ•Ë¶ÅË∑≥ËΩâÂà∞ÁöÑÊôÇÈñìÔºà‰æãÂ¶ÇÔºö‰∏âÂ§©Âæå„ÄÅ‰∏ÄÊúàÂçÅÊó•Ôºâ',async(input)=>{
    if(!input)return;
    showLoading('Ê≠£Âú®ËÆì AI ËôïÁêÜÊôÇÈñìË∑≥Ë∫ç...');
    try{
      const prompt=`ÊïÖ‰∫ãÊôÇÈñìÂæû„Äå${story.storyTime||'Êú™Áü•'}„ÄçË∑≥Ë∫çÂà∞„Äå${input}„Äç„ÄÇ
Ë´ãÁ∞°Áü≠ÊèèËø∞ÈÄôÊÆµÊôÇÈñìÂÖßÂèØËÉΩÁôºÁîüÁöÑ‰∫ãÊÉÖÔºà2-3Âè•Ë©±ÔºâÔºå‰ª•ÂèäÁï∂ÂâçÁöÑÂ†¥ÊôØÁãÄÊ≥Å„ÄÇ
‰øùÊåÅËàáÊïÖ‰∫ãÈ¢®Ê†º‰∏ÄËá¥„ÄÇ`;
      const resp=await callApi(prompt);
      hideLoading();
      
      // Êõ¥Êñ∞ÊïÖ‰∫ãÊôÇÈñì
      story.storyTime=input;
      await db.stories.update(story.id,{storyTime:input});
      
      // Ê∑ªÂä†Âà∞ÊôÇÈñìËª∏
      const count=await db.timeline.where('storyId').equals(story.id).count();
      await db.timeline.add({
        id:crypto.randomUUID(),
        storyId:story.id,
        timeLabel:input,
        events:['ÊôÇÈñìË∑≥Ë∫ç'],
        order:count,
        createdAt:Date.now()
      });
      
      // Ê∑ªÂä† AI ÁîüÊàêÁöÑÂÖßÂÆπ‰ΩúÁÇ∫Ê∂àÊÅØ
      const aiMsg={id:crypto.randomUUID(),storyId:story.id,branchId:story.currentBranchId,role:'assistant',content:`‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ${input} ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n${resp.content}`,tokens:resp.tokens,createdAt:Date.now()};
      await db.messages.add(aiMsg);
      msgs.push(aiMsg);
      renderMsgs();
      
      toast('ÊôÇÈñìË∑≥Ë∫çÂÆåÊàê','success');
      renderTimeline();
    }catch(e){
      hideLoading();
      toast('ÊôÇÈñìË∑≥Ë∫çÂ§±Êïó: '+e.message,'error');
    }
  });
}

// ‰ºèÁ≠Ü/‰∫ã‰ª∂
let fTab='foreshadow';
async function renderForeshadow(){
  if(!story)return;
  const c=document.getElementById('foreshadow-content');
  if(fTab==='foreshadow'){
    const fs=await db.foreshadowing.where('storyId').equals(story.id).toArray();
    const unres=fs.filter(f=>!f.isResolved),res=fs.filter(f=>f.isResolved);
    let html='<div class="section-title"><span>üìå</span><span>Êú™ÂõûÊî∂ÁöÑ‰ºèÁ≠Ü</span></div>';
    if(!unres.length)html+='<div style="text-align:center;padding:20px;color:var(--text-tertiary)">Êö´ÁÑ°</div>';
    else unres.forEach(f=>{const w=f.mentionCount>30;html+=`<div class="f-card ${w?'warning':''}"><div class="f-card-header"><span class="f-card-icon">${w?'‚ö†Ô∏è':'üíú'}</span><span class="f-card-title">${esc(f.title)}</span></div><div class="f-card-desc">${esc(f.description)}</div><div class="f-card-meta"><span>üìç ${esc(f.timeLabel||'')}</span><span>Â∑≤ÈÅé ${f.mentionCount||0} Ê¢ùÂ∞çË©±</span></div></div>`;});
    if(res.length){html+=`<div class="section-title" style="margin-top:20px"><span>‚úÖ</span><span>Â∑≤ÂõûÊî∂ (${res.length})</span></div>`;res.forEach(f=>{html+=`<div class="f-card resolved"><div class="f-card-header"><span class="f-card-icon">‚úì</span><span class="f-card-title">${esc(f.title)}</span></div><div class="f-card-desc">Â∑≤ÂõûÊî∂</div></div>`;});}
    c.innerHTML=html;
  }else{
    const evts=await db.events.where('storyId').equals(story.id).reverse().toArray();
    let html='<div class="section-title"><span>üìã</span><span>ÈáçË¶Å‰∫ã‰ª∂Ë®òÈåÑ</span></div>';
    if(!evts.length)html+='<div style="text-align:center;padding:40px;color:var(--text-tertiary)">Êö´ÁÑ°</div>';
    else evts.forEach(e=>{const icons={character_change:'üíÄ',relation_change:'ü§ù',plot_twist:'‚ö°',other:'üìù'};html+=`<div class="f-card"><div class="f-card-header"><span class="f-card-icon">${icons[e.eventType]||'üìù'}</span><span class="f-card-title">${esc(e.title)}</span></div><div class="f-card-desc">${esc(e.description)}</div><div class="f-card-meta"><span>üìç ${esc(e.storyTime||'')}</span></div></div>`;});
    c.innerHTML=html;
  }
}
function switchFTab(t,el){fTab=t;document.querySelectorAll('#view-foreshadow .tab-btn').forEach(b=>b.classList.remove('active'));el.classList.add('active');renderForeshadow();}

// Ê∑ªÂä†‰ºèÁ≠ÜÊàñ‰∫ã‰ª∂
function addForeshadowOrEvent(){
  if(!story){toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã','warning');return;}
  if(fTab==='foreshadow'){
    showInputDialog('Ê∑ªÂä†‰ºèÁ≠Ü','Ëº∏ÂÖ•‰ºèÁ≠ÜÊ®ôÈ°å',async(title)=>{
      if(!title)return;
      showInputDialog('‰ºèÁ≠ÜÊèèËø∞','ÊèèËø∞ÈÄôÂÄã‰ºèÁ≠ÜÁöÑÂÖßÂÆπÔºàÂèØÈÅ∏Ôºâ',async(desc)=>{
        const f={id:crypto.randomUUID(),storyId:story.id,messageId:msgs[msgs.length-1]?.id,title,description:desc||'',isResolved:false,mentionCount:0,timeLabel:story.storyTime,createdAt:Date.now()};
        await db.foreshadowing.add(f);
        toast('‰ºèÁ≠ÜÂ∑≤Ê∑ªÂä†','success');
        renderForeshadow();
      });
    });
  }else{
    showInputDialog('Ê∑ªÂä†‰∫ã‰ª∂','Ëº∏ÂÖ•‰∫ã‰ª∂Ê®ôÈ°å',async(title)=>{
      if(!title)return;
      showInputDialog('‰∫ã‰ª∂ÊèèËø∞','ÊèèËø∞ÈÄôÂÄã‰∫ã‰ª∂ÔºàÂèØÈÅ∏Ôºâ',async(desc)=>{
        const e={id:crypto.randomUUID(),storyId:story.id,messageId:msgs[msgs.length-1]?.id,title,description:desc||'',eventType:'other',storyTime:story.storyTime,createdAt:Date.now()};
        await db.events.add(e);
        toast('‰∫ã‰ª∂Â∑≤Ê∑ªÂä†','success');
        renderForeshadow();
      });
    });
  }
}

// AI ÂàÜÊûê‰ºèÁ≠Ü
async function aiAnalyzeForeshadow(){
  if(!story){toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã','warning');return;}
  showLoading('AI ÂàÜÊûê‰∏≠...');
  try{
    const fs=await db.foreshadowing.where('storyId').equals(story.id).filter(f=>!f.isResolved).toArray();
    const prompt=`Ë´ãÂàÜÊûê‰ª•‰∏ãÊïÖ‰∫ã‰∏≠ÁöÑ‰ºèÁ≠ÜÔºåÂà§Êñ∑Âì™‰∫õÂèØËÉΩÈúÄË¶ÅÂõûÊî∂Ôºå‰∏¶Áµ¶Âá∫ÂõûÊî∂Âª∫Ë≠∞Ôºö

Áï∂Ââç‰ºèÁ≠ÜÔºö
${fs.map(f=>`- ${f.title}Ôºö${f.description||'ÁÑ°ÊèèËø∞'}ÔºàÂ∑≤ÈÅé${f.mentionCount||0}Ê¢ùÂ∞çË©±Ôºâ`).join('\n')}

ÊúÄËøëÁöÑÊïÖ‰∫ãÂÖßÂÆπÔºö
${msgs.slice(-10).map(m=>m.content.slice(0,200)).join('\n\n')}

Ë´ãÊåáÂá∫Ôºö
1. Âì™‰∫õ‰ºèÁ≠ÜÂèØËÉΩË¢´ÈÅ∫Âøò‰∫ÜÈúÄË¶ÅÂÑòÂø´ÂõûÊî∂
2. Âì™‰∫õ‰ºèÁ≠ÜËàáÁï∂ÂâçÂäáÊÉÖÁõ∏ÈóúÂèØ‰ª•Ëá™ÁÑ∂ÂõûÊî∂
3. Â¶Ç‰ΩïÂÑ™ÈõÖÂú∞ÂõûÊî∂ÈÄô‰∫õ‰ºèÁ≠Ü`;
    const resp=await callApi(prompt);
    hideLoading();
    showAlert('AI ‰ºèÁ≠ÜÂàÜÊûê',resp.content);
  }catch(e){
    hideLoading();
    toast('ÂàÜÊûêÂ§±Êïó: '+e.message,'error');
  }
}

// È°ØÁ§∫Ë≠¶Âëä/‰ø°ÊÅØÂΩàÁ™ó
function showAlert(title,content){
  showConfirm(content,null,false,title);
}

// Â≠òÊ™î
async function renderSaves(){
  if(!story)return;
  const c=document.getElementById('saves-content');
  const saves=await db.saves.where('storyId').equals(story.id).reverse().toArray();
  const manual=saves.filter(s=>!s.isAuto),auto=saves.filter(s=>s.isAuto);
  let html=`<div class="section-title"><span>üíæ</span><span>ÊâãÂãïÂ≠òÊ™î (${manual.length}/8)</span></div>`;
  if(!manual.length)html+='<div style="text-align:center;padding:20px;color:var(--text-tertiary)">Êö´ÁÑ°</div>';
  else manual.forEach(s=>html+=renderSaveCard(s));
  html+=`<div class="section-title" style="margin-top:20px"><span>üîÑ</span><span>Ëá™ÂãïÂ≠òÊ™î (${auto.length}/5)</span></div>`;
  if(!auto.length)html+='<div style="text-align:center;padding:20px;color:var(--text-tertiary)">Êö´ÁÑ°</div>';
  else auto.forEach(s=>html+=renderSaveCard(s,true));
  c.innerHTML=html;
}
function renderSaveCard(s,isAuto=false){
  const t=timeAgo(s.createdAt),tagCls=s.labelColor==='#EF4444'?'be':s.labelColor==='#F59E0B'?'key':'';
  return `<div class="save-card"><div class="save-card-header"><div class="save-card-title">${isAuto?`Ëá™Âãï #${s.slotIndex}`:`Â≠òÊ™î ${s.slotIndex}`}${s.label?`<span class="save-card-tag ${tagCls}">${esc(s.label)}</span>`:''}</div></div><div class="save-card-preview">${esc(s.preview||'')}</div><div class="save-card-meta"><span>üìç ${esc(s.storyTime||'')}</span><span>üïê ${t}</span></div><div class="save-card-actions"><button class="action-btn primary" onclick="loadSave('${s.id}')">ËÆÄÂèñ</button>${isAuto?`<button class="action-btn secondary" onclick="toast('ËΩâÁÇ∫ÊâãÂãï')">ËΩâÁÇ∫ÊâãÂãï</button>`:`<button class="action-btn secondary" onclick="toast('Ë¶ÜËìã')">Ë¶ÜËìã</button>`}<button class="action-btn secondary" onclick="deleteSave('${s.id}')">üóëÔ∏è</button></div></div>`;
}
async function createSave(){
  if(!story||!msgs.length){toast('Ê≤íÊúâÂèØ‰øùÂ≠òÁöÑÂÖßÂÆπ','warning');return;}
  const existing=await db.saves.where('storyId').equals(story.id).filter(s=>!s.isAuto).toArray();
  if(existing.length>=8){toast('Â≠òÊ™îÊßΩ‰ΩçÂ∑≤Êªø','warning');return;}
  const slot=existing.length+1,last=msgs[msgs.length-1];
  const save={id:crypto.randomUUID(),storyId:story.id,slotIndex:slot,isAuto:false,label:'',preview:last?.content?.slice(0,100)||'',storyTime:story.storyTime||'',branchId:story.currentBranchId,messageId:last?.id,createdAt:Date.now()};
  await db.saves.put(save);
  toast('Â≠òÊ™îÂâµÂª∫ÊàêÂäüÔºÅ','success');
  renderSaves();
}
async function loadSave(id){showConfirm('Á¢∫ÂÆöË¶ÅËÆÄÂèñÊ≠§Â≠òÊ™îÂóéÔºüÁï∂ÂâçÈÄ≤Â∫¶Â∞á‰∏üÂ§±„ÄÇ',async()=>{showLoading('ËÆÄÂèñÂ≠òÊ™î...');try{const s=await db.saves.get(id);if(!s)throw new Error('Â≠òÊ™î‰∏çÂ≠òÂú®');await db.stories.update(story.id,{currentBranchId:s.branchId,currentMessageId:s.messageId,storyTime:s.storyTime});await openStory(story.id);toast('Â≠òÊ™îËÆÄÂèñÊàêÂäüÔºÅ','success');}catch(e){toast('ËÆÄÂèñÂ§±Êïó: '+e.message,'error');}hideLoading();});}
async function deleteSave(id){showConfirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Â≠òÊ™îÂóéÔºü',async()=>{await db.saves.delete(id);toast('Â≠òÊ™îÂ∑≤Âà™Èô§','success');renderSaves();});}

// Êåá‰ª§
async function renderInst(){
  const c=document.getElementById('inst-list');
  const list=await db.instructions.toArray();
  if(!list.length){c.innerHTML='<div class="empty"><div class="empty-icon">üìú</div><div class="empty-title">ÈÇÑÊ≤íÊúâÊåá‰ª§</div><div class="empty-desc">Â∞éÂÖ• .md Êàñ .txt Êñá‰ª∂‰ΩúÁÇ∫Ë®≠ÂÆöÊåá‰ª§</div><button class="empty-btn" onclick="importInst()">Â∞éÂÖ•Êåá‰ª§</button></div>';return;}
  
  // Áç≤ÂèñÊâÄÊúâÁ∂ÅÂÆöÈóú‰øÇÂíåÊïÖ‰∫ãÂêçÁ®±
  const allBindings = await db.storyInstructions.toArray();
  const allStories = await db.stories.toArray();
  const storyMap = Object.fromEntries(allStories.map(s=>[s.id, s.title]));
  
  // ÁÇ∫ÊØèÂÄãÊåá‰ª§ÊâæÂà∞Á∂ÅÂÆöÁöÑÊïÖ‰∫ã
  const enrichedList = list.map(inst => {
    const bindings = allBindings.filter(b => b.instructionId === inst.id);
    const boundStoryNames = bindings.map(b => storyMap[b.storyId]).filter(Boolean);
    return {
      ...inst,
      boundStoryNames: boundStoryNames.length ? boundStoryNames : null
    };
  });
  
  c.innerHTML=enrichedList.map(i=>`<div class="inst-card"><div class="inst-header"><div class="inst-icon">üìÑ</div><div class="inst-info"><div class="inst-name">${esc(i.name)}</div><div class="inst-meta">${fmtNum(i.content?.length||0)} Â≠ó</div><div class="inst-binding">Á∂ÅÂÆöÔºö${i.boundStoryNames ? i.boundStoryNames.map(n=>esc(n)).join(', ') : 'Êú™Á∂ÅÂÆö'}</div></div></div>${i.content?`<div class="inst-preview">${esc(i.content.slice(0,100))}...</div>`:''}<div class="inst-actions"><button class="action-btn secondary" onclick="previewInst('${i.id}')">È†êË¶Ω</button><button class="action-btn secondary" onclick="editInst('${i.id}')">Á∑®ËºØ</button><button class="action-btn secondary" onclick="deleteInst('${i.id}')">üóëÔ∏è</button></div></div>`).join('');
}

// È†êË¶ΩÊåá‰ª§
async function previewInst(id){
  const inst = await db.instructions.get(id);
  if(!inst) return;
  showConfirm(inst.content || 'ÔºàÁ©∫ÂÖßÂÆπÔºâ', null, false, `üìÑ ${inst.name}`);
}

// Á∑®ËºØÊåá‰ª§
let editInstId = null;
async function editInst(id){
  const inst = await db.instructions.get(id);
  if(!inst) return;
  editInstId = id;
  document.getElementById('edit-inst-name').value = inst.name;
  document.getElementById('edit-inst-content').value = inst.content || '';
  showModal('edit-inst-modal');
}

async function saveEditInst(){
  if(!editInstId) return;
  const name = document.getElementById('edit-inst-name').value.trim();
  const content = document.getElementById('edit-inst-content').value;
  if(!name){toast('Ë´ãËº∏ÂÖ•ÂêçÁ®±','warning');return;}
  await db.instructions.update(editInstId, { name, content });
  closeModal('edit-inst-modal');
  toast('Êåá‰ª§Â∑≤Êõ¥Êñ∞','success');
  renderInst();
  editInstId = null;
}
function importInst(){
  const input=document.getElementById('file-input');
  input.onchange=async e=>{
    const f=e.target.files[0];if(!f)return;
    const content=await f.text();
    const inst={id:crypto.randomUUID(),name:f.name,content,createdAt:Date.now()};
    await db.instructions.put(inst);
    toast('Êåá‰ª§Â∞éÂÖ•ÊàêÂäüÔºÅ','success');
    renderInst();
    input.value='';
  };
  input.click();
}
async function deleteInst(id){showConfirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Êåá‰ª§ÂóéÔºü',async()=>{await db.instructions.delete(id);await db.storyInstructions.where('instructionId').equals(id).delete();toast('Êåá‰ª§Â∑≤Âà™Èô§','success');renderInst();});}

// APIÈ†êË®≠
async function renderApi(){
  const c=document.getElementById('api-list');if(!c)return;
  const list=await db.apiPresets.toArray();
  if(!list.length){c.innerHTML='<div class="empty"><div class="empty-icon">ü§ñ</div><div class="empty-title">Êú™ÈÖçÁΩÆ API</div><div class="empty-desc">Ê∑ªÂä† Claude Êàñ OpenAI API ‰æÜÈñãÂßã</div><button class="empty-btn" onclick="addApi()">Ê∑ªÂä† API</button></div>';return;}
  c.innerHTML=list.map(p=>`<div class="api-card ${p.isActive?'active':''}"><div class="api-header" onclick="selectApi('${p.id}')"><span class="api-name">${esc(p.name)}</span>${p.isActive?'<span class="api-badge">‰ΩøÁî®‰∏≠</span>':''}</div><div class="api-info" onclick="selectApi('${p.id}')">${p.type==='anthropic'?'Anthropic':p.type==='openai'?'OpenAI':'Ëá™ÂÆöÁæ©'} ¬∑ ${esc(p.model)}</div><div class="api-actions" style="display:flex;gap:8px;margin-top:10px"><button class="action-btn secondary" onclick="editApi('${p.id}')">‚úèÔ∏è Á∑®ËºØ</button><button class="action-btn secondary" onclick="deleteApi('${p.id}')" style="color:var(--error)">üóëÔ∏è Âà™Èô§</button></div></div>`).join('')+`<div style="text-align:center;margin-top:16px"><button class="action-btn primary" style="width:auto;padding:12px 24px" onclick="addApi()">‚ûï Ê∑ªÂä†Êñ∞È†êË®≠</button></div>`;
}
function addApi(){
  editApiId=null;
  document.getElementById('api-name').value='';
  document.getElementById('api-type').value='anthropic';
  document.getElementById('api-key').value='';
  document.getElementById('api-model').value='';
  document.getElementById('api-url').value='';
  // ÈáçÁΩÆËá™ÂãïË£úÂÖ®Âæ©ÈÅ∏Ê°ÜÁÇ∫ÈÅ∏‰∏≠ÁãÄÊÖã
  const autoCompleteCheckbox = document.getElementById('api-url-autocomplete');
  if(autoCompleteCheckbox) autoCompleteCheckbox.checked = true;
  updateApiFields();
  showModal('api-modal');
}
async function editApi(id){
  const p=await db.apiPresets.get(id);
  if(!p)return;
  editApiId=id;
  document.getElementById('api-name').value=p.name||'';
  document.getElementById('api-type').value=p.type||'anthropic';
  document.getElementById('api-key').value=p.apiKey||'';
  document.getElementById('api-url').value=p.url||'';
  updateApiFields();
  document.getElementById('api-model').value=p.model||'';
  // Âä†ËºâËá™ÂãïË£úÂÖ®Ë®≠ÁΩÆ
  const autoCompleteCheckbox = document.getElementById('api-url-autocomplete');
  if(autoCompleteCheckbox) autoCompleteCheckbox.checked = p.urlAutoComplete !== false;
  showModal('api-modal');
}
async function deleteApi(id){
  showConfirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§ API È†êË®≠ÂóéÔºü',async()=>{
    const p=await db.apiPresets.get(id);
    await db.apiPresets.delete(id);
    if(p&&p.isActive){
      const first=await db.apiPresets.toCollection().first();
      if(first)await db.apiPresets.update(first.id,{isActive:true});
    }
    toast('API È†êË®≠Â∑≤Âà™Èô§','success');
    renderApi();
  });
}
function updateApiFields(){
  const t=document.getElementById('api-type').value,m=document.getElementById('api-model'),dl=document.getElementById('model-list'),u=document.getElementById('api-url-group');
  if(t==='anthropic'){
    dl.innerHTML='<option value="claude-sonnet-4-20250514">Claude Sonnet 4</option><option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option><option value="claude-3-opus-20240229">Claude 3 Opus</option><option value="claude-3-5-haiku-20241022">Claude 3.5 Haiku</option>';
    m.placeholder='ÈÅ∏ÊìáÊàñËº∏ÂÖ•Ê®°ÂûãÂêçÁ®±';
    u.classList.add('hidden');
  }else if(t==='openai'){
    dl.innerHTML='<option value="gpt-4o">GPT-4o</option><option value="gpt-4o-mini">GPT-4o Mini</option><option value="gpt-4-turbo">GPT-4 Turbo</option><option value="gpt-3.5-turbo">GPT-3.5 Turbo</option><option value="o1">o1</option><option value="o1-mini">o1-mini</option>';
    m.placeholder='ÈÅ∏ÊìáÊàñËº∏ÂÖ•Ê®°ÂûãÂêçÁ®±';
    u.classList.add('hidden');
  }else{
    dl.innerHTML='';
    m.placeholder='Ëº∏ÂÖ•Ê®°ÂûãÂêçÁ®±';
    u.classList.remove('hidden');
  }
}
async function saveApi(){
  const name=document.getElementById('api-name').value.trim(),type=document.getElementById('api-type').value,apiKey=document.getElementById('api-key').value.trim(),model=document.getElementById('api-model').value.trim(),url=document.getElementById('api-url').value.trim();
  const urlAutoComplete = document.getElementById('api-url-autocomplete')?.checked ?? true;
  if(!name||!apiKey){toast('Ë´ãÂ°´ÂØ´ÂêçÁ®±Âíå API Key','warning');return;}
  if(!model){toast('Ë´ãËº∏ÂÖ•ÊàñÈÅ∏ÊìáÊ®°Âûã','warning');return;}
  if(type==='custom'&&!url){toast('Ë´ãËº∏ÂÖ• API URL','warning');return;}
  
  // Â¶ÇÊûúÊòØÁ∑®ËºØÔºå‰øùÁïôÂéüÊú¨ÁöÑ isActive ÁãÄÊÖãÔºõÂ¶ÇÊûúÊòØÊñ∞Âª∫ÔºåË®≠ÁÇ∫ true ‰∏¶ÂèñÊ∂àÂÖ∂‰ªñÁöÑÊøÄÊ¥ªÁãÄÊÖã
  let isActive = true;
  if(editApiId){
    const existing = await db.apiPresets.get(editApiId);
    isActive = existing?.isActive || false;
  } else {
    // Êñ∞Âª∫ÊôÇÔºåÂèñÊ∂àÂÖ∂‰ªñ API ÁöÑÊøÄÊ¥ªÁãÄÊÖãÔºåËÆìÊñ∞ÁöÑÊàêÁÇ∫ÊøÄÊ¥ªÁãÄÊÖã
    await db.apiPresets.toCollection().modify({isActive: false});
  }
  
  const p={id:editApiId||crypto.randomUUID(),name,type,apiKey,model,url:type==='custom'?url:'',urlAutoComplete,isActive,createdAt:Date.now()};
  await db.apiPresets.put(p);
  closeModal('api-modal');
  toast('API È†êË®≠Â∑≤‰øùÂ≠ò' + (isActive ? 'ÔºàÂ∑≤ÊøÄÊ¥ªÔºâ' : ''), 'success');
  renderApi();
}
async function testApi(){
  const type=document.getElementById('api-type').value,apiKey=document.getElementById('api-key').value.trim(),model=document.getElementById('api-model').value.trim(),url=document.getElementById('api-url').value.trim();
  const resultEl=document.getElementById('api-test-result');
  resultEl.style.display='block';
  resultEl.style.color='var(--text-secondary)';
  resultEl.innerHTML='<span class="typing"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></span> Ê∏¨Ë©¶ÈÄ£Êé•‰∏≠...';
  if(!apiKey){resultEl.style.color='var(--error)';resultEl.textContent='‚ùå Ë´ãÂÖàÂ°´ÂØ´ API Key';return;}
  if(!model){resultEl.style.color='var(--error)';resultEl.textContent='‚ùå Ë´ãÂÖàÂ°´ÂØ´Ê®°ÂûãÂêçÁ®±';return;}
  
  // ÂâµÂª∫Ë∂ÖÊôÇÊéßÂà∂
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 30000);
  
  try{
    let r;
    // iOS ÂÖºÂÆπÊÄßÔºöÊòéÁ¢∫Ë®≠ÁΩÆ mode Âíå credentials
    const fetchOptions = { 
      signal: controller.signal,
      method: 'POST',
      mode: 'cors',
      credentials: 'omit',
      cache: 'no-cache'
    };
    
    if(type==='anthropic'){
      r=await fetch('https://api.anthropic.com/v1/messages',{
        ...fetchOptions,
        headers:{
          'Content-Type':'application/json',
          'x-api-key':apiKey,
          'anthropic-version':'2023-06-01',
          'anthropic-dangerous-direct-browser-access':'true'
        },
        body:JSON.stringify({model:model,max_tokens:10,messages:[{role:'user',content:'Hi'}]})
      });
    }else if(type==='openai'){
      r=await fetch('https://api.openai.com/v1/chat/completions',{
        ...fetchOptions,
        headers:{
          'Content-Type':'application/json',
          'Authorization':`Bearer ${apiKey}`
        },
        body:JSON.stringify({model:model,messages:[{role:'user',content:'Hi'}],max_tokens:10})
      });
    }else{
      if(!url){resultEl.style.color='var(--error)';resultEl.textContent='‚ùå Ë´ãÂÖàÂ°´ÂØ´ API URL';return;}
      const autoComplete = document.getElementById('api-url-autocomplete')?.checked ?? true;
      const apiUrl = normalizeApiUrl(url, autoComplete);
      console.log('Testing Custom API:', url, '‚Üí', apiUrl, '(autoComplete:', autoComplete, ')');
      r=await fetch(apiUrl,{
        ...fetchOptions,
        headers:{
          'Content-Type':'application/json',
          'Authorization':`Bearer ${apiKey}`
        },
        body:JSON.stringify({model:model,messages:[{role:'user',content:'Hi'}],max_tokens:10})
      });
    }
    clearTimeout(timeoutId);
    const text = await r.text();
    console.log('Test API response:', r.status, text.slice(0, 500));
    if(r.ok){
      try {
        const d = JSON.parse(text);
        const hasValidStructure = d.choices?.[0]?.message !== undefined || d.content?.[0] !== undefined;
        if(hasValidStructure) {
          resultEl.style.color='var(--success)';
          resultEl.textContent='‚úÖ ÈÄ£Êé•ÊàêÂäüÔºÅAPI ÂèØÊ≠£Â∏∏‰ΩøÁî®';
        } else {
          resultEl.style.color='var(--warning)';
          resultEl.textContent='‚ö†Ô∏è ÈÄ£Êé•ÊàêÂäü‰ΩÜËøîÂõûÊ†ºÂºèÁï∞Â∏∏';
        }
      } catch(e) {
        resultEl.style.color='var(--error)';
        resultEl.textContent='‚ùå ËøîÂõûÈùûJSON: ' + text.slice(0, 50);
      }
    }else{
      try {
        const e = JSON.parse(text);
        resultEl.style.color='var(--error)';
        resultEl.textContent='‚ùå ' + (e.error?.message || `HTTP ${r.status}`);
      } catch(e) {
        resultEl.style.color='var(--error)';
        resultEl.textContent='‚ùå HTTP ' + r.status + ': ' + text.slice(0, 50);
      }
    }
  }catch(e){
    clearTimeout(timeoutId);
    resultEl.style.color='var(--error)';
    console.error('Test API error:', e);
    const errMsg = e.message || e.toString() || 'Êú™Áü•ÈåØË™§';
    if(e.name === 'AbortError') {
      resultEl.innerHTML='‚ùå ÈÄ£Êé•Ë∂ÖÊôÇÔºà30ÁßíÔºâ<br><span style="font-size:11px;color:var(--text-tertiary)">Ë´ãÊ™¢Êü•Á∂≤Áµ°Êàñ URL ÊòØÂê¶Ê≠£Á¢∫</span>';
    } else if(errMsg.includes('Load failed') || errMsg.includes('Failed to fetch') || errMsg.includes('NetworkError') || e.name === 'TypeError') {
      // Ê™¢Ê∏¨ÊòØÂê¶ÁÇ∫ iOS
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      let hint = 'ÁÄèË¶ΩÂô®ÂÆâÂÖ®Á≠ñÁï•ÈòªÊ≠¢‰∫ÜË´ãÊ±Ç„ÄÇ';
      if(isIOS) {
        hint += '<br>iOS Ë®≠ÂÇôÂèØËÉΩÈúÄË¶ÅÔºö<br>‚Ä¢ Ê™¢Êü• Safari Ë®≠ÁΩÆ‰∏≠ÁöÑ„ÄåÈòªÊ≠¢Ë∑®Á∂≤Á´ôËøΩËπ§„Äç<br>‚Ä¢ ÂòóË©¶ÈóúÈñâ„ÄåÈö±ÁßÅÁÄèË¶Ω„ÄçÊ®°Âºè';
      }
      hint += '<br>‚Ä¢ Á¢∫Ë™ç API ÊúçÂãôÂ∑≤ÈñãÂïü CORS ÊîØÊåÅ';
      resultEl.innerHTML='‚ùå ÈÄ£Êé•Â§±Êïó<br><span style="font-size:11px;color:var(--text-tertiary)">' + hint + '</span>';
    } else {
      resultEl.innerHTML='‚ùå ÈÄ£Êé•Â§±Êïó: ' + errMsg;
    }
  }
}
async function selectApi(id){await db.apiPresets.toCollection().modify({isActive:false});await db.apiPresets.update(id,{isActive:true});toast('Â∑≤ÂàáÊèõ API','success');renderApi();}

// Ê≤âÊµ∏Ê®°Âºè
let immIdx=0,immPars=[];
function enterImm(){
  if(!msgs.length){toast('Ê≤íÊúâÂÖßÂÆπ','warning');return;}
  closeAll();
  immPars=msgs.filter(m=>m.role==='assistant').map(m=>m.content);
  immIdx=0;
  document.getElementById('immersive').classList.add('active');
  showImm();
}
function showImm(){const c=document.getElementById('immersive-content');if(immIdx<immPars.length){c.innerHTML=marked.parse(immPars[immIdx]);document.getElementById('imm-progress').style.width=((immIdx+1)/immPars.length*100)+'%';}}
function nextImm(){immIdx++;if(immIdx>=immPars.length){exitImm();return;}showImm();}
function exitImm(){document.getElementById('immersive').classList.remove('active');}

// Èù¢ÊùøÂíåËèúÂñÆ
function showSheet(){
  document.getElementById('overlay').classList.add('active');
  const sheet=document.getElementById('sheet');
  // ÂÖ®Â±èÊ®°Âºè‰∏ã‰∏çÈôêÂà∂ÂØ¨Â∫¶
  if(settings.screen==='fullscreen'){
    sheet.style.maxWidth='100%';
  }else{
    sheet.style.maxWidth='420px';
  }
  sheet.classList.add('active');
}
function showMore(e){
  e.stopPropagation();
  const m=document.getElementById('more-menu');
  m.style.top='100px';
  m.style.right='16px';
  // v19: Ê†πÊìöÊ®°ÂºèÈ°ØÁ§∫/Èö±ËóèÁ∂ìÁáüÊ®°ÂºèÈÅ∏È†Ö
  const isSimMode = story?.mode === 'simulation';
  m.querySelectorAll('.sim-only').forEach(el => {
    el.style.display = isSimMode ? '' : 'none';
  });
  m.classList.add('active');
}
function showMsgMenu(e,id){e.preventDefault();e.stopPropagation();selMsgId=id;const m=document.getElementById('msg-menu');m.style.top=Math.min(e.clientY,window.innerHeight-300)+'px';m.style.left=Math.min(e.clientX,window.innerWidth-180)+'px';m.classList.add('active');}
function hideMenu(){document.querySelectorAll('.context-menu').forEach(m=>m.classList.remove('active'));}

// ÊïÖ‰∫ãËèúÂñÆÁõ∏Èóú
let menuStoryId = null;
function showStoryMenu(id) {
  menuStoryId = id;
  const m = document.getElementById('story-menu');
  m.style.top = '120px';
  m.style.left = '50%';
  m.style.transform = 'translateX(-50%)';
  m.classList.add('active');
}
async function editStoryCover() {
  hideMenu();
  if (!menuStoryId) return;
  // Ëá®ÊôÇË®≠ÁΩÆ story ‰ª•‰æø‰∏äÂÇ≥
  const tempStory = await db.stories.get(menuStoryId);
  if (!tempStory) return;
  story = tempStory;
  imageUploadTarget = 'storyCover';
  document.getElementById('image-upload').click();
}
async function toggleStoryPin() {
  hideMenu();
  if (!menuStoryId) return;
  const s = await db.stories.get(menuStoryId);
  if (!s) return;
  await db.stories.update(menuStoryId, { isPinned: !s.isPinned });
  toast(s.isPinned ? 'Â∑≤ÂèñÊ∂àÁΩÆÈ†Ç' : 'Â∑≤ÁΩÆÈ†Ç', 'success');
  await renderStories();
}
async function deleteStoryFromMenu() {
  hideMenu();
  if (!menuStoryId) return;
  const s = await db.stories.get(menuStoryId);
  if (!s) return;
  showConfirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§„Äå${s.title}„ÄçÂóéÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Âæ©ÔºÅ`, async () => {
    await db.stories.delete(menuStoryId);
    await db.messages.where('storyId').equals(menuStoryId).delete();
    await db.branches.where('storyId').equals(menuStoryId).delete();
    toast('ÊïÖ‰∫ãÂ∑≤Âà™Èô§', 'success');
    await renderStories();
  }, true);
}

function closeAll(){document.getElementById('overlay').classList.remove('active');document.getElementById('sheet').classList.remove('active');hideMenu();}
document.addEventListener('click',e=>{if(!e.target.closest('.context-menu')&&!e.target.closest('.nav-btn'))hideMenu();});

// Modal
function showModal(id){document.getElementById('overlay').classList.add('active');document.getElementById(id).classList.add('active');}
function closeModal(id){
  document.getElementById('overlay').classList.remove('active');
  document.getElementById(id).classList.remove('active');
  
  // ÁâπÊÆäËôïÁêÜÔºöËßíËâ≤Á∑®ËºØÊ®°ÊÖãÊ°ÜÈóúÈñâÊôÇÈáçÁΩÆÁãÄÊÖã
  if(id === 'char-add-modal'){
    const modal = document.getElementById('char-add-modal');
    if(modal){
      modal.querySelector('.modal-title').textContent = '‚ûï Ê∑ªÂä†ËßíËâ≤';
      const confirmBtn = modal.querySelector('.modal-btn.confirm');
      if(confirmBtn) confirmBtn.onclick = saveCharacterManual;
    }
    currentCharacterId = null;
  }
}
function showConfirm(msg,cb,danger=false,title='Á¢∫Ë™ç'){
  document.getElementById('confirm-title').textContent=title;
  const contentEl = document.getElementById('confirm-content');
  contentEl.textContent=msg;
  contentEl.style.whiteSpace=title==='Á¢∫Ë™ç'?'normal':'pre-wrap';
  contentEl.style.maxHeight='50vh';
  contentEl.style.overflowY='auto';
  const b=document.getElementById('confirm-btn');
  const cancelBtn = document.querySelector('#confirm-modal .modal-btn.cancel');
  b.className=danger?'modal-btn danger':'modal-btn confirm';
  b.style.display=cb?'':'none';
  // Áï∂Ê≤íÊúâÁ¢∫Ë™çÂõûË™øÊôÇÔºåÂ∞áÂèñÊ∂àÊåâÈàïÊîπÁÇ∫"ÈóúÈñâ"
  cancelBtn.textContent = cb ? 'ÂèñÊ∂à' : 'ÈóúÈñâ';
  confirmCb=cb;
  showModal('confirm-modal');
}
function confirmAction(){closeModal('confirm-modal');if(confirmCb){confirmCb();confirmCb=null;}}
function showInputDialog(title,ph,cb){document.getElementById('input-title').textContent=title;document.getElementById('modal-input').placeholder=ph;document.getElementById('modal-input').value='';inputCb=cb;showModal('input-modal');}
function confirmInput(){const v=document.getElementById('modal-input').value.trim();closeModal('input-modal');if(inputCb){inputCb(v);inputCb=null;}}

// Ê∂àÊÅØÊìç‰Ωú
async function markForeshadow(){hideMenu();showInputDialog('Ê®ôË®ò‰ºèÁ≠Ü','Ëº∏ÂÖ•‰ºèÁ≠ÜÊ®ôÈ°å',async t=>{if(!t)return;const f={id:crypto.randomUUID(),storyId:story.id,messageId:selMsgId,title:t,description:'',isResolved:false,mentionCount:0,createdAt:Date.now()};await db.foreshadowing.put(f);toast('‰ºèÁ≠ÜÂ∑≤Ê®ôË®ò','success');});}
function copyMsg(){hideMenu();const m=msgs.find(x=>x.id===selMsgId);if(m){navigator.clipboard.writeText(m.content);toast('Â∑≤Ë§áË£Ω','success');}}

// Âà™Èô§Ê∂àÊÅØ
function deleteMsg(){
  hideMenu();
  showConfirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÊ¢ùÊ∂àÊÅØÂóéÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§Èä∑„ÄÇ',async()=>{
    const idx=msgs.findIndex(m=>m.id===selMsgId);
    if(idx===-1)return;
    await db.messages.delete(selMsgId);
    msgs.splice(idx,1);
    const el=document.querySelector(`.msg[data-id="${selMsgId}"]`);
    if(el)el.remove();
    toast('Ê∂àÊÅØÂ∑≤Âà™Èô§','success');
  });
}

// Á∑®ËºØÊ∂àÊÅØ
function editMsg(){
  hideMenu();
  const m=msgs.find(x=>x.id===selMsgId);
  if(!m)return;
  document.getElementById('edit-msg-content').value=m.content;
  showModal('edit-msg-modal');
}
async function saveEditMsg(){
  const content=document.getElementById('edit-msg-content').value.trim();
  if(!content){toast('ÂÖßÂÆπ‰∏çËÉΩÁÇ∫Á©∫','warning');return;}
  const m=msgs.find(x=>x.id===selMsgId);
  if(!m)return;
  m.content=content;
  await db.messages.update(selMsgId,{content});
  const el=document.querySelector(`.msg[data-id="${selMsgId}"]`);
  if(el)el.innerHTML=marked.parse(content);
  closeModal('edit-msg-modal');
  toast('Ê∂àÊÅØÂ∑≤Êõ¥Êñ∞','success');
}

// ÈáçÊñ∞ÁîüÊàê
function regenerateMsg(){
  hideMenu();
  const m=msgs.find(x=>x.id===selMsgId);
  if(!m||m.role!=='assistant'){toast('Âè™ËÉΩÈáçÊñ∞ÁîüÊàê AI Ê∂àÊÅØ','warning');return;}
  document.getElementById('regen-note').value='';
  showModal('regen-modal');
}
async function doRegenerate(){
  closeModal('regen-modal');
  if(generating){toast('Ê≠£Âú®ÁîüÊàê‰∏≠','warning');return;}
  const note=document.getElementById('regen-note').value.trim();
  const idx=msgs.findIndex(m=>m.id===selMsgId);
  if(idx===-1)return;
  
  // ÊâæÂà∞ÈÄôÊ¢ùÊ∂àÊÅØ‰πãÂâçÁöÑÁî®Êà∂Ê∂àÊÅØ
  let userMsg='';
  for(let i=idx-1;i>=0;i--){
    if(msgs[i].role==='user'){userMsg=msgs[i].content;break;}
  }
  if(note)userMsg+='\n\n[Ë£úÂÖÖË™™ÊòéÔºö'+note+']';
  
  // Âà™Èô§Áï∂ÂâçÊ∂àÊÅØ
  await db.messages.delete(selMsgId);
  msgs.splice(idx,1);
  const el=document.querySelector(`.msg[data-id="${selMsgId}"]`);
  if(el)el.remove();
  
  // ÈáçÊñ∞ÁîüÊàê
  generating=true;
  showTyping();
  try{
    const resp=await callApi(userMsg);
    hideTyping();
    const aiMsg={id:crypto.randomUUID(),storyId:story.id,branchId:story.currentBranchId,role:'assistant',content:resp.content,tokens:resp.tokens,createdAt:Date.now()};
    await db.messages.add(aiMsg);
    msgs.push(aiMsg);
    await typewriter(aiMsg);
    toast('ÈáçÊñ∞ÁîüÊàêÂÆåÊàê','success');
  }catch(e){
    hideTyping();
    toast('ÁîüÊàêÂ§±Êïó: '+e.message,'error');
  }
  generating=false;
}

// ÂõûÊ∫ØÂà∞Ê≠§
function rollbackTo(){
  hideMenu();
  const idx=msgs.findIndex(m=>m.id===selMsgId);
  if(idx===-1)return;
  const deleteCount=msgs.length-idx-1;
  if(deleteCount===0){toast('Â∑≤Á∂ìÊòØÊúÄÊñ∞Ê∂àÊÅØ','info');return;}
  showConfirm(`Á¢∫ÂÆöË¶ÅÂõûÊ∫ØÂà∞Ê≠§Ê∂àÊÅØÂóéÔºüÂ∞áÂà™Èô§‰πãÂæåÁöÑ ${deleteCount} Ê¢ùÊ∂àÊÅØ„ÄÇ`,async()=>{
    const toDelete=msgs.slice(idx+1).map(m=>m.id);
    await db.messages.bulkDelete(toDelete);
    msgs=msgs.slice(0,idx+1);
    renderMsgs();
    toast('Â∑≤ÂõûÊ∫Ø','success');
  });
}

// Ë®òÊÜ∂ÁÆ°ÁêÜ
async function showMemoryManager(){
  closeAll();
  if(!story){toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã','warning');return;}
  
  // Ë®àÁÆó Token ‰º∞ÁÆó
  let totalChars = 0;
  msgs.forEach(m => totalChars += m.content.length);
  const estimatedTokens = Math.round(totalChars / 2); // Á≤óÁï•‰º∞ÁÆóÔºö‰∏≠ÊñáÁ¥Ñ 2 Â≠óÁ¨¶/token
  const tokenColor = estimatedTokens > 8000 ? 'var(--error)' : estimatedTokens > 4000 ? 'var(--warning)' : 'var(--success)';
  
  // Ë®àÁÆóÂèó‰øùË≠∑Ê∂àÊÅØÊï∏
  const protectedMsgIds = new Set();
  const foreshadows = await db.foreshadowing.where('storyId').equals(story.id).toArray();
  const bookmarks = await db.bookmarks.where('storyId').equals(story.id).toArray();
  const plotTags = await db.plotTags.where('storyId').equals(story.id).toArray();
  foreshadows.forEach(f => protectedMsgIds.add(f.messageId));
  bookmarks.forEach(b => protectedMsgIds.add(b.messageId));
  plotTags.forEach(t => protectedMsgIds.add(t.messageId));
  
  // Ë®àÁÆóÊªæÂãïÊëòË¶ÅÊï∏
  const rollingSummaries = (story.rollingSummaries || []).length;
  
  // Êõ¥Êñ∞ UI
  document.getElementById('memory-msg-count').textContent = msgs.length;
  document.getElementById('memory-compressed').textContent = story.compressedCount || 0;
  document.getElementById('memory-summary-count').textContent = story.summaries?.length || 0;
  document.getElementById('memory-rolling-count').textContent = rollingSummaries;
  document.getElementById('memory-token-estimate').innerHTML = `‚âà <span style="color:${tokenColor}">${fmtNum(estimatedTokens)}</span> tokens`;
  
  const protectedInfo = document.getElementById('memory-protected-info');
  if(protectedMsgIds.size > 0){
    protectedInfo.textContent = `‚ö†Ô∏è ${protectedMsgIds.size} Ê¢ùÈáçË¶ÅÊ∂àÊÅØÂèó‰øùË≠∑Ôºà‰ºèÁ≠Ü/Êõ∏Á±§/Ê®ôÁ±§Ôºâ`;
    protectedInfo.style.display = '';
  } else {
    protectedInfo.style.display = 'none';
  }
  
  // ÂàùÂßãÂåñÊªæÂãïÊëòË¶ÅË®≠ÁΩÆ
  const rollingEnabled = story.rollingEnabled || false;
  const rollingInterval = story.rollingInterval || 30;
  document.getElementById('tog-rolling-summary').classList.toggle('active', rollingEnabled);
  document.getElementById('rolling-interval').value = rollingInterval;
  
  // Âä†ËºâÁ´†ÁØÄÈÅ∏È†Ö
  await updateCompressOptions();
  
  // ÈáçÁΩÆÈÅ∏È†ÖÂç°
  switchMemTab('compress');
  
  showModal('memory-modal');
}

// ÂàáÊèõË®òÊÜ∂ÁÆ°ÁêÜÈÅ∏È†ÖÂç°
function switchMemTab(tab){
  ['compress','rolling','analyze'].forEach(t => {
    document.getElementById('mem-tab-'+t).classList.toggle('secondary', t===tab);
    document.getElementById('mem-tab-'+t).style.background = t===tab ? '' : 'var(--bg-tertiary)';
    document.getElementById('mem-panel-'+t).style.display = t===tab ? '' : 'none';
  });
  // Êõ¥Êñ∞ÊåâÈàïÊñáÂ≠ó
  const btn = document.getElementById('mem-compress-btn');
  if(tab === 'compress'){
    btn.textContent = 'ü§ñ Êô∫ËÉΩÂ£ìÁ∏Æ';
    btn.onclick = compressMemory;
  } else if(tab === 'rolling'){
    btn.style.display = 'none';
  } else {
    btn.style.display = 'none';
  }
  if(tab === 'compress'){
    btn.style.display = '';
  }
}

// Êõ¥Êñ∞Â£ìÁ∏ÆÈÅ∏È†Ö
async function updateCompressOptions(){
  const mode = document.getElementById('compress-mode').value;
  document.getElementById('compress-count-group').style.display = mode === 'count' ? '' : 'none';
  document.getElementById('compress-chapter-group').style.display = mode === 'chapter' ? '' : 'none';
  
  if(mode === 'chapter' && story){
    const chapters = await db.chapters.where('storyId').equals(story.id).sortBy('order');
    const select = document.getElementById('compress-chapter');
    if(chapters.length === 0){
      select.innerHTML = '<option value="">Êö´ÁÑ°Á´†ÁØÄÔºåË´ãÂÖàÊ∑ªÂä†Á´†ÁØÄ</option>';
    } else {
      select.innerHTML = chapters.map((ch, i) => 
        `<option value="${ch.messageId}">Á¨¨ ${i+1} Á´†Ôºö${esc(ch.title)}</option>`
      ).join('');
    }
  }
}

// ÂàáÊèõÊªæÂãïÊëòË¶Å
async function toggleRollingSummary(){
  if(!story) return;
  const toggle = document.getElementById('tog-rolling-summary');
  const enabled = !toggle.classList.contains('active');
  toggle.classList.toggle('active', enabled);
  
  const interval = parseInt(document.getElementById('rolling-interval').value) || 30;
  await db.stories.update(story.id, { rollingEnabled: enabled, rollingInterval: interval });
  story.rollingEnabled = enabled;
  story.rollingInterval = interval;
  
  toast(enabled ? 'Â∑≤ÂïüÁî®Ëá™ÂãïÊªæÂãïÊëòË¶Å' : 'Â∑≤ÈóúÈñâËá™ÂãïÊªæÂãïÊëòË¶Å', 'success');
}
async function compressMemory(){
  const mode = document.getElementById('compress-mode').value;
  let count = 0;
  let toCompress = [];
  
  // Áç≤ÂèñÂèó‰øùË≠∑ÁöÑÊ∂àÊÅØ ID
  const protectedMsgIds = new Set();
  const foreshadows = await db.foreshadowing.where('storyId').equals(story.id).toArray();
  const bookmarks = await db.bookmarks.where('storyId').equals(story.id).toArray();
  const plotTags = await db.plotTags.where('storyId').equals(story.id).toArray();
  foreshadows.forEach(f => protectedMsgIds.add(f.messageId));
  bookmarks.forEach(b => protectedMsgIds.add(b.messageId));
  plotTags.forEach(t => protectedMsgIds.add(t.messageId));
  
  if(mode === 'chapter'){
    // ÊåâÁ´†ÁØÄÂ£ìÁ∏Æ
    const chapterMsgId = document.getElementById('compress-chapter').value;
    if(!chapterMsgId){
      toast('Ë´ãÈÅ∏ÊìáÁ´†ÁØÄ','warning');
      return;
    }
    const chapterMsgIdx = msgs.findIndex(m => m.id === chapterMsgId);
    if(chapterMsgIdx <= 0){
      toast('Ë©≤Á´†ÁØÄ‰πãÂâçÊ≤íÊúâÂèØÂ£ìÁ∏ÆÁöÑÊ∂àÊÅØ','info');
      closeModal('memory-modal');
      return;
    }
    // Â£ìÁ∏ÆÁ´†ÁØÄ‰πãÂâçÁöÑÊ∂àÊÅØÔºàÊéíÈô§Âèó‰øùË≠∑ÁöÑÔºâ
    for(let i = 0; i < chapterMsgIdx; i++){
      if(!protectedMsgIds.has(msgs[i].id)){
        toCompress.push(msgs[i]);
      }
    }
    count = toCompress.length;
  } else {
    // ÊåâÊï∏ÈáèÂ£ìÁ∏Æ
    const option = document.getElementById('compress-count').value;
    let targetCount = parseInt(option) || 10;
    if(option === 'all') targetCount = Math.max(0, msgs.length - 20);
    
    // ÂæûÊúÄÊó©ÁöÑÊ∂àÊÅØÈñãÂßãÔºåÊéíÈô§Âèó‰øùË≠∑ÁöÑ
    for(let i = 0; i < msgs.length && toCompress.length < targetCount; i++){
      if(!protectedMsgIds.has(msgs[i].id)){
        toCompress.push(msgs[i]);
      }
    }
    count = toCompress.length;
  }
  
  if(count <= 0){
    toast('Ê≤íÊúâÂèØÂ£ìÁ∏ÆÁöÑÊ∂àÊÅØÔºàÈáçË¶ÅÊ∂àÊÅØÂ∑≤Âèó‰øùË≠∑Ôºâ','info');
    closeModal('memory-modal');
    return;
  }
  
  // È°ØÁ§∫Á¢∫Ë™ç
  const skipped = (mode === 'chapter' ? msgs.slice(0, msgs.findIndex(m => m.id === document.getElementById('compress-chapter').value)).length : parseInt(document.getElementById('compress-count').value) || 10) - count;
  let confirmMsg = `Â∞áÂ£ìÁ∏Æ ${count} Ê¢ùÊ∂àÊÅØ`;
  if(skipped > 0){
    confirmMsg += `ÔºàÂ∑≤Ë∑≥ÈÅé ${skipped} Ê¢ùÂèó‰øùË≠∑Ê∂àÊÅØÔºâ`;
  }
  confirmMsg += '\n\nAI Â∞áÁîüÊàêÊô∫ËÉΩÊëòË¶Å‰øùÁïôÈóúÈçµ‰ø°ÊÅØ„ÄÇÁ¢∫ÂÆöÁπºÁ∫åÔºü';
  
  showConfirm(confirmMsg, async () => {
    showLoading('AI Ê≠£Âú®ÁîüÊàêÊô∫ËÉΩÊëòË¶Å...');
    try{
      // Â£ìÁ∏ÆÂâç‰øùÂ≠òËßíËâ≤Âø´ÁÖß
      await saveCharacterSnapshot();
      
      // ‰ΩøÁî® AI ÁîüÊàêÊô∫ËÉΩÊëòË¶Å
      let summary;
      try {
        summary = await generateAISummary(toCompress);
      } catch(aiError) {
        console.warn('AI ÊëòË¶ÅÁîüÊàêÂ§±ÊïóÔºå‰ΩøÁî®Á∞°ÂñÆÊëòË¶Å:', aiError);
        summary = generateSimpleSummary(toCompress);
      }
      
      // Âà™Èô§ËàäÊ∂àÊÅØ
      const ids = toCompress.map(m => m.id);
      await db.messages.bulkDelete(ids);
      msgs = msgs.filter(m => !ids.includes(m.id));
      
      // ‰øùÂ≠òÊëòË¶ÅÂà∞ÊïÖ‰∫ã
      const summaries = story.summaries || [];
      summaries.push({
        content: summary,
        createdAt: Date.now(),
        count,
        isAI: true,
        type: 'compressed'
      });
      await db.stories.update(story.id, {summaries, compressedCount: (story.compressedCount||0)+count});
      story.summaries = summaries;
      story.compressedCount = (story.compressedCount||0)+count;
      
      renderMsgs();
      hideLoading();
      closeModal('memory-modal');
      toast(`Â∑≤Â£ìÁ∏Æ ${count} Ê¢ùÊ∂àÊÅØÔºåAI ÊëòË¶ÅÂ∑≤‰øùÂ≠ò`,'success');
    }catch(e){
      hideLoading();
      toast('Â£ìÁ∏ÆÂ§±Êïó: '+e.message,'error');
    }
  });
}

// v18: AI Êô∫ËÉΩÊëòË¶ÅÁîüÊàê
async function generateAISummary(messages){
  const preset = await db.apiPresets.filter(p=>p.isActive).first();
  if(!preset || !preset.apiKey){
    throw new Error('Êú™ÈÖçÁΩÆ API');
  }
  
  // ÊßãÂª∫Ë¶ÅÊëòË¶ÅÁöÑÂÖßÂÆπ
  const content = messages.map(m => {
    const role = m.role === 'user' ? '„ÄêÁé©ÂÆ∂Ë°åÂãï„Äë' : '„ÄêÂäáÊÉÖÁôºÂ±ï„Äë';
    return `${role}\n${m.content}`;
  }).join('\n\n---\n\n');
  
  // ÈôêÂà∂Èï∑Â∫¶ÈÅøÂÖçË∂ÖÂá∫ token
  const truncatedContent = content.slice(0, 15000);
  
  const summaryPrompt = `Ë´ãÁÇ∫‰ª•‰∏ã‰∫íÂãïÂ∞èË™™ÁâáÊÆµÁîüÊàê‰∏Ä‰ªΩÁµêÊßãÂåñÊëòË¶Å„ÄÇÈÄô‰ªΩÊëòË¶ÅÂ∞áÁî®ÊñºÂπ´Âä© AI Âú®ÂæåÁ∫åÂäáÊÉÖ‰∏≠‰øùÊåÅÈÄ£Ë≤´ÊÄß„ÄÇ

„ÄêË¶ÅÊëòË¶ÅÁöÑÂÖßÂÆπ„Äë
${truncatedContent}

„ÄêÊëòË¶ÅË¶ÅÊ±Ç„Äë
Ë´ãÊåâ‰ª•‰∏ãÊ†ºÂºèËº∏Âá∫ÊëòË¶ÅÔºàÁ∏ΩÈï∑Â∫¶ÊéßÂà∂Âú® 800 Â≠ó‰ª•ÂÖßÔºâÔºö

## üìñ ÂäáÊÉÖÊ¶ÇË¶Å
ÔºàÁî® 2-3 ÊÆµË©±Ê¶ÇËø∞‰∏ªË¶Å‰∫ã‰ª∂ÁôºÂ±ïÔºâ

## üë• ËßíËâ≤ÂãïÊÖã
ÔºàÂàóÂá∫Âá∫ÁèæÁöÑÈáçË¶ÅËßíËâ≤ÂèäÂÖ∂ÁãÄÊÖãËÆäÂåñ„ÄÅÈóú‰øÇËÆäÂåñÔºâ

## üîë ÈóúÈçµ‰ø°ÊÅØ
ÔºàÂàóÂá∫ÈáçË¶ÅÁöÑÂú∞Èªû„ÄÅÁâ©ÂìÅ„ÄÅÁ∑öÁ¥¢„ÄÅÁ¥ÑÂÆöÁ≠âÈúÄË¶ÅË®ò‰ΩèÁöÑÁ¥∞ÁØÄÔºâ

## ‚ö° Áï∂ÂâçÂ±ÄÂã¢
ÔºàÁ∞°Ëø∞ÁõÆÂâçÁöÑËôïÂ¢ÉÂíåÂæÖËß£Ê±∫ÁöÑÂïèÈ°åÔºâ

Ë´ãÁõ¥Êé•Ëº∏Âá∫ÊëòË¶ÅÂÖßÂÆπÔºå‰∏çË¶ÅÊúâÂÖ∂‰ªñË™™Êòé„ÄÇ`;

  // Ë™øÁî® AI
  let response;
  if(preset.type === 'anthropic'){
    response = await callAnthropicDirect(preset, summaryPrompt);
  } else if(preset.type === 'openai'){
    response = await callOpenAIDirect(preset, summaryPrompt);
  } else {
    response = await callCustomDirect(preset, summaryPrompt);
  }
  
  return response.content;
}

// Áõ¥Êé•Ë™øÁî® APIÔºà‰∏çÂ∏∂ÊïÖ‰∫ã‰∏ä‰∏ãÊñáÔºâ
async function callAnthropicDirect(p, prompt){
  const r = await fetch('https://api.anthropic.com/v1/messages',{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'x-api-key':p.apiKey,
      'anthropic-version':'2023-06-01',
      'anthropic-dangerous-direct-browser-access':'true'
    },
    body:JSON.stringify({
      model: p.model,
      max_tokens: 1500,
      messages: [{role:'user', content: prompt}]
    })
  });
  if(!r.ok){
    const e = await r.json().catch(()=>({}));
    throw new Error(e.error?.message || `APIÈåØË™§ (${r.status})`);
  }
  const d = await r.json();
  return {content: d.content[0].text};
}

async function callOpenAIDirect(p, prompt){
  const r = await fetch(p.baseUrl || 'https://api.openai.com/v1/chat/completions',{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'Authorization':'Bearer '+p.apiKey
    },
    body:JSON.stringify({
      model: p.model,
      max_tokens: 1500,
      messages: [{role:'user', content: prompt}]
    })
  });
  if(!r.ok){
    const e = await r.json().catch(()=>({}));
    throw new Error(e.error?.message || `APIÈåØË™§ (${r.status})`);
  }
  const d = await r.json();
  return {content: d.choices[0].message.content};
}

async function callCustomDirect(p, prompt){
  const r = await fetch(p.baseUrl,{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'Authorization':'Bearer '+p.apiKey
    },
    body:JSON.stringify({
      model: p.model,
      max_tokens: 1500,
      messages: [{role:'user', content: prompt}]
    })
  });
  if(!r.ok){
    const e = await r.json().catch(()=>({}));
    throw new Error(e.error?.message || `APIÈåØË™§ (${r.status})`);
  }
  const d = await r.json();
  // ÂòóË©¶Â§öÁ®ÆÊ†ºÂºè
  if(d.choices?.[0]?.message?.content) return {content: d.choices[0].message.content};
  if(d.content?.[0]?.text) return {content: d.content[0].text};
  if(d.response) return {content: d.response};
  throw new Error('ÁÑ°Ê≥ïËß£Êûê API ÂõûÊáâ');
}

// Á∞°ÂñÆÊëòË¶ÅÔºàAI Â§±ÊïóÊôÇÁöÑÂÇôÈÅ∏ÊñπÊ°àÔºâ
function generateSimpleSummary(messages){
  const events = [];
  const characters = new Set();
  const locations = new Set();
  
  messages.forEach(m => {
    if(m.role === 'user'){
      events.push(`‚Ä¢ Áé©ÂÆ∂Ôºö${m.content.slice(0, 80)}${m.content.length > 80 ? '...' : ''}`);
    } else {
      // ÊèêÂèñÂâç 200 Â≠ó‰ΩúÁÇ∫ÊëòË¶Å
      const preview = m.content.slice(0, 200).replace(/\n+/g, ' ');
      events.push(`‚Ä¢ ÂäáÊÉÖÔºö${preview}${m.content.length > 200 ? '...' : ''}`);
      
      // ÂòóË©¶ÊèêÂèñËßíËâ≤ÂêçÔºàÁ∞°ÂñÆÂïüÁôºÂºèÔºâ
      const nameMatches = m.content.match(/„Äå[^„Äç]+„Äç|„Äé[^„Äè]+„Äè|„Äê[^„Äë]+„Äë/g);
      if(nameMatches){
        nameMatches.slice(0, 5).forEach(n => characters.add(n));
      }
    }
  });
  
  let summary = '## üìñ ÂäáÊÉÖÊ¶ÇË¶Å\n';
  summary += events.slice(0, 15).join('\n') + '\n';
  
  if(characters.size > 0){
    summary += '\n## üë• Âá∫ÁèæËßíËâ≤\n';
    summary += Array.from(characters).slice(0, 10).join('„ÄÅ') + '\n';
  }
  
  summary += '\n## ‚ö†Ô∏è Ê≥®ÊÑè\n';
  summary += 'Ê≠§ÁÇ∫Á∞°ÊòìÊëòË¶ÅÔºåÈÉ®ÂàÜÁ¥∞ÁØÄÂèØËÉΩÈÅ∫Êºè„ÄÇ';
  
  return summary;
}

// v18: Êü•ÁúãÊëòË¶Å
function viewSummaries(){
  if(!story){toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã','warning');return;}
  
  const summaries = story.summaries || [];
  const c = document.getElementById('summaries-list');
  
  if(!summaries.length){
    c.innerHTML = '<div class="empty" style="padding:30px"><div class="empty-icon">üì≠</div><div class="empty-title">Êö´ÁÑ°ÊëòË¶Å</div><div class="empty-desc">Â£ìÁ∏ÆË®òÊÜ∂ÂæåÊúÉÁîüÊàêÊëòË¶Å</div></div>';
    showModal('summaries-modal');
    return;
  }
  
  c.innerHTML = summaries.map((s, idx) => {
    const time = new Date(s.createdAt).toLocaleString();
    const aiTag = s.isAI ? '<span style="background:var(--primary);color:white;padding:2px 6px;border-radius:4px;font-size:11px;margin-left:6px">ü§ñ AI</span>' : '<span style="background:var(--text-tertiary);color:white;padding:2px 6px;border-radius:4px;font-size:11px;margin-left:6px">Á∞°Êòì</span>';
    return `
      <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <span style="font-weight:600">Ë®òÊÜ∂ÁâáÊÆµ ${idx + 1}${aiTag}</span>
          <span style="font-size:12px;color:var(--text-tertiary)">${time}</span>
        </div>
        <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px">Â£ìÁ∏Æ‰∫Ü ${s.count} Ê¢ùÊ∂àÊÅØ</div>
        <div style="font-size:13px;white-space:pre-wrap;line-height:1.6;max-height:200px;overflow-y:auto;background:var(--bg-secondary);padding:10px;border-radius:6px">${esc(s.content)}</div>
        <div style="margin-top:8px;text-align:right">
          <button onclick="deleteSummary(${idx})" style="background:none;border:none;color:var(--error);cursor:pointer;font-size:12px">üóëÔ∏è Âà™Èô§Ê≠§ÊëòË¶Å</button>
        </div>
      </div>
    `;
  }).join('');
  
  showModal('summaries-modal');
}

// Âà™Èô§ÂñÆÊ¢ùÊëòË¶Å
async function deleteSummary(idx){
  if(!confirm('Á¢∫ÂÆöÂà™Èô§ÈÄôÊ¢ùÊëòË¶ÅÔºüÂà™Èô§Âæå AI Â∞áÁÑ°Ê≥ïÂèÉËÄÉÈÄôÊÆµË®òÊÜ∂„ÄÇ')) return;
  
  const summaries = story.summaries || [];
  summaries.splice(idx, 1);
  
  await db.stories.update(story.id, {summaries});
  story.summaries = summaries;
  
  document.getElementById('memory-summary-count').textContent = summaries.length;
  viewSummaries(); // Âà∑Êñ∞ÂàóË°®
  toast('ÊëòË¶ÅÂ∑≤Âà™Èô§', 'success');
}

// Ê∏ÖÁ©∫ÊâÄÊúâÊëòË¶Å
async function clearAllSummaries(){
  if(!story){return;}
  
  const summaries = story.summaries || [];
  if(!summaries.length){
    toast('Êö´ÁÑ°ÊëòË¶ÅÂèØÊ∏ÖÁ©∫', 'info');
    return;
  }
  
  if(!confirm(`Á¢∫ÂÆöÊ∏ÖÁ©∫ÂÖ®ÈÉ® ${summaries.length} Ê¢ùÊëòË¶ÅÔºü\n\n‚ö†Ô∏è Ê∏ÖÁ©∫Âæå AI Â∞áÂÆåÂÖ®Â§±ÂéªÂ∞çÂ∑≤Â£ìÁ∏ÆÂäáÊÉÖÁöÑË®òÊÜ∂ÔºÅ`)) return;
  
  await db.stories.update(story.id, {summaries: [], compressedCount: 0});
  story.summaries = [];
  story.compressedCount = 0;
  
  document.getElementById('memory-summary-count').textContent = '0';
  document.getElementById('memory-compressed').textContent = '0';
  closeModal('summaries-modal');
  toast('ÊâÄÊúâÊëòË¶ÅÂ∑≤Ê∏ÖÁ©∫', 'success');
}

// ============ v22 Êñ∞Â¢ûÔºöÊªæÂãïÊëòË¶Å„ÄÅÊô∫ËÉΩÂàÜÊûê„ÄÅÊëòË¶ÅÊêúÁ¥¢ ============

// ÁîüÊàêÊªæÂãïÊëòË¶ÅÔºà‰∏çÂà™Èô§ÂéüÊñáÔºâ
async function generateRollingSummary(){
  if(!story){toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã','warning');return;}
  if(msgs.length < 10){toast('Ê∂àÊÅØÂ§™Â∞ëÔºåÂª∫Ë≠∞Á¥ØÁ©çÊõ¥Â§öÂÖßÂÆπÂæåÂÜçÁîüÊàê','info');return;}
  
  showLoading('Ê≠£Âú®ÁîüÊàêÊªæÂãïÊëòË¶Å...');
  try{
    const preset = await db.apiPresets.filter(p=>p.isActive).first();
    if(!preset || !preset.apiKey){
      throw new Error('Êú™ÈÖçÁΩÆ API');
    }
    
    // ÂèñÊúÄËøëÁöÑÊ∂àÊÅØÔºàÊéíÈô§Â∑≤ÊúâÊªæÂãïÊëòË¶ÅË¶ÜËìãÁöÑÈÉ®ÂàÜÔºâ
    const rollingSummaries = story.rollingSummaries || [];
    const lastSummaryMsgIdx = rollingSummaries.length > 0 ? 
      msgs.findIndex(m => m.id === rollingSummaries[rollingSummaries.length - 1].lastMessageId) : -1;
    
    const startIdx = lastSummaryMsgIdx >= 0 ? lastSummaryMsgIdx + 1 : 0;
    const toSummarize = msgs.slice(startIdx);
    
    if(toSummarize.length < 5){
      hideLoading();
      toast('Ë∑ùÈõ¢‰∏äÊ¨°ÊëòË¶ÅÂæåÊ∂àÊÅØÂ§™Â∞ëÔºåÂª∫Ë≠∞ÁπºÁ∫åÈÅäÊà≤ÂæåÂÜçÁîüÊàê','info');
      return;
    }
    
    // ÊßãÂª∫ÂÖßÂÆπ
    const content = toSummarize.map(m => {
      const role = m.role === 'user' ? '„ÄêÁé©ÂÆ∂„Äë' : '„ÄêÂäáÊÉÖ„Äë';
      return `${role} ${m.content.slice(0, 500)}`;
    }).join('\n\n');
    
    const prompt = `Ë´ãÁÇ∫‰ª•‰∏ã‰∫íÂãïÂ∞èË™™ÁâáÊÆµÁîüÊàê‰∏Ä‰ªΩÁ∞°Áü≠ÁöÑËÉåÊôØÊëòË¶ÅÔºà200Â≠ó‰ª•ÂÖßÔºâ„ÄÇÈÄô‰ªΩÊëòË¶ÅÂ∞á‰ΩúÁÇ∫‰∏ä‰∏ãÊñáËÉåÊôØÔºåÂπ´Âä©AIÁêÜËß£ÊïÖ‰∫ãÈÄ≤Â±ï„ÄÇ

„ÄêÂÖßÂÆπ„Äë
${content.slice(0, 8000)}

„ÄêË¶ÅÊ±Ç„Äë
- Áî® 2-3 Âè•Ë©±Ê¶ÇËø∞‰∏ªË¶Å‰∫ã‰ª∂
- Ë®òÈåÑÈóúÈçµÁöÑËßíËâ≤‰∫íÂãïÊàñÁãÄÊÖãËÆäÂåñ
- ‰∏çÈúÄË¶ÅË©≥Á¥∞ÔºåÂè™ÈúÄË¶ÅÊ†∏ÂøÉË¶ÅÈªû
- Áõ¥Êé•Ëº∏Âá∫ÊëòË¶ÅÔºå‰∏çË¶ÅÂÖ∂‰ªñË™™Êòé`;

    let response;
    if(preset.type === 'anthropic'){
      response = await callAnthropicDirect(preset, prompt);
    } else if(preset.type === 'openai'){
      response = await callOpenAIDirect(preset, prompt);
    } else {
      response = await callCustomDirect(preset, prompt);
    }
    
    // ‰øùÂ≠òÊªæÂãïÊëòË¶Å
    rollingSummaries.push({
      content: response.content,
      createdAt: Date.now(),
      lastMessageId: msgs[msgs.length - 1].id,
      msgCount: toSummarize.length
    });
    
    await db.stories.update(story.id, { rollingSummaries });
    story.rollingSummaries = rollingSummaries;
    
    hideLoading();
    document.getElementById('memory-rolling-count').textContent = rollingSummaries.length;
    toast('ÊªæÂãïÊëòË¶ÅÂ∑≤ÁîüÊàêÔºàÂéüÊ∂àÊÅØ‰øùÁïôÔºâ','success');
  }catch(e){
    hideLoading();
    toast('ÁîüÊàêÂ§±Êïó: '+e.message,'error');
  }
}

// Âêà‰ΩµÂ§öÊ¢ùÊëòË¶Å
async function mergeSummaries(){
  if(!story){toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã','warning');return;}
  
  const summaries = story.summaries || [];
  if(summaries.length < 2){
    toast('Ëá≥Â∞ëÈúÄË¶Å 2 Ê¢ùÊëòË¶ÅÊâçËÉΩÂêà‰Ωµ','info');
    return;
  }
  
  showConfirm(`Á¢∫ÂÆöË¶ÅÂêà‰Ωµ ${summaries.length} Ê¢ùÊëòË¶ÅÂóéÔºü\n\nAI Â∞áÈáçÊñ∞Êï¥ÁêÜÊâÄÊúâÊëòË¶ÅÔºåÁîüÊàê‰∏Ä‰ªΩÊõ¥Á≤æÁ∞°ÁöÑÁµ±‰∏ÄÁâàÊú¨„ÄÇ`, async () => {
    showLoading('AI Ê≠£Âú®Âêà‰ΩµÊëòË¶Å...');
    try{
      const preset = await db.apiPresets.filter(p=>p.isActive).first();
      if(!preset || !preset.apiKey){
        throw new Error('Êú™ÈÖçÁΩÆ API');
      }
      
      const allContent = summaries.map((s, i) => `--- ÊëòË¶Å ${i+1} ---\n${s.content}`).join('\n\n');
      
      const prompt = `‰ª•‰∏ãÊòØÂ§ö‰ªΩ‰∫íÂãïÂ∞èË™™ÁöÑÂäáÊÉÖÊëòË¶ÅÔºåË´ãÂ∞áÂÆÉÂÄëÂêà‰ΩµÊï¥ÁêÜÊàê‰∏Ä‰ªΩÁµ±‰∏ÄÁöÑÊëòË¶Å„ÄÇ

${allContent.slice(0, 12000)}

„ÄêË¶ÅÊ±Ç„Äë
- ‰øùÁïôÊâÄÊúâÈáçË¶Å‰ø°ÊÅØÔºåÂéªÈô§ÈáçË§áÂÖßÂÆπ
- ÊåâÊôÇÈñìÈ†ÜÂ∫èÊï¥ÁêÜ
- Á∏ΩÈï∑Â∫¶ÊéßÂà∂Âú® 1000 Â≠ó‰ª•ÂÖß
- ‰ΩøÁî®‰ª•‰∏ãÊ†ºÂºèÔºö

## üìñ ÂÆåÊï¥ÂäáÊÉÖÂõûÈ°ß
ÔºàÊåâÊôÇÈñìÈ†ÜÂ∫èÊ¶ÇËø∞ÊâÄÊúâÈáçË¶Å‰∫ã‰ª∂Ôºâ

## üë• ËßíËâ≤ÁãÄÊÖã
ÔºàÁï∂ÂâçÂêÑËßíËâ≤ÁöÑÁãÄÊÖãÂíåÈóú‰øÇÔºâ

## üîë ÈóúÈçµË¶ÅÈªû
ÔºàÈúÄË¶ÅË®ò‰ΩèÁöÑÈáçË¶Å‰ø°ÊÅØÔºâ

Áõ¥Êé•Ëº∏Âá∫Âêà‰ΩµÂæåÁöÑÊëòË¶Å„ÄÇ`;

      let response;
      if(preset.type === 'anthropic'){
        response = await callAnthropicDirect(preset, prompt);
      } else if(preset.type === 'openai'){
        response = await callOpenAIDirect(preset, prompt);
      } else {
        response = await callCustomDirect(preset, prompt);
      }
      
      // Ë®àÁÆóÁ∏ΩÂ£ìÁ∏ÆÊï∏
      const totalCount = summaries.reduce((sum, s) => sum + (s.count || 0), 0);
      
      // Áî®Êñ∞ÊëòË¶ÅÊõøÊèõÊâÄÊúâËàäÊëòË¶Å
      const newSummaries = [{
        content: response.content,
        createdAt: Date.now(),
        count: totalCount,
        isAI: true,
        type: 'merged'
      }];
      
      await db.stories.update(story.id, { summaries: newSummaries });
      story.summaries = newSummaries;
      
      hideLoading();
      document.getElementById('memory-summary-count').textContent = '1';
      closeModal('memory-modal');
      toast('ÊëòË¶ÅÂ∑≤Âêà‰ΩµÁÇ∫‰∏Ä‰ªΩ','success');
    }catch(e){
      hideLoading();
      toast('Âêà‰ΩµÂ§±Êïó: '+e.message,'error');
    }
  });
}

// Êô∫ËÉΩÂàÜÊûêË®òÊÜ∂
async function analyzeMemory(){
  if(!story){toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã','warning');return;}
  if(msgs.length < 5){toast('Ê∂àÊÅØÂ§™Â∞ëÔºåÁÑ°ÈúÄÂàÜÊûê','info');return;}
  
  const resultEl = document.getElementById('memory-analysis-result');
  resultEl.style.display = '';
  resultEl.innerHTML = 'üîÑ AI Ê≠£Âú®ÂàÜÊûê...';
  
  try{
    const preset = await db.apiPresets.filter(p=>p.isActive).first();
    if(!preset || !preset.apiKey){
      throw new Error('Êú™ÈÖçÁΩÆ API');
    }
    
    // ÊßãÂª∫ÂàÜÊûêÂÖßÂÆπ
    const content = msgs.slice(0, 50).map((m, i) => {
      const role = m.role === 'user' ? '„ÄêÁé©ÂÆ∂„Äë' : '„ÄêAI„Äë';
      return `[${i+1}] ${role} ${m.content.slice(0, 300)}`;
    }).join('\n\n');
    
    const prompt = `Ë´ãÂàÜÊûê‰ª•‰∏ã‰∫íÂãïÂ∞èË™™Â∞çË©±ÔºåÂæûË®òÊÜ∂ÁÆ°ÁêÜËßíÂ∫¶Êèê‰æõÂª∫Ë≠∞„ÄÇ

„ÄêÂ∞çË©±ÂÖßÂÆπ„ÄëÔºàÂÖ± ${msgs.length} Ê¢ùÊ∂àÊÅØÔºâ
${content.slice(0, 10000)}

„ÄêÂàÜÊûêË¶ÅÊ±Ç„Äë
1. Ë≠òÂà•Âì™‰∫õÊ∂àÊÅØÂåÖÂê´ÈáçË¶Å‰ø°ÊÅØÔºàÈóúÈçµÂäáÊÉÖ„ÄÅËßíËâ≤Ë®≠ÂÆö„ÄÅ‰ºèÁ≠ÜÔºâ
2. Ë≠òÂà•Âì™‰∫õÊ∂àÊÅØÂèØ‰ª•ÂÆâÂÖ®Â£ìÁ∏ÆÔºàÊó•Â∏∏Â∞çË©±„ÄÅÈÅéÊ∏°ÊÄßÊèèÂØ´Ôºâ
3. Áµ¶Âá∫ÂÖ∑È´îÁöÑÂ£ìÁ∏ÆÂª∫Ë≠∞

Ë´ãÁî®‰ª•‰∏ãÊ†ºÂºèËº∏Âá∫Ôºö

üî¥ ÈáçË¶ÅÊ∂àÊÅØÔºàÂª∫Ë≠∞‰øùÁïôÔºâÔºö
- [Ê∂àÊÅØÁ∑®Ëôü] ÂéüÂõ†

üü¢ ÂèØÂ£ìÁ∏ÆÊ∂àÊÅØÔºö
- [Ê∂àÊÅØÁ∑®ËôüÁØÑÂúç] ÂéüÂõ†

üí° Âª∫Ë≠∞Ôºö
ÔºàÂÖ∑È´îÁöÑË®òÊÜ∂ÁÆ°ÁêÜÂª∫Ë≠∞Ôºâ`;

    let response;
    if(preset.type === 'anthropic'){
      response = await callAnthropicDirect(preset, prompt);
    } else if(preset.type === 'openai'){
      response = await callOpenAIDirect(preset, prompt);
    } else {
      response = await callCustomDirect(preset, prompt);
    }
    
    resultEl.innerHTML = `<div style="white-space:pre-wrap;line-height:1.6">${esc(response.content)}</div>`;
  }catch(e){
    resultEl.innerHTML = `<div style="color:var(--error)">ÂàÜÊûêÂ§±Êïó: ${esc(e.message)}</div>`;
  }
}

// ÊêúÁ¥¢ÊëòË¶Å
function searchSummaries(){
  if(!story){toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã','warning');return;}
  document.getElementById('summary-search-input').value = '';
  document.getElementById('summary-search-results').innerHTML = '<div class="empty"><div class="empty-icon">üîç</div><div class="empty-title">Ëº∏ÂÖ•ÈóúÈçµË©ûÊêúÁ¥¢</div></div>';
  closeModal('memory-modal');
  showModal('summary-search-modal');
}

function doSummarySearch(){
  const keyword = document.getElementById('summary-search-input').value.trim().toLowerCase();
  const resultsEl = document.getElementById('summary-search-results');
  
  if(!keyword){
    resultsEl.innerHTML = '<div class="empty"><div class="empty-icon">üîç</div><div class="empty-title">Ëº∏ÂÖ•ÈóúÈçµË©ûÊêúÁ¥¢</div></div>';
    return;
  }
  
  const summaries = story.summaries || [];
  const rollingSummaries = story.rollingSummaries || [];
  const allSummaries = [
    ...summaries.map((s, i) => ({...s, type: 'Â£ìÁ∏ÆÊëòË¶Å', idx: i})),
    ...rollingSummaries.map((s, i) => ({...s, type: 'ÊªæÂãïÊëòË¶Å', idx: i}))
  ];
  
  const results = allSummaries.filter(s => s.content.toLowerCase().includes(keyword));
  
  if(results.length === 0){
    resultsEl.innerHTML = '<div class="empty"><div class="empty-icon">üîç</div><div class="empty-title">Êú™ÊâæÂà∞ÂåπÈÖçÂÖßÂÆπ</div></div>';
    return;
  }
  
  resultsEl.innerHTML = results.map(s => {
    const content = s.content;
    const lowerContent = content.toLowerCase();
    const idx = lowerContent.indexOf(keyword);
    const start = Math.max(0, idx - 50);
    const end = Math.min(content.length, idx + keyword.length + 50);
    let preview = content.slice(start, end);
    if(start > 0) preview = '...' + preview;
    if(end < content.length) preview = preview + '...';
    
    // È´ò‰∫ÆÈóúÈçµË©û
    const regex = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    preview = esc(preview).replace(regex, '<mark style="background:var(--warning);color:black;padding:0 2px">$1</mark>');
    
    return `
      <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;margin-bottom:8px">
        <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:4px">${s.type} #${s.idx + 1}</div>
        <div style="font-size:13px;line-height:1.5">${preview}</div>
      </div>
    `;
  }).join('');
}

// Ê™¢Êü•ÊòØÂê¶ÈúÄË¶ÅËá™ÂãïÁîüÊàêÊªæÂãïÊëòË¶Å
async function checkAutoRollingSummary(){
  if(!story || !story.rollingEnabled) return;
  
  const interval = story.rollingInterval || 30;
  const rollingSummaries = story.rollingSummaries || [];
  
  // Ë®àÁÆóË∑ùÈõ¢‰∏äÊ¨°ÊëòË¶ÅÂæåÁöÑÊ∂àÊÅØÊï∏
  let msgsSinceLastSummary = msgs.length;
  if(rollingSummaries.length > 0){
    const lastMsgId = rollingSummaries[rollingSummaries.length - 1].lastMessageId;
    const lastIdx = msgs.findIndex(m => m.id === lastMsgId);
    if(lastIdx >= 0){
      msgsSinceLastSummary = msgs.length - lastIdx - 1;
    }
  }
  
  if(msgsSinceLastSummary >= interval){
    // ÈùúÈªòÁîüÊàêÊªæÂãïÊëòË¶Å
    try{
      await generateRollingSummary();
    }catch(e){
      console.warn('Ëá™ÂãïÊªæÂãïÊëòË¶ÅÁîüÊàêÂ§±Êïó:', e);
    }
  }
}

// Êü•ÊâæÊõøÊèõ
function showFindReplace(){
  closeAll();
  if(!story){toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã','warning');return;}
  document.getElementById('find-text').value='';
  document.getElementById('replace-text').value='';
  document.getElementById('find-result').textContent='';
  showModal('find-replace-modal');
}
function findNext(){
  const find=document.getElementById('find-text').value;
  if(!find){toast('Ë´ãËº∏ÂÖ•Êü•ÊâæÂÖßÂÆπ','warning');return;}
  const caseSensitive=document.getElementById('find-case-sensitive').checked;
  let count=0;
  msgs.forEach(m=>{
    const content=caseSensitive?m.content:m.content.toLowerCase();
    const search=caseSensitive?find:find.toLowerCase();
    const matches=(content.match(new RegExp(search.replace(/[.*+?^${}()|[\]\\]/g,'\\\\$&'),'g'))||[]).length;
    count+=matches;
  });
  document.getElementById('find-result').textContent=`ÊâæÂà∞ ${count} ËôïÂåπÈÖç`;
}
async function replaceAll(){
  const find=document.getElementById('find-text').value;
  const replace=document.getElementById('replace-text').value;
  if(!find){toast('Ë´ãËº∏ÂÖ•Êü•ÊâæÂÖßÂÆπ','warning');return;}
  
  const caseSensitive=document.getElementById('find-case-sensitive').checked;
  const regex=new RegExp(find.replace(/[.*+?^${}()|[\]\\]/g,'\\\\$&'),caseSensitive?'g':'gi');
  let count=0;
  
  for(const m of msgs){
    const newContent=m.content.replace(regex,(match)=>{count++;return replace;});
    if(newContent!==m.content){
      m.content=newContent;
      await db.messages.update(m.id,{content:newContent});
    }
  }
  
  if(count>0){
    renderMsgs();
    document.getElementById('find-result').textContent=`Â∑≤ÊõøÊèõ ${count} Ëôï`;
    toast(`Â∑≤ÊõøÊèõ ${count} Ëôï`,'success');
  }else{
    document.getElementById('find-result').textContent='Êú™ÊâæÂà∞ÂåπÈÖçÂÖßÂÆπ';
  }
}

// Áµ±Ë®àÈù¢Êùø
function showStats(){
  closeAll();
  if(!story){toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã','warning');return;}
  
  let totalChars=0,userChars=0,aiChars=0,totalTokens=0;
  msgs.forEach(m=>{
    totalChars+=m.content.length;
    if(m.role==='user')userChars+=m.content.length;
    else aiChars+=m.content.length;
    totalTokens+=(m.tokens||0);
  });
  
  document.getElementById('stats-chars').textContent=fmtNum(totalChars);
  document.getElementById('stats-msgs').textContent=msgs.length;
  document.getElementById('stats-tokens').textContent=fmtNum(totalTokens);
  document.getElementById('stats-time').textContent=Math.round((story.statistics?.playTimeMinutes||0)/60)+'h';
  document.getElementById('stats-user-chars').textContent=fmtNum(userChars);
  document.getElementById('stats-ai-chars').textContent=fmtNum(aiChars);
  
  showModal('stats-modal');
}

// Â∞éÂá∫ÊïÖ‰∫ã
function exportStory(){
  closeAll();
  if(!story){toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã','warning');return;}
  
  let content='# '+story.title+'\n\n';
  if(story.description)content+='> '+story.description+'\n\n';
  content+='---\n\n';
  
  msgs.forEach(m=>{
    if(m.role==='user')content+='**„ÄêÁé©ÂÆ∂„Äë** '+m.content+'\n\n';
    else content+=m.content+'\n\n---\n\n';
  });
  
  const blob=new Blob([content],{type:'text/markdown'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=story.title+'.md';
  a.click();
  URL.revokeObjectURL(url);
  toast('ÊïÖ‰∫ãÂ∑≤Â∞éÂá∫','success');
}

// ============ Á´†ÁØÄÁÆ°ÁêÜ ============
async function renderChapters(){
  if(!story)return;
  const c=document.getElementById('chapter-list');
  const chapters=await db.chapters.where('storyId').equals(story.id).sortBy('order');
  if(!chapters.length){
    c.innerHTML='<div class="empty"><div class="empty-icon">üìë</div><div class="empty-title">Êö´ÁÑ°Á´†ÁØÄ</div><div class="empty-desc">ÈªûÊìäÂè≥‰∏äËßíÊ∑ªÂä†Á´†ÁØÄÊ®ôË®ò</div></div>';
    return;
  }
  c.innerHTML=chapters.map((ch,i)=>{
    const msg=msgs.find(m=>m.id===ch.messageId);
    const preview=msg?.content?.slice(0,50)||'';
    return `<div class="card" onclick="jumpToChapter('${ch.id}')">
      <div class="card-cover" style="background:linear-gradient(135deg,var(--primary),var(--info))">üìë</div>
      <div class="card-info">
        <div class="card-header"><div class="card-title">${esc(ch.title)}</div><div class="card-time">${fmtDate(ch.createdAt)}</div></div>
        <div class="card-preview">${esc(preview)}...</div>
        <div class="card-meta"><span class="card-stats">Á¨¨ ${i+1} Á´†</span></div>
      </div>
    </div>`;
  }).join('')+'<button class="action-btn secondary" style="width:100%;margin-top:12px" onclick="addChapter()">‚ûï Ê∑ªÂä†Á´†ÁØÄ</button>';
}
function addChapter(){
  if(!story){toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã','warning');return;}
  if(!selMsgId&&msgs.length>0)selMsgId=msgs[msgs.length-1].id;
  document.getElementById('chapter-title').value='';
  showModal('chapter-modal');
}
async function saveChapter(){
  const title=document.getElementById('chapter-title').value.trim();
  if(!title){toast('Ë´ãËº∏ÂÖ•Á´†ÁØÄÊ®ôÈ°å','warning');return;}
  const chapters=await db.chapters.where('storyId').equals(story.id).toArray();
  const ch={id:crypto.randomUUID(),storyId:story.id,messageId:selMsgId||msgs[msgs.length-1]?.id,title,order:chapters.length,createdAt:Date.now()};
  await db.chapters.add(ch);
  closeModal('chapter-modal');
  toast('Á´†ÁØÄÂ∑≤Ê∑ªÂä†','success');
  renderChapters();
}
async function jumpToChapter(chId){
  const ch=await db.chapters.get(chId);
  if(!ch)return;
  goBack();
  setTimeout(()=>{
    const el=document.querySelector(`.msg[data-id="${ch.messageId}"]`);
    if(el)el.scrollIntoView({behavior:'smooth',block:'center'});
  },300);
}

// ============ Êõ∏Á±§ÁÆ°ÁêÜ ============
async function renderBookmarks(){
  if(!story)return;
  const c=document.getElementById('bookmark-list');
  const bookmarks=await db.bookmarks.where('storyId').equals(story.id).reverse().sortBy('createdAt');
  if(!bookmarks.length){
    c.innerHTML='<div class="empty"><div class="empty-icon">üîñ</div><div class="empty-title">Êö´ÁÑ°Êõ∏Á±§</div><div class="empty-desc">Èï∑ÊåâÊ∂àÊÅØÂèØÊ∑ªÂä†Êõ∏Á±§</div></div>';
    return;
  }
  c.innerHTML=bookmarks.map(bm=>{
    const msg=msgs.find(m=>m.id===bm.messageId);
    const preview=msg?.content?.slice(0,80)||'';
    return `<div class="card" onclick="jumpToBookmark('${bm.id}')">
      <div class="card-cover" style="background:linear-gradient(135deg,var(--warning),var(--primary))">üîñ</div>
      <div class="card-info">
        <div class="card-header"><div class="card-title">${esc(bm.name)}</div><div class="card-time">${fmtDate(bm.createdAt)}</div></div>
        <div class="card-preview">${esc(preview)}...</div>
      </div>
      <div style="position:absolute;right:12px;top:50%;transform:translateY(-50%)" onclick="event.stopPropagation();deleteBookmark('${bm.id}')">üóëÔ∏è</div>
    </div>`;
  }).join('');
}
function addBookmark(){
  hideMenu();
  if(!selMsgId){toast('Ë´ãÂÖàÈÅ∏ÊìáÊ∂àÊÅØ','warning');return;}
  document.getElementById('bookmark-name').value='';
  showModal('bookmark-modal');
}
async function saveBookmark(){
  const name=document.getElementById('bookmark-name').value.trim()||'Êõ∏Á±§ '+(await db.bookmarks.where('storyId').equals(story.id).count()+1);
  const bm={id:crypto.randomUUID(),storyId:story.id,messageId:selMsgId,name,createdAt:Date.now()};
  await db.bookmarks.add(bm);
  closeModal('bookmark-modal');
  toast('Êõ∏Á±§Â∑≤Ê∑ªÂä†','success');
}
async function jumpToBookmark(bmId){
  const bm=await db.bookmarks.get(bmId);
  if(!bm)return;
  goBack();
  setTimeout(()=>{
    const el=document.querySelector(`.msg[data-id="${bm.messageId}"]`);
    if(el){el.scrollIntoView({behavior:'smooth',block:'center'});el.style.animation='highlight 1s';}
  },300);
}
async function deleteBookmark(id){await db.bookmarks.delete(id);toast('Êõ∏Á±§Â∑≤Âà™Èô§','success');renderBookmarks();}

// ============ ÂäáÊÉÖÊ®ôÁ±§ ============
function addPlotTag(){
  hideMenu();
  if(!selMsgId){toast('Ë´ãÂÖàÈÅ∏ÊìáÊ∂àÊÅØ','warning');return;}
  document.getElementById('tag-note').value='';
  showModal('tag-modal');
}
async function savePlotTag(){
  const type=document.getElementById('tag-type').value;
  const note=document.getElementById('tag-note').value.trim();
  const tag={id:crypto.randomUUID(),storyId:story.id,messageId:selMsgId,type,note,createdAt:Date.now()};
  await db.plotTags.add(tag);
  closeModal('tag-modal');
  toast('Ê®ôÁ±§Â∑≤Ê∑ªÂä†','success');
  // Âú®Ê∂àÊÅØ‰∏äÈ°ØÁ§∫Ê®ôÁ±§
  const el=document.querySelector(`.msg[data-id="${selMsgId}"]`);
  if(el){
    const labels={key:'üîëÈóúÈçµ',scene:'üé¨ÂêçÂ†¥Èù¢',clue:'üîçÁ∑öÁ¥¢',turning:'üîÑËΩâÊäò',emotion:'üíïÊÉÖÊÑü'};
    let tagEl=el.querySelector('.plot-tags');
    if(!tagEl){tagEl=document.createElement('div');tagEl.className='plot-tags';tagEl.style.cssText='margin-top:8px;display:flex;gap:4px;flex-wrap:wrap';el.appendChild(tagEl);}
    tagEl.innerHTML+=`<span style="font-size:10px;padding:2px 6px;background:var(--bg-tertiary);border-radius:4px;color:var(--primary)">${labels[type]||type}</span>`;
  }
}

// ============ ÂàÜÊîØÁÆ°ÁêÜ ============
async function renderBranches(){
  if(!story)return;
  const c=document.getElementById('branch-list');
  const branches=await db.branches.where('storyId').equals(story.id).toArray();
  if(!branches.length){
    // ÂâµÂª∫ÈªòË™ç‰∏ªÂàÜÊîØ
    const main={id:'branch_main',storyId:story.id,name:'‰∏ªÁ∑ö',description:'',parentBranchId:null,createdAt:Date.now()};
    await db.branches.add(main);
    branches.push(main);
  }
  c.innerHTML=branches.map(br=>{
    const isActive=br.id===story.currentBranchId;
    return `<div class="card ${isActive?'selected':''}" onclick="switchBranch('${br.id}')">
      <div class="card-cover" style="background:linear-gradient(135deg,${isActive?'var(--success)':'var(--bg-tertiary)'},var(--primary))">üîÄ</div>
      <div class="card-info">
        <div class="card-header"><div class="card-title">${esc(br.name)}</div>${isActive?'<span class="api-badge">Áï∂Ââç</span>':''}</div>
        <div class="card-preview">${esc(br.description||'ÁÑ°ÊèèËø∞')}</div>
        <div class="card-meta"><span class="card-stats">${fmtDate(br.createdAt)}</span></div>
      </div>
    </div>`;
  }).join('')+'<button class="action-btn primary" style="width:100%;margin-top:12px" onclick="createBranch()">‚ûï ÂâµÂª∫Êñ∞ÂàÜÊîØ</button>';
}
function createBranch(){
  if(!story){toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã','warning');return;}
  document.getElementById('branch-name').value='';
  document.getElementById('branch-desc').value='';
  showModal('branch-modal');
}
async function saveBranch(){
  const name=document.getElementById('branch-name').value.trim();
  if(!name){toast('Ë´ãËº∏ÂÖ•ÂàÜÊîØÂêçÁ®±','warning');return;}
  const desc=document.getElementById('branch-desc').value.trim();
  const br={id:crypto.randomUUID(),storyId:story.id,name,description:desc,parentBranchId:story.currentBranchId,forkMessageId:msgs[msgs.length-1]?.id,createdAt:Date.now()};
  await db.branches.add(br);
  // Ë§áË£ΩÁï∂ÂâçÂàÜÊîØÁöÑÊ∂àÊÅØÂà∞Êñ∞ÂàÜÊîØ
  const currentMsgs=await db.messages.where('[storyId+branchId]').equals([story.id,story.currentBranchId]).toArray();
  const newMsgs=currentMsgs.map(m=>({...m,id:crypto.randomUUID(),branchId:br.id}));
  await db.messages.bulkAdd(newMsgs);
  closeModal('branch-modal');
  toast('ÂàÜÊîØÂ∑≤ÂâµÂª∫','success');
  renderBranches();
}
async function switchBranch(brId){
  if(brId===story.currentBranchId)return;
  story.currentBranchId=brId;
  await db.stories.update(story.id,{currentBranchId:brId});
  msgs=await db.messages.where('[storyId+branchId]').equals([story.id,brId]).sortBy('createdAt');
  renderMsgs();
  toast('Â∑≤ÂàáÊèõÂàÜÊîØ','success');
  renderBranches();
}

// ============ AI ÂäüËÉΩ ============
let lastAiCheckResult = null; // ‰øùÂ≠òÊúÄÂæå‰∏ÄÊ¨° AI Ê™¢Êü•ÁµêÊûú

function aiConsistencyCheck(){
  if(!story||!msgs.length){toast('Ë´ãÂÖàÈÅ∏ÊìáÊúâÂÖßÂÆπÁöÑÊïÖ‰∫ã','warning');return;}
  document.getElementById('ai-check-result').textContent='ÈªûÊìä„ÄåÈñãÂßãÊ™¢Êü•„ÄçÈÄ≤Ë°åÂàÜÊûê...';
  document.getElementById('ai-fix-btn').style.display='none';
  showModal('ai-check-modal');
}
async function doAiConsistencyCheck(){
  const resultEl=document.getElementById('ai-check-result');
  resultEl.textContent='ÂàÜÊûê‰∏≠ÔºåË´ãÁ®çÂÄô...';
  
  const prompt=`‰Ω†ÊòØ‰∏ÄÂÄãÊïÖ‰∫ã‰∏ÄËá¥ÊÄßÊ™¢Êü•Âä©Êâã„ÄÇË´ãÂàÜÊûê‰ª•‰∏ãÊïÖ‰∫ãÂÖßÂÆπÔºåÊ™¢Êü•ÊòØÂê¶Â≠òÂú®Ôºö
1. Ë®≠ÂÆöÁüõÁõæÔºàËßíËâ≤ÊÄßÊ†º„ÄÅËÉΩÂäõ„ÄÅËÉåÊôØ‰∏ç‰∏ÄËá¥Ôºâ
2. ÊôÇÈñìÁ∑öÈåØË™§Ôºà‰∫ã‰ª∂È†ÜÂ∫è‰∏çÂêàÁêÜÔºâ
3. ËßíËâ≤Ë°åÁÇ∫‰∏ç‰∏ÄËá¥ÔºàËàá‰πãÂâçÂª∫Á´ãÁöÑÊÄßÊ†º‰∏çÁ¨¶Ôºâ
4. ÈÇèËºØÊºèÊ¥ûÔºàÊÉÖÁØÄ‰∏çÂêàÁêÜÔºâ

Ë´ãÂàóÂá∫ÁôºÁèæÁöÑÂïèÈ°åÔºå‰∏¶Áµ¶Âá∫ÂÖ∑È´î‰ΩçÁΩÆÂíå‰øÆÊîπÂª∫Ë≠∞„ÄÇÂ¶ÇÊûúÊ≤íÊúâÂïèÈ°åÔºåË´ãË™™ÊòéÊïÖ‰∫ãÊï¥È´î‰∏ÄËá¥ÊÄßËâØÂ•Ω„ÄÇ

ÊïÖ‰∫ãÂÖßÂÆπÔºö
${msgs.slice(-30).map(m=>(m.role==='user'?'„ÄêÁé©ÂÆ∂„Äë':'„ÄêAI„Äë')+m.content).join('\n\n')}`;

  try{
    const resp=await callApi(prompt);
    resultEl.textContent=resp.content;
    lastAiCheckResult=resp.content;
    // Â¶ÇÊûúÁôºÁèæÂïèÈ°åÔºåÈ°ØÁ§∫‰øÆÂæ©ÊåâÈàï
    if(!resp.content.includes('‰∏ÄËá¥ÊÄßËâØÂ•Ω') && !resp.content.includes('Ê≤íÊúâÁôºÁèæÂïèÈ°å') && !resp.content.includes('Ê≤íÊúâÊòéÈ°Ø')){
      document.getElementById('ai-fix-btn').style.display='block';
    }
  }catch(e){
    resultEl.textContent='Ê™¢Êü•Â§±Êïó: '+e.message;
  }
}

function showAiFix(){
  closeModal('ai-check-modal');
  showModal('ai-fix-modal');
}

async function applyAiFix(method){
  closeModal('ai-fix-modal');
  
  if(method==='auto'){
    // Â∞á‰∏ÄËá¥ÊÄßÂïèÈ°åÊ∑ªÂä†Âà∞‰∏ãÊ¨° AI ÂõûË¶ÜÁöÑÊèêÁ§∫‰∏≠
    story.consistencyNote=`Ë´ãÊ≥®ÊÑè‰ª•‰∏ã‰∏ÄËá¥ÊÄßÂïèÈ°å‰∏¶Âú®ÂõûË¶Ü‰∏≠Ëá™ÁÑ∂Âú∞Á≥æÊ≠£Ôºö\n${lastAiCheckResult.slice(0,500)}`;
    await db.stories.update(story.id,{consistencyNote:story.consistencyNote});
    toast('Â∑≤Ë®≠ÁΩÆËá™Âãï‰øÆÂæ©ÔºåAI Â∞áÂú®‰∏ãÊ¨°ÂõûË¶Ü‰∏≠Á≥æÊ≠£','success');
  }else if(method==='note'){
    // Ê∑ªÂä†Âà∞‰∏ñÁïåËßÄË®≠ÂÆö
    const note={
      id:crypto.randomUUID(),
      storyId:story.id,
      category:'setting',
      name:'‰∏ÄËá¥ÊÄßÁ≠ÜË®ò - '+new Date().toLocaleDateString(),
      description:'AI Ê™¢Ê∏¨Âà∞ÁöÑÂïèÈ°å',
      content:lastAiCheckResult,
      isSelected:false,
      createdAt:Date.now()
    };
    await db.loreEntries.add(note);
    toast('Â∑≤Ê∑ªÂä†Âà∞‰∏ñÁïåËßÄË®≠ÂÆö','success');
  }else{
    toast('Â∑≤ÂøΩÁï•','info');
  }
}

function aiChapterSummary(){
  if(!story||!msgs.length){toast('Ë´ãÂÖàÈÅ∏ÊìáÊúâÂÖßÂÆπÁöÑÊïÖ‰∫ã','warning');return;}
  document.getElementById('ai-summary-result').textContent='ÈªûÊìä„ÄåÁîüÊàêÁ∏ΩÁµê„ÄçÈñãÂßã...';
  showModal('ai-summary-modal');
}
async function doAiChapterSummary(){
  const resultEl=document.getElementById('ai-summary-result');
  resultEl.textContent='ÁîüÊàê‰∏≠ÔºåË´ãÁ®çÂÄô...';
  
  const prompt=`Ë´ãÁÇ∫‰ª•‰∏ãÊïÖ‰∫ãÂÖßÂÆπÁîüÊàê‰∏ÄÂÄãÁ∞°ÊΩîÁöÑÁ´†ÁØÄÁ∏ΩÁµêÔºåÂåÖÊã¨Ôºö
1. ‰∏ªË¶Å‰∫ã‰ª∂Ê¶ÇËø∞Ôºà3-5Âè•Ë©±Ôºâ
2. ÈáçË¶ÅËßíËâ≤ÁãÄÊÖãËÆäÂåñ
3. ÈóúÈçµÊ±∫Á≠ñÈªû
4. Êú™Ëß£Ê±∫ÁöÑ‰ºèÁ≠Ü/Êá∏Âøµ

ÊïÖ‰∫ãÂÖßÂÆπÔºö
${msgs.slice(-50).map(m=>(m.role==='user'?'„ÄêÁé©ÂÆ∂„Äë':'„ÄêAI„Äë')+m.content).join('\n\n')}`;

  try{
    const resp=await callApi(prompt);
    resultEl.textContent=resp.content;
  }catch(e){
    resultEl.textContent='ÁîüÊàêÂ§±Êïó: '+e.message;
  }
}
function copySummary(){
  const text=document.getElementById('ai-summary-result').textContent;
  navigator.clipboard.writeText(text);
  toast('Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÊùø','success');
}

function aiSuggestions(){
  if(!story||!msgs.length){toast('Ë´ãÂÖàÈÅ∏ÊìáÊúâÂÖßÂÆπÁöÑÊïÖ‰∫ã','warning');return;}
  document.getElementById('ai-suggest-result').textContent='ÈªûÊìä„ÄåÁç≤ÂèñÂª∫Ë≠∞„ÄçÈñãÂßã...';
  showModal('ai-suggest-modal');
}
async function doAiSuggestions(){
  const resultEl=document.getElementById('ai-suggest-result');
  resultEl.textContent='ÊÄùËÄÉ‰∏≠ÔºåË´ãÁ®çÂÄô...';
  
  const prompt=`Âü∫Êñº‰ª•‰∏ãÊïÖ‰∫ãÁöÑÁï∂ÂâçÈÄ≤Â±ïÔºåË´ãÁÇ∫Áé©ÂÆ∂Êèê‰æõ 3-5 ÂÄãÂèØËÉΩÁöÑË°åÂãïÂª∫Ë≠∞„ÄÇÊØèÂÄãÂª∫Ë≠∞ÊáâË©≤Ôºö
1. Á¨¶ÂêàÁï∂ÂâçÊÉÖÂ¢É
2. Êúâ‰∏çÂêåÁöÑÈ¢®Èö™/Êî∂ÁõäÂÇæÂêë
3. ËÉΩÊé®ÂãïÂäáÊÉÖÁôºÂ±ï

Ë´ãÁî®Á∞°ÊΩîÁöÑÊñπÂºèÂàóÂá∫Âª∫Ë≠∞ÔºåÊØèÂÄãÂª∫Ë≠∞ÈôÑ‰∏äÁ∞°Áü≠ÁöÑÂèØËÉΩÂæåÊûúÈ†êÊ∏¨„ÄÇ

Áï∂ÂâçÊïÖ‰∫ãÈÄ≤Â±ïÔºö
${msgs.slice(-20).map(m=>(m.role==='user'?'„ÄêÁé©ÂÆ∂„Äë':'„ÄêAI„Äë')+m.content).join('\n\n')}`;

  try{
    const resp=await callApi(prompt);
    resultEl.textContent=resp.content;
  }catch(e){
    resultEl.textContent='Áç≤ÂèñÂª∫Ë≠∞Â§±Êïó: '+e.message;
  }
}

// ============ v7: ËßíËâ≤Âç°ÁâáÁ≥ªÁµ± ============
let currentCharacterId = null; // Áï∂ÂâçÈÅ∏‰∏≠ÁöÑËßíËâ≤ID

// Ê∏≤ÊüìËßíËâ≤ÂàóË°®
async function renderCharacters(){
  if(!story){
    document.getElementById('character-list').innerHTML='<div class="char-empty"><div class="char-empty-icon">üìö</div><div class="char-empty-title">Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã</div></div>';
    return;
  }
  const chars = await db.characters.where('storyId').equals(story.id).toArray();
  const c = document.getElementById('character-list');
  document.getElementById('char-count').textContent = chars.length + ' ‰ΩçËßíËâ≤';
  
  if(!chars.length){
    c.innerHTML=`<div class="char-empty">
      <div class="char-empty-icon">üë•</div>
      <div class="char-empty-title">Â∞öÊú™Ë≠òÂà•ËßíËâ≤</div>
      <div class="char-empty-desc">ÈªûÊìä„ÄåAI Êõ¥Êñ∞ÁãÄÊÖã„ÄçËá™ÂãïË≠òÂà•<br>ÊàñÊâãÂãïÊ∑ªÂä†ËßíËâ≤</div>
    </div>`;
    return;
  }
  
  c.innerHTML = chars.map(char => renderCharacterCard(char)).join('');
}

// Ê∏≤ÊüìÂñÆÂÄãËßíËâ≤Âç°Áâá
function renderCharacterCard(char){
  const stats = char.stats || {};
  const tags = char.tags || [];
  const relations = char.relations || [];
  
  // Áç≤ÂèñÂø´ÈÄüÈ†êË¶ΩÁöÑÈóúÈçµÊï∏ÂÄº
  const quickStats = [];
  if(stats['Â•ΩÊÑü'] !== undefined || stats['Ë°®Èù¢Â•ΩÊÑü'] !== undefined){
    const favor = stats['Ë°®Èù¢Â•ΩÊÑü'] || stats['Â•ΩÊÑü'] || 0;
    quickStats.push(`<div class="char-quick-item"><span>üíú</span><span class="char-quick-val">${favor}</span></div>`);
  }
  if(stats['ÁúüÂØ¶Â•ΩÊÑü'] !== undefined){
    const realFavor = stats['ÁúüÂØ¶Â•ΩÊÑü'];
    const color = realFavor > 50 ? 'var(--success)' : realFavor > 20 ? 'var(--warning)' : 'var(--error)';
    quickStats.push(`<div class="char-quick-item"><span>‚ù§Ô∏è</span><span class="char-quick-val" style="color:${color}">${realFavor}</span></div>`);
  }
  if(stats['Âø†Ë™†'] !== undefined){
    const loyalty = stats['Âø†Ë™†'];
    const color = loyalty > 50 ? 'var(--success)' : 'var(--error)';
    quickStats.push(`<div class="char-quick-item"><span>ü§ù</span><span class="char-quick-val" style="color:${color}">${loyalty}</span></div>`);
  }
  if(stats['ÈáéÂøÉ'] !== undefined){
    quickStats.push(`<div class="char-quick-item"><span>üî•</span><span class="char-quick-val" style="color:var(--warning)">${stats['ÈáéÂøÉ']}</span></div>`);
  }
  // ÂÖ∂‰ªñÂ∏∏Ë¶ãÂ±¨ÊÄß
  const otherKeys = Object.keys(stats).filter(k => !['Â•ΩÊÑü','Ë°®Èù¢Â•ΩÊÑü','ÁúüÂØ¶Â•ΩÊÑü','Âø†Ë™†','ÈáéÂøÉ'].includes(k));
  otherKeys.slice(0,2).forEach(k => {
    quickStats.push(`<div class="char-quick-item"><span>üìä</span><span class="char-quick-val">${stats[k]}</span></div>`);
  });
  
  // ÊßãÂª∫Â±¨ÊÄßÊ¢ù
  const statBars = Object.entries(stats).map(([key, val]) => {
    const numVal = parseInt(val) || 0;
    let colorClass = 'purple';
    if(['ÈáéÂøÉ','ÊïµÊÑè','Âç±Èö™'].some(k => key.includes(k))) colorClass = 'red';
    else if(['Âø†Ë™†','Â•ΩÊÑü','‰ø°‰ªª'].some(k => key.includes(k))) colorClass = numVal > 50 ? 'green' : 'red';
    else if(['Êô∫Ë¨Ä','Êô∫Âäõ','È≠ÖÂäõ'].some(k => key.includes(k))) colorClass = 'blue';
    else if(['ÂÆπË≤å','È≠ÖÂäõ'].some(k => key.includes(k))) colorClass = 'pink';
    else if(['ÂÆ∂‰∏ñ','Ë≤°ÂØå','Âú∞‰Ωç'].some(k => key.includes(k))) colorClass = 'gold';
    return `<div class="char-stat-bar">
      <div class="char-stat-header">
        <span class="char-stat-label">${key}</span>
        <span class="char-stat-value">${val}</span>
      </div>
      <div class="char-stat-track"><div class="char-stat-fill ${colorClass}" style="width:${Math.min(100,numVal)}%"></div></div>
    </div>`;
  }).join('');
  
  // Ê®ôÁ±§
  const tagHtml = tags.map(t => {
    let cls = '';
    if(['Âç±Èö™','ÈáéÂøÉ','ÊïµÂ∞ç','Èô∞Èö™'].some(k => t.includes(k))) cls = 'danger';
    else if(['Ë≠¶Âëä','Ê≥®ÊÑè','Â∞èÂøÉ'].some(k => t.includes(k))) cls = 'warning';
    else if(['ÂèãÂ•Ω','Âø†Ë™†','ÂèØ‰ø°'].some(k => t.includes(k))) cls = 'success';
    else cls = 'info';
    return `<span class="char-tag ${cls}">${esc(t)}</span>`;
  }).join('');
  
  // Èóú‰øÇ
  const relationHtml = relations.map(r => `
    <div class="char-relation">
      <div class="char-relation-avatar" style="background:linear-gradient(135deg,${r.type==='ÊïµÂ∞ç'?'#ef4444,#f87171':r.type==='ÂèãÂ•Ω'?'#22c55e,#4ade80':'#3b82f6,#60a5fa'})">
        ${r.avatar || 'üë§'}
      </div>
      <div class="char-relation-info">
        <div class="char-relation-name">${esc(r.name)}</div>
        <div class="char-relation-type">${esc(r.description || r.type || '')}</div>
      </div>
      <span class="char-relation-status ${r.type==='ÊïµÂ∞ç'?'enemy':r.type==='ÂèãÂ•Ω'?'ally':'neutral'}">${esc(r.type || '‰∏≠Á´ã')}</span>
    </div>
  `).join('');
  
  return `<div class="char-card" id="char-${char.id}" onclick="toggleCharCard('${char.id}')">
    <div class="char-header">
      <div class="char-avatar" style="background:linear-gradient(135deg,${char.color||'var(--primary)'},${char.colorLight||'var(--primary-light)'})" onclick="event.stopPropagation();uploadCharAvatar('${char.id}')">
        ${char.avatarImage ? `<img src="${char.avatarImage}" alt="${esc(char.name)}">` : (char.avatar || 'üë§')}
        ${char.rank ? `<span class="char-avatar-rank">${esc(char.rank)}</span>` : ''}
        <div class="upload-btn">üì∑</div>
      </div>
      <div class="char-info">
        <div class="char-name">
          ${esc(char.name)}
          ${char.title ? `<span class="char-title">${esc(char.title)}</span>` : ''}
        </div>
        <div class="char-brief">${esc(char.brief || char.description || '')}</div>
        <div class="char-quick">${quickStats.join('')}</div>
      </div>
      <div class="char-expand">‚ñº</div>
    </div>
    <div class="char-content">
      <div class="char-inner">
        <div class="char-tabs">
          <div class="char-tab active" onclick="event.stopPropagation();switchCharTab('${char.id}','basic')">Âü∫Êú¨</div>
          <div class="char-tab" onclick="event.stopPropagation();switchCharTab('${char.id}','stats')">Â±¨ÊÄß</div>
          <div class="char-tab" onclick="event.stopPropagation();switchCharTab('${char.id}','relation')">Èóú‰øÇ</div>
        </div>
        <div class="char-tab-content active" id="char-${char.id}-basic">
          ${char.description ? `<div class="char-desc">${esc(char.description)}</div>` : ''}
          ${tagHtml ? `<div class="char-tags">${tagHtml}</div>` : ''}
          ${char.extraInfo ? `<div class="char-mini-stats">${Object.entries(char.extraInfo).map(([k,v])=>`<div class="char-mini-stat"><div class="char-mini-val">${esc(String(v))}</div><div class="char-mini-label">${esc(k)}</div></div>`).join('')}</div>` : ''}
        </div>
        <div class="char-tab-content" id="char-${char.id}-stats">
          <div class="char-section">
            <div class="char-section-title">Â±¨ÊÄßÊï∏ÂÄº</div>
            ${statBars || '<div style="font-size:12px;color:var(--text-tertiary)">Êö´ÁÑ°Â±¨ÊÄßÊï∏Êìö</div>'}
          </div>
        </div>
        <div class="char-tab-content" id="char-${char.id}-relation">
          <div class="char-section">
            <div class="char-section-title">‰∫∫Áâ©Èóú‰øÇ</div>
            ${relationHtml || '<div style="font-size:12px;color:var(--text-tertiary)">Êö´ÁÑ°Èóú‰øÇÊï∏Êìö</div>'}
          </div>
        </div>
        <div class="char-actions">
          <button class="char-action-btn secondary" onclick="event.stopPropagation();showCharHistory('${char.id}')">üìú Ê≠∑Âè≤</button>
          <button class="char-action-btn primary" onclick="event.stopPropagation();showCharDetail('${char.id}')">üìù Ë©≥ÊÉÖ</button>
        </div>
      </div>
    </div>
  </div>`;
}

// Â±ïÈñã/Êî∂Ëµ∑ËßíËâ≤Âç°
function toggleCharCard(charId){
  const card = document.getElementById('char-'+charId);
  if(card) card.classList.toggle('expanded');
}

// ÂàáÊèõËßíËâ≤Tab
function switchCharTab(charId, tabName){
  const card = document.getElementById('char-'+charId);
  if(!card) return;
  card.querySelectorAll('.char-tab').forEach((t,i) => {
    t.classList.toggle('active', t.textContent.includes(tabName==='basic'?'Âü∫Êú¨':tabName==='stats'?'Â±¨ÊÄß':'Èóú‰øÇ'));
  });
  card.querySelectorAll('.char-tab-content').forEach(c => c.classList.remove('active'));
  const target = document.getElementById(`char-${charId}-${tabName}`);
  if(target) target.classList.add('active');
}

// Âà∑Êñ∞/Êõ¥Êñ∞ËßíËâ≤ÁãÄÊÖãÔºàAIËß£ÊûêÔºâ
function refreshCharacters(){
  if(!story){toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã','warning');return;}
  if(!msgs.length){toast('ÊïÖ‰∫ãÂÖßÂÆπÁÇ∫Á©∫ÔºåË´ãÂÖàÈñãÂßãÊïÖ‰∫ã','warning');return;}
  document.getElementById('char-update-result').textContent='ÈªûÊìä„ÄåÈñãÂßãÂàÜÊûê„ÄçËÆì AI Ë≠òÂà•ËßíËâ≤...';
  document.getElementById('char-update-btn').textContent='ÈñãÂßãÂàÜÊûê';
  document.getElementById('char-update-btn').disabled=false;
  showModal('char-update-modal');
}

async function doCharacterUpdate(){
  const resultEl = document.getElementById('char-update-result');
  const btn = document.getElementById('char-update-btn');
  btn.disabled = true;
  btn.textContent = 'ÂàÜÊûê‰∏≠...';
  resultEl.textContent = 'Ê≠£Âú®ÂàÜÊûêÊïÖ‰∫ãÂÖßÂÆπÔºåË≠òÂà•ËßíËâ≤...';
  
  // ÊßãÂª∫ÊèêÁ§∫Ë©û
  const prompt = `‰Ω†ÊòØ‰∏ÄÂÄãËßíËâ≤ÁãÄÊÖãÊèêÂèñÂä©Êâã„ÄÇË´ãÂàÜÊûê‰ª•‰∏ãÊïÖ‰∫ãÂÖßÂÆπÔºåË≠òÂà•ÊâÄÊúâÂá∫ÁèæÁöÑÈáçË¶ÅËßíËâ≤Ôºå‰∏¶ÊèêÂèñ‰ªñÂÄëÁöÑÁãÄÊÖã‰ø°ÊÅØ„ÄÇ

Ë´ã‰ª• JSON Ê†ºÂºèËøîÂõûÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
\`\`\`json
{
  "characters": [
    {
      "name": "ËßíËâ≤Âêç",
      "title": "È†≠Èäú/Ë∫´‰ªΩÔºàÂ¶ÇÁöáÂ§´„ÄÅÈÅ∏‰æçÁ≠âÔºâ",
      "rank": "ÂìÅÁ¥öÔºàÂ¶Ç‰∏ÄÂìÅ„ÄÅÂÖ≠ÂìÅÁ≠âÔºåÊ≤íÊúâÂâáÁïôÁ©∫Ôºâ",
      "avatar": "‰∏ÄÂÄã‰ª£Ë°®ËßíËâ≤ÁöÑemoji",
      "brief": "‰∏ÄÂè•Ë©±Á∞°‰ªã",
      "description": "Ë©≥Á¥∞ÊèèËø∞ÔºàÊÄßÊ†º„ÄÅËÉåÊôØ„ÄÅÁâπÈªûÔºâ",
      "stats": {
        "Â±¨ÊÄßÂêç": Êï∏ÂÄºÔºà0-100Ôºâ
      },
      "tags": ["Ê®ôÁ±§1", "Ê®ôÁ±§2"],
      "relations": [
        {"name": "Èóú‰øÇÂ∞çË±°", "type": "ÂèãÂ•Ω/ÊïµÂ∞ç/‰∏≠Á´ã", "description": "Èóú‰øÇÊèèËø∞"}
      ],
      "extraInfo": {
        "Âπ¥ÈΩ°": "19Ê≠≤",
        "ÂÖ∂‰ªñ‰ø°ÊÅØ": "ÂÄº"
      }
    }
  ]
}
\`\`\`

Ê†πÊìöÊïÖ‰∫ãÈ°ûÂûãËá™ÂãïÂà§Êñ∑ÂêàÈÅ©ÁöÑÂ±¨ÊÄßÔºö
- ÂæåÂÆÆ/ÂÆÆÈ¨•ÔºöÂ•ΩÊÑü„ÄÅË°®Èù¢Â•ΩÊÑü„ÄÅÁúüÂØ¶Â•ΩÊÑü„ÄÅÂø†Ë™†„ÄÅÈáéÂøÉ„ÄÅÂØµÊÑõÂ∫¶Á≠â
- ‰øÆ‰ªô/ÁéÑÂπªÔºöÂ¢ÉÁïå„ÄÅÈùàÂäõ„ÄÅÂ£ΩÂÖÉ„ÄÅÂäüÊ≥ïÁ≠âÁ¥öÁ≠â
- Êú´Êó•/ÁîüÂ≠òÔºöÁîüÂëΩ„ÄÅÈ£¢È§ì„ÄÅÁ≤æÁ•û„ÄÅÊÑüÊüìÂ∫¶Á≠â
- ÂÜíÈö™/RPGÔºöHP„ÄÅMP„ÄÅÂäõÈáè„ÄÅÊïèÊç∑„ÄÅÁ≠âÁ¥öÁ≠â

ÊïÖ‰∫ãÂÖßÂÆπÔºö
${msgs.slice(-30).map(m=>(m.role==='user'?'„ÄêÁé©ÂÆ∂„Äë':'„ÄêAI„Äë')+m.content).join('\n\n')}

Ë´ãÂè™ËøîÂõûJSONÔºå‰∏çË¶ÅÂÖ∂‰ªñËß£Èáã„ÄÇ`;

  try{
    const resp = await callApi(prompt);
    let content = resp.content;
    resultEl.textContent = 'Ëß£ÊûêAIÂõûË¶Ü...';
    
    // ÊèêÂèñJSON
    const jsonMatch = content.match(/```json\s*([\s\S]*?)\s*```/) || content.match(/\{[\s\S]*"characters"[\s\S]*\}/);
    if(!jsonMatch){
      resultEl.textContent = '‚ùå AI ÂõûË¶ÜÊ†ºÂºèÈåØË™§ÔºåÁÑ°Ê≥ïËß£ÊûêËßíËâ≤Êï∏Êìö\n\nÂéüÂßãÂõûË¶ÜÔºö\n' + content.slice(0,500);
      btn.disabled = false;
      btn.textContent = 'ÈáçË©¶';
      return;
    }
    
    const jsonStr = jsonMatch[1] || jsonMatch[0];
    const data = JSON.parse(jsonStr);
    
    if(!data.characters || !data.characters.length){
      resultEl.textContent = '‚ùå Êú™Ë≠òÂà•Âà∞ËßíËâ≤ÔºåË´ãÁ¢∫‰øùÊïÖ‰∫ã‰∏≠ÊúâËßíËâ≤Âá∫Áèæ';
      btn.disabled = false;
      btn.textContent = 'ÈáçË©¶';
      return;
    }
    
    resultEl.textContent = `‚úÖ Ë≠òÂà•Âà∞ ${data.characters.length} ÂÄãËßíËâ≤ÔºåÊ≠£Âú®‰øùÂ≠ò...`;
    
    // Áç≤ÂèñÁèæÊúâËßíËâ≤
    const existing = await db.characters.where('storyId').equals(story.id).toArray();
    const existingMap = {};
    existing.forEach(c => existingMap[c.name] = c);
    
    // Êõ¥Êñ∞ÊàñÊñ∞Â¢ûËßíËâ≤
    for(const char of data.characters){
      const existingChar = existingMap[char.name];
      if(existingChar){
        // Ë®òÈåÑÊ≠∑Âè≤ËÆäÂåñ
        const oldStats = existingChar.stats || {};
        const newStats = char.stats || {};
        const changes = [];
        for(const [key, newVal] of Object.entries(newStats)){
          const oldVal = oldStats[key];
          if(oldVal !== undefined && oldVal !== newVal){
            changes.push({attr: key, from: oldVal, to: newVal});
          }
        }
        if(changes.length){
          await db.characterHistory.add({
            id: crypto.randomUUID(),
            storyId: story.id,
            characterId: existingChar.id,
            changes,
            createdAt: Date.now()
          });
        }
        // Êõ¥Êñ∞ËßíËâ≤
        await db.characters.update(existingChar.id, {
          ...char,
          id: existingChar.id,
          storyId: story.id,
          updatedAt: Date.now()
        });
      }else{
        // Êñ∞Â¢ûËßíËâ≤
        await db.characters.add({
          ...char,
          id: crypto.randomUUID(),
          storyId: story.id,
          createdAt: Date.now(),
          updatedAt: Date.now()
        });
      }
    }
    
    resultEl.textContent = `‚úÖ ÊàêÂäüÊõ¥Êñ∞ ${data.characters.length} ÂÄãËßíËâ≤ÔºÅ`;
    closeModal('char-update-modal');
    renderCharacters();
    toast(`Â∑≤Êõ¥Êñ∞ ${data.characters.length} ÂÄãËßíËâ≤`,'success');
    
  }catch(e){
    console.error('Character update error:', e);
    resultEl.textContent = '‚ùå Êõ¥Êñ∞Â§±Êïó: ' + e.message;
    btn.disabled = false;
    btn.textContent = 'ÈáçË©¶';
  }
}

// ÊâãÂãïÊ∑ªÂä†ËßíËâ≤
function addCharacterManual(){
  if(!story){toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã','warning');return;}
  document.getElementById('char-add-name').value='';
  document.getElementById('char-add-title').value='';
  document.getElementById('char-add-avatar').value='';
  document.getElementById('char-add-desc').value='';
  document.getElementById('char-add-stats').value='';
  showModal('char-add-modal');
}

async function saveCharacterManual(){
  const name = document.getElementById('char-add-name').value.trim();
  if(!name){toast('Ë´ãËº∏ÂÖ•ËßíËâ≤ÂêçÁ®±','warning');return;}
  
  const title = document.getElementById('char-add-title').value.trim();
  const avatar = document.getElementById('char-add-avatar').value.trim() || 'üë§';
  const desc = document.getElementById('char-add-desc').value.trim();
  const statsText = document.getElementById('char-add-stats').value.trim();
  
  // Ëß£ÊûêÂ±¨ÊÄß
  const stats = {};
  if(statsText){
    statsText.split('\n').forEach(line => {
      const [key, val] = line.split(':').map(s => s.trim());
      if(key && val) stats[key] = parseInt(val) || val;
    });
  }
  
  const char = {
    id: crypto.randomUUID(),
    storyId: story.id,
    name,
    title,
    avatar,
    description: desc,
    stats,
    tags: [],
    relations: [],
    createdAt: Date.now(),
    updatedAt: Date.now()
  };
  
  await db.characters.add(char);
  closeModal('char-add-modal');
  renderCharacters();
  toast('ËßíËâ≤Â∑≤Ê∑ªÂä†','success');
}

// ============ ËßíËâ≤Âç°Â∞éÂÖ•/Â∞éÂá∫Á≥ªÁµ± ============
function showCharacterMenu(){
  const menu = document.getElementById('char-menu');
  menu.style.top = '50px';
  menu.style.right = '16px';
  menu.style.left = 'auto';
  menu.classList.add('active');
}

async function exportAllCharacters(){
  if(!story){toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã','warning');return;}
  const chars = await db.characters.where('storyId').equals(story.id).toArray();
  if(!chars.length){toast('Ê≤íÊúâËßíËâ≤ÂèØÂ∞éÂá∫','warning');return;}
  
  // ËΩâÊèõÁÇ∫ÈÄöÁî®Ê†ºÂºèÔºàÂÖºÂÆπ SillyTavernÔºâ
  const exportData = {
    format: 'zhimeng_characters_v1',
    exportedAt: new Date().toISOString(),
    storyTitle: story.title,
    characters: chars.map(c => ({
      name: c.name,
      title: c.title || '',
      avatar: c.avatar || 'üë§',
      description: c.description || '',
      personality: c.personality || '',
      stats: c.stats || {},
      tags: c.tags || [],
      relations: c.relations || [],
      mood: c.mood || '',
      note: c.note || '',
      location: c.location || ''
    }))
  };
  
  const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `ËßíËâ≤Âç°_${story.title}_${new Date().toLocaleDateString()}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast(`Â∑≤Â∞éÂá∫ ${chars.length} ‰ΩçËßíËâ≤`,'success');
}

function importCharacterCard(){
  if(!story){toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã','warning');return;}
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json,.png'; // ÊîØÊåÅ JSON Âíå PNGÔºàSillyTavern Ê†ºÂºèÔºâ
  input.onchange = async e => {
    const file = e.target.files[0];
    if(!file) return;
    
    try {
      showLoading('Ê≠£Âú®Â∞éÂÖ•...');
      
      if(file.name.endsWith('.png')){
        // SillyTavern PNG Ê†ºÂºèÔºàËßíËâ≤Âç°ÂµåÂÖ•Âú® PNG ÂÖÉÊï∏Êìö‰∏≠Ôºâ
        await importSillyTavernPNG(file);
      } else {
        // JSON Ê†ºÂºè
        const text = await file.text();
        const data = JSON.parse(text);
        await importCharacterJSON(data);
      }
      
      hideLoading();
      renderCharacters();
    } catch(err) {
      hideLoading();
      console.error('Import error:', err);
      toast('Â∞éÂÖ•Â§±Êïó: ' + err.message, 'error');
    }
  };
  input.click();
}

async function importCharacterJSON(data){
  let imported = 0;
  
  // Ê™¢Ê∏¨Ê†ºÂºè
  if(data.format === 'zhimeng_characters_v1' && data.characters){
    // ÁπîÂ§¢Ê†ºÂºè
    for(const c of data.characters){
      await addImportedCharacter(c);
      imported++;
    }
  } else if(data.spec === 'chara_card_v2' || data.data){
    // SillyTavern/Character Card V2 Ê†ºÂºè
    const charData = data.data || data;
    await addImportedCharacter({
      name: charData.name || data.name || 'Êú™Áü•ËßíËâ≤',
      description: charData.description || data.description || '',
      personality: charData.personality || data.personality || '',
      tags: charData.tags || [],
      avatar: 'üë§'
    });
    imported = 1;
  } else if(data.name){
    // Á∞°ÂñÆÊ†ºÂºèÔºàÂñÆÂÄãËßíËâ≤Ôºâ
    await addImportedCharacter(data);
    imported = 1;
  } else if(Array.isArray(data)){
    // ËßíËâ≤Êï∏ÁµÑ
    for(const c of data){
      if(c.name){
        await addImportedCharacter(c);
        imported++;
      }
    }
  } else {
    throw new Error('ÁÑ°Ê≥ïË≠òÂà•ÁöÑËßíËâ≤Âç°Ê†ºÂºè');
  }
  
  toast(`Â∑≤Â∞éÂÖ• ${imported} ‰ΩçËßíËâ≤`,'success');
}

async function importSillyTavernPNG(file){
  // ËÆÄÂèñ PNG ‰∏≠ÂµåÂÖ•ÁöÑËßíËâ≤Êï∏Êìö
  // SillyTavern Â∞áËßíËâ≤Êï∏ÊìöÂ≠òÂú® PNG ÁöÑ tEXt chunk ‰∏≠
  const arrayBuffer = await file.arrayBuffer();
  const uint8Array = new Uint8Array(arrayBuffer);
  
  // Êü•Êâæ tEXt chunkÔºàÂåÖÂê´ "chara" ÈóúÈçµÂ≠óÔºâ
  const textDecoder = new TextDecoder('utf-8');
  let charaData = null;
  
  // Á∞°ÂåñËôïÁêÜÔºöÊêúÁ¥¢ "chara" ÈóúÈçµÂ≠óÂæåÁöÑ base64 Êï∏Êìö
  const str = textDecoder.decode(uint8Array);
  const charaMatch = str.match(/chara\x00([A-Za-z0-9+/=]+)/);
  
  if(charaMatch){
    try {
      const base64 = charaMatch[1];
      const jsonStr = atob(base64);
      charaData = JSON.parse(jsonStr);
    } catch(e){
      console.error('Failed to parse embedded data:', e);
    }
  }
  
  if(!charaData){
    // ÂòóË©¶‰ΩúÁÇ∫ÊôÆÈÄö JSON Â∞éÂÖ•ÔºàÁî®Êà∂ÂèØËÉΩÈÅ∏ÈåØ‰∫ÜÊñá‰ª∂Ôºâ
    throw new Error('ÁÑ°Ê≥ïÂæû PNG ‰∏≠ËÆÄÂèñËßíËâ≤Êï∏ÊìöÔºåË´ãÁ¢∫Ë™çÈÄôÊòØÊúâÊïàÁöÑËßíËâ≤Âç°ÂúñÁâá');
  }
  
  await importCharacterJSON(charaData);
}

async function addImportedCharacter(c){
  // Ê™¢Êü•ÊòØÂê¶Â∑≤Â≠òÂú®ÂêåÂêçËßíËâ≤
  const existing = await db.characters.where('storyId').equals(story.id).filter(x => x.name === c.name).first();
  
  const char = {
    id: existing?.id || crypto.randomUUID(),
    storyId: story.id,
    name: c.name,
    title: c.title || '',
    avatar: c.avatar || 'üë§',
    description: c.description || c.personality || '',
    personality: c.personality || '',
    stats: c.stats || {},
    tags: c.tags || [],
    relations: c.relations || [],
    mood: c.mood || '',
    note: c.note || '',
    location: c.location || '',
    createdAt: existing?.createdAt || Date.now(),
    updatedAt: Date.now()
  };
  
  await db.characters.put(char);
}

async function exportSingleCharacter(charId){
  const char = await db.characters.get(charId);
  if(!char){toast('ËßíËâ≤‰∏çÂ≠òÂú®','error');return;}
  
  const exportData = {
    spec: 'chara_card_v2',
    spec_version: '2.0',
    data: {
      name: char.name,
      description: char.description || '',
      personality: char.personality || '',
      first_mes: '',
      avatar: char.avatar || 'üë§',
      chat: '',
      mes_example: '',
      scenario: '',
      creator_notes: `ÂæûÁπîÂ§¢Â∞éÂá∫ - ${story?.title || ''}`,
      system_prompt: '',
      post_history_instructions: '',
      alternate_greetings: [],
      tags: char.tags || [],
      creator: 'ÁπîÂ§¢',
      character_version: '1.0',
      extensions: {
        zhimeng: {
          title: char.title,
          stats: char.stats,
          relations: char.relations,
          mood: char.mood,
          note: char.note,
          location: char.location
        }
      }
    }
  };
  
  const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${char.name}_ËßíËâ≤Âç°.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast(`Â∑≤Â∞éÂá∫ËßíËâ≤„Äå${char.name}„Äç`,'success');
}

async function clearAllCharacters(){
  if(!story){toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã','warning');return;}
  if(!confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâËßíËâ≤ÂóéÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Âæ©ÔºÅ')) return;
  
  await db.characters.where('storyId').equals(story.id).delete();
  renderCharacters();
  toast('Â∑≤Ê∏ÖÁ©∫ÊâÄÊúâËßíËâ≤','success');
}

function exportCurrentCharacter(){
  if(currentCharacterId){
    exportSingleCharacter(currentCharacterId);
  }
}

// ============ Â†¥ÊôØÁÆ°ÁêÜÁ≥ªÁµ± ============
let currentEditSceneId = null;

async function showSceneManager(){
  if(!story){toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã','warning');return;}
  closeAll();
  await renderSceneList();
  await updateCurrentSceneSelect();
  showModal('scene-modal');
}

async function renderSceneList(){
  const container = document.getElementById('scene-list');
  const scenes = await db.scenes.where('storyId').equals(story.id).toArray();
  
  if(!scenes.length){
    container.innerHTML = `<div style="text-align:center;padding:16px;color:var(--text-tertiary);font-size:13px">ÈÇÑÊ≤íÊúâÂ†¥ÊôØÔºåÈªûÊìä‰∏ãÊñπÊåâÈàïÂâµÂª∫</div>`;
    document.getElementById('scene-detail-section').style.display = 'none';
    return;
  }
  
  let html = '';
  scenes.forEach(s => {
    const charCount = s.characterIds?.length || 0;
    html += `
      <div class="scene-item" style="display:flex;align-items:center;padding:10px;background:${s.isActive?'rgba(139,92,246,0.15)':'var(--bg-secondary)'};border-radius:8px;margin-bottom:6px;cursor:pointer" onclick="selectSceneForDetail('${s.id}')">
        <div style="flex:1;min-width:0">
          <div style="font-size:14px;font-weight:500;color:${s.isActive?'var(--primary)':'var(--text-primary)'}">${esc(s.name)} ${s.isActive?'‚úì':''}</div>
          <div style="font-size:11px;color:var(--text-tertiary)">${charCount} ‰ΩçËßíËâ≤Âú®Â†¥</div>
        </div>
        <div style="display:flex;gap:4px">
          <button class="icon-btn" style="padding:4px 8px;font-size:12px" onclick="event.stopPropagation();editScene('${s.id}')">‚úèÔ∏è</button>
          <button class="icon-btn" style="padding:4px 8px;font-size:12px;color:var(--error)" onclick="event.stopPropagation();deleteScene('${s.id}')">üóëÔ∏è</button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

async function updateCurrentSceneSelect(){
  const select = document.getElementById('current-scene');
  const scenes = await db.scenes.where('storyId').equals(story.id).toArray();
  
  let html = '<option value="">ÁÑ°Â†¥ÊôØÔºàÊâÄÊúâËßíËâ≤Ôºâ</option>';
  scenes.forEach(s => {
    html += `<option value="${s.id}" ${s.isActive?'selected':''}>${esc(s.name)}</option>`;
  });
  select.innerHTML = html;
}

async function switchScene(sceneId){
  if(!story) return;
  
  // Ê∏ÖÈô§ÊâÄÊúâÂ†¥ÊôØÁöÑÊøÄÊ¥ªÁãÄÊÖã
  const scenes = await db.scenes.where('storyId').equals(story.id).toArray();
  for(const s of scenes){
    if(s.isActive){
      s.isActive = false;
      await db.scenes.put(s);
    }
  }
  
  // ÊøÄÊ¥ªÈÅ∏‰∏≠ÁöÑÂ†¥ÊôØ
  if(sceneId){
    const scene = await db.scenes.get(sceneId);
    if(scene){
      scene.isActive = true;
      await db.scenes.put(scene);
      toast(`Â∑≤ÂàáÊèõÂà∞Â†¥ÊôØ„Äå${scene.name}„Äç`,'success');
    }
  } else {
    toast('Â∑≤ÂàáÊèõÁÇ∫ÁÑ°Â†¥ÊôØÊ®°Âºè','success');
  }
  
  await renderSceneList();
}

async function selectSceneForDetail(sceneId){
  const scene = await db.scenes.get(sceneId);
  if(!scene) return;
  
  const section = document.getElementById('scene-detail-section');
  section.style.display = 'block';
  
  const container = document.getElementById('scene-characters');
  const charIds = scene.characterIds || [];
  
  if(!charIds.length){
    container.innerHTML = `<div style="text-align:center;padding:12px;color:var(--text-tertiary);font-size:12px">Ê≠§Â†¥ÊôØÊ≤íÊúâËßíËâ≤</div>`;
    return;
  }
  
  let html = '';
  for(const cid of charIds){
    const char = await db.characters.get(cid);
    if(char){
      html += `
        <div style="display:flex;align-items:center;padding:8px;background:var(--bg-secondary);border-radius:6px;margin-bottom:4px">
          <span style="font-size:20px;margin-right:8px">${char.avatar||'üë§'}</span>
          <span style="flex:1;font-size:13px">${esc(char.name)}</span>
          ${char.title?`<span style="font-size:11px;color:var(--text-tertiary)">${esc(char.title)}</span>`:''}
        </div>
      `;
    }
  }
  container.innerHTML = html;
}

async function createNewScene(){
  currentEditSceneId = null;
  document.getElementById('scene-edit-title').textContent = 'ÂâµÂª∫Â†¥ÊôØ';
  document.getElementById('scene-edit-id').value = '';
  document.getElementById('scene-edit-name').value = '';
  document.getElementById('scene-edit-desc').value = '';
  
  await renderSceneCharSelector([]);
  showModal('scene-edit-modal');
}

async function editScene(sceneId){
  const scene = await db.scenes.get(sceneId);
  if(!scene) return;
  
  currentEditSceneId = sceneId;
  document.getElementById('scene-edit-title').textContent = 'Á∑®ËºØÂ†¥ÊôØ';
  document.getElementById('scene-edit-id').value = sceneId;
  document.getElementById('scene-edit-name').value = scene.name;
  document.getElementById('scene-edit-desc').value = scene.description || '';
  
  await renderSceneCharSelector(scene.characterIds || []);
  showModal('scene-edit-modal');
}

async function renderSceneCharSelector(selectedIds){
  const container = document.getElementById('scene-char-selector');
  const chars = await db.characters.where('storyId').equals(story.id).toArray();
  
  if(!chars.length){
    container.innerHTML = `<div style="text-align:center;padding:12px;color:var(--text-tertiary);font-size:12px">ÈÇÑÊ≤íÊúâËßíËâ≤ÔºåË´ãÂÖàÊ∑ªÂä†ËßíËâ≤</div>`;
    return;
  }
  
  let html = '';
  chars.forEach(c => {
    const checked = selectedIds.includes(c.id);
    html += `
      <label style="display:flex;align-items:center;padding:8px;cursor:pointer;border-radius:6px;margin-bottom:4px;background:${checked?'rgba(139,92,246,0.1)':'transparent'}">
        <input type="checkbox" class="scene-char-cb" value="${c.id}" ${checked?'checked':''} style="margin-right:10px;width:18px;height:18px">
        <span style="font-size:18px;margin-right:8px">${c.avatar||'üë§'}</span>
        <span style="flex:1;font-size:13px">${esc(c.name)}</span>
        ${c.title?`<span style="font-size:11px;color:var(--text-tertiary)">${esc(c.title)}</span>`:''}
      </label>
    `;
  });
  container.innerHTML = html;
}

async function saveScene(){
  const name = document.getElementById('scene-edit-name').value.trim();
  if(!name){toast('Ë´ãËº∏ÂÖ•Â†¥ÊôØÂêçÁ®±','warning');return;}
  
  const description = document.getElementById('scene-edit-desc').value.trim();
  const checkboxes = document.querySelectorAll('.scene-char-cb:checked');
  const characterIds = Array.from(checkboxes).map(cb => cb.value);
  
  const sceneId = document.getElementById('scene-edit-id').value || crypto.randomUUID();
  
  const scene = {
    id: sceneId,
    storyId: story.id,
    name,
    description,
    characterIds,
    isActive: false,
    createdAt: currentEditSceneId ? (await db.scenes.get(sceneId))?.createdAt || Date.now() : Date.now()
  };
  
  await db.scenes.put(scene);
  closeModal('scene-edit-modal');
  await renderSceneList();
  await updateCurrentSceneSelect();
  toast(currentEditSceneId ? 'Â†¥ÊôØÂ∑≤Êõ¥Êñ∞' : 'Â†¥ÊôØÂ∑≤ÂâµÂª∫', 'success');
}

async function deleteScene(sceneId){
  if(!confirm('Á¢∫ÂÆöÂà™Èô§ÈÄôÂÄãÂ†¥ÊôØÔºü')) return;
  await db.scenes.delete(sceneId);
  await renderSceneList();
  await updateCurrentSceneSelect();
  toast('Â†¥ÊôØÂ∑≤Âà™Èô§','success');
}

// Áç≤ÂèñÁï∂ÂâçÂ†¥ÊôØÁöÑËßíËâ≤‰ø°ÊÅØÔºàÁî®Êñº System PromptÔºâ
async function getActiveScenePrompt(){
  if(!story) return '';
  
  const activeScene = await db.scenes.where('storyId').equals(story.id).filter(s => s.isActive).first();
  if(!activeScene || !activeScene.characterIds?.length) return '';
  
  let prompt = `\n\n### Áï∂ÂâçÂ†¥ÊôØÔºö${activeScene.name}\n`;
  if(activeScene.description){
    prompt += `${activeScene.description}\n\n`;
  }
  prompt += `Âú®Â†¥ËßíËâ≤Ôºö\n`;
  
  for(const cid of activeScene.characterIds){
    const char = await db.characters.get(cid);
    if(char){
      prompt += `- **${char.name}**`;
      if(char.title) prompt += `Ôºà${char.title}Ôºâ`;
      if(char.mood) prompt += ` [Áï∂ÂâçÊÉÖÁ∑íÔºö${char.mood}]`;
      prompt += '\n';
    }
  }
  
  prompt += `\nË´ãËÆìÈÄô‰∫õÂú®Â†¥ÁöÑËßíËâ≤Ê†πÊìöÂêÑËá™ÁöÑÊÄßÊ†ºÂíåÈóú‰øÇÈÄ≤Ë°å‰∫íÂãïÔºåÂèØ‰ª•ÊúâÂ∞çË©±„ÄÅÂãï‰Ωú„ÄÅË°®ÊÉÖÁ≠â„ÄÇ\n`;
  
  return prompt;
}

// È°ØÁ§∫ËßíËâ≤Ë©≥ÊÉÖ
async function showCharDetail(charId){
  currentCharacterId = charId;
  const char = await db.characters.get(charId);
  if(!char){toast('ËßíËâ≤‰∏çÂ≠òÂú®','error');return;}
  
  document.getElementById('char-detail-title').textContent = char.name + ' Ë©≥ÊÉÖ';
  
  let html = `
    <div style="text-align:center;margin-bottom:16px">
      <div style="width:64px;height:64px;border-radius:16px;background:linear-gradient(135deg,var(--primary),var(--primary-light));display:inline-flex;align-items:center;justify-content:center;font-size:32px">${char.avatar||'üë§'}</div>
      <div style="font-size:18px;font-weight:600;margin-top:8px">${esc(char.name)}</div>
      ${char.title?`<div style="font-size:13px;color:var(--text-secondary)">${esc(char.title)}</div>`:''}
    </div>
    ${char.description?`<div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px;padding:10px;background:var(--bg-tertiary);border-radius:8px">${esc(char.description)}</div>`:''}
  `;
  
  if(char.stats && Object.keys(char.stats).length){
    html += `<div style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">Â±¨ÊÄß</div>`;
    html += `<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:12px">`;
    for(const [k,v] of Object.entries(char.stats)){
      html += `<div style="background:var(--bg-tertiary);padding:8px;border-radius:6px;font-size:13px"><span style="color:var(--text-secondary)">${esc(k)}:</span> <strong>${esc(String(v))}</strong></div>`;
    }
    html += `</div>`;
  }
  
  if(char.tags && char.tags.length){
    html += `<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px">${char.tags.map(t=>`<span style="font-size:11px;padding:4px 8px;background:var(--bg-tertiary);border-radius:8px">${esc(t)}</span>`).join('')}</div>`;
  }
  
  html += `<div style="font-size:11px;color:var(--text-tertiary);text-align:right">Êõ¥Êñ∞Êñº ${fmtDate(char.updatedAt)}</div>`;
  
  document.getElementById('char-detail-content').innerHTML = html;
  showModal('char-detail-modal');
}

// Á∑®ËºØËßíËâ≤ÔºàË∑≥ËΩâÂà∞Ê∑ªÂä†È†ÅÈù¢‰∏¶Â°´ÂÖÖÊï∏ÊìöÔºâ
async function editCharacter(){
  if(!currentCharacterId) return;
  const char = await db.characters.get(currentCharacterId);
  if(!char) return;
  
  closeModal('char-detail-modal');
  
  document.getElementById('char-add-name').value = char.name || '';
  document.getElementById('char-add-title').value = char.title || '';
  document.getElementById('char-add-avatar').value = char.avatar || '';
  document.getElementById('char-add-desc').value = char.description || '';
  
  // ËΩâÊèõÂ±¨ÊÄßÁÇ∫ÊñáÊú¨
  if(char.stats){
    document.getElementById('char-add-stats').value = Object.entries(char.stats).map(([k,v])=>`${k}:${v}`).join('\n');
  }
  
  // ‰øÆÊîπ‰øùÂ≠òÂáΩÊï∏ÁÇ∫Êõ¥Êñ∞
  const modal = document.getElementById('char-add-modal');
  modal.querySelector('.modal-title').textContent = 'Á∑®ËºØËßíËâ≤';
  const confirmBtn = modal.querySelector('.modal-btn.confirm');
  confirmBtn.onclick = async function(){
    const name = document.getElementById('char-add-name').value.trim();
    if(!name){toast('Ë´ãËº∏ÂÖ•ËßíËâ≤ÂêçÁ®±','warning');return;}
    
    const statsText = document.getElementById('char-add-stats').value.trim();
    const stats = {};
    if(statsText){
      statsText.split('\n').forEach(line => {
        const [key, val] = line.split(':').map(s => s.trim());
        if(key && val) stats[key] = parseInt(val) || val;
      });
    }
    
    await db.characters.update(currentCharacterId, {
      name,
      title: document.getElementById('char-add-title').value.trim(),
      avatar: document.getElementById('char-add-avatar').value.trim() || 'üë§',
      description: document.getElementById('char-add-desc').value.trim(),
      stats,
      updatedAt: Date.now()
    });
    
    closeModal('char-add-modal');
    // ÈáçÁΩÆmodalÊ®ôÈ°åÂíå‰øùÂ≠òÂáΩÊï∏
    modal.querySelector('.modal-title').textContent = '‚ûï Ê∑ªÂä†ËßíËâ≤';
    confirmBtn.onclick = saveCharacterManual;
    currentCharacterId = null;
    renderCharacters();
    toast('ËßíËâ≤Â∑≤Êõ¥Êñ∞','success');
  };
  
  showModal('char-add-modal');
}

// Âà™Èô§ËßíËâ≤
async function deleteCharacter(){
  if(!currentCharacterId) return;
  if(!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãËßíËâ≤ÂóéÔºü')) return;
  
  await db.characters.delete(currentCharacterId);
  await db.characterHistory.where('characterId').equals(currentCharacterId).delete();
  closeModal('char-detail-modal');
  currentCharacterId = null;
  renderCharacters();
  toast('ËßíËâ≤Â∑≤Âà™Èô§','success');
}

// È°ØÁ§∫ËßíËâ≤Ê≠∑Âè≤
async function showCharHistory(charId){
  const history = await db.characterHistory.where('characterId').equals(charId).reverse().toArray();
  const char = await db.characters.get(charId);
  
  let html = '';
  if(!history.length){
    html = '<div style="text-align:center;padding:20px;color:var(--text-secondary)">Êö´ÁÑ°Â±¨ÊÄßËÆäÂåñË®òÈåÑ</div>';
  }else{
    html = history.map(h => {
      const changeHtml = h.changes.map(c => {
        const diff = (parseInt(c.to)||0) - (parseInt(c.from)||0);
        const color = diff > 0 ? 'var(--success)' : diff < 0 ? 'var(--error)' : 'var(--text-secondary)';
        const arrow = diff > 0 ? '‚Üë' : diff < 0 ? '‚Üì' : '‚Üí';
        return `<span style="display:inline-block;margin:2px 4px;padding:2px 6px;background:var(--bg-tertiary);border-radius:4px;font-size:11px">${esc(c.attr)}: ${c.from} <span style="color:${color}">${arrow} ${c.to}</span></span>`;
      }).join('');
      return `<div style="padding:10px;border-bottom:1px solid var(--divider)">
        <div style="font-size:11px;color:var(--text-tertiary);margin-bottom:4px">${fmtDate(h.createdAt)}</div>
        <div>${changeHtml}</div>
      </div>`;
    }).join('');
  }
  
  document.getElementById('char-history-content').innerHTML = html;
  showModal('char-history-modal');
}

// Âú®Â£ìÁ∏ÆË®òÊÜ∂Ââç‰øùÂ≠òËßíËâ≤Âø´ÁÖß
async function saveCharacterSnapshot(){
  if(!story) return;
  const chars = await db.characters.where('storyId').equals(story.id).toArray();
  if(!chars.length) return;
  
  await db.characterSnapshots.add({
    id: crypto.randomUUID(),
    storyId: story.id,
    characters: chars,
    messageCount: msgs.length,
    createdAt: Date.now()
  });
}

// È°ØÁ§∫Êï∏ÂÄºËÆäÂåñÂãïÁï´
function showValueChange(element, value, isUp){
  const rect = element.getBoundingClientRect();
  const change = document.createElement('div');
  change.className = 'char-value-change ' + (isUp ? 'up' : 'down');
  change.textContent = (isUp ? '+' : '') + value + (isUp ? ' ‚Üë' : ' ‚Üì');
  change.style.left = rect.left + 'px';
  change.style.top = rect.top + 'px';
  document.body.appendChild(change);
  setTimeout(() => change.remove(), 1500);
}

// Âú®goToÂáΩÊï∏‰∏≠Ê∑ªÂä†ËßíËâ≤Ë¶ñÂúñÁöÑÊ∏≤Êüì
const originalGoTo = typeof goTo === 'function' ? goTo : null;

// Êï∏ÊìöÂ∞éÂÖ•Â∞éÂá∫
async function exportAll(){
  showLoading('Â∞éÂá∫‰∏≠...');
  try{
    const data={
      version:'4.6',
      exportedAt:Date.now(),
      stories:await db.stories.toArray(),
      messages:await db.messages.toArray(),
      branches:await db.branches.toArray(),
      instructions:await db.instructions.toArray(),
      storyInstructions:await db.storyInstructions.toArray(),
      loreEntries:await db.loreEntries.toArray(),
      foreshadowing:await db.foreshadowing.toArray(),
      events:await db.events.toArray(),
      saves:await db.saves.toArray(),
      apiPresets:await db.apiPresets.toArray(),
      settings:await db.settings.toArray(),
      timeline:await db.timeline.toArray(),
      chapters:await db.chapters.toArray(),
      bookmarks:await db.bookmarks.toArray(),
      plotTags:await db.plotTags.toArray(),
      characters:await db.characters.toArray(),
      characterSnapshots:await db.characterSnapshots.toArray(),
      characterHistory:await db.characterHistory.toArray(),
      lorebook:await db.lorebook.toArray(),
      lorebookTriggerLog:await db.lorebookTriggerLog.toArray(),
      // v16 Êñ∞Â¢û
      quickCommands:await db.quickCommands.toArray(),
      scenes:await db.scenes.toArray(),
      // Ë£úÂÖÖÈÅ∫ÊºèÁöÑË°®
      characterStates:await db.characterStates.toArray()
    };
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;a.download=`zhimeng_backup_${new Date().toISOString().slice(0,10)}.json`;a.click();
    URL.revokeObjectURL(url);
    toast('Êï∏ÊìöÂ∞éÂá∫ÊàêÂäüÔºÅ','success');
  }catch(e){toast('Â∞éÂá∫Â§±Êïó: '+e.message,'error');}
  hideLoading();
}
function importAll(){
  const input=document.getElementById('import-input');
  input.onchange=async e=>{
    const f=e.target.files[0];if(!f)return;
    showLoading('Â∞éÂÖ•‰∏≠...');
    try{
      const text=await f.text(),data=JSON.parse(text);
      if(!data.version||!data.stories)throw new Error('ÁÑ°ÊïàÁöÑÂÇô‰ªΩÊñá‰ª∂');
      if(data.stories)await db.stories.bulkPut(data.stories);
      if(data.messages)await db.messages.bulkPut(data.messages);
      if(data.branches)await db.branches.bulkPut(data.branches);
      if(data.instructions)await db.instructions.bulkPut(data.instructions);
      if(data.storyInstructions)await db.storyInstructions.bulkPut(data.storyInstructions);
      if(data.loreEntries)await db.loreEntries.bulkPut(data.loreEntries);
      if(data.foreshadowing)await db.foreshadowing.bulkPut(data.foreshadowing);
      if(data.events)await db.events.bulkPut(data.events);
      if(data.saves)await db.saves.bulkPut(data.saves);
      if(data.apiPresets)await db.apiPresets.bulkPut(data.apiPresets);
      if(data.settings)await db.settings.bulkPut(data.settings);
      if(data.timeline)await db.timeline.bulkPut(data.timeline);
      if(data.chapters)await db.chapters.bulkPut(data.chapters);
      if(data.bookmarks)await db.bookmarks.bulkPut(data.bookmarks);
      if(data.plotTags)await db.plotTags.bulkPut(data.plotTags);
      // v7: ËßíËâ≤Êï∏Êìö
      if(data.characters)await db.characters.bulkPut(data.characters);
      if(data.characterSnapshots)await db.characterSnapshots.bulkPut(data.characterSnapshots);
      if(data.characterHistory)await db.characterHistory.bulkPut(data.characterHistory);
      // v13: Lorebook Êï∏Êìö
      if(data.lorebook)await db.lorebook.bulkPut(data.lorebook);
      if(data.lorebookTriggerLog)await db.lorebookTriggerLog.bulkPut(data.lorebookTriggerLog);
      // v16: Âø´Êç∑Êåá‰ª§ÂíåÂ†¥ÊôØ
      if(data.quickCommands)await db.quickCommands.bulkPut(data.quickCommands);
      if(data.scenes)await db.scenes.bulkPut(data.scenes);
      // Ë£úÂÖÖÈÅ∫ÊºèÁöÑË°®
      if(data.characterStates)await db.characterStates.bulkPut(data.characterStates);
      await loadSettings();await renderStories();await renderInst();await renderQuickCommands();
      toast('Êï∏ÊìöÂ∞éÂÖ•ÊàêÂäüÔºÅ','success');
    }catch(e){toast('Â∞éÂÖ•Â§±Êïó: '+e.message,'error');}
    hideLoading();input.value='';
  };
  input.click();
}
function clearAll(){showConfirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊï∏ÊìöÂóéÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Âæ©ÔºÅ',async()=>{showLoading('Ê∏ÖÁ©∫‰∏≠...');try{await db.delete();await initDB();await renderStories();await renderInst();toast('Êï∏ÊìöÂ∑≤Ê∏ÖÁ©∫','success');}catch(e){toast('Ê∏ÖÁ©∫Â§±Êïó: '+e.message,'error');}hideLoading();},true);}

// Toast & Loading
let toastTimeout = null;
function toast(msg,type=''){
  const t=document.getElementById('toast');
  document.getElementById('toast-text').textContent=msg;
  t.className='toast active '+type;
  // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊôÇÂô®ÔºåÈÅøÂÖçÈáçÁñä
  if(toastTimeout) clearTimeout(toastTimeout);
  toastTimeout = setTimeout(()=>{
    t.classList.remove('active');
    toastTimeout = null;
  },2500);
}
function showLoading(txt='ËôïÁêÜ‰∏≠...'){document.getElementById('loading-text').textContent=txt;document.getElementById('loading').classList.add('active');}
function hideLoading(){document.getElementById('loading').classList.remove('active');}

// Â∑•ÂÖ∑ÂáΩÊï∏
function esc(t){if(!t)return'';const d=document.createElement('div');d.textContent=t;return d.innerHTML;}
function fmtNum(n){return n>=10000?(n/10000).toFixed(1)+'Ëê¨':n.toLocaleString();}
function fmtDate(ts){if(!ts)return'Êú™Áü•';const d=new Date(ts);return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;}
function timeAgo(ts){const d=Date.now()-ts,m=Math.floor(d/60000),h=Math.floor(d/3600000),dy=Math.floor(d/86400000);if(m<1)return'ÂâõÂâõ';if(m<60)return m+'ÂàÜÈêòÂâç';if(h<24)return h+'Â∞èÊôÇÂâç';if(dy<7)return dy+'Â§©Ââç';const dt=new Date(ts);return(dt.getMonth()+1)+'/'+dt.getDate();}

console.log('ÁπîÂ§¢ v5.2 - AI‰∫íÂãïÂ∞èË™™Èñ±ËÆÄÂô® Ê∫ñÂÇôÂ∞±Á∑íÔºÅ');

// PWA ÊîØÊåÅ
let deferredPrompt = null;

// Ë®ªÂÜä Service Worker (‰ΩøÁî®ÂÖßÂµåÊñπÂºè)
// Ê≥®ÊÑèÔºöBlob URL ÊñπÂºèÂú®Êüê‰∫õÁÄèË¶ΩÂô®ÔºàÂ¶Ç SafariÔºâÂèØËÉΩ‰∏çÊîØÊåÅÔºåÈÄôÊòØÊ≠£Â∏∏ÁèæË±°
if ('serviceWorker' in navigator) {
  const swCode = `
    const CACHE_NAME = 'zhimeng-v5.2';
    const urlsToCache = [self.location.href];
    
    self.addEventListener('install', e => {
      e.waitUntil(
        caches.open(CACHE_NAME)
          .then(cache => cache.addAll(urlsToCache))
          .then(() => self.skipWaiting())
      );
    });
    
    self.addEventListener('activate', e => {
      e.waitUntil(
        caches.keys().then(names => 
          Promise.all(names.filter(n => n !== CACHE_NAME).map(n => caches.delete(n)))
        ).then(() => self.clients.claim())
      );
    });
    
    self.addEventListener('fetch', e => {
      if (e.request.method !== 'GET') return;
      e.respondWith(
        caches.match(e.request).then(cached => {
          const fetchPromise = fetch(e.request).then(response => {
            if (response.ok) {
              const clone = response.clone();
              caches.open(CACHE_NAME).then(cache => cache.put(e.request, clone));
            }
            return response;
          }).catch(() => cached);
          return cached || fetchPromise;
        })
      );
    });
  `;
  
  try {
    const swBlob = new Blob([swCode], {type: 'application/javascript'});
    const swUrl = URL.createObjectURL(swBlob);
    
    navigator.serviceWorker.register(swUrl, {scope: './'})
      .then(reg => console.log('ServiceWorker Ë®ªÂÜäÊàêÂäü:', reg.scope))
      .catch(err => {
        // Blob URL ÊñπÂºèÂú®Êüê‰∫õÁí∞Â¢É‰∏ã‰∏çÊîØÊåÅÔºåÈÄôÊòØÊ≠£Â∏∏ÁöÑ
        console.log('ServiceWorker Ë®ªÂÜäÂ§±Êïó (Blob URL ÊñπÂºèÂèØËÉΩ‰∏çÂèóÊîØÊåÅ):', err.message);
      });
  } catch(e) {
    console.log('ServiceWorker ÂàùÂßãÂåñÂ§±Êïó:', e.message);
  }
}

// ÂâµÂª∫‰∏¶Ê≥®ÂÖ• manifest
const manifest = {
  "name": "ÁπîÂ§¢ - AI‰∫íÂãïÂ∞èË™™Èñ±ËÆÄÂô®",
  "short_name": "ÁπîÂ§¢",
  "description": "AI‰∫íÂãïÂ∞èË™™Èñ±ËÆÄÂô® - ÂâµÂª∫‰Ω†ÁöÑÂ∞àÂ±¨ÊïÖ‰∫ã",
  "start_url": "./",
  "display": "standalone",
  "background_color": "#0F0F1A",
  "theme_color": "#8B7CF7",
  "orientation": "portrait",
  "icons": [
    {
      "src": "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect fill='%238B7CF7' width='512' height='512' rx='80'/><text x='256' y='340' text-anchor='middle' fill='white' font-size='280' font-family='serif'>Áπî</text></svg>",
      "sizes": "512x512",
      "type": "image/svg+xml",
      "purpose": "any maskable"
    },
    {
      "src": "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%238B7CF7' width='192' height='192' rx='30'/><text x='96' y='130' text-anchor='middle' fill='white' font-size='110' font-family='serif'>Áπî</text></svg>",
      "sizes": "192x192",
      "type": "image/svg+xml"
    }
  ]
};

const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
const manifestUrl = URL.createObjectURL(manifestBlob);
const manifestLink = document.createElement('link');
manifestLink.rel = 'manifest';
manifestLink.href = manifestUrl;
document.head.appendChild(manifestLink);

// Áõ£ËÅΩÂÆâË£ùÊèêÁ§∫‰∫ã‰ª∂
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  // Êõ¥Êñ∞ÂÆâË£ùÁãÄÊÖãÈ°ØÁ§∫
  const statusEl = document.getElementById('pwa-install-status');
  if (statusEl) statusEl.textContent = 'ÂèØÂÆâË£ù ‚Ä∫';
  // È°ØÁ§∫ÂÆâË£ùÊèêÁ§∫
  showInstallBanner();
});

// Áõ£ËÅΩÂÆâË£ùÂÆåÊàê
window.addEventListener('appinstalled', () => {
  console.log('PWA Â∑≤ÂÆâË£ù');
  deferredPrompt = null;
  const statusEl = document.getElementById('pwa-install-status');
  if (statusEl) statusEl.textContent = '‚úì Â∑≤ÂÆâË£ù';
});

// È°ØÁ§∫ÂÆâË£ùÊèêÁ§∫Ê©´ÂπÖ
function showInstallBanner() {
  // Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ìÂÆâË£ùÊàñÂ∑≤Á∂ìÈ°ØÁ§∫ÈÅé
  if (window.matchMedia('(display-mode: standalone)').matches) return;
  if (localStorage.getItem('pwa-install-dismissed')) return;
  
  const banner = document.createElement('div');
  banner.id = 'install-banner';
  banner.innerHTML = `
    <div style="position:fixed;bottom:80px;left:16px;right:16px;max-width:388px;margin:0 auto;background:linear-gradient(135deg,var(--primary-dark),var(--primary));padding:16px;border-radius:12px;box-shadow:0 4px 20px rgba(139,124,247,0.4);z-index:1000;display:flex;align-items:center;gap:12px;">
      <div style="font-size:32px">üì±</div>
      <div style="flex:1">
        <div style="font-size:14px;font-weight:600;color:white;margin-bottom:4px">ÂÆâË£ùÂà∞‰∏ªÁï´Èù¢</div>
        <div style="font-size:12px;color:rgba(255,255,255,0.8)">ÂÉè App ‰∏ÄÊ®£‰ΩøÁî®ÁπîÂ§¢</div>
      </div>
      <button onclick="installPWA()" style="padding:8px 16px;background:white;color:var(--primary);border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer">ÂÆâË£ù</button>
      <button onclick="dismissInstallBanner()" style="padding:8px;background:transparent;color:rgba(255,255,255,0.8);border:none;font-size:18px;cursor:pointer">√ó</button>
    </div>
  `;
  document.body.appendChild(banner);
}

// Ë™øË©¶ API ÈÄ£Êé•
async function debugApiTest() {
  const testUrl = 'https://api.deepseek.com/v1/chat/completions';
  const info = {
    userAgent: navigator.userAgent,
    platform: navigator.platform,
    isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent),
    isAndroid: /Android/.test(navigator.userAgent),
    isSafari: /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent),
    isChrome: /Chrome/.test(navigator.userAgent),
    location: window.location.href,
    protocol: window.location.protocol,
    online: navigator.onLine
  };
  
  let result = `üì± Ë®≠ÂÇô‰ø°ÊÅØÔºö\n`;
  result += `‚Ä¢ Âπ≥Âè∞: ${info.platform}\n`;
  result += `‚Ä¢ iOS: ${info.isIOS}\n`;
  result += `‚Ä¢ Safari: ${info.isSafari}\n`;
  result += `‚Ä¢ Chrome: ${info.isChrome}\n`;
  result += `‚Ä¢ Âú®Á∑ö: ${info.online}\n`;
  result += `‚Ä¢ ÂçîË≠∞: ${info.protocol}\n\n`;
  
  result += `üîó Ê∏¨Ë©¶ÈÄ£Êé•Âà∞: ${testUrl}\n\n`;
  
  // Ê∏¨Ë©¶ 1: Á∞°ÂñÆ GET Ë´ãÊ±Ç
  result += `Ê∏¨Ë©¶ 1: HEAD Ë´ãÊ±Ç...\n`;
  try {
    const r1 = await fetch(testUrl, { method: 'HEAD', mode: 'cors' });
    result += `‚úÖ HEAD ÊàêÂäü: ${r1.status}\n\n`;
  } catch(e) {
    result += `‚ùå HEAD Â§±Êïó: ${e.name} - ${e.message}\n\n`;
  }
  
  // Ê∏¨Ë©¶ 2: POST Ë´ãÊ±ÇÔºàÁÑ° bodyÔºâ
  result += `Ê∏¨Ë©¶ 2: POST Ë´ãÊ±ÇÔºàÁÑ°Ë™çË≠âÔºâ...\n`;
  try {
    const r2 = await fetch(testUrl, { 
      method: 'POST', 
      mode: 'cors',
      credentials: 'omit',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({})
    });
    const t2 = await r2.text();
    result += `‚úÖ POST ÁãÄÊÖã: ${r2.status}\n`;
    result += `ÈüøÊáâ: ${t2.slice(0, 100)}...\n\n`;
  } catch(e) {
    result += `‚ùå POST Â§±Êïó: ${e.name} - ${e.message}\n`;
    result += `ÈåØË™§È°ûÂûã: ${e.constructor.name}\n\n`;
  }
  
  // Ê∏¨Ë©¶ 3: Ê∏¨Ë©¶Âè¶‰∏ÄÂÄã API
  const testUrl2 = 'https://httpbin.org/post';
  result += `Ê∏¨Ë©¶ 3: httpbin.orgÔºàCORS Ê∏¨Ë©¶ÊúçÂãôÔºâ...\n`;
  try {
    const r3 = await fetch(testUrl2, { 
      method: 'POST', 
      mode: 'cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ test: 'hello' })
    });
    const t3 = await r3.text();
    result += `‚úÖ httpbin ÊàêÂäü: ${r3.status}\n`;
    result += `ÈüøÊáâ: ${t3.slice(0, 80)}...\n\n`;
  } catch(e) {
    result += `‚ùå httpbin Â§±Êïó: ${e.name} - ${e.message}\n\n`;
  }
  
  // È°ØÁ§∫ÁµêÊûú
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.style.cssText = 'max-width:90%;max-height:80vh;overflow:auto;white-space:pre-wrap;font-family:monospace;font-size:12px;text-align:left;';
  modal.innerHTML = `
    <div class="modal-title">üîß API Ë™øË©¶ÁµêÊûú</div>
    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;margin-bottom:16px;max-height:50vh;overflow:auto;">${result}</div>
    <div class="modal-actions">
      <button class="modal-btn confirm" onclick="this.closest('.modal').remove();document.getElementById('overlay').classList.remove('active')">ÈóúÈñâ</button>
    </div>
  `;
  document.getElementById('overlay').classList.add('active');
  document.body.appendChild(modal);
}

// ÂÆâË£ù PWA
async function installPWA() {
  if (!deferredPrompt) {
    // Â∞çÊñº iOSÔºåÈ°ØÁ§∫ÊâãÂãïÂÆâË£ùÊåáÂºï
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    if (isIOS) {
      showModal('ios-install-modal');
    } else {
      toast('Ë´ã‰ΩøÁî®ÁÄèË¶ΩÂô®ËèúÂñÆ‰∏≠ÁöÑ„ÄåÂä†ÂÖ•‰∏ªÁï´Èù¢„ÄçÂäüËÉΩ', 'info');
    }
    dismissInstallBanner();
    return;
  }
  
  deferredPrompt.prompt();
  const result = await deferredPrompt.userChoice;
  console.log('ÂÆâË£ùÁµêÊûú:', result.outcome);
  deferredPrompt = null;
  dismissInstallBanner();
  
  if (result.outcome === 'accepted') {
    toast('üéâ ÂÆâË£ùÊàêÂäüÔºÅ', 'success');
  }
}

// ÈóúÈñâÂÆâË£ùÊ©´ÂπÖ
function dismissInstallBanner() {
  const banner = document.getElementById('install-banner');
  if (banner) banner.remove();
  localStorage.setItem('pwa-install-dismissed', 'true');
}

// Ê™¢Ê∏¨ÊòØÂê¶‰ª• PWA Ê®°ÂºèÈÅãË°å
if (window.matchMedia('(display-mode: standalone)').matches) {
  console.log('Ê≠£Âú®‰ª• PWA Ê®°ÂºèÈÅãË°å');
  // Êõ¥Êñ∞ÂÆâË£ùÁãÄÊÖã
  setTimeout(() => {
    const statusEl = document.getElementById('pwa-install-status');
    if (statusEl) statusEl.textContent = '‚úì Â∑≤ÂÆâË£ù';
  }, 100);
}

// ============================================
// Êåá‰ª§ÁîüÊàêÂêëÂ∞éÁ≥ªÁµ±
// ============================================

// ÂêëÂ∞éÁãÄÊÖã
let wizardState = {
  step: 0,
  data: {
    template: null,
    basic: { type: '', era: '', setting: '', theme: '' },
    protagonist: { name: '', identity: '', gender: '', personality: '', appearance: '', background: '', goal: '' },
    characters: [],
    mechanics: { attributes: [], systems: [], triggers: [] },
    style: { tone: '', perspective: '', detail: '', format: '' },
    aiRules: { dos: [], donts: [], special: '' },
    examples: { opening: '', response: '', status: '' },
    aiChat: []
  },
  aiAsked: false
};

// È†êË®≠Ê®°Êùø
const wizardTemplates = [
  {
    id: 'palace',
    name: 'ÂÆÆÂª∑ÂæåÂÆÆ',
    icon: 'üëë',
    desc: 'ÂÆÆÈ¨•„ÄÅÊ¨äË¨Ä„ÄÅÊÑõÊÅ®‰∫§Áπî',
    preset: {
      type: 'ÂÆÆÂª∑ÂæåÂÆÆ',
      era: 'Êû∂Á©∫Âè§‰ª£Êù±Êñπ',
      attributes: ['Â•ΩÊÑüÂ∫¶(Ë°®Èù¢/ÁúüÂØ¶)', 'Âø†Ë™†Â∫¶', 'ÈáéÂøÉÂÄº', 'Ê¨äÂã¢', 'ÂØµÊÑõÂ∫¶'],
      systems: ['Ê¥æÁ≥ªÂã¢Âäõ', 'ÂæåÂÆÆ‰Ωç‰ªΩ', 'ÊúùÂ†ÇÊîøÊ≤ª'],
      tone: 'Ê≤âÁ©©Á¥∞ËÜ©',
      perspective: 'Á¨¨‰∫å‰∫∫Á®±'
    }
  },
  {
    id: 'cultivation',
    name: '‰øÆ‰ªôÁéÑÂπª',
    icon: '‚öîÔ∏è',
    desc: '‰øÆÁÖâ„ÄÅÊ≠∑Á∑¥„ÄÅÂïèÈÅìÈï∑Áîü',
    preset: {
      type: '‰øÆ‰ªôÁéÑÂπª',
      era: 'Êû∂Á©∫‰ªô‰ø†‰∏ñÁïå',
      attributes: ['Â¢ÉÁïå', 'ÈùàÂäõ', 'Â£ΩÂÖÉ', 'ÊÇüÊÄß', 'Ê∞£ÈÅã'],
      systems: ['ÂÆóÈñÄÈ´îÁ≥ª', 'ÂäüÊ≥ïÂÇ≥Êâø', 'Â§©ÊùêÂú∞ÂØ∂'],
      tone: 'ÁÜ±Ë°ÄÊøÄÊòÇ',
      perspective: 'Á¨¨‰∫å‰∫∫Á®±'
    }
  },
  {
    id: 'apocalypse',
    name: 'Êú´Êó•ÁîüÂ≠ò',
    icon: 'üßü',
    desc: 'Âª¢Âúü„ÄÅÂñ™Â±ç„ÄÅ‰∫∫ÊÄßËÄÉÈ©ó',
    preset: {
      type: 'Êú´Êó•ÁîüÂ≠ò',
      era: 'ËøëÊú™‰æÜÂª¢Âúü',
      attributes: ['ÁîüÂëΩÂÄº', 'È£¢È§ìÂ∫¶', 'Á≤æÁ•ûÂÄº', 'ÊÑüÊüìÂ∫¶', 'ËÅ≤Êúõ'],
      systems: ['ÊìöÈªûÂª∫Ë®≠', 'Áâ©Ë≥áÁÆ°ÁêÜ', 'ÂÄñÂ≠òËÄÖÈóú‰øÇ'],
      tone: 'Á∑äÂºµÂà∫ÊøÄ',
      perspective: 'Á¨¨‰∫å‰∫∫Á®±'
    }
  },
  {
    id: 'fantasy',
    name: 'Ë•øÂπªÂÜíÈö™',
    icon: 'üêâ',
    desc: 'ÂäçËàáÈ≠îÊ≥ïÁöÑÂè≤Ë©©ÊóÖÈÄî',
    preset: {
      type: 'Ë•øÊñπÂ•áÂπª',
      era: '‰∏≠‰∏ñÁ¥ÄÈ≠îÊ≥ï‰∏ñÁïå',
      attributes: ['HP', 'MP', 'ÂäõÈáè', 'ÊïèÊç∑', 'Êô∫Âäõ', 'È≠ÖÂäõ'],
      systems: ['ËÅ∑Ê•≠ÊàêÈï∑', 'ÊäÄËÉΩÊ®π', '‰ªªÂãôÁ≥ªÁµ±'],
      tone: 'Âè≤Ë©©Â£ØÈóò',
      perspective: 'Á¨¨‰∫å‰∫∫Á®±'
    }
  },
  {
    id: 'modern',
    name: 'ÈÉΩÂ∏ÇÊÉÖÊÑü',
    icon: 'üåÉ',
    desc: 'ÈÉΩÂ∏ÇÊÑõÊÉÖ„ÄÅËÅ∑Â†¥„ÄÅÊó•Â∏∏',
    preset: {
      type: 'Áèæ‰ª£ÈÉΩÂ∏Ç',
      era: 'Áï∂‰ª£ÈÉΩÂ∏Ç',
      attributes: ['Â•ΩÊÑüÂ∫¶', 'ÈáëÈå¢', 'Á§æÊúÉÂú∞‰Ωç', 'Â£ìÂäõÂÄº', 'È≠ÖÂäõ'],
      systems: ['Á§æ‰∫§Èóú‰øÇ', '‰∫ãÊ•≠ÁôºÂ±ï', 'ÊÉÖÊÑüÁ∑ö'],
      tone: 'ËºïÈ¨ÜÊµ™Êº´',
      perspective: 'Á¨¨‰∫å‰∫∫Á®±'
    }
  },
  {
    id: 'custom',
    name: 'Ëá™ÂÆöÁæ©',
    icon: '‚ú®',
    desc: 'ÂæûÈõ∂ÈñãÂßãÂâµÂª∫',
    preset: null
  }
];

// ÂêëÂ∞éÈöéÊÆµÂÆöÁæ©
const wizardSteps = [
  { id: 'template', title: 'ÈÅ∏ÊìáÊ®°Êùø', icon: 'üìã' },
  { id: 'basic', title: 'Âü∫Á§éË®≠ÂÆö', icon: 'üåç' },
  { id: 'protagonist', title: '‰∏ªËßíË®≠ÂÆö', icon: 'üë§' },
  { id: 'characters', title: 'ÈÖçËßíÁ≥ªÁµ±', icon: 'üë•' },
  { id: 'mechanics', title: 'ÈÅäÊà≤Ê©üÂà∂', icon: '‚öôÔ∏è' },
  { id: 'style', title: 'ÂØ´‰ΩúÈ¢®Ê†º', icon: '‚úçÔ∏è' },
  { id: 'aiRules', title: 'AIË°åÁÇ∫', icon: 'ü§ñ' },
  { id: 'finish', title: 'ÂÆåÊàêÁîüÊàê', icon: 'üéâ' }
];

// ÁØÑ‰æãÁâáÊÆµ
const wizardExamples = {
  basic: `## ‰∏ñÁïåËßÄË®≠ÂÆö
ÈÄôÊòØ‰∏ÄÂÄãÊû∂Á©∫ÁöÑÊù±ÊñπÂÆÆÂª∑‰∏ñÁïåÔºå‰ª•ÊòéÊ∏ÖÁÇ∫ËóçÊú¨‰ΩÜËûçÂÖ•‰∫ÜÊõ¥Â§öÂ•áÂπªÂÖÉÁ¥†„ÄÇÁöáÂüéÂàÜÁÇ∫Â§ñÊúùËàáÂÖßÂª∑ÔºåÂ§ñÊúùËôïÁêÜÊúùÊîøÔºåÂÖßÂª∑ÂâáÊòØÂêéÂ¶ÉÂ±ÖÊâÄ„ÄÇÂêéÂÆÆÂìÅÁ¥öÂæûÈ´òÂà∞‰ΩéÁÇ∫ÔºöÁöáÂêé„ÄÅÁöáË≤¥Â¶É„ÄÅË≤¥Â¶É„ÄÅÂ¶É„ÄÅÂ¨™„ÄÅË≤¥‰∫∫„ÄÅÂ∏∏Âú®„ÄÅÁ≠îÊáâ„ÄÇ`,
  protagonist: `## ‰∏ªËßíË®≠ÂÆö
‰Ω†ÊòØÂâõÂÖ•ÂÆÆÁöÑÊñ∞ÊôâË≤¥‰∫∫ÔºåÂá∫Ë∫´Ê±üÂçóÊõ∏È¶ôÈñÄÁ¨¨„ÄÇ‰Ω†Â§ñË°®Ê∫´Â©âÁ´ØËéäÔºåÂØ¶ÂâáËÅ∞ÊÖßÊ©üÊïèÔºåÂøÉ‰∏≠ÊúâËëóËá™Â∑±ÁöÑÂ†ÖÊåÅËàáÂ∫ïÁ∑ö„ÄÇ‰Ω†ÁöÑÁà∂Ë¶™ÊòØÁï∂ÊúùÁø∞ÊûóÔºåÂõ†ÂÆ∂ÊóèÈúÄË¶Å‰∏ÄÂÄãÂú®ÂÆÆ‰∏≠ÁöÑÊ£ãÂ≠êËÄåË¢´ÈÄÅÂÖ•ÂÆÆ‰∏≠„ÄÇ‰Ω†ÁöÑÁõÆÊ®ôÊòØÂú®ÈÄôÂêÉ‰∫∫ÁöÑÂæåÂÆÆ‰∏≠‰øùÂÖ®Ëá™Â∑±ÂíåÂÆ∂Êóè„ÄÇ`,
  characters: `## ‰∏ªË¶ÅËßíËâ≤
### ÁöáÂ∏ù - Ëï≠ÁÖú
Âπ¥Á¥Ñ‰∫åÂçÅ‰∫îÔºåÂú®‰Ωç‰∏âÂπ¥„ÄÇË°®Èù¢Ê∫´ÂíåÂØ°Ë®ÄÔºåÂØ¶ÂâáÂüéÂ∫úÊ•µÊ∑±„ÄÇÂ∞çÂæåÂÆÆË´∏‰∫ãÁúã‰ºº‰∏ç‰∏äÂøÉÔºåÂØ¶Ââá‰∏ÄÂàáÁõ°Âú®ÊéåÊè°„ÄÇÂñúÊÄí‰∏çÂΩ¢ÊñºËâ≤ÔºåËÆì‰∫∫Èõ£‰ª•ÊçâÊë∏„ÄÇ

### ÁöáÂêé - Ê≤àÊ∞è
Â§™ÂêéÂ®òÂÆ∂‰æÑÂ•≥ÔºåÁ´ØËéäË≥¢Ê∑ëÔºåËôï‰∫ãÂÖ¨ÂÖÅ„ÄÇ‰ΩÜÂú®ÁöáÂêéÁöÑÂ§ñË°®‰∏ãÔºåÊöóËóèËëóÂ∞çÊ¨äÂäõÁöÑÊ∏¥ÊúõÂíåÂ∞çËá™Ë∫´ËôïÂ¢ÉÁöÑ‰∏çÂÆâ„ÄÇ`,
  mechanics: `## ÈÅäÊà≤Ê©üÂà∂
### Â•ΩÊÑüÂ∫¶Á≥ªÁµ±
ÊØèÂÄãËßíËâ≤ÊúâÂÖ©ÂÄãÂ•ΩÊÑüÂ∫¶Êï∏ÂÄºÔºö
- Ë°®Èù¢Â•ΩÊÑüÔºöNPC Â∞ç‰∏ªËßíÂ±ïÁèæÁöÑÊÖãÂ∫¶Ôºà0-100Ôºâ
- ÁúüÂØ¶Â•ΩÊÑüÔºöNPC ÂÖßÂøÉÁúüÂØ¶ÁöÑÊÉ≥Ê≥ïÔºà0-100Ôºâ
È´òË°®Èù¢Â•ΩÊÑü+‰ΩéÁúüÂØ¶Â•ΩÊÑü=ÂèØËÉΩÊòØÂÅΩË£ù
‰ΩéË°®Èù¢Â•ΩÊÑü+È´òÁúüÂØ¶Â•ΩÊÑü=ÂÇ≤Â¨å/Ê∑±Ëóè‰∏çÈú≤

### ÊØèÊ¨°‰∫íÂãïÂæåË´ãÊõ¥Êñ∞ÁãÄÊÖãÔºö
\`\`\`
„ÄêÁãÄÊÖãÊõ¥Êñ∞„Äë
ÊôÇÈñìÔºöXXÂπ¥XXÊúàXXÊó• XXÊôÇ
Âú∞ÈªûÔºöXXX
ËßíËâ≤ÁãÄÊÖãËÆäÂåñÔºö
- XXXÔºöË°®Èù¢Â•ΩÊÑü +5 ‚Üí 75ÔºåÁúüÂØ¶Â•ΩÊÑü ‰∏çËÆä 50
\`\`\``,
  style: `## ÂØ´‰ΩúÈ¢®Ê†ºË¶ÅÊ±Ç
- Êé°Áî®Âè§È¢®ÂÖ∏ÈõÖÁöÑÊñáÂ≠óÈ¢®Ê†ºÔºåÈÅ©Áï∂‰ΩøÁî®Ë©©Ë©ûÂÖ∏ÊïÖ
- ÊèèÂØ´Á¥∞ËÜ©ÔºåÊ≥®ÈáçÊ∞õÂúçÁáüÈÄ†ÂíåÂøÉÁêÜÂàªÁï´
- Â∞çË©±Ë¶ÅÁ¨¶ÂêàËßíËâ≤Ë∫´‰ªΩÔºåÂÆÆÂª∑Áî®Ë™ûÂæóÈ´î
- ÊØèÊÆµÂõûË¶ÜÊéßÂà∂Âú®800-1500Â≠ó
- ÈÅ©ÊôÇÂä†ÂÖ•Áí∞Â¢ÉÊèèÂØ´ÂíåËßíËâ≤ÂæÆË°®ÊÉÖÁ¥∞ÁØÄ`
};

// ÂïüÂãïÂêëÂ∞é
function startWizard() {
  wizardState = {
    step: 0,
    data: {
      template: null,
      basic: { type: '', era: '', setting: '', theme: '' },
      protagonist: { name: '', identity: '', gender: '', personality: '', appearance: '', background: '', goal: '' },
      characters: [],
      mechanics: { attributes: [], systems: [], triggers: [] },
      style: { tone: '', perspective: '', detail: '', format: '' },
      aiRules: { dos: [], donts: [], special: '' },
      examples: { opening: '', response: '', status: '' },
      aiChat: []
    },
    aiAsked: false
  };
  renderWizardStep();
  goTo('view-wizard');
}

function exitWizard() {
  showConfirm('Á¢∫ÂÆöË¶ÅÈÄÄÂá∫ÂóéÔºüÂ∑≤Â°´ÂØ´ÁöÑÂÖßÂÆπÂ∞á‰∏çÊúÉ‰øùÂ≠ò„ÄÇ', () => {
    goBack();
  });
}

function showWizardHelp() {
  showConfirm(
    'Êåá‰ª§ÁîüÊàêÂêëÂ∞éÂπ´Âä©\n\n' +
    'ÈÄôÂÄãÂêëÂ∞éÂ∞áÂºïÂ∞é‰Ω†ÂâµÂª∫‰∏ÄÂÄãÂÆåÊï¥ÁöÑÊñáÊ∏∏Êåá‰ª§„ÄÇ\n\n' +
    '‚Ä¢ ÂÖ± 8 ÂÄãÊ≠•È©üÔºåÂèØÈö®ÊôÇËøîÂõû‰øÆÊîπ\n' +
    '‚Ä¢ ÊØèÊ≠•ÈÉΩÊúâ AI Êô∫ËÉΩÊèêÂïèÂπ´Âä©ÂÆåÂñÑ\n' +
    '‚Ä¢ ÊúÄÂæåÂèØÂ∞éÂá∫ÁÇ∫ÊñáÊ™îÊàñ‰øùÂ≠òÁÇ∫Êåá‰ª§\n\n' +
    'Â∞èÊäÄÂ∑ßÔºöÈÅ∏ÊìáÈ†êË®≠Ê®°ÊùøÂèØ‰ª•Âø´ÈÄüÈñãÂßãÔºÅ',
    null, false, 'üí° Âπ´Âä©'
  );
}

// Ê∏≤ÊüìÁï∂ÂâçÊ≠•È©ü
function renderWizardStep() {
  const step = wizardSteps[wizardState.step];
  document.getElementById('wizard-title').textContent = step.title;
  document.getElementById('wizard-progress-fill').style.width = ((wizardState.step + 1) / wizardSteps.length * 100) + '%';
  document.getElementById('wizard-progress-text').textContent = `${wizardState.step + 1}/${wizardSteps.length} ${step.title}`;
  
  // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
  document.getElementById('wizard-prev').disabled = wizardState.step === 0;
  const nextBtn = document.getElementById('wizard-next');
  if (wizardState.step === wizardSteps.length - 1) {
    nextBtn.textContent = 'ÂÆåÊàê';
  } else {
    nextBtn.textContent = '‰∏ã‰∏ÄÊ≠•';
  }
  
  const content = document.getElementById('wizard-content');
  wizardState.aiAsked = false;
  
  switch(step.id) {
    case 'template': renderTemplateStep(content); break;
    case 'basic': renderBasicStep(content); break;
    case 'protagonist': renderProtagonistStep(content); break;
    case 'characters': renderCharactersStep(content); break;
    case 'mechanics': renderMechanicsStep(content); break;
    case 'style': renderStyleStep(content); break;
    case 'aiRules': renderAiRulesStep(content); break;
    case 'finish': renderFinishStep(content); break;
  }
}

// Ê≠•È©ü 0ÔºöÈÅ∏ÊìáÊ®°Êùø
function renderTemplateStep(container) {
  container.innerHTML = `
    <div class="wizard-section">
      <div class="wizard-section-title">üìã ÈÅ∏Êìá‰∏ÄÂÄãÊ®°ÊùøÈñãÂßã</div>
      <div class="wizard-section-desc">ÈÅ∏ÊìáÈ†êË®≠Ê®°ÊùøÂèØ‰ª•Âø´ÈÄüÂ°´ÂÖÖÂ∏∏Áî®Ë®≠ÂÆöÔºå‰Ω†‰πüÂèØ‰ª•ÈÅ∏Êìá„ÄåËá™ÂÆöÁæ©„ÄçÂæûÈõ∂ÈñãÂßã„ÄÇ</div>
      <div class="wizard-options">
        ${wizardTemplates.map(t => `
          <div class="wizard-option template ${wizardState.data.template === t.id ? 'selected' : ''}" onclick="selectTemplate('${t.id}')">
            <div class="template-icon">${t.icon}</div>
            <div class="template-name">${t.name}</div>
            <div class="template-desc">${t.desc}</div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

function selectTemplate(id) {
  wizardState.data.template = id;
  const template = wizardTemplates.find(t => t.id === id);
  if (template?.preset) {
    // ÊáâÁî®È†êË®≠
    wizardState.data.basic.type = template.preset.type || '';
    wizardState.data.basic.era = template.preset.era || '';
    wizardState.data.mechanics.attributes = template.preset.attributes || [];
    wizardState.data.mechanics.systems = template.preset.systems || [];
    wizardState.data.style.tone = template.preset.tone || '';
    wizardState.data.style.perspective = template.preset.perspective || '';
  }
  renderWizardStep();
}

// Ê≠•È©ü 1ÔºöÂü∫Á§éË®≠ÂÆö
function renderBasicStep(container) {
  const d = wizardState.data.basic;
  container.innerHTML = `
    <div class="wizard-section">
      <div class="wizard-section-title">üåç ‰∏ñÁïåËßÄÂü∫Á§éË®≠ÂÆö</div>
      <div class="wizard-section-desc">ÂÆöÁæ©ÊïÖ‰∫ãÁôºÁîüÁöÑ‰∏ñÁïåËÉåÊôØÔºåÈÄôÂ∞áÊ±∫ÂÆöÊï¥ÂÄãÊïÖ‰∫ãÁöÑÂü∫Ë™ø„ÄÇ</div>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">ÊïÖ‰∫ãÈ°ûÂûã</label>
      <input class="wizard-input" id="wiz-type" value="${esc(d.type)}" placeholder="Â¶ÇÔºöÂÆÆÂª∑ÂæåÂÆÆ„ÄÅ‰øÆ‰ªôÁéÑÂπª„ÄÅÊú´Êó•ÁîüÂ≠ò...">
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">ÊôÇ‰ª£ËÉåÊôØ</label>
      <input class="wizard-input" id="wiz-era" value="${esc(d.era)}" placeholder="Â¶ÇÔºöÊû∂Á©∫Âè§‰ª£„ÄÅËøëÊú™‰æÜ„ÄÅ‰∏≠‰∏ñÁ¥ÄÈ≠îÊ≥ï‰∏ñÁïå...">
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">‰∏ñÁïåËßÄË®≠ÂÆö</label>
      <textarea class="wizard-input wizard-textarea" id="wiz-setting" placeholder="ÊèèËø∞ÈÄôÂÄã‰∏ñÁïåÁöÑÁç®ÁâπË®≠ÂÆö„ÄÅË¶èÂâá„ÄÅÊ≠∑Âè≤ËÉåÊôØÁ≠â...">${esc(d.setting)}</textarea>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">Ê†∏ÂøÉ‰∏ªÈ°å</label>
      <input class="wizard-input" id="wiz-theme" value="${esc(d.theme)}" placeholder="Â¶ÇÔºöÊ¨äË¨ÄÈ¨•Áà≠„ÄÅÊàêÈï∑ËõªËÆä„ÄÅÊÑõÊÅ®Á≥æËëõ...">
      
      <div class="wizard-example">
        <div class="wizard-example-title">üìù ÁØÑ‰æãÂèÉËÄÉ</div>
        ${wizardExamples.basic}
      </div>
    </div>
    <div class="wizard-ai-container"></div>
  `;
  
  // Ëá™ÂãïËß∏Áôº AI ÊèêÂïè
  setTimeout(() => askWizardAI('basic'), 500);
}

// Ê≠•È©ü 2Ôºö‰∏ªËßíË®≠ÂÆö
function renderProtagonistStep(container) {
  const d = wizardState.data.protagonist;
  container.innerHTML = `
    <div class="wizard-section">
      <div class="wizard-section-title">üë§ ‰∏ªËßíË®≠ÂÆö</div>
      <div class="wizard-section-desc">Ë©≥Á¥∞Ë®≠ÂÆö‰∏ªËßíÁöÑÂêÑÈ†ÖÂ±¨ÊÄßÔºåÈÄôÂ∞áÊòØÁé©ÂÆ∂‰ª£ÂÖ•ÁöÑËßíËâ≤„ÄÇ</div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div>
          <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">Á®±Âëº/ÂêçÂ≠ó</label>
          <input class="wizard-input" id="wiz-pname" value="${esc(d.name)}" placeholder="Â¶ÇÔºö‰Ω†„ÄÅÂ∞ë‰ø†„ÄÅÊÆø‰∏ã...">
        </div>
        <div>
          <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">ÊÄßÂà•</label>
          <select class="wizard-input" id="wiz-pgender" style="padding:12px">
            <option value="">Ë´ãÈÅ∏Êìá</option>
            <option value="male" ${d.gender==='male'?'selected':''}>Áî∑</option>
            <option value="female" ${d.gender==='female'?'selected':''}>Â•≥</option>
            <option value="custom" ${d.gender==='custom'?'selected':''}>Ëá™ÂÆöÁæ©/‰∏çÈôê</option>
          </select>
        </div>
      </div>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">Ë∫´‰ªΩÂú∞‰Ωç</label>
      <input class="wizard-input" id="wiz-pidentity" value="${esc(d.identity)}" placeholder="Â¶ÇÔºöÊñ∞ÊôâË≤¥‰∫∫„ÄÅÊï£‰øÆ„ÄÅÂÄñÂ≠òËÄÖ...">
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">ÊÄßÊ†ºÁâπÈªû</label>
      <input class="wizard-input" id="wiz-ppersonality" value="${esc(d.personality)}" placeholder="Â¶ÇÔºöÂ§ñÊüîÂÖßÂâõ„ÄÅËÖπÈªëÊ©üÊô∫„ÄÅÁÜ±Ë°ÄÊ≠£Áõ¥...">
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">Â§ñË≤åÊèèËø∞</label>
      <textarea class="wizard-input wizard-textarea" id="wiz-pappearance" placeholder="‰∏ªËßíÁöÑÂ§ñË≤åÁâπÂæµ...">${esc(d.appearance)}</textarea>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">ËÉåÊôØÊïÖ‰∫ã</label>
      <textarea class="wizard-input wizard-textarea" id="wiz-pbackground" placeholder="‰∏ªËßíÁöÑË∫´‰∏ñ„ÄÅ‰æÜÊ≠∑„ÄÅÈÅéÂéªÁöÑÁ∂ìÊ≠∑...">${esc(d.background)}</textarea>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">ÁõÆÊ®ô/ÂãïÊ©ü</label>
      <input class="wizard-input" id="wiz-pgoal" value="${esc(d.goal)}" placeholder="‰∏ªËßíÂú®ÊïÖ‰∫ã‰∏≠ÁöÑÁõÆÊ®ôÊòØ‰ªÄÈ∫ºÔºü">
      
      <div class="wizard-example">
        <div class="wizard-example-title">üìù ÁØÑ‰æãÂèÉËÄÉ</div>
        ${wizardExamples.protagonist}
      </div>
    </div>
    <div class="wizard-ai-container"></div>
  `;
  
  setTimeout(() => askWizardAI('protagonist'), 500);
}

// Ê≠•È©ü 3ÔºöÈÖçËßíÁ≥ªÁµ±
function renderCharactersStep(container) {
  const chars = wizardState.data.characters;
  container.innerHTML = `
    <div class="wizard-section">
      <div class="wizard-section-title">üë• ÈÖçËßíÁ≥ªÁµ±</div>
      <div class="wizard-section-desc">Ê∑ªÂä†ÊïÖ‰∫ã‰∏≠ÁöÑÈáçË¶Å NPCÔºåË±êÂØåÁöÑÈÖçËßíËÉΩËÆìÊïÖ‰∫ãÊõ¥Á≤æÂΩ©„ÄÇÂª∫Ë≠∞Ëá≥Â∞ë 3-5 ÂÄã‰∏ªË¶ÅËßíËâ≤„ÄÇ</div>
      
      <div class="wizard-char-list" id="wizard-char-list">
        ${chars.length ? chars.map((c, i) => `
          <div class="wizard-char-card">
            <div class="wizard-char-avatar">${c.avatar || 'üë§'}</div>
            <div class="wizard-char-info">
              <div class="wizard-char-name">${esc(c.name)}</div>
              <div class="wizard-char-role">${esc(c.role)} ¬∑ ${esc(c.relation)}</div>
            </div>
            <div class="wizard-char-actions">
              <button class="wizard-char-btn" onclick="editWizardChar(${i})">‚úèÔ∏è</button>
              <button class="wizard-char-btn" onclick="deleteWizardChar(${i})">üóëÔ∏è</button>
            </div>
          </div>
        `).join('') : '<div style="text-align:center;padding:20px;color:var(--text-tertiary)">Â∞öÊú™Ê∑ªÂä†ËßíËâ≤</div>'}
      </div>
      
      <button class="wizard-btn secondary" style="width:100%;margin-top:12px" onclick="addWizardChar()">‚ûï Ê∑ªÂä†ËßíËâ≤</button>
      <button class="wizard-btn secondary" style="width:100%;margin-top:8px" onclick="aiGenerateChars()">ü§ñ AI Âª∫Ë≠∞ËßíËâ≤</button>
      
      <div class="wizard-example">
        <div class="wizard-example-title">üìù ÁØÑ‰æãÂèÉËÄÉ</div>
        ${wizardExamples.characters}
      </div>
    </div>
    <div class="wizard-ai-container"></div>
  `;
  
  setTimeout(() => askWizardAI('characters'), 500);
}

// Ê≠•È©ü 4ÔºöÈÅäÊà≤Ê©üÂà∂
function renderMechanicsStep(container) {
  const d = wizardState.data.mechanics;
  const attrOptions = ['Â•ΩÊÑüÂ∫¶', 'Â•ΩÊÑüÂ∫¶(Ë°®Èù¢/ÁúüÂØ¶)', 'Âø†Ë™†Â∫¶', 'ÈáéÂøÉÂÄº', 'Ê¨äÂã¢', 'ÂØµÊÑõÂ∫¶', 'Â¢ÉÁïå', 'ÈùàÂäõ', 'Â£ΩÂÖÉ', 'ÁîüÂëΩÂÄº', 'È£¢È§ìÂ∫¶', 'Á≤æÁ•ûÂÄº', 'HP', 'MP', 'ÂäõÈáè', 'ÊïèÊç∑', 'Êô∫Âäõ', 'È≠ÖÂäõ', 'ÈáëÈå¢', 'ËÅ≤Êúõ'];
  const sysOptions = ['Ê¥æÁ≥ªÂã¢Âäõ', 'Â•ΩÊÑüÂ∫¶Á≥ªÁµ±', 'Êï∏ÂÄºÊàêÈï∑', 'ÊäÄËÉΩÊ®π', '‰ªªÂãôÁ≥ªÁµ±', 'Áâ©Ë≥áÁÆ°ÁêÜ', 'ÊìöÈªûÂª∫Ë®≠', 'ÊôÇÈñìÊµÅÈÄù', 'Èö±Ëóè‰∫ã‰ª∂', 'Â§öÁµêÂ±ÄÂàÜÊîØ', 'Èö®Ê©ü‰∫ã‰ª∂'];
  
  container.innerHTML = `
    <div class="wizard-section">
      <div class="wizard-section-title">‚öôÔ∏è ÈÅäÊà≤Ê©üÂà∂Ë®≠Ë®à</div>
      <div class="wizard-section-desc">Ë®≠Ë®àËÆìÊïÖ‰∫ãÊõ¥Êúâ‰∫íÂãïÊÄßÁöÑÊ©üÂà∂ÔºåÂêàÁêÜÁöÑÊ©üÂà∂ËÉΩÂ¢ûÂº∑‰ª£ÂÖ•ÊÑü„ÄÇ</div>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">ËßíËâ≤Â±¨ÊÄßÔºàÂèØÂ§öÈÅ∏Ôºâ</label>
      <div class="wizard-options" style="margin-bottom:16px">
        ${attrOptions.map(a => `
          <div class="wizard-option ${d.attributes.includes(a)?'selected':''}" onclick="toggleWizardOption('attributes','${a}')">${a}</div>
        `).join('')}
      </div>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">Ëá™ÂÆöÁæ©Â±¨ÊÄß</label>
      <input class="wizard-input" id="wiz-custom-attr" placeholder="Ëº∏ÂÖ•ÂæåÊåâ Enter Ê∑ªÂä†">
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px;margin-top:16px">ÈÅäÊà≤Á≥ªÁµ±ÔºàÂèØÂ§öÈÅ∏Ôºâ</label>
      <div class="wizard-options" style="margin-bottom:16px">
        ${sysOptions.map(s => `
          <div class="wizard-option ${d.systems.includes(s)?'selected':''}" onclick="toggleWizardOption('systems','${s}')">${s}</div>
        `).join('')}
      </div>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">ÁâπÊÆäËß∏ÁôºÊ©üÂà∂</label>
      <textarea class="wizard-input wizard-textarea" id="wiz-triggers" placeholder="ÊèèËø∞‰∏Ä‰∫õÁâπÊÆäÁöÑËß∏ÁôºÊ¢ù‰ª∂Ôºå‰æãÂ¶ÇÔºöÂ•ΩÊÑüÂ∫¶ÈÅîÂà∞ 80 ÊôÇËß£ÈéñÁâπÊÆäÂäáÊÉÖ...">${d.triggers.join('\n')}</textarea>
      
      <div class="wizard-example">
        <div class="wizard-example-title">üìù ÁØÑ‰æãÂèÉËÄÉ</div>
        ${wizardExamples.mechanics}
      </div>
    </div>
    <div class="wizard-ai-container"></div>
  `;
  
  // Ëá™ÂÆöÁæ©Â±¨ÊÄßËº∏ÂÖ•
  document.getElementById('wiz-custom-attr')?.addEventListener('keypress', e => {
    if (e.key === 'Enter' && e.target.value.trim()) {
      if (!d.attributes.includes(e.target.value.trim())) {
        d.attributes.push(e.target.value.trim());
        renderMechanicsStep(container);
      }
      e.target.value = '';
    }
  });
  
  setTimeout(() => askWizardAI('mechanics'), 500);
}

function toggleWizardOption(type, value) {
  const arr = wizardState.data.mechanics[type];
  const idx = arr.indexOf(value);
  if (idx >= 0) arr.splice(idx, 1);
  else arr.push(value);
  renderWizardStep();
}

// Ê≠•È©ü 5ÔºöÂØ´‰ΩúÈ¢®Ê†º
function renderStyleStep(container) {
  const d = wizardState.data.style;
  container.innerHTML = `
    <div class="wizard-section">
      <div class="wizard-section-title">‚úçÔ∏è ÂØ´‰ΩúÈ¢®Ê†ºË®≠ÂÆö</div>
      <div class="wizard-section-desc">ÂÆöÁæ© AI ÁöÑÂØ´‰ΩúÈ¢®Ê†ºÔºåËÆìÊïÖ‰∫ãÂëàÁèæÁ¨¶Âêà‰Ω†ÊúüÊúõÁöÑË≥™ÊÑü„ÄÇ</div>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">ÊñáÈ¢®Âü∫Ë™ø</label>
      <div class="wizard-options" style="margin-bottom:16px">
        ${['ËºïÈ¨ÜÊ≠°Âø´', 'Ê≤âÁ©©Á¥∞ËÜ©', 'ÁÜ±Ë°ÄÊøÄÊòÇ', 'ÈªëÊöóÂ£ìÊäë', 'Êµ™Êº´ÂîØÁæé', 'ÂπΩÈªòË´∑Âà∫', 'Âè≤Ë©©Â£ØÈóò', 'Êá∏ÁñëÁ∑äÂºµ'].map(t => `
          <div class="wizard-option ${d.tone===t?'selected':''}" onclick="wizardState.data.style.tone='${t}';renderWizardStep()">${t}</div>
        `).join('')}
      </div>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">Êïò‰∫ãË¶ñËßí</label>
      <div class="wizard-options" style="margin-bottom:16px">
        ${['Á¨¨‰∏Ä‰∫∫Á®±', 'Á¨¨‰∫å‰∫∫Á®±', 'Á¨¨‰∏â‰∫∫Á®±', '‰∏äÂ∏ùË¶ñËßí'].map(p => `
          <div class="wizard-option ${d.perspective===p?'selected':''}" onclick="wizardState.data.style.perspective='${p}';renderWizardStep()">${p}</div>
        `).join('')}
      </div>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">Á¥∞ÁØÄÁ®ãÂ∫¶</label>
      <div class="wizard-options" style="margin-bottom:16px">
        ${['Á∞°ÊΩîÊòéÂø´Ôºà300-500Â≠óÔºâ', 'ÈÅ©‰∏≠Ë©≥Á¥∞Ôºà500-1000Â≠óÔºâ', 'Ë±êÂØåÁ¥∞ËÜ©Ôºà1000-2000Â≠óÔºâ', 'Ë∂ÖÈï∑ÁØáÂπÖÔºà2000Â≠ó+Ôºâ'].map(d2 => `
          <div class="wizard-option ${d.detail===d2?'selected':''}" onclick="wizardState.data.style.detail='${d2}';renderWizardStep()">${d2}</div>
        `).join('')}
      </div>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">ÁâπÊÆäÊ†ºÂºèË¶ÅÊ±Ç</label>
      <textarea class="wizard-input wizard-textarea" id="wiz-format" placeholder="‰æãÂ¶ÇÔºöÊØèÊÆµÈñãÈ†≠Á©∫ÂÖ©Ê†º„ÄÅÂ∞çË©±Áî®„Äå„Äç„ÄÅÂÖßÂøÉÁç®ÁôΩÁî®ÔºàÔºâ...">${esc(d.format)}</textarea>
      
      <div class="wizard-example">
        <div class="wizard-example-title">üìù ÁØÑ‰æãÂèÉËÄÉ</div>
        ${wizardExamples.style}
      </div>
    </div>
    <div class="wizard-ai-container"></div>
  `;
  
  setTimeout(() => askWizardAI('style'), 500);
}

// Ê≠•È©ü 6ÔºöAI Ë°åÁÇ∫Ë¶èÂâá
function renderAiRulesStep(container) {
  const d = wizardState.data.aiRules;
  container.innerHTML = `
    <div class="wizard-section">
      <div class="wizard-section-title">ü§ñ AI Ë°åÁÇ∫Ë¶èÂâá</div>
      <div class="wizard-section-desc">Ë®≠ÂÆö AI ÊáâË©≤ÂÅö‰ªÄÈ∫º„ÄÅ‰∏çË©≤ÂÅö‰ªÄÈ∫ºÔºåÁ¢∫‰øùÊïÖ‰∫ãÊåâ‰Ω†ÁöÑÊúüÊúõÁôºÂ±ï„ÄÇ</div>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">AI ÊáâË©≤ÂÅöÁöÑÔºàDosÔºâ</label>
      <textarea class="wizard-input wizard-textarea" id="wiz-dos" placeholder="ÊØèË°å‰∏ÄÊ¢ùÔºå‰æãÂ¶ÇÔºö
- ‰øùÊåÅËßíËâ≤ÊÄßÊ†º‰∏ÄËá¥ÊÄß
- ÈÅ©ÊôÇÁµ¶Âá∫Ë°åÂãïÈÅ∏È†Ö
- ÊèèÂØ´ËßíËâ≤ÂæÆË°®ÊÉÖËÆäÂåñ">${d.dos.join('\n')}</textarea>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">AI ‰∏çÊáâË©≤ÂÅöÁöÑÔºàDon'tsÔºâ</label>
      <textarea class="wizard-input wizard-textarea" id="wiz-donts" placeholder="ÊØèË°å‰∏ÄÊ¢ùÔºå‰æãÂ¶ÇÔºö
- ‰∏çË¶ÅÊìÖËá™Ê±∫ÂÆö‰∏ªËßíÁöÑË°åÂãï
- ‰∏çË¶ÅË∑≥ÈÅéÈáçË¶ÅÂäáÊÉÖ
- ‰∏çË¶ÅËÆìËßíËâ≤Á™ÅÁÑ∂ÊÄßÊ†ºÂ§ßËÆä">${d.donts.join('\n')}</textarea>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">ÁâπÊÆäÊåá‰ª§</label>
      <textarea class="wizard-input wizard-textarea" id="wiz-special" placeholder="ÂÖ∂‰ªñÁâπÊÆäË¶ÅÊ±Ç...">${esc(d.special)}</textarea>
    </div>
    <div class="wizard-ai-container"></div>
  `;
  
  setTimeout(() => askWizardAI('aiRules'), 500);
}

// Ê≠•È©ü 7ÔºöÂÆåÊàê
function renderFinishStep(container) {
  const prompt = generatePrompt();
  const charCount = prompt.length;
  
  container.innerHTML = `
    <div class="wizard-section">
      <div class="wizard-section-title">üéâ Êåá‰ª§ÁîüÊàêÂÆåÊàêÔºÅ</div>
      <div class="wizard-section-desc">‰Ω†ÁöÑÊñáÊ∏∏Êåá‰ª§Â∑≤ÁîüÊàêÔºåÂèØ‰ª•È†êË¶Ω„ÄÅÁ∑®ËºØÊàñ‰øùÂ≠ò„ÄÇ</div>
      
      <div class="wizard-preview">
        <div class="wizard-preview-header">
          <div class="wizard-preview-title">üìÑ Êåá‰ª§È†êË¶Ω</div>
          <div class="wizard-preview-stats">${charCount.toLocaleString()} Â≠ó</div>
        </div>
        <div class="wizard-preview-content" id="wizard-preview-content">${esc(prompt.slice(0, 2000))}${prompt.length > 2000 ? '\n\n... (ÈªûÊìäÂ±ïÈñãÊü•ÁúãÊõ¥Â§ö)' : ''}</div>
      </div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:16px">
        <button class="wizard-btn secondary" onclick="previewFullPrompt()">üëÅÔ∏è ÂÆåÊï¥È†êË¶Ω</button>
        <button class="wizard-btn secondary" onclick="editPrompt()">‚úèÔ∏è Á∑®ËºØÂæÆË™ø</button>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
        <button class="wizard-btn secondary" onclick="exportPrompt('md')">üìÑ Â∞éÂá∫ MD</button>
        <button class="wizard-btn secondary" onclick="exportPrompt('txt')">üìù Â∞éÂá∫ TXT</button>
      </div>
      <button class="wizard-btn primary" style="width:100%;margin-top:8px" onclick="saveAsInstruction()">üíæ ‰øùÂ≠òÁÇ∫Êåá‰ª§</button>
    </div>
    
    <div class="wizard-section" style="margin-top:24px">
      <div class="wizard-section-title">üí¨ AI Â∞çË©±ÂÆåÂñÑ</div>
      <div class="wizard-section-desc">ÈÇÑÊúâ‰ªÄÈ∫ºÊÉ≥Ë£úÂÖÖÁöÑÔºüÂèØ‰ª•Âíå AI Â∞çË©±ÁπºÁ∫åÂÆåÂñÑÊåá‰ª§„ÄÇ</div>
      <div class="wizard-chat" id="wizard-chat">
        ${wizardState.data.aiChat.map(m => `
          <div class="wizard-chat-msg ${m.role}">${marked.parse(m.content)}</div>
        `).join('')}
      </div>
      <div class="wizard-chat-input">
        <input class="wizard-chat-field" id="wizard-chat-input" placeholder="Ëº∏ÂÖ•‰Ω†ÁöÑÊÉ≥Ê≥ï..." onkeypress="if(event.key==='Enter')sendWizardChat()">
        <button class="wizard-chat-send" onclick="sendWizardChat()">‚û§</button>
      </div>
    </div>
  `;
}

// ‰øùÂ≠òÁï∂ÂâçÊ≠•È©üÊï∏Êìö
function saveWizardStepData() {
  const step = wizardSteps[wizardState.step];
  switch(step.id) {
    case 'basic':
      wizardState.data.basic = {
        type: document.getElementById('wiz-type')?.value || '',
        era: document.getElementById('wiz-era')?.value || '',
        setting: document.getElementById('wiz-setting')?.value || '',
        theme: document.getElementById('wiz-theme')?.value || ''
      };
      break;
    case 'protagonist':
      wizardState.data.protagonist = {
        name: document.getElementById('wiz-pname')?.value || '',
        identity: document.getElementById('wiz-pidentity')?.value || '',
        gender: document.getElementById('wiz-pgender')?.value || '',
        personality: document.getElementById('wiz-ppersonality')?.value || '',
        appearance: document.getElementById('wiz-pappearance')?.value || '',
        background: document.getElementById('wiz-pbackground')?.value || '',
        goal: document.getElementById('wiz-pgoal')?.value || ''
      };
      break;
    case 'mechanics':
      const triggers = document.getElementById('wiz-triggers')?.value || '';
      wizardState.data.mechanics.triggers = triggers.split('\n').filter(t => t.trim());
      break;
    case 'style':
      wizardState.data.style.format = document.getElementById('wiz-format')?.value || '';
      break;
    case 'aiRules':
      const dos = document.getElementById('wiz-dos')?.value || '';
      const donts = document.getElementById('wiz-donts')?.value || '';
      wizardState.data.aiRules = {
        dos: dos.split('\n').filter(t => t.trim()),
        donts: donts.split('\n').filter(t => t.trim()),
        special: document.getElementById('wiz-special')?.value || ''
      };
      break;
  }
}

// ‰∏ä‰∏ÄÊ≠•/‰∏ã‰∏ÄÊ≠•
function wizardPrev() {
  if (wizardState.step > 0) {
    saveWizardStepData();
    wizardState.step--;
    renderWizardStep();
  }
}

function wizardNext() {
  saveWizardStepData();
  if (wizardState.step < wizardSteps.length - 1) {
    wizardState.step++;
    renderWizardStep();
  } else {
    saveAsInstruction();
  }
}

// AI ÊèêÂïè
async function askWizardAI(stepId) {
  if (wizardState.aiAsked) return;
  wizardState.aiAsked = true;
  
  const box = document.querySelector('.wizard-ai-container');
  if (!box) return;
  
  box.innerHTML = `
    <div class="wizard-ai-box">
      <div class="wizard-ai-header"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span> AI Ê≠£Âú®ÊÄùËÄÉ...</div>
    </div>
  `;
  
  try {
    const preset = await db.apiPresets.filter(p => p.isActive).first();
    if (!preset) {
      box.innerHTML = `<div class="wizard-ai-box"><div class="wizard-ai-header">‚ö†Ô∏è ÊèêÁ§∫</div><div class="wizard-ai-content">Ë´ãÂÖàÂú®Ë®≠ÁΩÆ‰∏≠ÈÖçÁΩÆ APIÔºåÊâçËÉΩ‰ΩøÁî® AI Êô∫ËÉΩÊèêÂïèÂäüËÉΩ„ÄÇ</div></div>`;
      return;
    }
    
    const context = JSON.stringify(wizardState.data, null, 2);
    const prompts = {
      basic: `Áî®Êà∂Ê≠£Âú®ÂâµÂª∫ÊñáÊ∏∏Êåá‰ª§ÔºåÁõÆÂâçÂ°´ÂØ´ÁöÑÂü∫Á§éË®≠ÂÆöÂ¶Ç‰∏ãÔºö
${context}

Ë´ãÊ†πÊìöÁî®Êà∂Â°´ÂØ´ÁöÑÂÖßÂÆπÔºåÊèêÂá∫ 1-2 ÂÄãÊúâÈáùÂ∞çÊÄßÁöÑÂïèÈ°åÔºåÂπ´Âä©ÂÆåÂñÑ‰∏ñÁïåËßÄË®≠ÂÆö„ÄÇÂïèÈ°åË¶ÅÂÖ∑È´î„ÄÅÊúâÂª∫Ë®≠ÊÄß„ÄÇÂ¶ÇÊûúÂÖßÂÆπÂ∑≤Á∂ìÂæàÂÆåÊï¥ÔºåÂèØ‰ª•Áµ¶Âá∫ËÇØÂÆö‰∏¶ÊèêÂá∫ÈÄ≤ÈöéÂª∫Ë≠∞„ÄÇÂõûË¶ÜË¶ÅÁ∞°ÊΩîÔºà100Â≠óÂÖßÔºâ„ÄÇ`,
      protagonist: `Áî®Êà∂Ê≠£Âú®Ë®≠ÂÆöÊñáÊ∏∏ÁöÑ‰∏ªËßíÔºö
${context}

Ë´ãÊ†πÊìö‰∏ªËßíË®≠ÂÆöÔºåÊèêÂá∫ 1-2 ÂÄãÂïèÈ°åÂπ´Âä©ÂÆåÂñÑ„ÄÇÂèØ‰ª•ÂïèÔºö‰∏ªËßíÁöÑÂº±Èªû/Áº∫Èô∑ÊòØ‰ªÄÈ∫ºÔºüÊúâ‰ªÄÈ∫ºÁâπÊÆäÊäÄËÉΩÊàñËÉåÊôØÊïÖ‰∫ãÔºüÂõûË¶ÜÁ∞°ÊΩîÔºà100Â≠óÂÖßÔºâ„ÄÇ`,
      characters: `Áî®Êà∂Ê≠£Âú®Ê∑ªÂä†ÈÖçËßíÔºö
${context}

Ë´ãÊ†πÊìöÊïÖ‰∫ãÈ°ûÂûãÂíåÂ∑≤ÊúâËßíËâ≤ÔºåÂª∫Ë≠∞ÈÇÑÈúÄË¶Å‰ªÄÈ∫ºÈ°ûÂûãÁöÑËßíËâ≤ÔºåÊàñÊèêÂïèÁèæÊúâËßíËâ≤ÁöÑÁ¥∞ÁØÄ„ÄÇÂõûË¶ÜÁ∞°ÊΩîÔºà100Â≠óÂÖßÔºâ„ÄÇ`,
      mechanics: `Áî®Êà∂Ê≠£Âú®Ë®≠Ë®àÈÅäÊà≤Ê©üÂà∂Ôºö
${context}

Ë´ãÊ†πÊìöÊïÖ‰∫ãÈ°ûÂûãÔºåÊèêÂá∫Ê©üÂà∂ÊñπÈù¢ÁöÑÂª∫Ë≠∞ÊàñÂïèÈ°å„ÄÇ‰æãÂ¶ÇÔºöÈÄô‰∫õÂ±¨ÊÄß‰πãÈñìÂ¶Ç‰Ωï‰∫íÁõ∏ÂΩ±ÈüøÔºüÊúâÊ≤íÊúâÁâπÊÆäÁöÑËß∏ÁôºÊ©üÂà∂ÔºüÂõûË¶ÜÁ∞°ÊΩîÔºà100Â≠óÂÖßÔºâ„ÄÇ`,
      style: `Áî®Êà∂Ê≠£Âú®Ë®≠ÂÆöÂØ´‰ΩúÈ¢®Ê†ºÔºö
${context}

Ë´ãÊ†πÊìöÊïÖ‰∫ãÈ°ûÂûãÂíåÈ¢®Ê†ºÈÅ∏ÊìáÔºåÁµ¶Âá∫Âª∫Ë≠∞ÊàñÊèêÂïè„ÄÇ‰æãÂ¶ÇÔºöË¶Å‰∏çË¶ÅÂä†ÂÖ•Ë©©Ë©û/Â∞àÊ•≠Ë°ìË™ûÔºüÂ∞çË©±È¢®Ê†ºÊúâ‰ªÄÈ∫ºË¶ÅÊ±ÇÔºüÂõûË¶ÜÁ∞°ÊΩîÔºà100Â≠óÂÖßÔºâ„ÄÇ`,
      aiRules: `Áî®Êà∂Ê≠£Âú®Ë®≠ÂÆö AI Ë°åÁÇ∫Ë¶èÂâáÔºö
${context}

Ë´ãÊ†πÊìöÊï¥È´îË®≠ÂÆöÔºåÂª∫Ë≠∞‰∏Ä‰∫õÈáçË¶ÅÁöÑ AI Ë°åÁÇ∫Ë¶èÂâá„ÄÇ‰ªÄÈ∫ºÊòØ AI ÂøÖÈ†àÈÅµÂÆàÁöÑÔºü‰ªÄÈ∫ºÊòØÁµïÂ∞ç‰∏çËÉΩÂÅöÁöÑÔºüÂõûË¶ÜÁ∞°ÊΩîÔºà100Â≠óÂÖßÔºâ„ÄÇ`
    };
    
    const response = await callAI(prompts[stepId] || 'Ë´ãÁµ¶Âá∫‰∏Ä‰∫õÂª∫Ë≠∞„ÄÇ');
    
    box.innerHTML = `
      <div class="wizard-ai-box">
        <div class="wizard-ai-header">ü§ñ AI ÊèêÂïè</div>
        <div class="wizard-ai-content">${marked.parse(response.content)}</div>
      </div>
    `;
  } catch (e) {
    box.innerHTML = `<div class="wizard-ai-box"><div class="wizard-ai-header">‚ö†Ô∏è AI Êö´ÊôÇÁÑ°Ê≥ïÂõûÊáâ</div><div class="wizard-ai-content">${e.message}</div></div>`;
  }
}

// Ê∑ªÂä†/Á∑®ËºØËßíËâ≤
function addWizardChar() {
  showModal('wizard-char-modal');
  document.getElementById('wiz-char-name').value = '';
  document.getElementById('wiz-char-role').value = '';
  document.getElementById('wiz-char-personality').value = '';
  document.getElementById('wiz-char-relation').value = '';
  document.getElementById('wiz-char-desc').value = '';
  document.getElementById('wiz-char-idx').value = '-1';
}

function editWizardChar(idx) {
  const c = wizardState.data.characters[idx];
  showModal('wizard-char-modal');
  document.getElementById('wiz-char-name').value = c.name || '';
  document.getElementById('wiz-char-role').value = c.role || '';
  document.getElementById('wiz-char-personality').value = c.personality || '';
  document.getElementById('wiz-char-relation').value = c.relation || '';
  document.getElementById('wiz-char-desc').value = c.description || '';
  document.getElementById('wiz-char-idx').value = idx;
}

function saveWizardChar() {
  const idx = parseInt(document.getElementById('wiz-char-idx').value);
  const char = {
    name: document.getElementById('wiz-char-name').value.trim(),
    role: document.getElementById('wiz-char-role').value.trim(),
    personality: document.getElementById('wiz-char-personality').value.trim(),
    relation: document.getElementById('wiz-char-relation').value.trim(),
    description: document.getElementById('wiz-char-desc').value.trim(),
    avatar: 'üë§'
  };
  if (!char.name) { toast('Ë´ãËº∏ÂÖ•ËßíËâ≤ÂêçÁ®±', 'warning'); return; }
  
  if (idx >= 0) {
    wizardState.data.characters[idx] = char;
  } else {
    wizardState.data.characters.push(char);
  }
  closeModal('wizard-char-modal');
  renderWizardStep();
}

function deleteWizardChar(idx) {
  showConfirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãËßíËâ≤ÂóéÔºü', () => {
    wizardState.data.characters.splice(idx, 1);
    renderWizardStep();
  });
}

// AI ÁîüÊàêËßíËâ≤Âª∫Ë≠∞
async function aiGenerateChars() {
  toast('AI Ê≠£Âú®ÁîüÊàêËßíËâ≤Âª∫Ë≠∞...', 'info');
  try {
    const context = JSON.stringify(wizardState.data, null, 2);
    const response = await callAI(`Ê†πÊìö‰ª•‰∏ãÊñáÊ∏∏Ë®≠ÂÆöÔºåÂª∫Ë≠∞ 3 ÂÄãÈÅ©ÂêàÁöÑÈÖçËßí„ÄÇË´ãÁî® JSON Ê†ºÂºèËøîÂõûÔºö
${context}

ËøîÂõûÊ†ºÂºèÔºö
\`\`\`json
[
  {"name": "ËßíËâ≤Âêç", "role": "Ë∫´‰ªΩ", "personality": "ÊÄßÊ†º", "relation": "Ëàá‰∏ªËßíÈóú‰øÇ", "description": "Á∞°‰ªã"}
]
\`\`\``);
    
    const match = response.content.match(/```json\\s*([\\s\\S]*?)\\s*```/) || response.content.match(/\\[\\s*\\{[\\s\\S]*\\}\\s*\\]/);
    if (match) {
      const chars = JSON.parse(match[1] || match[0]);
      chars.forEach(c => {
        c.avatar = 'üë§';
        wizardState.data.characters.push(c);
      });
      renderWizardStep();
      toast(`Â∑≤Ê∑ªÂä† ${chars.length} ÂÄãËßíËâ≤`, 'success');
    }
  } catch (e) {
    toast('ÁîüÊàêÂ§±Êïó: ' + e.message, 'error');
  }
}

// ÁîüÊàêÂÆåÊï¥ Prompt
function generatePrompt() {
  const d = wizardState.data;
  let prompt = '';
  
  // ‰∏ñÁïåËßÄ
  prompt += `# ‰∏ñÁïåËßÄË®≠ÂÆö\n\n`;
  prompt += `## Âü∫Êú¨‰ø°ÊÅØ\n`;
  prompt += `- ÊïÖ‰∫ãÈ°ûÂûãÔºö${d.basic.type}\n`;
  prompt += `- ÊôÇ‰ª£ËÉåÊôØÔºö${d.basic.era}\n`;
  prompt += `- Ê†∏ÂøÉ‰∏ªÈ°åÔºö${d.basic.theme}\n\n`;
  if (d.basic.setting) {
    prompt += `## Ë©≥Á¥∞Ë®≠ÂÆö\n${d.basic.setting}\n\n`;
  }
  
  // ‰∏ªËßí
  prompt += `# ‰∏ªËßíË®≠ÂÆö\n\n`;
  prompt += `- Á®±ÂëºÔºö${d.protagonist.name}\n`;
  prompt += `- ÊÄßÂà•Ôºö${d.protagonist.gender === 'male' ? 'Áî∑' : d.protagonist.gender === 'female' ? 'Â•≥' : 'Ëá™ÂÆöÁæ©'}\n`;
  prompt += `- Ë∫´‰ªΩÔºö${d.protagonist.identity}\n`;
  prompt += `- ÊÄßÊ†ºÔºö${d.protagonist.personality}\n`;
  if (d.protagonist.appearance) prompt += `\n## Â§ñË≤å\n${d.protagonist.appearance}\n`;
  if (d.protagonist.background) prompt += `\n## ËÉåÊôØ\n${d.protagonist.background}\n`;
  if (d.protagonist.goal) prompt += `\n## ÁõÆÊ®ô\n${d.protagonist.goal}\n`;
  prompt += `\n`;
  
  // ÈÖçËßí
  if (d.characters.length) {
    prompt += `# ‰∏ªË¶ÅËßíËâ≤\n\n`;
    d.characters.forEach(c => {
      prompt += `## ${c.name}\n`;
      prompt += `- Ë∫´‰ªΩÔºö${c.role}\n`;
      prompt += `- ÊÄßÊ†ºÔºö${c.personality}\n`;
      prompt += `- Ëàá‰∏ªËßíÈóú‰øÇÔºö${c.relation}\n`;
      if (c.description) prompt += `\n${c.description}\n`;
      prompt += `\n`;
    });
  }
  
  // ÈÅäÊà≤Ê©üÂà∂
  prompt += `# ÈÅäÊà≤Ê©üÂà∂\n\n`;
  if (d.mechanics.attributes.length) {
    prompt += `## Â±¨ÊÄßÁ≥ªÁµ±\n`;
    d.mechanics.attributes.forEach(a => prompt += `- ${a}\n`);
    prompt += `\n`;
  }
  if (d.mechanics.systems.length) {
    prompt += `## ÈÅäÊà≤Á≥ªÁµ±\n`;
    d.mechanics.systems.forEach(s => prompt += `- ${s}\n`);
    prompt += `\n`;
  }
  if (d.mechanics.triggers.length) {
    prompt += `## ÁâπÊÆäËß∏Áôº\n`;
    d.mechanics.triggers.forEach(t => prompt += `- ${t}\n`);
    prompt += `\n`;
  }
  
  // ÂØ´‰ΩúÈ¢®Ê†º
  prompt += `# ÂØ´‰ΩúË¶ÅÊ±Ç\n\n`;
  prompt += `- ÊñáÈ¢®Ôºö${d.style.tone}\n`;
  prompt += `- Ë¶ñËßíÔºö${d.style.perspective}\n`;
  prompt += `- ÁØáÂπÖÔºö${d.style.detail}\n`;
  if (d.style.format) prompt += `\n## Ê†ºÂºèË¶ÅÊ±Ç\n${d.style.format}\n`;
  prompt += `\n`;
  
  // AI Ë¶èÂâá
  prompt += `# AI Ë°åÁÇ∫Ë¶èÂâá\n\n`;
  if (d.aiRules.dos.length) {
    prompt += `## ÂøÖÈ†àÈÅµÂÆà\n`;
    d.aiRules.dos.forEach(r => prompt += `- ${r}\n`);
    prompt += `\n`;
  }
  if (d.aiRules.donts.length) {
    prompt += `## Á¶ÅÊ≠¢‰∫ãÈ†Ö\n`;
    d.aiRules.donts.forEach(r => prompt += `- ${r}\n`);
    prompt += `\n`;
  }
  if (d.aiRules.special) {
    prompt += `## ÁâπÊÆäÊåá‰ª§\n${d.aiRules.special}\n`;
  }
  
  return prompt;
}

// È†êË¶ΩÂÆåÊï¥ Prompt
function previewFullPrompt() {
  const prompt = generatePrompt();
  showConfirm(prompt, null, false, 'üìÑ ÂÆåÊï¥Êåá‰ª§È†êË¶Ω');
}

// Á∑®ËºØ Prompt
function editPrompt() {
  const prompt = generatePrompt();
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.style.cssText = 'max-width:90%;max-height:80vh;';
  modal.innerHTML = `
    <div class="modal-title">‚úèÔ∏è Á∑®ËºØÊåá‰ª§</div>
    <textarea class="form-input" id="edit-prompt-text" style="min-height:50vh;font-family:monospace;font-size:13px;line-height:1.6">${esc(prompt)}</textarea>
    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="this.closest('.modal').remove();document.getElementById('overlay').classList.remove('active')">ÂèñÊ∂à</button>
      <button class="modal-btn confirm" onclick="applyEditedPrompt()">ÊáâÁî®‰øÆÊîπ</button>
    </div>
  `;
  document.getElementById('overlay').classList.add('active');
  document.body.appendChild(modal);
}

function applyEditedPrompt() {
  const text = document.getElementById('edit-prompt-text').value;
  wizardState.editedPrompt = text;
  document.querySelector('.modal')?.remove();
  document.getElementById('overlay').classList.remove('active');
  toast('Â∑≤ÊáâÁî®‰øÆÊîπ', 'success');
  renderWizardStep();
}

// Â∞éÂá∫ Prompt
function exportPrompt(format) {
  const prompt = wizardState.editedPrompt || generatePrompt();
  const filename = `ÊñáÊ∏∏Êåá‰ª§_${wizardState.data.basic.type || 'Ëá™ÂÆöÁæ©'}_${Date.now()}`;
  
  if (format === 'md') {
    downloadFile(prompt, filename + '.md', 'text/markdown');
  } else {
    downloadFile(prompt, filename + '.txt', 'text/plain');
  }
  toast('Â∑≤Â∞éÂá∫Êåá‰ª§ÊñáÊ™î', 'success');
}

function downloadFile(content, filename, type) {
  const blob = new Blob([content], { type: type + ';charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ‰øùÂ≠òÁÇ∫Êåá‰ª§
async function saveAsInstruction() {
  const prompt = wizardState.editedPrompt || generatePrompt();
  const name = wizardState.data.basic.type || 'Ëá™ÂÆöÁæ©Êåá‰ª§';
  
  const inst = {
    id: crypto.randomUUID(),
    name: name + ' - ' + new Date().toLocaleDateString(),
    icon: wizardTemplates.find(t => t.id === wizardState.data.template)?.icon || 'üìú',
    systemPrompt: prompt,
    createdAt: Date.now()
  };
  
  await db.instructions.put(inst);
  toast('Êåá‰ª§Â∑≤‰øùÂ≠òÔºÅ', 'success');
  goTo('view-instructions');
  await renderInst();
}

// Â∞çË©±ÂÆåÂñÑ
async function sendWizardChat() {
  const input = document.getElementById('wizard-chat-input');
  const msg = input.value.trim();
  if (!msg) return;
  
  input.value = '';
  wizardState.data.aiChat.push({ role: 'user', content: msg });
  renderWizardStep();
  
  try {
    const prompt = generatePrompt();
    const response = await callAI(`Áî®Êà∂Ê≠£Âú®ÂÆåÂñÑ‰ª•‰∏ãÊñáÊ∏∏Êåá‰ª§Ôºö

${prompt}

Áî®Êà∂Ë™™Ôºö${msg}

Ë´ãÊ†πÊìöÁî®Êà∂ÁöÑÊÑèË¶ãÔºåÁµ¶Âá∫‰øÆÊîπÂª∫Ë≠∞ÊàñÂõûÁ≠îÂïèÈ°å„ÄÇÂ¶ÇÊûúÁî®Êà∂Ë¶ÅÊ±Ç‰øÆÊîπÊüêÈÉ®ÂàÜÔºåË´ãÊòéÁ¢∫ÊåáÂá∫ÊáâË©≤Â¶Ç‰Ωï‰øÆÊîπ„ÄÇÂõûË¶ÜË¶ÅÊúâÂª∫Ë®≠ÊÄß„ÄÇ`);
    
    wizardState.data.aiChat.push({ role: 'ai', content: response.content });
    renderWizardStep();
  } catch (e) {
    toast('ÂõûË¶ÜÂ§±Êïó: ' + e.message, 'error');
  }
}

// ============================================
// Prompt ÂàÜÊûêÁ≥ªÁµ±
// ============================================

let analyzeState = {
  originalPrompt: '',
  improvedPrompt: '',
  analysis: null,
  moduleImprovements: {},
  chatHistory: []
};

const analyzeModules = [
  { id: 'worldview', name: '‰∏ñÁïåËßÄË®≠ÂÆö', icon: 'üåç', keywords: ['‰∏ñÁïå', 'ËÉåÊôØ', 'ÊôÇ‰ª£', 'Ë®≠ÂÆö', 'Ê≠∑Âè≤', 'È≠îÊ≥ï', 'Á≥ªÁµ±'] },
  { id: 'protagonist', name: '‰∏ªËßíË®≠ÂÆö', icon: 'üë§', keywords: ['‰∏ªËßí', '‰Ω†', 'Áé©ÂÆ∂', 'Ë∫´‰ªΩ', 'ÊÄßÊ†º', 'ÁõÆÊ®ô'] },
  { id: 'characters', name: 'ÈÖçËßíÁ≥ªÁµ±', icon: 'üë•', keywords: ['ËßíËâ≤', 'NPC', '‰∫∫Áâ©', 'Èóú‰øÇ', 'ÈÖçËßí'] },
  { id: 'mechanics', name: 'ÈÅäÊà≤Ê©üÂà∂', icon: '‚öôÔ∏è', keywords: ['Â±¨ÊÄß', 'Êï∏ÂÄº', 'Â•ΩÊÑü', 'Á≥ªÁµ±', 'Ê©üÂà∂', 'Ëß∏Áôº'] },
  { id: 'style', name: 'ÂØ´‰ΩúÈ¢®Ê†º', icon: '‚úçÔ∏è', keywords: ['È¢®Ê†º', 'ÊñáÈ¢®', 'Ë¶ñËßí', 'ÊèèÂØ´', 'ÁØáÂπÖ', 'Â≠óÊï∏'] },
  { id: 'aiRules', name: 'AI Ë°åÁÇ∫Ë¶èÂâá', icon: 'ü§ñ', keywords: ['AI', 'Ë¶èÂâá', 'Á¶ÅÊ≠¢', 'ÂøÖÈ†à', '‰∏çË¶Å', 'ÊáâË©≤', 'Ëº∏Âá∫'] }
];

// ÂïüÂãïÂàÜÊûê
function startAnalyze() {
  analyzeState = {
    originalPrompt: '',
    improvedPrompt: '',
    analysis: null,
    moduleImprovements: {},
    chatHistory: []
  };
  renderAnalyzeImport();
  goTo('view-analyze');
}

function showAnalyzeHelp() {
  showConfirm(
    'Prompt ÂàÜÊûêÂäüËÉΩÂπ´Âä©\n\n' +
    'ÈÄôÂÄãÂäüËÉΩÂèØ‰ª•ÂàÜÊûê‰Ω†ÁèæÊúâÁöÑ PromptÔºåÊâæÂá∫‰∏çË∂≥‰πãËôï‰∏¶Êèê‰æõÊîπÈÄ≤Âª∫Ë≠∞„ÄÇ\n\n' +
    '‚Ä¢ ÊîØÊåÅ‰∏äÂÇ≥ .txt / .md ÊñáÊ™îÊàñÁõ¥Êé•Á≤òË≤º\n' +
    '‚Ä¢ AI ÊúÉÊ∑±Â∫¶ÂàÜÊûê 6 ÂÄãÁ∂≠Â∫¶\n' +
    '‚Ä¢ ÂèØ‰ª•ÂàÜÊ®°Â°äÂñÆÁç®ÂÆåÂñÑ\n' +
    '‚Ä¢ ÊîØÊåÅÂéüÁâàËàáÊîπÈÄ≤ÁâàÂ∞çÊØî\n\n' +
    'ÂàÜÊûêÂÆåÊàêÂæåÂèØ‰ª•Â∞éÂá∫Êàñ‰øùÂ≠òÁÇ∫Êåá‰ª§„ÄÇ',
    null, false, 'üí° Âπ´Âä©'
  );
}

// Ê∏≤ÊüìÂ∞éÂÖ•ÁïåÈù¢
function renderAnalyzeImport() {
  const container = document.getElementById('analyze-content');
  container.innerHTML = `
    <div class="wizard-section">
      <div class="wizard-section-title">üì• Â∞éÂÖ•‰Ω†ÁöÑ Prompt</div>
      <div class="wizard-section-desc">‰∏äÂÇ≥ÊñáÊ™îÊàñÁõ¥Êé•Á≤òË≤º‰Ω†ÊÉ≥ÂàÜÊûêÁöÑ Prompt ÂÖßÂÆπ„ÄÇ</div>
      
      <div class="analyze-import">
        <div class="analyze-import-btn" onclick="document.getElementById('analyze-file').click()">
          <div class="icon">üìÑ</div>
          <div class="label">‰∏äÂÇ≥ÊñáÊ™î<br><small style="color:var(--text-tertiary)">.txt / .md</small></div>
        </div>
        <div class="analyze-import-btn" onclick="pasteFromClipboard()">
          <div class="icon">üìã</div>
          <div class="label">ÂæûÂâ™Ë≤ºÊùøÁ≤òË≤º</div>
        </div>
      </div>
      
      <div class="wizard-section-title" style="margin-top:20px">ÊàñÁõ¥Êé•Ëº∏ÂÖ•</div>
      <textarea class="analyze-textarea" id="analyze-input" placeholder="Âú®Ê≠§Á≤òË≤º‰Ω†ÁöÑ Prompt ÂÖßÂÆπ..."></textarea>
      
      <div id="analyze-file-info" style="display:none;margin-top:12px;padding:12px;background:var(--bg-card);border-radius:8px">
        <div style="display:flex;align-items:center;gap:8px">
          <span>üìÑ</span>
          <span id="analyze-file-name" style="flex:1;font-size:14px"></span>
          <button onclick="clearAnalyzeFile()" style="background:none;border:none;color:var(--error);cursor:pointer">‚úï</button>
        </div>
      </div>
      
      <button class="wizard-btn primary" style="width:100%;margin-top:16px" onclick="startDeepAnalyze()">üîç ÈñãÂßãÊ∑±Â∫¶ÂàÜÊûê</button>
    </div>
  `;
}

// ËôïÁêÜÊñá‰ª∂‰∏äÂÇ≥
async function handleAnalyzeFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  try {
    let text = '';
    if (file.name.endsWith('.docx')) {
      toast('Ê≠£Âú®Ëß£ÊûêÊñáÊ™î...', 'info');
      // Á∞°ÂñÆËôïÁêÜÔºåÂØ¶ÈöõÈúÄË¶Å mammoth.js
      toast('Êö´‰∏çÊîØÊåÅ .docx Ê†ºÂºèÔºåË´ã‰ΩøÁî® .txt Êàñ .md', 'warning');
      return;
    } else {
      text = await file.text();
    }
    
    analyzeState.originalPrompt = text;
    document.getElementById('analyze-input').value = text;
    document.getElementById('analyze-file-info').style.display = 'block';
    document.getElementById('analyze-file-name').textContent = file.name;
    toast('Êñá‰ª∂Â∑≤ËºâÂÖ•', 'success');
  } catch (e) {
    toast('ËÆÄÂèñÊñá‰ª∂Â§±Êïó: ' + e.message, 'error');
  }
  
  event.target.value = '';
}

async function pasteFromClipboard() {
  try {
    const text = await navigator.clipboard.readText();
    if (text) {
      document.getElementById('analyze-input').value = text;
      analyzeState.originalPrompt = text;
      toast('Â∑≤Á≤òË≤ºÂÖßÂÆπ', 'success');
    }
  } catch (e) {
    toast('ÁÑ°Ê≥ïË®™ÂïèÂâ™Ë≤ºÊùøÔºåË´ãÊâãÂãïÁ≤òË≤º', 'warning');
  }
}

function clearAnalyzeFile() {
  analyzeState.originalPrompt = '';
  document.getElementById('analyze-input').value = '';
  document.getElementById('analyze-file-info').style.display = 'none';
}

// ÈñãÂßãÊ∑±Â∫¶ÂàÜÊûê
async function startDeepAnalyze() {
  const input = document.getElementById('analyze-input');
  const prompt = input?.value?.trim() || analyzeState.originalPrompt;
  
  if (!prompt) {
    toast('Ë´ãÂÖàËº∏ÂÖ•Êàñ‰∏äÂÇ≥ Prompt ÂÖßÂÆπ', 'warning');
    return;
  }
  
  if (prompt.length < 100) {
    toast('Prompt ÂÖßÂÆπÂ§™Áü≠ÔºåËá≥Â∞ëÈúÄË¶Å 100 Â≠ó', 'warning');
    return;
  }
  
  analyzeState.originalPrompt = prompt;
  
  // È°ØÁ§∫ÂàÜÊûê‰∏≠
  const container = document.getElementById('analyze-content');
  container.innerHTML = `
    <div style="text-align:center;padding:60px 20px">
      <div class="typing-dot" style="display:inline-block"></div>
      <div class="typing-dot" style="display:inline-block"></div>
      <div class="typing-dot" style="display:inline-block"></div>
      <div style="margin-top:20px;font-size:15px;color:var(--text-secondary)">AI Ê≠£Âú®Ê∑±Â∫¶ÂàÜÊûê‰Ω†ÁöÑ Prompt...</div>
      <div style="margin-top:8px;font-size:13px;color:var(--text-tertiary)">ÈÄôÂèØËÉΩÈúÄË¶Å 30-60 Áßí</div>
    </div>
  `;
  
  try {
    const preset = await db.apiPresets.filter(p => p.isActive).first();
    if (!preset) {
      toast('Ë´ãÂÖàÂú®Ë®≠ÁΩÆ‰∏≠ÈÖçÁΩÆ API', 'error');
      renderAnalyzeImport();
      return;
    }
    
    // Ë™øÁî® AI ÂàÜÊûê
    const response = await callAI(`‰Ω†ÊòØ‰∏ÄÂÄãÂ∞àÊ•≠ÁöÑÊñáÊ∏∏ Prompt ÂàÜÊûêÂ∞àÂÆ∂„ÄÇË´ãÊ∑±Â∫¶ÂàÜÊûê‰ª•‰∏ã PromptÔºå‰∏¶Áµ¶Âá∫Ë©≥Á¥∞Ë©ï‰º∞„ÄÇ

„ÄêÂæÖÂàÜÊûêÁöÑ Prompt„Äë
${prompt}

Ë´ãÊåâ‰ª•‰∏ã JSON Ê†ºÂºèËøîÂõûÂàÜÊûêÁµêÊûúÔºö
\`\`\`json
{
  "overallScore": 0-100ÁöÑÊï¥È´îË©ïÂàÜ,
  "overallComment": "Êï¥È´îË©ïÂÉπÔºà50Â≠óÂÖßÔºâ",
  "modules": {
    "worldview": {
      "score": 0-100,
      "found": true/false ÊòØÂê¶ÊâæÂà∞Áõ∏ÈóúÂÖßÂÆπ,
      "content": "ÊâæÂà∞ÁöÑÁõ∏ÈóúÂÖßÂÆπÊëòË¶ÅÔºà50Â≠óÂÖßÔºâ",
      "issues": ["ÂïèÈ°å1", "ÂïèÈ°å2"],
      "suggestions": ["Âª∫Ë≠∞1", "Âª∫Ë≠∞2"]
    },
    "protagonist": {
      "score": 0-100,
      "found": true/false,
      "content": "ÊëòË¶Å",
      "issues": [],
      "suggestions": []
    },
    "characters": {
      "score": 0-100,
      "found": true/false,
      "content": "ÊëòË¶Å",
      "issues": [],
      "suggestions": []
    },
    "mechanics": {
      "score": 0-100,
      "found": true/false,
      "content": "ÊëòË¶Å",
      "issues": [],
      "suggestions": []
    },
    "style": {
      "score": 0-100,
      "found": true/false,
      "content": "ÊëòË¶Å",
      "issues": [],
      "suggestions": []
    },
    "aiRules": {
      "score": 0-100,
      "found": true/false,
      "content": "ÊëòË¶Å",
      "issues": [],
      "suggestions": []
    }
  },
  "criticalIssues": ["ÊúÄÂö¥ÈáçÁöÑÂïèÈ°å1", "ÂïèÈ°å2"],
  "topSuggestions": ["ÊúÄÈáçË¶ÅÁöÑÂª∫Ë≠∞1", "Âª∫Ë≠∞2", "Âª∫Ë≠∞3"]
}
\`\`\`

Ë©ïÂàÜÊ®ôÊ∫ñÔºö
- 90-100ÔºöÈùûÂ∏∏ÂÆåÂñÑÔºåÂπæ‰πéÊ≤íÊúâÊîπÈÄ≤Á©∫Èñì
- 70-89ÔºöËâØÂ•ΩÔºåÊúâÂ∞èÁöÑÊîπÈÄ≤Á©∫Èñì
- 50-69Ôºö‰∏ÄËà¨ÔºåÊúâÊòéÈ°Ø‰∏çË∂≥
- 30-49ÔºöËºÉÂ∑ÆÔºåÁº∫Â§±ÈáçË¶ÅÂÖßÂÆπ
- 0-29ÔºöÂæàÂ∑ÆÔºåÂü∫Êú¨Ê≤íÊúâÁõ∏ÈóúÂÖßÂÆπ

Ë´ãÂö¥Ê†ºÊåâÁÖß JSON Ê†ºÂºèËøîÂõûÔºå‰∏çË¶ÅÊúâÂÖ∂‰ªñÂÖßÂÆπ„ÄÇ`);
    
    // Ëß£ÊûêÁµêÊûú
    const match = response.content.match(/```json\s*([\s\S]*?)\s*```/) || response.content.match(/\{[\s\S]*\}/);
    if (match) {
      const analysis = JSON.parse(match[1] || match[0]);
      analyzeState.analysis = analysis;
      renderAnalyzeResult();
    } else {
      throw new Error('ÁÑ°Ê≥ïËß£Êûê AI ËøîÂõûÁöÑÁµêÊûú');
    }
  } catch (e) {
    toast('ÂàÜÊûêÂ§±Êïó: ' + e.message, 'error');
    renderAnalyzeImport();
  }
}

// Ê∏≤ÊüìÂàÜÊûêÁµêÊûú
function renderAnalyzeResult() {
  const a = analyzeState.analysis;
  const container = document.getElementById('analyze-content');
  
  // Ë®àÁÆóÁµ±Ë®à
  const charCount = analyzeState.originalPrompt.length;
  const lineCount = analyzeState.originalPrompt.split('\n').length;
  const issueCount = Object.values(a.modules).reduce((sum, m) => sum + (m.issues?.length || 0), 0);
  
  container.innerHTML = `
    <div class="analyze-stats">
      <div class="analyze-stat"><div class="analyze-stat-value">${charCount.toLocaleString()}</div><div class="analyze-stat-label">Â≠óÊï∏</div></div>
      <div class="analyze-stat"><div class="analyze-stat-value">${lineCount}</div><div class="analyze-stat-label">Ë°åÊï∏</div></div>
      <div class="analyze-stat"><div class="analyze-stat-value">${issueCount}</div><div class="analyze-stat-label">ÂïèÈ°å</div></div>
    </div>
    
    <div class="analyze-score">
      <div class="analyze-score-ring">
        <svg width="120" height="120" viewBox="0 0 120 120">
          <circle class="bg" cx="60" cy="60" r="52"/>
          <circle class="fill" cx="60" cy="60" r="52" 
            stroke-dasharray="${2 * Math.PI * 52}" 
            stroke-dashoffset="${2 * Math.PI * 52 * (1 - a.overallScore / 100)}"/>
        </svg>
        <div class="analyze-score-value">
          <div class="analyze-score-num">${a.overallScore}</div>
          <div class="analyze-score-label">Á∏ΩÂàÜ</div>
        </div>
      </div>
      <div class="analyze-score-text">${a.overallComment || 'ÂàÜÊûêÂÆåÊàê'}</div>
    </div>
    
    <div class="wizard-section-title">üìã Ê®°Â°äË©ïÂàÜ</div>
    <div class="analyze-modules" id="analyze-modules">
      ${analyzeModules.map(m => {
        const data = a.modules[m.id] || { score: 0, found: false, issues: [], suggestions: [] };
        const scoreClass = data.score >= 70 ? 'high' : data.score >= 40 ? 'medium' : 'low';
        const statusIcon = data.score >= 70 ? '‚úÖ' : data.score >= 40 ? '‚ö†Ô∏è' : '‚ùå';
        const improved = analyzeState.moduleImprovements[m.id];
        return `
          <div class="analyze-module ${improved ? 'improved' : ''}" id="module-${m.id}">
            <div class="analyze-module-header" onclick="toggleAnalyzeModule('${m.id}')">
              <span class="analyze-module-icon">${m.icon}</span>
              <span class="analyze-module-name">${m.name}</span>
              <div class="analyze-module-score">
                <div class="analyze-module-bar"><div class="analyze-module-bar-fill ${scoreClass}" style="width:${data.score}%"></div></div>
                <span class="analyze-module-num">${data.score}</span>
                <span class="analyze-module-status">${improved ? '‚ú®' : statusIcon}</span>
              </div>
            </div>
            <div class="analyze-module-body">
              ${data.found ? `<div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px;padding:10px;background:var(--bg-tertiary);border-radius:8px">${esc(data.content || 'Â∑≤ÊâæÂà∞Áõ∏ÈóúÂÖßÂÆπ')}</div>` : '<div style="font-size:13px;color:var(--warning);margin-bottom:12px">‚ö†Ô∏è Êú™ÊâæÂà∞Áõ∏ÈóúÂÖßÂÆπ</div>'}
              ${data.issues?.length ? `
                <div class="analyze-module-issues">
                  ${data.issues.map(issue => `
                    <div class="analyze-issue">
                      <span class="analyze-issue-icon">‚ö†Ô∏è</span>
                      <span class="analyze-issue-text">${esc(issue)}</span>
                    </div>
                  `).join('')}
                </div>
              ` : ''}
              ${data.suggestions?.length ? `
                <div style="margin-bottom:12px">
                  <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:6px">üí° Âª∫Ë≠∞</div>
                  ${data.suggestions.map(s => `<div style="font-size:13px;color:var(--text-secondary);padding:4px 0">‚Ä¢ ${esc(s)}</div>`).join('')}
                </div>
              ` : ''}
              ${improved ? `
                <div style="margin-bottom:12px;padding:10px;background:rgba(16,185,129,.1);border-radius:8px;border-left:3px solid var(--success)">
                  <div style="font-size:12px;color:var(--success);margin-bottom:6px">‚ú® Â∑≤ÊîπÈÄ≤</div>
                  <div style="font-size:13px;color:var(--text-secondary);white-space:pre-wrap;max-height:150px;overflow-y:auto">${esc(improved.slice(0, 500))}${improved.length > 500 ? '...' : ''}</div>
                </div>
              ` : ''}
              <div class="analyze-module-actions">
                <button class="analyze-module-btn ${improved ? '' : 'primary'}" onclick="improveModule('${m.id}')">
                  ${improved ? 'üîÑ ÈáçÊñ∞ÁîüÊàê' : 'ü§ñ AI ÂÆåÂñÑ'}
                </button>
                <button class="analyze-module-btn" onclick="editModule('${m.id}')">‚úèÔ∏è ÊâãÂãïÁ∑®ËºØ</button>
              </div>
            </div>
          </div>
        `;
      }).join('')}
    </div>
    
    ${a.criticalIssues?.length ? `
      <div class="analyze-suggestions" style="border-left-color:var(--error)">
        <div class="analyze-suggestions-title"><span>‚ùå</span> Âö¥ÈáçÂïèÈ°å</div>
        <div class="analyze-suggestions-content">
          ${a.criticalIssues.map((issue, i) => `${i + 1}. ${esc(issue)}`).join('<br>')}
        </div>
      </div>
    ` : ''}
    
    <div class="analyze-suggestions">
      <div class="analyze-suggestions-title"><span>üí°</span> AI Âª∫Ë≠∞</div>
      <div class="analyze-suggestions-content">
        ${a.topSuggestions?.map((s, i) => `${i + 1}. ${esc(s)}`).join('<br>') || 'Êö´ÁÑ°Âª∫Ë≠∞'}
      </div>
    </div>
    
    <div class="wizard-section-title" style="margin-top:24px">üì§ Â∞éÂá∫ÈÅ∏È†Ö</div>
    <div class="analyze-actions">
      <button class="wizard-btn secondary" onclick="showAnalyzeCompare()">üìä Â∞çÊØîÊü•Áúã</button>
      <button class="wizard-btn secondary" onclick="previewImprovedPrompt()">üëÅÔ∏è È†êË¶ΩÊîπÈÄ≤Áâà</button>
      <button class="wizard-btn secondary" onclick="exportAnalyzedPrompt('md')">üìÑ Â∞éÂá∫ MD</button>
      <button class="wizard-btn secondary" onclick="exportAnalyzedPrompt('txt')">üìù Â∞éÂá∫ TXT</button>
    </div>
    <button class="wizard-btn primary" style="width:100%;margin-top:12px" onclick="saveAnalyzedAsInstruction()">üíæ ‰øùÂ≠òÁÇ∫Êåá‰ª§</button>
    
    <div class="analyze-chat">
      <div class="wizard-section-title">üí¨ Â∞çË©±Ë®éË´ñ</div>
      <div class="wizard-section-desc">ÊúâÁñëÂïèÔºüÂíå AI Ë®éË´ñÂÖ∑È´îÂïèÈ°å„ÄÇ</div>
      <div class="wizard-chat" id="analyze-chat-list">
        ${analyzeState.chatHistory.map(m => `
          <div class="wizard-chat-msg ${m.role}">${marked.parse(m.content)}</div>
        `).join('')}
      </div>
      <div class="wizard-chat-input">
        <input class="wizard-chat-field" id="analyze-chat-input" placeholder="Ë©¢Âïè AI ÈóúÊñº Prompt ÁöÑÂïèÈ°å..." onkeypress="if(event.key==='Enter')sendAnalyzeChat()">
        <button class="wizard-chat-send" onclick="sendAnalyzeChat()">‚û§</button>
      </div>
    </div>
  `;
}

// ÂàáÊèõÊ®°Â°äÂ±ïÈñã
function toggleAnalyzeModule(id) {
  const module = document.getElementById('module-' + id);
  if (module) {
    module.classList.toggle('expanded');
  }
}

// AI ÂÆåÂñÑÂñÆÂÄãÊ®°Â°ä
async function improveModule(moduleId) {
  const module = analyzeModules.find(m => m.id === moduleId);
  if (!module) return;
  
  toast(`AI Ê≠£Âú®ÂÆåÂñÑ ${module.name}...`, 'info');
  
  try {
    const a = analyzeState.analysis;
    const moduleData = a.modules[moduleId] || {};
    
    const response = await callAI(`‰Ω†ÊòØ‰∏ÄÂÄãÂ∞àÊ•≠ÁöÑÊñáÊ∏∏ Prompt ÂØ´‰ΩúÂ∞àÂÆ∂„ÄÇ

„ÄêÂéüÂßã Prompt„Äë
${analyzeState.originalPrompt}

„ÄêÁï∂ÂâçÊ®°Â°ä„Äë${module.name}
„ÄêÁèæÊúâÂÖßÂÆπ„Äë${moduleData.content || 'ÁÑ°'}
„ÄêÁôºÁèæÁöÑÂïèÈ°å„Äë${moduleData.issues?.join('„ÄÅ') || 'ÁÑ°'}
„ÄêÊîπÈÄ≤Âª∫Ë≠∞„Äë${moduleData.suggestions?.join('„ÄÅ') || 'ÁÑ°'}

Ë´ãÁÇ∫ÈÄôÂÄãÊ®°Â°äÁîüÊàêÊîπÈÄ≤ÂæåÁöÑÂÖßÂÆπ„ÄÇË¶ÅÊ±ÇÔºö
1. ‰øùÊåÅËàáÂéü Prompt È¢®Ê†º‰∏ÄËá¥
2. Ëß£Ê±∫ÁôºÁèæÁöÑÂïèÈ°å
3. Êé°Á¥çÂª∫Ë≠∞ÈÄ≤Ë°åÂÑ™Âåñ
4. ÂÖßÂÆπË¶ÅÂÖ∑È´î„ÄÅÂèØÁî®

Áõ¥Êé•Ëº∏Âá∫ÊîπÈÄ≤ÂæåÁöÑÂÖßÂÆπÔºå‰∏çË¶ÅÊúâÂÖ∂‰ªñËß£Èáã„ÄÇËº∏Âá∫Ê†ºÂºè‰øùÊåÅ Markdown„ÄÇ`);
    
    analyzeState.moduleImprovements[moduleId] = response.content;
    toast(`${module.name} Â∑≤ÂÆåÂñÑ`, 'success');
    renderAnalyzeResult();
    
    // Â±ïÈñãÈÄôÂÄãÊ®°Â°ä
    setTimeout(() => {
      const el = document.getElementById('module-' + moduleId);
      if (el) el.classList.add('expanded');
    }, 100);
  } catch (e) {
    toast('ÂÆåÂñÑÂ§±Êïó: ' + e.message, 'error');
  }
}

// ÊâãÂãïÁ∑®ËºØÊ®°Â°ä
function editModule(moduleId) {
  const module = analyzeModules.find(m => m.id === moduleId);
  if (!module) return;
  
  const current = analyzeState.moduleImprovements[moduleId] || '';
  const moduleData = analyzeState.analysis?.modules[moduleId] || {};
  
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.style.cssText = 'max-width:90%;max-height:80vh;';
  modal.innerHTML = `
    <div class="modal-title">‚úèÔ∏è Á∑®ËºØ ${module.name}</div>
    <div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">
      ${moduleData.suggestions?.length ? 'üí° AI Âª∫Ë≠∞Ôºö' + moduleData.suggestions.join('Ôºõ') : ''}
    </div>
    <textarea class="form-input" id="edit-module-text" style="min-height:40vh;font-family:monospace;font-size:13px;line-height:1.6">${esc(current)}</textarea>
    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="this.closest('.modal').remove();document.getElementById('overlay').classList.remove('active')">ÂèñÊ∂à</button>
      <button class="modal-btn confirm" onclick="saveModuleEdit('${moduleId}')">‰øùÂ≠ò</button>
    </div>
  `;
  document.getElementById('overlay').classList.add('active');
  document.body.appendChild(modal);
}

function saveModuleEdit(moduleId) {
  const text = document.getElementById('edit-module-text').value.trim();
  if (text) {
    analyzeState.moduleImprovements[moduleId] = text;
  } else {
    delete analyzeState.moduleImprovements[moduleId];
  }
  document.querySelector('.modal')?.remove();
  document.getElementById('overlay').classList.remove('active');
  toast('Â∑≤‰øùÂ≠ò', 'success');
  renderAnalyzeResult();
}

// ÁîüÊàêÊîπÈÄ≤ÂæåÁöÑ Prompt
function generateImprovedPrompt() {
  let improved = analyzeState.originalPrompt;
  
  // Â¶ÇÊûúÊúâÊ®°Â°äÊîπÈÄ≤ÔºåÈôÑÂä†Âà∞Êú´Â∞æ
  const improvements = Object.entries(analyzeState.moduleImprovements);
  if (improvements.length > 0) {
    improved += '\n\n---\n\n# Ë£úÂÖÖËàáÊîπÈÄ≤\n\n';
    improvements.forEach(([id, content]) => {
      const module = analyzeModules.find(m => m.id === id);
      improved += `## ${module?.icon || 'üìù'} ${module?.name || id}\n\n${content}\n\n`;
    });
  }
  
  analyzeState.improvedPrompt = improved;
  return improved;
}

// È°ØÁ§∫Â∞çÊØî
function showAnalyzeCompare() {
  const improved = generateImprovedPrompt();
  const original = analyzeState.originalPrompt;
  
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.style.cssText = 'max-width:95%;max-height:85vh;width:800px;';
  modal.innerHTML = `
    <div class="modal-title">üìä ÂéüÁâà vs ÊîπÈÄ≤ÁâàÂ∞çÊØî</div>
    <div class="analyze-compare" style="max-height:60vh">
      <div class="analyze-compare-col">
        <div class="analyze-compare-title">üìÑ ÂéüÁâà (${original.length} Â≠ó)</div>
        <div class="analyze-compare-content">${esc(original)}</div>
      </div>
      <div class="analyze-compare-col">
        <div class="analyze-compare-title">‚ú® ÊîπÈÄ≤Áâà (${improved.length} Â≠ó)</div>
        <div class="analyze-compare-content">${esc(improved)}</div>
      </div>
    </div>
    <div style="margin-top:12px;font-size:13px;color:var(--text-secondary)">
      ${Object.keys(analyzeState.moduleImprovements).length > 0 
        ? `‚úÖ Â∑≤ÊîπÈÄ≤ ${Object.keys(analyzeState.moduleImprovements).length} ÂÄãÊ®°Â°ä` 
        : '‚ö†Ô∏è Â∞öÊú™ÈÄ≤Ë°å‰ªª‰ΩïÊîπÈÄ≤'}
    </div>
    <div class="modal-actions">
      <button class="modal-btn confirm" onclick="this.closest('.modal').remove();document.getElementById('overlay').classList.remove('active')">ÈóúÈñâ</button>
    </div>
  `;
  document.getElementById('overlay').classList.add('active');
  document.body.appendChild(modal);
}

// È†êË¶ΩÊîπÈÄ≤Áâà
function previewImprovedPrompt() {
  const improved = generateImprovedPrompt();
  
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.style.cssText = 'max-width:90%;max-height:80vh;';
  modal.innerHTML = `
    <div class="modal-title">üëÅÔ∏è ÊîπÈÄ≤ÁâàÈ†êË¶Ω</div>
    <div style="font-size:13px;color:var(--text-tertiary);margin-bottom:12px">${improved.length.toLocaleString()} Â≠ó</div>
    <div style="background:var(--bg-tertiary);border-radius:8px;padding:12px;max-height:50vh;overflow-y:auto;font-size:13px;line-height:1.7;white-space:pre-wrap;font-family:monospace">${esc(improved)}</div>
    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="this.closest('.modal').remove();document.getElementById('overlay').classList.remove('active')">ÈóúÈñâ</button>
      <button class="modal-btn confirm" onclick="copyImprovedPrompt()">üìã Ë§áË£Ω</button>
    </div>
  `;
  document.getElementById('overlay').classList.add('active');
  document.body.appendChild(modal);
}

async function copyImprovedPrompt() {
  const improved = generateImprovedPrompt();
  try {
    await navigator.clipboard.writeText(improved);
    toast('Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÊùø', 'success');
  } catch (e) {
    toast('Ë§áË£ΩÂ§±Êïó', 'error');
  }
}

// Â∞éÂá∫
function exportAnalyzedPrompt(format) {
  const improved = generateImprovedPrompt();
  const filename = `PromptÂàÜÊûêÊîπÈÄ≤Áâà_${Date.now()}`;
  
  if (format === 'md') {
    downloadFile(improved, filename + '.md', 'text/markdown');
  } else {
    downloadFile(improved, filename + '.txt', 'text/plain');
  }
  toast('Â∑≤Â∞éÂá∫', 'success');
}

// ‰øùÂ≠òÁÇ∫Êåá‰ª§
async function saveAnalyzedAsInstruction() {
  const improved = generateImprovedPrompt();
  
  const inst = {
    id: crypto.randomUUID(),
    name: 'ÂàÜÊûêÊîπÈÄ≤Áâà - ' + new Date().toLocaleDateString(),
    icon: '‚ú®',
    systemPrompt: improved,
    createdAt: Date.now()
  };
  
  await db.instructions.put(inst);
  toast('Â∑≤‰øùÂ≠òÁÇ∫Êåá‰ª§ÔºÅ', 'success');
  goTo('view-instructions');
  await renderInst();
}

// Â∞çË©±Ë®éË´ñ
async function sendAnalyzeChat() {
  const input = document.getElementById('analyze-chat-input');
  const msg = input.value.trim();
  if (!msg) return;
  
  input.value = '';
  analyzeState.chatHistory.push({ role: 'user', content: msg });
  renderAnalyzeResult();
  
  try {
    const response = await callAI(`‰Ω†ÊòØ Prompt ÂàÜÊûêÂ∞àÂÆ∂„ÄÇÁî®Êà∂Ê≠£Âú®ÂàÜÊûê‰ª•‰∏ã PromptÔºö

„ÄêÂéüÂßã Prompt ÊëòË¶Å„Äë
${analyzeState.originalPrompt.slice(0, 2000)}...

„ÄêÂàÜÊûêÁµêÊûú„Äë
Á∏ΩÂàÜÔºö${analyzeState.analysis?.overallScore || 'Êú™Áü•'}
‰∏ªË¶ÅÂïèÈ°åÔºö${analyzeState.analysis?.criticalIssues?.join('„ÄÅ') || 'ÁÑ°'}

„ÄêÁî®Êà∂ÂïèÈ°å„Äë
${msg}

Ë´ãÈáùÂ∞çÁî®Êà∂ÁöÑÂïèÈ°åÁµ¶Âá∫Â∞àÊ•≠„ÄÅÂÖ∑È´îÁöÑÂõûÁ≠î„ÄÇÂõûË¶ÜË¶ÅÁ∞°ÊΩîÂØ¶Áî®„ÄÇ`);
    
    analyzeState.chatHistory.push({ role: 'ai', content: response.content });
    renderAnalyzeResult();
    
    // ÊªæÂãïÂà∞Â∫ïÈÉ®
    setTimeout(() => {
      const chatList = document.getElementById('analyze-chat-list');
      if (chatList) chatList.scrollTop = chatList.scrollHeight;
    }, 100);
  } catch (e) {
    toast('ÂõûË¶ÜÂ§±Êïó: ' + e.message, 'error');
  }
}

// Êõ¥Êñ∞ÁãÄÊÖãÊ¨ÑÊôÇÈñì
function updateStatusTime() {
  const now = new Date();
  const hours = now.getHours().toString().padStart(2, '0');
  const mins = now.getMinutes().toString().padStart(2, '0');
  const timeEl = document.getElementById('status-time');
  if (timeEl) timeEl.textContent = `${hours}:${mins}`;
}
updateStatusTime();
setInterval(updateStatusTime, 60000);
</script>
</body>
</html>
