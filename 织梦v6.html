<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#8B7CF7">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ç¹”å¤¢">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="description" content="AIäº’å‹•å°èªªé–±è®€å™¨ - å‰µå»ºä½ çš„å°ˆå±¬æ•…äº‹">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%238B7CF7' width='100' height='100' rx='20'/><text x='50' y='65' text-anchor='middle' fill='white' font-size='50'>ç¹”</text></svg>">
  <title>ç¹”å¤¢ - AIäº’å‹•å°èªªé–±è®€å™¨ v5.3</title>
  <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.min.js"></script>
  <style>
:root{--primary:#8B7CF7;--primary-light:#A89CFF;--primary-dark:#6B5CE7;--bg-primary:#0F0F1A;--bg-secondary:#1A1A2E;--bg-tertiary:#252540;--bg-card:#1E1E32;--text-primary:#E5E7EB;--text-secondary:#9CA3AF;--text-tertiary:#6B7280;--divider:#2D2D44;--success:#10B981;--warning:#F59E0B;--error:#EF4444;--info:#3B82F6;--font-size:16px;--line-height:1.8}
[data-theme="light"]{--primary:#6B5CE7;--primary-light:#8B7CF7;--bg-primary:#FFFFFF;--bg-secondary:#F5F5F7;--bg-tertiary:#E8E8ED;--bg-card:#FFFFFF;--text-primary:#1A1A2E;--text-secondary:#6B7280;--text-tertiary:#9CA3AF;--divider:#E5E7EB}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,BlinkMacSystemFont,"PingFang SC",sans-serif;font-size:16px;background:#000;color:var(--text-primary);height:100vh;height:100dvh;overflow:hidden;user-select:none}
.app{width:100%;max-width:420px;height:100vh;height:100dvh;margin:0 auto;display:flex;flex-direction:column;background:var(--bg-primary);position:relative;box-shadow:0 0 50px rgba(139,124,247,0.2);overflow:hidden}
@media(min-width:421px) and (min-height:901px){.app{max-height:900px;margin-top:calc((100vh - 900px)/2);border-radius:40px}}
.app.fullscreen{max-width:100%;max-height:100%;border-radius:0;margin:0}
.status-bar{height:44px;background:var(--bg-secondary);display:flex;justify-content:space-between;align-items:center;padding:0 20px;font-size:14px;font-weight:500;flex-shrink:0}
.views{flex:1;position:relative;overflow:hidden}
.view{position:absolute;inset:0;display:flex;flex-direction:column;overflow:hidden;opacity:0;transform:translateX(100%);transition:all .3s ease;pointer-events:none;background:var(--bg-primary)}
.view.active{opacity:1;transform:translateX(0);pointer-events:auto;z-index:1}
.view.out{transform:translateX(-30%);opacity:.5;z-index:0}
.nav{height:52px;background:var(--bg-secondary);display:flex;justify-content:space-between;align-items:center;padding:0 16px;border-bottom:1px solid var(--divider);flex-shrink:0}
.nav-back{color:var(--primary);font-size:24px;cursor:pointer;padding:8px;margin:-8px}
.nav-title{font-size:17px;font-weight:600;flex:1;text-align:center}
.nav-right{display:flex;gap:4px}
.nav-btn{width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;color:var(--text-secondary);border-radius:8px;transition:all .2s}
.nav-btn:hover{color:var(--primary);background:rgba(139,124,247,.1)}
.list-nav{height:52px;background:var(--bg-secondary);display:flex;justify-content:space-between;align-items:center;padding:0 16px;border-bottom:1px solid var(--divider);flex-shrink:0}
.list-nav-title{font-size:22px;font-weight:700;background:linear-gradient(135deg,var(--primary),var(--primary-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.search-bar{padding:12px 16px;background:var(--bg-secondary);flex-shrink:0}
.search-wrap{background:var(--bg-tertiary);border-radius:10px;padding:10px 14px;display:flex;align-items:center;gap:10px}
.search-wrap:focus-within{box-shadow:0 0 0 2px var(--primary)}
.search-input{flex:1;border:none;background:transparent;font-size:15px;outline:none;color:var(--text-primary)}
.search-input::placeholder{color:var(--text-tertiary)}
.progress-wrap{padding:0 16px 8px;background:var(--bg-secondary);display:flex;align-items:center;gap:8px;flex-shrink:0}
.progress-bar{flex:1;height:4px;background:var(--bg-tertiary);border-radius:2px;overflow:hidden;cursor:pointer}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--primary-dark),var(--primary));border-radius:2px;transition:width .3s}
.progress-text{font-size:11px;color:var(--text-tertiary);min-width:32px}
.scroll{flex:1;overflow-y:auto;padding:12px 16px}
.scroll::-webkit-scrollbar{display:none}
.card{display:flex;padding:14px;background:var(--bg-card);border-radius:12px;margin-bottom:12px;cursor:pointer;transition:all .2s;position:relative;border:1px solid transparent}
.card-menu-btn{position:absolute;top:8px;right:8px;width:28px;height:28px;border-radius:50%;background:var(--bg-tertiary);display:flex;align-items:center;justify-content:center;font-size:16px;color:var(--text-secondary);opacity:0.7;transition:all .2s;z-index:2}
.card-menu-btn:hover{opacity:1;background:var(--primary);color:white}
.card:hover{transform:translateY(-2px);box-shadow:0 4px 20px rgba(139,124,247,.15)}
.card:active{transform:scale(.98)}
.card.pinned::before{content:'ğŸ“Œ';position:absolute;top:-6px;left:-6px;font-size:16px}
.card.selected{border-color:var(--primary)}
.card-cover{width:56px;height:70px;border-radius:8px;margin-right:12px;flex-shrink:0;background:linear-gradient(135deg,var(--primary-dark),var(--primary));display:flex;align-items:center;justify-content:center;font-size:24px;background-size:cover;background-position:center;overflow:hidden;position:relative}
.card-cover img{width:100%;height:100%;object-fit:cover}
.card-cover .cover-emoji{font-size:24px}
.upload-btn{position:absolute;bottom:4px;right:4px;width:20px;height:20px;background:rgba(0,0,0,0.6);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;cursor:pointer;opacity:0;transition:opacity 0.2s}
.card-cover:hover .upload-btn,.char-avatar:hover .upload-btn{opacity:1}
.content.has-bg{background-size:cover;background-position:center;background-attachment:fixed}
.content.has-bg::before{content:'';position:absolute;inset:0;background:rgba(15,15,26,0.85);z-index:0}
.content.has-bg .msg{position:relative;z-index:1}
.card-info{flex:1;min-width:0}
.card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px}
.card-title{font-size:15px;font-weight:600}
.card-time{font-size:11px;color:var(--text-tertiary)}
.card-preview{font-size:12px;color:var(--text-secondary);margin-bottom:6px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;line-height:1.4}
.card-meta{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.card-instruction{font-size:10px;color:var(--primary);background:rgba(139,124,247,.15);padding:2px 6px;border-radius:4px}
.card-stats{font-size:10px;color:var(--text-tertiary)}
.card-tags{display:flex;gap:4px;margin-top:4px}
.tag{font-size:9px;padding:2px 5px;border-radius:3px;background:var(--bg-tertiary);color:var(--text-secondary)}
.tab-bar{display:flex;background:var(--bg-secondary);border-top:1px solid var(--divider);padding:6px 0;padding-bottom:calc(6px + env(safe-area-inset-bottom, 0px));flex-shrink:0}
.tab-item{flex:1;display:flex;flex-direction:column;align-items:center;padding:4px 0;cursor:pointer}
.tab-item .tab-icon{font-size:20px;margin-bottom:2px;transition:transform .2s}
.tab-item .tab-label{font-size:10px;color:var(--text-tertiary)}
.tab-item.active .tab-icon{transform:scale(1.1)}
.tab-item.active .tab-label{color:var(--primary)}
.content{flex:1;overflow-y:auto;padding:16px;font-family:"Noto Serif SC",Georgia,serif;font-size:var(--font-size);line-height:var(--line-height);word-break:break-word;overflow-wrap:break-word}
.content::-webkit-scrollbar{display:none}
.content.sys{font-family:-apple-system,sans-serif;font-size:15px;line-height:1.5}
.content p{margin-bottom:16px;word-break:break-word;overflow-wrap:break-word}
.content strong{color:var(--primary-light)}
.content blockquote{border-left:3px solid var(--primary);padding-left:12px;margin:12px 0;color:var(--text-secondary);word-break:break-word;overflow-wrap:break-word}
.content pre{white-space:pre-wrap;word-break:break-word;overflow-wrap:break-word;background:var(--bg-tertiary);padding:12px;border-radius:8px;overflow-x:auto;max-width:100%}
.content code{word-break:break-all}
/* å°èªªé–±è®€å¼ UI */
.msg{margin-bottom:24px;word-break:break-word;overflow-wrap:break-word;max-width:100%}
.msg.user{margin:24px 0}
.msg-user-action{text-align:center;padding:16px 0}
.msg-user-action .action-divider{color:var(--primary);font-size:13px;margin-bottom:8px;display:flex;align-items:center;justify-content:center;gap:12px}
.msg-user-action .action-divider::before,.msg-user-action .action-divider::after{content:'';flex:1;max-width:60px;height:1px;background:linear-gradient(90deg,transparent,var(--primary),transparent)}
.msg-user-action .action-content{color:var(--primary-light);font-style:italic;font-size:calc(var(--font-size) * 0.95)}
.msg-ai-story{padding:0 4px}
.msg-ai-story p{text-indent:2em;margin-bottom:1em}
.msg-ai-story p:first-child{text-indent:0}
/* æ”¹å–„é¸é …åˆ—è¡¨é¡¯ç¤º */
.msg-ai-story br{display:block;content:'';margin-top:0.5em}
.msg-ai-story ol,.msg-ai-story ul{margin:1em 0;padding-left:2em;text-indent:0}
.msg-ai-story li{margin-bottom:0.5em;text-indent:0}
/* ç¢ºä¿åœˆè™Ÿé¸é …æ­£ç¢ºæ›è¡Œ - ä½¿ç”¨æ›´ç²¾ç¢ºçš„é¸æ“‡å™¨ */
.msg-ai-story{white-space:pre-line}
.msg-timestamp{text-align:center;font-size:11px;color:var(--text-tertiary);margin-top:12px}
.msg-floor{position:absolute;right:8px;top:8px;font-size:10px;color:var(--text-tertiary);font-family:sans-serif;opacity:0.6}
.msg-menu-btn{position:absolute;right:28px;top:6px;width:24px;height:24px;border-radius:6px;background:var(--bg-tertiary);display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--text-secondary);cursor:pointer;opacity:0.4;transition:opacity .2s;z-index:5}
.msg:hover .msg-menu-btn,.msg-menu-btn:focus,.msg-menu-btn:active{opacity:1}
.msg-menu-btn:active{background:var(--primary);color:white}
.msg-action-menu{position:fixed;background:var(--bg-card);border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.3);padding:6px;z-index:1002;min-width:120px}
.msg-action-item{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:8px;font-size:14px;color:var(--text-primary);cursor:pointer;transition:background .2s}
.msg-action-item:hover{background:var(--bg-tertiary)}
.msg-action-item.danger{color:var(--error)}
.msg-action-item .icon{font-size:16px}
.msg{position:relative}
/* Lorebook æ¨£å¼ */
.lore-trigger-toast{position:fixed;top:60px;left:50%;transform:translateX(-50%);background:rgba(139,124,247,0.95);color:white;padding:8px 16px;border-radius:20px;font-size:12px;z-index:1001;animation:slideDown .3s ease;display:flex;align-items:center;gap:6px}
@keyframes slideDown{from{opacity:0;transform:translateX(-50%) translateY(-10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.lorebook-card{background:var(--bg-card);border-radius:12px;padding:14px;margin-bottom:12px;border-left:3px solid var(--primary)}
/* èƒŒåŒ…ç‰©å“æ¨£å¼ */
.inventory-item{background:var(--bg-card);border-radius:12px;padding:12px;margin-bottom:10px;display:flex;align-items:center;gap:12px;position:relative}
.inventory-item-icon{font-size:28px;width:44px;height:44px;display:flex;align-items:center;justify-content:center;background:var(--bg-tertiary);border-radius:10px;flex-shrink:0}
.inventory-item-info{flex:1;min-width:0}
.inventory-item-name{font-weight:600;font-size:15px;color:var(--text-primary);display:flex;align-items:center;gap:6px}
.inventory-item-name .quantity{font-size:12px;color:var(--primary);font-weight:500}
.inventory-item-category{font-size:11px;color:var(--text-tertiary);margin-top:2px}
.inventory-item-desc{font-size:12px;color:var(--text-secondary);margin-top:4px;line-height:1.4}
.inventory-item-actions{display:flex;gap:6px}
.inventory-item-btn{padding:6px 10px;border-radius:6px;font-size:12px;border:none;cursor:pointer;background:var(--bg-tertiary);color:var(--text-secondary)}
.inventory-item-btn:hover{background:var(--bg-hover)}
.inventory-item-btn.danger{color:var(--error)}
.inventory-item.has-lorebook{border-left:3px solid var(--primary)}
/* åœ–æ¨™é¸æ“‡å™¨ */
.icon-option{width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-size:20px;background:var(--bg-tertiary);border-radius:8px;cursor:pointer;transition:all .2s}
.icon-option:hover,.icon-option.selected{background:var(--primary);transform:scale(1.1)}
.lorebook-card.disabled{opacity:0.5;border-left-color:var(--text-tertiary)}
.lorebook-card-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.lorebook-card-status{width:8px;height:8px;border-radius:50%;background:var(--success)}
.lorebook-card.disabled .lorebook-card-status{background:var(--text-tertiary)}
.lorebook-card-title{flex:1;font-size:14px;font-weight:600}
.lorebook-card-lock{font-size:12px}
.lorebook-card-triggers{font-size:12px;color:var(--text-secondary);margin-bottom:6px}
.lorebook-card-stats{font-size:11px;color:var(--text-tertiary);display:flex;gap:12px}
.lorebook-card-actions{display:flex;gap:8px;margin-top:10px}
.lorebook-condition{display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-tertiary);border-radius:6px;margin-bottom:8px;flex-wrap:wrap}
.lorebook-condition select,.lorebook-condition input{padding:6px 8px;border:1px solid var(--divider);border-radius:4px;background:var(--bg-card);color:var(--text-primary);font-size:13px}
.lorebook-condition input[type="number"]{width:60px}
/* ç©å®¶é¢æ¿æ¨£å¼ - å¢å¼·ç‰ˆ */
.player-panel{background:var(--bg-card);border-radius:16px;padding:16px;margin-bottom:16px;border:1px solid var(--divider)}
.player-panel-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.player-panel-title{font-size:16px;font-weight:600;display:flex;align-items:center;gap:8px}
.player-panel-edit{font-size:12px;color:var(--primary);cursor:pointer}
/* åˆ†çµ„æ¨£å¼ */
.player-group{margin-bottom:16px}
.player-group:last-child{margin-bottom:0}
.player-group-header{display:flex;align-items:center;gap:8px;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--divider)}
.player-group-icon{font-size:16px}
.player-group-title{font-size:13px;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.5px}
.player-group-toggle{margin-left:auto;font-size:12px;color:var(--text-tertiary);cursor:pointer;transition:transform .2s}
.player-group-toggle.collapsed{transform:rotate(-90deg)}
.player-group-content{overflow:hidden;transition:max-height .3s ease}
.player-group-content.collapsed{max-height:0!important}
/* å±¬æ€§ç¶²æ ¼ */
.player-stat-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.player-stat-grid.grid-3{grid-template-columns:repeat(3,1fr)}
.player-stat-item{background:var(--bg-tertiary);border-radius:12px;padding:12px;position:relative;overflow:hidden;transition:transform .2s,box-shadow .2s}
.player-stat-item:active{transform:scale(0.98)}
.player-stat-item::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;opacity:0.8}
.player-stat-item.color-red::before{background:linear-gradient(90deg,#EF4444,#F87171)}
.player-stat-item.color-orange::before{background:linear-gradient(90deg,#F59E0B,#FBBF24)}
.player-stat-item.color-yellow::before{background:linear-gradient(90deg,#EAB308,#FDE047)}
.player-stat-item.color-green::before{background:linear-gradient(90deg,#10B981,#34D399)}
.player-stat-item.color-blue::before{background:linear-gradient(90deg,#3B82F6,#60A5FA)}
.player-stat-item.color-purple::before{background:linear-gradient(90deg,#8B5CF6,#A78BFA)}
.player-stat-item.color-pink::before{background:linear-gradient(90deg,#EC4899,#F472B6)}
.player-stat-item.color-default::before{background:linear-gradient(90deg,var(--primary),var(--primary-light))}
.player-stat-label{font-size:11px;color:var(--text-tertiary);margin-bottom:4px;display:flex;align-items:center;gap:4px}
.player-stat-value{font-size:18px;font-weight:700;color:var(--text-primary);display:flex;align-items:baseline;gap:4px}
.player-stat-value .unit{font-size:12px;font-weight:400;color:var(--text-tertiary)}
.player-stat-value.positive{color:var(--success)}
.player-stat-value.negative{color:var(--error)}
/* é€²åº¦æ¢å‹•ç•« */
.player-stat-bar{height:8px;background:var(--bg-primary);border-radius:4px;margin-top:8px;overflow:hidden;position:relative}
.player-stat-bar-fill{height:100%;border-radius:4px;transition:width .5s ease;position:relative}
.player-stat-bar-fill::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3),transparent);animation:shimmer 2s infinite}
@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.player-stat-bar-fill.health{background:linear-gradient(90deg,#10B981,#34D399)}
.player-stat-bar-fill.energy{background:linear-gradient(90deg,#F59E0B,#FBBF24)}
.player-stat-bar-fill.mood{background:linear-gradient(90deg,#EC4899,#F472B6)}
.player-stat-bar-fill.default{background:linear-gradient(90deg,var(--primary),var(--primary-light))}
/* æ–‡å­—é¡å‹æ¨™ç±¤ */
.player-stat-tag{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;background:var(--bg-primary);border-radius:20px;font-size:13px;font-weight:500;color:var(--text-primary)}
/* å±¬æ€§å¡ç‰‡ï¼ˆè¨­ç½®é ï¼‰ */
.player-attr-card{background:var(--bg-tertiary);border-radius:10px;padding:12px;margin-bottom:8px;display:flex;align-items:center;gap:10px;border-left:3px solid var(--primary)}
.player-attr-icon{font-size:20px;width:32px;text-align:center}
.player-attr-info{flex:1}
.player-attr-name{font-size:13px;font-weight:500}
.player-attr-type{font-size:11px;color:var(--text-tertiary)}
.player-attr-group{font-size:10px;color:var(--primary);margin-top:2px}
/* AIåŒæ­¥æŒ‰éˆ• */
.player-sync-btn{width:100%;padding:12px;background:linear-gradient(135deg,var(--primary),var(--primary-light));color:white;border:none;border-radius:10px;font-size:14px;font-weight:500;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-top:12px;transition:opacity .2s,transform .2s}
.player-sync-btn:active{transform:scale(0.98)}
.player-sync-btn:disabled{opacity:0.6;cursor:not-allowed}
/* åˆ†çµ„é¸æ“‡å™¨ */
.group-selector{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.group-chip{padding:6px 12px;background:var(--bg-tertiary);border-radius:16px;font-size:12px;cursor:pointer;transition:all .2s;border:1px solid transparent}
.group-chip:hover{background:var(--bg-primary)}
.group-chip.active{background:var(--primary);color:white;border-color:var(--primary)}
.time-div{display:flex;align-items:center;justify-content:center;margin:20px 0;color:var(--text-tertiary);font-size:13px;cursor:pointer}
.time-div::before,.time-div::after{content:'';flex:1;height:1px;background:var(--divider);margin:0 12px}
.typing{display:flex;align-items:center;gap:4px;padding:12px 0}
.typing-dot{width:8px;height:8px;background:var(--primary);border-radius:50%;animation:typing 1.4s infinite ease-in-out}
.typing-dot:nth-child(1){animation-delay:0s}
.typing-dot:nth-child(2){animation-delay:.2s}
.typing-dot:nth-child(3){animation-delay:.4s}
@keyframes typing{0%,60%,100%{transform:translateY(0);opacity:.4}30%{transform:translateY(-6px);opacity:1}}
@keyframes highlight{0%,100%{background:transparent}50%{background:rgba(139,124,247,0.3)}}
.typing-cursor{display:inline-block;width:2px;height:1em;background:var(--primary);margin-left:2px;animation:blink 1s infinite}
@keyframes blink{0%,50%{opacity:1}51%,100%{opacity:0}}
.quick-cmds{display:flex;gap:8px;padding:10px 16px;background:var(--bg-secondary);overflow-x:auto;border-top:1px solid var(--divider);flex-shrink:0}
.quick-cmds::-webkit-scrollbar{display:none}
.quick-cmd{padding:6px 14px;background:var(--bg-tertiary);border-radius:16px;font-size:13px;color:var(--text-secondary);white-space:nowrap;cursor:pointer;border:none;transition:all .2s}
.quick-cmd:hover{background:var(--primary);color:white}
.quick-cmd.add{background:transparent;border:1px dashed var(--text-tertiary);color:var(--text-tertiary)}
.quick-cmd-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:8px}
.quick-cmd-item .drag-handle{cursor:grab;color:var(--text-tertiary);font-size:14px}
.quick-cmd-item .cmd-info{flex:1;min-width:0}
.quick-cmd-item .cmd-label{font-size:14px;font-weight:500;color:var(--text-primary)}
.quick-cmd-item .cmd-content{font-size:11px;color:var(--text-tertiary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.quick-cmd-item .cmd-actions{display:flex;gap:6px}
.quick-cmd-item .cmd-actions button{padding:4px 8px;font-size:12px;border:none;border-radius:4px;cursor:pointer}
.quick-cmd-item .cmd-actions .edit-btn{background:var(--bg-secondary);color:var(--text-secondary)}
.quick-cmd-item .cmd-actions .del-btn{background:rgba(239,68,68,0.1);color:#ef4444}
.persona-bar{background:var(--bg-secondary);padding:8px 16px;display:flex;align-items:center;gap:8px;border-top:1px solid var(--divider);flex-shrink:0}
.persona-selector{flex:1;display:flex;align-items:center;gap:8px;padding:6px 12px;background:var(--bg-tertiary);border-radius:12px;cursor:pointer;transition:all .2s}
.persona-selector:hover{background:rgba(139,124,247,.1);box-shadow:0 0 0 1px var(--primary)}
.persona-avatar{font-size:18px}
.persona-info{flex:1;min-width:0}
.persona-label{font-size:11px;color:var(--text-tertiary)}
.persona-name{font-size:13px;color:var(--text-primary);font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.persona-dropdown{font-size:12px;color:var(--text-tertiary)}
.input-bar{background:var(--bg-secondary);padding:10px 16px;display:flex;align-items:flex-end;gap:10px;border-top:1px solid var(--divider);flex-shrink:0}
.input-wrap{flex:1;background:var(--bg-tertiary);border-radius:20px;min-height:40px;max-height:120px;display:flex;align-items:center;padding:0 16px}
.input-field{flex:1;border:none;background:transparent;padding:10px 0;font-size:15px;outline:none;color:var(--text-primary)}
.input-field::placeholder{color:var(--text-tertiary)}
.send-btn{width:40px;height:40px;background:var(--primary);border:none;border-radius:50%;color:white;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.send-btn:hover{background:var(--primary-light);transform:scale(1.05)}
.send-btn:disabled{background:var(--bg-tertiary);opacity:.5;cursor:not-allowed}
.lore-section{margin-bottom:16px}
.lore-header{display:flex;justify-content:space-between;align-items:center;padding:10px 0;cursor:pointer}
.lore-header-left{display:flex;align-items:center;gap:8px;font-size:15px;font-weight:600}
.lore-count{font-size:12px;color:var(--text-tertiary);font-weight:normal}
.lore-toggle{color:var(--text-tertiary);transition:transform .3s;font-size:12px}
.lore-toggle.collapsed{transform:rotate(-90deg)}
.lore-list{max-height:1000px;overflow:hidden;transition:all .3s ease}
.lore-list.collapsed{max-height:0;opacity:0}
.lore-item{display:flex;align-items:flex-start;padding:12px;background:var(--bg-card);border-radius:10px;margin-bottom:8px;cursor:pointer;position:relative}
.lore-actions{position:absolute;right:8px;top:50%;transform:translateY(-50%);display:flex;gap:8px;font-size:14px;opacity:0.6}
.lore-actions:hover{opacity:1}
.lore-item:hover{background:var(--bg-tertiary)}
.lore-checkbox{width:20px;height:20px;border:2px solid var(--text-tertiary);border-radius:4px;margin-right:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer}
.lore-checkbox.checked{background:var(--primary);border-color:var(--primary)}
.lore-checkbox.checked::after{content:'âœ“';color:white;font-size:12px}
.lore-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;margin-right:12px;font-size:18px;flex-shrink:0}
.lore-icon.char{background:rgba(59,130,246,.2)}
.lore-icon.loc{background:rgba(16,185,129,.2)}
.lore-icon.item{background:rgba(249,115,22,.2)}
.lore-icon.set{background:rgba(168,85,247,.2)}
.lore-content{flex:1;min-width:0}
.lore-name{font-size:14px;font-weight:600;margin-bottom:2px;display:flex;align-items:center;gap:8px}
.lore-affection{font-size:11px}
.lore-affection.pos{color:var(--success)}
.lore-affection.neg{color:var(--error)}
.lore-desc{font-size:12px;color:var(--text-secondary);margin-bottom:4px}
.lore-status{font-size:11px;color:var(--text-tertiary)}
.timeline-current{background:var(--bg-card);padding:12px 16px;border-radius:10px;margin-bottom:20px;display:flex;align-items:center;gap:8px}
.timeline-label{font-size:13px;color:var(--text-secondary)}
.timeline-value{font-size:15px;font-weight:600;color:var(--primary)}
.timeline-list{position:relative;padding-left:24px}
.timeline-list::before{content:'';position:absolute;left:8px;top:0;bottom:0;width:2px;background:var(--divider)}
.timeline-item{position:relative;margin-bottom:20px;cursor:pointer}
.timeline-item::before{content:'';position:absolute;left:-24px;top:6px;width:12px;height:12px;border-radius:50%;background:var(--bg-tertiary);border:2px solid var(--text-tertiary)}
.timeline-item.current::before{background:var(--primary);border-color:var(--primary);box-shadow:0 0 0 4px rgba(139,124,247,.2)}
.timeline-date{font-size:14px;font-weight:600;margin-bottom:6px}
.timeline-events{font-size:13px;color:var(--text-secondary)}
.timeline-event{display:flex;align-items:center;gap:6px;margin-bottom:4px}
.timeline-event-dot{width:4px;height:4px;background:var(--text-tertiary);border-radius:50%}
.tabs-bar{display:flex;background:var(--bg-secondary);padding:0 16px;flex-shrink:0;border-bottom:1px solid var(--divider)}
.tab-btn{padding:12px 20px;font-size:14px;color:var(--text-secondary);cursor:pointer;border:none;border-bottom:2px solid transparent;background:none}
.tab-btn.active{color:var(--primary);border-bottom-color:var(--primary)}
.section-title{font-size:13px;color:var(--text-tertiary);padding:12px 0;display:flex;align-items:center;gap:8px}
.f-card{background:var(--bg-card);border-radius:10px;padding:14px;margin-bottom:10px;cursor:pointer;transition:transform .2s}
.f-card:hover{transform:translateX(4px)}
.f-card.warning{border-left:3px solid var(--warning)}
.f-card.resolved{opacity:.6}
.f-card-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.f-card-icon{font-size:14px}
.f-card-title{font-size:14px;font-weight:600;flex:1}
.f-card-desc{font-size:13px;color:var(--text-secondary);margin-bottom:8px;word-break:break-word;overflow-wrap:break-word}
.f-card-meta{display:flex;align-items:center;gap:12px;font-size:11px;color:var(--text-tertiary);flex-wrap:wrap}
.save-card{background:var(--bg-card);border-radius:10px;padding:14px;margin-bottom:10px}
.save-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.save-card-title{font-size:14px;font-weight:600;display:flex;align-items:center;gap:8px}
.save-card-tag{font-size:10px;padding:2px 8px;border-radius:4px;background:var(--success);color:white}
.save-card-tag.be{background:var(--error)}
.save-card-tag.key{background:var(--warning)}
.save-card-preview{font-size:12px;color:var(--text-secondary);margin-bottom:8px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.save-card-meta{font-size:11px;color:var(--text-tertiary);display:flex;gap:12px;flex-wrap:wrap}
.save-card-actions{display:flex;gap:8px;margin-top:10px}
.action-btn{flex:1;padding:8px;border:none;border-radius:6px;font-size:12px;cursor:pointer}
.action-btn.primary{background:var(--primary);color:white}
.action-btn.secondary{background:var(--bg-tertiary);color:var(--text-secondary)}
.action-btn.danger{background:var(--error);color:white}
.font-option{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:12px 8px;background:var(--bg-tertiary);border:2px solid var(--divider);border-radius:8px;cursor:pointer;transition:all .2s;color:var(--text-primary)}
.font-option:hover{border-color:var(--primary);background:rgba(139,124,247,.1)}
.font-option.active{border-color:var(--primary);background:rgba(139,124,247,.2)}
.inst-card{background:var(--bg-card);border-radius:12px;padding:16px;margin-bottom:12px}
.inst-header{display:flex;align-items:flex-start;margin-bottom:12px}
.inst-icon{font-size:28px;margin-right:12px}
.inst-info{flex:1}
.inst-name{font-size:15px;font-weight:600;margin-bottom:4px}
.inst-meta{font-size:12px;color:var(--text-secondary)}
.inst-binding{font-size:12px;color:var(--text-tertiary);margin-top:4px}
.inst-preview{font-size:12px;color:var(--text-secondary);padding:8px;background:var(--bg-tertiary);border-radius:6px;margin-bottom:12px;max-height:60px;overflow:hidden}
.inst-actions{display:flex;gap:8px}
.settings-section{margin-bottom:24px}
.settings-section-title{font-size:13px;color:var(--text-tertiary);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.settings-card{background:var(--bg-card);border-radius:12px;overflow:hidden}
.settings-item{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--divider);cursor:pointer}
.settings-item:last-child{border-bottom:none}
.settings-item:hover{background:var(--bg-tertiary)}
.settings-item-label{font-size:15px}
.settings-item-value{font-size:14px;color:var(--text-secondary);display:flex;align-items:center;gap:4px}
.settings-item.danger .settings-item-label{color:var(--error)}
.toggle{width:44px;height:24px;background:var(--bg-tertiary);border-radius:12px;position:relative;cursor:pointer}
.toggle.active{background:var(--primary)}
.toggle::after{content:'';width:20px;height:20px;background:white;border-radius:50%;position:absolute;top:2px;left:2px;transition:left .2s}
.toggle.active::after{left:22px}
.immersive{position:fixed;inset:0;background:#0A0A12;z-index:1000;display:none;flex-direction:column}
.immersive.active{display:flex}
.immersive-content{flex:1;display:flex;align-items:center;justify-content:center;padding:40px 32px;font-family:"Noto Serif SC",serif;font-size:20px;line-height:2;color:#E5E7EB;text-align:justify;overflow-y:auto;word-break:break-word;overflow-wrap:break-word}
.immersive-footer{padding:16px 20px;display:flex;align-items:center;gap:16px;background:rgba(0,0,0,.5)}
.immersive-progress{flex:1;height:4px;background:rgba(255,255,255,.1);border-radius:2px}
.immersive-progress-fill{height:100%;background:var(--primary);border-radius:2px}
.immersive-hint{font-size:12px;color:rgba(255,255,255,.4)}
.immersive-close{width:36px;height:36px;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,.6);cursor:pointer;font-size:20px;border-radius:50%}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;opacity:0;visibility:hidden;transition:all .3s}
.overlay.active{opacity:1;visibility:visible}
.bottom-sheet{position:fixed;bottom:0;left:50%;transform:translateX(-50%) translateY(100%);width:100%;max-width:420px;background:var(--bg-secondary);border-radius:20px 20px 0 0;padding:20px;transition:transform .3s ease;z-index:101;max-height:85vh;overflow-y:auto;box-sizing:border-box}
.bottom-sheet.active{transform:translateX(-50%) translateY(0)}
.bottom-sheet-handle{width:40px;height:4px;background:var(--bg-tertiary);border-radius:2px;margin:0 auto 16px}
.bottom-sheet-title{font-size:17px;font-weight:600;margin-bottom:16px}
.sheet-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding-bottom:20px}
.sheet-item{text-align:center;padding:16px 8px;background:var(--bg-tertiary);border-radius:12px;cursor:pointer}
.sheet-item:hover{background:var(--primary);color:white}
.sheet-item-icon{font-size:24px;margin-bottom:6px}
.sheet-item-label{font-size:12px}
.modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(.9);background:var(--bg-secondary);border-radius:16px;padding:20px;width:calc(100% - 32px);max-width:360px;max-height:calc(100vh - 100px);overflow-y:auto;z-index:102;opacity:0;visibility:hidden;transition:all .3s;box-sizing:border-box}
.modal.active{opacity:1;visibility:visible;transform:translate(-50%,-50%) scale(1)}
.modal-title{font-size:18px;font-weight:600;margin-bottom:12px}
.modal-content{font-size:14px;color:var(--text-secondary);margin-bottom:20px;line-height:1.6;max-height:40vh;overflow-y:auto;word-break:break-word;overflow-wrap:break-word}
.modal-input{width:100%;padding:12px 16px;background:var(--bg-tertiary);border:1px solid var(--divider);border-radius:8px;font-size:15px;color:var(--text-primary);outline:none;margin-bottom:16px}
.modal-input:focus{border-color:var(--primary)}
.modal-actions{display:flex;gap:12px}
.modal-btn{flex:1;padding:12px;border:none;border-radius:8px;font-size:15px;cursor:pointer}
.modal-btn.cancel{background:var(--bg-tertiary);color:var(--text-secondary)}
.modal-btn.confirm{background:var(--primary);color:white}
.modal-btn.danger{background:var(--error);color:white}
/* v19: æ¨¡å¼é¸æ“‡å¡ç‰‡ */
.mode-card{background:var(--bg-tertiary);border:2px solid var(--divider);border-radius:12px;padding:12px;text-align:center;cursor:pointer;transition:all 0.2s}
.mode-card:hover{border-color:var(--primary);background:var(--bg-secondary)}
.mode-card.active{border-color:var(--primary);background:rgba(123,97,255,0.1)}
/* v19: è³‡æºé¢æ¿ */
.sim-resource-bar{display:flex;gap:12px;padding:10px 16px;background:var(--bg-secondary);border-bottom:1px solid var(--divider);overflow-x:auto;flex-wrap:wrap}
.sim-resource-item{display:flex;align-items:center;gap:4px;font-size:13px;white-space:nowrap}
.sim-resource-icon{font-size:16px}
.sim-resource-value{font-weight:600;color:var(--text-primary)}
.sim-resource-name{color:var(--text-secondary);font-size:11px}
.sim-resource-change{font-size:11px;margin-left:2px}
.sim-resource-change.up{color:var(--success)}
.sim-resource-change.down{color:var(--error)}
.sim-day-badge{background:var(--primary);color:white;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:600}
.context-menu{position:fixed;background:var(--bg-card);border-radius:12px;padding:8px 0;box-shadow:0 4px 20px rgba(0,0,0,.4);z-index:200;min-width:160px;opacity:0;visibility:hidden;transform:scale(.95);transition:all .2s}
.context-menu.active{opacity:1;visibility:visible;transform:scale(1)}
.context-menu-item{padding:12px 16px;font-size:14px;cursor:pointer;display:flex;align-items:center;gap:10px}
.context-menu-item:hover{background:var(--bg-tertiary)}
.context-menu-item.danger{color:var(--error)}
.context-menu-divider{height:1px;background:var(--divider);margin:4px 0}
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--bg-card);color:var(--text-primary);padding:12px 20px;border-radius:8px;font-size:14px;box-shadow:0 4px 20px rgba(0,0,0,.3);opacity:0;transition:all .3s;z-index:300;display:flex;align-items:center;gap:8px}
.toast.active{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.success{border-left:3px solid var(--success)}
.toast.error{border-left:3px solid var(--error)}
.toast.warning{border-left:3px solid var(--warning)}
.loading{position:fixed;inset:0;background:rgba(15,15,26,.8);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:500;opacity:0;visibility:hidden;transition:all .3s}
.loading.active{opacity:1;visibility:visible}
.loading-spinner{width:40px;height:40px;border:3px solid var(--bg-tertiary);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{margin-top:16px;font-size:14px;color:var(--text-secondary)}
.empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;text-align:center}
.empty-icon{font-size:64px;opacity:.5;margin-bottom:16px}
.empty-title{font-size:18px;font-weight:600;margin-bottom:8px}
.empty-desc{font-size:14px;color:var(--text-secondary);margin-bottom:24px;max-width:260px}
.empty-btn{padding:12px 24px;background:var(--primary);color:white;border:none;border-radius:8px;font-size:15px;cursor:pointer}
.api-card{background:var(--bg-card);border-radius:12px;padding:16px;margin-bottom:12px;border:2px solid transparent;cursor:pointer}
.api-card:hover{background:var(--bg-tertiary)}
.api-card.active{border-color:var(--primary)}
.api-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.api-name{font-size:15px;font-weight:600}
.api-badge{font-size:10px;padding:2px 8px;background:var(--primary);color:white;border-radius:4px}
.api-info{font-size:12px;color:var(--text-secondary)}
.form-group{margin-bottom:16px}
.form-label{display:block;font-size:13px;color:var(--text-secondary);margin-bottom:6px}
.form-input{width:100%;padding:12px 16px;background:var(--bg-tertiary);border:1px solid var(--divider);border-radius:8px;font-size:15px;color:var(--text-primary);outline:none}
.form-input:focus{border-color:var(--primary)}
.form-select{width:100%;padding:12px 16px;background:var(--bg-tertiary);border:1px solid var(--divider);border-radius:8px;font-size:15px;color:var(--text-primary);outline:none;cursor:pointer;appearance:none}
.form-textarea{width:100%;padding:12px 16px;background:var(--bg-tertiary);border:1px solid var(--divider);border-radius:8px;font-size:14px;color:var(--text-primary);outline:none;resize:vertical;min-height:80px;font-family:inherit;line-height:1.5}
.form-textarea:focus{border-color:var(--primary)}
/* v8 è§’è‰²ç·¨è¼¯é¢æ¿æ¨£å¼ */
.char-panel{background:var(--bg-card);border-radius:12px;margin-bottom:10px;border:1px solid var(--divider);overflow:hidden}
.char-panel-header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;cursor:pointer;font-size:14px;font-weight:600;color:var(--text-primary);transition:background .2s}
.char-panel-header:hover{background:rgba(139,124,247,.05)}
.char-panel-header:active{background:rgba(139,124,247,.1)}
.char-panel-arrow{font-size:10px;color:var(--text-secondary);transition:transform .2s}
.char-panel.expanded .char-panel-arrow{transform:rotate(90deg)}
.char-panel-content{padding:0 16px 16px;border-top:1px solid var(--divider)}
.greeting-option{padding:12px;margin-bottom:10px;background:var(--bg-tertiary);border-radius:10px;cursor:pointer;border:2px solid transparent;transition:all .2s}
.greeting-option:hover{background:var(--bg-card)}
.greeting-option.selected{border-color:var(--primary);background:rgba(139,124,247,.1)}
.greeting-option-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.greeting-char-avatar{font-size:20px}
.greeting-char-name{font-weight:600;font-size:14px}
.greeting-badge{font-size:10px;padding:2px 6px;background:var(--primary);color:white;border-radius:4px;margin-left:auto}
.greeting-preview{font-size:13px;color:var(--text-secondary);line-height:1.5;max-height:60px;overflow:hidden}
.relationship-item{background:var(--bg-tertiary);border-radius:10px;padding:12px;position:relative}
.relationship-item .delete-btn{position:absolute;top:8px;right:8px;width:24px;height:24px;border-radius:50%;background:var(--error);color:white;border:none;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center}
.relationship-row{display:flex;gap:8px;margin-bottom:8px}
.relationship-row .form-input,.relationship-row .form-select{flex:1;padding:8px 10px;font-size:13px}
.rel-type-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:6px;font-size:11px;font-weight:500}
.rel-graph-node{position:absolute;width:70px;height:70px;border-radius:50%;background:var(--bg-card);border:3px solid var(--primary);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:move;transition:transform .2s,box-shadow .2s;z-index:2}
.rel-graph-node:hover{transform:scale(1.1);box-shadow:0 4px 20px rgba(139,124,247,.4)}
.rel-graph-node .node-avatar{font-size:24px}
.rel-graph-node .node-name{font-size:10px;margin-top:2px;max-width:60px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:center}
.rel-graph-node.protagonist{border-color:#FFD700}
.rel-graph-node.npc{border-color:var(--text-tertiary)}
.rel-graph-line{position:absolute;pointer-events:none;z-index:1}
.rel-graph-label{position:absolute;background:var(--bg-secondary);padding:2px 6px;border-radius:4px;font-size:10px;color:var(--text-secondary);white-space:nowrap;z-index:1}
.expression-item{position:relative;background:var(--bg-tertiary);border-radius:10px;padding:8px;cursor:pointer;border:2px solid transparent;transition:all .2s}
.expression-item:hover{background:var(--bg-card)}
.expression-item.selected{border-color:var(--primary);background:rgba(139,124,247,.1)}
.expression-item.default{border-color:var(--success)}
.expression-item .expr-img{width:100%;aspect-ratio:1;border-radius:8px;object-fit:cover;background:var(--bg-secondary)}
.expression-item .expr-name{font-size:11px;text-align:center;margin-top:6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.expression-item .expr-badge{position:absolute;top:4px;left:4px;font-size:9px;padding:2px 5px;background:var(--success);color:white;border-radius:4px}
.expression-item .expr-delete{position:absolute;top:4px;right:4px;width:20px;height:20px;border-radius:50%;background:rgba(0,0,0,.5);color:white;border:none;cursor:pointer;font-size:10px;display:none;align-items:center;justify-content:center}
.expression-item:hover .expr-delete{display:flex}
.expression-edit-modal{background:var(--bg-secondary);border-radius:12px;padding:16px;margin-top:10px}
.char-expr-display{width:80px;height:80px;border-radius:12px;object-fit:cover;border:2px solid var(--primary);cursor:pointer;transition:transform .2s}
.char-expr-display:hover{transform:scale(1.05)}
.expr-selector{position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:var(--bg-card);border-radius:12px;padding:8px;display:none;flex-wrap:wrap;gap:6px;max-width:200px;box-shadow:0 4px 20px rgba(0,0,0,.3);z-index:100}
.expr-selector.active{display:flex}
.expr-selector-item{width:50px;height:50px;border-radius:8px;object-fit:cover;cursor:pointer;border:2px solid transparent;transition:all .2s}
.expr-selector-item:hover{border-color:var(--primary)}
.expr-selector-item.active{border-color:var(--primary);box-shadow:0 0 10px rgba(139,124,247,.5)}
.char-filter-bar{display:flex;gap:10px;padding:10px 16px;background:var(--bg-secondary);border-bottom:1px solid var(--divider)}
.char-search-wrap{flex:1;position:relative}
.char-search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:14px;opacity:.5}
.char-search-input{width:100%;padding:10px 12px 10px 36px;border:1px solid var(--divider);border-radius:10px;background:var(--bg-tertiary);color:var(--text-primary);font-size:14px}
.char-search-input:focus{outline:none;border-color:var(--primary)}
.char-filter-select{padding:10px 12px;border:1px solid var(--divider);border-radius:10px;background:var(--bg-tertiary);color:var(--text-primary);font-size:13px;min-width:100px}
.char-batch-bar{display:flex;align-items:center;gap:12px;padding:10px 16px;background:rgba(139,124,247,.1);border-bottom:1px solid var(--primary)}
.char-batch-select-all{display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer}
.char-batch-count{font-size:12px;color:var(--primary);font-weight:500}
.char-batch-actions{margin-left:auto;display:flex;gap:8px}
.char-batch-btn{padding:6px 12px;border:none;border-radius:6px;background:var(--bg-tertiary);color:var(--text-primary);font-size:12px;cursor:pointer;transition:background .2s}
.char-batch-btn:hover{background:var(--bg-card)}
.char-group{margin-bottom:16px}
.char-group-header{display:flex;align-items:center;gap:8px;padding:8px 16px;font-size:13px;font-weight:600;color:var(--text-secondary);cursor:pointer}
.char-group-header:hover{color:var(--text-primary)}
.char-group-arrow{transition:transform .2s}
.char-group.collapsed .char-group-arrow{transform:rotate(-90deg)}
.char-group.collapsed .char-group-list{display:none}
.char-group-count{font-size:11px;color:var(--text-tertiary);font-weight:normal}
.char-card{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--bg-card);margin:0 16px 8px;border-radius:12px;cursor:pointer;transition:all .2s;position:relative}
.char-card:hover{background:var(--bg-tertiary);transform:translateX(4px)}
.char-card.selected{background:rgba(139,124,247,.15);border:1px solid var(--primary)}
.char-card-checkbox{width:20px;height:20px;border-radius:4px;border:2px solid var(--divider);display:none;align-items:center;justify-content:center;flex-shrink:0}
.char-card-checkbox.checked{background:var(--primary);border-color:var(--primary);color:white}
.batch-mode .char-card-checkbox{display:flex}
.char-card-avatar{width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--primary-light));display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;overflow:hidden}
.char-card-avatar img{width:100%;height:100%;object-fit:cover}
.char-card-info{flex:1;min-width:0}
.char-card-name{font-size:15px;font-weight:600;margin-bottom:2px;display:flex;align-items:center;gap:6px}
.char-card-title{font-size:12px;color:var(--text-secondary);margin-bottom:4px}
.char-card-tags{display:flex;flex-wrap:wrap;gap:4px}
.char-card-tag{font-size:10px;padding:2px 6px;background:var(--bg-tertiary);border-radius:4px;color:var(--text-secondary)}
.char-card-stats{display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0}
.char-card-stat{font-size:11px;color:var(--text-secondary);display:flex;align-items:center;gap:4px}
.char-card-category{font-size:10px;padding:2px 6px;border-radius:4px;font-weight:500}
.char-card-category.protagonist{background:rgba(255,215,0,.2);color:#FFD700}
.char-card-category.supporting{background:rgba(139,124,247,.2);color:var(--primary)}
.char-card-category.npc{background:rgba(156,163,175,.2);color:#9ca3af}
.char-empty{text-align:center;padding:40px 20px;color:var(--text-tertiary)}
.char-empty-icon{font-size:48px;margin-bottom:12px;opacity:.5}
.char-empty-text{font-size:14px;margin-bottom:16px}
.char-form-row{display:flex;gap:12px}
.token-hint{font-size:11px;color:var(--text-tertiary);font-weight:normal}
.char-lore-entry{background:var(--bg-tertiary);border-radius:8px;padding:12px;position:relative}
.char-lore-entry .delete-btn{position:absolute;top:8px;right:8px;width:24px;height:24px;border-radius:50%;background:var(--error);color:white;border:none;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center}
.alt-greeting-item{display:flex;gap:8px;align-items:flex-start}
.alt-greeting-item textarea{flex:1;min-height:60px}
.alt-greeting-item .delete-btn{width:28px;height:28px;border-radius:6px;background:var(--bg-tertiary);color:var(--text-secondary);border:none;cursor:pointer;flex-shrink:0}
.alt-greeting-item .delete-btn:hover{background:var(--error);color:white}
.hidden{display:none!important}
/* PWA å®‰è£æ©«å¹…å‹•ç•« */
#install-banner>div{animation:slideUp .3s ease}
@keyframes slideUp{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}
/* æ–‡å­—æº¢å‡ºä¿®å¾© */
.scroll{word-break:break-word;overflow-wrap:break-word}
.lore-desc,.lore-name,.inst-preview,.card-preview,.save-card-preview{word-break:break-word;overflow-wrap:break-word}
/* ====== v7 è§’è‰²å¡ç‰‡ç³»çµ± CSS ====== */
.char-card{background:var(--bg-card);border-radius:16px;margin-bottom:12px;border:1px solid var(--divider);overflow:hidden;transition:all .3s}
.char-card.expanded{box-shadow:0 8px 32px rgba(139,124,247,.15)}
.char-header{display:flex;align-items:center;padding:14px;cursor:pointer;transition:background .2s}
.char-header:active{background:rgba(255,255,255,.03)}
.char-avatar{width:52px;height:52px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--primary-light));display:flex;align-items:center;justify-content:center;font-size:22px;margin-right:12px;flex-shrink:0;position:relative;background-size:cover;background-position:center;overflow:hidden;cursor:pointer}
.char-avatar img{width:100%;height:100%;object-fit:cover}
.char-avatar-rank{position:absolute;bottom:-4px;right:-4px;background:var(--warning);color:#000;font-size:9px;padding:2px 6px;border-radius:8px;font-weight:600}
.char-info{flex:1;min-width:0}
.char-name{font-size:16px;font-weight:600;display:flex;align-items:center;gap:8px}
.char-title{font-size:10px;background:linear-gradient(135deg,#d4a574,#e8c9a0);color:#000;padding:2px 8px;border-radius:4px;font-weight:500}
.char-brief{font-size:12px;color:var(--text-secondary);margin-top:3px}
.char-quick{display:flex;gap:10px;margin-top:6px}
.char-quick-item{display:flex;align-items:center;gap:3px;font-size:11px}
.char-quick-val{font-weight:600}
.char-expand{width:28px;height:28px;border-radius:50%;background:var(--bg-secondary);display:flex;align-items:center;justify-content:center;transition:transform .3s;flex-shrink:0;font-size:12px}
.char-card.expanded .char-expand{transform:rotate(180deg)}
.char-content{max-height:0;overflow:hidden;transition:max-height .4s ease}
.char-card.expanded .char-content{max-height:800px}
.char-inner{padding:0 14px 14px}
.char-tabs{display:flex;gap:4px;background:var(--bg-secondary);padding:4px;border-radius:10px;margin-bottom:12px}
.char-tab{flex:1;padding:8px;border-radius:8px;font-size:12px;text-align:center;cursor:pointer;transition:all .2s;color:var(--text-secondary)}
.char-tab.active{background:var(--primary);color:white;font-weight:500}
.char-tab-content{display:none;animation:fadeIn .3s}
.char-tab-content.active{display:block}
@keyframes charFadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.char-section{margin-bottom:14px}
.char-section-title{font-size:11px;color:var(--text-tertiary);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.char-section-title::after{content:'';flex:1;height:1px;background:var(--divider)}
.char-stat-bar{margin-bottom:10px}
.char-stat-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.char-stat-label{font-size:12px;color:var(--text-secondary);display:flex;align-items:center;gap:4px}
.char-stat-value{font-size:13px;font-weight:600}
.char-stat-track{height:5px;background:var(--bg-secondary);border-radius:3px;overflow:hidden}
.char-stat-fill{height:100%;border-radius:3px;transition:width .5s}
.char-stat-fill.purple{background:linear-gradient(90deg,#8b5cf6,#a78bfa)}
.char-stat-fill.gold{background:linear-gradient(90deg,#d4a574,#e8c9a0)}
.char-stat-fill.blue{background:linear-gradient(90deg,#3b82f6,#60a5fa)}
.char-stat-fill.red{background:linear-gradient(90deg,#ef4444,#f87171)}
.char-stat-fill.green{background:linear-gradient(90deg,#22c55e,#4ade80)}
.char-stat-fill.pink{background:linear-gradient(90deg,#ec4899,#f472b6)}
.char-favor{background:var(--bg-secondary);border-radius:12px;padding:12px;margin-bottom:10px}
.char-favor-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.char-favor-title{font-size:13px;font-weight:500}
.char-favor-level{font-size:11px;color:var(--warning);background:rgba(245,158,11,.15);padding:3px 8px;border-radius:10px}
.char-favor-item{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.char-favor-item:last-child{margin-bottom:0}
.char-favor-icon{width:26px;height:26px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0}
.char-favor-icon.surface{background:rgba(139,124,247,.2)}
.char-favor-icon.real{background:rgba(239,68,68,.2)}
.char-favor-info{flex:1}
.char-favor-label{font-size:11px;color:var(--text-secondary)}
.char-favor-track{height:4px;background:rgba(255,255,255,.1);border-radius:2px;margin-top:3px;overflow:hidden}
.char-favor-fill{height:100%;border-radius:2px;transition:width .5s}
.char-favor-fill.surface{background:var(--primary)}
.char-favor-fill.real{background:var(--error)}
.char-favor-fill.true{background:var(--success)}
.char-favor-val{font-size:13px;font-weight:600;min-width:28px;text-align:right}
.char-desc{font-size:12px;line-height:1.6;color:var(--text-secondary);background:var(--bg-secondary);padding:12px;border-radius:10px;border-left:3px solid var(--primary)}
.char-tags{display:flex;flex-wrap:wrap;gap:5px;margin-top:10px}
.char-tag{font-size:10px;padding:4px 8px;border-radius:10px;background:var(--bg-secondary);color:var(--text-secondary)}
.char-tag.danger{background:rgba(239,68,68,.15);color:#f87171}
.char-tag.warning{background:rgba(234,179,8,.15);color:#fbbf24}
.char-tag.info{background:rgba(59,130,246,.15);color:#60a5fa}
.char-tag.success{background:rgba(34,197,94,.15);color:#4ade80}
.char-mini-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:10px}
.char-mini-stat{background:var(--bg-secondary);padding:8px;border-radius:8px;text-align:center}
.char-mini-val{font-size:16px;font-weight:600}
.char-mini-label{font-size:10px;color:var(--text-tertiary);margin-top:2px}
.char-relation{display:flex;align-items:center;padding:10px;background:var(--bg-secondary);border-radius:10px;margin-bottom:8px}
.char-relation-avatar{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#3b82f6,#60a5fa);display:flex;align-items:center;justify-content:center;font-size:16px;margin-right:10px}
.char-relation-info{flex:1}
.char-relation-name{font-size:13px;font-weight:500}
.char-relation-type{font-size:11px;color:var(--text-secondary)}
.char-relation-status{font-size:10px;padding:3px 8px;border-radius:10px}
.char-relation-status.ally{background:rgba(34,197,94,.2);color:var(--success)}
.char-relation-status.enemy{background:rgba(239,68,68,.2);color:var(--error)}
.char-relation-status.neutral{background:rgba(255,255,255,.1);color:var(--text-secondary)}
.char-actions{display:flex;gap:8px;margin-top:12px}
.char-action-btn{flex:1;padding:10px;border-radius:10px;border:none;font-size:12px;cursor:pointer;transition:all .2s}
.char-action-btn.primary{background:var(--primary);color:white}
.char-action-btn.secondary{background:var(--bg-secondary);color:var(--text-primary)}
.char-action-btn:active{transform:scale(.97)}
/* æ•¸å€¼è®ŠåŒ–å‹•ç•« */
.char-value-change{position:fixed;font-size:14px;font-weight:600;animation:charFloatUp 1.5s ease forwards;pointer-events:none;z-index:9999}
.char-value-change.up{color:var(--success)}
.char-value-change.down{color:var(--error)}
@keyframes charFloatUp{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-24px)}}
/* è§’è‰²åˆ—è¡¨ç©ºç‹€æ…‹ */
.char-empty{text-align:center;padding:40px 20px;color:var(--text-secondary)}
.char-empty-icon{font-size:48px;margin-bottom:12px}
.char-empty-title{font-size:15px;font-weight:500;margin-bottom:6px;color:var(--text-primary)}
.char-empty-desc{font-size:13px}
/* è§’è‰²æ›´æ–°ä¸­æç¤º */
.char-updating{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.8);padding:12px 20px;border-radius:12px;font-size:13px;display:flex;align-items:center;gap:8px}
.char-updating-spin{width:16px;height:16px;border:2px solid var(--primary);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite}
/* æŒ‡ä»¤ç”Ÿæˆå‘å°æ¨£å¼ */
.wizard-progress{display:flex;align-items:center;padding:16px;background:var(--bg-secondary);border-bottom:1px solid var(--divider)}
.wizard-progress-bar{flex:1;height:6px;background:var(--bg-tertiary);border-radius:3px;overflow:hidden;margin-right:12px}
.wizard-progress-fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--primary-light));border-radius:3px;transition:width .3s}
.wizard-progress-text{font-size:12px;color:var(--text-secondary);white-space:nowrap}
.wizard-content{flex:1;overflow-y:auto;padding:16px}
.wizard-section{margin-bottom:24px}
.wizard-section-title{font-size:16px;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.wizard-section-desc{font-size:13px;color:var(--text-secondary);margin-bottom:16px;line-height:1.6}
.wizard-options{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px}
.wizard-option{padding:10px 16px;background:var(--bg-tertiary);border:2px solid transparent;border-radius:10px;font-size:14px;cursor:pointer;transition:all .2s}
.wizard-option:hover{border-color:var(--primary-light)}
.wizard-option.selected{background:rgba(139,124,247,.2);border-color:var(--primary);color:var(--primary-light)}
.wizard-option.template{display:flex;flex-direction:column;padding:16px;min-width:calc(50% - 4px)}
.wizard-option.template .template-icon{font-size:28px;margin-bottom:8px}
.wizard-option.template .template-name{font-weight:600;margin-bottom:4px}
.wizard-option.template .template-desc{font-size:11px;color:var(--text-tertiary)}
.wizard-input{width:100%;padding:12px 16px;background:var(--bg-tertiary);border:1px solid var(--divider);border-radius:10px;font-size:14px;color:var(--text-primary);outline:none;margin-bottom:12px}
.wizard-input:focus{border-color:var(--primary)}
.wizard-textarea{min-height:100px;resize:vertical;font-family:inherit;line-height:1.6}
.wizard-ai-box{background:var(--bg-card);border-radius:12px;padding:16px;margin-top:16px;border-left:3px solid var(--primary)}
.wizard-ai-header{display:flex;align-items:center;gap:8px;margin-bottom:12px;font-size:13px;color:var(--primary-light)}
.wizard-ai-content{font-size:14px;line-height:1.7;color:var(--text-secondary)}
.wizard-ai-options{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
.wizard-ai-btn{padding:8px 16px;background:var(--bg-tertiary);border:none;border-radius:8px;font-size:13px;color:var(--text-primary);cursor:pointer;transition:all .2s}
.wizard-ai-btn:hover{background:var(--primary);color:white}
.wizard-ai-btn.loading{opacity:.6;pointer-events:none}
.wizard-char-list{margin-top:16px}
.wizard-char-card{background:var(--bg-card);border-radius:10px;padding:12px;margin-bottom:8px;display:flex;align-items:center;gap:12px}
.wizard-char-avatar{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--primary-light));display:flex;align-items:center;justify-content:center;font-size:18px}
.wizard-char-info{flex:1}
.wizard-char-name{font-size:14px;font-weight:600}
.wizard-char-role{font-size:12px;color:var(--text-secondary)}
.wizard-char-actions{display:flex;gap:8px}
.wizard-char-btn{width:28px;height:28px;border-radius:6px;background:var(--bg-tertiary);border:none;font-size:12px;cursor:pointer}
.wizard-example{background:var(--bg-tertiary);border-radius:10px;padding:12px;margin-top:12px;font-size:13px;color:var(--text-secondary);line-height:1.6;max-height:150px;overflow-y:auto}
.wizard-example-title{font-size:12px;color:var(--text-tertiary);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.wizard-footer{display:flex;gap:12px;padding:16px;background:var(--bg-secondary);border-top:1px solid var(--divider)}
.wizard-btn{flex:1;padding:14px;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;transition:all .2s}
.wizard-btn.primary{background:var(--primary);color:white}
.wizard-btn.secondary{background:var(--bg-tertiary);color:var(--text-secondary)}
.wizard-btn:disabled{opacity:.5;cursor:not-allowed}
.wizard-btn:active:not(:disabled){transform:scale(.98)}
.wizard-preview{background:var(--bg-card);border-radius:12px;padding:16px;margin-top:16px}
.wizard-preview-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.wizard-preview-title{font-size:14px;font-weight:600}
.wizard-preview-stats{font-size:12px;color:var(--text-tertiary)}
.wizard-preview-content{background:var(--bg-tertiary);border-radius:8px;padding:12px;font-size:13px;line-height:1.7;max-height:300px;overflow-y:auto;white-space:pre-wrap;font-family:monospace}
.wizard-chat{display:flex;flex-direction:column;gap:12px;margin-top:16px}
.wizard-chat-msg{max-width:85%;padding:12px 16px;border-radius:16px;font-size:14px;line-height:1.6}
.wizard-chat-msg.ai{background:var(--bg-card);border-bottom-left-radius:4px;align-self:flex-start}
.wizard-chat-msg.user{background:var(--primary);color:white;border-bottom-right-radius:4px;align-self:flex-end}
.wizard-chat-input{display:flex;gap:8px;margin-top:12px}
.wizard-chat-field{flex:1;padding:12px 16px;background:var(--bg-tertiary);border:none;border-radius:20px;font-size:14px;color:var(--text-primary);outline:none}
.wizard-chat-send{width:40px;height:40px;background:var(--primary);border:none;border-radius:50%;color:white;font-size:16px;cursor:pointer}
/* Prompt åˆ†æåŠŸèƒ½æ¨£å¼ */
.analyze-import{display:flex;gap:12px;margin-bottom:16px}
.analyze-import-btn{flex:1;padding:40px 16px;background:var(--bg-card);border:2px dashed var(--divider);border-radius:12px;cursor:pointer;text-align:center;transition:all .2s}
.analyze-import-btn:hover{border-color:var(--primary);background:rgba(139,124,247,.05)}
.analyze-import-btn .icon{font-size:32px;margin-bottom:8px}
.analyze-import-btn .label{font-size:14px;color:var(--text-secondary)}
.analyze-textarea{width:100%;min-height:200px;padding:16px;background:var(--bg-tertiary);border:1px solid var(--divider);border-radius:12px;font-size:14px;color:var(--text-primary);font-family:monospace;line-height:1.6;resize:vertical;outline:none}
.analyze-textarea:focus{border-color:var(--primary)}
.analyze-stats{display:flex;gap:16px;margin:16px 0;padding:12px 16px;background:var(--bg-card);border-radius:10px}
.analyze-stat{text-align:center}
.analyze-stat-value{font-size:20px;font-weight:700;color:var(--primary)}
.analyze-stat-label{font-size:11px;color:var(--text-tertiary)}
.analyze-score{text-align:center;padding:24px;background:var(--bg-card);border-radius:16px;margin-bottom:20px}
.analyze-score-ring{width:120px;height:120px;margin:0 auto 12px;position:relative}
.analyze-score-ring svg{transform:rotate(-90deg)}
.analyze-score-ring circle{fill:none;stroke-width:8}
.analyze-score-ring .bg{stroke:var(--bg-tertiary)}
.analyze-score-ring .fill{stroke:var(--primary);stroke-linecap:round;transition:stroke-dashoffset .5s}
.analyze-score-value{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.analyze-score-num{font-size:36px;font-weight:700}
.analyze-score-label{font-size:12px;color:var(--text-tertiary)}
.analyze-score-text{font-size:14px;color:var(--text-secondary)}
.analyze-modules{margin-bottom:20px}
.analyze-module{background:var(--bg-card);border-radius:12px;margin-bottom:8px;overflow:hidden}
.analyze-module-header{display:flex;align-items:center;padding:14px 16px;cursor:pointer}
.analyze-module-icon{font-size:18px;margin-right:10px}
.analyze-module-name{flex:1;font-size:14px;font-weight:500}
.analyze-module-score{display:flex;align-items:center;gap:8px}
.analyze-module-bar{width:60px;height:6px;background:var(--bg-tertiary);border-radius:3px;overflow:hidden}
.analyze-module-bar-fill{height:100%;border-radius:3px;transition:width .3s}
.analyze-module-bar-fill.high{background:var(--success)}
.analyze-module-bar-fill.medium{background:var(--warning)}
.analyze-module-bar-fill.low{background:var(--error)}
.analyze-module-num{font-size:13px;font-weight:600;min-width:28px;text-align:right}
.analyze-module-status{font-size:14px;margin-left:4px}
.analyze-module-body{padding:0 16px 14px;display:none}
.analyze-module.expanded .analyze-module-body{display:block}
.analyze-module-issues{margin-bottom:12px}
.analyze-issue{display:flex;align-items:flex-start;gap:8px;padding:8px 0;border-bottom:1px solid var(--divider);font-size:13px}
.analyze-issue:last-child{border-bottom:none}
.analyze-issue-icon{flex-shrink:0}
.analyze-issue-text{flex:1;color:var(--text-secondary);line-height:1.5}
.analyze-module-actions{display:flex;gap:8px}
.analyze-module-btn{padding:8px 16px;background:var(--bg-tertiary);border:none;border-radius:8px;font-size:13px;color:var(--text-primary);cursor:pointer;transition:all .2s}
.analyze-module-btn:hover{background:var(--primary);color:white}
.analyze-module-btn.primary{background:var(--primary);color:white}
.analyze-suggestions{background:var(--bg-card);border-radius:12px;padding:16px;margin-bottom:20px;border-left:3px solid var(--primary)}
.analyze-suggestions-title{font-size:14px;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.analyze-suggestions-content{font-size:14px;line-height:1.7;color:var(--text-secondary)}
.analyze-compare{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px}
.analyze-compare-col{background:var(--bg-tertiary);border-radius:10px;padding:12px;max-height:300px;overflow-y:auto}
.analyze-compare-title{font-size:12px;font-weight:600;margin-bottom:8px;color:var(--text-tertiary);display:flex;align-items:center;gap:6px}
.analyze-compare-content{font-size:12px;line-height:1.6;white-space:pre-wrap;font-family:monospace;color:var(--text-secondary)}
.analyze-compare-content .added{background:rgba(16,185,129,.2);color:var(--success)}
.analyze-compare-content .removed{background:rgba(239,68,68,.2);color:var(--error);text-decoration:line-through}
.analyze-actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:16px}
.analyze-chat{margin-top:20px;padding-top:20px;border-top:1px solid var(--divider)}
/* æ¶ˆæ¯ç‹€æ…‹å¡ç‰‡æ¨£å¼ */
.msg-story{line-height:1.8}
.msg-status-section{margin-top:16px;border-top:1px solid var(--divider);padding-top:12px}
.msg-status-header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--bg-tertiary);border-radius:10px;cursor:pointer;transition:all .2s}
.msg-status-header:hover{background:var(--bg-card)}
.msg-status-header .title{display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500;color:var(--text-secondary)}
.msg-status-header .toggle{font-size:12px;color:var(--text-tertiary);transition:transform .2s}
.msg-status-header.expanded .toggle{transform:rotate(180deg)}
.msg-status-cards{display:none;margin-top:10px;gap:10px}
.msg-status-header.expanded+.msg-status-cards{display:flex;flex-direction:column}
.status-card{background:var(--bg-card);border-radius:12px;padding:14px;border:1px solid var(--divider)}
.status-card-header{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.status-card-avatar{width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--primary-light));display:flex;align-items:center;justify-content:center;font-size:20px;color:white;flex-shrink:0}
.status-card-avatar img{width:100%;height:100%;object-fit:cover;border-radius:10px}
.status-card-info{flex:1;min-width:0}
.status-card-name{font-size:15px;font-weight:600;display:flex;align-items:center;gap:6px}
.status-card-title{font-size:12px;color:var(--primary-light);background:rgba(139,124,247,.15);padding:2px 8px;border-radius:4px}
.status-card-meta{font-size:12px;color:var(--text-tertiary);margin-top:2px}
.status-card-stats{display:flex;flex-direction:column;gap:8px}
.status-stat-row{display:flex;align-items:center;gap:10px}
.status-stat-label{font-size:12px;color:var(--text-secondary);min-width:70px}
.status-stat-bar{flex:1;height:6px;background:var(--bg-tertiary);border-radius:3px;overflow:hidden}
.status-stat-fill{height:100%;border-radius:3px;transition:width .3s}
.status-stat-fill.high{background:linear-gradient(90deg,var(--success),#34d399)}
.status-stat-fill.medium{background:linear-gradient(90deg,var(--warning),#fbbf24)}
.status-stat-fill.low{background:linear-gradient(90deg,var(--error),#f87171)}
.status-stat-fill.primary{background:linear-gradient(90deg,var(--primary),var(--primary-light))}
.status-stat-value{font-size:12px;font-weight:600;min-width:28px;text-align:right}
.status-card-footer{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;padding-top:10px;border-top:1px solid var(--divider)}
.status-tag{font-size:11px;padding:3px 8px;background:var(--bg-tertiary);border-radius:4px;color:var(--text-secondary)}
.status-tag.mood{background:rgba(59,130,246,.15);color:var(--info)}
.status-tag.note{background:rgba(245,158,11,.15);color:var(--warning)}
.msg-format-warning{display:flex;align-items:center;gap:8px;padding:10px 14px;background:rgba(245,158,11,.1);border-radius:8px;margin-top:12px;font-size:12px;color:var(--warning)}
.msg-format-warning .icon{font-size:16px}

/* å°å…¥åŠ‡æœ¬æ¨¡æ…‹æ¡†æ¨£å¼ */
.script-import-modal{max-width:600px;max-height:80vh;overflow:hidden}
.script-import-modal.active{display:flex;flex-direction:column}
.script-import-steps{display:flex;justify-content:center;gap:8px;padding:12px 0;border-bottom:1px solid var(--divider);margin-bottom:16px}
.script-step{font-size:12px;color:var(--text-tertiary);padding:4px 12px;border-radius:12px;transition:all .2s}
.script-step.active{color:var(--primary);background:rgba(99,102,241,.1);font-weight:600}
.script-step.done{color:var(--success)}
.script-import-content{flex:1;overflow-y:auto;padding:0 4px}
.script-input-tabs{display:flex;gap:8px;margin-bottom:12px}
.script-tab{flex:1;padding:10px;border:1px solid var(--divider);border-radius:8px;background:var(--bg-secondary);font-size:13px;cursor:pointer;transition:all .2s}
.script-tab.active{border-color:var(--primary);background:rgba(99,102,241,.1);color:var(--primary)}
.script-input-area textarea{width:100%;height:200px;padding:12px;border:1px solid var(--divider);border-radius:8px;background:var(--bg-secondary);color:var(--text-primary);font-size:13px;resize:none;font-family:inherit;box-sizing:border-box}
.script-input-area textarea:focus{outline:none;border-color:var(--primary)}
.script-file-drop{border:2px dashed var(--divider);border-radius:12px;padding:40px 20px;text-align:center;cursor:pointer;transition:all .2s}
.script-file-drop:hover{border-color:var(--primary);background:rgba(99,102,241,.05)}
.script-file-drop.dragover{border-color:var(--primary);background:rgba(99,102,241,.1)}
.script-file-icon{font-size:40px;margin-bottom:12px}
.script-file-text{font-size:14px;color:var(--text-primary);margin-bottom:8px}
.script-file-hint{font-size:12px;color:var(--text-tertiary)}
.script-file-selected{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--bg-tertiary);border-radius:8px;margin-top:12px}
.script-file-selected button{background:none;border:none;color:var(--text-tertiary);cursor:pointer;font-size:16px}
.script-token-estimate{text-align:center;padding:12px;font-size:13px;color:var(--text-secondary);margin-top:12px;background:var(--bg-tertiary);border-radius:8px}
.script-analyzing{text-align:center;padding:40px 20px}
.script-analyzing-icon{font-size:48px;animation:spin 2s linear infinite}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.script-analyzing-text{font-size:16px;margin:16px 0;color:var(--text-primary)}
.script-progress-bar{width:100%;height:8px;background:var(--bg-tertiary);border-radius:4px;overflow:hidden;margin:16px 0}
.script-progress-fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--info));border-radius:4px;transition:width .3s;width:0}
.script-progress-percent{font-size:14px;color:var(--primary);font-weight:600}
.script-analyzing-steps{margin-top:24px;text-align:left;max-width:280px;margin-left:auto;margin-right:auto}
.script-analyze-step{padding:6px 0;font-size:13px;color:var(--text-tertiary)}
.script-analyze-step.active{color:var(--primary)}
.script-analyze-step.done{color:var(--success)}
.script-analyze-step.done::first-letter{content:'âœ“'}
.script-preview-tabs{display:flex;gap:6px;margin-bottom:12px;overflow-x:auto;padding-bottom:4px}
.script-preview-tab{padding:8px 14px;border:1px solid var(--divider);border-radius:8px;background:var(--bg-secondary);font-size:12px;white-space:nowrap;cursor:pointer;transition:all .2s}
.script-preview-tab.active{border-color:var(--primary);background:rgba(99,102,241,.1);color:var(--primary)}
.script-preview-content{display:none}
.script-preview-content.active{display:block}
.script-preview-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.script-token-badge{font-size:11px;padding:3px 8px;background:var(--bg-tertiary);border-radius:10px;color:var(--text-secondary)}
.script-preview-box{background:var(--bg-tertiary);border-radius:8px;padding:12px;max-height:200px;overflow-y:auto;font-size:12px;line-height:1.6;white-space:pre-wrap;word-break:break-word}
.script-edit-btn{margin-top:8px;padding:6px 12px;font-size:12px;background:var(--bg-secondary);border:1px solid var(--divider);border-radius:6px;cursor:pointer}
.script-category-list{max-height:300px;overflow-y:auto}
.script-category-group{margin-bottom:12px}
.script-category-header{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--bg-tertiary);border-radius:8px;cursor:pointer;font-size:13px;font-weight:500}
.script-category-header .count{font-size:11px;color:var(--text-tertiary);font-weight:normal}
.script-category-items{padding:8px 0}
.script-entry-item{display:flex;align-items:flex-start;gap:10px;padding:10px 12px;border:1px solid var(--divider);border-radius:8px;margin-bottom:8px;background:var(--bg-secondary)}
.script-entry-item input[type="checkbox"]{margin-top:3px}
.script-entry-info{flex:1;min-width:0}
.script-entry-name{font-size:13px;font-weight:500;margin-bottom:4px;display:flex;align-items:center;gap:6px}
.script-entry-name .icon{font-size:14px}
.script-entry-keys{font-size:11px;color:var(--text-tertiary);margin-bottom:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.script-entry-tokens{font-size:11px;color:var(--text-secondary)}
.script-entry-actions{display:flex;gap:4px}
.script-entry-actions button{padding:4px 8px;font-size:11px;background:var(--bg-tertiary);border:none;border-radius:4px;cursor:pointer;color:var(--text-secondary)}
.script-entry-actions button:hover{background:var(--bg-primary);color:var(--text-primary)}
.script-preview-actions{display:flex;gap:8px;margin-top:12px}
.script-preview-actions button{padding:8px 12px;font-size:12px;background:var(--bg-secondary);border:1px solid var(--divider);border-radius:6px;cursor:pointer}
.script-entry-list{max-height:300px;overflow-y:auto}
.script-char-item{display:flex;align-items:center;gap:12px;padding:12px;border:1px solid var(--divider);border-radius:8px;margin-bottom:8px;background:var(--bg-secondary)}
.script-char-avatar{width:40px;height:40px;border-radius:50%;background:var(--bg-tertiary);display:flex;align-items:center;justify-content:center;font-size:20px}
.script-char-info{flex:1}
.script-char-name{font-size:13px;font-weight:500}
.script-char-title{font-size:11px;color:var(--text-tertiary)}
.script-char-category{font-size:10px;padding:2px 6px;border-radius:4px;background:var(--bg-tertiary)}
.script-char-category.protagonist{background:rgba(245,158,11,.15);color:var(--warning)}
.script-char-category.supporting{background:rgba(99,102,241,.15);color:var(--primary)}
.script-complete{text-align:center;padding:20px}
.script-complete-icon{font-size:48px;margin-bottom:12px}
.script-complete-title{font-size:18px;font-weight:600;margin-bottom:20px}
.script-complete-stats{text-align:left;background:var(--bg-tertiary);border-radius:8px;padding:16px;margin-bottom:16px}
.script-complete-stat{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--divider)}
.script-complete-stat:last-child{border-bottom:none}
.script-optimization-box{background:linear-gradient(135deg,rgba(99,102,241,.1),rgba(59,130,246,.1));border-radius:12px;padding:16px;margin-bottom:16px}
.script-optimization-title{font-size:14px;font-weight:600;margin-bottom:12px;text-align:center}
.script-optimization-content{display:flex;justify-content:center;align-items:center;gap:16px;font-size:14px}
.script-optimization-arrow{color:var(--success);font-size:20px}
.script-optimization-savings{color:var(--success);font-weight:600}
.script-complete-tip{font-size:12px;color:var(--text-tertiary);padding:12px;background:var(--bg-tertiary);border-radius:8px}
.script-import-actions{justify-content:space-between}
.script-entry-reasoning{margin-top:12px;padding:10px;background:rgba(99,102,241,.05);border-radius:8px;font-size:12px;color:var(--text-secondary)}
.script-entry-reasoning::before{content:'ğŸ’¡ AI åˆ†æï¼š';font-weight:500;color:var(--primary)}
.form-group{margin-bottom:12px}
.form-group label{display:block;font-size:12px;color:var(--text-secondary);margin-bottom:6px}
.modal-textarea{width:100%;padding:10px;border:1px solid var(--divider);border-radius:8px;background:var(--bg-secondary);color:var(--text-primary);font-size:13px;resize:vertical;font-family:inherit}
  </style>
</head>
<body>
<div class="app" id="app">
  <div class="status-bar">
    <span id="status-time">09:41</span>
    <div style="display:flex;gap:4px;font-size:12px"><span>ğŸ“¶</span><span>ğŸ”‹</span></div>
  </div>
  <div class="views">
    <!-- æ•…äº‹åˆ—è¡¨ -->
    <div class="view active" id="view-stories">
      <div class="list-nav">
        <span class="list-nav-title">ç¹”å¤¢</span>
        <div style="display:flex;gap:4px">
          <div class="nav-btn" onclick="toggleScreen()" title="åˆ‡æ›æ¨¡å¼">ğŸ–¥ï¸</div>
          <div class="nav-btn" onclick="createStory()" title="æ–°å»º">â•</div>
        </div>
      </div>
      <div class="search-bar">
        <div class="search-wrap">
          <span style="color:var(--text-tertiary)">ğŸ”</span>
          <input type="text" class="search-input" placeholder="æœç´¢æ•…äº‹" id="story-search" oninput="filterStories()">
        </div>
      </div>
      <div class="scroll" id="story-list"></div>
      <div class="tab-bar">
        <div class="tab-item active" onclick="switchTab('stories')"><span class="tab-icon">ğŸ“š</span><span class="tab-label">æ•…äº‹</span></div>
        <div class="tab-item" onclick="switchTab('instructions')"><span class="tab-icon">ğŸ“œ</span><span class="tab-label">æŒ‡ä»¤</span></div>
        <div class="tab-item" onclick="switchTab('settings')"><span class="tab-icon">âš™ï¸</span><span class="tab-label">è¨­ç½®</span></div>
      </div>
    </div>
    <!-- é–±è®€é  -->
    <div class="view" id="view-reading">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">â€¹</div>
        <span class="nav-title" id="reading-title">æ•…äº‹</span>
        <div class="nav-right">
          <div class="nav-btn" onclick="goTo('view-characters')" title="è§’è‰²ç‹€æ…‹" id="btn-characters">ğŸ‘¥</div>
          <div class="nav-btn" onclick="goTo('view-lore')" title="è³‡æ–™åº«">ğŸ“–</div>
          <div class="nav-btn" onclick="goTo('view-search')" title="æœç´¢">ğŸ”</div>
          <div class="nav-btn" onclick="showSheet()" title="è¨­ç½®">âš™ï¸</div>
          <div class="nav-btn" onclick="showMore(event)" title="æ›´å¤š">â‹¯</div>
        </div>
      </div>
      <!-- v19: ç¶“ç‡Ÿæ¨¡å¼è³‡æºé¢æ¿ -->
      <div class="sim-resource-bar" id="sim-resource-bar" style="display:none">
        <div class="sim-day-badge" id="sim-day-badge">ğŸ“… ç¬¬ 1 å¤©</div>
        <!-- è³‡æºé …ç›®å‹•æ…‹æ¸²æŸ“ -->
      </div>
      <div class="progress-wrap">
        <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
        <span class="progress-text" id="progress-text">0%</span>
      </div>
      <div class="content" id="content-area"></div>
      <div class="quick-cmds" id="quick-cmds">
        <!-- å‹•æ…‹æ¸²æŸ“ -->
      </div>
      <div class="persona-bar">
        <div class="persona-selector" onclick="showPersonaSelector()">
          <span class="persona-avatar" id="current-persona-avatar">ğŸ‘¤</span>
          <div class="persona-info">
            <div class="persona-label">ç•¶å‰èº«ä»½</div>
            <div class="persona-name" id="current-persona-name">ç„¡ç‰¹å®šèº«ä»½</div>
          </div>
          <span class="persona-dropdown">â–¼</span>
        </div>
      </div>
      <div class="input-bar">
        <div class="input-wrap"><input type="text" class="input-field" id="user-input" placeholder="è¼¸å…¥ä½ çš„è¡Œå‹•æˆ–å°è©±..." onkeydown="handleInputKey(event)"></div>
        <button class="send-btn" id="send-btn" onclick="send()">â†‘</button>
      </div>
    </div>
    <!-- è³‡æ–™åº« -->
    <div class="view" id="view-lore">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">â€¹</div>
        <span class="nav-title">ä¸–ç•Œè§€è³‡æ–™åº«</span>
        <div class="nav-right">
          <div class="nav-btn" onclick="aiExtractLore()">ğŸ¤–</div>
          <div class="nav-btn" onclick="addLore()">â•</div>
        </div>
      </div>
      <div class="search-bar">
        <div class="search-wrap">
          <span style="color:var(--text-tertiary)">ğŸ”</span>
          <input type="text" class="search-input" placeholder="æœç´¢è³‡æ–™" id="lore-search" oninput="filterLore()">
        </div>
      </div>
      <div class="scroll sys" id="lore-list"></div>
      <div class="input-bar" style="justify-content:center">
        <span style="font-size:12px;color:var(--text-tertiary)" id="lore-count">å·²é¸ 0 é …</span>
      </div>
    </div>
    <!-- æ™‚é–“è»¸ -->
    <div class="view" id="view-timeline">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">â€¹</div>
        <span class="nav-title">æ•…äº‹æ™‚é–“è»¸</span>
        <div class="nav-right">
          <div class="nav-btn" onclick="addTimeline()">â•</div>
          <div class="nav-btn" onclick="timeJump()">â­ï¸</div>
        </div>
      </div>
      <div class="scroll sys" id="timeline-content"></div>
    </div>
    <!-- ä¼ç­†/äº‹ä»¶ -->
    <div class="view" id="view-foreshadow">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">â€¹</div>
        <span class="nav-title">ä¼ç­†èˆ‡äº‹ä»¶</span>
        <div class="nav-right">
          <div class="nav-btn" onclick="aiAnalyzeForeshadow()">ğŸ¤–</div>
          <div class="nav-btn" onclick="addForeshadowOrEvent()">â•</div>
        </div>
      </div>
      <div class="tabs-bar">
        <button class="tab-btn active" onclick="switchFTab('foreshadow',this)">ä¼ç­†</button>
        <button class="tab-btn" onclick="switchFTab('events',this)">äº‹ä»¶</button>
      </div>
      <div class="scroll sys" id="foreshadow-content"></div>
    </div>
    <!-- å­˜æª” -->
    <div class="view" id="view-saves">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">â€¹</div>
        <span class="nav-title">å­˜æª”ç®¡ç†</span>
        <div class="nav-right"><div class="nav-btn" onclick="toast(T('å­˜æª”è¨­ç½®'))">âš™ï¸</div></div>
      </div>
      <div class="scroll sys" id="saves-content"></div>
      <div class="input-bar"><button class="action-btn primary" style="flex:1" onclick="createSave()">ğŸ’¾ å‰µå»ºæ–°å­˜æª”</button></div>
    </div>
    <!-- æœç´¢ -->
    <div class="view" id="view-search">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">â€¹</div>
        <span class="nav-title">æœç´¢</span>
        <div class="nav-right"><div class="nav-btn" style="font-size:13px;width:auto;padding:0 8px" onclick="showAdvancedSearch()">é«˜ç´š</div></div>
      </div>
      <div class="search-bar">
        <div class="search-wrap">
          <span style="color:var(--text-tertiary)">ğŸ”</span>
          <input type="text" class="search-input" placeholder="æœç´¢æ•…äº‹å…§å®¹" id="content-search" oninput="doContentSearch()">
        </div>
      </div>
      <div class="scroll sys" id="search-results"><div class="empty"><div class="empty-icon">ğŸ”</div><div class="empty-title">è¼¸å…¥é—œéµè©æœç´¢</div></div></div>
    </div>
    <!-- æŒ‡ä»¤ç®¡ç† -->
    <div class="view" id="view-instructions">
      <div class="list-nav">
        <span class="list-nav-title" style="background:none;-webkit-text-fill-color:var(--text-primary)">æŒ‡ä»¤ç®¡ç†</span>
        <div style="display:flex;gap:4px">
          <div class="nav-btn" onclick="startAnalyze()" title="åˆ†æPrompt">ğŸ”</div>
          <div class="nav-btn" onclick="startWizard()" title="AIç”ŸæˆæŒ‡ä»¤">ğŸª„</div>
          <div class="nav-btn" onclick="importInst()">â•</div>
        </div>
      </div>
      <div class="scroll sys" id="inst-list"></div>
      <div class="tab-bar">
        <div class="tab-item" onclick="switchTab('stories')"><span class="tab-icon">ğŸ“š</span><span class="tab-label">æ•…äº‹</span></div>
        <div class="tab-item active" onclick="switchTab('instructions')"><span class="tab-icon">ğŸ“œ</span><span class="tab-label">æŒ‡ä»¤</span></div>
        <div class="tab-item" onclick="switchTab('settings')"><span class="tab-icon">âš™ï¸</span><span class="tab-label">è¨­ç½®</span></div>
      </div>
    </div>
    <!-- è¨­ç½® -->
    <div class="view" id="view-settings">
      <div class="list-nav">
        <span class="list-nav-title" style="background:none;-webkit-text-fill-color:var(--text-primary)">è¨­ç½®</span>
      </div>
      <div class="scroll sys" style="padding-bottom:80px">
        <div class="settings-section">
          <div class="settings-section-title">ğŸ¨ å¤–è§€</div>
          <div class="settings-card">
            <div class="settings-item" onclick="toggleTheme()"><span class="settings-item-label">ä¸»é¡Œ</span><span class="settings-item-value" id="theme-val">æ·±è‰²æ¨¡å¼ â€º</span></div>
            <div class="settings-item" onclick="toggleScreen()"><span class="settings-item-label">å±å¹•æ¨¡å¼</span><span class="settings-item-value" id="screen-val">æ‰‹æ©Ÿæ¨¡æ“¬å™¨ â€º</span></div>
            <div class="settings-item" onclick="setChatBackground()"><span class="settings-item-label">èŠå¤©èƒŒæ™¯</span><span class="settings-item-value" id="chat-bg-val">é»˜èª â€º</span></div>
            <div class="settings-item" onclick="showFontSettings()"><span class="settings-item-label">å­—é«”å¤§å°</span><span class="settings-item-value" id="font-size-val">16px â€º</span></div>
            <div class="settings-item" onclick="showLineHeightSettings()"><span class="settings-item-label">è¡Œé–“è·</span><span class="settings-item-value" id="line-height-val">1.8x â€º</span></div>
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">ğŸ¤– AIè¨­ç½®</div>
          <div class="settings-card">
            <div class="settings-item" onclick="goTo('view-api')"><span class="settings-item-label">API é è¨­ç®¡ç†</span><span class="settings-item-value">â€º</span></div>
            <div class="settings-item" onclick="showContextSettings()"><span class="settings-item-label">ä¸Šä¸‹æ–‡è¨­ç½®</span><span class="settings-item-value" id="context-val">20æ¢æ¶ˆæ¯ â€º</span></div>
            <div class="settings-item" onclick="showMaxTokensSettings()"><span class="settings-item-label">æœ€å¤§ç”Ÿæˆé•·åº¦</span><span class="settings-item-value" id="max-tokens-val">4096 â€º</span></div>
            <div class="settings-item" onclick="showStreamingSettings()"><span class="settings-item-label">æµå¼éŸ¿æ‡‰</span><span class="settings-item-value" id="streaming-val">å·²é–‹å•Ÿ â€º</span></div>
            <div class="settings-item" onclick="showDefaultAIParams()"><span class="settings-item-label">AI åƒæ•¸é»˜èªå€¼</span><span class="settings-item-value" id="ai-params-val">T:0.8 â€º</span></div>
            <div class="settings-item" onclick="showTemplateVarsSettings()"><span class="settings-item-label">æ¨¡æ¿è®Šé‡</span><span class="settings-item-value" id="template-vars-val">è¨­ç½® â€º</span></div>
            <div class="settings-item"><span class="settings-item-label">ä¸€è‡´æ€§æª¢æŸ¥</span><div class="toggle active" id="tog-consist" onclick="toggleSet('consist')"></div></div>
            <div class="settings-item"><span class="settings-item-label">è‡ªå‹•ç« ç¯€ç¸½çµ</span><div class="toggle active" id="tog-summary" onclick="toggleSet('summary')"></div></div>
            <div class="settings-item"><span class="settings-item-label">è¡Œå‹•å»ºè­°</span><div class="toggle active" id="tog-suggest" onclick="toggleSet('suggest')"></div></div>
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">âŒ¨ï¸ è¼¸å…¥</div>
          <div class="settings-card">
            <div class="settings-item" onclick="showTypingSpeedSettings()"><span class="settings-item-label">æ‰“å­—æ©Ÿæ•ˆæœ</span><span class="settings-item-value" id="typing-speed-val">30ms â€º</span></div>
            <div class="settings-item" onclick="toggleSendKey()"><span class="settings-item-label">ç™¼é€å¿«æ·éµ</span><span class="settings-item-value" id="send-key-val">Enter â€º</span></div>
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">ğŸŒ è¯­è¨€</div>
          <div class="settings-card">
            <div class="settings-item" onclick="showChineseConvertSettings()"><span class="settings-item-label">è¯­è¨€è®¾ç½®</span><span class="settings-item-value" id="cn-convert-val">ç®€ä½“ â€º</span></div>
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">ğŸ’¾ æ•¸æ“š</div>
          <div class="settings-card">
            <div class="settings-item" onclick="exportAll()"><span class="settings-item-label">å°å‡ºæ‰€æœ‰æ•¸æ“š</span><span class="settings-item-value">â€º</span></div>
            <div class="settings-item" onclick="importAll()"><span class="settings-item-label">å°å…¥æ•¸æ“š</span><span class="settings-item-value">â€º</span></div>
            <div class="settings-item danger" onclick="clearAll()"><span class="settings-item-label">æ¸…ç©ºæ‰€æœ‰æ•¸æ“š</span><span class="settings-item-value">â€º</span></div>
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">ğŸ“± æ‡‰ç”¨</div>
          <div class="settings-card">
            <div class="settings-item" onclick="installPWA()"><span class="settings-item-label">å®‰è£åˆ°æ¡Œé¢</span><span class="settings-item-value" id="pwa-install-status">â€º</span></div>
            <div class="settings-item" onclick="debugApiTest()"><span class="settings-item-label">ğŸ”§ API é€£æ¥èª¿è©¦</span><span class="settings-item-value">â€º</span></div>
            <div class="settings-item"><span class="settings-item-label">é—œæ–¼ç¹”å¤¢</span><span class="settings-item-value">v5.3 â€º</span></div>
          </div>
        </div>
      </div>
      <div class="tab-bar">
        <div class="tab-item" onclick="switchTab('stories')"><span class="tab-icon">ğŸ“š</span><span class="tab-label">æ•…äº‹</span></div>
        <div class="tab-item" onclick="switchTab('instructions')"><span class="tab-icon">ğŸ“œ</span><span class="tab-label">æŒ‡ä»¤</span></div>
        <div class="tab-item active" onclick="switchTab('settings')"><span class="tab-icon">âš™ï¸</span><span class="tab-label">è¨­ç½®</span></div>
      </div>
    </div>
    <!-- APIè¨­ç½® -->
    <div class="view" id="view-api">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">â€¹</div>
        <span class="nav-title">API é è¨­ç®¡ç†</span>
        <div class="nav-right"><div class="nav-btn" onclick="addApi()">â•</div></div>
      </div>
      <div class="scroll sys" id="api-list"></div>
    </div>
    <!-- ç« ç¯€ç®¡ç† -->
    <div class="view" id="view-chapters">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">â€¹</div>
        <span class="nav-title">ç« ç¯€ç®¡ç†</span>
        <div class="nav-right"><div class="nav-btn" onclick="addChapter()">â•</div></div>
      </div>
      <div class="scroll sys" id="chapter-list"></div>
    </div>
    <!-- æ›¸ç±¤åˆ—è¡¨ -->
    <div class="view" id="view-bookmarks">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">â€¹</div>
        <span class="nav-title">æ›¸ç±¤åˆ—è¡¨</span>
        <div class="nav-right"></div>
      </div>
      <div class="scroll sys" id="bookmark-list"></div>
    </div>
    <!-- èƒŒåŒ…ç³»çµ± -->
    <div class="view" id="view-inventory">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">â€¹</div>
        <span class="nav-title">ğŸ’ èƒŒåŒ…</span>
        <div class="nav-right">
          <div class="nav-btn" onclick="aiSyncInventory()" title="AIæ™ºèƒ½åŒæ­¥">ğŸ¤–</div>
          <div class="nav-btn" onclick="addInventoryItem()">â•</div>
        </div>
      </div>
      <div style="padding:8px 16px;background:var(--bg-secondary);border-bottom:1px solid var(--divider)">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input type="text" class="form-input" id="inventory-search" placeholder="ğŸ” æœç´¢ç‰©å“..." style="flex:1;min-width:120px;padding:6px 10px;font-size:13px" oninput="filterInventory()">
          <select class="form-input" id="inventory-filter" style="padding:6px 10px;font-size:13px" onchange="filterInventory()">
            <option value="all">å…¨éƒ¨</option>
            <option value="weapon">âš”ï¸ æ­¦å™¨</option>
            <option value="armor">ğŸ›¡ï¸ é˜²å…·</option>
            <option value="consumable">ğŸ§ª æ¶ˆè€—å“</option>
            <option value="material">ğŸ“¦ ææ–™</option>
            <option value="key">ğŸ”‘ é—œéµç‰©å“</option>
            <option value="other">ğŸ“‹ å…¶ä»–</option>
          </select>
        </div>
      </div>
      <div class="scroll sys" id="inventory-list" style="padding:12px 16px"></div>
    </div>
    <!-- åˆ†æ”¯ç®¡ç† -->
    <div class="view" id="view-branches">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">â€¹</div>
        <span class="nav-title">åˆ†æ”¯ç®¡ç†</span>
        <div class="nav-right"><div class="nav-btn" onclick="createBranch()">â•</div></div>
      </div>
      <div class="scroll sys" id="branch-list"></div>
    </div>
    <!-- Lorebook è¨­å®šåº« -->
    <div class="view" id="view-lorebook">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">â€¹</div>
        <span class="nav-title">ğŸ”® Lorebook</span>
        <div class="nav-right">
          <div class="nav-btn" onclick="showAiLorebookModal()" title="AIç”Ÿæˆ">ğŸ¤–</div>
          <div class="nav-btn" onclick="importFromLore()" title="å¾è³‡æ–™åº«å°å…¥">ğŸ“¥</div>
          <div class="nav-btn" onclick="addLorebook()">â•</div>
        </div>
      </div>
      <div style="padding:8px 16px;background:var(--bg-secondary);border-bottom:1px solid var(--divider)">
        <div style="font-size:12px;color:var(--text-tertiary)">ç•¶å°è©±åŒ…å«é—œéµè©æ™‚ï¼Œè‡ªå‹•æ³¨å…¥ç›¸é—œè¨­å®šåˆ° AI ä¸Šä¸‹æ–‡</div>
      </div>
      <div class="scroll sys" id="lorebook-list"></div>
    </div>
    <!-- v7: è§’è‰²å¡ç‰‡è¦–åœ– -->
    <div class="view" id="view-characters">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">â€¹</div>
        <span class="nav-title">è§’è‰²ç‹€æ…‹</span>
        <div class="nav-right">
          <div class="nav-btn" onclick="toggleCharBatchMode()" title="æ‰¹é‡æ“ä½œ" id="char-batch-btn">â˜‘ï¸</div>
          <div class="nav-btn" onclick="showCharacterMenu()" title="æ›´å¤š">â‹¯</div>
          <div class="nav-btn" onclick="addCharacterManual()" title="æ‰‹å‹•æ·»åŠ ">â•</div>
        </div>
      </div>
      <!-- v25: æœç´¢å’Œç­›é€‰æ  -->
      <div class="char-filter-bar">
        <div class="char-search-wrap">
          <span class="char-search-icon">ğŸ”</span>
          <input type="text" class="char-search-input" id="char-search-input" placeholder="æœç´¢è§’è‰²..." oninput="filterCharacters()">
        </div>
        <select class="char-filter-select" id="char-filter-category" onchange="filterCharacters()">
          <option value="all">å…¨éƒ¨åˆ†é¡</option>
          <option value="protagonist">â­ ä¸»è§’</option>
          <option value="supporting">ğŸ‘¤ é…è§’</option>
          <option value="npc">ğŸ‘¥ NPC</option>
        </select>
      </div>
      <!-- v25: æ‰¹é‡æ“ä½œæ ï¼ˆé»˜è®¤éšè—ï¼‰ -->
      <div class="char-batch-bar" id="char-batch-bar" style="display:none">
        <label class="char-batch-select-all">
          <input type="checkbox" id="char-select-all" onchange="toggleSelectAllChars()">
          <span>å…¨é¸</span>
        </label>
        <span class="char-batch-count" id="char-batch-count">å·²é¸ 0 å€‹</span>
        <div class="char-batch-actions">
          <button class="char-batch-btn" onclick="batchDeleteChars()">ğŸ—‘ï¸ åˆªé™¤</button>
          <button class="char-batch-btn" onclick="batchExportChars()">ğŸ“¤ å°å‡º</button>
        </div>
      </div>
      <div class="scroll sys" id="character-list" style="position:relative"></div>
      <div class="input-bar" style="justify-content:space-between;padding:8px 16px">
        <span style="font-size:12px;color:var(--text-tertiary)" id="char-count">0 ä½è§’è‰²</span>
        <button class="action-btn primary" style="padding:8px 16px;font-size:13px" onclick="refreshCharacters()">ğŸ¤– AI æ›´æ–°ç‹€æ…‹</button>
      </div>
    </div>
    <!-- æŒ‡ä»¤ç”Ÿæˆå‘å° -->
    <div class="view" id="view-wizard">
      <div class="nav">
        <div class="nav-back" onclick="exitWizard()">â€¹</div>
        <span class="nav-title" id="wizard-title">æŒ‡ä»¤ç”Ÿæˆå‘å°</span>
        <div class="nav-right">
          <div class="nav-btn" onclick="showWizardHelp()" title="å¹«åŠ©">â“</div>
        </div>
      </div>
      <div class="wizard-progress">
        <div class="wizard-progress-bar"><div class="wizard-progress-fill" id="wizard-progress-fill" style="width:12.5%"></div></div>
        <span class="wizard-progress-text" id="wizard-progress-text">1/8 åŸºç¤è¨­å®š</span>
      </div>
      <div class="wizard-content" id="wizard-content">
        <!-- å‹•æ…‹å…§å®¹ -->
      </div>
      <div class="wizard-footer">
        <button class="wizard-btn secondary" id="wizard-prev" onclick="wizardPrev()" disabled>ä¸Šä¸€æ­¥</button>
        <button class="wizard-btn primary" id="wizard-next" onclick="wizardNext()">ä¸‹ä¸€æ­¥</button>
      </div>
    </div>
    <!-- Prompt åˆ†æé é¢ -->
    <div class="view" id="view-analyze">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">â€¹</div>
        <span class="nav-title">Prompt åˆ†æ</span>
        <div class="nav-right">
          <div class="nav-btn" onclick="showAnalyzeHelp()" title="å¹«åŠ©">â“</div>
        </div>
      </div>
      <div class="wizard-content" id="analyze-content">
        <!-- å‹•æ…‹å…§å®¹ -->
      </div>
    </div>
  </div>
</div>
<!-- æ²‰æµ¸æ¨¡å¼ -->
<div class="immersive" id="immersive">
  <div class="immersive-content" id="immersive-content" onclick="nextImm()"></div>
  <div class="immersive-footer">
    <div class="immersive-progress"><div class="immersive-progress-fill" id="imm-progress"></div></div>
    <span class="immersive-hint">è¼•è§¸ç¹¼çºŒ â–¶</span>
    <div class="immersive-close" onclick="exitImm()">âœ•</div>
  </div>
</div>
<!-- éš±è—çš„æ–‡ä»¶è¼¸å…¥ -->
<input type="file" id="image-upload" accept="image/*" style="display:none" onchange="handleImageUpload(event)">
<input type="file" id="analyze-file" accept=".txt,.md,.docx" style="display:none" onchange="handleAnalyzeFile(event)">
<!-- é®ç½© -->
<div class="overlay" id="overlay" onclick="closeAll()"></div>
<!-- åº•éƒ¨é¢æ¿ -->
<div class="bottom-sheet" id="sheet">
  <div class="bottom-sheet-handle"></div>
  <div class="bottom-sheet-title">æ•…äº‹è¨­ç½®</div>
  <div class="sheet-grid">
    <div class="sheet-item" onclick="showScriptImport()"><div class="sheet-item-icon">ğŸ“œ</div><div class="sheet-item-label">å°å…¥åŠ‡æœ¬</div></div>
    <div class="sheet-item" onclick="goTo('view-characters');closeAll()"><div class="sheet-item-icon">ğŸ‘¥</div><div class="sheet-item-label">è§’è‰²ç‹€æ…‹</div></div>
    <div class="sheet-item" onclick="showRelationshipGraph()"><div class="sheet-item-icon">ğŸ•¸ï¸</div><div class="sheet-item-label">é—œä¿‚åœ–è­œ</div></div>
    <div class="sheet-item" onclick="showSceneManager()"><div class="sheet-item-icon">ğŸ¬</div><div class="sheet-item-label">å ´æ™¯ç®¡ç†</div></div>
    <div class="sheet-item" onclick="showPlayerPanel()"><div class="sheet-item-icon">ğŸ‘¤</div><div class="sheet-item-label">æˆ‘çš„ç‹€æ…‹</div></div>
    <div class="sheet-item" onclick="goTo('view-inventory');closeAll()"><div class="sheet-item-icon">ğŸ’</div><div class="sheet-item-label">èƒŒåŒ…</div></div>
    <div class="sheet-item" onclick="goTo('view-timeline');closeAll()"><div class="sheet-item-icon">ğŸ“…</div><div class="sheet-item-label">æ™‚é–“è»¸</div></div>
    <div class="sheet-item" onclick="goTo('view-foreshadow');closeAll()"><div class="sheet-item-icon">ğŸ“Œ</div><div class="sheet-item-label">ä¼ç­†äº‹ä»¶</div></div>
    <div class="sheet-item" onclick="goTo('view-chapters');closeAll()"><div class="sheet-item-icon">ğŸ“‘</div><div class="sheet-item-label">ç« ç¯€ç®¡ç†</div></div>
    <div class="sheet-item" onclick="goTo('view-bookmarks');closeAll()"><div class="sheet-item-icon">ğŸ”–</div><div class="sheet-item-label">æ›¸ç±¤åˆ—è¡¨</div></div>
    <div class="sheet-item" onclick="goTo('view-saves');closeAll()"><div class="sheet-item-icon">ğŸ’¾</div><div class="sheet-item-label">å­˜æª”ç®¡ç†</div></div>
    <div class="sheet-item" onclick="goTo('view-branches');closeAll()"><div class="sheet-item-icon">ğŸ”€</div><div class="sheet-item-label">åˆ†æ”¯ç®¡ç†</div></div>
    <div class="sheet-item" onclick="goTo('view-lorebook');closeAll()"><div class="sheet-item-icon">ğŸ”®</div><div class="sheet-item-label">Lorebook</div></div>
    <div class="sheet-item" onclick="showStoryAIParams()"><div class="sheet-item-icon">ğŸ›ï¸</div><div class="sheet-item-label">AIåƒæ•¸</div></div>
    <div class="sheet-item" onclick="showMemoryManager()"><div class="sheet-item-icon">ğŸ§ </div><div class="sheet-item-label">è¨˜æ†¶ç®¡ç†</div></div>
    <div class="sheet-item" onclick="showFindReplace()"><div class="sheet-item-icon">ğŸ”</div><div class="sheet-item-label">æŸ¥æ‰¾æ›¿æ›</div></div>
    <div class="sheet-item" onclick="showStats()"><div class="sheet-item-icon">ğŸ“Š</div><div class="sheet-item-label">çµ±è¨ˆé¢æ¿</div></div>
    <div class="sheet-item" onclick="enterImm()"><div class="sheet-item-icon">ğŸ­</div><div class="sheet-item-label">æ²‰æµ¸æ¨¡å¼</div></div>
    <div class="sheet-item" onclick="exportStory()"><div class="sheet-item-icon">ğŸ“¤</div><div class="sheet-item-label">å°å‡ºæ•…äº‹</div></div>
  </div>
</div>
<!-- æ›´å¤šèœå–® -->
<div class="context-menu" id="more-menu">
  <!-- v19: ç¶“ç‡Ÿæ¨¡å¼é¸é … -->
  <div class="context-menu-item sim-only" onclick="showSimResourceModal();hideMenu()" style="display:none">ğŸ® è³‡æºç®¡ç†</div>
  <div class="context-menu-item sim-only" onclick="simNextDay();hideMenu()" style="display:none">â­ï¸ é€²å…¥ä¸‹ä¸€å¤©</div>
  <div class="context-menu-item sim-only" onclick="showSimImportModal();hideMenu()" style="display:none">ğŸ“¥ å°å…¥å­˜æª”</div>
  <div class="context-menu-item sim-only" onclick="showSimExportModal();hideMenu()" style="display:none">ğŸ“¤ å°å‡ºå­˜æª”</div>
  <div class="context-menu-divider sim-only" style="display:none"></div>
  <div class="context-menu-item" onclick="aiConsistencyCheck();hideMenu()">ğŸ” AIä¸€è‡´æ€§æª¢æŸ¥</div>
  <div class="context-menu-item" onclick="aiChapterSummary();hideMenu()">ğŸ“ AIç« ç¯€ç¸½çµ</div>
  <div class="context-menu-item" onclick="aiSuggestions();hideMenu()">ğŸ’¡ AIè¡Œå‹•å»ºè­°</div>
</div>
<!-- æ¶ˆæ¯èœå–® -->
<div class="context-menu" id="msg-menu">
  <div class="context-menu-item" onclick="editMsg()">âœï¸ ç·¨è¼¯</div>
  <div class="context-menu-item" onclick="regenerateMsg()">ğŸ”„ é‡æ–°ç”Ÿæˆ</div>
  <div class="context-menu-item" onclick="markForeshadow()">ğŸ“Œ æ¨™è¨˜ä¼ç­†</div>
  <div class="context-menu-item" onclick="addPlotTag()">ğŸ·ï¸ æ·»åŠ æ¨™ç±¤</div>
  <div class="context-menu-divider"></div>
  <div class="context-menu-item" onclick="rollbackTo()">â†©ï¸ å›æº¯åˆ°æ­¤</div>
  <div class="context-menu-item" onclick="copyMsg()">ğŸ“‹ è¤‡è£½</div>
  <div class="context-menu-item" onclick="addBookmark()">ğŸ”– æ·»åŠ æ›¸ç±¤</div>
  <div class="context-menu-divider"></div>
  <div class="context-menu-item danger" onclick="deleteMsg()">ğŸ—‘ï¸ åˆªé™¤æ¶ˆæ¯</div>
</div>
<!-- è§’è‰²èœå–® -->
<div class="context-menu" id="char-menu">
  <div class="context-menu-item" onclick="refreshCharacters();hideMenu()">ğŸ”„ AI æ›´æ–°ç‹€æ…‹</div>
  <div class="context-menu-divider"></div>
  <div class="context-menu-item" onclick="importCharacterCard();hideMenu()">ğŸ“¥ å°å…¥è§’è‰²å¡ï¼ˆæ–‡ä»¶ï¼‰</div>
  <div class="context-menu-item" onclick="importCharacterFromURL();hideMenu()">ğŸ”— å¾ URL å°å…¥</div>
  <div class="context-menu-item" onclick="exportAllCharacters();hideMenu()">ğŸ“¤ å°å‡ºæ‰€æœ‰è§’è‰²</div>
  <div class="context-menu-divider"></div>
  <div class="context-menu-item danger" onclick="clearAllCharacters();hideMenu()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰è§’è‰²</div>
</div>
<!-- æ•…äº‹èœå–® -->
<div class="context-menu" id="story-menu">
  <div class="context-menu-item" onclick="editStoryCover()">ğŸ–¼ï¸ æ›´æ›å°é¢</div>
  <div class="context-menu-item" onclick="toggleStoryPin()">ğŸ“Œ ç½®é ‚/å–æ¶ˆç½®é ‚</div>
  <div class="context-menu-divider"></div>
  <div class="context-menu-item danger" onclick="deleteStoryFromMenu()">ğŸ—‘ï¸ åˆªé™¤æ•…äº‹</div>
</div>
<!-- å°å…¥åŠ‡æœ¬æ¨¡æ…‹æ¡† -->
<div class="modal script-import-modal" id="script-import-modal">
  <div class="modal-title">ğŸ“œ å°å…¥åŠ‡æœ¬</div>
  <div class="script-import-steps">
    <div class="script-step active" data-step="1">â‘  è¼¸å…¥</div>
    <div class="script-step" data-step="2">â‘¡ åˆ†æ</div>
    <div class="script-step" data-step="3">â‘¢ é è¦½</div>
    <div class="script-step" data-step="4">â‘£ å®Œæˆ</div>
  </div>
  
  <!-- æ­¥éª¤1ï¼šè¾“å…¥å‰§æœ¬ -->
  <div class="script-import-content" id="script-step-1">
    <div class="script-input-tabs">
      <button class="script-tab active" onclick="switchScriptTab('paste')">ğŸ“‹ ç²˜è²¼æ–‡æœ¬</button>
      <button class="script-tab" onclick="switchScriptTab('file')">ğŸ“ ä¸Šå‚³æ–‡ä»¶</button>
    </div>
    <div class="script-input-area" id="script-paste-area">
      <textarea id="script-input-text" placeholder="åœ¨æ­¤ç²˜è²¼ä½ çš„åŠ‡æœ¬è¨­å®šæ›¸...&#10;&#10;æ”¯æŒä»»ä½•é¡å‹çš„æ–‡æ¸¸åŠ‡æœ¬ï¼š&#10;â€¢ å¥³åƒ•å’–å•¡å»³ã€æ ¡åœ’æˆ€æ„›ã€æ‡¸ç–‘æ¨ç†&#10;â€¢ ä¿®ä»™ã€è³½åšæœ‹å…‹ã€å¥‡å¹»å†’éšª&#10;â€¢ ç¶“ç‡Ÿæ¨¡æ“¬ã€ç”Ÿå­˜éŠæˆ²...&#10;&#10;AI æœƒè‡ªå‹•è­˜åˆ¥åŠ‡æœ¬é¡å‹ä¸¦æ™ºèƒ½æ‹†åˆ†"></textarea>
    </div>
    <div class="script-input-area" id="script-file-area" style="display:none">
      <div class="script-file-drop" id="script-file-drop">
        <div class="script-file-icon">ğŸ“</div>
        <div class="script-file-text">é»æ“Šé¸æ“‡æ–‡ä»¶æˆ–æ‹–æ”¾åˆ°æ­¤è™•</div>
        <div class="script-file-hint">æ”¯æŒ .txt / .md / .docx</div>
        <input type="file" id="script-file-input" accept=".txt,.md,.docx" style="display:none">
      </div>
      <div class="script-file-selected" id="script-file-selected" style="display:none">
        <span id="script-file-name"></span>
        <button onclick="clearScriptFile()">âœ•</button>
      </div>
    </div>
    <div class="script-token-estimate">
      ğŸ“Š é ä¼°ï¼š<span id="script-token-count">0</span> tokens
    </div>
  </div>
  
  <!-- æ­¥éª¤2ï¼šAIåˆ†æä¸­ -->
  <div class="script-import-content" id="script-step-2" style="display:none">
    <div class="script-analyzing">
      <div class="script-analyzing-icon">ğŸ”„</div>
      <div class="script-analyzing-text">æ­£åœ¨åˆ†æåŠ‡æœ¬...</div>
      <div class="script-progress-bar">
        <div class="script-progress-fill" id="script-progress"></div>
      </div>
      <div class="script-progress-percent" id="script-progress-text">0%</div>
      <div class="script-analyzing-steps" id="script-analyzing-steps">
        <div class="script-analyze-step" id="analyze-step-1">â—‹ è­˜åˆ¥åŠ‡æœ¬é¡å‹</div>
        <div class="script-analyze-step" id="analyze-step-2">â—‹ æå–æ ¸å¿ƒè¦å‰‡</div>
        <div class="script-analyze-step" id="analyze-step-3">â—‹ è­˜åˆ¥è¨­å®šå…§å®¹</div>
        <div class="script-analyze-step" id="analyze-step-4">â—‹ ç”Ÿæˆè§¸ç™¼è©</div>
        <div class="script-analyze-step" id="analyze-step-5">â—‹ æå–è§’è‰²è¨­å®š</div>
      </div>
    </div>
  </div>
  
  <!-- æ­¥éª¤3ï¼šé¢„è§ˆä¸è°ƒæ•´ -->
  <div class="script-import-content" id="script-step-3" style="display:none">
    <div class="script-preview-tabs">
      <button class="script-preview-tab active" onclick="switchPreviewTab('instruction')">ğŸ“‹ æŒ‡ä»¤</button>
      <button class="script-preview-tab" onclick="switchPreviewTab('lorebook')">ğŸ“š Lorebook</button>
      <button class="script-preview-tab" onclick="switchPreviewTab('worldinfo')">ğŸŒ ä¸–ç•Œè§€</button>
      <button class="script-preview-tab" onclick="switchPreviewTab('characters')">ğŸ‘¥ è§’è‰²</button>
    </div>
    
    <div class="script-preview-content" id="preview-instruction">
      <div class="script-preview-header">
        <span>ğŸ“‹ æŒ‡ä»¤ï¼ˆæ ¸å¿ƒè¦å‰‡ï¼‰</span>
        <span class="script-token-badge" id="instruction-tokens">0 tk</span>
      </div>
      <div class="script-preview-box" id="instruction-preview"></div>
      <button class="script-edit-btn" onclick="editScriptInstruction()">âœï¸ ç·¨è¼¯</button>
    </div>
    
    <div class="script-preview-content" id="preview-lorebook" style="display:none">
      <div class="script-preview-header">
        <span>ğŸ“š Lorebook æ¢ç›®</span>
        <span class="script-token-badge" id="lorebook-tokens">0 tk</span>
      </div>
      <div class="script-category-list" id="lorebook-categories"></div>
      <div class="script-preview-actions">
        <button onclick="addScriptLorebookEntry()">+ æ‰‹å‹•æ·»åŠ </button>
        <button onclick="mergeSelectedEntries()">åˆä½µé¸ä¸­</button>
      </div>
    </div>
    
    <div class="script-preview-content" id="preview-worldinfo" style="display:none">
      <div class="script-preview-header">
        <span>ğŸŒ ä¸–ç•Œè§€è³‡æ–™</span>
        <span class="script-token-badge" id="worldinfo-tokens">0 tk</span>
      </div>
      <div class="script-entry-list" id="worldinfo-list"></div>
    </div>
    
    <div class="script-preview-content" id="preview-characters" style="display:none">
      <div class="script-preview-header">
        <span>ğŸ‘¥ è§’è‰²</span>
        <span class="script-token-badge" id="characters-tokens">0 tk</span>
      </div>
      <div class="script-entry-list" id="characters-list"></div>
    </div>
  </div>
  
  <!-- æ­¥éª¤4ï¼šå®Œæˆ -->
  <div class="script-import-content" id="script-step-4" style="display:none">
    <div class="script-complete">
      <div class="script-complete-icon">âœ…</div>
      <div class="script-complete-title">å°å…¥æˆåŠŸï¼</div>
      <div class="script-complete-stats" id="script-complete-stats"></div>
      <div class="script-optimization-box">
        <div class="script-optimization-title">ğŸ“Š å„ªåŒ–æ•ˆæœ</div>
        <div class="script-optimization-content" id="script-optimization"></div>
      </div>
      <div class="script-complete-tip">ğŸ’¡ æç¤ºï¼šä½ å¯ä»¥åœ¨ã€Œæ•…äº‹è¨­ç½®ã€ä¸­éš¨æ™‚ç·¨è¼¯é€™äº›å…§å®¹</div>
    </div>
  </div>
  
  <div class="modal-actions script-import-actions">
    <button class="modal-btn cancel" onclick="closeScriptImport()">å–æ¶ˆ</button>
    <button class="modal-btn" id="script-prev-btn" onclick="scriptPrevStep()" style="display:none">â† ä¸Šä¸€æ­¥</button>
    <button class="modal-btn confirm" id="script-next-btn" onclick="scriptNextStep()">ä¸‹ä¸€æ­¥ â†’</button>
  </div>
</div>

<!-- ç·¨è¼¯Lorebookæ¢ç›®æ¨¡æ…‹æ¡† -->
<div class="modal" id="script-entry-edit-modal">
  <div class="modal-title">âœï¸ ç·¨è¼¯æ¢ç›®</div>
  <div class="modal-content">
    <div class="form-group">
      <label>æ¢ç›®åç¨±</label>
      <input type="text" id="script-entry-name" class="modal-input">
    </div>
    <div class="form-group">
      <label>åˆ†é¡</label>
      <input type="text" id="script-entry-category" class="modal-input">
    </div>
    <div class="form-group">
      <label>è§¸ç™¼è©ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰</label>
      <input type="text" id="script-entry-keys" class="modal-input">
    </div>
    <div class="form-group">
      <label>å…§å®¹ <span class="script-entry-tokens" id="script-entry-tokens">0 tk</span></label>
      <textarea id="script-entry-content" class="modal-textarea" rows="8"></textarea>
    </div>
    <div class="script-entry-reasoning" id="script-entry-reasoning"></div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('script-entry-edit-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="saveScriptEntry()">ä¿å­˜</button>
  </div>
</div>

<!-- ç¢ºèªæ¡† -->
<div class="modal" id="confirm-modal">
  <div class="modal-title" id="confirm-title">ç¢ºèª</div>
  <div class="modal-content" id="confirm-content">ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ</div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="cancelConfirm()">å–æ¶ˆ</button>
    <button class="modal-btn confirm" id="confirm-btn" onclick="confirmAction()">ç¢ºå®š</button>
  </div>
</div>
<!-- è¼¸å…¥æ¡† -->
<div class="modal" id="input-modal">
  <div class="modal-title" id="input-title">è¼¸å…¥</div>
  <div class="modal-content" id="input-desc"></div>
  <input type="text" class="modal-input" id="modal-input" placeholder="">
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('input-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="confirmInput()">ç¢ºå®š</button>
  </div>
</div>
<!-- æ–°å»ºæ•…äº‹ -->
<div class="modal" id="new-story-modal" style="max-width:420px">
  <div class="modal-title">æ–°å»ºæ•…äº‹</div>
  <div class="form-group"><label class="form-label">æ•…äº‹æ¨™é¡Œ</label><input type="text" class="form-input" id="new-title" placeholder="è¼¸å…¥æ•…äº‹æ¨™é¡Œ"></div>
  <div class="form-group"><label class="form-label">ç°¡ä»‹ï¼ˆå¯é¸ï¼‰</label><textarea class="form-textarea" id="new-desc" placeholder="ç°¡å–®æè¿°é€™å€‹æ•…äº‹..."></textarea></div>
  <div class="form-group">
    <label class="form-label">æ•…äº‹æ¨¡å¼</label>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <div class="mode-card active" id="mode-normal" onclick="selectStoryMode('normal')">
        <div style="font-size:24px;margin-bottom:4px">ğŸ“–</div>
        <div style="font-weight:600;font-size:13px">æ™®é€šæ¨¡å¼</div>
        <div style="font-size:11px;color:var(--text-tertiary)">è§’è‰²ç‹€æ…‹è¿½è¹¤</div>
      </div>
      <div class="mode-card" id="mode-simulation" onclick="selectStoryMode('simulation')">
        <div style="font-size:24px;margin-bottom:4px">ğŸ®</div>
        <div style="font-weight:600;font-size:13px">ç¶“ç‡Ÿæ¨¡å¼</div>
        <div style="font-size:11px;color:var(--text-tertiary)">è³‡æºé¢æ¿+å­˜æª”</div>
      </div>
    </div>
  </div>
  <div id="sim-mode-options" style="display:none">
    <div class="form-group">
      <label class="form-label">åˆå§‹è³‡æºï¼ˆå¯ç¨å¾Œç·¨è¼¯ï¼‰</label>
      <div id="new-sim-resources" style="display:flex;flex-direction:column;gap:6px">
        <div style="display:flex;gap:6px;align-items:center">
          <input type="text" class="form-input" style="width:60px" placeholder="ğŸ’°" maxlength="2" value="ğŸ’°">
          <input type="text" class="form-input" style="flex:1" placeholder="åç¨±" value="é‡‘å¹£">
          <input type="number" class="form-input" style="width:80px" placeholder="æ•¸å€¼" value="10000">
          <button onclick="removeSimResource(this)" style="background:none;border:none;color:var(--error);cursor:pointer">âœ•</button>
        </div>
      </div>
      <button onclick="addSimResource()" style="margin-top:8px;background:var(--bg-tertiary);border:none;padding:6px 12px;border-radius:6px;color:var(--text-secondary);cursor:pointer;font-size:12px">â• æ·»åŠ è³‡æº</button>
    </div>
  </div>
  <div class="form-group"><label class="form-label">æ¨™ç±¤ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰</label><input type="text" class="form-input" id="new-tags" placeholder="å®®é¬¥ å¤é¢¨ æˆ€æ„›"></div>
  <div class="form-group"><label class="form-label">ç¶å®šæŒ‡ä»¤</label><select class="form-select" id="new-inst"><option value="">ä¸ç¶å®šæŒ‡ä»¤</option></select></div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('new-story-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="saveNewStory()">å‰µå»º</button>
  </div>
</div>
<!-- APIè¨­ç½® -->
<div class="modal" id="api-modal" style="max-width:400px">
  <div class="modal-title">API è¨­ç½®</div>
  <div class="form-group"><label class="form-label">é è¨­åç¨±</label><input type="text" class="form-input" id="api-name" placeholder="ä¾‹å¦‚: Claude API"></div>
  <div class="form-group"><label class="form-label">API é¡å‹</label><select class="form-select" id="api-type" onchange="updateApiFields()"><option value="anthropic">Anthropic (Claude)</option><option value="openai">OpenAI (GPT)</option><option value="custom">è‡ªå®šç¾© API</option></select></div>
  <div class="form-group"><label class="form-label">API Key</label><input type="password" class="form-input" id="api-key" placeholder="sk-..."></div>
  <div class="form-group"><label class="form-label">æ¨¡å‹</label><input type="text" class="form-input" id="api-model" list="model-list" placeholder="é¸æ“‡æˆ–è¼¸å…¥æ¨¡å‹åç¨±"><datalist id="model-list"><option value="claude-sonnet-4-20250514">Claude Sonnet 4</option><option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option><option value="claude-3-opus-20240229">Claude 3 Opus</option></datalist></div>
  <div class="form-group hidden" id="api-url-group"><label class="form-label">API URL</label><input type="text" class="form-input" id="api-url" placeholder="https://api.example.com"><div style="margin-top:6px"><label style="font-size:12px;color:var(--text-secondary);display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="api-url-autocomplete" checked> è‡ªå‹•è£œå…¨ /v1/chat/completions</label></div></div>
  <div class="form-group"><button type="button" class="action-btn secondary" style="width:100%" onclick="testApi()">ğŸ”— æ¸¬è©¦é€£æ¥</button><div id="api-test-result" style="margin-top:8px;font-size:12px;display:none"></div></div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('api-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="saveApi()">ä¿å­˜</button>
  </div>
</div>
<!-- v19: ç¶“ç‡Ÿæ¨¡å¼ - è³‡æºç®¡ç† Modal -->
<div class="modal" id="sim-resource-modal" style="max-width:min(95%,420px)">
  <div class="modal-title">ğŸ® è³‡æºç®¡ç†</div>
  <div style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">
    è‡ªå®šç¾©è¿½è¹¤çš„è³‡æºæ•¸å€¼ï¼Œæœƒé¡¯ç¤ºåœ¨é ‚éƒ¨é¢æ¿
  </div>
  <div class="form-group">
    <label class="form-label">ç•¶å‰å¤©æ•¸/å›åˆ</label>
    <div style="display:flex;gap:8px;align-items:center">
      <input type="number" class="form-input" id="sim-current-day" min="1" value="1" style="width:100px">
      <button onclick="simDayMinus()" style="background:var(--bg-tertiary);border:none;padding:8px 12px;border-radius:6px;cursor:pointer">âˆ’</button>
      <button onclick="simDayPlus()" style="background:var(--bg-tertiary);border:none;padding:8px 12px;border-radius:6px;cursor:pointer">+</button>
    </div>
  </div>
  <div class="form-group">
    <label class="form-label">è³‡æºåˆ—è¡¨</label>
    <div id="sim-resource-list" style="display:flex;flex-direction:column;gap:8px;max-height:250px;overflow-y:auto">
      <!-- å‹•æ…‹æ¸²æŸ“ -->
    </div>
    <button onclick="addSimResourceInModal()" style="margin-top:10px;background:var(--bg-tertiary);border:none;padding:8px 14px;border-radius:6px;color:var(--text-secondary);cursor:pointer;font-size:13px;width:100%">â• æ·»åŠ æ–°è³‡æº</button>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('sim-resource-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="saveSimResources()">ä¿å­˜</button>
  </div>
</div>
<!-- v19: ç¶“ç‡Ÿæ¨¡å¼ - å­˜æª”å°å…¥ Modal -->
<div class="modal" id="sim-import-modal" style="max-width:min(95%,500px)">
  <div class="modal-title">ğŸ“¥ å°å…¥å­˜æª”</div>
  <div style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">
    è²¼å…¥æ–‡éŠ prompt ç”Ÿæˆçš„å­˜æª”å…§å®¹ï¼Œæœƒè‡ªå‹•è§£æè³‡æºæ•¸å€¼
  </div>
  <div class="form-group">
    <label class="form-label">å­˜æª”å…§å®¹</label>
    <textarea class="form-input" id="sim-import-content" style="min-height:200px;font-family:monospace;font-size:12px" placeholder="è²¼å…¥å­˜æª”å…§å®¹..."></textarea>
  </div>
  <div class="form-group">
    <label class="form-label">è§£æè¦å‰‡ï¼ˆæ­£å‰‡è¡¨é”å¼ï¼Œå¯é¸ï¼‰</label>
    <input type="text" class="form-input" id="sim-import-regex" placeholder="ä¾‹å¦‚ï¼šğŸ’° ç¾é‡‘ï¼š([\\d,]+)å…ƒ">
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">ç•™ç©ºå‰‡ä½¿ç”¨é»˜èªè¦å‰‡è§£æå¸¸è¦‹æ ¼å¼</div>
  </div>
  <div id="sim-import-preview" style="display:none;background:var(--bg-tertiary);padding:12px;border-radius:8px;margin-bottom:12px">
    <div style="font-size:12px;font-weight:600;margin-bottom:8px">ğŸ“Š è§£æé è¦½</div>
    <div id="sim-import-preview-content"></div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn" style="background:var(--bg-tertiary);color:var(--text-secondary)" onclick="parseSimImport()">ğŸ” è§£æé è¦½</button>
    <button class="modal-btn cancel" onclick="closeModal('sim-import-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="applySimImport()">å°å…¥</button>
  </div>
</div>
<!-- v19: ç¶“ç‡Ÿæ¨¡å¼ - å­˜æª”å°å‡º Modal -->
<div class="modal" id="sim-export-modal" style="max-width:min(95%,500px)">
  <div class="modal-title">ğŸ“¤ å°å‡ºå­˜æª”</div>
  <div style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">
    ç”Ÿæˆç•¶å‰ç‹€æ…‹çš„å­˜æª”ï¼Œå¯è²¼åˆ°æ–°å°è©±ç¹¼çºŒéŠæˆ²
  </div>
  <div class="form-group">
    <label class="form-label">å­˜æª”æ ¼å¼</label>
    <select class="form-select" id="sim-export-format" onchange="generateSimExport()">
      <option value="simple">ç°¡æ½”æ ¼å¼</option>
      <option value="detailed">è©³ç´°æ ¼å¼</option>
      <option value="custom">è‡ªå®šç¾©æ¨¡æ¿</option>
    </select>
  </div>
  <div class="form-group" id="sim-export-template-group" style="display:none">
    <label class="form-label">è‡ªå®šç¾©æ¨¡æ¿</label>
    <textarea class="form-input" id="sim-export-template" style="min-height:100px;font-family:monospace;font-size:12px" placeholder="ä½¿ç”¨ {day} {resources} {summary} ç­‰è®Šé‡"></textarea>
  </div>
  <div class="form-group">
    <label class="form-label">å­˜æª”å…§å®¹</label>
    <textarea class="form-input" id="sim-export-content" style="min-height:200px;font-family:monospace;font-size:12px" readonly></textarea>
  </div>
  <div class="modal-actions">
    <button class="modal-btn" style="background:var(--bg-tertiary);color:var(--text-secondary)" onclick="copySimExport()">ğŸ“‹ è¤‡è£½</button>
    <button class="modal-btn confirm" onclick="closeModal('sim-export-modal')">å®Œæˆ</button>
  </div>
</div>
<!-- Toast -->
<div class="toast" id="toast"><span id="toast-text"></span></div>
<!-- Loading -->
<div class="loading" id="loading"><div class="loading-spinner"></div><div class="loading-text" id="loading-text">è™•ç†ä¸­...</div></div>
<!-- ä¸Šä¸‹æ–‡è¨­ç½® Modal -->
<div class="modal" id="context-modal">
  <div class="modal-title">ä¸Šä¸‹æ–‡è¨­ç½®</div>
  <div class="form-group">
    <label class="form-label">ä¸Šä¸‹æ–‡æ¶ˆæ¯æ•¸é‡</label>
    <p style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">ç™¼é€çµ¦ AI çš„æ­·å²æ¶ˆæ¯æ•¸é‡ï¼Œè¶Šå¤šè¶Šèƒ½ç†è§£ä¸Šä¸‹æ–‡ï¼Œä½†æœƒæ¶ˆè€—æ›´å¤š Token</p>
    <input type="number" class="form-input" id="context-count" min="1" max="500" placeholder="è¼¸å…¥æ•¸é‡ï¼Œä¾‹å¦‚ï¼š20">
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">å»ºè­°ç¯„åœï¼š10-50ï¼Œæœ€å¤§æ”¯æŒ 500</div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('context-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="saveContextSettings()">ä¿å­˜</button>
  </div>
</div>
<!-- æœ€å¤§ Token Modal -->
<div class="modal" id="max-tokens-modal">
  <div class="modal-title">æœ€å¤§ç”Ÿæˆé•·åº¦</div>
  <div class="form-group">
    <label class="form-label">Max Tokens</label>
    <p style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">AI å–®æ¬¡å›å¾©çš„æœ€å¤§é•·åº¦ï¼Œè¶Šå¤§å›å¾©è¶Šé•·ä½†ä¹Ÿè¶Šæ…¢</p>
    <input type="number" class="form-input" id="max-tokens-input" min="100" placeholder="è¼¸å…¥æ•¸é‡ï¼Œä¾‹å¦‚ï¼š4096">
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">å»ºè­°ç¯„åœï¼š1024-8192ï¼Œå¯æ ¹æ“šæ¨¡å‹æ”¯æŒè‡ªè¡Œèª¿æ•´</div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('max-tokens-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="saveMaxTokensSettings()">ä¿å­˜</button>
  </div>
</div>
<!-- æ‰“å­—æ©Ÿæ•ˆæœ Modal -->
<div class="modal" id="typing-modal">
  <div class="modal-title">æ‰“å­—æ©Ÿæ•ˆæœ</div>
  <div class="form-group">
    <label class="form-label">æ‰“å­—é€Ÿåº¦</label>
    <p style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">æ¯å€‹å­—é¡¯ç¤ºçš„é–“éš”æ™‚é–“ï¼Œ0 ç‚ºé—œé–‰æ‰“å­—æ©Ÿæ•ˆæœ</p>
    <select class="form-select" id="typing-speed-select">
      <option value="0">é—œé–‰</option>
      <option value="10">10msï¼ˆå¿«é€Ÿï¼‰</option>
      <option value="20">20ms</option>
      <option value="30">30msï¼ˆæ¨è–¦ï¼‰</option>
      <option value="50">50ms</option>
      <option value="80">80msï¼ˆæ…¢é€Ÿï¼‰</option>
    </select>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('typing-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="saveTypingSpeedSettings()">ä¿å­˜</button>
  </div>
</div>
<!-- æµå¼éŸ¿æ‡‰è¨­ç½® Modal -->
<div class="modal" id="streaming-modal">
  <div class="modal-title">âš¡ æµå¼éŸ¿æ‡‰</div>
  <div class="form-group">
    <label class="form-label">å•Ÿç”¨æµå¼éŸ¿æ‡‰</label>
    <p style="font-size:12px;color:var(--text-tertiary);margin-bottom:12px">AI é‚Šç”Ÿæˆé‚Šé¡¯ç¤ºï¼Œå¹¾ç§’é˜å°±èƒ½é–‹å§‹é–±è®€ï¼Œä¸¦å¯éš¨æ™‚åœæ­¢ç”Ÿæˆ</p>
    <div style="display:flex;align-items:center;gap:12px">
      <div class="toggle active" id="toggle-streaming" onclick="toggleStreamingEnabled()"></div>
      <span id="toggle-streaming-text" style="font-size:13px;color:var(--text-secondary)">å·²é–‹å•Ÿ</span>
    </div>
  </div>
  <div id="streaming-advanced-options">
    <div class="form-group">
      <label class="form-label">æ‰“å­—æ©Ÿå»¶é²</label>
      <p style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">æ”¶åˆ°æ–‡å­—å¾Œçš„é¡¯ç¤ºå»¶é²ï¼Œè®“æµå¼é¡¯ç¤ºæ›´å¹³æ»‘</p>
      <select class="form-select" id="streaming-chunk-delay-select">
        <option value="0">ç„¡å»¶é²ï¼ˆç«‹å³é¡¯ç¤ºï¼‰</option>
        <option value="10">10msï¼ˆæ¥µå¿«ï¼‰</option>
        <option value="20">20msï¼ˆæ¨è–¦ï¼‰</option>
        <option value="30">30ms</option>
        <option value="50">50msï¼ˆå¹³æ»‘ï¼‰</option>
      </select>
    </div>
    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;font-size:12px;color:var(--text-secondary);margin-top:12px">
      <div style="font-weight:600;margin-bottom:6px">ğŸ’¡ æç¤º</div>
      <div style="line-height:1.6">
        â€¢ æµå¼éŸ¿æ‡‰å¯å¤§å¹…æ¸›å°‘ç­‰å¾…æ™‚é–“<br>
        â€¢ éƒ¨åˆ† API å¯èƒ½ä¸æ”¯æŒæµå¼ï¼Œæœƒè‡ªå‹•é™ç´š<br>
        â€¢ åœæ­¢ç”Ÿæˆæ™‚æœƒè©¢å•æ˜¯å¦ä¿å­˜å·²ç”Ÿæˆå…§å®¹
      </div>
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('streaming-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="saveStreamingSettings()">ä¿å­˜</button>
  </div>
</div>
<!-- å­—é«”å¤§å° Modal -->
<div class="modal" id="font-size-modal">
  <div class="modal-title">ğŸ“ å­—é«”å¤§å°</div>
  <div class="form-group">
    <label class="form-label">é¸æ“‡å­—é«”å¤§å°</label>
    <p style="font-size:12px;color:var(--text-tertiary);margin-bottom:12px">èª¿æ•´æ•…äº‹å…§å®¹çš„å­—é«”å¤§å°ï¼Œæ‰¾åˆ°æœ€èˆ’é©çš„é–±è®€é«”é©—</p>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
      <button class="font-option" data-size="14" onclick="selectFontSize(14)">
        <span style="font-size:14px">å°</span>
        <span style="font-size:11px;color:var(--text-tertiary)">14px</span>
      </button>
      <button class="font-option" data-size="16" onclick="selectFontSize(16)">
        <span style="font-size:16px">ä¸­</span>
        <span style="font-size:11px;color:var(--text-tertiary)">16px</span>
      </button>
      <button class="font-option" data-size="18" onclick="selectFontSize(18)">
        <span style="font-size:18px">å¤§</span>
        <span style="font-size:11px;color:var(--text-tertiary)">18px</span>
      </button>
      <button class="font-option" data-size="20" onclick="selectFontSize(20)">
        <span style="font-size:20px">ç‰¹å¤§</span>
        <span style="font-size:11px;color:var(--text-tertiary)">20px</span>
      </button>
    </div>
    <div style="margin-top:16px;padding:16px;background:var(--bg-tertiary);border-radius:8px">
      <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">é è¦½æ•ˆæœ</div>
      <div id="font-preview" style="font-family:'Noto Serif SC',Georgia,serif;line-height:1.8">
        é™›ä¸‹ç·©æ­¥è¡Œè‡³å¾¡èŠ±åœ’ï¼Œåªè¦‹æ¡ƒèŠ±ç¼ç¼ï¼Œå«£ç„¶ç¶»æ”¾æ–¼æé ­ã€‚
      </div>
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('font-size-modal')">é—œé–‰</button>
  </div>
</div>
<!-- è¡Œé–“è· Modal -->
<div class="modal" id="line-height-modal">
  <div class="modal-title">ğŸ“ è¡Œé–“è·</div>
  <div class="form-group">
    <label class="form-label">é¸æ“‡è¡Œé–“è·</label>
    <p style="font-size:12px;color:var(--text-tertiary);margin-bottom:12px">èª¿æ•´è¡Œèˆ‡è¡Œä¹‹é–“çš„è·é›¢ï¼Œå½±éŸ¿é–±è®€ç¯€å¥</p>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
      <button class="font-option" data-lh="1.5" onclick="selectLineHeight(1.5)">
        <span>ç·Šæ¹Š</span>
        <span style="font-size:11px;color:var(--text-tertiary)">1.5x</span>
      </button>
      <button class="font-option" data-lh="1.8" onclick="selectLineHeight(1.8)">
        <span>æ¨™æº–</span>
        <span style="font-size:11px;color:var(--text-tertiary)">1.8x</span>
      </button>
      <button class="font-option" data-lh="2.0" onclick="selectLineHeight(2.0)">
        <span>å¯¬é¬†</span>
        <span style="font-size:11px;color:var(--text-tertiary)">2.0x</span>
      </button>
      <button class="font-option" data-lh="2.2" onclick="selectLineHeight(2.2)">
        <span>ç‰¹å¯¬</span>
        <span style="font-size:11px;color:var(--text-tertiary)">2.2x</span>
      </button>
    </div>
    <div style="margin-top:16px;padding:16px;background:var(--bg-tertiary);border-radius:8px">
      <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">é è¦½æ•ˆæœ</div>
      <div id="line-height-preview" style="font-family:'Noto Serif SC',Georgia,serif;font-size:16px">
        é™›ä¸‹ç·©æ­¥è¡Œè‡³å¾¡èŠ±åœ’ï¼Œåªè¦‹æ¡ƒèŠ±ç¼ç¼ï¼Œå«£ç„¶ç¶»æ”¾æ–¼æé ­ã€‚èŠ±ç“£éš¨é¢¨é£„è½ï¼Œå¦‚ç²‰è‰²çš„é›ªï¼Œè¼•æŸ”åœ°è½åœ¨ä½ çš„è‚©é ­ã€‚
      </div>
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('line-height-modal')">é—œé–‰</button>
  </div>
</div>
<!-- Lorebook ç·¨è¼¯ Modal -->
<div class="modal" id="lorebook-modal" style="max-width:min(95%,450px);max-height:85vh;overflow-y:auto">
  <div class="modal-title">ğŸ”® ç·¨è¼¯ Lorebook æ¢ç›®</div>
  <input type="hidden" id="lorebook-id">
  <div class="form-group">
    <label class="form-label">åç¨±</label>
    <input type="text" class="form-input" id="lorebook-name" placeholder="ä¾‹å¦‚ï¼šå¤œå¯’ - åŸºæœ¬äººè¨­">
  </div>
  <div class="form-group">
    <label class="form-label">è§¸ç™¼é—œéµè©ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</label>
    <input type="text" class="form-input" id="lorebook-keywords" placeholder="ä¾‹å¦‚ï¼šå¤œå¯’, çš‡å¤«, é•·æ¨‚å®®ä¸»äºº">
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">ç•¶å°è©±ä¸­å‡ºç¾é€™äº›è©æ™‚æœƒè§¸ç™¼æ³¨å…¥</div>
  </div>
  <div class="form-group">
    <label class="form-label">å…§å®¹</label>
    <textarea class="form-input" id="lorebook-content" style="min-height:120px" placeholder="è¦æ³¨å…¥çš„è¨­å®šå…§å®¹..."></textarea>
  </div>
  <div class="form-group">
    <div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer" onclick="toggleLorebookAdvanced()">
      <label class="form-label" style="margin:0">âš™ï¸ é€²éšè¨­ç½®</label>
      <span id="lorebook-advanced-toggle" style="color:var(--text-tertiary)">â–¼</span>
    </div>
    <div id="lorebook-advanced" style="display:none;margin-top:12px">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
        <div>
          <label style="font-size:12px;color:var(--text-secondary)">æª¢æ¸¬æ·±åº¦</label>
          <select class="form-select" id="lorebook-depth" style="margin-top:4px">
            <option value="1">æœ€è¿‘ 1 æ¢æ¶ˆæ¯</option>
            <option value="2" selected>æœ€è¿‘ 2 æ¢æ¶ˆæ¯</option>
            <option value="3">æœ€è¿‘ 3 æ¢æ¶ˆæ¯</option>
            <option value="5">æœ€è¿‘ 5 æ¢æ¶ˆæ¯</option>
          </select>
        </div>
        <div>
          <label style="font-size:12px;color:var(--text-secondary)">å„ªå…ˆç´š</label>
          <input type="number" class="form-input" id="lorebook-priority" value="100" style="margin-top:4px">
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
        <div>
          <label style="font-size:12px;color:var(--text-secondary)">å†·å»ï¼ˆæ¶ˆæ¯æ•¸ï¼‰</label>
          <input type="number" class="form-input" id="lorebook-cooldown" value="0" min="0" style="margin-top:4px">
        </div>
        <div>
          <label style="font-size:12px;color:var(--text-secondary)">æœ€å¤§è§¸ç™¼æ¬¡æ•¸</label>
          <input type="number" class="form-input" id="lorebook-max-triggers" value="0" min="0" style="margin-top:4px" placeholder="0=ç„¡é™">
        </div>
      </div>
      <label style="font-size:13px;color:var(--text-secondary);display:flex;align-items:center;gap:6px;cursor:pointer">
        <input type="checkbox" id="lorebook-one-time"> ä¸€æ¬¡æ€§è§¸ç™¼ï¼ˆè§¸ç™¼å¾Œè‡ªå‹•ç¦ç”¨ï¼‰
      </label>
    </div>
  </div>
  <div class="form-group">
    <div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer" onclick="toggleLorebookConditions()">
      <label class="form-label" style="margin:0">ğŸ” è§¸ç™¼æ¢ä»¶ï¼ˆå¯é¸ï¼‰</label>
      <span id="lorebook-conditions-toggle" style="color:var(--text-tertiary)">â–¼</span>
    </div>
    <div id="lorebook-conditions" style="display:none;margin-top:12px">
      <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">é™¤äº†é—œéµè©åŒ¹é…ï¼Œé‚„éœ€æ»¿è¶³ä»¥ä¸‹æ¢ä»¶æ‰æœƒè§¸ç™¼</div>
      <div id="lorebook-condition-list"></div>
      <button class="action-btn secondary" style="width:100%;margin-top:8px" onclick="addLorebookCondition()">â• æ·»åŠ æ¢ä»¶</button>
      <div style="margin-top:12px">
        <label style="font-size:12px;color:var(--text-secondary)">æ¢ä»¶é‚è¼¯</label>
        <div style="display:flex;gap:16px;margin-top:6px">
          <label style="font-size:13px;display:flex;align-items:center;gap:4px;cursor:pointer">
            <input type="radio" name="lorebook-logic" value="AND" checked> å…¨éƒ¨æ»¿è¶³ (AND)
          </label>
          <label style="font-size:13px;display:flex;align-items:center;gap:4px;cursor:pointer">
            <input type="radio" name="lorebook-logic" value="OR"> ä»»ä¸€æ»¿è¶³ (OR)
          </label>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('lorebook-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="saveLorebook()">ä¿å­˜</button>
  </div>
</div>
<!-- ç·¨è¼¯æŒ‡ä»¤ Modal -->
<div class="modal" id="edit-inst-modal" style="max-width:500px">
  <div class="modal-title">âœï¸ ç·¨è¼¯æŒ‡ä»¤</div>
  <div class="form-group">
    <label class="form-label">æŒ‡ä»¤åç¨±</label>
    <input type="text" class="form-input" id="edit-inst-name" placeholder="è¼¸å…¥æŒ‡ä»¤åç¨±">
  </div>
  <div class="form-group">
    <label class="form-label">æŒ‡ä»¤å…§å®¹</label>
    <textarea class="form-input" id="edit-inst-content" style="min-height:300px;resize:vertical;font-family:monospace;font-size:13px" placeholder="è¼¸å…¥æŒ‡ä»¤å…§å®¹..."></textarea>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('edit-inst-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="saveEditInst()">ä¿å­˜</button>
  </div>
</div>
<!-- ç·¨è¼¯æ¶ˆæ¯ Modal -->
<div class="modal" id="edit-msg-modal" style="max-width:min(90%,400px)">
  <div class="modal-title">ç·¨è¼¯æ¶ˆæ¯</div>
  <div class="form-group">
    <textarea class="form-input" id="edit-msg-content" style="min-height:200px;resize:vertical" placeholder="ç·¨è¼¯æ¶ˆæ¯å…§å®¹..."></textarea>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('edit-msg-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="saveEditMsg()">ä¿å­˜</button>
  </div>
</div>
<!-- é‡æ–°ç”Ÿæˆ Modal -->
<div class="modal" id="regen-modal">
  <div class="modal-title">ğŸ”„ é‡æ–°ç”Ÿæˆ</div>
  <div class="form-group">
    <label class="form-label">è£œå……èªªæ˜ï¼ˆå¯é¸ï¼‰</label>
    <textarea class="form-input" id="regen-note" style="min-height:80px" placeholder="ä¾‹å¦‚ï¼šæå¯«æ›´ç´°è†©ä¸€äº›ã€èªæ°£æ›´å¼·ç¡¬..."></textarea>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('regen-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="doRegenerate()">é‡æ–°ç”Ÿæˆ</button>
  </div>
</div>
<!-- è¨˜æ†¶ç®¡ç† Modal -->
<div class="modal" id="memory-modal" style="max-width:min(95%,480px)">
  <div class="modal-title">ğŸ§  è¨˜æ†¶ç®¡ç†</div>
  <div style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">
    ç®¡ç†æ•…äº‹è¨˜æ†¶ï¼Œå£“ç¸®èˆŠæ¶ˆæ¯æˆ–ç”Ÿæˆæ»¾å‹•æ‘˜è¦ï¼Œä¿æŒ AI å°åŠ‡æƒ…çš„é€£è²«ç†è§£ã€‚
  </div>
  <div class="form-group">
    <label class="form-label">ğŸ“Š ç•¶å‰ç‹€æ…‹</label>
    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;font-size:13px">
      <div style="display:flex;justify-content:space-between;margin-bottom:4px">
        <span>ç¸½æ¶ˆæ¯æ•¸ï¼š<strong id="memory-msg-count">0</strong> æ¢</span>
        <span id="memory-token-estimate" style="color:var(--text-tertiary)"></span>
      </div>
      <div>å·²å£“ç¸®ï¼š<span id="memory-compressed">0</span> æ¢</div>
      <div>æ‘˜è¦æ•¸ï¼š<span id="memory-summary-count">0</span> æ¢ 
        <span style="color:var(--primary);cursor:pointer;margin-left:8px" onclick="viewSummaries()">ğŸ“– æŸ¥çœ‹</span>
        <span style="color:var(--primary);cursor:pointer;margin-left:8px" onclick="searchSummaries()">ğŸ” æœç´¢</span>
      </div>
      <div>æ»¾å‹•æ‘˜è¦ï¼š<span id="memory-rolling-count">0</span> æ¢ <span style="color:var(--text-tertiary);font-size:11px">(ä¸åˆªé™¤åŸæ–‡)</span></div>
      <div id="memory-protected-info" style="color:var(--warning);font-size:12px;margin-top:6px"></div>
    </div>
  </div>
  
  <!-- åŠŸèƒ½é¸é …å¡ -->
  <div style="display:flex;gap:8px;margin-bottom:12px">
    <button class="modal-btn secondary" id="mem-tab-compress" onclick="switchMemTab('compress')" style="flex:1;font-size:12px;padding:8px">ğŸ—œï¸ å£“ç¸®</button>
    <button class="modal-btn" id="mem-tab-rolling" onclick="switchMemTab('rolling')" style="flex:1;font-size:12px;padding:8px;background:var(--bg-tertiary)">ğŸ“œ æ»¾å‹•</button>
    <button class="modal-btn" id="mem-tab-analyze" onclick="switchMemTab('analyze')" style="flex:1;font-size:12px;padding:8px;background:var(--bg-tertiary)">ğŸ” åˆ†æ</button>
  </div>
  
  <!-- å£“ç¸®é¸é … -->
  <div id="mem-panel-compress">
    <div class="form-group">
      <label class="form-label">å£“ç¸®æ–¹å¼</label>
      <select class="form-select" id="compress-mode" onchange="updateCompressOptions()">
        <option value="count">æŒ‰æ¶ˆæ¯æ•¸é‡</option>
        <option value="chapter">æŒ‰ç« ç¯€å£“ç¸®</option>
      </select>
    </div>
    <div class="form-group" id="compress-count-group">
      <label class="form-label">å£“ç¸®æ•¸é‡</label>
      <select class="form-select" id="compress-count">
        <option value="10">å£“ç¸®æœ€æ—© 10 æ¢æ¶ˆæ¯</option>
        <option value="20">å£“ç¸®æœ€æ—© 20 æ¢æ¶ˆæ¯</option>
        <option value="50">å£“ç¸®æœ€æ—© 50 æ¢æ¶ˆæ¯</option>
        <option value="all">å£“ç¸®æ‰€æœ‰èˆŠæ¶ˆæ¯ï¼ˆä¿ç•™æœ€è¿‘20æ¢ï¼‰</option>
      </select>
    </div>
    <div class="form-group" id="compress-chapter-group" style="display:none">
      <label class="form-label">é¸æ“‡ç« ç¯€</label>
      <select class="form-select" id="compress-chapter"></select>
      <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">å°‡å£“ç¸®è©²ç« ç¯€ä¹‹å‰çš„æ‰€æœ‰æ¶ˆæ¯</div>
    </div>
    <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:12px;padding:8px;background:var(--bg-tertiary);border-radius:6px">
      ğŸ’¡ å¸¶æœ‰ä¼ç­†æ¨™è¨˜ã€æ›¸ç±¤ã€åŠ‡æƒ…æ¨™ç±¤çš„é‡è¦æ¶ˆæ¯æœƒè‡ªå‹•è·³éä¿è­·ã€‚
    </div>
  </div>
  
  <!-- æ»¾å‹•æ‘˜è¦é¸é … -->
  <div id="mem-panel-rolling" style="display:none">
    <div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">
      è‡ªå‹•ç‚ºå°è©±ç”ŸæˆèƒŒæ™¯æ‘˜è¦ï¼Œ<strong>ä¸åˆªé™¤åŸæ–‡</strong>ï¼Œå¹«åŠ© AI æ›´å¥½åœ°ç†è§£ä¸Šä¸‹æ–‡ã€‚
    </div>
    <div class="form-group">
      <label class="form-label">è‡ªå‹•æ»¾å‹•æ‘˜è¦</label>
      <div style="display:flex;align-items:center;gap:12px">
        <div class="toggle" id="tog-rolling-summary" onclick="toggleRollingSummary()"></div>
        <span style="font-size:13px;color:var(--text-secondary)">æ¯ <input type="number" id="rolling-interval" value="30" min="10" max="100" style="width:50px;padding:4px;border:1px solid var(--divider);border-radius:4px;background:var(--bg-tertiary);color:var(--text-primary)"> æ¢æ¶ˆæ¯è‡ªå‹•ç”Ÿæˆ</span>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">æ‰‹å‹•æ“ä½œ</label>
      <button class="modal-btn secondary" onclick="generateRollingSummary()" style="width:100%;margin-bottom:8px">ğŸ“œ ç«‹å³ç”Ÿæˆæ»¾å‹•æ‘˜è¦</button>
      <button class="modal-btn" onclick="mergeSummaries()" style="width:100%;background:var(--bg-tertiary)">ğŸ”— åˆä½µå¤šæ¢æ‘˜è¦</button>
    </div>
  </div>
  
  <!-- æ™ºèƒ½åˆ†æé¸é … -->
  <div id="mem-panel-analyze" style="display:none">
    <div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">
      è®“ AI åˆ†æç•¶å‰å°è©±ï¼Œè­˜åˆ¥å“ªäº›å…§å®¹é‡è¦ã€å“ªäº›å¯ä»¥å®‰å…¨å£“ç¸®ã€‚
    </div>
    <button class="modal-btn secondary" onclick="analyzeMemory()" style="width:100%;margin-bottom:12px">ğŸ” AI æ™ºèƒ½åˆ†æ</button>
    <div id="memory-analysis-result" style="display:none;background:var(--bg-tertiary);padding:12px;border-radius:8px;font-size:13px;max-height:200px;overflow-y:auto"></div>
  </div>
  
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('memory-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" id="mem-compress-btn" onclick="compressMemory()">ğŸ¤– æ™ºèƒ½å£“ç¸®</button>
  </div>
</div>
<!-- æ‘˜è¦æŸ¥çœ‹ Modal -->
<div class="modal" id="summaries-modal" style="max-width:min(95%,500px)">
  <div class="modal-title">ğŸ“š è¨˜æ†¶æ‘˜è¦</div>
  <div id="summaries-list" style="max-height:60vh;overflow-y:auto"></div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('summaries-modal')">é—œé–‰</button>
    <button class="modal-btn" style="background:var(--error)" onclick="clearAllSummaries()">ğŸ—‘ï¸ æ¸…ç©ºæ‘˜è¦</button>
  </div>
</div>
<!-- æ‘˜è¦ç·¨è¼¯ Modal -->
<div class="modal" id="edit-summary-modal" style="max-width:min(95%,550px)">
  <div class="modal-title" id="edit-summary-title">âœï¸ ç·¨è¼¯æ‘˜è¦</div>
  <div class="modal-content" style="padding:0">
    <textarea id="edit-summary-content" class="form-input" style="min-height:250px;max-height:50vh;font-size:14px;line-height:1.6" placeholder="æ‘˜è¦å…§å®¹..."></textarea>
    <div style="font-size:12px;color:var(--text-tertiary);margin-top:8px">
      ğŸ’¡ ç·¨è¼¯æ‘˜è¦å…§å®¹æœƒå½±éŸ¿ AI å°æ•…äº‹çš„ç†è§£ï¼Œè«‹è¬¹æ…ä¿®æ”¹ã€‚
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('edit-summary-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="saveSummaryEdit()">ä¿å­˜</button>
  </div>
</div>
<!-- æ‘˜è¦æœç´¢ Modal -->
<div class="modal" id="summary-search-modal" style="max-width:min(95%,500px)">
  <div class="modal-title">ğŸ” æœç´¢è¨˜æ†¶æ‘˜è¦</div>
  <div class="form-group">
    <input type="text" class="form-input" id="summary-search-input" placeholder="è¼¸å…¥é—œéµè©æœç´¢æ‘˜è¦å…§å®¹" oninput="doSummarySearch()">
  </div>
  <div id="summary-search-results" style="max-height:50vh;overflow-y:auto">
    <div class="empty"><div class="empty-icon">ğŸ”</div><div class="empty-title">è¼¸å…¥é—œéµè©æœç´¢</div></div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('summary-search-modal')">é—œé–‰</button>
  </div>
</div>
<!-- æ‘˜è¦é è¦½ Modal -->
<div class="modal" id="summary-preview-modal" style="max-width:min(95%,550px)">
  <div class="modal-title">ğŸ“ è¨˜æ†¶æ‘˜è¦é è¦½</div>
  <div class="modal-content" style="padding:0">
    <div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;padding:0 4px">
      AI å·²ç”Ÿæˆä»¥ä¸‹æ‘˜è¦ï¼Œä½ å¯ä»¥ç·¨è¼¯å¾Œå†ç¢ºèªå£“ç¸®ï¼š
    </div>
    <textarea id="summary-preview-content" class="form-input" style="min-height:200px;max-height:40vh;font-size:14px;line-height:1.6" placeholder="æ‘˜è¦å…§å®¹..."></textarea>
    <div style="background:var(--bg-tertiary);border-radius:8px;padding:10px 12px;margin-top:12px;font-size:12px;color:var(--text-secondary)">
      <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px">
        <span>ğŸ’¡</span>
        <span style="font-weight:600">æç¤º</span>
      </div>
      <div>ç¢ºèªå¾Œå°‡åˆªé™¤åŸå§‹æ¶ˆæ¯ä¸¦ä¿å­˜æ­¤æ‘˜è¦ã€‚å£“ç¸®å¾Œä»å¯åœ¨ã€ŒğŸ“Š æŸ¥çœ‹ã€ä¸­ç·¨è¼¯æ‘˜è¦å…§å®¹ã€‚</div>
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="cancelSummaryPreview()">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="confirmSummaryCompress()">ç¢ºèªä¸¦å£“ç¸®</button>
  </div>
</div>
<!-- èƒŒåŒ…ç‰©å“ç·¨è¼¯ Modal -->
<div class="modal" id="inventory-item-modal" style="max-width:min(95%,450px)">
  <div class="modal-title" id="inventory-modal-title">â• æ·»åŠ ç‰©å“</div>
  <div class="form-group">
    <label class="form-label">ç‰©å“åœ–æ¨™</label>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px" id="inventory-icon-picker">
      <span class="icon-option" onclick="selectInventoryIcon('âš”ï¸')">âš”ï¸</span>
      <span class="icon-option" onclick="selectInventoryIcon('ğŸ—¡ï¸')">ğŸ—¡ï¸</span>
      <span class="icon-option" onclick="selectInventoryIcon('ğŸ›¡ï¸')">ğŸ›¡ï¸</span>
      <span class="icon-option" onclick="selectInventoryIcon('ğŸ§ª')">ğŸ§ª</span>
      <span class="icon-option" onclick="selectInventoryIcon('ğŸ’Š')">ğŸ’Š</span>
      <span class="icon-option" onclick="selectInventoryIcon('ğŸ“¦')">ğŸ“¦</span>
      <span class="icon-option" onclick="selectInventoryIcon('ğŸ’')">ğŸ’</span>
      <span class="icon-option" onclick="selectInventoryIcon('ğŸ”‘')">ğŸ”‘</span>
      <span class="icon-option" onclick="selectInventoryIcon('ğŸ“œ')">ğŸ“œ</span>
      <span class="icon-option" onclick="selectInventoryIcon('ğŸ’°')">ğŸ’°</span>
      <span class="icon-option" onclick="selectInventoryIcon('ğŸ')">ğŸ</span>
      <span class="icon-option" onclick="selectInventoryIcon('ğŸ§²')">ğŸ§²</span>
      <span class="icon-option" onclick="selectInventoryIcon('ğŸ”®')">ğŸ”®</span>
      <span class="icon-option" onclick="selectInventoryIcon('ğŸ“¿')">ğŸ“¿</span>
      <span class="icon-option" onclick="selectInventoryIcon('ğŸ‘‘')">ğŸ‘‘</span>
    </div>
    <input type="text" class="form-input" id="inventory-item-icon" placeholder="æˆ–è¼¸å…¥è‡ªå®šç¾©åœ–æ¨™/emoji" maxlength="4" style="width:80px">
  </div>
  <div class="form-group">
    <label class="form-label">ç‰©å“åç¨± *</label>
    <input type="text" class="form-input" id="inventory-item-name" placeholder="ä¾‹ï¼šæœˆå…‰åŠ">
  </div>
  <div class="form-group">
    <label class="form-label">æ•¸é‡</label>
    <input type="number" class="form-input" id="inventory-item-quantity" value="1" min="1" style="width:100px">
  </div>
  <div class="form-group">
    <label class="form-label">åˆ†é¡</label>
    <select class="form-input" id="inventory-item-category">
      <option value="weapon">âš”ï¸ æ­¦å™¨</option>
      <option value="armor">ğŸ›¡ï¸ é˜²å…·</option>
      <option value="consumable">ğŸ§ª æ¶ˆè€—å“</option>
      <option value="material">ğŸ“¦ ææ–™</option>
      <option value="key">ğŸ”‘ é—œéµç‰©å“</option>
      <option value="other">ğŸ“‹ å…¶ä»–</option>
    </select>
  </div>
  <div class="form-group">
    <label class="form-label">æè¿°</label>
    <textarea class="form-input" id="inventory-item-desc" placeholder="ç‰©å“æè¿°ï¼ˆå¯é¸ï¼‰" rows="2"></textarea>
  </div>
  <div class="form-group">
    <label class="form-label" style="display:flex;align-items:center;gap:8px">
      <input type="checkbox" id="inventory-item-lorebook"> åŒæ­¥åˆ° Lorebookï¼ˆAIå¯è­˜åˆ¥æ­¤ç‰©å“ï¼‰
    </label>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('inventory-item-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="saveInventoryItem()">ä¿å­˜</button>
  </div>
</div>
<!-- æŸ¥æ‰¾æ›¿æ› Modal -->
<div class="modal" id="find-replace-modal">
  <div class="modal-title">ğŸ” æŸ¥æ‰¾èˆ‡æ›¿æ›</div>
  <div class="form-group">
    <label class="form-label">æŸ¥æ‰¾</label>
    <input type="text" class="form-input" id="find-text" placeholder="è¼¸å…¥è¦æŸ¥æ‰¾çš„æ–‡å­—">
  </div>
  <div class="form-group">
    <label class="form-label">æ›¿æ›ç‚º</label>
    <input type="text" class="form-input" id="replace-text" placeholder="è¼¸å…¥æ›¿æ›å¾Œçš„æ–‡å­—">
  </div>
  <div class="form-group">
    <label style="font-size:13px;color:var(--text-secondary);display:flex;align-items:center;gap:6px;cursor:pointer">
      <input type="checkbox" id="find-case-sensitive"> å€åˆ†å¤§å°å¯«
    </label>
  </div>
  <div id="find-result" style="font-size:13px;color:var(--text-tertiary);margin-bottom:12px"></div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('find-replace-modal')">é—œé–‰</button>
    <button class="modal-btn secondary" onclick="findNext()">æŸ¥æ‰¾ä¸‹ä¸€å€‹</button>
    <button class="modal-btn confirm" onclick="replaceAll()">å…¨éƒ¨æ›¿æ›</button>
  </div>
</div>
<!-- çµ±è¨ˆé¢æ¿ Modal -->
<div class="modal" id="stats-modal">
  <div class="modal-title">ğŸ“Š çµ±è¨ˆé¢æ¿</div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;text-align:center">
      <div style="font-size:24px;font-weight:bold;color:var(--primary)" id="stats-chars">0</div>
      <div style="font-size:12px;color:var(--text-tertiary)">ç¸½å­—æ•¸</div>
    </div>
    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;text-align:center">
      <div style="font-size:24px;font-weight:bold;color:var(--primary)" id="stats-msgs">0</div>
      <div style="font-size:12px;color:var(--text-tertiary)">æ¶ˆæ¯æ•¸</div>
    </div>
    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;text-align:center">
      <div style="font-size:24px;font-weight:bold;color:var(--primary)" id="stats-tokens">0</div>
      <div style="font-size:12px;color:var(--text-tertiary)">ç¸½ Tokens</div>
    </div>
    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;text-align:center">
      <div style="font-size:24px;font-weight:bold;color:var(--primary)" id="stats-time">0h</div>
      <div style="font-size:12px;color:var(--text-tertiary)">éŠç©æ™‚é•·</div>
    </div>
  </div>
  <div style="margin-top:16px;padding:12px;background:var(--bg-tertiary);border-radius:8px;font-size:13px">
    <div style="margin-bottom:8px"><strong>ç”¨æˆ¶è¼¸å…¥ï¼š</strong><span id="stats-user-chars">0</span> å­—</div>
    <div><strong>AI ç”Ÿæˆï¼š</strong><span id="stats-ai-chars">0</span> å­—</div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn confirm" onclick="closeModal('stats-modal')">é—œé–‰</button>
  </div>
</div>
<!-- æ·»åŠ ç« ç¯€ Modal -->
<div class="modal" id="chapter-modal">
  <div class="modal-title">ğŸ“‘ æ·»åŠ ç« ç¯€</div>
  <div class="form-group">
    <label class="form-label">ç« ç¯€æ¨™é¡Œ</label>
    <input type="text" class="form-input" id="chapter-title" placeholder="ä¾‹å¦‚ï¼šç¬¬ä¸€ç« ãƒ»å…¥å®®">
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('chapter-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="saveChapter()">ä¿å­˜</button>
  </div>
</div>
<!-- æ·»åŠ æ›¸ç±¤ Modal -->
<div class="modal" id="bookmark-modal">
  <div class="modal-title">ğŸ”– æ·»åŠ æ›¸ç±¤</div>
  <div class="form-group">
    <label class="form-label">æ›¸ç±¤åç¨±</label>
    <input type="text" class="form-input" id="bookmark-name" placeholder="ä¾‹å¦‚ï¼šé‡è¦åŠ‡æƒ…é»">
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('bookmark-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="saveBookmark()">ä¿å­˜</button>
  </div>
</div>
<!-- æ·»åŠ æ¨™ç±¤ Modal -->
<div class="modal" id="tag-modal">
  <div class="modal-title">ğŸ·ï¸ æ·»åŠ åŠ‡æƒ…æ¨™ç±¤</div>
  <div class="form-group">
    <label class="form-label">æ¨™ç±¤é¡å‹</label>
    <select class="form-select" id="tag-type">
      <option value="key">ğŸ”‘ é—œéµåŠ‡æƒ…</option>
      <option value="scene">ğŸ¬ åå ´é¢</option>
      <option value="clue">ğŸ” ç·šç´¢</option>
      <option value="turning">ğŸ”„ è½‰æŠ˜é»</option>
      <option value="emotion">ğŸ’• æƒ…æ„Ÿæˆ²</option>
    </select>
  </div>
  <div class="form-group">
    <label class="form-label">å‚™è¨»ï¼ˆå¯é¸ï¼‰</label>
    <input type="text" class="form-input" id="tag-note" placeholder="ç°¡çŸ­æè¿°">
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('tag-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="savePlotTag()">ä¿å­˜</button>
  </div>
</div>
<!-- å‰µå»ºåˆ†æ”¯ Modal -->
<div class="modal" id="branch-modal">
  <div class="modal-title">ğŸ”€ å‰µå»ºåˆ†æ”¯</div>
  <div class="form-group">
    <label class="form-label">åˆ†æ”¯åç¨±</label>
    <input type="text" class="form-input" id="branch-name" placeholder="ä¾‹å¦‚ï¼šé¸æ“‡å¹«åŠ©å¤œå¯’">
  </div>
  <div class="form-group">
    <label class="form-label">åˆ†æ”¯æè¿°ï¼ˆå¯é¸ï¼‰</label>
    <textarea class="form-input" id="branch-desc" style="min-height:60px" placeholder="é€™å€‹åˆ†æ”¯çš„ç‰¹é»..."></textarea>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('branch-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="saveBranch()">å‰µå»º</button>
  </div>
</div>
<!-- AI ä¸€è‡´æ€§æª¢æŸ¥ Modal -->
<div class="modal" id="ai-check-modal" style="max-width:min(90%,400px)">
  <div class="modal-title">ğŸ” AI ä¸€è‡´æ€§æª¢æŸ¥</div>
  <div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">
    AI å°‡åˆ†ææ•…äº‹å…§å®¹ï¼Œæª¢æŸ¥æ˜¯å¦å­˜åœ¨è¨­å®šçŸ›ç›¾ã€æ™‚é–“ç·šéŒ¯èª¤ã€è§’è‰²è¡Œç‚ºä¸ä¸€è‡´ç­‰å•é¡Œã€‚
  </div>
  <div id="ai-check-result" style="background:var(--bg-tertiary);padding:12px;border-radius:8px;min-height:100px;max-height:300px;overflow-y:auto;font-size:13px;white-space:pre-wrap">
    é»æ“Šã€Œé–‹å§‹æª¢æŸ¥ã€é€²è¡Œåˆ†æ...
  </div>
  <div class="modal-actions" style="flex-wrap:wrap;gap:8px">
    <button class="modal-btn secondary" id="ai-fix-btn" style="display:none;flex:0 0 auto" onclick="showAiFix()">ğŸ”§ æ‡‰ç”¨ä¿®å¾©</button>
    <button class="modal-btn cancel" onclick="closeModal('ai-check-modal')">é—œé–‰</button>
    <button class="modal-btn confirm" onclick="doAiConsistencyCheck()">é–‹å§‹æª¢æŸ¥</button>
  </div>
</div>
<!-- AI ä¿®å¾©å»ºè­° Modal -->
<div class="modal" id="ai-fix-modal" style="max-width:min(90%,400px)">
  <div class="modal-title">ğŸ”§ AI ä¿®å¾©å»ºè­°</div>
  <div style="font-size:14px;margin-bottom:16px">
    é¸æ“‡å¦‚ä½•è™•ç†ç™¼ç¾çš„å•é¡Œï¼š
  </div>
  <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px">
    <button class="action-btn secondary" style="text-align:left;padding:12px" onclick="applyAiFix('auto')">ğŸ¤– <strong>AI è‡ªå‹•ä¿®å¾©</strong><br><span style="font-size:12px;color:var(--text-secondary)">åœ¨ä¸‹æ¬¡ AI å›è¦†ä¸­è‡ªç„¶åœ°ç³¾æ­£å•é¡Œ</span></button>
    <button class="action-btn secondary" style="text-align:left;padding:12px" onclick="applyAiFix('note')">ğŸ“ <strong>æ·»åŠ è¨­å®šç­†è¨˜</strong><br><span style="font-size:12px;color:var(--text-secondary)">è¨˜éŒ„åˆ°ä¸–ç•Œè§€è³‡æ–™åº«ä¾›æ—¥å¾Œåƒè€ƒ</span></button>
    <button class="action-btn secondary" style="text-align:left;padding:12px" onclick="applyAiFix('ignore')">ğŸ”• <strong>å¿½ç•¥é€™æ¬¡</strong><br><span style="font-size:12px;color:var(--text-secondary)">é€™å€‹ã€Œå•é¡Œã€å¯èƒ½æ˜¯æ•…æ„è¨­è¨ˆçš„</span></button>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('ai-fix-modal')">å–æ¶ˆ</button>
  </div>
</div>
<!-- v7: è§’è‰²ç‹€æ…‹æ›´æ–° Modal -->
<div class="modal" id="char-update-modal" style="max-width:min(90%,420px)">
  <div class="modal-title">ğŸ¤– AI è§’è‰²åˆ†æ</div>
  <div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">
    AI æœƒåˆ†ææ•…äº‹å…§å®¹ï¼Œè‡ªå‹•è­˜åˆ¥è§’è‰²ä¸¦æå–å±¬æ€§ã€‚é€™å¯èƒ½éœ€è¦ä¸€äº›æ™‚é–“ã€‚
  </div>
  <div id="char-update-result" style="background:var(--bg-tertiary);padding:12px;border-radius:8px;min-height:80px;max-height:250px;overflow-y:auto;font-size:12px;white-space:pre-wrap">
    é»æ“Šã€Œé–‹å§‹åˆ†æã€è®“ AI è­˜åˆ¥è§’è‰²...
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('char-update-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" id="char-update-btn" onclick="doCharacterUpdate()">é–‹å§‹åˆ†æ</button>
  </div>
</div>
<!-- v8: è§’è‰²æ·»åŠ /ç·¨è¼¯ Modalï¼ˆé‡æ§‹ç‰ˆ - æŠ˜ç–Šé¢æ¿ï¼‰ -->
<div class="modal" id="char-add-modal" style="max-width:min(95%,480px);max-height:85vh;display:flex;flex-direction:column">
  <div class="modal-title" style="flex-shrink:0">
    <span id="char-modal-title">â• æ·»åŠ è§’è‰²</span>
    <span id="char-token-count" style="font-size:12px;color:var(--text-secondary);font-weight:normal;margin-left:8px"></span>
  </div>
  <div style="flex:1;overflow-y:auto;padding-right:4px" id="char-edit-scroll">
    <!-- ğŸ“‹ åŸºæœ¬ä¿¡æ¯ï¼ˆé»˜èªå±•é–‹ï¼‰ -->
    <div class="char-panel" data-panel="basic">
      <div class="char-panel-header" onclick="toggleCharPanel('basic')">
        <span>ğŸ“‹ åŸºæœ¬ä¿¡æ¯</span>
        <span class="char-panel-arrow">â–¼</span>
      </div>
      <div class="char-panel-content" style="display:block">
        <div class="char-form-row">
          <div class="form-group" style="flex:1">
            <label class="form-label">è§’è‰²åç¨± *</label>
            <input type="text" class="form-input" id="char-add-name" placeholder="ä¾‹å¦‚ï¼šå¤œå¯’" oninput="updateCharTokenCount()">
          </div>
          <div class="form-group" style="width:80px">
            <label class="form-label">é ­åƒ</label>
            <input type="text" class="form-input" id="char-add-avatar" placeholder="ğŸŒ™" maxlength="4" style="text-align:center;font-size:20px">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">é ­éŠœ/èº«ä»½</label>
          <input type="text" class="form-input" id="char-add-title" placeholder="ä¾‹å¦‚ï¼šæœˆå…‰èŠåœ’è€é—†">
        </div>
        <div class="form-group">
          <label class="form-label">åˆ†é¡</label>
          <select class="form-input" id="char-add-category">
            <option value="protagonist">â­ ä¸»è§’</option>
            <option value="supporting" selected>ğŸ‘¤ é…è§’</option>
            <option value="npc">ğŸ‘¥ NPC</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">æè¿° <span class="token-hint" id="desc-tokens"></span></label>
          <textarea class="form-textarea" id="char-add-desc" rows="4" placeholder="è©³ç´°æè¿°è§’è‰²çš„å¤–è²Œã€æ€§æ ¼ã€èƒŒæ™¯æ•…äº‹...&#10;æ”¯æŒ Markdown æ ¼å¼" oninput="updateCharTokenCount()"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">æ€§æ ¼æ‘˜è¦</label>
          <input type="text" class="form-input" id="char-add-personality" placeholder="ä¾‹å¦‚ï¼šå¤–å†·å…§ç†±ã€ä½”æœ‰æ¬²å¼·ã€å°èˆŠæ„›å¿µå¿µä¸å¿˜">
        </div>
        <div class="form-group">
          <label class="form-label">æ¨™ç±¤ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰</label>
          <input type="text" class="form-input" id="char-add-tags" placeholder="ä¾‹å¦‚ï¼šéœ¸é“ç¸½è£, å‰ä»», æ·±æƒ…">
        </div>
      </div>
    </div>
    
    <!-- ğŸ’¬ å°è©±è¨­ç½®ï¼ˆé»˜èªæŠ˜ç–Šï¼‰ -->
    <div class="char-panel" data-panel="dialogue">
      <div class="char-panel-header" onclick="toggleCharPanel('dialogue')">
        <span>ğŸ’¬ å°è©±è¨­ç½®</span>
        <span class="char-panel-arrow">â–¶</span>
      </div>
      <div class="char-panel-content" style="display:none">
        <div class="form-group">
          <label class="form-label">é–‹å ´ç™½ <span class="token-hint" id="firstmes-tokens"></span></label>
          <textarea class="form-textarea" id="char-add-firstmes" rows="4" placeholder="è§’è‰²çš„ç¬¬ä¸€æ¢æ¶ˆæ¯ï¼Œç”¨æ–¼é–‹å§‹æ–°å°è©±æ™‚...&#10;ä¾‹å¦‚ï¼š*ä»–æŠ¬çœ¼çœ‹å‘ä½ ï¼Œå˜´è§’å¾®å¾®ä¸Šæš* ã€Œä½ çµ‚æ–¼ä¾†äº†ã€‚ã€" oninput="updateCharTokenCount()"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">æ›¿ä»£é–‹å ´ç™½</label>
          <div id="char-alt-greetings" style="display:flex;flex-direction:column;gap:8px"></div>
          <button class="modal-btn secondary" style="margin-top:8px;padding:6px 12px;font-size:12px" onclick="addAltGreeting()">+ æ·»åŠ æ›¿ä»£é–‹å ´ç™½</button>
        </div>
        <div class="form-group">
          <label class="form-label">å ´æ™¯æè¿°</label>
          <textarea class="form-textarea" id="char-add-scenario" rows="2" placeholder="å°è©±ç™¼ç”Ÿçš„èƒŒæ™¯æƒ…å¢ƒ..."></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">å°è©±ç¤ºä¾‹ <span class="token-hint" id="example-tokens"></span></label>
          <textarea class="form-textarea" id="char-add-example" rows="4" placeholder="ç¤ºç¯„è§’è‰²å¦‚ä½•èªªè©±ï¼Œå¹«åŠ© AI å­¸ç¿’èªæ°£...&#10;æ ¼å¼ï¼šç”¨ &lt;START&gt; åˆ†éš”å¤šæ®µç¤ºä¾‹" oninput="updateCharTokenCount()"></textarea>
          <div style="margin-top:8px">
            <button class="modal-btn secondary" style="padding:6px 12px;font-size:12px" onclick="openVisualExampleEditor()">ğŸ“ å¯è¦–åŒ–ç·¨è¼¯å™¨</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- âš™ï¸ é«˜ç´šè¨­ç½®ï¼ˆé»˜èªæŠ˜ç–Šï¼‰ -->
    <div class="char-panel" data-panel="advanced">
      <div class="char-panel-header" onclick="toggleCharPanel('advanced')">
        <span>âš™ï¸ é«˜ç´šè¨­ç½®</span>
        <span class="char-panel-arrow">â–¶</span>
      </div>
      <div class="char-panel-content" style="display:none">
        <div class="form-group">
          <label class="form-label">è§’è‰²å°ˆå±¬ç³»çµ±æç¤ºè© <span class="token-hint" id="sysprompt-tokens"></span></label>
          <textarea class="form-textarea" id="char-add-sysprompt" rows="3" placeholder="è¦†è“‹æˆ–è£œå……é»˜èªç³»çµ±æç¤ºè©...&#10;åƒ…åœ¨è©²è§’è‰²å‡ºå ´æ™‚ç”Ÿæ•ˆ" oninput="updateCharTokenCount()"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">å¾Œæ­·å²æŒ‡ä»¤</label>
          <textarea class="form-textarea" id="char-add-posthistory" rows="2" placeholder="åœ¨å°è©±æ­·å²ä¹‹å¾Œæ³¨å…¥çš„æŒ‡ä»¤..."></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">å‰µä½œè€…ç­†è¨˜</label>
          <textarea class="form-textarea" id="char-add-creatornotes" rows="2" placeholder="ä½¿ç”¨èªªæ˜ã€æŠ€å·§ç­‰..."></textarea>
        </div>
        <div class="char-form-row">
          <div class="form-group" style="flex:1">
            <label class="form-label">å‰µä½œè€…</label>
            <input type="text" class="form-input" id="char-add-creator" placeholder="ä½ çš„åå­—">
          </div>
          <div class="form-group" style="width:100px">
            <label class="form-label">ç‰ˆæœ¬è™Ÿ</label>
            <input type="text" class="form-input" id="char-add-version" placeholder="1.0">
          </div>
        </div>
      </div>
    </div>
    
    <!-- ğŸ“š è§’è‰² Lorebookï¼ˆé»˜èªæŠ˜ç–Šï¼‰ -->
    <div class="char-panel" data-panel="lorebook">
      <div class="char-panel-header" onclick="toggleCharPanel('lorebook')">
        <span>ğŸ“š è§’è‰²å°ˆå±¬ Lorebook</span>
        <span class="char-panel-arrow">â–¶</span>
      </div>
      <div class="char-panel-content" style="display:none">
        <div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px">
          ç‚ºè©²è§’è‰²å‰µå»ºå°ˆå±¬çš„ä¸–ç•Œæ›¸æ¢ç›®ï¼Œåƒ…åœ¨è§’è‰²å‡ºå ´æ™‚è§¸ç™¼ã€‚
        </div>
        <div class="form-group">
          <label class="form-label">è§¸ç™¼æ¨¡å¼</label>
          <select class="form-input" id="char-add-lore-trigger">
            <option value="scene">åƒ…åœ¨ç•¶å‰å ´æ™¯ä¸­è§¸ç™¼</option>
            <option value="always">åªè¦æ•…äº‹åŒ…å«è©²è§’è‰²å°±å§‹çµ‚è§¸ç™¼</option>
          </select>
        </div>
        <div id="char-lorebook-entries" style="display:flex;flex-direction:column;gap:8px"></div>
        <button class="modal-btn secondary" style="margin-top:8px;padding:6px 12px;font-size:12px" onclick="addCharLorebookEntry()">+ æ·»åŠ æ¢ç›®</button>
      </div>
    </div>
    
    <!-- ğŸ‘¥ è§’è‰²é—œä¿‚ï¼ˆé»˜èªæŠ˜ç–Šï¼‰ -->
    <div class="char-panel" data-panel="relations">
      <div class="char-panel-header" onclick="toggleCharPanel('relations')">
        <span>ğŸ‘¥ è§’è‰²é—œä¿‚</span>
        <span class="char-panel-arrow">â–¶</span>
      </div>
      <div class="char-panel-content" style="display:none">
        <div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px">
          å®šç¾©æ­¤è§’è‰²èˆ‡å…¶ä»–è§’è‰²çš„é—œä¿‚ï¼ŒAIæœƒåƒè€ƒé€™äº›ä¿¡æ¯ã€‚
        </div>
        <div id="char-relationships-list" style="display:flex;flex-direction:column;gap:10px"></div>
        <button class="modal-btn secondary" style="margin-top:10px;padding:6px 12px;font-size:12px" onclick="addCharRelationship()">+ æ·»åŠ é—œä¿‚</button>
      </div>
    </div>
    
    <!-- ğŸ¨ è¡¨æƒ…ç«‹ç¹ªï¼ˆé»˜èªæŠ˜ç–Šï¼‰ -->
    <div class="char-panel" data-panel="expressions">
      <div class="char-panel-header" onclick="toggleCharPanel('expressions')">
        <span>ğŸ¨ è¡¨æƒ…ç«‹ç¹ª</span>
        <span class="char-panel-arrow">â–¶</span>
      </div>
      <div class="char-panel-content" style="display:none">
        <div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px">
          ä¸Šå‚³è§’è‰²çš„ä¸åŒè¡¨æƒ…åœ–ç‰‡ï¼ŒAIå¯æ ¹æ“šå°è©±å…§å®¹è‡ªå‹•åˆ‡æ›ã€‚
        </div>
        <div class="form-group">
          <label class="form-label">è¡¨æƒ…æ¨¡å¼</label>
          <select class="form-input" id="char-add-expr-mode" style="width:100%">
            <option value="manual">æ‰‹å‹•åˆ‡æ›</option>
            <option value="auto">AI è‡ªå‹•åˆ‡æ›</option>
          </select>
        </div>
        <div id="char-expressions-list" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px"></div>
        <button class="modal-btn secondary" style="margin-top:12px;padding:6px 12px;font-size:12px;width:100%" onclick="addCharExpression()">+ æ·»åŠ è¡¨æƒ…</button>
        <input type="file" id="expr-file-input" accept="image/*" style="display:none" onchange="handleExpressionUpload(event)">
      </div>
    </div>
    
    <!-- ğŸ“Š ç‹€æ…‹å±¬æ€§ï¼ˆé»˜èªæŠ˜ç–Šï¼‰ -->
    <div class="char-panel" data-panel="stats">
      <div class="char-panel-header" onclick="toggleCharPanel('stats')">
        <span>ğŸ“Š ç‹€æ…‹å±¬æ€§</span>
        <span class="char-panel-arrow">â–¶</span>
      </div>
      <div class="char-panel-content" style="display:none">
        <div class="form-group">
          <label class="form-label">å±¬æ€§ï¼ˆæ¯è¡Œä¸€å€‹ï¼Œæ ¼å¼ï¼šå±¬æ€§å:æ•¸å€¼ï¼‰</label>
          <textarea class="form-textarea" id="char-add-stats" rows="4" placeholder="å¥½æ„Ÿ:50&#10;å¿ èª :60&#10;é‡å¿ƒ:30"></textarea>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal-actions" style="flex-shrink:0;border-top:1px solid var(--divider);padding-top:12px;margin-top:8px">
    <button class="modal-btn secondary" onclick="aiGenerateCharFields()" style="margin-right:auto">ğŸ¤– AI è¼”åŠ©</button>
    <button class="modal-btn cancel" onclick="closeCharEditModal()">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="saveCharacterManual()">ä¿å­˜</button>
  </div>
</div>
<!-- v7: è§’è‰²è©³æƒ…/ç·¨è¼¯ Modal -->
<div class="modal" id="char-detail-modal" style="max-width:min(90%,420px)">
  <div class="modal-title" id="char-detail-title">è§’è‰²è©³æƒ…</div>
  <div id="char-detail-content" style="max-height:50vh;overflow-y:auto"></div>
  <div class="modal-actions" style="flex-wrap:wrap;gap:8px">
    <button class="modal-btn cancel" onclick="closeModal('char-detail-modal')">é—œé–‰</button>
    <button class="modal-btn" onclick="showCharExportOptions()">ğŸ“¤ å°å‡º</button>
    <button class="modal-btn secondary" onclick="editCharacter()">ç·¨è¼¯</button>
    <button class="modal-btn" style="background:var(--error);color:white" onclick="deleteCharacter()">åˆªé™¤</button>
  </div>
</div>
<!-- v8: è§’è‰²å°å‡ºé¸é … Modal -->
<div class="modal" id="char-export-modal" style="max-width:min(90%,320px)">
  <div class="modal-title">ğŸ“¤ å°å‡ºè§’è‰²å¡</div>
  <div style="padding:16px 0">
    <div style="display:flex;flex-direction:column;gap:12px">
      <button class="modal-btn" style="padding:16px;font-size:15px" onclick="exportCurrentCharacterJSON()">
        ğŸ“„ JSON æ ¼å¼<br><span style="font-size:12px;color:var(--text-secondary)">é€šç”¨æ ¼å¼ï¼Œå¯åœ¨å…¶ä»–å¹³å°å°å…¥</span>
      </button>
      <button class="modal-btn" style="padding:16px;font-size:15px" onclick="exportCurrentCharacterPNG()">
        ğŸ–¼ï¸ PNG åœ–ç‰‡<br><span style="font-size:12px;color:var(--text-secondary)">SillyTavern å…¼å®¹ï¼Œå¸¶è§’è‰²åœ–ç‰‡</span>
      </button>
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('char-export-modal')">å–æ¶ˆ</button>
  </div>
</div>
<!-- v8: URL å°å…¥è§’è‰²å¡ Modal -->
<div class="modal" id="char-url-import-modal" style="max-width:min(90%,380px)">
  <div class="modal-title">ğŸ”— å¾ URL å°å…¥è§’è‰²å¡</div>
  <div style="padding:16px 0">
    <div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">
      æ”¯æŒçš„æ ¼å¼ï¼š<br>
      â€¢ ç›´æ¥ JSON/PNG éˆæ¥<br>
      â€¢ Chub.ai è§’è‰²é é¢<br>
      â€¢ CharacterHub è§’è‰²é é¢
    </div>
    <input type="text" id="char-url-input" placeholder="è«‹è¼¸å…¥è§’è‰²å¡ URL..." style="width:100%;padding:12px;border:1px solid var(--divider);border-radius:8px;background:var(--bg-tertiary);color:var(--text-primary);font-size:14px">
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('char-url-import-modal')">å–æ¶ˆ</button>
    <button class="modal-btn" onclick="doImportFromURL()">å°å…¥</button>
  </div>
</div>
<!-- v7: è§’è‰²æ­·å²è¨˜éŒ„ Modal -->
<div class="modal" id="char-history-modal" style="max-width:min(90%,400px)">
  <div class="modal-title">ğŸ“œ å±¬æ€§è®ŠåŒ–æ­·å²</div>
  <div id="char-history-content" style="max-height:50vh;overflow-y:auto"></div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('char-history-modal')">é—œé–‰</button>
  </div>
</div>
<!-- v25: é–‹å ´ç™½é¸æ“‡ Modal -->
<div class="modal" id="greeting-select-modal" style="max-width:min(90%,420px)">
  <div class="modal-title">ğŸ’¬ é¸æ“‡é–‹å ´ç™½</div>
  <div id="greeting-select-content" style="max-height:60vh;overflow-y:auto;padding:8px 0"></div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('greeting-select-modal');skipGreeting()">ä¸ä½¿ç”¨é–‹å ´ç™½</button>
    <button class="modal-btn confirm" onclick="confirmGreeting()">ä½¿ç”¨é¸ä¸­çš„é–‹å ´ç™½</button>
  </div>
</div>
<!-- v25: è§’è‰²é—œä¿‚åœ–è­œ Modal -->
<div class="modal" id="relationship-graph-modal" style="max-width:min(95%,600px);max-height:85vh">
  <div class="modal-title">ğŸ•¸ï¸ è§’è‰²é—œä¿‚åœ–è­œ</div>
  <div id="relationship-graph-container" style="width:100%;height:400px;background:var(--bg-tertiary);border-radius:12px;overflow:hidden;position:relative"></div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('relationship-graph-modal')">é—œé–‰</button>
    <button class="modal-btn secondary" onclick="resetGraphView()">é‡ç½®è¦–åœ–</button>
  </div>
</div>
<!-- AI ç« ç¯€ç¸½çµ Modal -->
<div class="modal" id="ai-summary-modal" style="max-width:min(90%,400px)">
  <div class="modal-title">ğŸ“ AI ç« ç¯€ç¸½çµ</div>
  <div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">
    AI å°‡è‡ªå‹•ç”Ÿæˆç•¶å‰æ•…äº‹é€²åº¦çš„æ‘˜è¦ï¼ŒåŒ…æ‹¬ä¸»è¦äº‹ä»¶ã€è§’è‰²ç‹€æ…‹è®ŠåŒ–ç­‰ã€‚
  </div>
  <div id="ai-summary-result" style="background:var(--bg-tertiary);padding:12px;border-radius:8px;min-height:100px;max-height:300px;overflow-y:auto;font-size:13px;white-space:pre-wrap">
    é»æ“Šã€Œç”Ÿæˆç¸½çµã€é–‹å§‹...
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('ai-summary-modal')">é—œé–‰</button>
    <button class="modal-btn secondary" onclick="copySummary()">è¤‡è£½</button>
    <button class="modal-btn confirm" onclick="doAiChapterSummary()">ç”Ÿæˆç¸½çµ</button>
  </div>
</div>
<!-- AI è¡Œå‹•å»ºè­° Modal -->
<div class="modal" id="ai-suggest-modal" style="max-width:min(90%,400px)">
  <div class="modal-title">ğŸ’¡ AI è¡Œå‹•å»ºè­°</div>
  <div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">
    å¡é—œäº†ï¼Ÿè®“ AI ç‚ºä½ æä¾›ä¸€äº›å¯èƒ½çš„è¡Œå‹•æ–¹å‘ã€‚
  </div>
  <div id="ai-suggest-result" style="background:var(--bg-tertiary);padding:12px;border-radius:8px;min-height:100px;max-height:300px;overflow-y:auto;font-size:13px;white-space:pre-wrap">
    é»æ“Šã€Œç²å–å»ºè­°ã€é–‹å§‹...
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('ai-suggest-modal')">é—œé–‰</button>
    <button class="modal-btn confirm" onclick="doAiSuggestions()">ç²å–å»ºè­°</button>
  </div>
</div>
<!-- é«˜ç´šæœç´¢ Modal -->
<div class="modal" id="advanced-search-modal">
  <div class="modal-title">ğŸ” é«˜ç´šæœç´¢</div>
  <div class="form-group">
    <label class="form-label">é—œéµè©</label>
    <input type="text" class="form-input" id="adv-search-keyword" placeholder="è¼¸å…¥æœç´¢é—œéµè©">
  </div>
  <div class="form-group">
    <label class="form-label">æœç´¢ç¯„åœ</label>
    <select class="form-select" id="adv-search-scope">
      <option value="all">å…¨éƒ¨å…§å®¹</option>
      <option value="user">åƒ…ç”¨æˆ¶è¼¸å…¥</option>
      <option value="ai">åƒ… AI å›å¾©</option>
    </select>
  </div>
  <div class="form-group">
    <label style="font-size:13px;color:var(--text-secondary);display:flex;align-items:center;gap:6px;cursor:pointer">
      <input type="checkbox" id="adv-search-case"> å€åˆ†å¤§å°å¯«
    </label>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('advanced-search-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="doAdvancedSearch()">æœç´¢</button>
  </div>
</div>
<!-- è³‡æ–™ç·¨è¼¯ Modal -->
<div class="modal" id="lore-modal">
  <div class="modal-title">ğŸ“– è³‡æ–™è¨­å®š</div>
  <div class="form-group">
    <label class="form-label">åç¨±</label>
    <input type="text" class="form-input" id="lore-name" placeholder="ä¾‹å¦‚ï¼šå¤œå¯’ã€é³³å„€å®®">
  </div>
  <div class="form-group">
    <label class="form-label">é¡å‹</label>
    <select class="form-select" id="lore-category">
      <option value="character">ğŸ‘¥ è§’è‰²</option>
      <option value="location">ğŸ—ºï¸ åœ°é»</option>
      <option value="item">ğŸ“¦ ç‰©å“</option>
      <option value="setting">ğŸ“œ è¨­å®š</option>
    </select>
  </div>
  <div class="form-group">
    <label class="form-label">ç°¡ä»‹</label>
    <input type="text" class="form-input" id="lore-desc" placeholder="ç°¡çŸ­æè¿°">
  </div>
  <div class="form-group">
    <label class="form-label">è©³ç´°å…§å®¹</label>
    <textarea class="form-input" id="lore-content-input" style="min-height:100px" placeholder="è©³ç´°è¨­å®šå…§å®¹ï¼Œæœƒä½œç‚ºä¸Šä¸‹æ–‡ç™¼é€çµ¦ AI"></textarea>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('lore-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="saveLore()">ä¿å­˜</button>
  </div>
</div>
<!-- æ™‚é–“è»¸ç·¨è¼¯ Modal -->
<div class="modal" id="timeline-modal">
  <div class="modal-title">ğŸ“… æ·»åŠ æ™‚é–“é»</div>
  <div class="form-group">
    <label class="form-label">æ™‚é–“æ¨™è¨˜</label>
    <input type="text" class="form-input" id="timeline-label" placeholder="ä¾‹å¦‚ï¼šæ˜­é³³å…ƒå¹´ãƒ»ä¸€æœˆäºŒæ—¥">
  </div>
  <div class="form-group">
    <label class="form-label">äº‹ä»¶æè¿°</label>
    <textarea class="form-input" id="timeline-event" style="min-height:60px" placeholder="é€™å€‹æ™‚é–“é»ç™¼ç”Ÿäº†ä»€éº¼"></textarea>
  </div>
  <div class="form-group">
    <label style="font-size:13px;color:var(--text-secondary);display:flex;align-items:center;gap:6px;cursor:pointer">
      <input type="checkbox" id="timeline-set-current" checked> è¨­ç‚ºç•¶å‰æ•…äº‹æ™‚é–“
    </label>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('timeline-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="saveTimeline()">ä¿å­˜</button>
  </div>
</div>
<!-- iOS å®‰è£æŒ‡å¼• Modal -->
<div class="modal" id="ios-install-modal">
  <div class="modal-title">ğŸ“± åœ¨ iPhone ä¸Šå®‰è£</div>
  <div class="modal-content" style="text-align:center">
    <p style="margin-bottom:16px;font-size:15px">è«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿå®‰è£åˆ°ä¸»ç•«é¢ï¼š</p>
    <div style="text-align:left;background:var(--bg-tertiary);padding:16px;border-radius:8px;margin-bottom:16px">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
        <span style="font-size:24px">1ï¸âƒ£</span>
        <span>é»æ“Šåº•éƒ¨çš„ <strong>åˆ†äº«æŒ‰éˆ•</strong> <span style="font-size:18px">â¬†ï¸</span></span>
      </div>
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
        <span style="font-size:24px">2ï¸âƒ£</span>
        <span>å‘ä¸‹æ»‘å‹•ï¼Œé»æ“Š <strong>ã€ŒåŠ å…¥ä¸»ç•«é¢ã€</strong></span>
      </div>
      <div style="display:flex;align-items:center;gap:12px">
        <span style="font-size:24px">3ï¸âƒ£</span>
        <span>é»æ“Š <strong>ã€Œæ–°å¢ã€</strong> å®Œæˆå®‰è£</span>
      </div>
    </div>
    <p style="font-size:12px;color:var(--text-tertiary)">å®‰è£å¾Œï¼Œç¹”å¤¢æœƒåƒæ™®é€š App ä¸€æ¨£å‡ºç¾åœ¨æ‚¨çš„ä¸»ç•«é¢</p>
  </div>
  <div class="modal-actions">
    <button class="modal-btn confirm" onclick="closeModal('ios-install-modal')">çŸ¥é“äº†</button>
  </div>
</div>
<!-- å‘å°è§’è‰²ç·¨è¼¯ Modal -->
<div class="modal" id="wizard-char-modal">
  <div class="modal-title">ğŸ‘¤ è§’è‰²è¨­å®š</div>
  <input type="hidden" id="wiz-char-idx" value="-1">
  <div class="form-group">
    <label class="form-label">è§’è‰²åç¨±</label>
    <input type="text" class="form-input" id="wiz-char-name" placeholder="å¦‚ï¼šå¤œå¯’ã€é›²æƒœ...">
  </div>
  <div class="form-group">
    <label class="form-label">èº«ä»½åœ°ä½</label>
    <input type="text" class="form-input" id="wiz-char-role" placeholder="å¦‚ï¼šçš‡å¤«ã€è²¼èº«ä¾å¥³...">
  </div>
  <div class="form-group">
    <label class="form-label">æ€§æ ¼ç‰¹é»</label>
    <input type="text" class="form-input" id="wiz-char-personality" placeholder="å¦‚ï¼šæ·±æ²‰è…¹é»‘ã€å¿ èª æ©Ÿæ•...">
  </div>
  <div class="form-group">
    <label class="form-label">èˆ‡ä¸»è§’é—œä¿‚</label>
    <input type="text" class="form-input" id="wiz-char-relation" placeholder="å¦‚ï¼šè¡¨é¢æ­é †æš—æ‡·é‡å¿ƒã€çµ•å°å¿ èª ...">
  </div>
  <div class="form-group">
    <label class="form-label">è©³ç´°æè¿°ï¼ˆå¯é¸ï¼‰</label>
    <textarea class="form-input" id="wiz-char-desc" style="min-height:80px" placeholder="è§’è‰²çš„æ›´å¤šç´°ç¯€..."></textarea>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('wizard-char-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="saveWizardChar()">ä¿å­˜</button>
  </div>
</div>
<!-- èŠå¤©èƒŒæ™¯ Modal -->
<div class="modal" id="chat-bg-modal">
  <div class="modal-title">ğŸ–¼ï¸ èŠå¤©èƒŒæ™¯è¨­ç½®</div>
  <div class="form-group">
    <label class="form-label">é¸æ“‡èƒŒæ™¯</label>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
      <div class="bg-option" data-bg="none" onclick="selectBg('none')" style="aspect-ratio:3/4;background:var(--bg-primary);border:2px solid var(--divider);border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--text-tertiary)">é»˜èª</div>
      <div class="bg-option" data-bg="gradient1" onclick="selectBg('gradient1')" style="aspect-ratio:3/4;background:linear-gradient(135deg,#1a1a2e,#16213e);border:2px solid var(--divider);border-radius:8px;cursor:pointer"></div>
      <div class="bg-option" data-bg="gradient2" onclick="selectBg('gradient2')" style="aspect-ratio:3/4;background:linear-gradient(135deg,#0f0f1a,#1e1e32);border:2px solid var(--divider);border-radius:8px;cursor:pointer"></div>
      <div class="bg-option" data-bg="gradient3" onclick="selectBg('gradient3')" style="aspect-ratio:3/4;background:linear-gradient(135deg,#1a0a0a,#2a1515);border:2px solid var(--divider);border-radius:8px;cursor:pointer"></div>
      <div class="bg-option" data-bg="gradient4" onclick="selectBg('gradient4')" style="aspect-ratio:3/4;background:linear-gradient(135deg,#0a1a0a,#152a15);border:2px solid var(--divider);border-radius:8px;cursor:pointer"></div>
      <div class="bg-option" data-bg="custom" onclick="uploadChatBg()" style="aspect-ratio:3/4;background:var(--bg-tertiary);border:2px dashed var(--divider);border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px">ğŸ“·</div>
    </div>
    <div id="current-bg-preview" style="display:none;margin-bottom:12px">
      <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:6px">ç•¶å‰è‡ªå®šç¾©èƒŒæ™¯ï¼š</div>
      <div id="bg-preview-img" style="width:100%;aspect-ratio:16/9;background-size:cover;background-position:center;border-radius:8px"></div>
      <button class="modal-btn cancel" style="margin-top:8px;width:100%" onclick="clearChatBg()">æ¸…é™¤è‡ªå®šç¾©èƒŒæ™¯</button>
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('chat-bg-modal')">é—œé–‰</button>
  </div>
</div>
<!-- æ•…äº‹ç´šåˆ¥ AI åƒæ•¸è¨­ç½® Modal -->
<div class="modal" id="story-ai-params-modal" style="max-height:85vh;overflow-y:auto">
  <div class="modal-title">ğŸ›ï¸ æœ¬æ•…äº‹ AI åƒæ•¸</div>
  <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:16px">ç‚ºç•¶å‰æ•…äº‹è¨­ç½®ç¨ç«‹çš„ AI åƒæ•¸ï¼Œä¸å½±éŸ¿å…¶ä»–æ•…äº‹</div>
  
  <div style="padding:10px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px">
    <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
      <input type="checkbox" id="story-ai-use-custom" onchange="toggleStoryAICustom(this.checked)" style="width:18px;height:18px">
      <span style="font-size:13px">ä½¿ç”¨è‡ªå®šç¾©åƒæ•¸ï¼ˆå¦å‰‡ä½¿ç”¨å…¨å±€é»˜èªå€¼ï¼‰</span>
    </label>
  </div>
  
  <div id="story-ai-params-container" style="opacity:0.5;pointer-events:none">
    <div class="form-group">
      <label class="form-label" style="display:flex;justify-content:space-between;align-items:center">
        <span>ğŸ¨ å‰µæ„åº¦ (Temperature)</span>
        <span id="story-temp-value" style="color:var(--primary);font-weight:600">0.8</span>
      </label>
      <input type="range" id="story-temp-slider" min="0" max="200" value="80" style="width:100%" oninput="updateStoryAIParam('temperature',this.value/100)">
      <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-tertiary);margin-top:4px">
        <span>ä¿å®ˆç©©å®š</span>
        <span>å‰µæ„å¥”æ”¾</span>
      </div>
    </div>
    
    <div class="form-group">
      <label class="form-label" style="display:flex;justify-content:space-between;align-items:center">
        <span>ğŸ“Š è©å½™å¤šæ¨£æ€§ (Top P)</span>
        <span id="story-topp-value" style="color:var(--primary);font-weight:600">0.9</span>
      </label>
      <input type="range" id="story-topp-slider" min="0" max="100" value="90" style="width:100%" oninput="updateStoryAIParam('topP',this.value/100)">
      <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-tertiary);margin-top:4px">
        <span>ç²¾æº–</span>
        <span>å¤šæ¨£</span>
      </div>
    </div>
    
    <div class="form-group">
      <label class="form-label" style="display:flex;justify-content:space-between;align-items:center">
        <span>ğŸ”„ æ¸›å°‘é‡è¤‡ (Frequency Penalty)</span>
        <span id="story-freq-value" style="color:var(--primary);font-weight:600">0.3</span>
      </label>
      <input type="range" id="story-freq-slider" min="0" max="200" value="30" style="width:100%" oninput="updateStoryAIParam('frequencyPenalty',this.value/100)">
      <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-tertiary);margin-top:4px">
        <span>å…è¨±é‡è¤‡</span>
        <span>å¼·åˆ¶å¤šæ¨£</span>
      </div>
    </div>
    
    <div class="form-group">
      <label class="form-label" style="display:flex;justify-content:space-between;align-items:center">
        <span>ğŸ’¡ é¼“å‹µæ–°è©±é¡Œ (Presence Penalty)</span>
        <span id="story-pres-value" style="color:var(--primary);font-weight:600">0.1</span>
      </label>
      <input type="range" id="story-pres-slider" min="0" max="200" value="10" style="width:100%" oninput="updateStoryAIParam('presencePenalty',this.value/100)">
      <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-tertiary);margin-top:4px">
        <span>å»¶çºŒè©±é¡Œ</span>
        <span>å¼•å…¥æ–°è©±é¡Œ</span>
      </div>
    </div>
    
    <div style="padding:12px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px">
      <div style="font-size:12px;font-weight:600;margin-bottom:8px">ğŸ¯ å¿«é€Ÿé è¨­</div>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
        <button class="modal-btn" style="padding:8px;font-size:12px" onclick="applyStoryAIPreset('creative')">ğŸ¨ å‰µæ„å¯«ä½œ</button>
        <button class="modal-btn" style="padding:8px;font-size:12px" onclick="applyStoryAIPreset('balanced')">âš–ï¸ å¹³è¡¡æ¨¡å¼</button>
        <button class="modal-btn" style="padding:8px;font-size:12px" onclick="applyStoryAIPreset('precise')">ğŸ¯ ç²¾æº–æ•˜äº‹</button>
        <button class="modal-btn" style="padding:8px;font-size:12px" onclick="applyStoryAIPreset('wild')">ğŸŒªï¸ å¤©é¦¬è¡Œç©º</button>
      </div>
    </div>
  </div>
  
  <div id="story-ai-current-info" style="padding:10px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px;font-size:12px">
    <div style="font-weight:600;margin-bottom:6px">ğŸ“‹ ç•¶å‰ç”Ÿæ•ˆåƒæ•¸</div>
    <div id="story-ai-effective-params" style="color:var(--text-secondary)"></div>
  </div>
  
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('story-ai-params-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="saveStoryAIParams()">ä¿å­˜</button>
  </div>
</div>
<!-- AI åƒæ•¸è¨­ç½® Modalï¼ˆå…¨å±€é»˜èªå€¼ï¼‰ -->
<div class="modal" id="ai-params-modal" style="max-height:85vh;overflow-y:auto">
  <div class="modal-title">ğŸ›ï¸ AI åƒæ•¸é»˜èªå€¼</div>
  <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:16px">è¨­ç½®æ–°æ•…äº‹çš„é»˜èª AI åƒæ•¸ï¼Œå·²æœ‰æ•…äº‹å¯åœ¨æ•…äº‹è¨­ç½®ä¸­å–®ç¨èª¿æ•´</div>
  
  <div class="form-group">
    <label class="form-label" style="display:flex;justify-content:space-between;align-items:center">
      <span>ğŸ¨ å‰µæ„åº¦ (Temperature)</span>
      <span id="temp-value" style="color:var(--primary);font-weight:600">0.8</span>
    </label>
    <input type="range" id="temp-slider" min="0" max="200" value="80" style="width:100%" oninput="updateAIParam('temperature',this.value/100)">
    <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-tertiary);margin-top:4px">
      <span>ä¿å®ˆç©©å®š</span>
      <span>å‰µæ„å¥”æ”¾</span>
    </div>
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:6px">0.0-0.5 é©åˆåŠ‡æƒ…æ¨é€²ï¼Œ0.7-1.0 é©åˆå‰µæ„å¯«ä½œï¼Œ1.0+ æ›´éš¨æ©Ÿ</div>
  </div>
  
  <div class="form-group">
    <label class="form-label" style="display:flex;justify-content:space-between;align-items:center">
      <span>ğŸ“Š è©å½™å¤šæ¨£æ€§ (Top P)</span>
      <span id="topp-value" style="color:var(--primary);font-weight:600">0.9</span>
    </label>
    <input type="range" id="topp-slider" min="0" max="100" value="90" style="width:100%" oninput="updateAIParam('topP',this.value/100)">
    <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-tertiary);margin-top:4px">
      <span>ç²¾æº–</span>
      <span>å¤šæ¨£</span>
    </div>
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:6px">æ§åˆ¶è©å½™é¸æ“‡ç¯„åœï¼Œ0.9-1.0 è¼ƒå¸¸ç”¨</div>
  </div>
  
  <div class="form-group">
    <label class="form-label" style="display:flex;justify-content:space-between;align-items:center">
      <span>ğŸ”„ æ¸›å°‘é‡è¤‡ (Frequency Penalty)</span>
      <span id="freq-value" style="color:var(--primary);font-weight:600">0.3</span>
    </label>
    <input type="range" id="freq-slider" min="0" max="200" value="30" style="width:100%" oninput="updateAIParam('frequencyPenalty',this.value/100)">
    <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-tertiary);margin-top:4px">
      <span>å…è¨±é‡è¤‡</span>
      <span>å¼·åˆ¶å¤šæ¨£</span>
    </div>
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:6px">æ¸›å°‘é‡è¤‡ç”¨è©ï¼Œ0.2-0.5 è¼ƒé©åˆ</div>
  </div>
  
  <div class="form-group">
    <label class="form-label" style="display:flex;justify-content:space-between;align-items:center">
      <span>ğŸ’¡ é¼“å‹µæ–°è©±é¡Œ (Presence Penalty)</span>
      <span id="pres-value" style="color:var(--primary);font-weight:600">0.1</span>
    </label>
    <input type="range" id="pres-slider" min="0" max="200" value="10" style="width:100%" oninput="updateAIParam('presencePenalty',this.value/100)">
    <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-tertiary);margin-top:4px">
      <span>å»¶çºŒè©±é¡Œ</span>
      <span>å¼•å…¥æ–°è©±é¡Œ</span>
    </div>
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:6px">é¼“å‹µ AI è«‡è«–æ–°å…§å®¹ï¼Œ0.0-0.3 è¼ƒé©åˆ</div>
  </div>
  
  <div style="padding:12px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px">
    <div style="font-size:12px;font-weight:600;margin-bottom:8px">ğŸ¯ æ¨è–¦é è¨­</div>
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
      <button class="modal-btn" style="padding:8px;font-size:12px" onclick="applyAIPreset('creative')">ğŸ¨ å‰µæ„å¯«ä½œ</button>
      <button class="modal-btn" style="padding:8px;font-size:12px" onclick="applyAIPreset('balanced')">âš–ï¸ å¹³è¡¡æ¨¡å¼</button>
      <button class="modal-btn" style="padding:8px;font-size:12px" onclick="applyAIPreset('precise')">ğŸ¯ ç²¾æº–æ•˜äº‹</button>
      <button class="modal-btn" style="padding:8px;font-size:12px" onclick="applyAIPreset('wild')">ğŸŒªï¸ å¤©é¦¬è¡Œç©º</button>
    </div>
  </div>
  
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('ai-params-modal')">é—œé–‰</button>
  </div>
</div>
<!-- å¿«æ·æŒ‡ä»¤ç®¡ç† Modal -->
<div class="modal" id="quick-cmd-modal" style="max-height:85vh;overflow-y:auto">
  <div class="modal-title">âš¡ å¿«æ·æŒ‡ä»¤ç®¡ç†</div>
  <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:16px">
    è‡ªå®šç¾©å¿«æ·æŒ‰éˆ•ï¼Œé»æ“Šå¾Œæœƒè‡ªå‹•ç™¼é€å°æ‡‰æŒ‡ä»¤çµ¦ AI
  </div>
  
  <div id="quick-cmd-list" style="margin-bottom:16px">
    <!-- å‹•æ…‹æ¸²æŸ“ -->
  </div>
  
  <div style="padding:12px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px">
    <div style="font-size:12px;font-weight:600;margin-bottom:10px">â• æ·»åŠ æ–°æŒ‡ä»¤</div>
    <div class="form-group" style="margin-bottom:10px">
      <input type="text" class="form-input" id="new-cmd-label" placeholder="æŒ‰éˆ•é¡¯ç¤ºæ–‡å­—ï¼ˆå¦‚ï¼šå›æ†¶ï¼‰" maxlength="10">
    </div>
    <div class="form-group" style="margin-bottom:10px">
      <input type="text" class="form-input" id="new-cmd-content" placeholder="ç™¼é€çµ¦AIçš„æŒ‡ä»¤ï¼ˆå¦‚ï¼šå›æ†¶éå»çš„äº‹æƒ…ï¼‰">
    </div>
    <button class="modal-btn confirm" style="width:100%" onclick="addQuickCommand()">æ·»åŠ </button>
  </div>
  
  <div style="padding:10px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px;font-size:11px;color:var(--text-tertiary)">
    <div style="font-weight:600;margin-bottom:6px">ğŸ’¡ æç¤º</div>
    <div>â€¢ æ‹–å‹•æŒ‡ä»¤å¯èª¿æ•´é †åº</div>
    <div>â€¢ é¡¯ç¤ºæ–‡å­—å»ºè­° 2-4 å€‹å­—</div>
    <div>â€¢ æŒ‡ä»¤å…§å®¹æœƒç›´æ¥ç™¼é€çµ¦ AI</div>
  </div>
  
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="resetQuickCommands()">æ¢å¾©é»˜èª</button>
    <button class="modal-btn confirm" onclick="closeModal('quick-cmd-modal')">å®Œæˆ</button>
  </div>
</div>
<!-- ç·¨è¼¯å¿«æ·æŒ‡ä»¤ Modal -->
<div class="modal" id="edit-cmd-modal">
  <div class="modal-title">âœï¸ ç·¨è¼¯å¿«æ·æŒ‡ä»¤</div>
  <input type="hidden" id="edit-cmd-id">
  <div class="form-group">
    <label class="form-label">æŒ‰éˆ•é¡¯ç¤ºæ–‡å­—</label>
    <input type="text" class="form-input" id="edit-cmd-label" placeholder="å¦‚ï¼šå›æ†¶" maxlength="10">
  </div>
  <div class="form-group">
    <label class="form-label">ç™¼é€çµ¦AIçš„æŒ‡ä»¤</label>
    <input type="text" class="form-input" id="edit-cmd-content" placeholder="å¦‚ï¼šå›æ†¶éå»çš„äº‹æƒ…">
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('edit-cmd-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="saveEditQuickCommand()">ä¿å­˜</button>
  </div>
</div>
<!-- å ´æ™¯ç®¡ç† Modal -->
<div class="modal" id="scene-modal" style="max-height:85vh;overflow-y:auto">
  <div class="modal-title">ğŸ¬ å ´æ™¯ç®¡ç†</div>
  <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:16px">
    è¨­ç½®ç•¶å‰å ´æ™¯ä¸­åœ¨å ´çš„è§’è‰²ï¼ŒAI æœƒè®“é€™äº›è§’è‰²äº’å‹•
  </div>
  
  <div style="margin-bottom:16px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <span style="font-size:13px;font-weight:600">ç•¶å‰å ´æ™¯</span>
      <select class="form-select" id="current-scene" style="width:auto;min-width:120px" onchange="switchScene(this.value)">
        <option value="">ç„¡å ´æ™¯</option>
      </select>
    </div>
    <div style="font-size:11px;color:var(--text-tertiary)">é¸æ“‡å ´æ™¯å¾Œï¼ŒAI æœƒæ ¹æ“šåœ¨å ´è§’è‰²é€²è¡Œå¤šè§’è‰²äº’å‹•</div>
  </div>
  
  <div style="padding:12px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px">
    <div style="font-size:12px;font-weight:600;margin-bottom:10px">ğŸ“‹ å ´æ™¯åˆ—è¡¨</div>
    <div id="scene-list" style="max-height:200px;overflow-y:auto">
      <!-- å‹•æ…‹æ¸²æŸ“ -->
    </div>
    <button class="modal-btn" style="width:100%;margin-top:10px" onclick="createNewScene()">â• å‰µå»ºæ–°å ´æ™¯</button>
  </div>
  
  <div id="scene-detail-section" style="display:none">
    <div style="padding:12px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px">
      <div style="font-size:12px;font-weight:600;margin-bottom:10px">ğŸ‘¥ åœ¨å ´è§’è‰²</div>
      <div id="scene-characters" style="max-height:200px;overflow-y:auto">
        <!-- å‹•æ…‹æ¸²æŸ“ -->
      </div>
    </div>
  </div>
  
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('scene-modal')">é—œé–‰</button>
  </div>
</div>
<!-- å‰µå»º/ç·¨è¼¯å ´æ™¯ Modal -->
<div class="modal" id="scene-edit-modal">
  <div class="modal-title" id="scene-edit-title">å‰µå»ºå ´æ™¯</div>
  <input type="hidden" id="scene-edit-id">
  <div class="form-group">
    <label class="form-label">å ´æ™¯åç¨±</label>
    <input type="text" class="form-input" id="scene-edit-name" placeholder="å¦‚ï¼šæ—©æœã€å®´æœƒã€å¾Œå®®èŠ±åœ’...">
  </div>
  <div class="form-group">
    <label class="form-label">å ´æ™¯æè¿°ï¼ˆå¯é¸ï¼‰</label>
    <textarea class="form-textarea" id="scene-edit-desc" rows="2" placeholder="æè¿°é€™å€‹å ´æ™¯çš„æ°›åœã€æ™‚é–“ã€åœ°é»ç­‰..."></textarea>
  </div>
  <div class="form-group">
    <label class="form-label">é¸æ“‡åœ¨å ´è§’è‰²</label>
    <div id="scene-char-selector" style="max-height:200px;overflow-y:auto;padding:8px;background:var(--bg-tertiary);border-radius:8px">
      <!-- å‹•æ…‹æ¸²æŸ“è§’è‰²è¤‡é¸æ¡† -->
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('scene-edit-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="saveScene()">ä¿å­˜</button>
  </div>
</div>
<!-- ç©å®¶é¢æ¿ Modal -->
<div class="modal" id="player-panel-modal" style="max-height:85vh;overflow-y:auto">
  <div class="modal-title">ğŸ‘¤ æˆ‘çš„ç‹€æ…‹</div>
  <div id="player-panel-content">
    <div style="text-align:center;padding:24px;color:var(--text-tertiary)">
      <div style="font-size:32px;margin-bottom:12px">ğŸ“‹</div>
      <div style="font-size:14px">é‚„æ²’æœ‰è¨­ç½®ç‹€æ…‹é¢æ¿</div>
      <div style="font-size:12px;margin-top:4px">é»æ“Šä¸‹æ–¹æŒ‰éˆ•å‰µå»º</div>
    </div>
  </div>
  <button class="player-sync-btn" id="player-sync-btn" onclick="aiSyncPlayerStatus()" style="display:none">
    ğŸ¤– AI æ™ºèƒ½åŒæ­¥ï¼ˆå¾å°è©±ä¸­è§£ææ•¸å€¼è®ŠåŒ–ï¼‰
  </button>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('player-panel-modal')">é—œé–‰</button>
    <button class="modal-btn" style="background:var(--bg-tertiary);color:var(--text-primary)" onclick="showPlayerPanelSetup()">âš™ï¸ è¨­ç½®é¢æ¿</button>
    <button class="modal-btn confirm" onclick="manualUpdatePlayerPanel()">âœï¸ æ›´æ–°æ•¸å€¼</button>
  </div>
</div>
<!-- ç©å®¶é¢æ¿è¨­ç½® Modal -->
<div class="modal" id="player-panel-setup-modal" style="max-height:85vh;overflow-y:auto">
  <div class="modal-title">âš™ï¸ è¨­ç½®æˆ‘çš„ç‹€æ…‹é¢æ¿</div>
  <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:16px">
    è‡ªå®šç¾©è¦è¿½è¹¤çš„å±¬æ€§ï¼ŒAI æœƒåœ¨å›è¦†ä¸­è‡ªå‹•æ›´æ–°é€™äº›æ•¸å€¼
  </div>
  <div class="form-group">
    <label class="form-label">é¢æ¿åç¨±</label>
    <input type="text" class="form-input" id="player-panel-name" placeholder="å¦‚ï¼šè§’è‰²ç‹€æ…‹ã€æˆ‘çš„è³‡æ–™...">
  </div>
  <div class="form-group">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <label class="form-label" style="margin:0">å±¬æ€§åˆ—è¡¨</label>
      <button class="action-btn secondary" style="padding:4px 10px;font-size:12px" onclick="addPlayerAttribute()">â• æ·»åŠ </button>
    </div>
    <div id="player-attr-list" style="max-height:300px;overflow-y:auto">
      <div style="text-align:center;padding:16px;color:var(--text-tertiary);font-size:13px">é‚„æ²’æœ‰å±¬æ€§ï¼Œé»æ“Šæ·»åŠ </div>
    </div>
  </div>
  <div class="form-group">
    <button class="action-btn secondary" style="width:100%" onclick="aiGeneratePlayerPanel()">ğŸ¤– AI æ ¹æ“šè¨­å®šè‡ªå‹•ç”Ÿæˆ</button>
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:6px;text-align:center">AI æœƒæ ¹æ“šæ•…äº‹çš„ System Prompt å’Œ Lorebook è‡ªå‹•æ¨è–¦é©åˆçš„å±¬æ€§</div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('player-panel-setup-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="savePlayerPanelSetup()">ä¿å­˜</button>
  </div>
</div>
<!-- æ·»åŠ /ç·¨è¼¯ç©å®¶å±¬æ€§ Modal -->
<div class="modal" id="player-attr-modal">
  <div class="modal-title" id="player-attr-modal-title">â• æ·»åŠ å±¬æ€§</div>
  <input type="hidden" id="player-attr-edit-index" value="-1">
  <div class="form-group">
    <label class="form-label">å±¬æ€§åç¨±</label>
    <input type="text" class="form-input" id="player-attr-name" placeholder="å¦‚ï¼šç¾é‡‘ã€é«”åŠ›ã€å¥½æ„Ÿåº¦...">
  </div>
  <div class="form-group">
    <label class="form-label">åœ–æ¨™</label>
    <input type="text" class="form-input" id="player-attr-icon" placeholder="ğŸ’°" maxlength="2" style="width:60px">
  </div>
  <div class="form-group">
    <label class="form-label">æ‰€å±¬åˆ†çµ„</label>
    <div id="player-attr-group-selector" class="group-selector">
      <span class="group-chip active" data-group="default" onclick="selectAttrGroup(this)">ğŸ“Š é è¨­</span>
      <span class="group-chip" data-group="stats" onclick="selectAttrGroup(this)">ğŸ’ª åŸºç¤å±¬æ€§</span>
      <span class="group-chip" data-group="status" onclick="selectAttrGroup(this)">â¤ï¸ ç•¶å‰ç‹€æ…‹</span>
      <span class="group-chip" data-group="finance" onclick="selectAttrGroup(this)">ğŸ’° è²¡å‹™</span>
      <span class="group-chip" data-group="custom" onclick="selectAttrGroup(this)">âœ¨ è‡ªå®šç¾©</span>
    </div>
    <input type="hidden" id="player-attr-group" value="default">
    <div id="player-attr-custom-group" style="display:none;margin-top:8px">
      <input type="text" class="form-input" id="player-attr-custom-group-name" placeholder="è¼¸å…¥è‡ªå®šç¾©åˆ†çµ„åç¨±">
    </div>
  </div>
  <div class="form-group">
    <label class="form-label">é¡å‹</label>
    <select class="form-select" id="player-attr-type" onchange="updatePlayerAttrTypeUI()">
      <option value="number">æ•¸å­—ï¼ˆå¦‚ï¼šé‡‘éŒ¢ã€å¤©æ•¸ï¼‰</option>
      <option value="percent">ç™¾åˆ†æ¯”ï¼ˆå¦‚ï¼šé«”åŠ›ã€å¥½æ„Ÿåº¦ï¼‰</option>
      <option value="text">æ–‡å­—ï¼ˆå¦‚ï¼šè·ä½ã€ç¨±è™Ÿï¼‰</option>
    </select>
  </div>
  <div class="form-group">
    <label class="form-label">é¡è‰²</label>
    <div class="group-selector">
      <span class="group-chip active" data-color="default" onclick="selectAttrColor(this)" style="border-left:3px solid var(--primary)">é è¨­</span>
      <span class="group-chip" data-color="red" onclick="selectAttrColor(this)" style="border-left:3px solid #EF4444">ç´…</span>
      <span class="group-chip" data-color="orange" onclick="selectAttrColor(this)" style="border-left:3px solid #F59E0B">æ©™</span>
      <span class="group-chip" data-color="green" onclick="selectAttrColor(this)" style="border-left:3px solid #10B981">ç¶ </span>
      <span class="group-chip" data-color="blue" onclick="selectAttrColor(this)" style="border-left:3px solid #3B82F6">è—</span>
      <span class="group-chip" data-color="purple" onclick="selectAttrColor(this)" style="border-left:3px solid #8B5CF6">ç´«</span>
      <span class="group-chip" data-color="pink" onclick="selectAttrColor(this)" style="border-left:3px solid #EC4899">ç²‰</span>
    </div>
    <input type="hidden" id="player-attr-color" value="default">
  </div>
  <div id="player-attr-type-options">
    <div class="form-group">
      <label class="form-label">åˆå§‹å€¼</label>
      <input type="text" class="form-input" id="player-attr-default" placeholder="0">
    </div>
    <div class="form-group" id="player-attr-max-group">
      <label class="form-label">æœ€å¤§å€¼ï¼ˆç™¾åˆ†æ¯”ç”¨ï¼‰</label>
      <input type="number" class="form-input" id="player-attr-max" value="100">
    </div>
  </div>
  <div class="form-group">
    <label class="form-label">è§¸ç™¼é—œéµè©ï¼ˆç”¨æ–¼è‡ªå‹•è§£æï¼‰</label>
    <input type="text" class="form-input" id="player-attr-keywords" placeholder="å¦‚ï¼šç¾é‡‘, é¤˜é¡, é‡‘éŒ¢">
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">AI å›è¦†ä¸­åŒ…å«é€™äº›è©æ™‚æœƒå˜—è©¦æ›´æ–°æ­¤å±¬æ€§</div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('player-attr-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="savePlayerAttribute()">ä¿å­˜</button>
  </div>
</div>
<!-- æ‰‹å‹•æ›´æ–°ç©å®¶æ•¸å€¼ Modal -->
<div class="modal" id="player-update-modal" style="max-height:85vh;overflow-y:auto">
  <div class="modal-title">âœï¸ æ›´æ–°æˆ‘çš„ç‹€æ…‹</div>
  <div id="player-update-fields"></div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('player-update-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="savePlayerUpdate()">ä¿å­˜</button>
  </div>
</div>
<!-- AIç”ŸæˆLorebook Modal -->
<div class="modal" id="ai-lorebook-modal" style="max-width:min(95%,500px);max-height:85vh;overflow-y:auto">
  <div class="modal-title">ğŸ¤– AI è‡ªå‹•ç”Ÿæˆ Lorebook</div>
  <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:16px">
    è²¼å…¥ä½ çš„è¨­å®šæ›¸/Promptï¼ŒAI æœƒè‡ªå‹•æ‹†åˆ†æˆå¤šå€‹ Lorebook æ¢ç›®
  </div>
  <div class="form-group">
    <label class="form-label">è¨­å®šæ›¸å…§å®¹</label>
    <textarea class="form-input" id="ai-lorebook-input" style="min-height:200px;font-size:13px" placeholder="è²¼å…¥ä½ çš„è¨­å®šæ›¸ã€ä¸–ç•Œè§€ã€è§’è‰²è¨­å®šã€åƒ¹ç›®è¡¨ç­‰å…§å®¹..."></textarea>
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">æ”¯æŒ Markdown æ ¼å¼ï¼ŒAI æœƒæ ¹æ“šæ¨™é¡Œå’Œå…§å®¹è‡ªå‹•æ‹†åˆ†</div>
  </div>
  <div class="form-group">
    <label class="form-label">ç”Ÿæˆé¸é …</label>
    <div style="display:flex;flex-direction:column;gap:8px">
      <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer">
        <input type="checkbox" id="ai-lorebook-chars" checked> æå–è§’è‰²è¨­å®šç‚ºè§’è‰²å¡
      </label>
      <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer">
        <input type="checkbox" id="ai-lorebook-player" checked> æå–ç©å®¶å±¬æ€§åˆ°ç‹€æ…‹é¢æ¿
      </label>
    </div>
  </div>
  <div id="ai-lorebook-preview" style="display:none;margin-bottom:16px">
    <div style="font-size:13px;font-weight:600;margin-bottom:8px">ğŸ“‹ é è¦½</div>
    <div id="ai-lorebook-preview-content" style="max-height:200px;overflow-y:auto;background:var(--bg-tertiary);border-radius:8px;padding:12px;font-size:12px"></div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('ai-lorebook-modal')">å–æ¶ˆ</button>
    <button class="modal-btn" id="ai-lorebook-generate-btn" style="background:var(--primary);color:white" onclick="generateAiLorebook()">ğŸ¤– é–‹å§‹ç”Ÿæˆ</button>
  </div>
</div>
<!-- ç°¡ç¹è½‰æ›è¨­ç½® Modal -->
<div class="modal" id="cn-convert-modal">
  <div class="modal-title">ğŸŒ è¯­è¨€è®¾ç½®</div>
  <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:16px">
    è®¾ç½®ç•Œé¢è¯­è¨€å’Œ AI è¾“å‡ºè¯­è¨€
  </div>
  <div class="form-group">
    <label class="form-label">ç•Œé¢è¯­è¨€</label>
    <select class="form-select" id="ui-language-mode" onchange="updateCnConvertPreview()">
      <option value="sc">ç®€ä½“ä¸­æ–‡</option>
      <option value="tc">ç¹é«”ä¸­æ–‡</option>
    </select>
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:6px">
      åˆ‡æ¢ç»‡æ¢¦ç•Œé¢çš„æ˜¾ç¤ºè¯­è¨€
    </div>
  </div>
  <div class="form-group">
    <label class="form-label">AI è¾“å‡ºè¯­è¨€</label>
    <select class="form-select" id="cn-convert-mode" onchange="updateCnConvertPreview()">
      <option value="follow">è·Ÿéšç•Œé¢è¯­è¨€</option>
      <option value="none">ä¸æŒ‡å®šï¼ˆAI é»˜è®¤ï¼‰</option>
      <option value="s2t">ç¹é«”ä¸­æ–‡ï¼ˆå°ç£/é¦™æ¸¯ï¼‰</option>
      <option value="t2s">ç®€ä½“ä¸­æ–‡ï¼ˆä¸­å›½å¤§é™†ï¼‰</option>
    </select>
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:6px">
      æŒ‡ç¤º AI ç”¨å“ªç§ä¸­æ–‡å›å¤
    </div>
  </div>
  <div style="padding:10px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px;font-size:12px">
    <div style="font-weight:600;margin-bottom:6px">ğŸ’¡ æ•ˆæœè¯´æ˜</div>
    <div id="cn-convert-preview" style="color:var(--text-secondary)">
      ç•Œé¢å’Œ AI éƒ½ä½¿ç”¨ç®€ä½“ä¸­æ–‡
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('cn-convert-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="saveChineseConvert()">ä¿å­˜</button>
  </div>
</div>
<!-- æ¨¡æ¿è®Šé‡è¨­ç½® Modal -->
<div class="modal" id="template-vars-modal">
  <div class="modal-title">ğŸ“ æ¨¡æ¿è®Šé‡è¨­ç½®</div>
  <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:16px">
    è¨­ç½®é€™äº›è®Šé‡å¾Œï¼Œå¯ä»¥åœ¨æŒ‡ä»¤å’Œ Lorebook ä¸­ä½¿ç”¨ <code style="background:var(--bg-tertiary);padding:2px 4px;border-radius:3px">{{è®Šé‡å}}</code> å¼•ç”¨
  </div>
  
  <div class="form-group">
    <label class="form-label">{{user}} - ç©å®¶ç¨±å‘¼</label>
    <input type="text" class="form-input" id="var-player-name" placeholder="ä½ ã€é™›ä¸‹ã€å°‘ä¿ ..." value="">
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">AI ç¨±å‘¼ç©å®¶æ™‚ä½¿ç”¨çš„åå­—</div>
  </div>
  
  <div class="form-group">
    <label class="form-label">{{location}} - ç•¶å‰åœ°é»</label>
    <input type="text" class="form-input" id="var-location" placeholder="é•·æ¨‚å®®ã€èšè³¢èŠ..." value="">
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">æ•…äº‹ç•¶å‰ç™¼ç”Ÿçš„åœ°é»</div>
  </div>
  
  <div style="padding:12px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px">
    <div style="font-size:12px;font-weight:600;margin-bottom:8px">ğŸ“‹ å¯ç”¨è®Šé‡åˆ—è¡¨</div>
    <div style="font-size:11px;color:var(--text-secondary);line-height:1.8">
      <div><code>{{user}}</code> â†’ ç©å®¶ç¨±å‘¼</div>
      <div><code>{{location}}</code> â†’ ç•¶å‰åœ°é»</div>
      <div><code>{{time}}</code> â†’ æ•…äº‹æ™‚é–“ï¼ˆå¾æ™‚é–“è»¸è®€å–ï¼‰</div>
      <div><code>{{date}}</code> â†’ ç¾å¯¦æ—¥æœŸ</div>
      <div><code>{{char:è§’è‰²å}}</code> â†’ æŒ‡å®šè§’è‰²çš„ä¿¡æ¯</div>
    </div>
  </div>
  
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('template-vars-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="saveTemplateVars()">ä¿å­˜</button>
  </div>
</div>
<!-- Persona é¸æ“‡å™¨ Modal -->
<div class="modal" id="persona-selector-modal">
  <div class="modal-title">ğŸ‘¤ é¸æ“‡èº«ä»½</div>
  <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:16px">
    é¸æ“‡ä½ åœ¨æ•…äº‹ä¸­æ‰®æ¼”çš„è§’è‰²èº«ä»½ï¼ŒAI æœƒæ ¹æ“šä½ çš„èº«ä»½èª¿æ•´å›æ‡‰
  </div>
  <div id="persona-list" style="max-height:calc(85vh - 200px);overflow-y:auto;margin-bottom:16px">
    <!-- å‹•æ…‹æ¸²æŸ“ -->
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('persona-selector-modal')">å–æ¶ˆ</button>
    <button class="modal-btn" onclick="showPersonaManager()" style="background:var(--bg-tertiary);color:var(--text-primary)">âš™ï¸ ç®¡ç†èº«ä»½</button>
  </div>
</div>
<!-- Persona ç·¨è¼¯ Modal -->
<div class="modal" id="persona-edit-modal">
  <div class="modal-title" id="persona-edit-title">âœ¨ å‰µå»ºæ–°èº«ä»½</div>
  <input type="hidden" id="persona-edit-id" value="">

  <div style="max-height:calc(85vh - 160px);overflow-y:auto;margin-bottom:16px">
    <div class="form-group">
      <label class="form-label">é ­åƒ</label>
      <input type="text" class="form-input" id="persona-avatar" placeholder="ğŸ‘¸" maxlength="2">
      <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">è¼¸å…¥ä¸€å€‹ emoji æˆ–ç•™ç©ºä½¿ç”¨é»˜èª ğŸ‘¤</div>
    </div>

    <div class="form-group">
      <label class="form-label">åç¨± *</label>
      <input type="text" class="form-input" id="persona-name" placeholder="æ—å©‰å„¿">
    </div>

    <div class="form-group">
      <label class="form-label">ç°¡ä»‹</label>
      <input type="text" class="form-input" id="persona-description" placeholder="æ±Ÿå—å¯Œå•†ä¹‹å¥³ï¼ŒçŸ¥æ›¸é”ç†ï¼Œæº«å©‰å¯äºº">
    </div>

    <div class="form-group">
      <label class="form-label">èƒŒæ™¯æ•…äº‹</label>
      <textarea class="form-input" id="persona-background" placeholder="æ—å®¶æ˜¯æ±Ÿå—é¦–å¯Œï¼Œå©‰å„¿è‡ªå¹¼é£½è®€è©©æ›¸..." rows="3"></textarea>
    </div>

    <div class="form-group">
      <label class="form-label">èªªè©±é¢¨æ ¼</label>
      <input type="text" class="form-input" id="persona-speech-style" placeholder="èªªè©±æº«æŸ”ï¼Œå¸¸ç”¨ã€Œå¥´å®¶ã€è‡ªç¨±">
    </div>

    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;font-size:12px;color:var(--text-secondary)">
      <div style="font-weight:600;margin-bottom:6px">ğŸ’¡ æç¤º</div>
      <div style="line-height:1.6">
        â€¢ è¨­ç½®è©³ç´°çš„èƒŒæ™¯æ•…äº‹å¯ä»¥è®“ AI æ›´å¥½åœ°ç†è§£ä½ çš„è§’è‰²<br>
        â€¢ èªªè©±é¢¨æ ¼æœƒå½±éŸ¿ AI å°ä½ çš„å›æ‡‰æ–¹å¼<br>
        â€¢ åˆ‡æ›èº«ä»½å¾Œï¼Œå»ºè­°é–‹å•Ÿæ–°å°è©±ä»¥ç²å¾—æœ€ä½³æ•ˆæœ
      </div>
    </div>
  </div>

  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('persona-edit-modal')">å–æ¶ˆ</button>
    <button class="modal-btn confirm" onclick="savePersona()">ä¿å­˜</button>
  </div>
</div>
<!-- Persona ç®¡ç† Modal -->
<div class="modal" id="persona-manager-modal">
  <div class="modal-title">âš™ï¸ ç®¡ç†èº«ä»½</div>
  <div id="persona-manager-list" style="max-height:calc(85vh - 200px);overflow-y:auto;margin-bottom:16px">
    <!-- å‹•æ…‹æ¸²æŸ“ -->
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('persona-manager-modal')">é—œé–‰</button>
    <button class="modal-btn confirm" onclick="createNewPersona()">+ å‰µå»ºæ–°èº«ä»½</button>
  </div>
</div>
<!-- éš±è—è¼¸å…¥ -->
<input type="file" id="file-input" accept=".md,.txt,.json" style="display:none">
<input type="file" id="import-input" accept=".json" style="display:none">
<script>
// å…¨å±€ç‹€æ…‹
let db, story=null, msgs=[], hist=['view-stories'], generating=false, typingCtrl=null, selMsgId=null, confirmCb=null, inputCb=null, editApiId=null;
let settings={theme:'dark',screen:'phone',consist:true,summary:true,suggest:true,typingSpeed:30,contextCount:20,maxTokens:4096,sendKey:'enter',chatBg:'none',chatBgImage:'',fontSize:16,lineHeight:1.8,
  // AI åƒæ•¸
  temperature:0.8,topP:0.9,frequencyPenalty:0.3,presencePenalty:0.1,
  // æ¨¡æ¿è®Šé‡
  playerName:'ä½ ',currentLocation:'',
  // ç°¡ç¹è½‰æ›
  chineseConvert:'t2s',
  uiLanguage:'sc',  // sc=ç®€ä½“, tc=ç¹ä½“
  // æµå¼éŸ¿æ‡‰
  enableStreaming:true,streamingChunkDelay:20
};

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded',async()=>{
  initOpenCC(); // åˆå§‹åŒ– OpenCC è½¬æ¢å™¨
  await initDB();
  await loadSettings();
  
  // ç¡®ä¿ OpenCC åˆå§‹åŒ–å®Œæˆåå†è½¬æ¢ç•Œé¢
  // å¦‚æœ OpenCC è¿˜æ²¡åŠ è½½å®Œï¼Œç­‰å¾…å¹¶é‡è¯•
  const tryTranslate = (retries = 5) => {
    if(!openccT2S && typeof OpenCC !== 'undefined'){
      initOpenCC();
    }
    if(openccT2S){
      translateUI();
    } else if(retries > 0){
      setTimeout(() => tryTranslate(retries - 1), 100);
    }
  };
  tryTranslate();
  
  await renderStories();
  await renderInst();
  await renderApi();
  await renderQuickCommands();
  initTypingCancel(); // åˆå§‹åŒ–æ‰“å­—æ©Ÿå–æ¶ˆåŠŸèƒ½
  updateTime();
  setInterval(updateTime,60000);
});

// æ•¸æ“šåº«
async function initDB(){
  db=new Dexie('ZhimengDB');
  db.version(7).stores({
    stories:'id,title,createdAt,updatedAt,isPinned',
    messages:'id,storyId,branchId,[storyId+branchId],createdAt',
    branches:'id,storyId,parentBranchId,createdAt',
    instructions:'id,createdAt',
    storyInstructions:'[storyId+instructionId],storyId,instructionId',
    loreEntries:'id,storyId,category,createdAt',
    foreshadowing:'id,storyId,messageId,isResolved,createdAt',
    events:'id,storyId,messageId,createdAt',
    characterStates:'id,storyId,loreEntryId',
    timeline:'id,storyId,messageId,order',
    saves:'id,storyId,slotIndex,isAuto,createdAt',
    apiPresets:'id,isActive,createdAt',
    settings:'key',
    chapters:'id,storyId,messageId,order,createdAt',
    bookmarks:'id,storyId,messageId,createdAt',
    plotTags:'id,storyId,messageId,type,createdAt',
    // v7 æ–°å¢ï¼šè§’è‰²ç³»çµ±
    characters:'id,storyId,name,createdAt,updatedAt',
    characterSnapshots:'id,storyId,createdAt',
    characterHistory:'id,storyId,characterId,createdAt',
    // v13 æ–°å¢ï¼šLorebook ç³»çµ±
    lorebook:'id,storyId,name,isEnabled,priority,createdAt',
    lorebookTriggerLog:'id,storyId,lorebookId,createdAt',
    // v16 æ–°å¢ï¼šå¿«æ·æŒ‡ä»¤
    quickCommands:'id,order,createdAt',
    // v16 æ–°å¢ï¼šå ´æ™¯ç³»çµ±
    scenes:'id,storyId,name,isActive,createdAt',
    // v22 æ–°å¢ï¼šPersona ç³»çµ±
    personas:'id,name,createdAt',
    // v23 æ–°å¢ï¼šç©å®¶é¢æ¿ç³»çµ±
    playerPanels:'id,storyId,createdAt'
  });
  
  // v8 æ–°å¢ï¼šè§’è‰²å¡ V2 å­—æ®µï¼ˆCharacter Card V2 è¦ç¯„ï¼‰
  // Dexie æœƒè‡ªå‹•è™•ç†å‡ç´šï¼ŒèˆŠæ•¸æ“šæœƒä¿ç•™
  db.version(8).stores({
    stories:'id,title,createdAt,updatedAt,isPinned',
    messages:'id,storyId,branchId,[storyId+branchId],createdAt',
    branches:'id,storyId,parentBranchId,createdAt',
    instructions:'id,createdAt',
    storyInstructions:'[storyId+instructionId],storyId,instructionId',
    loreEntries:'id,storyId,category,createdAt',
    foreshadowing:'id,storyId,messageId,isResolved,createdAt',
    events:'id,storyId,messageId,createdAt',
    characterStates:'id,storyId,loreEntryId',
    timeline:'id,storyId,messageId,order',
    saves:'id,storyId,slotIndex,isAuto,createdAt',
    apiPresets:'id,isActive,createdAt',
    settings:'key',
    chapters:'id,storyId,messageId,order,createdAt',
    bookmarks:'id,storyId,messageId,createdAt',
    plotTags:'id,storyId,messageId,type,createdAt',
    // v8 å‡ç´šï¼šè§’è‰²ç³»çµ± V2ï¼ˆæ”¯æŒ Character Card V2 è¦ç¯„ï¼‰
    // æ–°å¢å­—æ®µï¼šcategory, relationships, scenario, first_mes, alternate_greetings,
    //          mes_example, system_prompt, post_history_instructions, character_book,
    //          expressions, creator_notes, creator, character_version
    characters:'id,storyId,name,category,createdAt,updatedAt',
    characterSnapshots:'id,storyId,createdAt',
    characterHistory:'id,storyId,characterId,createdAt',
    lorebook:'id,storyId,name,isEnabled,priority,createdAt',
    lorebookTriggerLog:'id,storyId,lorebookId,createdAt',
    quickCommands:'id,order,createdAt',
    scenes:'id,storyId,name,isActive,createdAt',
    personas:'id,name,createdAt',
    playerPanels:'id,storyId,createdAt'
  });
  
  await db.open();
  // åˆå§‹åŒ–é»˜èªå¿«æ·æŒ‡ä»¤
  await initDefaultQuickCommands();
  // åˆå§‹åŒ–é»˜èª Persona
  await initDefaultPersona();
}

// è¨­ç½®
async function loadSettings(){
  try{
    const s=await db.settings.toArray();
    s.forEach(x=>{if(x.key in settings)settings[x.key]=x.value});
    applySettings();
  }catch(e){}
}
async function saveSetting(k,v){await db.settings.put({key:k,value:v});settings[k]=v;}
function applySettings(){
  const isSC = settings.uiLanguage === 'sc';
  document.documentElement.setAttribute('data-theme',settings.theme);
  document.getElementById('theme-val').textContent=settings.theme==='dark'?(isSC?'æ·±è‰²æ¨¡å¼ â€º':'æ·±è‰²æ¨¡å¼ â€º'):(isSC?'æµ…è‰²æ¨¡å¼ â€º':'æ·ºè‰²æ¨¡å¼ â€º');
  const app=document.getElementById('app');
  if(settings.screen==='fullscreen'){app.classList.add('fullscreen');document.getElementById('screen-val').textContent=isSC?'å…¨å±æ¨¡å¼ â€º':'å…¨å±æ¨¡å¼ â€º';}
  else{app.classList.remove('fullscreen');document.getElementById('screen-val').textContent=isSC?'æ‰‹æœºæ¨¡æ‹Ÿå™¨ â€º':'æ‰‹æ©Ÿæ¨¡æ“¬å™¨ â€º';}
  ['consist','summary','suggest'].forEach(k=>{const t=document.getElementById('tog-'+k);if(t){if(settings[k])t.classList.add('active');else t.classList.remove('active');}});
  // æ–°å¢è¨­ç½®é …çš„é¡¯ç¤º
  const ctxVal=document.getElementById('context-val');if(ctxVal)ctxVal.textContent=settings.contextCount+(isSC?'æ¡æ¶ˆæ¯ â€º':'æ¢æ¶ˆæ¯ â€º');
  const maxVal=document.getElementById('max-tokens-val');if(maxVal)maxVal.textContent=settings.maxTokens+' â€º';
  const typVal=document.getElementById('typing-speed-val');if(typVal)typVal.textContent=settings.typingSpeed===0?(isSC?'å…³é—­ â€º':'é—œé–‰ â€º'):settings.typingSpeed+'ms â€º';
  const keyVal=document.getElementById('send-key-val');if(keyVal)keyVal.textContent=settings.sendKey==='enter'?'Enter â€º':'Ctrl+Enter â€º';
  // èŠå¤©èƒŒæ™¯é¡¯ç¤º
  const bgVal=document.getElementById('chat-bg-val');
  if(bgVal){
    if(settings.chatBg==='custom'&&settings.chatBgImage)bgVal.textContent=isSC?'è‡ªå®šä¹‰ â€º':'è‡ªå®šç¾© â€º';
    else if(settings.chatBg==='none')bgVal.textContent=isSC?'é»˜è®¤ â€º':'é»˜èª â€º';
    else bgVal.textContent=isSC?'æ¸å˜è‰² â€º':'æ¼¸è®Šè‰² â€º';
  }
  // å­—é«”å¤§å°å’Œè¡Œé–“è·
  const fontVal=document.getElementById('font-size-val');if(fontVal)fontVal.textContent=settings.fontSize+'px â€º';
  const lhVal=document.getElementById('line-height-val');if(lhVal)lhVal.textContent=settings.lineHeight+'x â€º';
  // æ‡‰ç”¨å­—é«”å’Œè¡Œé«˜åˆ° CSS è®Šé‡
  document.documentElement.style.setProperty('--font-size', settings.fontSize + 'px');
  document.documentElement.style.setProperty('--line-height', settings.lineHeight);
  // AI åƒæ•¸é¡¯ç¤º
  const aiParamsVal=document.getElementById('ai-params-val');if(aiParamsVal)aiParamsVal.textContent=`T:${settings.temperature} â€º`;
  // æ¨¡æ¿è®Šé‡é¡¯ç¤º
  const templateVal=document.getElementById('template-vars-val');if(templateVal)templateVal.textContent=settings.playerName?settings.playerName+' â€º':(isSC?'è®¾ç½® â€º':'è¨­ç½® â€º');
  // ç°¡ç¹è½‰æ›é¡¯ç¤º
  const cnVal=document.getElementById('cn-convert-val');
  if(cnVal){
    if(settings.uiLanguage==='sc')cnVal.textContent='ç®€ä½“ â€º';
    else cnVal.textContent='ç¹é«” â€º';
  }
  // æµå¼éŸ¿æ‡‰é¡¯ç¤º
  const streamVal=document.getElementById('streaming-val');if(streamVal)streamVal.textContent=settings.enableStreaming?(isSC?'å·²å¼€å¯ â€º':'å·²é–‹å•Ÿ â€º'):(isSC?'å·²å…³é—­ â€º':'å·²é—œé–‰ â€º');
}
function toggleTheme(){settings.theme=settings.theme==='dark'?'light':'dark';saveSetting('theme',settings.theme);applySettings();toast(T('ä¸»é¡Œå·²åˆ‡æ›'));}
function toggleScreen(){settings.screen=settings.screen==='phone'?'fullscreen':'phone';saveSetting('screen',settings.screen);applySettings();}
function toggleSet(k){settings[k]=!settings[k];saveSetting(k,settings[k]);applySettings();}
function toggleSendKey(){settings.sendKey=settings.sendKey==='enter'?'ctrl+enter':'enter';saveSetting('sendKey',settings.sendKey);applySettings();toast(T('ç™¼é€å¿«æ·éµå·²åˆ‡æ›'));}

// å­—é«”å¤§å°è¨­ç½®
function showFontSettings(){
  showModal('font-size-modal');
  updateFontOptions();
  document.getElementById('font-preview').style.fontSize = settings.fontSize + 'px';
}
function updateFontOptions(){
  document.querySelectorAll('#font-size-modal .font-option').forEach(btn=>{
    const size = parseInt(btn.dataset.size);
    if(size === settings.fontSize) btn.classList.add('active');
    else btn.classList.remove('active');
  });
}
function selectFontSize(size){
  settings.fontSize = size;
  saveSetting('fontSize', size);
  applySettings();
  updateFontOptions();
  document.getElementById('font-preview').style.fontSize = size + 'px';
  toast('å­—é«”å¤§å°å·²æ›´æ”¹ç‚º ' + size + 'px');
}

// è¡Œé–“è·è¨­ç½®
function showLineHeightSettings(){
  showModal('line-height-modal');
  updateLineHeightOptions();
  document.getElementById('line-height-preview').style.lineHeight = settings.lineHeight;
}
function updateLineHeightOptions(){
  document.querySelectorAll('#line-height-modal .font-option').forEach(btn=>{
    const lh = parseFloat(btn.dataset.lh);
    if(lh === settings.lineHeight) btn.classList.add('active');
    else btn.classList.remove('active');
  });
}
function selectLineHeight(lh){
  settings.lineHeight = lh;
  saveSetting('lineHeight', lh);
  applySettings();
  updateLineHeightOptions();
  document.getElementById('line-height-preview').style.lineHeight = lh;
  toast('è¡Œé–“è·å·²æ›´æ”¹ç‚º ' + lh + 'x');
}

// ============ AI åƒæ•¸è¨­ç½® ============
function showAIParamsSettings(){
  showModal('ai-params-modal');
  // æ›´æ–°æ»‘å¡Šå€¼
  document.getElementById('temp-slider').value = settings.temperature * 100;
  document.getElementById('temp-value').textContent = settings.temperature.toFixed(1);
  document.getElementById('topp-slider').value = settings.topP * 100;
  document.getElementById('topp-value').textContent = settings.topP.toFixed(1);
  document.getElementById('freq-slider').value = settings.frequencyPenalty * 100;
  document.getElementById('freq-value').textContent = settings.frequencyPenalty.toFixed(1);
  document.getElementById('pres-slider').value = settings.presencePenalty * 100;
  document.getElementById('pres-value').textContent = settings.presencePenalty.toFixed(1);
}

function updateAIParam(param, value){
  value = parseFloat(value);
  settings[param] = value;
  saveSetting(param, value);
  
  // æ›´æ–°é¡¯ç¤º
  switch(param){
    case 'temperature':
      document.getElementById('temp-value').textContent = value.toFixed(1);
      break;
    case 'topP':
      document.getElementById('topp-value').textContent = value.toFixed(1);
      break;
    case 'frequencyPenalty':
      document.getElementById('freq-value').textContent = value.toFixed(1);
      break;
    case 'presencePenalty':
      document.getElementById('pres-value').textContent = value.toFixed(1);
      break;
  }
  applySettings();
}

function applyAIPreset(preset){
  const presets = {
    creative: { temperature: 1.0, topP: 0.95, frequencyPenalty: 0.5, presencePenalty: 0.3 },
    balanced: { temperature: 0.8, topP: 0.9, frequencyPenalty: 0.3, presencePenalty: 0.1 },
    precise: { temperature: 0.5, topP: 0.8, frequencyPenalty: 0.2, presencePenalty: 0.0 },
    wild: { temperature: 1.5, topP: 1.0, frequencyPenalty: 0.7, presencePenalty: 0.5 }
  };
  
  const p = presets[preset];
  if(!p) return;
  
  settings.temperature = p.temperature;
  settings.topP = p.topP;
  settings.frequencyPenalty = p.frequencyPenalty;
  settings.presencePenalty = p.presencePenalty;
  
  saveSetting('temperature', p.temperature);
  saveSetting('topP', p.topP);
  saveSetting('frequencyPenalty', p.frequencyPenalty);
  saveSetting('presencePenalty', p.presencePenalty);
  
  // æ›´æ–° UI
  showAIParamsSettings();
  applySettings();
  
  const names = { creative: 'å‰µæ„å¯«ä½œ', balanced: 'å¹³è¡¡æ¨¡å¼', precise: 'ç²¾æº–æ•˜äº‹', wild: 'å¤©é¦¬è¡Œç©º' };
  toast(`å·²å¥—ç”¨ã€Œ${names[preset]}ã€é è¨­`);
}

// å…¨å±€é»˜èª AI åƒæ•¸è¨­ç½®ï¼ˆåˆ¥åï¼‰
function showDefaultAIParams(){
  showAIParamsSettings();
}

// ============ æ•…äº‹ç´šåˆ¥ AI åƒæ•¸è¨­ç½® ============
let storyAIParamsTemp = null; // è‡¨æ™‚å­˜å„²ç·¨è¼¯ä¸­çš„åƒæ•¸

function showStoryAIParams(){
  if(!story){toast(T('è«‹å…ˆæ‰“é–‹ä¸€å€‹æ•…äº‹'),'warning');return;}
  closeAll();
  
  // è®€å–æ•…äº‹çš„ AI åƒæ•¸
  const hasCustom = story.aiParams && story.aiParams.useCustom;
  const params = story.aiParams || {
    useCustom: false,
    temperature: settings.temperature,
    topP: settings.topP,
    frequencyPenalty: settings.frequencyPenalty,
    presencePenalty: settings.presencePenalty
  };
  
  storyAIParamsTemp = {...params};
  
  // è¨­ç½® checkbox
  document.getElementById('story-ai-use-custom').checked = hasCustom;
  toggleStoryAICustom(hasCustom);
  
  // è¨­ç½®æ»‘å¡Šå€¼
  document.getElementById('story-temp-slider').value = params.temperature * 100;
  document.getElementById('story-temp-value').textContent = params.temperature.toFixed(1);
  document.getElementById('story-topp-slider').value = params.topP * 100;
  document.getElementById('story-topp-value').textContent = params.topP.toFixed(1);
  document.getElementById('story-freq-slider').value = params.frequencyPenalty * 100;
  document.getElementById('story-freq-value').textContent = params.frequencyPenalty.toFixed(1);
  document.getElementById('story-pres-slider').value = params.presencePenalty * 100;
  document.getElementById('story-pres-value').textContent = params.presencePenalty.toFixed(1);
  
  // æ›´æ–°ç•¶å‰ç”Ÿæ•ˆåƒæ•¸é¡¯ç¤º
  updateEffectiveParamsDisplay();
  
  showModal('story-ai-params-modal');
}

function toggleStoryAICustom(checked){
  const container = document.getElementById('story-ai-params-container');
  if(checked){
    container.style.opacity = '1';
    container.style.pointerEvents = 'auto';
    storyAIParamsTemp.useCustom = true;
  } else {
    container.style.opacity = '0.5';
    container.style.pointerEvents = 'none';
    storyAIParamsTemp.useCustom = false;
  }
  updateEffectiveParamsDisplay();
}

function updateStoryAIParam(param, value){
  value = parseFloat(value);
  storyAIParamsTemp[param] = value;
  
  // æ›´æ–°é¡¯ç¤º
  switch(param){
    case 'temperature':
      document.getElementById('story-temp-value').textContent = value.toFixed(1);
      break;
    case 'topP':
      document.getElementById('story-topp-value').textContent = value.toFixed(1);
      break;
    case 'frequencyPenalty':
      document.getElementById('story-freq-value').textContent = value.toFixed(1);
      break;
    case 'presencePenalty':
      document.getElementById('story-pres-value').textContent = value.toFixed(1);
      break;
  }
  updateEffectiveParamsDisplay();
}

function applyStoryAIPreset(preset){
  const presets = {
    creative: { temperature: 1.0, topP: 0.95, frequencyPenalty: 0.5, presencePenalty: 0.3 },
    balanced: { temperature: 0.8, topP: 0.9, frequencyPenalty: 0.3, presencePenalty: 0.1 },
    precise: { temperature: 0.5, topP: 0.8, frequencyPenalty: 0.2, presencePenalty: 0.0 },
    wild: { temperature: 1.5, topP: 1.0, frequencyPenalty: 0.7, presencePenalty: 0.5 }
  };
  
  const p = presets[preset];
  if(!p) return;
  
  storyAIParamsTemp.temperature = p.temperature;
  storyAIParamsTemp.topP = p.topP;
  storyAIParamsTemp.frequencyPenalty = p.frequencyPenalty;
  storyAIParamsTemp.presencePenalty = p.presencePenalty;
  
  // æ›´æ–°æ»‘å¡Š
  document.getElementById('story-temp-slider').value = p.temperature * 100;
  document.getElementById('story-temp-value').textContent = p.temperature.toFixed(1);
  document.getElementById('story-topp-slider').value = p.topP * 100;
  document.getElementById('story-topp-value').textContent = p.topP.toFixed(1);
  document.getElementById('story-freq-slider').value = p.frequencyPenalty * 100;
  document.getElementById('story-freq-value').textContent = p.frequencyPenalty.toFixed(1);
  document.getElementById('story-pres-slider').value = p.presencePenalty * 100;
  document.getElementById('story-pres-value').textContent = p.presencePenalty.toFixed(1);
  
  updateEffectiveParamsDisplay();
  
  const names = { creative: 'å‰µæ„å¯«ä½œ', balanced: 'å¹³è¡¡æ¨¡å¼', precise: 'ç²¾æº–æ•˜äº‹', wild: 'å¤©é¦¬è¡Œç©º' };
  toast(`å·²å¥—ç”¨ã€Œ${names[preset]}ã€é è¨­`);
}

async function saveStoryAIParams(){
  if(!story) return;
  
  story.aiParams = {
    useCustom: storyAIParamsTemp.useCustom,
    temperature: storyAIParamsTemp.temperature,
    topP: storyAIParamsTemp.topP,
    frequencyPenalty: storyAIParamsTemp.frequencyPenalty,
    presencePenalty: storyAIParamsTemp.presencePenalty
  };
  story.updatedAt = Date.now();
  
  await db.stories.put(story);
  closeModal('story-ai-params-modal');
  
  if(story.aiParams.useCustom){
    toast(`å·²ä¿å­˜æœ¬æ•…äº‹çš„ AI åƒæ•¸ (T:${story.aiParams.temperature})`,'success');
  } else {
    toast(T('å·²è¨­ç‚ºä½¿ç”¨å…¨å±€é»˜èªåƒæ•¸'),'success');
  }
}

function updateEffectiveParamsDisplay(){
  const el = document.getElementById('story-ai-effective-params');
  if(!el) return;
  
  let params;
  let source;
  
  if(storyAIParamsTemp && storyAIParamsTemp.useCustom){
    params = storyAIParamsTemp;
    source = 'æœ¬æ•…äº‹è‡ªå®šç¾©';
  } else {
    params = settings;
    source = 'å…¨å±€é»˜èªå€¼';
  }
  
  el.innerHTML = `
    <div style="margin-bottom:4px">ä¾†æºï¼š<span style="color:var(--primary)">${source}</span></div>
    <div>Temperature: ${params.temperature.toFixed(1)} | Top P: ${params.topP.toFixed(1)} | Freq: ${params.frequencyPenalty.toFixed(1)} | Pres: ${params.presencePenalty.toFixed(1)}</div>
  `;
}

// ç²å–ç•¶å‰æ‡‰è©²ä½¿ç”¨çš„ AI åƒæ•¸ï¼ˆå„ªå…ˆæ•…äº‹ç´šåˆ¥ï¼Œå…¶æ¬¡å…¨å±€é»˜èªï¼‰
function getAIParams(){
  if(story && story.aiParams && story.aiParams.useCustom){
    return {
      temperature: story.aiParams.temperature,
      topP: story.aiParams.topP,
      frequencyPenalty: story.aiParams.frequencyPenalty,
      presencePenalty: story.aiParams.presencePenalty
    };
  }
  return {
    temperature: settings.temperature || 0.8,
    topP: settings.topP || 0.9,
    frequencyPenalty: settings.frequencyPenalty || 0.3,
    presencePenalty: settings.presencePenalty || 0.1
  };
}

// ============ æ¨¡æ¿è®Šé‡è¨­ç½® ============
function showTemplateVarsSettings(){
  showModal('template-vars-modal');
  document.getElementById('var-player-name').value = settings.playerName || '';
  document.getElementById('var-location').value = settings.currentLocation || '';
}

function saveTemplateVars(){
  const playerName = document.getElementById('var-player-name').value.trim();
  const location = document.getElementById('var-location').value.trim();
  
  settings.playerName = playerName;
  settings.currentLocation = location;
  
  saveSetting('playerName', playerName);
  saveSetting('currentLocation', location);
  
  closeModal('template-vars-modal');
  applySettings();
  toast(T('æ¨¡æ¿è®Šé‡å·²ä¿å­˜'), 'success');
}

// æ›¿æ›æ¨¡æ¿è®Šé‡
function replaceTemplateVars(text){
  if(!text) return text;
  
  // {{user}} - ç©å®¶ç¨±å‘¼
  text = text.replace(/\{\{user\}\}/gi, settings.playerName || 'ä½ ');
  
  // {{location}} - ç•¶å‰åœ°é»
  text = text.replace(/\{\{location\}\}/gi, settings.currentLocation || 'æ­¤è™•');
  
  // {{time}} - æ•…äº‹æ™‚é–“ï¼ˆæ·»åŠ storyå­˜åœ¨æ€§æª¢æŸ¥ï¼‰
  const storyTime = story && story.storyTime ? story.storyTime : '';
  text = text.replace(/\{\{time\}\}/gi, storyTime || 'ç•¶å‰');
  
  // {{date}} - ç¾å¯¦æ—¥æœŸ
  const today = new Date();
  const dateStr = `${today.getFullYear()}å¹´${today.getMonth()+1}æœˆ${today.getDate()}æ—¥`;
  text = text.replace(/\{\{date\}\}/gi, dateStr);
  
  // {{char:è§’è‰²å}} - æŒ‡å®šè§’è‰²çš„ä¿¡æ¯ï¼ˆç•°æ­¥ï¼Œé€™è£¡åªåšç°¡å–®æ›¿æ›ï¼‰
  text = text.replace(/\{\{char:([^}]+)\}\}/gi, (match, charName) => {
    return `ã€${charName}ã€‘`;
  });
  
  return text;
}

// åœ–ç‰‡ä¸Šå‚³ç›¸é—œ
let imageUploadTarget = null; // 'storyCover' | 'charAvatar' | 'chatBg' | {type: 'charAvatar', charId: xxx}

// å£“ç¸®åœ–ç‰‡
async function compressImage(file, maxWidth = 400, quality = 0.8) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        
        if (width > maxWidth) {
          height = (height * maxWidth) / width;
          width = maxWidth;
        }
        
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        const dataUrl = canvas.toDataURL('image/jpeg', quality);
        resolve(dataUrl);
      };
      img.onerror = reject;
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// è™•ç†åœ–ç‰‡ä¸Šå‚³
async function handleImageUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  try {
    showLoading('è™•ç†åœ–ç‰‡ä¸­...');
    const maxWidth = imageUploadTarget === 'chatBg' ? 1920 : 400;
    const dataUrl = await compressImage(file, maxWidth, 0.85);
    
    // å¾ä¸»é æ›´æ›å°é¢ï¼ˆå¸¶storyIdçš„å°è±¡ï¼‰
    if (typeof imageUploadTarget === 'object' && imageUploadTarget.type === 'storyCover') {
      const targetStoryId = imageUploadTarget.storyId;
      await db.stories.update(targetStoryId, { coverImage: dataUrl });
      // å¦‚æœç•¶å‰æ‰“é–‹çš„æ•…äº‹å°±æ˜¯é€™å€‹æ•…äº‹ï¼Œä¹Ÿæ›´æ–°å…¨å±€è®Šé‡
      if (story && story.id === targetStoryId) {
        story.coverImage = dataUrl;
      }
      await renderStories();
      toast(T('å°é¢å·²æ›´æ–°'), 'success');
    } else if (imageUploadTarget === 'storyCover' && story) {
      // å¾æ•…äº‹å…§éƒ¨æ›´æ›å°é¢
      await db.stories.update(story.id, { coverImage: dataUrl });
      story.coverImage = dataUrl;
      await renderStories();
      toast(T('å°é¢å·²æ›´æ–°'), 'success');
    } else if (imageUploadTarget === 'chatBg') {
      settings.chatBg = 'custom';
      settings.chatBgImage = dataUrl;
      await saveSetting('chatBg', 'custom');
      await saveSetting('chatBgImage', dataUrl);
      applyChatBg();
      closeModal('chat-bg-modal');
      toast(T('èƒŒæ™¯å·²æ›´æ–°'), 'success');
    } else if (typeof imageUploadTarget === 'object' && imageUploadTarget.type === 'charAvatar') {
      const charId = imageUploadTarget.charId;
      await db.characters.update(charId, { avatarImage: dataUrl, updatedAt: Date.now() });
      renderCharacters();
      toast(T('é ­åƒå·²æ›´æ–°'), 'success');
    }
    
    hideLoading();
  } catch (e) {
    hideLoading();
    toast('åœ–ç‰‡è™•ç†å¤±æ•—: ' + e.message, 'error');
  }
  
  // æ¸…ç©º input
  event.target.value = '';
}

// ä¸Šå‚³æ•…äº‹å°é¢
function uploadStoryCover() {
  if (!story) return toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'));
  imageUploadTarget = 'storyCover';
  document.getElementById('image-upload').click();
}

// ä¸Šå‚³è§’è‰²é ­åƒ
function uploadCharAvatar(charId) {
  imageUploadTarget = { type: 'charAvatar', charId };
  document.getElementById('image-upload').click();
}

// èŠå¤©èƒŒæ™¯è¨­ç½®
function setChatBackground() {
  // æ›´æ–°é¸ä¸­ç‹€æ…‹
  document.querySelectorAll('.bg-option').forEach(el => {
    el.style.borderColor = el.dataset.bg === settings.chatBg ? 'var(--primary)' : 'var(--divider)';
  });
  // é¡¯ç¤ºè‡ªå®šç¾©èƒŒæ™¯é è¦½
  const preview = document.getElementById('current-bg-preview');
  const previewImg = document.getElementById('bg-preview-img');
  if (settings.chatBg === 'custom' && settings.chatBgImage) {
    preview.style.display = 'block';
    previewImg.style.backgroundImage = `url(${settings.chatBgImage})`;
  } else {
    preview.style.display = 'none';
  }
  showModal('chat-bg-modal');
}

function selectBg(bg) {
  if (bg === 'custom') return; // ç”± uploadChatBg è™•ç†
  settings.chatBg = bg;
  saveSetting('chatBg', bg);
  applyChatBg();
  // æ›´æ–°é¸ä¸­ç‹€æ…‹
  document.querySelectorAll('.bg-option').forEach(el => {
    el.style.borderColor = el.dataset.bg === bg ? 'var(--primary)' : 'var(--divider)';
  });
  applySettings();
  toast(T('èƒŒæ™¯å·²æ›´æ–°'), 'success');
}

function uploadChatBg() {
  imageUploadTarget = 'chatBg';
  document.getElementById('image-upload').click();
}

function clearChatBg() {
  settings.chatBg = 'none';
  settings.chatBgImage = '';
  saveSetting('chatBg', 'none');
  saveSetting('chatBgImage', '');
  applyChatBg();
  document.getElementById('current-bg-preview').style.display = 'none';
  document.querySelectorAll('.bg-option').forEach(el => {
    el.style.borderColor = el.dataset.bg === 'none' ? 'var(--primary)' : 'var(--divider)';
  });
  applySettings();
  toast(T('å·²æ¢å¾©é»˜èªèƒŒæ™¯'), 'success');
}

function applyChatBg() {
  const content = document.getElementById('content-area');
  if (!content) return;
  
  content.classList.remove('has-bg');
  content.style.backgroundImage = '';
  content.style.background = '';
  
  if (settings.chatBg === 'custom' && settings.chatBgImage) {
    content.classList.add('has-bg');
    content.style.backgroundImage = `url(${settings.chatBgImage})`;
  } else if (settings.chatBg === 'gradient1') {
    content.style.background = 'linear-gradient(135deg, #1a1a2e, #16213e)';
  } else if (settings.chatBg === 'gradient2') {
    content.style.background = 'linear-gradient(135deg, #0f0f1a, #1e1e32)';
  } else if (settings.chatBg === 'gradient3') {
    content.style.background = 'linear-gradient(135deg, #1a0a0a, #2a1515)';
  } else if (settings.chatBg === 'gradient4') {
    content.style.background = 'linear-gradient(135deg, #0a1a0a, #152a15)';
  }
}

// è™•ç†è¼¸å…¥æ¡†æŒ‰éµäº‹ä»¶
function handleInputKey(event){
  if(event.key==='Enter'){
    if(settings.sendKey==='ctrl+enter'){
      if(event.ctrlKey||event.metaKey){
        event.preventDefault();
        send();
      }
    }else{
      // é»˜èª Enter ç™¼é€
      if(!event.ctrlKey&&!event.metaKey&&!event.shiftKey){
        event.preventDefault();
        send();
      }
    }
  }
}

// ä¸Šä¸‹æ–‡è¨­ç½®
function showContextSettings(){
  document.getElementById('context-count').value=settings.contextCount||20;
  showModal('context-modal');
}
function saveContextSettings(){
  const val=parseInt(document.getElementById('context-count').value)||20;
  settings.contextCount=Math.max(1,Math.min(500,val));
  saveSetting('contextCount',settings.contextCount);
  applySettings();
  closeModal('context-modal');
  toast(T('ä¸Šä¸‹æ–‡è¨­ç½®å·²ä¿å­˜'));
}

// æœ€å¤§ Token è¨­ç½®
function showMaxTokensSettings(){
  document.getElementById('max-tokens-input').value=settings.maxTokens||4096;
  showModal('max-tokens-modal');
}
function saveMaxTokensSettings(){
  const val=parseInt(document.getElementById('max-tokens-input').value)||4096;
  settings.maxTokens=Math.max(100,val);
  saveSetting('maxTokens',settings.maxTokens);
  applySettings();
  closeModal('max-tokens-modal');
  toast(T('æœ€å¤§ç”Ÿæˆé•·åº¦å·²ä¿å­˜'));
}

// æ‰“å­—æ©Ÿæ•ˆæœè¨­ç½®
function showTypingSpeedSettings(){
  document.getElementById('typing-speed-select').value=settings.typingSpeed||30;
  showModal('typing-modal');
}
function saveTypingSpeedSettings(){
  settings.typingSpeed=parseInt(document.getElementById('typing-speed-select').value);
  saveSetting('typingSpeed',settings.typingSpeed);
  applySettings();
  closeModal('typing-modal');
  toast(T('æ‰“å­—æ©Ÿæ•ˆæœå·²ä¿å­˜'));
}

// æµå¼éŸ¿æ‡‰è¨­ç½®
function showStreamingSettings(){
  const toggle=document.getElementById('toggle-streaming');
  const text=document.getElementById('toggle-streaming-text');
  const options=document.getElementById('streaming-advanced-options');
  if(settings.enableStreaming){
    toggle.classList.add('active');
    text.textContent='å·²é–‹å•Ÿ';
    options.style.display='block';
  }else{
    toggle.classList.remove('active');
    text.textContent='å·²é—œé–‰';
    options.style.display='none';
  }
  document.getElementById('streaming-chunk-delay-select').value=settings.streamingChunkDelay||20;
  showModal('streaming-modal');
}
function toggleStreamingEnabled(){
  const toggle=document.getElementById('toggle-streaming');
  const text=document.getElementById('toggle-streaming-text');
  const options=document.getElementById('streaming-advanced-options');
  const enabled=toggle.classList.contains('active');
  if(enabled){
    toggle.classList.remove('active');
    text.textContent='å·²é—œé–‰';
    options.style.display='none';
  }else{
    toggle.classList.add('active');
    text.textContent='å·²é–‹å•Ÿ';
    options.style.display='block';
  }
}
function saveStreamingSettings(){
  const enabled=document.getElementById('toggle-streaming').classList.contains('active');
  settings.enableStreaming=enabled;
  settings.streamingChunkDelay=parseInt(document.getElementById('streaming-chunk-delay-select').value)||20;
  saveSetting('enableStreaming',settings.enableStreaming);
  saveSetting('streamingChunkDelay',settings.streamingChunkDelay);
  applySettings();
  closeModal('streaming-modal');
  toast(T('æµå¼éŸ¿æ‡‰è¨­ç½®å·²ä¿å­˜'),'success');
}

// æ™‚é–“
function updateTime(){
  const n=new Date();
  const timeEl=document.getElementById('status-time');
  if(timeEl)timeEl.textContent=`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;
}

// å°èˆª
function goTo(id){
  const cur=document.querySelector('.view.active'),tar=document.getElementById(id);
  if(!tar||cur===tar)return;
  hist.push(id);
  cur.classList.remove('active');cur.classList.add('out');
  tar.classList.add('active');
  setTimeout(()=>cur.classList.remove('out'),300);
  // è¼‰å…¥æ•¸æ“š
  if(id==='view-lore')renderLore();
  else if(id==='view-timeline')renderTimeline();
  else if(id==='view-foreshadow')renderForeshadow();
  else if(id==='view-saves')renderSaves();
  else if(id==='view-api')renderApi();
  else if(id==='view-chapters')renderChapters();
  else if(id==='view-bookmarks')renderBookmarks();
  else if(id==='view-inventory')renderInventory();
  else if(id==='view-branches')renderBranches();
  else if(id==='view-characters')renderCharacters(); // v7
  else if(id==='view-lorebook')renderLorebook(); // v13
  else if(id==='view-search')initContentSearch(); // v17 ä¿®å¾©
}
function goBack(){
  if(hist.length>1){
    hist.pop();
    const prev=hist[hist.length-1];
    const cur=document.querySelector('.view.active'),tar=document.getElementById(prev);
    cur.classList.remove('active');tar.classList.add('active');
  }
}
function switchTab(t){
  document.querySelectorAll('.tab-bar .tab-item').forEach(x=>x.classList.remove('active'));
  if(t==='stories'){goTo('view-stories');document.querySelectorAll('.tab-bar')[0]?.querySelector('.tab-item')?.classList.add('active');}
  else if(t==='instructions'){goTo('view-instructions');}
  else if(t==='settings'){goTo('view-settings');}
}

// æ•…äº‹åˆ—è¡¨
async function renderStories(){
  const c=document.getElementById('story-list');
  let list=await db.stories.orderBy('updatedAt').reverse().toArray();
  list.sort((a,b)=>(a.isPinned&&!b.isPinned)?-1:(!a.isPinned&&b.isPinned)?1:0);
  if(!list.length){c.innerHTML=`<div class="empty"><div class="empty-icon">ğŸ“š</div><div class="empty-title">${T('é‚„æ²’æœ‰æ•…äº‹')}</div><div class="empty-desc">${T('é»æ“Šå³ä¸Šè§’ â• å‰µå»ºä½ çš„ç¬¬ä¸€å€‹äº’å‹•æ•…äº‹')}</div><button class="empty-btn" onclick="createStory()">${T('å‰µå»ºæ•…äº‹')}</button></div>`;return;}
  c.innerHTML=list.map(s=>{
    const t=timeAgo(s.updatedAt),stats=s.statistics||{totalChars:0},tags=(s.tags||[]).map(x=>`<span class="tag">${esc(x)}</span>`).join('');
    // æ”¯æŒå°é¢åœ–ç‰‡
    const coverEmoji = esc(s.cover) || 'ğŸ“–';
    const coverContent = s.coverImage 
      ? `<img src="${s.coverImage}" alt="å°é¢" onerror="this.outerHTML='<span class=cover-emoji>${coverEmoji}</span>'">` 
      : `<span class="cover-emoji">${coverEmoji}</span>`;
    return `<div class="card ${s.isPinned?'pinned':''}" onclick="openStory('${s.id}')"><div class="card-cover">${coverContent}</div><div class="card-info"><div class="card-header"><span class="card-title">${esc(s.title)}</span><span class="card-time">${t}</span></div><div class="card-preview">${esc(s.preview||'é–‹å§‹ä½ çš„å†’éšª...')}</div><div class="card-meta">${s.instructionName?`<span class="card-instruction">ğŸ“œ ${esc(s.instructionName)}</span>`:''}<span class="card-stats">ğŸ“Š ${fmtNum(stats.totalChars)}å­—</span></div>${tags?`<div class="card-tags">${tags}</div>`:''}</div><div class="card-menu-btn" onclick="event.stopPropagation();showStoryMenu('${s.id}')">â‹¯</div></div>`;
  }).join('');
}
function filterStories(){const q=document.getElementById('story-search').value.toLowerCase();document.querySelectorAll('#story-list .card').forEach(c=>{const t=c.querySelector('.card-title')?.textContent.toLowerCase()||'';c.style.display=t.includes(q)?'':'none';});}

// v19: ç¶“ç‡Ÿæ¨¡å¼ç›¸é—œ
let selectedStoryMode = 'normal';

function selectStoryMode(mode){
  selectedStoryMode = mode;
  document.getElementById('mode-normal').classList.toggle('active', mode === 'normal');
  document.getElementById('mode-simulation').classList.toggle('active', mode === 'simulation');
  document.getElementById('sim-mode-options').style.display = mode === 'simulation' ? 'block' : 'none';
}

function addSimResource(){
  const container = document.getElementById('new-sim-resources');
  const div = document.createElement('div');
  div.style.cssText = 'display:flex;gap:6px;align-items:center';
  div.innerHTML = `
    <input type="text" class="form-input" style="width:60px" placeholder="ğŸ“Š" maxlength="2">
    <input type="text" class="form-input" style="flex:1" placeholder="åç¨±">
    <input type="number" class="form-input" style="width:80px" placeholder="æ•¸å€¼" value="0">
    <button onclick="removeSimResource(this)" style="background:none;border:none;color:var(--error);cursor:pointer">âœ•</button>
  `;
  container.appendChild(div);
}

function removeSimResource(btn){
  btn.parentElement.remove();
}

async function createStory(){
  const insts=await db.instructions.toArray();
  const sel=document.getElementById('new-inst');
  sel.innerHTML='<option value="">ä¸ç¶å®šæŒ‡ä»¤</option>'+insts.map(i=>`<option value="${i.id}">${esc(i.name)}</option>`).join('');
  document.getElementById('new-title').value='';
  document.getElementById('new-desc').value='';
  document.getElementById('new-tags').value='';
  // v19: é‡ç½®æ¨¡å¼é¸æ“‡
  selectedStoryMode = 'normal';
  selectStoryMode('normal');
  // é‡ç½®åˆå§‹è³‡æº
  document.getElementById('new-sim-resources').innerHTML = `
    <div style="display:flex;gap:6px;align-items:center">
      <input type="text" class="form-input" style="width:60px" placeholder="ğŸ’°" maxlength="2" value="ğŸ’°">
      <input type="text" class="form-input" style="flex:1" placeholder="åç¨±" value="é‡‘å¹£">
      <input type="number" class="form-input" style="width:80px" placeholder="æ•¸å€¼" value="10000">
      <button onclick="removeSimResource(this)" style="background:none;border:none;color:var(--error);cursor:pointer">âœ•</button>
    </div>
  `;
  showModal('new-story-modal');
}
async function saveNewStory(){
  const title=document.getElementById('new-title').value.trim();
  if(!title){toast(T('è«‹è¼¸å…¥æ•…äº‹æ¨™é¡Œ'),'warning');return;}
  const desc=document.getElementById('new-desc').value.trim();
  const tagsStr=document.getElementById('new-tags').value.trim();
  const tags=tagsStr?tagsStr.split(/\s+/):[];
  const instId=document.getElementById('new-inst').value;
  const storyId=crypto.randomUUID(),branchId='main_'+crypto.randomUUID(),now=Date.now();
  const s={id:storyId,title,description:desc,cover:'ğŸ“–',tags,currentBranchId:branchId,currentMessageId:null,storyTime:'',isPinned:false,preview:'',createdAt:now,updatedAt:now,statistics:{totalChars:0,totalMessages:0},draft:'',autoSave:{enabled:true,interval:20,maxCount:5}};
  
  // v19: ä¿å­˜æ¨¡å¼å’Œè³‡æº
  s.mode = selectedStoryMode;
  if(selectedStoryMode === 'simulation'){
    s.simDay = 1;
    s.simResources = [];
    const rows = document.querySelectorAll('#new-sim-resources > div');
    rows.forEach(row => {
      const inputs = row.querySelectorAll('input');
      if(inputs.length >= 3){
        const icon = inputs[0].value.trim() || 'ğŸ“Š';
        const name = inputs[1].value.trim();
        const value = parseFloat(inputs[2].value) || 0;
        if(name) s.simResources.push({icon, name, value, prevValue: value});
      }
    });
  }
  
  if(instId){const inst=await db.instructions.get(instId);if(inst){s.instructionName=inst.name;await db.storyInstructions.put({storyId,instructionId:instId,order:0});}}
  await db.branches.put({id:branchId,storyId,name:'ä¸»ç·š',parentBranchId:null,createdAt:now});
  await db.stories.put(s);
  closeModal('new-story-modal');
  toast(T('æ•…äº‹å‰µå»ºæˆåŠŸï¼'),'success');
  await renderStories();
  openStory(storyId);
}

async function openStory(id){
  showLoading('è¼‰å…¥æ•…äº‹...');
  try{
    story=await db.stories.get(id);
    if(!story){toast(T('æ•…äº‹ä¸å­˜åœ¨'),'error');hideLoading();return;}
    msgs=await db.messages.where('[storyId+branchId]').equals([id,story.currentBranchId]).sortBy('createdAt');
    document.getElementById('reading-title').textContent=story.title;
    renderMsgs();
    applyChatBg(); // æ‡‰ç”¨èŠå¤©èƒŒæ™¯
    // v19: ç¶“ç‡Ÿæ¨¡å¼ UI åˆ‡æ›
    updateSimulationUI();
    // v22: è¼‰å…¥ Persona
    await initDefaultPersona();
    goTo('view-reading');
    hideLoading();
    
    // v25: å¦‚æœæ˜¯æ–°æ•…äº‹ï¼ˆæ²’æœ‰æ¶ˆæ¯ï¼‰ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰é–‹å ´ç™½
    if(msgs.length === 0){
      await checkGreetingAvailable();
    }
  }catch(e){console.error(e);toast(T('è¼‰å…¥å¤±æ•—'),'error');hideLoading();}
}

// v25: é–‹å ´ç™½ç³»çµ±
let selectedGreetingIndex = -1;
let availableGreetings = [];

async function checkGreetingAvailable(){
  if(!story) return;
  
  const chars = await db.characters.where('storyId').equals(story.id).toArray();
  availableGreetings = [];
  
  // æ”¶é›†æ‰€æœ‰è§’è‰²çš„é–‹å ´ç™½
  for(const char of chars){
    if(char.first_mes){
      availableGreetings.push({
        charId: char.id,
        charName: char.name,
        charAvatar: char.avatar || 'ğŸ‘¤',
        content: char.first_mes,
        isDefault: true
      });
    }
    
    // æ›¿ä»£é–‹å ´ç™½
    if(char.alternate_greetings && char.alternate_greetings.length > 0){
      char.alternate_greetings.forEach((greeting, idx) => {
        if(greeting.trim()){
          availableGreetings.push({
            charId: char.id,
            charName: char.name,
            charAvatar: char.avatar || 'ğŸ‘¤',
            content: greeting,
            isDefault: false,
            altIndex: idx + 1
          });
        }
      });
    }
  }
  
  if(availableGreetings.length > 0){
    showGreetingSelector();
  }
}

function showGreetingSelector(){
  const container = document.getElementById('greeting-select-content');
  selectedGreetingIndex = 0;
  
  let html = '';
  availableGreetings.forEach((g, idx) => {
    const isSelected = idx === 0 ? 'selected' : '';
    const badge = g.isDefault ? 'é»˜èª' : `æ›¿ä»£ ${g.altIndex}`;
    html += `
      <div class="greeting-option ${isSelected}" onclick="selectGreeting(${idx})" data-idx="${idx}">
        <div class="greeting-option-header">
          <span class="greeting-char-avatar">${g.charAvatar}</span>
          <span class="greeting-char-name">${esc(g.charName)}</span>
          <span class="greeting-badge">${badge}</span>
        </div>
        <div class="greeting-preview">${esc(g.content.slice(0, 150))}${g.content.length > 150 ? '...' : ''}</div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  showModal('greeting-select-modal');
}

function selectGreeting(idx){
  selectedGreetingIndex = idx;
  document.querySelectorAll('.greeting-option').forEach((el, i) => {
    el.classList.toggle('selected', i === idx);
  });
}

async function confirmGreeting(){
  closeModal('greeting-select-modal');
  
  if(selectedGreetingIndex < 0 || selectedGreetingIndex >= availableGreetings.length) return;
  
  const greeting = availableGreetings[selectedGreetingIndex];
  
  // å‰µå»ºAIæ¶ˆæ¯
  const aiMsgId = crypto.randomUUID();
  const aiMsg = {
    id: aiMsgId,
    storyId: story.id,
    branchId: story.currentBranchId,
    role: 'assistant',
    content: greeting.content,
    createdAt: Date.now(),
    isGreeting: true  // æ¨™è¨˜ç‚ºé–‹å ´ç™½
  };
  
  await db.messages.put(aiMsg);
  msgs.push(aiMsg);
  renderMsgs();
  
  toast(T('å·²ä½¿ç”¨é–‹å ´ç™½'), 'success');
}

function skipGreeting(){
  // ç”¨æˆ¶é¸æ“‡ä¸ä½¿ç”¨é–‹å ´ç™½ï¼Œä»€éº¼éƒ½ä¸åš
  availableGreetings = [];
  selectedGreetingIndex = -1;
}

// v25: è§’è‰²é—œä¿‚ç³»çµ±
let charRelationships = []; // ç•¶å‰ç·¨è¼¯çš„è§’è‰²é—œä¿‚
const RELATIONSHIP_TYPES = [
  { code: 'lover', label: 'æˆ€äºº', icon: 'â¤ï¸', color: '#ff6b6b' },
  { code: 'ex', label: 'å‰ä»»', icon: 'ğŸ’”', color: '#ffa8a8' },
  { code: 'crush', label: 'æš—æˆ€', icon: 'ğŸ’—', color: '#ffb3d9' },
  { code: 'spouse', label: 'é…å¶', icon: 'ğŸ’', color: '#ff4757' },
  { code: 'family', label: 'å®¶äºº', icon: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§', color: '#4ecdc4' },
  { code: 'friend', label: 'æœ‹å‹', icon: 'ğŸ¤', color: '#45b7d1' },
  { code: 'bestfriend', label: 'æ‘¯å‹', icon: 'ğŸ‘¯', color: '#3498db' },
  { code: 'enemy', label: 'æ•µäºº', icon: 'âš”ï¸', color: '#ff4757' },
  { code: 'rival', label: 'å°æ‰‹', icon: 'ğŸ”¥', color: '#ff7f50' },
  { code: 'boss', label: 'ä¸Šå¸', icon: 'ğŸ‘”', color: '#a55eea' },
  { code: 'subordinate', label: 'ä¸‹å±¬', icon: 'ğŸ‘·', color: '#26de81' },
  { code: 'colleague', label: 'åŒäº‹', icon: 'ğŸ¢', color: '#74b9ff' },
  { code: 'mentor', label: 'å°å¸«', icon: 'ğŸ“', color: '#fed330' },
  { code: 'student', label: 'å­¸ç”Ÿ', icon: 'ğŸ“š', color: '#20bf6b' },
  { code: 'master', label: 'ä¸»äºº', icon: 'ğŸ‘‘', color: '#6c5ce7' },
  { code: 'servant', label: 'åƒ•äºº', icon: 'ğŸ™‡', color: '#81ecec' },
  { code: 'partner', label: 'æ­æª”', icon: 'ğŸ¤œğŸ¤›', color: '#00cec9' },
  { code: 'custom', label: 'è‡ªå®šç¾©', icon: 'âœï¸', color: '#9ca3af' }
];

function addCharRelationship(){
  charRelationships.push({
    id: crypto.randomUUID(),
    targetId: null,
    targetName: '',
    type: 'friend',
    label: 'æœ‹å‹',
    description: '',
    mutual: false
  });
  renderCharRelationships();
}

async function renderCharRelationships(){
  const container = document.getElementById('char-relationships-list');
  if(!container) return;
  
  // ç²å–å¯é¸çš„è§’è‰²åˆ—è¡¨ï¼ˆæ’é™¤ç•¶å‰ç·¨è¼¯çš„è§’è‰²ï¼‰
  const chars = await db.characters.where('storyId').equals(story?.id || 0).toArray();
  const otherChars = chars.filter(c => c.id !== editingCharacterId);
  
  const typeOptions = RELATIONSHIP_TYPES.map(t => 
    `<option value="${t.code}">${t.icon} ${t.label}</option>`
  ).join('');
  
  const charOptions = otherChars.map(c => 
    `<option value="${c.id}">${c.avatar || 'ğŸ‘¤'} ${c.name}</option>`
  ).join('');
  
  container.innerHTML = charRelationships.map((rel, idx) => `
    <div class="relationship-item">
      <button class="delete-btn" onclick="removeCharRelationship(${idx})">âœ•</button>
      <div class="relationship-row">
        <select class="form-input" onchange="updateRelTarget(${idx}, this.value)" style="flex:1.5">
          <option value="">é¸æ“‡è§’è‰²...</option>
          ${charOptions}
        </select>
        <select class="form-input" onchange="updateRelType(${idx}, this.value)">
          ${typeOptions}
        </select>
      </div>
      <div class="relationship-row">
        <input type="text" class="form-input" placeholder="é—œä¿‚æè¿°ï¼ˆå¯é¸ï¼‰" 
               value="${esc(rel.description || '')}"
               oninput="charRelationships[${idx}].description=this.value">
        <label style="display:flex;align-items:center;gap:4px;font-size:12px;white-space:nowrap">
          <input type="checkbox" ${rel.mutual ? 'checked' : ''} 
                 onchange="charRelationships[${idx}].mutual=this.checked">
          é›™å‘
        </label>
      </div>
    </div>
  `).join('');
  
  // è¨­ç½®å·²é¸ä¸­çš„å€¼
  const selects = container.querySelectorAll('select');
  charRelationships.forEach((rel, idx) => {
    const targetSelect = selects[idx * 2];
    const typeSelect = selects[idx * 2 + 1];
    if(targetSelect && rel.targetId) targetSelect.value = rel.targetId;
    if(typeSelect) typeSelect.value = rel.type || 'friend';
  });
}

function updateRelTarget(idx, targetId){
  if(!targetId){
    charRelationships[idx].targetId = null;
    charRelationships[idx].targetName = '';
    return;
  }
  charRelationships[idx].targetId = parseInt(targetId);
  // ç²å–è§’è‰²å
  db.characters.get(parseInt(targetId)).then(char => {
    if(char) charRelationships[idx].targetName = char.name;
  });
}

function updateRelType(idx, typeCode){
  const typeInfo = RELATIONSHIP_TYPES.find(t => t.code === typeCode);
  charRelationships[idx].type = typeCode;
  charRelationships[idx].label = typeInfo ? typeInfo.label : typeCode;
}

function removeCharRelationship(idx){
  charRelationships.splice(idx, 1);
  renderCharRelationships();
}

// v25: é—œä¿‚åœ–è­œ
async function showRelationshipGraph(){
  closeAll();
  
  if(!story){
    toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'), 'warning');
    return;
  }
  
  showLoading(T('è¼‰å…¥é—œä¿‚åœ–è­œ...'));
  
  try {
    const chars = await db.characters.where('storyId').equals(story.id).toArray();
    
    if(chars.length === 0){
      hideLoading();
      toast(T('æš«ç„¡è§’è‰²'), 'info');
      return;
    }
    
    hideLoading();
    showModal('relationship-graph-modal');
    
    // å»¶é²æ¸²æŸ“ä»¥ç¢ºä¿æ¨¡æ…‹æ¡†å·²é¡¯ç¤º
    setTimeout(() => renderRelationshipGraph(chars), 100);
  } catch(err){
    hideLoading();
    console.error('Load graph error:', err);
    toast(T('è¼‰å…¥å¤±æ•—'), 'error');
  }
}

function renderRelationshipGraph(chars){
  const container = document.getElementById('relationship-graph-container');
  if(!container) return;
  
  const width = container.offsetWidth;
  const height = container.offsetHeight || 400;
  
  // è¨ˆç®—ç¯€é»ä½ç½®ï¼ˆåœ“å½¢å¸ƒå±€ï¼‰
  const centerX = width / 2;
  const centerY = height / 2;
  const radius = Math.min(width, height) / 2 - 60;
  
  const nodes = chars.map((char, idx) => {
    const angle = (2 * Math.PI * idx) / chars.length - Math.PI / 2;
    return {
      id: char.id,
      name: char.name,
      avatar: char.avatar || 'ğŸ‘¤',
      category: char.category || 'supporting',
      x: centerX + radius * Math.cos(angle),
      y: centerY + radius * Math.sin(angle),
      relationships: char.relationships || []
    };
  });
  
  // æ”¶é›†æ‰€æœ‰é—œä¿‚ç·š
  const lines = [];
  nodes.forEach(node => {
    node.relationships.forEach(rel => {
      const targetNode = nodes.find(n => n.id === rel.targetId);
      if(targetNode){
        const typeInfo = RELATIONSHIP_TYPES.find(t => t.code === rel.type);
        lines.push({
          from: node,
          to: targetNode,
          label: rel.label || (typeInfo ? typeInfo.label : rel.type),
          color: typeInfo ? typeInfo.color : '#888',
          icon: typeInfo ? typeInfo.icon : ''
        });
      }
    });
  });
  
  // æ¸²æŸ“HTML
  let html = '<svg width="100%" height="100%" style="position:absolute;top:0;left:0">';
  
  // ç¹ªè£½é—œä¿‚ç·š
  lines.forEach(line => {
    const midX = (line.from.x + line.to.x) / 2;
    const midY = (line.from.y + line.to.y) / 2;
    
    html += `
      <line x1="${line.from.x}" y1="${line.from.y}" 
            x2="${line.to.x}" y2="${line.to.y}" 
            stroke="${line.color}" stroke-width="2" stroke-opacity="0.6"/>
    `;
  });
  
  html += '</svg>';
  
  // ç¹ªè£½é—œä¿‚æ¨™ç±¤
  lines.forEach(line => {
    const midX = (line.from.x + line.to.x) / 2;
    const midY = (line.from.y + line.to.y) / 2;
    
    html += `
      <div class="rel-graph-label" style="left:${midX}px;top:${midY}px;transform:translate(-50%,-50%)">
        ${line.icon} ${line.label}
      </div>
    `;
  });
  
  // ç¹ªè£½ç¯€é»
  nodes.forEach(node => {
    const categoryClass = node.category === 'protagonist' ? 'protagonist' : 
                         node.category === 'npc' ? 'npc' : '';
    html += `
      <div class="rel-graph-node ${categoryClass}" 
           style="left:${node.x - 35}px;top:${node.y - 35}px"
           onclick="showCharDetail(${node.id})">
        <span class="node-avatar">${node.avatar}</span>
        <span class="node-name">${esc(node.name)}</span>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function resetGraphView(){
  // é‡æ–°æ¸²æŸ“åœ–è­œ
  db.characters.where('storyId').equals(story?.id || 0).toArray().then(chars => {
    renderRelationshipGraph(chars);
  });
}

// v25: è¡¨æƒ…ç«‹ç¹ªç³»çµ±
let charExpressions = []; // ç•¶å‰ç·¨è¼¯çš„è§’è‰²è¡¨æƒ…
let editingExpressionIndex = -1;

function addCharExpression(){
  document.getElementById('expr-file-input').click();
}

function handleExpressionUpload(event){
  const file = event.target.files[0];
  if(!file) return;
  
  if(!file.type.startsWith('image/')){
    toast(T('è«‹é¸æ“‡åœ–ç‰‡æ–‡ä»¶'), 'warning');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = (e) => {
    const base64 = e.target.result;
    
    // å‰µå»ºæ–°è¡¨æƒ…
    const expr = {
      id: Date.now(),
      name: 'è¡¨æƒ… ' + (charExpressions.length + 1),
      image: base64,
      keywords: [],
      isDefault: charExpressions.length === 0  // ç¬¬ä¸€å€‹è¡¨æƒ…é»˜èª
    };
    
    charExpressions.push(expr);
    renderCharExpressions();
    
    // é¡¯ç¤ºç·¨è¼¯å½ˆçª—
    editingExpressionIndex = charExpressions.length - 1;
    showExpressionEditPopup();
  };
  
  reader.readAsDataURL(file);
  event.target.value = '';  // é‡ç½®input
}

function renderCharExpressions(){
  const container = document.getElementById('char-expressions-list');
  if(!container) return;
  
  if(charExpressions.length === 0){
    container.innerHTML = '<div style="grid-column:span 3;text-align:center;color:var(--text-tertiary);font-size:12px;padding:20px 0">æš«ç„¡è¡¨æƒ…ï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•æ·»åŠ </div>';
    return;
  }
  
  container.innerHTML = charExpressions.map((expr, idx) => `
    <div class="expression-item ${expr.isDefault ? 'default' : ''}" onclick="editExpression(${idx})">
      ${expr.isDefault ? '<span class="expr-badge">é»˜èª</span>' : ''}
      <button class="expr-delete" onclick="event.stopPropagation();deleteExpression(${idx})">âœ•</button>
      <img class="expr-img" src="${expr.image}" alt="${esc(expr.name)}">
      <div class="expr-name">${esc(expr.name)}</div>
    </div>
  `).join('');
}

function editExpression(idx){
  editingExpressionIndex = idx;
  showExpressionEditPopup();
}

function showExpressionEditPopup(){
  if(editingExpressionIndex < 0 || editingExpressionIndex >= charExpressions.length) return;
  
  const expr = charExpressions[editingExpressionIndex];
  
  const html = `
    <div class="expression-edit-modal" id="expr-edit-popup">
      <div style="display:flex;gap:12px;align-items:flex-start">
        <img src="${expr.image}" style="width:80px;height:80px;border-radius:10px;object-fit:cover">
        <div style="flex:1">
          <div class="form-group" style="margin-bottom:10px">
            <label class="form-label" style="font-size:11px">è¡¨æƒ…åç¨±</label>
            <input type="text" class="form-input" id="expr-edit-name" value="${esc(expr.name)}" placeholder="å¦‚ï¼šé–‹å¿ƒã€ç”Ÿæ°£ã€å®³ç¾...">
          </div>
          <div class="form-group" style="margin-bottom:10px">
            <label class="form-label" style="font-size:11px">è§¸ç™¼é—œéµè©ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</label>
            <input type="text" class="form-input" id="expr-edit-keywords" value="${(expr.keywords || []).join(', ')}" placeholder="ç¬‘, é–‹å¿ƒ, é«˜èˆˆ...">
          </div>
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer">
            <input type="checkbox" id="expr-edit-default" ${expr.isDefault ? 'checked' : ''}>
            è¨­ç‚ºé»˜èªè¡¨æƒ…
          </label>
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button class="modal-btn secondary" onclick="closeExpressionEdit()" style="padding:6px 12px;font-size:12px">å–æ¶ˆ</button>
        <button class="modal-btn confirm" onclick="saveExpressionEdit()" style="padding:6px 12px;font-size:12px">ä¿å­˜</button>
      </div>
    </div>
  `;
  
  // ç§»é™¤èˆŠçš„å½ˆçª—
  const oldPopup = document.getElementById('expr-edit-popup');
  if(oldPopup) oldPopup.remove();
  
  // åœ¨è¡¨æƒ…åˆ—è¡¨å¾Œæ’å…¥
  const container = document.getElementById('char-expressions-list');
  container.insertAdjacentHTML('afterend', html);
}

function closeExpressionEdit(){
  const popup = document.getElementById('expr-edit-popup');
  if(popup) popup.remove();
  editingExpressionIndex = -1;
}

function saveExpressionEdit(){
  if(editingExpressionIndex < 0) return;
  
  const name = document.getElementById('expr-edit-name')?.value?.trim() || 'è¡¨æƒ…';
  const keywordsText = document.getElementById('expr-edit-keywords')?.value || '';
  const keywords = keywordsText.split(',').map(s => s.trim()).filter(s => s);
  const isDefault = document.getElementById('expr-edit-default')?.checked || false;
  
  // æ›´æ–°è¡¨æƒ…
  charExpressions[editingExpressionIndex].name = name;
  charExpressions[editingExpressionIndex].keywords = keywords;
  
  // å¦‚æœè¨­ç‚ºé»˜èªï¼Œå–æ¶ˆå…¶ä»–é»˜èª
  if(isDefault){
    charExpressions.forEach((e, i) => {
      e.isDefault = (i === editingExpressionIndex);
    });
  }
  charExpressions[editingExpressionIndex].isDefault = isDefault;
  
  closeExpressionEdit();
  renderCharExpressions();
  toast(T('è¡¨æƒ…å·²æ›´æ–°'), 'success');
}

function deleteExpression(idx){
  if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹è¡¨æƒ…å—ï¼Ÿ')) return;
  
  const wasDefault = charExpressions[idx].isDefault;
  charExpressions.splice(idx, 1);
  
  // å¦‚æœåˆªé™¤çš„æ˜¯é»˜èªè¡¨æƒ…ï¼Œè¨­ç½®ç¬¬ä¸€å€‹ç‚ºé»˜èª
  if(wasDefault && charExpressions.length > 0){
    charExpressions[0].isDefault = true;
  }
  
  renderCharExpressions();
  toast(T('è¡¨æƒ…å·²åˆªé™¤'), 'success');
}

// AI è‡ªå‹•åˆ‡æ›è¡¨æƒ…
async function autoSwitchExpression(charId, aiResponse){
  const char = await db.characters.get(charId);
  if(!char || !char.expressions || char.expressions.length === 0) return null;
  if(char.expressionMode !== 'auto') return null;
  
  const responseText = aiResponse.toLowerCase();
  
  // æª¢æŸ¥æ¯å€‹è¡¨æƒ…çš„é—œéµè©
  for(const expr of char.expressions){
    if(!expr.keywords || expr.keywords.length === 0) continue;
    
    const matched = expr.keywords.some(kw => responseText.includes(kw.toLowerCase()));
    if(matched){
      // æ›´æ–°ç•¶å‰è¡¨æƒ…
      await db.characters.update(charId, { currentExpression: expr.id });
      return expr;
    }
  }
  
  return null;
}

// ç²å–è§’è‰²ç•¶å‰è¡¨æƒ…
async function getCurrentExpression(charId){
  const char = await db.characters.get(charId);
  if(!char || !char.expressions || char.expressions.length === 0) return null;
  
  // å¦‚æœæœ‰ç•¶å‰è¡¨æƒ…ï¼Œè¿”å›å®ƒ
  if(char.currentExpression){
    const expr = char.expressions.find(e => e.id === char.currentExpression);
    if(expr) return expr;
  }
  
  // å¦å‰‡è¿”å›é»˜èªè¡¨æƒ…
  const defaultExpr = char.expressions.find(e => e.isDefault);
  return defaultExpr || char.expressions[0];
}

// æ‰‹å‹•åˆ‡æ›è¡¨æƒ…
async function switchExpression(charId, exprId){
  await db.characters.update(charId, { currentExpression: exprId });
  toast(T('è¡¨æƒ…å·²åˆ‡æ›'), 'success');
  
  // æ›´æ–°é¡¯ç¤º
  renderCharacterExpressionInChat(charId);
}

// åœ¨èŠå¤©ä¸­æ¸²æŸ“è§’è‰²è¡¨æƒ…
async function renderCharacterExpressionInChat(charId){
  const expr = await getCurrentExpression(charId);
  const displays = document.querySelectorAll(`.char-expr-display[data-char-id="${charId}"]`);
  
  displays.forEach(display => {
    if(expr && expr.image){
      display.src = expr.image;
      display.style.display = 'block';
    } else {
      display.style.display = 'none';
    }
  });
}

// æª¢æŸ¥ä¸¦è‡ªå‹•åˆ‡æ›æ‰€æœ‰è§’è‰²çš„è¡¨æƒ…
async function checkAutoExpressionSwitch(aiResponse){
  if(!story) return;
  
  const chars = await db.characters.where('storyId').equals(story.id).toArray();
  
  for(const char of chars){
    if(char.expressionMode !== 'auto') continue;
    if(!char.expressions || char.expressions.length === 0) continue;
    
    const switched = await autoSwitchExpression(char.id, aiResponse);
    if(switched){
      console.log(`Expression switched for ${char.name}: ${switched.name}`);
    }
  }
}

// v21: æ›´æ–°ç¶“ç‡Ÿæ¨¡å¼ UIï¼ˆé›™è»Œä¸¦è¡Œï¼šè³‡æºé¢æ¿ + è§’è‰²ç³»çµ±éƒ½å¯ç”¨ï¼‰
function updateSimulationUI(){
  const isSimMode = story?.mode === 'simulation';
  const resourceBar = document.getElementById('sim-resource-bar');
  const btnCharacters = document.getElementById('btn-characters');
  
  if(isSimMode){
    resourceBar.style.display = 'flex';
    // v21: ç¶“ç‡Ÿæ¨¡å¼ä¸‹ä¹Ÿä¿ç•™è§’è‰²ç‹€æ…‹æŒ‰éˆ•ï¼ˆé›™è»Œä¸¦è¡Œï¼‰
    btnCharacters.style.display = '';
    renderSimResourceBar();
  } else {
    resourceBar.style.display = 'none';
    btnCharacters.style.display = '';
  }
}

// v19: æ¸²æŸ“è³‡æºé¢æ¿
function renderSimResourceBar(){
  const bar = document.getElementById('sim-resource-bar');
  if(!story || story.mode !== 'simulation') return;
  
  const day = story.simDay || 1;
  const resources = story.simResources || [];
  
  let html = `<div class="sim-day-badge" onclick="showSimResourceModal()">ğŸ“… ç¬¬ ${day} å¤©</div>`;
  
  resources.forEach(r => {
    const change = r.value - (r.prevValue || r.value);
    let changeHtml = '';
    if(change !== 0){
      const cls = change > 0 ? 'up' : 'down';
      const sign = change > 0 ? '+' : '';
      changeHtml = `<span class="sim-resource-change ${cls}">${sign}${formatNumber(change)}</span>`;
    }
    html += `
      <div class="sim-resource-item" onclick="showSimResourceModal()">
        <span class="sim-resource-icon">${r.icon}</span>
        <span class="sim-resource-value">${formatNumber(r.value)}</span>
        ${changeHtml}
      </div>
    `;
  });
  
  bar.innerHTML = html;
}

function formatNumber(n){
  if(Math.abs(n) >= 10000) return (n/10000).toFixed(1) + 'è¬';
  if(Math.abs(n) >= 1000) return n.toLocaleString();
  return n.toString();
}

// v19: é¡¯ç¤ºè³‡æºç®¡ç† Modal
function showSimResourceModal(){
  if(!story || story.mode !== 'simulation'){
    toast(T('æ­¤æ•…äº‹ä¸æ˜¯ç¶“ç‡Ÿæ¨¡å¼'),'warning');
    return;
  }
  
  document.getElementById('sim-current-day').value = story.simDay || 1;
  
  const list = document.getElementById('sim-resource-list');
  const resources = story.simResources || [];
  
  list.innerHTML = resources.map((r, idx) => `
    <div style="display:flex;gap:6px;align-items:center" data-idx="${idx}">
      <input type="text" class="form-input" style="width:50px;text-align:center" value="${r.icon}" maxlength="2">
      <input type="text" class="form-input" style="flex:1" value="${esc(r.name)}">
      <input type="number" class="form-input" style="width:90px" value="${r.value}">
      <button onclick="removeSimResourceInModal(this)" style="background:none;border:none;color:var(--error);cursor:pointer;font-size:16px">âœ•</button>
    </div>
  `).join('');
  
  showModal('sim-resource-modal');
}

function addSimResourceInModal(){
  const list = document.getElementById('sim-resource-list');
  const div = document.createElement('div');
  div.style.cssText = 'display:flex;gap:6px;align-items:center';
  div.innerHTML = `
    <input type="text" class="form-input" style="width:50px;text-align:center" placeholder="ğŸ“Š" maxlength="2">
    <input type="text" class="form-input" style="flex:1" placeholder="è³‡æºåç¨±">
    <input type="number" class="form-input" style="width:90px" placeholder="æ•¸å€¼" value="0">
    <button onclick="removeSimResourceInModal(this)" style="background:none;border:none;color:var(--error);cursor:pointer;font-size:16px">âœ•</button>
  `;
  list.appendChild(div);
}

function removeSimResourceInModal(btn){
  btn.parentElement.remove();
}

function simDayMinus(){
  const input = document.getElementById('sim-current-day');
  input.value = Math.max(1, parseInt(input.value) - 1);
}

function simDayPlus(){
  const input = document.getElementById('sim-current-day');
  input.value = parseInt(input.value) + 1;
}

async function saveSimResources(){
  if(!story) return;
  
  const day = parseInt(document.getElementById('sim-current-day').value) || 1;
  const rows = document.querySelectorAll('#sim-resource-list > div');
  const resources = [];
  
  rows.forEach(row => {
    const inputs = row.querySelectorAll('input');
    if(inputs.length >= 3){
      const icon = inputs[0].value.trim() || 'ğŸ“Š';
      const name = inputs[1].value.trim();
      const value = parseFloat(inputs[2].value) || 0;
      // ä¿ç•™ä¹‹å‰çš„ prevValue ç”¨æ–¼è¨ˆç®—è®ŠåŒ–
      const oldResource = story.simResources?.find(r => r.name === name);
      if(name) resources.push({
        icon, 
        name, 
        value, 
        prevValue: oldResource?.value ?? value
      });
    }
  });
  
  story.simDay = day;
  story.simResources = resources;
  
  await db.stories.update(story.id, {simDay: day, simResources: resources});
  
  renderSimResourceBar();
  closeModal('sim-resource-modal');
  toast(T('è³‡æºå·²æ›´æ–°'),'success');
}

// v19: å¿«é€Ÿæ›´æ–°è³‡æºï¼ˆ+1å¤©ï¼‰
async function simNextDay(){
  if(!story || story.mode !== 'simulation') return;
  
  // ä¿å­˜ç•¶å‰å€¼ç‚º prevValue
  const resources = (story.simResources || []).map(r => ({
    ...r,
    prevValue: r.value
  }));
  
  story.simDay = (story.simDay || 1) + 1;
  story.simResources = resources;
  
  await db.stories.update(story.id, {simDay: story.simDay, simResources: resources});
  renderSimResourceBar();
  toast(`é€²å…¥ç¬¬ ${story.simDay} å¤©`,'info');
}

// v19: å­˜æª”å°å…¥
function showSimImportModal(){
  if(!story || story.mode !== 'simulation'){
    toast(T('æ­¤æ•…äº‹ä¸æ˜¯ç¶“ç‡Ÿæ¨¡å¼'),'warning');
    return;
  }
  document.getElementById('sim-import-content').value = '';
  document.getElementById('sim-import-regex').value = '';
  document.getElementById('sim-import-preview').style.display = 'none';
  showModal('sim-import-modal');
}

function parseSimImport(){
  const content = document.getElementById('sim-import-content').value;
  const customRegex = document.getElementById('sim-import-regex').value;
  
  if(!content.trim()){
    toast(T('è«‹è²¼å…¥å­˜æª”å…§å®¹'),'warning');
    return;
  }
  
  const result = {day: null, resources: []};
  
  // å˜—è©¦è§£æå¤©æ•¸
  const dayPatterns = [
    /ç¬¬\s*(\d+)\s*å¤©/,
    /Day\s*(\d+)/i,
    /éŠæˆ²æ—¥æœŸ.*?(\d+)å¤©/,
    /å·²éŠç©.*?(\d+)\s*å¤©/
  ];
  for(const p of dayPatterns){
    const m = content.match(p);
    if(m) { result.day = parseInt(m[1]); break; }
  }
  
  // å˜—è©¦è§£æè³‡æº
  const resourcePatterns = [
    // ğŸ’° ç¾é‡‘ï¼š100,000å…ƒ
    /([ğŸ’°ğŸ“¦ğŸ‘¥ğŸ’â­ğŸ”®â¤ï¸ğŸ–ğŸ˜ŠğŸ“ŠğŸ´])\s*([^ï¼š:]+)[ï¼š:]\s*([\d,]+)/g,
    // ç¾é‡‘ï¼š100,000å…ƒ
    /([^\sï¼š:]+)[ï¼š:]\s*([\d,]+)\s*å…ƒ?/g
  ];
  
  if(customRegex){
    try{
      const regex = new RegExp(customRegex, 'g');
      let m;
      while((m = regex.exec(content)) !== null){
        if(m[1] && m[2]){
          result.resources.push({icon:'ğŸ“Š', name:m[1], value:parseInt(m[2].replace(/,/g,''))});
        }
      }
    }catch(e){
      toast('æ­£å‰‡è¡¨é”å¼éŒ¯èª¤: '+e.message,'error');
      return;
    }
  } else {
    // ä½¿ç”¨é»˜èªæ¨¡å¼
    for(const p of resourcePatterns){
      p.lastIndex = 0; // é‡ç½®æ­£å‰‡è¡¨é”å¼ç‹€æ…‹
      let m;
      while((m = p.exec(content)) !== null){
        const isEmoji = /[\u{1F300}-\u{1F9FF}]/u.test(m[1]);
        if(isEmoji){
          result.resources.push({
            icon: m[1],
            name: m[2].trim(),
            value: parseInt(m[3].replace(/,/g,''))
          });
        } else if(m[1] && m[2]){
          result.resources.push({
            icon: 'ğŸ“Š',
            name: m[1].trim(),
            value: parseInt(m[2].replace(/,/g,''))
          });
        }
      }
    }
  }
  
  // å»é‡
  const seen = new Set();
  result.resources = result.resources.filter(r => {
    if(seen.has(r.name)) return false;
    seen.add(r.name);
    return true;
  });
  
  // é¡¯ç¤ºé è¦½
  const preview = document.getElementById('sim-import-preview');
  const previewContent = document.getElementById('sim-import-preview-content');
  
  let html = '';
  if(result.day) html += `<div>ğŸ“… å¤©æ•¸ï¼šç¬¬ ${result.day} å¤©</div>`;
  if(result.resources.length){
    html += '<div style="margin-top:8px">è³‡æºï¼š</div>';
    html += result.resources.map(r => 
      `<div style="margin-left:12px">${r.icon} ${r.name}ï¼š${r.value.toLocaleString()}</div>`
    ).join('');
  }
  
  if(!html) html = '<div style="color:var(--text-tertiary)">æœªèƒ½è§£æå‡ºä»»ä½•æ•¸æ“šï¼Œè«‹æª¢æŸ¥æ ¼å¼æˆ–ä½¿ç”¨è‡ªå®šç¾©æ­£å‰‡</div>';
  
  previewContent.innerHTML = html;
  preview.style.display = 'block';
  
  // ä¿å­˜è§£æçµæœä¾›å°å…¥ä½¿ç”¨
  preview.dataset.result = JSON.stringify(result);
}

async function applySimImport(){
  const preview = document.getElementById('sim-import-preview');
  if(!preview.dataset.result){
    parseSimImport();
  }
  
  try{
    const result = JSON.parse(preview.dataset.result || '{}');
    
    if(result.day) story.simDay = result.day;
    if(result.resources?.length){
      story.simResources = result.resources.map(r => ({...r, prevValue: r.value}));
    }
    
    await db.stories.update(story.id, {
      simDay: story.simDay,
      simResources: story.simResources
    });
    
    renderSimResourceBar();
    closeModal('sim-import-modal');
    toast(T('å­˜æª”å°å…¥æˆåŠŸï¼'),'success');
  }catch(e){
    toast('å°å…¥å¤±æ•—: '+e.message,'error');
  }
}

// v19: å­˜æª”å°å‡º
function showSimExportModal(){
  if(!story || story.mode !== 'simulation'){
    toast(T('æ­¤æ•…äº‹ä¸æ˜¯ç¶“ç‡Ÿæ¨¡å¼'),'warning');
    return;
  }
  document.getElementById('sim-export-format').value = 'simple';
  document.getElementById('sim-export-template-group').style.display = 'none';
  generateSimExport();
  showModal('sim-export-modal');
}

function generateSimExport(){
  const format = document.getElementById('sim-export-format').value;
  const templateGroup = document.getElementById('sim-export-template-group');
  templateGroup.style.display = format === 'custom' ? 'block' : 'none';
  
  const day = story.simDay || 1;
  const resources = story.simResources || [];
  const title = story.title;
  
  let content = '';
  
  if(format === 'simple'){
    content = `ã€${title}ã€‘å­˜æª”\n`;
    content += `ğŸ“… ç¬¬ ${day} å¤©\n\n`;
    content += `ã€ç•¶å‰ç‹€æ…‹ã€‘\n`;
    resources.forEach(r => {
      content += `${r.icon} ${r.name}ï¼š${r.value.toLocaleString()}\n`;
    });
  } else if(format === 'detailed'){
    content = `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;
    content += `ã€${title}ã€‘å®Œæ•´å­˜æª”\n`;
    content += `å­˜æª”æ™‚é–“ï¼š${new Date().toLocaleString()}\n`;
    content += `éŠæˆ²æ—¥æœŸï¼šç¬¬ ${day} å¤©\n`;
    content += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`;
    content += `ã€ç•¶å‰ç‹€æ…‹ã€‘\n`;
    resources.forEach(r => {
      content += `${r.icon} ${r.name}ï¼š${r.value.toLocaleString()}\n`;
    });
    content += `\nã€æ•…äº‹æ‘˜è¦ã€‘\n`;
    if(story.summaries?.length){
      story.summaries.forEach((s, i) => {
        content += `\n--- è¨˜æ†¶ç‰‡æ®µ ${i+1} ---\n${s.content}\n`;
      });
    } else {
      content += `ï¼ˆæš«ç„¡æ‘˜è¦ï¼‰\n`;
    }
    content += `\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;
    content += `å°‡æ­¤å­˜æª”å®Œæ•´è²¼çµ¦æ–°å°è©±å³å¯ç¹¼çºŒéŠæˆ²\n`;
    content += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`;
  } else {
    // è‡ªå®šç¾©æ¨¡æ¿
    const template = document.getElementById('sim-export-template').value;
    content = template
      .replace(/{day}/g, day)
      .replace(/{title}/g, title)
      .replace(/{resources}/g, resources.map(r => `${r.icon} ${r.name}ï¼š${r.value.toLocaleString()}`).join('\n'))
      .replace(/{summary}/g, story.summaries?.map(s=>s.content).join('\n\n') || 'ï¼ˆæš«ç„¡ï¼‰');
  }
  
  document.getElementById('sim-export-content').value = content;
}

async function copySimExport(){
  const content = document.getElementById('sim-export-content').value;
  try{
    await navigator.clipboard.writeText(content);
    toast(T('å·²è¤‡è£½åˆ°å‰ªè²¼æ¿'),'success');
  }catch(e){
    toast(T('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½'),'error');
  }
}
function renderMsgs(){
  const c=document.getElementById('content-area');
  if(!msgs.length){c.innerHTML=`<div class="empty" style="padding:60px 20px"><div class="empty-icon">âœ¨</div><div class="empty-title">${T('æ•…äº‹å³å°‡é–‹å§‹')}</div><div class="empty-desc">${T('è¼¸å…¥ä½ çš„ç¬¬ä¸€å€‹è¡Œå‹•ï¼Œæˆ–é»æ“Šã€Œç¹¼çºŒã€è®“AIé–‹å§‹è¬›è¿°...')}</div></div>`;updateProgress();return;}
  let html='',lastTime=null,floor=0;
  msgs.forEach((m,idx)=>{
    floor++;
    if(m.storyTime&&m.storyTime!==lastTime){html+=`<div class="time-div">${esc(m.storyTime)}</div>`;lastTime=m.storyTime;}
    const isUser=m.role==='user';
    const isLast = idx === msgs.length - 1;
    
    if(isUser){
      // å°èªªå¼ï¼šç”¨æˆ¶è¡Œå‹•å±…ä¸­é¡¯ç¤º
      html+=`<div class="msg user" data-id="${m.id}" oncontextmenu="showMsgMenu(event,'${m.id}')">
        <span class="msg-floor">#${floor}</span>
        <div class="msg-menu-btn" onclick="showMsgActionMenu(event,'${m.id}','user')">â‹¯</div>
        <div class="msg-user-action">
          <div class="action-divider">ä½ çš„è¡Œå‹•</div>
          <div class="action-content">ã€Œ${esc(m.content).replace(/^[ã€Œã€]|[ã€Œã€]$/g,'')}ã€</div>
        </div>
      </div>`;
    }else{
      // AI æ¶ˆæ¯ï¼šåˆ†é›¢åŠ‡æƒ…å’Œç‹€æ…‹
      const parsed = parseAIResponse(m.content||'');
      html+=`<div class="msg" data-id="${m.id}" oncontextmenu="showMsgMenu(event,'${m.id}')">`;
      html+=`<span class="msg-floor">#${floor}</span>`;
      html+=`<div class="msg-menu-btn" onclick="showMsgActionMenu(event,'${m.id}','ai')">â‹¯</div>`;
      html+=`<div class="msg-ai-story">${marked.parse(parsed.story)}</div>`;
      if(parsed.characters && parsed.characters.length > 0){
        html+=renderStatusCards(parsed.characters, m.id);
      }
      if(parsed.formatWarning){
        html+=`<div class="msg-format-warning"><span class="icon">âš ï¸</span>AI æœªæŒ‰æ ¼å¼è¼¸å‡ºç‹€æ…‹æ•¸æ“šï¼Œå·²é¡¯ç¤ºåŸæ–‡</div>`;
      }
      if(m.tokens){
        html+=`<div class="msg-timestamp">â‰ˆ${m.tokens} tokens</div>`;
      }
      html+=`</div>`;
    }
  });
  c.innerHTML=html;
  c.scrollTop=c.scrollHeight;
  updateProgress();
}

// è§£æ AI å›è¦†ï¼Œåˆ†é›¢åŠ‡æƒ…å’Œè§’è‰²ç‹€æ…‹
function parseAIResponse(content){
  let story = content;
  let characters = [];
  let formatWarning = false;
  
  // å˜—è©¦åŒ¹é… JSON ä»£ç¢¼å¡Š
  const jsonMatch = content.match(/```json\s*([\s\S]*?)\s*```/);
  if(jsonMatch){
    try{
      const jsonStr = jsonMatch[1];
      const data = JSON.parse(jsonStr);
      if(data.characters && Array.isArray(data.characters)){
        characters = data.characters;
        // ç§»é™¤ JSON éƒ¨åˆ†ï¼Œåªä¿ç•™åŠ‡æƒ…
        story = content.replace(/```json\s*[\s\S]*?\s*```/, '').trim();
        // ç§»é™¤å¯èƒ½çš„åˆ†éš”ç·š
        story = story.replace(/[-â”€]{3,}\s*(?:ç‹€æ…‹æ›´æ–°|è§’è‰²ç‹€æ…‹|ç¾æœ‰å¾Œå®®|ç‹€æ…‹)\s*[-â”€]{3,}/gi, '').trim();
      }
    }catch(e){
      console.log('JSON parse error:', e);
      formatWarning = true;
    }
  }else{
    // æª¢æŸ¥æ˜¯å¦æœ‰ç‹€æ…‹å…§å®¹ä½†æ²’ç”¨ JSON æ ¼å¼
    const hasStatusMarker = /[-â”€]{3,}\s*(?:ç‹€æ…‹æ›´æ–°|è§’è‰²ç‹€æ…‹|ç¾æœ‰å¾Œå®®|ç‹€æ…‹|ç¾æœ‰è§’è‰²)\s*[-â”€]{3,}/i.test(content);
    const hasCharacterBlock = /ã€[^ã€‘]+ã€‘[^\n]+/.test(content);
    if(hasStatusMarker || hasCharacterBlock){
      // å˜—è©¦è§£æèˆŠæ ¼å¼
      const parsed = parseOldFormatStatus(content);
      if(parsed.characters.length > 0){
        characters = parsed.characters;
        story = parsed.story;
      }else{
        formatWarning = hasStatusMarker; // æœ‰æ¨™è¨˜ä½†è§£æå¤±æ•—æ‰è­¦å‘Š
      }
    }
  }
  
  return { story, characters, formatWarning };
}

// è§£æèˆŠæ ¼å¼ç‹€æ…‹ï¼ˆã€è§’è‰²ã€‘æ ¼å¼ï¼‰
function parseOldFormatStatus(content){
  let story = content;
  let characters = [];
  
  // æ‰¾åˆ°ç‹€æ…‹åˆ†éš”ç·š
  const statusMatch = content.match(/([-â”€]{3,}\s*(?:ç‹€æ…‹æ›´æ–°|è§’è‰²ç‹€æ…‹|ç¾æœ‰å¾Œå®®|ç‹€æ…‹|ç¾æœ‰è§’è‰²)\s*[-â”€]{3,})([\s\S]*?)(?=[-â”€]{3,}|$)/i);
  if(statusMatch){
    story = content.slice(0, content.indexOf(statusMatch[0])).trim();
    const statusText = statusMatch[2];
    
    // è§£æã€è§’è‰²ã€‘æ ¼å¼
    const charBlocks = statusText.split(/(?=ã€[^ã€‘]+ã€‘)/);
    charBlocks.forEach(block => {
      if(!block.trim()) return;
      const nameMatch = block.match(/ã€([^ã€‘]+)ã€‘\s*([^\sã€]+)?/);
      if(nameMatch){
        const char = {
          name: nameMatch[2] || nameMatch[1],
          title: nameMatch[1].includes('ã€‘') ? '' : nameMatch[1],
          stats: {},
          tags: []
        };
        
        // æå–æ•¸å€¼å±¬æ€§
        const statPatterns = [
          /å¥½æ„Ÿ[åº¦]?\s*(\d+)/g,
          /è¡¨é¢å¥½æ„Ÿ\s*(\d+)/g,
          /çœŸå¯¦å¥½æ„Ÿ\s*(\d+)/g,
          /å¯µæ„›[åº¦]?\s*(\d+)/g,
          /å¿ èª [åº¦]?\s*(\d+)/g,
          /é‡å¿ƒ[å€¼]?\s*(\d+)/g,
          /æ™ºè¬€\s*(\d+)/g,
          /å®¹è²Œ\s*(\d+)/g,
          /å¥åº·\s*(\d+)/g
        ];
        
        const statNames = ['å¥½æ„Ÿ', 'è¡¨é¢å¥½æ„Ÿ', 'çœŸå¯¦å¥½æ„Ÿ', 'å¯µæ„›åº¦', 'å¿ èª ', 'é‡å¿ƒ', 'æ™ºè¬€', 'å®¹è²Œ', 'å¥åº·'];
        statPatterns.forEach((pattern, i) => {
          const match = block.match(pattern);
          if(match){
            char.stats[statNames[i]] = parseInt(match[1]);
          }
        });
        
        // æå–æƒ…ç·’
        const moodMatch = block.match(/æƒ…ç·’[ï¼š:]\s*([^\s|ï½œ]+)/);
        if(moodMatch) char.mood = moodMatch[1];
        
        // æå–å±…æ‰€
        const locationMatch = block.match(/å±…æ‰€[ï¼š:Â·]?\s*([^\s|ï½œ]+)/);
        if(locationMatch) char.location = locationMatch[1];
        
        if(Object.keys(char.stats).length > 0 || char.mood){
          characters.push(char);
        }
      }
    });
  }
  
  return { story, characters };
}

// æ¸²æŸ“ç‹€æ…‹å¡ç‰‡
function renderStatusCards(characters, msgId){
  if(!characters || characters.length === 0) return '';
  
  let html = `<div class="msg-status-section">`;
  html += `<div class="msg-status-header" onclick="toggleStatusCards(this)">`;
  html += `<span class="title">ğŸ‘¥ è§’è‰²ç‹€æ…‹æ›´æ–° (${characters.length})</span>`;
  html += `<span class="toggle">â–¼</span>`;
  html += `</div>`;
  html += `<div class="msg-status-cards">`;
  
  characters.forEach(char => {
    html += `<div class="status-card">`;
    html += `<div class="status-card-header">`;
    html += `<div class="status-card-avatar">${char.avatar || 'ğŸ‘¤'}</div>`;
    html += `<div class="status-card-info">`;
    html += `<div class="status-card-name">${esc(char.name)}`;
    if(char.title) html += `<span class="status-card-title">${esc(char.title)}</span>`;
    html += `</div>`;
    if(char.location) html += `<div class="status-card-meta">ğŸ“ ${esc(char.location)}</div>`;
    html += `</div></div>`;
    
    // æ¸²æŸ“æ•¸å€¼å±¬æ€§
    if(char.stats && Object.keys(char.stats).length > 0){
      html += `<div class="status-card-stats">`;
      Object.entries(char.stats).forEach(([key, value]) => {
        const numValue = typeof value === 'number' ? value : parseInt(value) || 0;
        const fillClass = numValue >= 70 ? 'high' : numValue >= 40 ? 'medium' : numValue > 0 ? 'low' : 'primary';
        html += `<div class="status-stat-row">`;
        html += `<span class="status-stat-label">${esc(key)}</span>`;
        html += `<div class="status-stat-bar"><div class="status-stat-fill ${fillClass}" style="width:${Math.min(100, numValue)}%"></div></div>`;
        html += `<span class="status-stat-value">${numValue}</span>`;
        html += `</div>`;
      });
      html += `</div>`;
    }
    
    // æ¸²æŸ“æ¨™ç±¤ï¼ˆæƒ…ç·’ã€å‚™è¨»ç­‰ï¼‰
    const hasTags = char.mood || char.note || (char.tags && char.tags.length > 0);
    if(hasTags){
      html += `<div class="status-card-footer">`;
      if(char.mood) html += `<span class="status-tag mood">ğŸ˜ ${esc(char.mood)}</span>`;
      if(char.note) html += `<span class="status-tag note">ğŸ’­ ${esc(char.note)}</span>`;
      if(char.tags) char.tags.forEach(tag => {
        html += `<span class="status-tag">${esc(tag)}</span>`;
      });
      html += `</div>`;
    }
    
    html += `</div>`;
  });
  
  html += `</div></div>`;
  return html;
}

// åˆ‡æ›ç‹€æ…‹å¡ç‰‡å±•é–‹/æ”¶èµ·
function toggleStatusCards(header){
  header.classList.toggle('expanded');
}

function updateProgress(){const n=msgs.length;document.getElementById('progress-fill').style.width=(n>0?100:0)+'%';document.getElementById('progress-text').textContent=n>0?n+'æ¢':'0%';}

// ç™¼é€æ¶ˆæ¯
async function send(){
  const input=document.getElementById('user-input'),content=input.value.trim();
  if(!content||generating)return;
  if(!story){toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'),'warning');return;}

  generating=true;
  const sendBtn=document.getElementById('send-btn');
  sendBtn.disabled=true;

  // ä¿å­˜ç”¨æˆ·æ¶ˆæ¯
  const userMsgId=crypto.randomUUID();
  const userMsg={id:userMsgId,storyId:story.id,branchId:story.currentBranchId,role:'user',content,createdAt:Date.now()};
  await db.messages.put(userMsg);
  msgs.push(userMsg);
  input.value='';
  renderMsgs();

  // æ£€æŸ¥æ˜¯å¦å¯ç”¨æµå¼å“åº”
  const useStreaming=settings.enableStreaming;

  if(useStreaming){
    // æµå¼å“åº”æ¨¡å¼
    await sendWithStreaming(content,sendBtn);
  }else{
    // ä¼ ç»Ÿæ¨¡å¼
    await sendTraditional(content);
  }

  generating=false;
  sendBtn.disabled=false;
}

// ä¼ ç»Ÿéæµå¼å‘é€
async function sendTraditional(content){
  showTyping();
  try{
    const resp=await callAI(content);
    hideTyping();
    const aiMsgId=crypto.randomUUID();
    const aiMsg={id:aiMsgId,storyId:story.id,branchId:story.currentBranchId,role:'assistant',content:resp.content,tokens:resp.tokens||0,storyTime:story.storyTime||'',createdAt:Date.now()};
    await db.messages.put(aiMsg);
    msgs.push(aiMsg);
    await db.stories.update(story.id,{updatedAt:Date.now(),preview:resp.content.slice(0,100),currentMessageId:aiMsgId,'statistics.totalMessages':msgs.length,'statistics.totalChars':(story.statistics?.totalChars||0)+resp.content.length});
    await typewriter(aiMsg);
    checkAutoRollingSummary();
  }catch(e){
    console.error(e);
    hideTyping();
    toast('ç”Ÿæˆå¤±æ•—: '+e.message,'error');
  }
}

// æµå¼å‘é€
async function sendWithStreaming(content,sendBtn){
  const preset=await db.apiPresets.filter(p=>p.isActive).first();
  if(!preset){toast(T('è«‹å…ˆé…ç½®ä¸¦é¸æ“‡ä¸€å€‹ API é è¨­'),'error');return;}

  // æ„å»ºç³»ç»Ÿæç¤ºå’Œæ¶ˆæ¯
  let sysPrompt=await buildSysPrompt();
  const triggeredLorebook=await getTriggeredLorebook(content);
  if(triggeredLorebook.length>0){
    sysPrompt+='\n\n### ç›¸é—œè¨­å®šï¼ˆè‡ªå‹•è§¸ç™¼ï¼‰\n';
    for(const entry of triggeredLorebook){
      if(entry.name && entry.content){
        sysPrompt+=`\n#### ${entry.name}\n${entry.content}\n`;
      }
      await db.lorebook.update(entry.id,{triggerCount:(entry.triggerCount||0)+1,lastTriggered:Date.now()});
      if(entry.oneTime)await db.lorebook.update(entry.id,{isEnabled:false});
    }
    showLorebookTriggerToast(triggeredLorebook);
  }

  const contextCount=settings.contextCount||20;
  const messages=msgs.slice(-contextCount).map(m=>({role:m.role,content:m.content}));
  if(!messages.length||messages[messages.length-1].content!==content)messages.push({role:'user',content});
  
  // v25: æ³¨å…¥å¾Œæ­·å²æŒ‡ä»¤ (post_history_instructions)
  const postHistoryInstructions = await getPostHistoryInstructions();
  if(postHistoryInstructions){
    // åœ¨æœ€å¾Œä¸€æ¢ç”¨æˆ¶æ¶ˆæ¯å¾Œæ·»åŠ ç³»çµ±æŒ‡ä»¤
    messages.push({
      role: 'user',
      content: `[ç³»çµ±æŒ‡ä»¤ï¼š${postHistoryInstructions}]`
    });
  }

  // åˆ›å»ºç©ºçš„AIæ¶ˆæ¯å…ƒç´ 
  const c=document.getElementById('content-area');
  const aiMsgId=crypto.randomUUID();
  const msgDiv=document.createElement('div');
  msgDiv.className='msg';
  msgDiv.dataset.id=aiMsgId;
  c.appendChild(msgDiv);

  // æ›¿æ¢å‘é€æŒ‰é’®ä¸ºåœæ­¢æŒ‰é’®
  sendBtn.textContent='â– ';
  sendBtn.style.background='var(--error)';
  sendBtn.disabled=false;  // é‡è¦ï¼šå¯ç”¨æŒ‰é’®è®©ç”¨æˆ·å¯ä»¥ç‚¹å‡»åœæ­¢
  sendBtn.onclick=()=>stopStreaming();

  let fullContent='';
  let stopped=false;
  const chunkDelay=settings.streamingChunkDelay||20;

  try{
    // é€‰æ‹©å¯¹åº”çš„æµå¼APIå‡½æ•°
    let streamFunc;
    if(preset.type==='anthropic')streamFunc=callAnthropicStream;
    else if(preset.type==='openai')streamFunc=callOpenAIStream;
    else streamFunc=callCustomStream;

    // è°ƒç”¨æµå¼API
    const result=await streamFunc(
      preset,
      sysPrompt,
      messages,
      // onChunk: æ”¶åˆ°æ–°æ–‡å­—æ—¶
      async(newText,full)=>{
        fullContent=full;
        // è½»å¾®å»¶è¿Ÿä»¥å®ç°å¹³æ»‘æ˜¾ç¤º
        if(chunkDelay>0){
          await new Promise(r=>setTimeout(r,chunkDelay));
        }
        msgDiv.innerHTML=`<div class="msg-ai-story">${marked.parse(full)}</div>`;
        c.scrollTop=c.scrollHeight;
      },
      // onDone: ç”Ÿæˆå®Œæˆ
      (final)=>{
        fullContent=final;
      },
      // onError: å‘ç”Ÿé”™è¯¯
      (error,partial)=>{
        fullContent=partial;
        stopped=true;
      }
    );

    if(result.stopped)stopped=true;

  }catch(e){
    console.error(e);
    stopped=true;

    // æ£€æŸ¥æ˜¯å¦æ˜¯ä¸æ”¯æŒæµå¼çš„é”™è¯¯
    const errMsg=e.message||'';
    if(errMsg.includes('stream')&&!errMsg.includes('åœæ­¢')){
      toast(T('æ­¤ API ä¸æ”¯æŒæµå¼éŸ¿æ‡‰ï¼Œå·²è‡ªå‹•åˆ‡æ›åˆ°å‚³çµ±æ¨¡å¼'),'warning');
      // é™çº§åˆ°éæµå¼
      sendBtn.textContent='â†‘';
      sendBtn.style.background='';
      sendBtn.onclick=()=>send();
      msgDiv.remove();
      await sendTraditional(content);
      return;
    }

    if(!errMsg.includes('åœæ­¢')){
      toast('ç”Ÿæˆå¤±æ•—: '+errMsg,'error');
    }
  }

  // æ¢å¤å‘é€æŒ‰é’®
  sendBtn.textContent='â†‘';
  sendBtn.style.background='';
  sendBtn.onclick=()=>send();

  // å¤„ç†ç”Ÿæˆçš„å†…å®¹
  if(stopped){
    // ç”¨æˆ·ä¸­é€”åœæ­¢,è¯¢é—®æ˜¯å¦ä¿å­˜
    if(fullContent&&fullContent.length>10){
      showConfirm('ç”Ÿæˆå·²åœæ­¢ï¼Œæ˜¯å¦ä¿å­˜å·²ç”Ÿæˆçš„å…§å®¹ï¼Ÿ',async()=>{
        await saveStreamedMessage(aiMsgId,fullContent,msgDiv);
      },false,'ç¢ºèª',()=>{
        msgDiv.remove();
      });
    }else{
      msgDiv.remove();
    }
  }else{
    // æ­£å¸¸å®Œæˆ
    await saveStreamedMessage(aiMsgId,fullContent,msgDiv);
  }
}

// ä¿å­˜æµå¼ç”Ÿæˆçš„æ¶ˆæ¯
async function saveStreamedMessage(aiMsgId,fullContent,msgDiv){
  // ä¼°ç®— token æ•¸é‡ï¼ˆä¸­æ–‡ç´„2å­—ç¬¦=1tokenï¼Œè‹±æ–‡ç´„4å­—ç¬¦=1tokenï¼‰
  const estimatedTokens = Math.round(fullContent.length / 2);
  const aiMsg={id:aiMsgId,storyId:story.id,branchId:story.currentBranchId,role:'assistant',content:fullContent,tokens:estimatedTokens,storyTime:story.storyTime||'',createdAt:Date.now()};
  await db.messages.put(aiMsg);
  msgs.push(aiMsg);
  await db.stories.update(story.id,{updatedAt:Date.now(),preview:fullContent.slice(0,100),currentMessageId:aiMsgId,'statistics.totalMessages':msgs.length,'statistics.totalChars':(story.statistics?.totalChars||0)+fullContent.length});

  // è§£æå¹¶æ˜¾ç¤ºå®Œæ•´å†…å®¹(åŒ…æ‹¬è§’è‰²çŠ¶æ€)
  const parsed=parseAIResponse(fullContent);
  let html=`<div class="msg-ai-story">${marked.parse(parsed.story)}</div>`;
  if(parsed.characters&&parsed.characters.length>0){
    html+=renderStatusCards(parsed.characters,aiMsgId);
    syncCharacterStatus(parsed.characters);
  }
  // v23: è‡ªå‹•è§£æç©å®¶ç‹€æ…‹
  parsePlayerStatusFromAI(fullContent);
  if(parsed.formatWarning){
    html+=`<div class="msg-format-warning"><span class="icon">âš ï¸</span>AI æœªæŒ‰æ ¼å¼è¼¸å‡ºç‹€æ…‹æ•¸æ“šï¼Œå·²é¡¯ç¤ºåŸæ–‡</div>`;
  }
  msgDiv.innerHTML=html;
  checkAutoRollingSummary();
}
function sendCmd(cmd){document.getElementById('user-input').value=cmd;send();}

// ============ å¿«æ·æŒ‡ä»¤ç³»çµ± ============
const defaultQuickCommands = [
  { id: 'default_1', label: 'ç¹¼çºŒ', content: 'ç¹¼çºŒ', order: 1 },
  { id: 'default_2', label: 'ç‹€æ…‹', content: 'æŸ¥çœ‹ç‹€æ…‹', order: 2 },
  { id: 'default_3', label: 'ç’°å¢ƒ', content: 'æè¿°ç’°å¢ƒ', order: 3 }
];

async function initDefaultQuickCommands(){
  const count = await db.quickCommands.count();
  if(count === 0){
    for(const cmd of defaultQuickCommands){
      await db.quickCommands.put({...cmd, createdAt: Date.now()});
    }
  }
}

async function renderQuickCommands(){
  const container = document.getElementById('quick-cmds');
  if(!container) return;
  
  const cmds = await db.quickCommands.orderBy('order').toArray();
  
  let html = '';
  cmds.forEach(cmd => {
    // å¯¹é»˜è®¤å‘½ä»¤æ ‡ç­¾è¿›è¡Œç®€ç¹è½¬æ¢
    const label = cmd.id.startsWith('default_') ? T(cmd.label) : cmd.label;
    html += `<button class="quick-cmd" onclick="sendCmd('${esc(cmd.content)}')">${esc(label)}</button>`;
  });
  html += `<button class="quick-cmd add" onclick="showQuickCmdManager()">ï¼‹</button>`;
  
  container.innerHTML = html;
}

function showQuickCmdManager(){
  renderQuickCmdList();
  showModal('quick-cmd-modal');
}

async function renderQuickCmdList(){
  const container = document.getElementById('quick-cmd-list');
  const cmds = await db.quickCommands.orderBy('order').toArray();
  
  if(cmds.length === 0){
    container.innerHTML = `<div style="text-align:center;padding:20px;color:var(--text-tertiary)">${T('æš«ç„¡å¿«æ·æŒ‡ä»¤')}</div>`;
    return;
  }
  
  let html = '';
  cmds.forEach(cmd => {
    html += `
      <div class="quick-cmd-item" data-id="${cmd.id}">
        <span class="drag-handle">â‹®â‹®</span>
        <div class="cmd-info">
          <div class="cmd-label">${esc(cmd.label)}</div>
          <div class="cmd-content">${esc(cmd.content)}</div>
        </div>
        <div class="cmd-actions">
          <button class="edit-btn" onclick="editQuickCommand('${cmd.id}')">ç·¨è¼¯</button>
          <button class="del-btn" onclick="deleteQuickCommand('${cmd.id}')">åˆªé™¤</button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

async function addQuickCommand(){
  const label = document.getElementById('new-cmd-label').value.trim();
  const content = document.getElementById('new-cmd-content').value.trim();
  
  if(!label){toast(T('è«‹è¼¸å…¥æŒ‰éˆ•é¡¯ç¤ºæ–‡å­—'),'warning');return;}
  if(!content){toast(T('è«‹è¼¸å…¥æŒ‡ä»¤å…§å®¹'),'warning');return;}
  
  const maxOrder = await db.quickCommands.orderBy('order').last();
  const order = maxOrder ? maxOrder.order + 1 : 1;
  
  await db.quickCommands.put({
    id: crypto.randomUUID(),
    label,
    content,
    order,
    createdAt: Date.now()
  });
  
  document.getElementById('new-cmd-label').value = '';
  document.getElementById('new-cmd-content').value = '';
  
  await renderQuickCmdList();
  await renderQuickCommands();
  toast(T('å¿«æ·æŒ‡ä»¤å·²æ·»åŠ '),'success');
}

async function editQuickCommand(id){
  const cmd = await db.quickCommands.get(id);
  if(!cmd) return;
  
  document.getElementById('edit-cmd-id').value = id;
  document.getElementById('edit-cmd-label').value = cmd.label;
  document.getElementById('edit-cmd-content').value = cmd.content;
  
  showModal('edit-cmd-modal');
}

async function saveEditQuickCommand(){
  const id = document.getElementById('edit-cmd-id').value;
  const label = document.getElementById('edit-cmd-label').value.trim();
  const content = document.getElementById('edit-cmd-content').value.trim();
  
  if(!label){toast(T('è«‹è¼¸å…¥æŒ‰éˆ•é¡¯ç¤ºæ–‡å­—'),'warning');return;}
  if(!content){toast(T('è«‹è¼¸å…¥æŒ‡ä»¤å…§å®¹'),'warning');return;}
  
  const cmd = await db.quickCommands.get(id);
  if(!cmd) return;
  
  cmd.label = label;
  cmd.content = content;
  await db.quickCommands.put(cmd);
  
  closeModal('edit-cmd-modal');
  await renderQuickCmdList();
  await renderQuickCommands();
  toast(T('å¿«æ·æŒ‡ä»¤å·²æ›´æ–°'),'success');
}

async function deleteQuickCommand(id){
  if(!confirm('ç¢ºå®šåˆªé™¤é€™å€‹å¿«æ·æŒ‡ä»¤ï¼Ÿ')) return;
  
  await db.quickCommands.delete(id);
  await renderQuickCmdList();
  await renderQuickCommands();
  toast(T('å¿«æ·æŒ‡ä»¤å·²åˆªé™¤'),'success');
}

async function resetQuickCommands(){
  if(!confirm('ç¢ºå®šæ¢å¾©é»˜èªå¿«æ·æŒ‡ä»¤ï¼Ÿé€™å°‡åˆªé™¤æ‰€æœ‰è‡ªå®šç¾©æŒ‡ä»¤ã€‚')) return;

  await db.quickCommands.clear();
  for(const cmd of defaultQuickCommands){
    await db.quickCommands.put({...cmd, createdAt: Date.now()});
  }

  await renderQuickCmdList();
  await renderQuickCommands();
  toast(T('å·²æ¢å¾©é»˜èªå¿«æ·æŒ‡ä»¤'),'success');
}

// ============ Persona ç³»çµ± ============
let currentPersona = null;

// åˆå§‹åŒ–é»˜èª Persona
async function initDefaultPersona(){
  const count = await db.personas.count();
  if(count === 0){
    const defaultPersona = {
      id: 'default',
      name: 'ç„¡ç‰¹å®šèº«ä»½',
      avatar: 'ğŸ‘¤',
      description: '',
      background: '',
      speechStyle: '',
      isDefault: true,
      createdAt: Date.now()
    };
    await db.personas.put(defaultPersona);
  }

  // è¼‰å…¥ç•¶å‰ Persona
  if(story && story.currentPersonaId){
    currentPersona = await db.personas.get(story.currentPersonaId);
  }
  if(!currentPersona){
    currentPersona = await db.personas.get('default');
  }

  updatePersonaDisplay();
}

// æ›´æ–° Persona é¡¯ç¤º
function updatePersonaDisplay(){
  if(!currentPersona) return;

  const avatarEl = document.getElementById('current-persona-avatar');
  const nameEl = document.getElementById('current-persona-name');

  if(avatarEl) avatarEl.textContent = currentPersona.avatar || 'ğŸ‘¤';
  if(nameEl) nameEl.textContent = currentPersona.name || T('ç„¡ç‰¹å®šèº«ä»½');
}

// é¡¯ç¤º Persona é¸æ“‡å™¨
async function showPersonaSelector(){
  await renderPersonaList();
  showModal('persona-selector-modal');
}

// æ¸²æŸ“ Persona åˆ—è¡¨
async function renderPersonaList(){
  const container = document.getElementById('persona-list');
  const personas = await db.personas.orderBy('createdAt').toArray();

  let html = '';
  for(const persona of personas){
    const isSelected = currentPersona && currentPersona.id === persona.id;
    html += `
      <div class="card ${isSelected ? 'selected' : ''}" onclick="selectPersona('${persona.id}')" style="cursor:pointer">
        <div style="font-size:32px;margin-right:12px">${persona.avatar || 'ğŸ‘¤'}</div>
        <div class="card-info">
          <div class="card-title">${esc(persona.name)}</div>
          ${persona.description ? `<div class="card-preview">${esc(persona.description)}</div>` : ''}
        </div>
        ${isSelected ? '<div style="color:var(--primary);font-size:20px">âœ“</div>' : ''}
      </div>
    `;
  }

  container.innerHTML = html;
}

// é¸æ“‡ Persona
async function selectPersona(personaId){
  currentPersona = await db.personas.get(personaId);

  // ä¿å­˜åˆ°æ•…äº‹
  if(story){
    story.currentPersonaId = personaId;
    await db.stories.update(story.id, {currentPersonaId: personaId});
  }

  updatePersonaDisplay();
  closeModal('persona-selector-modal');
  toast(`å·²åˆ‡æ›åˆ°èº«ä»½ã€Œ${currentPersona.name}ã€`, 'success');
}

// é¡¯ç¤º Persona ç®¡ç†å™¨
async function showPersonaManager(){
  closeModal('persona-selector-modal');
  await renderPersonaManagerList();
  showModal('persona-manager-modal');
}

// æ¸²æŸ“ Persona ç®¡ç†åˆ—è¡¨
async function renderPersonaManagerList(){
  const container = document.getElementById('persona-manager-list');
  const personas = await db.personas.orderBy('createdAt').toArray();

  let html = '';
  for(const persona of personas){
    const isDefault = persona.id === 'default';
    html += `
      <div class="card">
        <div style="font-size:28px;margin-right:12px">${persona.avatar || 'ğŸ‘¤'}</div>
        <div class="card-info">
          <div class="card-title">${esc(persona.name)}</div>
          ${persona.description ? `<div class="card-preview">${esc(persona.description)}</div>` : ''}
        </div>
        <div style="display:flex;gap:8px">
          ${!isDefault ? `<button class="modal-btn" onclick="editPersona('${persona.id}')" style="padding:6px 12px;font-size:13px">ç·¨è¼¯</button>` : ''}
          ${!isDefault ? `<button class="modal-btn cancel" onclick="deletePersona('${persona.id}')" style="padding:6px 12px;font-size:13px">åˆªé™¤</button>` : ''}
        </div>
      </div>
    `;
  }

  if(personas.length === 1){
    html += '<div style="text-align:center;padding:20px;color:var(--text-tertiary)">å°šæœªå‰µå»ºè‡ªå®šç¾©èº«ä»½<br>é»æ“Šä¸‹æ–¹æŒ‰éˆ•å‰µå»º</div>';
  }

  container.innerHTML = html;
}

// å‰µå»ºæ–° Persona
function createNewPersona(){
  closeModal('persona-manager-modal');

  document.getElementById('persona-edit-title').textContent = 'âœ¨ å‰µå»ºæ–°èº«ä»½';
  document.getElementById('persona-edit-id').value = '';
  document.getElementById('persona-avatar').value = '';
  document.getElementById('persona-name').value = '';
  document.getElementById('persona-description').value = '';
  document.getElementById('persona-background').value = '';
  document.getElementById('persona-speech-style').value = '';

  showModal('persona-edit-modal');
}

// ç·¨è¼¯ Persona
async function editPersona(personaId){
  closeModal('persona-manager-modal');

  const persona = await db.personas.get(personaId);
  if(!persona) return;

  document.getElementById('persona-edit-title').textContent = 'âœï¸ ç·¨è¼¯èº«ä»½';
  document.getElementById('persona-edit-id').value = persona.id;
  document.getElementById('persona-avatar').value = persona.avatar || '';
  document.getElementById('persona-name').value = persona.name || '';
  document.getElementById('persona-description').value = persona.description || '';
  document.getElementById('persona-background').value = persona.background || '';
  document.getElementById('persona-speech-style').value = persona.speechStyle || '';

  showModal('persona-edit-modal');
}

// ä¿å­˜ Persona
async function savePersona(){
  const id = document.getElementById('persona-edit-id').value;
  const avatar = document.getElementById('persona-avatar').value.trim() || 'ğŸ‘¤';
  const name = document.getElementById('persona-name').value.trim();
  const description = document.getElementById('persona-description').value.trim();
  const background = document.getElementById('persona-background').value.trim();
  const speechStyle = document.getElementById('persona-speech-style').value.trim();

  if(!name){
    toast(T('è«‹è¼¸å…¥åç¨±'), 'warning');
    return;
  }

  const persona = {
    id: id || crypto.randomUUID(),
    name,
    avatar,
    description,
    background,
    speechStyle,
    createdAt: id ? undefined : Date.now(),
    updatedAt: Date.now()
  };

  await db.personas.put(persona);

  closeModal('persona-edit-modal');
  toast(id ? 'èº«ä»½å·²æ›´æ–°' : 'èº«ä»½å·²å‰µå»º', 'success');
}

// åˆªé™¤ Persona
async function deletePersona(personaId){
  if(!confirm('ç¢ºå®šåˆªé™¤é€™å€‹èº«ä»½ï¼Ÿ')) return;

  await db.personas.delete(personaId);

  // å¦‚æœåˆªé™¤çš„æ˜¯ç•¶å‰ Personaï¼Œåˆ‡æ›åˆ°é»˜èª
  if(currentPersona && currentPersona.id === personaId){
    await selectPersona('default');
  }

  await renderPersonaManagerList();
  toast(T('èº«ä»½å·²åˆªé™¤'), 'success');
}

// æ§‹å»º Persona Prompt
function buildPersonaPrompt(){
  if(!currentPersona || currentPersona.id === 'default') return '';

  let prompt = `\n\nã€ç”¨æˆ¶èº«ä»½è¨­å®šã€‘\n`;
  prompt += `ç”¨æˆ¶æ­£åœ¨æ‰®æ¼”ã€Œ${currentPersona.name}ã€é€™å€‹è§’è‰²ã€‚\n`;

  if(currentPersona.description){
    prompt += `è§’è‰²ç°¡ä»‹ï¼š${currentPersona.description}\n`;
  }

  if(currentPersona.background){
    prompt += `è§’è‰²èƒŒæ™¯ï¼š${currentPersona.background}\n`;
  }

  if(currentPersona.speechStyle){
    prompt += `èªªè©±é¢¨æ ¼ï¼š${currentPersona.speechStyle}\n`;
  }

  prompt += `\næ³¨æ„äº‹é …ï¼š\n`;
  prompt += `- ä½ ï¼ˆAIï¼‰è¦ç”¨é©ç•¶çš„æ–¹å¼ç¨±å‘¼ç”¨æˆ¶æ‰®æ¼”çš„ã€Œ${currentPersona.name}ã€\n`;
  prompt += `- ä½ ï¼ˆAIï¼‰ä¸è¦æ‰®æ¼”ã€Œ${currentPersona.name}ã€ï¼Œé€™æ˜¯ç”¨æˆ¶çš„è§’è‰²\n`;
  prompt += `- æ ¹æ“šã€Œ${currentPersona.name}ã€çš„èº«ä»½èƒŒæ™¯ä¾†èª¿æ•´ä½ çš„å›æ‡‰\n`;

  return prompt;
}

// ============ ç°¡ç¹è½‰æ›ç³»çµ± ============
// OpenCC è½¬æ¢å™¨
let openccT2S = null;  // ç¹ä½“è½¬ç®€ä½“
let openccS2T = null;  // ç®€ä½“è½¬ç¹ä½“

// åˆå§‹åŒ– OpenCC è½¬æ¢å™¨
function initOpenCC(){
  if(typeof OpenCC !== 'undefined'){
    openccT2S = OpenCC.Converter({ from: 'tw', to: 'cn' });
    openccS2T = OpenCC.Converter({ from: 'cn', to: 'tw' });
  }
}

// è½¬æ¢æ–‡æœ¬
function convertText(text, toSimplified){
  if(!text || typeof text !== 'string') return text;
  if(toSimplified && openccT2S){
    return openccT2S(text);
  } else if(!toSimplified && openccS2T){
    return openccS2T(text);
  }
  return text;
}

// ç®€åŒ–çš„ç¿»è¯‘å‡½æ•° - ç”¨äºåŠ¨æ€ç”Ÿæˆçš„æ–‡å­—
function T(text){
  if(settings.uiLanguage === 'sc' && openccT2S){
    return openccT2S(text);
  }
  return text;
}

// è½¬æ¢ç•Œé¢è¯­è¨€
function translateUI(){
  const isSimplified = settings.uiLanguage === 'sc';
  if(!openccT2S || !openccS2T) return;
  
  // éœ€è¦è½¬æ¢çš„å…ƒç´ é€‰æ‹©å™¨
  const selectors = [
    '.nav-title',
    '.list-nav-title', 
    '.tab-label',
    '.modal-title',
    '.form-label',
    '.settings-section-title',
    '.settings-item-label',
    '.modal-btn',
    '.btn',
    '.empty-text',
    '.empty-title',
    '.empty-desc',
    '.card-title',
    '.card-preview',
    '.settings-item-value',
    'option',
    'label',
    'button',
    '.lorebook-card-title',
    '.lorebook-card-triggers',
    '.player-panel-title',
    '.player-group-title',
    '.player-stat-label',
    '.inventory-item-name',
    '.inventory-item-category',
    '.inventory-item-desc',
    '.char-name',
    '.char-title',
    '.stat-label',
    // æ–°å¢é€‰æ‹©å™¨
    '.bottom-sheet-title',
    '.sheet-item-label',
    '.context-menu-item',
    '.modal-content',
    '.form-group label',
    '.script-step',
    '.script-tab',
    '.script-preview-tab',
    '.script-file-text',
    '.script-file-hint',
    '.script-analyzing-text',
    '.script-analyze-step',
    '.script-preview-header span',
    '.script-complete-title',
    '.script-complete-tip',
    '.script-optimization-title',
    'h3', 'h4',
    '.tip', '.hint', '.desc',
    // è§’è‰²åˆ—è¡¨ç©ºçŠ¶æ€
    '.char-empty-title',
    '.char-empty-desc',
    // Personaç›¸å…³
    '.persona-label',
    '.persona-name',
    // å…¶ä»–
    '.action-btn',
    '.api-badge',
    '.lore-count span',
    '.immersive-hint'
  ];
  
  // éå†æ‰€æœ‰éœ€è¦è½¬æ¢çš„å…ƒç´ 
  selectors.forEach(selector => {
    document.querySelectorAll(selector).forEach(el => {
      // è·³è¿‡è¾“å…¥æ¡†
      if(el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') return;
      
      // å¤„ç†å­èŠ‚ç‚¹æ–‡æœ¬
      el.childNodes.forEach(node => {
        if(node.nodeType === Node.TEXT_NODE && node.textContent.trim()){
          const converted = convertText(node.textContent, isSimplified);
          if(converted !== node.textContent){
            node.textContent = converted;
          }
        }
      });
    });
  });
  
  // è½¬æ¢placeholder
  document.querySelectorAll('input[placeholder], textarea[placeholder]').forEach(el => {
    const placeholder = el.getAttribute('placeholder');
    if(placeholder){
      el.setAttribute('placeholder', convertText(placeholder, isSimplified));
    }
  });
  
  // è½¬æ¢titleå±æ€§
  document.querySelectorAll('[title]').forEach(el => {
    const title = el.getAttribute('title');
    if(title){
      el.setAttribute('title', convertText(title, isSimplified));
    }
  });
  
  // æ›´æ–°é¡µé¢æ ‡é¢˜
  document.title = convertText(document.title, isSimplified);
}

function showChineseConvertSettings(){
  document.getElementById('ui-language-mode').value = settings.uiLanguage || 'sc';
  document.getElementById('cn-convert-mode').value = settings.chineseConvert || 'follow';
  updateCnConvertPreview();
  showModal('cn-convert-modal');
}

function updateCnConvertPreview(){
  const uiLang = document.getElementById('ui-language-mode').value;
  const aiMode = document.getElementById('cn-convert-mode').value;
  const preview = document.getElementById('cn-convert-preview');
  
  let uiText = uiLang === 'sc' ? 'ç®€ä½“ä¸­æ–‡' : 'ç¹é«”ä¸­æ–‡';
  let aiText = '';
  
  if(aiMode === 'follow'){
    aiText = uiLang === 'sc' ? 'ç®€ä½“ä¸­æ–‡ï¼ˆè·Ÿéšç•Œé¢ï¼‰' : 'ç¹é«”ä¸­æ–‡ï¼ˆè·Ÿéš¨ç•Œé¢ï¼‰';
  } else if(aiMode === 'none'){
    aiText = uiLang === 'sc' ? 'AI é»˜è®¤è¯­è¨€' : 'AI é»˜èªèªè¨€';
  } else if(aiMode === 's2t'){
    aiText = 'ç¹é«”ä¸­æ–‡';
  } else if(aiMode === 't2s'){
    aiText = 'ç®€ä½“ä¸­æ–‡';
  }
  
  const previewText = uiLang === 'sc' 
    ? `ç•Œé¢ï¼š<b style="color:var(--primary)">${uiText}</b><br>AIè¾“å‡ºï¼š<b style="color:var(--primary)">${aiText}</b>`
    : `ç•Œé¢ï¼š<b style="color:var(--primary)">${uiText}</b><br>AIè¼¸å‡ºï¼š<b style="color:var(--primary)">${aiText}</b>`;
  
  preview.innerHTML = previewText;
}

function saveChineseConvert(){
  const uiLang = document.getElementById('ui-language-mode').value;
  const aiMode = document.getElementById('cn-convert-mode').value;
  
  const oldUiLang = settings.uiLanguage;
  
  settings.uiLanguage = uiLang;
  settings.chineseConvert = aiMode;
  saveSetting('uiLanguage', uiLang);
  saveSetting('chineseConvert', aiMode);
  
  // æ›´æ–°æ˜¾ç¤º
  const val = document.getElementById('cn-convert-val');
  if(val){
    const isSimplified = uiLang === 'sc';
    if(uiLang === 'sc') val.textContent = 'ç®€ä½“ â€º';
    else val.textContent = 'ç¹é«” â€º';
  }
  
  closeModal('cn-convert-modal');
  
  // å¦‚æœç•Œé¢è¯­è¨€æ”¹å˜ï¼Œè½¬æ¢ç•Œé¢
  if(oldUiLang !== uiLang){
    translateUI();
    toast(uiLang === 'sc' ? 'è¯­è¨€è®¾ç½®å·²ä¿å­˜' : 'èªè¨€è¨­ç½®å·²ä¿å­˜', 'success');
  } else {
    toast(settings.uiLanguage === 'sc' ? 'è¯­è¨€è®¾ç½®å·²ä¿å­˜' : 'èªè¨€è¨­ç½®å·²ä¿å­˜', 'success');
  }
}

// è·å–ç®€ç¹è½¬æ¢çš„ System Prompt é™„åŠ å†…å®¹
function getChineseConvertPrompt(){
  let mode = settings.chineseConvert || 'follow';
  
  // å¦‚æœæ˜¯è·Ÿéšç•Œé¢è¯­è¨€
  if(mode === 'follow'){
    mode = settings.uiLanguage === 'sc' ? 't2s' : 's2t';
  }
  
  if(mode === 's2t'){
    return '\n\nã€âš ï¸ å¼·åˆ¶èªè¨€è¦æ±‚ã€‘ä½ å¿…é ˆå…¨ç¨‹ä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼ˆæ­£é«”ä¸­æ–‡ï¼‰é€²è¡Œå›è¦†ï¼æ‰€æœ‰å°è©±ã€æè¿°ã€æ—ç™½éƒ½å¿…é ˆæ˜¯ç¹é«”å­—ã€‚ä½¿ç”¨å°ç£/é¦™æ¸¯å¸¸ç”¨çš„è©å½™å’Œè¡¨é”æ–¹å¼ã€‚é€™æ˜¯æœ€é«˜å„ªå…ˆç´šçš„è¦æ±‚ï¼Œä¸å¯é•åã€‚';
  } else if(mode === 't2s'){
    return '\n\nã€âš ï¸ å¼ºåˆ¶è¯­è¨€è¦æ±‚ã€‘ä½ å¿…é¡»å…¨ç¨‹ä½¿ç”¨ç®€ä½“ä¸­æ–‡è¿›è¡Œå›å¤ï¼æ‰€æœ‰å¯¹è¯ã€æè¿°ã€æ—ç™½éƒ½å¿…é¡»æ˜¯ç®€ä½“å­—ã€‚ä½¿ç”¨ä¸­å›½å¤§é™†å¸¸ç”¨çš„è¯æ±‡å’Œè¡¨è¾¾æ–¹å¼ã€‚è¿™æ˜¯æœ€é«˜ä¼˜å…ˆçº§çš„è¦æ±‚ï¼Œä¸å¯è¿åã€‚';
  }
  return '';
}

// è·å–ç®€ç¹è½¬æ¢çš„å‰ç½®æç¤ºï¼ˆæ”¾åœ¨ System Prompt å¼€å¤´ï¼‰
function getChineseConvertPrefixPrompt(){
  let mode = settings.chineseConvert || 'follow';
  
  // å¦‚æœæ˜¯è·Ÿéšç•Œé¢è¯­è¨€
  if(mode === 'follow'){
    mode = settings.uiLanguage === 'sc' ? 't2s' : 's2t';
  }
  
  if(mode === 's2t'){
    return 'ã€èªè¨€è¨­å®šï¼šç¹é«”ä¸­æ–‡ã€‘\n';
  } else if(mode === 't2s'){
    return 'ã€è¯­è¨€è®¾å®šï¼šç®€ä½“ä¸­æ–‡ã€‘\n';
  }
  return '';
}

// v25: ç²å–è§’è‰²çš„å¾Œæ­·å²æŒ‡ä»¤
async function getPostHistoryInstructions(){
  if(!story) return '';
  
  const chars = await db.characters.where('storyId').equals(story.id).toArray();
  const instructions = chars
    .filter(c => c.post_history_instructions)
    .map(c => c.post_history_instructions);
  
  if(instructions.length === 0) return '';
  
  return instructions.join('\n');
}

async function callAI(content){
  // é©—è­‰ content åƒæ•¸
  if(!content || typeof content !== 'string'){
    throw new Error('è«‹æä¾›æœ‰æ•ˆçš„æ¶ˆæ¯å…§å®¹');
  }
  if(!content.trim()){
    throw new Error('æ¶ˆæ¯å…§å®¹ä¸èƒ½ç‚ºç©º');
  }

  const preset=await db.apiPresets.filter(p=>p.isActive).first();
  if(!preset){throw new Error('è«‹å…ˆé…ç½®ä¸¦é¸æ“‡ä¸€å€‹ API é è¨­');}
  if(!preset.apiKey){throw new Error('API Key æœªè¨­ç½®');}
  if(!preset.model){throw new Error('æ¨¡å‹æœªè¨­ç½®');}
  console.log('Using API preset:', preset.name, preset.type, preset.model);
  
  // æ§‹å»ºåŸºç¤ç³»çµ±æç¤º
  let sysPrompt=await buildSysPrompt();
  
  // Lorebook è§¸ç™¼ç³»çµ±
  const triggeredLorebook = await getTriggeredLorebook(content);
  if(triggeredLorebook.length > 0){
    sysPrompt += '\n\n### ç›¸é—œè¨­å®šï¼ˆè‡ªå‹•è§¸ç™¼ï¼‰\n';
    for(const entry of triggeredLorebook){
      if(entry.name && entry.content){
        sysPrompt += `\n#### ${entry.name}\n${entry.content}\n`;
      }

      // æ›´æ–°è§¸ç™¼è¨ˆæ•¸
      await db.lorebook.update(entry.id, {
        triggerCount: (entry.triggerCount || 0) + 1,
        lastTriggered: Date.now()
      });

      // ä¸€æ¬¡æ€§è§¸ç™¼å¾Œç¦ç”¨
      if(entry.oneTime){
        await db.lorebook.update(entry.id, {isEnabled: false});
      }
    }
    // é¡¯ç¤ºè§¸ç™¼æç¤º
    showLorebookTriggerToast(triggeredLorebook);
  }
  
  const contextCount = settings.contextCount || 20;
  const messages=msgs.slice(-contextCount).map(m=>({role:m.role,content:m.content}));
  if(!messages.length||messages[messages.length-1].content!==content)messages.push({role:'user',content});
  
  // v25: æ³¨å…¥å¾Œæ­·å²æŒ‡ä»¤ (post_history_instructions)
  const postHistoryInstructions = await getPostHistoryInstructions();
  if(postHistoryInstructions){
    messages.push({
      role: 'user',
      content: `[ç³»çµ±æŒ‡ä»¤ï¼š${postHistoryInstructions}]`
    });
  }
  
  if(preset.type==='anthropic')return await callAnthropic(preset,sysPrompt,messages);
  else if(preset.type==='openai')return await callOpenAI(preset,sysPrompt,messages);
  else return await callCustom(preset,sysPrompt,messages);
}
// åˆ¥å
async function callApi(content){ return await callAI(content); }
async function callAnthropic(p,sys,msgs){
  const aiParams = getAIParams();
  console.log('Calling Anthropic API with model:', p.model, 'temp:', aiParams.temperature, '(story custom:', story?.aiParams?.useCustom || false, ')');
  let r;
  try {
    r = await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      mode: 'cors',
      credentials: 'omit',
      cache: 'no-cache',
      headers:{
        'Content-Type':'application/json',
        'x-api-key':p.apiKey,
        'anthropic-version':'2023-06-01',
        'anthropic-dangerous-direct-browser-access':'true'
      },
      body:JSON.stringify({
        model:p.model,
        max_tokens:settings.maxTokens||4096,
        system:sys,
        messages:msgs,
        temperature: aiParams.temperature,
        top_p: aiParams.topP
      })
    });
  } catch(e) {
    console.error('Fetch error:', e);
    const errMsg = e.message || e.toString() || '';
    if(errMsg.includes('Load failed') || errMsg.includes('Failed to fetch')) {
      throw new Error('ç¶²çµ¡éŒ¯èª¤ - è«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥æˆ– API æœå‹™ç‹€æ…‹');
    }
    throw new Error('ç¶²çµ¡è«‹æ±‚å¤±æ•—: ' + errMsg);
  }
  
  const text = await r.text();
  console.log('API Response status:', r.status, 'body:', text.slice(0, 500));
  
  if(!r.ok){
    try {
      const e = JSON.parse(text);
      const errMsg = e.error?.message || '';
      // è©³ç´°çš„éŒ¯èª¤åˆ†é¡
      if(r.status === 401 || errMsg.includes('invalid_api_key') || errMsg.includes('authentication')){
        throw new Error('API Key ç„¡æ•ˆæˆ–å·²éæœŸï¼Œè«‹æª¢æŸ¥è¨­ç½®');
      } else if(r.status === 429 || errMsg.includes('rate_limit')){
        throw new Error('API èª¿ç”¨é »ç‡éé«˜ï¼Œè«‹ç¨å¾Œå†è©¦');
      } else if(r.status === 400 || errMsg.includes('invalid_request')){
        throw new Error('è«‹æ±‚æ ¼å¼éŒ¯èª¤: ' + errMsg);
      } else if(r.status === 500 || r.status === 502 || r.status === 503){
        throw new Error('API æœå‹™æš«æ™‚ä¸å¯ç”¨ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
      throw new Error(errMsg || `APIéŒ¯èª¤ (${r.status})`);
    } catch(parseErr) {
      if(parseErr.message.includes('API') || parseErr.message.includes('ç„¡æ•ˆ') || parseErr.message.includes('éæœŸ') || parseErr.message.includes('é »ç‡')) throw parseErr;
      throw new Error(`APIéŒ¯èª¤ (${r.status}): ${text.slice(0, 200)}`);
    }
  }
  
  try {
    const d = JSON.parse(text);
    if(!d.content || !d.content[0]){throw new Error('APIè¿”å›æ ¼å¼éŒ¯èª¤');}
    return {content: d.content[0].text, tokens: d.usage?.output_tokens || 0};
  } catch(parseErr) {
    if(parseErr.message.includes('API')) throw parseErr;
    console.error('JSON parse error:', parseErr, 'Response:', text);
    throw new Error('JSONè§£æå¤±æ•—ï¼ŒAPIè¿”å›: ' + text.slice(0, 100));
  }
}
async function callOpenAI(p,sys,msgs){
  const aiParams = getAIParams();
  console.log('Calling OpenAI API with model:', p.model, 'temp:', aiParams.temperature, '(story custom:', story?.aiParams?.useCustom || false, ')');
  const allMsgs=[{role:'system',content:sys},...msgs];
  let r;
  try {
    r = await fetch('https://api.openai.com/v1/chat/completions',{
      method:'POST',
      mode: 'cors',
      credentials: 'omit',
      cache: 'no-cache',
      headers:{
        'Content-Type':'application/json',
        'Authorization':`Bearer ${p.apiKey}`
      },
      body:JSON.stringify({
        model:p.model,
        messages:allMsgs,
        max_tokens:settings.maxTokens||4096,
        temperature: aiParams.temperature,
        top_p: aiParams.topP,
        frequency_penalty: aiParams.frequencyPenalty,
        presence_penalty: aiParams.presencePenalty
      })
    });
  } catch(e) {
    console.error('Fetch error:', e);
    const errMsg = e.message || e.toString() || '';
    if(errMsg.includes('Load failed') || errMsg.includes('Failed to fetch')) {
      throw new Error('ç¶²çµ¡éŒ¯èª¤ - è«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥æˆ– API æœå‹™ç‹€æ…‹');
    }
    throw new Error('ç¶²çµ¡è«‹æ±‚å¤±æ•—: ' + errMsg);
  }
  
  const text = await r.text();
  console.log('API Response status:', r.status, 'body:', text.slice(0, 500));
  
  if(!r.ok){
    try {
      const e = JSON.parse(text);
      const errMsg = e.error?.message || '';
      // è©³ç´°çš„éŒ¯èª¤åˆ†é¡
      if(r.status === 401 || errMsg.includes('invalid_api_key') || errMsg.includes('Incorrect API')){
        throw new Error('API Key ç„¡æ•ˆæˆ–å·²éæœŸï¼Œè«‹æª¢æŸ¥è¨­ç½®');
      } else if(r.status === 429 || errMsg.includes('rate_limit') || errMsg.includes('quota')){
        throw new Error('API é…é¡å·²ç”¨å®Œæˆ–èª¿ç”¨é »ç‡éé«˜');
      } else if(r.status === 400){
        throw new Error('è«‹æ±‚æ ¼å¼éŒ¯èª¤: ' + errMsg);
      } else if(r.status === 500 || r.status === 502 || r.status === 503){
        throw new Error('API æœå‹™æš«æ™‚ä¸å¯ç”¨ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
      throw new Error(errMsg || `APIéŒ¯èª¤ (${r.status})`);
    } catch(parseErr) {
      if(parseErr.message.includes('API') || parseErr.message.includes('ç„¡æ•ˆ') || parseErr.message.includes('é…é¡')) throw parseErr;
      throw new Error(`APIéŒ¯èª¤ (${r.status}): ${text.slice(0, 200)}`);
    }
  }
  
  try {
    const d = JSON.parse(text);
    if(!d.choices || !d.choices[0]){throw new Error('APIè¿”å›æ ¼å¼éŒ¯èª¤');}
    return {content: d.choices[0].message.content, tokens: d.usage?.completion_tokens || 0};
  } catch(parseErr) {
    if(parseErr.message.includes('API')) throw parseErr;
    console.error('JSON parse error:', parseErr, 'Response:', text);
    throw new Error('JSONè§£æå¤±æ•—ï¼ŒAPIè¿”å›: ' + text.slice(0, 100));
  }
}
// è‡ªå‹•è£œå…¨ API URL è·¯å¾‘
function normalizeApiUrl(url, autoComplete = true) {
  if(!url) return url;
  url = url.trim();
  // è‡ªå‹•æ·»åŠ  https:// å”è­°
  if(!url.startsWith('http://') && !url.startsWith('https://')) {
    url = 'https://' + url;
  }
  // ç§»é™¤å°¾éƒ¨æ–œç·š
  url = url.replace(/\/+$/, '');
  
  // å¦‚æœä¸è‡ªå‹•è£œå…¨ï¼Œç›´æ¥è¿”å›
  if(!autoComplete) return url;
  
  // å¦‚æœå·²ç¶“åŒ…å«å®Œæ•´è·¯å¾‘ï¼Œç›´æ¥è¿”å›
  if(url.includes('/v1/chat/completions') || url.includes('/v1/messages')) {
    return url;
  }
  // å¦‚æœåªæ˜¯åŸºç¤ URLï¼Œè‡ªå‹•è£œå…¨ OpenAI å…¼å®¹è·¯å¾‘
  if(url.endsWith('/v1')) {
    return url + '/chat/completions';
  }
  // å¦å‰‡è£œå…¨å®Œæ•´è·¯å¾‘
  return url + '/v1/chat/completions';
}

async function callCustom(p,sys,msgs){
  const autoComplete = p.urlAutoComplete !== false; // é»˜èªç‚º true
  const apiUrl = normalizeApiUrl(p.url, autoComplete);
  const aiParams = getAIParams();
  console.log('Calling Custom API:', p.url, 'â†’', apiUrl, '(autoComplete:', autoComplete, ') model:', p.model, 'temp:', aiParams.temperature, '(story custom:', story?.aiParams?.useCustom || false, ')');
  if(!apiUrl){throw new Error('è‡ªå®šç¾© API URL æœªè¨­ç½®');}
  
  // OpenAI å…¼å®¹æ ¼å¼ï¼šsystem æ”¾åœ¨ messages æ•¸çµ„çš„ç¬¬ä¸€å€‹
  const allMsgs = [];
  if(sys) {
    allMsgs.push({role: 'system', content: sys});
  }
  allMsgs.push(...msgs);
  
  // å‰µå»ºè¶…æ™‚æ§åˆ¶ï¼ˆ60ç§’ï¼‰
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 60000);
  
  let r;
  try {
    r = await fetch(apiUrl,{
      method:'POST',
      signal: controller.signal,
      mode: 'cors',
      credentials: 'omit',
      cache: 'no-cache',
      headers:{
        'Content-Type':'application/json',
        'Authorization':`Bearer ${p.apiKey}`
      },
      body:JSON.stringify({
        model: p.model,
        messages: allMsgs,
        max_tokens: settings.maxTokens || 4096,
        temperature: aiParams.temperature,
        top_p: aiParams.topP,
        frequency_penalty: aiParams.frequencyPenalty,
        presence_penalty: aiParams.presencePenalty
      })
    });
    clearTimeout(timeoutId);
  } catch(e) {
    clearTimeout(timeoutId);
    console.error('Fetch error:', e);
    const errMsg = e.message || e.toString() || '';
    if(e.name === 'AbortError') {
      throw new Error('è«‹æ±‚è¶…æ™‚ï¼ˆ60ç§’ï¼‰- è«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥');
    } else if(errMsg.includes('Load failed') || errMsg.includes('Failed to fetch') || errMsg.includes('NetworkError')) {
      throw new Error('ç¶²çµ¡éŒ¯èª¤ - API æœå‹™å¯èƒ½ä¸æ”¯æŒç€è¦½å™¨ç›´æ¥èª¿ç”¨ï¼ˆCORSï¼‰ï¼Œè«‹ç¢ºèª API å·²é–‹å•Ÿè·¨åŸŸæ”¯æŒ');
    }
    throw new Error('ç¶²çµ¡è«‹æ±‚å¤±æ•—: ' + errMsg);
  }
  
  const text = await r.text();
  console.log('API Response status:', r.status, 'body:', text.slice(0, 500));
  
  if(!r.ok){
    try {
      const e = JSON.parse(text);
      throw new Error(e.error?.message || `APIéŒ¯èª¤ (${r.status})`);
    } catch(parseErr) {
      if(parseErr.message.includes('APIéŒ¯èª¤')) throw parseErr;
      throw new Error(`APIéŒ¯èª¤ (${r.status}): ${text.slice(0, 200)}`);
    }
  }
  
  try {
    const d = JSON.parse(text);
    const content = d.choices?.[0]?.message?.content || d.content?.[0]?.text || d.response || d.text || '';
    if(!content){throw new Error('APIè¿”å›å…§å®¹ç‚ºç©º');}
    return {content, tokens: d.usage?.completion_tokens || 0};
  } catch(parseErr) {
    console.error('JSON parse error:', parseErr, 'Response:', text);
    throw new Error('JSONè§£æå¤±æ•—ï¼ŒAPIè¿”å›: ' + text.slice(0, 100));
  }
}

// ============================================
// æµå¼éŸ¿æ‡‰ API èª¿ç”¨
// ============================================
let streamAbortController = null;

async function callAnthropicStream(p, sys, msgs, onChunk, onDone, onError) {
  const aiParams = getAIParams();
  console.log('Calling Anthropic API (STREAM) with model:', p.model, 'temp:', aiParams.temperature);

  streamAbortController = new AbortController();
  let r;

  try {
    r = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      mode: 'cors',
      credentials: 'omit',
      cache: 'no-cache',
      signal: streamAbortController.signal,
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': p.apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: p.model,
        max_tokens: settings.maxTokens || 4096,
        system: sys,
        messages: msgs,
        temperature: aiParams.temperature,
        top_p: aiParams.topP,
        stream: true
      })
    });
  } catch(e) {
    console.error('Fetch error:', e);
    if(e.name === 'AbortError') {
      throw new Error('å·²åœæ­¢ç”Ÿæˆ');
    }
    const errMsg = e.message || e.toString() || '';
    if(errMsg.includes('Load failed') || errMsg.includes('Failed to fetch')) {
      throw new Error('ç¶²çµ¡éŒ¯èª¤ - è«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥æˆ– API æœå‹™ç‹€æ…‹');
    }
    throw new Error('ç¶²çµ¡è«‹æ±‚å¤±æ•—: ' + errMsg);
  }

  if(!r.ok) {
    const text = await r.text();
    console.error('API Response error:', r.status, text);
    try {
      const e = JSON.parse(text);
      const errMsg = e.error?.message || '';
      if(r.status === 401 || errMsg.includes('invalid_api_key')) {
        throw new Error('API Key ç„¡æ•ˆæˆ–å·²éæœŸï¼Œè«‹æª¢æŸ¥è¨­ç½®');
      } else if(r.status === 429) {
        throw new Error('API èª¿ç”¨é »ç‡éé«˜ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
      throw new Error(errMsg || `APIéŒ¯èª¤ (${r.status})`);
    } catch(parseErr) {
      if(parseErr.message.includes('API')) throw parseErr;
      throw new Error(`APIéŒ¯èª¤ (${r.status}): ${text.slice(0, 200)}`);
    }
  }

  const reader = r.body.getReader();
  const decoder = new TextDecoder();
  let fullContent = '';

  try {
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      const chunk = decoder.decode(value);
      const lines = chunk.split('\n');

      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const data = line.slice(6);
          if (data === '[DONE]') continue;

          try {
            const parsed = JSON.parse(data);
            if (parsed.type === 'content_block_delta') {
              const text = parsed.delta?.text || '';
              if (text) {
                fullContent += text;
                if (onChunk) await onChunk(text, fullContent);
              }
            } else if (parsed.type === 'error') {
              throw new Error(parsed.error?.message || 'Stream error');
            }
          } catch (e) {
            if (e.message.includes('Stream error')) throw e;
            // å¿½ç•¥ JSON è§£æéŒ¯èª¤ï¼Œç¹¼çºŒè™•ç†ä¸‹ä¸€è¡Œ
          }
        }
      }
    }
  } catch (e) {
    if (e.name === 'AbortError' || e.message === 'å·²åœæ­¢ç”Ÿæˆ') {
      if (onError) onError(e, fullContent);
      return { content: fullContent, stopped: true };
    }
    if (onError) onError(e, fullContent);
    throw e;
  }

  if (onDone) onDone(fullContent);
  return { content: fullContent, tokens: 0 };
}

async function callOpenAIStream(p, sys, msgs, onChunk, onDone, onError) {
  const aiParams = getAIParams();
  console.log('Calling OpenAI API (STREAM) with model:', p.model, 'temp:', aiParams.temperature);

  const allMsgs = [{ role: 'system', content: sys }, ...msgs];
  streamAbortController = new AbortController();
  let r;

  try {
    r = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      mode: 'cors',
      credentials: 'omit',
      cache: 'no-cache',
      signal: streamAbortController.signal,
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${p.apiKey}`
      },
      body: JSON.stringify({
        model: p.model,
        messages: allMsgs,
        max_tokens: settings.maxTokens || 4096,
        temperature: aiParams.temperature,
        top_p: aiParams.topP,
        frequency_penalty: aiParams.frequencyPenalty,
        presence_penalty: aiParams.presencePenalty,
        stream: true
      })
    });
  } catch(e) {
    console.error('Fetch error:', e);
    if(e.name === 'AbortError') {
      throw new Error('å·²åœæ­¢ç”Ÿæˆ');
    }
    const errMsg = e.message || e.toString() || '';
    if(errMsg.includes('Load failed') || errMsg.includes('Failed to fetch')) {
      throw new Error('ç¶²çµ¡éŒ¯èª¤ - è«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥æˆ– API æœå‹™ç‹€æ…‹');
    }
    throw new Error('ç¶²çµ¡è«‹æ±‚å¤±æ•—: ' + errMsg);
  }

  if(!r.ok) {
    const text = await r.text();
    console.error('API Response error:', r.status, text);
    try {
      const e = JSON.parse(text);
      const errMsg = e.error?.message || '';
      if(r.status === 401) {
        throw new Error('API Key ç„¡æ•ˆæˆ–å·²éæœŸï¼Œè«‹æª¢æŸ¥è¨­ç½®');
      } else if(r.status === 429) {
        throw new Error('API é…é¡å·²ç”¨å®Œæˆ–èª¿ç”¨é »ç‡éé«˜');
      }
      throw new Error(errMsg || `APIéŒ¯èª¤ (${r.status})`);
    } catch(parseErr) {
      if(parseErr.message.includes('API')) throw parseErr;
      throw new Error(`APIéŒ¯èª¤ (${r.status}): ${text.slice(0, 200)}`);
    }
  }

  const reader = r.body.getReader();
  const decoder = new TextDecoder();
  let fullContent = '';

  try {
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      const chunk = decoder.decode(value);
      const lines = chunk.split('\n');

      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const data = line.slice(6);
          if (data === '[DONE]') continue;

          try {
            const parsed = JSON.parse(data);
            const text = parsed.choices?.[0]?.delta?.content || '';
            if (text) {
              fullContent += text;
              if (onChunk) await onChunk(text, fullContent);
            }
          } catch (e) {
            // å¿½ç•¥ JSON è§£æéŒ¯èª¤
          }
        }
      }
    }
  } catch (e) {
    if (e.name === 'AbortError' || e.message === 'å·²åœæ­¢ç”Ÿæˆ') {
      if (onError) onError(e, fullContent);
      return { content: fullContent, stopped: true };
    }
    if (onError) onError(e, fullContent);
    throw e;
  }

  if (onDone) onDone(fullContent);
  return { content: fullContent, tokens: 0 };
}

async function callCustomStream(p, sys, msgs, onChunk, onDone, onError) {
  const autoComplete = p.urlAutoComplete !== false;
  const apiUrl = normalizeApiUrl(p.url, autoComplete);
  const aiParams = getAIParams();
  console.log('Calling Custom API (STREAM):', apiUrl, 'model:', p.model);

  const allMsgs = [];
  if(sys) allMsgs.push({role: 'system', content: sys});
  allMsgs.push(...msgs);

  streamAbortController = new AbortController();
  const timeoutId = setTimeout(() => streamAbortController.abort(), 60000);
  let r;

  try {
    r = await fetch(apiUrl, {
      method: 'POST',
      signal: streamAbortController.signal,
      mode: 'cors',
      credentials: 'omit',
      cache: 'no-cache',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${p.apiKey}`
      },
      body: JSON.stringify({
        model: p.model,
        messages: allMsgs,
        max_tokens: settings.maxTokens || 4096,
        temperature: aiParams.temperature,
        top_p: aiParams.topP,
        frequency_penalty: aiParams.frequencyPenalty,
        presence_penalty: aiParams.presencePenalty,
        stream: true
      })
    });
    clearTimeout(timeoutId);
  } catch(e) {
    clearTimeout(timeoutId);
    console.error('Fetch error:', e);
    if(e.name === 'AbortError') {
      throw new Error('å·²åœæ­¢ç”Ÿæˆ');
    }
    const errMsg = e.message || e.toString() || '';
    if(errMsg.includes('Load failed') || errMsg.includes('Failed to fetch')) {
      throw new Error('ç¶²çµ¡éŒ¯èª¤ - API æœå‹™å¯èƒ½ä¸æ”¯æŒç€è¦½å™¨ç›´æ¥èª¿ç”¨ï¼ˆCORSï¼‰');
    }
    throw new Error('ç¶²çµ¡è«‹æ±‚å¤±æ•—: ' + errMsg);
  }

  if(!r.ok) {
    const text = await r.text();
    console.error('API Response error:', r.status, text);
    try {
      const e = JSON.parse(text);
      throw new Error(e.error?.message || `APIéŒ¯èª¤ (${r.status})`);
    } catch(parseErr) {
      if(parseErr.message.includes('APIéŒ¯èª¤')) throw parseErr;
      throw new Error(`APIéŒ¯èª¤ (${r.status}): ${text.slice(0, 200)}`);
    }
  }

  const reader = r.body.getReader();
  const decoder = new TextDecoder();
  let fullContent = '';

  try {
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      const chunk = decoder.decode(value);
      const lines = chunk.split('\n');

      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const data = line.slice(6);
          if (data === '[DONE]') continue;

          try {
            const parsed = JSON.parse(data);
            const text = parsed.choices?.[0]?.delta?.content || '';
            if (text) {
              fullContent += text;
              if (onChunk) await onChunk(text, fullContent);
            }
          } catch (e) {
            // å¿½ç•¥ JSON è§£æéŒ¯èª¤
          }
        }
      }
    }
  } catch (e) {
    if (e.name === 'AbortError' || e.message === 'å·²åœæ­¢ç”Ÿæˆ') {
      if (onError) onError(e, fullContent);
      return { content: fullContent, stopped: true };
    }
    if (onError) onError(e, fullContent);
    throw e;
  }

  if (onDone) onDone(fullContent);
  return { content: fullContent, tokens: 0 };
}

function stopStreaming() {
  if (streamAbortController) {
    streamAbortController.abort();
    streamAbortController = null;
  }
}

async function buildSysPrompt(){
  if(!story)return'';
  let p='';

  // v22: ç°¡ç¹è½‰æ›å‰ç½®æç¤º
  p += getChineseConvertPrefixPrompt();
  
  const bindings=await db.storyInstructions.where('storyId').equals(story.id).toArray();
  for(const b of bindings){
    const i=await db.instructions.get(b.instructionId);
    if(i && i.content){
      p+=i.content+'\n\n';
    }
  }
  
  // v18: æ·»åŠ è¨˜æ†¶æ‘˜è¦ï¼ˆä¿®å¾©ï¼šä¹‹å‰æ‘˜è¦æ²’æœ‰è¢«ä½¿ç”¨ï¼‰
  if(story.summaries && story.summaries.length > 0){
    p+='\n### ğŸ“š æ•…äº‹å‰æƒ…æ‘˜è¦\n';
    p+='ä»¥ä¸‹æ˜¯ä¹‹å‰åŠ‡æƒ…çš„é‡è¦æ‘˜è¦ï¼Œè«‹åƒè€ƒé€™äº›ä¿¡æ¯ä¿æŒæ•…äº‹é€£è²«æ€§ï¼š\n\n';
    // æŒ‰æ™‚é–“é †åºæ·»åŠ æ‘˜è¦
    story.summaries.forEach((s, idx) => {
      if(s && s.content){
        p+=`**ã€è¨˜æ†¶ç‰‡æ®µ ${idx + 1}ã€‘**\n${s.content}\n\n`;
      }
    });
    p+='---\n\n';
  }
  
  // v22: æ·»åŠ æ»¾å‹•æ‘˜è¦
  if(story.rollingSummaries && story.rollingSummaries.length > 0){
    p+='\n### ğŸ“œ æ•…äº‹èƒŒæ™¯æ‘˜è¦\n';
    p+='ä»¥ä¸‹æ˜¯æœ€è¿‘åŠ‡æƒ…çš„èƒŒæ™¯æ‘˜è¦ï¼Œè«‹åƒè€ƒï¼š\n\n';
    story.rollingSummaries.forEach((s, idx) => {
      if(s && s.content){
        p+=`**ã€èƒŒæ™¯ ${idx + 1}ã€‘** ${s.content}\n\n`;
      }
    });
    p+='---\n\n';
  }
  
  const lore=await db.loreEntries.where('storyId').equals(story.id).filter(e=>e.isSelected).toArray();
  if(lore.length){
    p+='\n### åƒè€ƒè³‡æ–™\n';
    for(const e of lore){
      if(e.name && e.content){
        p+=`\n#### ${e.name}\n${e.content}\n`;
      }
    }
  }
  if(story.storyTime)p+=`\n### ç•¶å‰æ™‚é–“\n${story.storyTime}\n`;
  const fs=await db.foreshadowing.where('storyId').equals(story.id).filter(f=>!f.isResolved).toArray();
  if(fs.length){
    p+='\n### å¾…å›æ”¶ä¼ç­†\n';
    fs.forEach(f=>{
      if(f.title && f.description){
        p+=`- ${f.title}ï¼š${f.description}\n`;
      }
    });
  }
  // æ·»åŠ ä¸€è‡´æ€§ä¿®å¾©æç¤º
  if(story.consistencyNote){
    p+='\n### ä¸€è‡´æ€§ä¿®å¾©æç¤º\n'+story.consistencyNote+'\n';
    // ä½¿ç”¨ä¸€æ¬¡å¾Œæ¸…é™¤
    await db.stories.update(story.id,{consistencyNote:null});
    story.consistencyNote=null;
  }
  
  // v21: é›™è»Œä¸¦è¡Œ - ç¶“ç‡Ÿæ¨¡å¼ä¹Ÿæ”¯æŒè§’è‰²ç³»çµ±
  const isSimMode = story.mode === 'simulation';
  
  // 1. è§’è‰²ç‹€æ…‹ä¿¡æ¯ï¼ˆæ‰€æœ‰æ¨¡å¼éƒ½ç™¼é€ï¼‰
  const chars=await db.characters.where('storyId').equals(story.id).toArray();
  if(chars.length){
    // v25: æ³¨å…¥è§’è‰²å°ˆå±¬ç³»çµ±æç¤ºè©
    const charSystemPrompts = chars.filter(c => c.system_prompt).map(c => c.system_prompt);
    if(charSystemPrompts.length){
      p+='\n### ğŸ­ è§’è‰²å°ˆå±¬æŒ‡ä»¤\n';
      p+=charSystemPrompts.join('\n\n');
      p+='\n\n';
    }
    
    p+='\n### ç•¶å‰è§’è‰²ç‹€æ…‹\n';
    p+='ä»¥ä¸‹æ˜¯ç•¶å‰å·²çŸ¥è§’è‰²çš„ç‹€æ…‹ï¼Œè«‹åœ¨å›è¦†ä¸­ä¿æŒè§’è‰²è¡Œç‚ºèˆ‡å…¶æ€§æ ¼ã€å±¬æ€§ä¸€è‡´ï¼š\n\n';
    chars.forEach(c=>{
      p+=`**${c.name}**`;
      if(c.title)p+=`ï¼ˆ${c.title}ï¼‰`;
      p+='\n';
      // v25: æ·»åŠ æ€§æ ¼æ‘˜è¦
      if(c.personality)p+=`- æ€§æ ¼ï¼š${c.personality}\n`;
      if(c.description)p+=`- ç°¡ä»‹ï¼š${c.description}\n`;
      // v25: æ·»åŠ å ´æ™¯æè¿°
      if(c.scenario)p+=`- å ´æ™¯ï¼š${c.scenario}\n`;
      if(c.stats&&Object.keys(c.stats).length){
        p+=`- å±¬æ€§ï¼š${Object.entries(c.stats).map(([k,v])=>`${k}:${v}`).join('ã€')}\n`;
      }
      if(c.tags&&c.tags.length){
        p+=`- ç‰¹å¾µï¼š${c.tags.join('ã€')}\n`;
      }
      p+='\n';
    });
    
    // v25: æ³¨å…¥è§’è‰²é—œä¿‚ä¿¡æ¯
    const charsWithRelations = chars.filter(c => c.relationships && c.relationships.length > 0);
    if(charsWithRelations.length){
      p+='\n### ğŸ‘¥ è§’è‰²é—œä¿‚\n';
      charsWithRelations.forEach(c => {
        c.relationships.forEach(rel => {
          p+=`- ${c.name} â†’ ${rel.targetName || 'æŸäºº'}ï¼š${rel.label || rel.type}`;
          if(rel.description) p+=`ï¼ˆ${rel.description}ï¼‰`;
          p+='\n';
        });
      });
      p+='\n';
    }
    
    // v25: æ³¨å…¥å°è©±ç¤ºä¾‹
    const charsWithExamples = chars.filter(c => c.mes_example);
    if(charsWithExamples.length){
      p+='\n### ğŸ’¬ å°è©±ç¤ºä¾‹\n';
      p+='ä»¥ä¸‹æ˜¯è§’è‰²çš„å°è©±é¢¨æ ¼ç¤ºä¾‹ï¼Œè«‹åƒè€ƒé€™äº›ç¤ºä¾‹ä¾†æ¨¡ä»¿è§’è‰²çš„èªªè©±æ–¹å¼ï¼š\n\n';
      charsWithExamples.forEach(c => {
        p+=`**${c.name} çš„å°è©±é¢¨æ ¼ï¼š**\n`;
        p+=c.mes_example.replace(/<START>/g, '\n---\n');
        p+='\n\n';
      });
    }
  }
  
  // 2. ç¶“ç‡Ÿæ¨¡å¼ï¼šæ·»åŠ è³‡æºç‹€æ…‹ï¼ˆä¸å¼·åˆ¶ JSON è¼¸å‡ºï¼‰
  if(isSimMode){
    if(story.simResources && story.simResources.length > 0){
      p+='\n### ğŸ“Š ç•¶å‰è³‡æºç‹€æ…‹ï¼ˆç¬¬ ' + (story.simDay || 1) + ' å¤©ï¼‰\n';
      story.simResources.forEach(r => {
        p+=`${r.icon} ${r.name}ï¼š${r.value.toLocaleString()}\n`;
      });
      p+='\nè«‹åœ¨å›è¦†ä¸­ç¶­æŒé€™äº›æ•¸æ“šçš„åˆç†æ€§ï¼Œå¦‚æœ‰è®ŠåŒ–å¯åœ¨å›è¦†ä¸­è‡ªç„¶èªªæ˜ã€‚\n';
    }
    // ç¶“ç‡Ÿæ¨¡å¼ä¸å¼·åˆ¶ JSON è¼¸å‡ºï¼Œè®“ prompt è‡ªå·±çš„æ ¼å¼ç”Ÿæ•ˆ
  } else {
    // 3. æ™®é€šæ¨¡å¼ï¼šè¦æ±‚ JSON æ ¼å¼è¼¸å‡ºè§’è‰²ç‹€æ…‹
    p+=`\n### ç‹€æ…‹è¼¸å‡ºæ ¼å¼ï¼ˆé‡è¦ï¼‰
æ¯æ¬¡å›è¦†æ™‚ï¼Œè«‹åœ¨åŠ‡æƒ…å…§å®¹ä¹‹å¾Œï¼Œç”¨ä»¥ä¸‹ JSON æ ¼å¼è¼¸å‡ºè§’è‰²ç‹€æ…‹æ›´æ–°ï¼š

\`\`\`json
{
  "characters": [
    {
      "name": "è§’è‰²å",
      "title": "èº«ä»½/ç¨±è™Ÿ",
      "location": "ç•¶å‰ä½ç½®",
      "stats": {
        "è¡¨é¢å¥½æ„Ÿ": 0-100,
        "çœŸå¯¦å¥½æ„Ÿ": 0-100,
        "å…¶ä»–å±¬æ€§": æ•¸å€¼
      },
      "mood": "ç•¶å‰æƒ…ç·’",
      "note": "ç°¡çŸ­å‚™è¨»"
    }
  ]
}
\`\`\`

æ³¨æ„ï¼š
- åªè¼¸å‡ºæœ¬æ¬¡äº’å‹•ä¸­å‡ºç¾æˆ–ç‹€æ…‹æœ‰è®ŠåŒ–çš„è§’è‰²
- æ•¸å€¼ç”¨ 0-100 è¡¨ç¤º
- å¦‚æœæ²’æœ‰è§’è‰²ç‹€æ…‹è®ŠåŒ–ï¼Œå¯ä»¥ä¸è¼¸å‡º JSON
- JSON å¿…é ˆæ”¾åœ¨å›è¦†çš„æœ€å¾Œï¼Œç”¨ \`\`\`json å’Œ \`\`\` åŒ…è£¹
`;
  }
  
  // v24: æ·»åŠ ç©å®¶ç‹€æ…‹é¢æ¿
  const playerPanel = await db.playerPanels.where('storyId').equals(story.id).first();
  if(playerPanel && playerPanel.attributes && playerPanel.attributes.length > 0){
    p += `\n### ğŸ‘¤ ç©å®¶ç‹€æ…‹ï¼ˆ${playerPanel.name || 'ä¸»è§’'}ï¼‰\n`;
    p += 'ä»¥ä¸‹æ˜¯ç©å®¶/ä¸»è§’çš„ç•¶å‰ç‹€æ…‹ï¼Œè«‹åœ¨å›è¦†ä¸­åƒè€ƒé€™äº›æ•¸å€¼ï¼š\n\n';
    
    // æŒ‰åˆ†çµ„æ•´ç†å±¬æ€§
    const groups = {};
    playerPanel.attributes.forEach(attr => {
      const group = attr.group || 'åŸºç¤å±¬æ€§';
      if(!groups[group]) groups[group] = [];
      groups[group].push(attr);
    });
    
    for(const [groupName, attrs] of Object.entries(groups)){
      p += `**ã€${groupName}ã€‘**\n`;
      attrs.forEach(attr => {
        // å¾ values å°è±¡ä¸­ç²å–ç•¶å‰å€¼ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨é»˜èªå€¼
        const currentValue = playerPanel.values?.[attr.name] ?? attr.defaultValue ?? 0;
        let valueStr = '';
        if(attr.type === 'percent'){
          valueStr = `${currentValue}%`;
        } else if(attr.type === 'number'){
          valueStr = `${currentValue}`;
        } else {
          valueStr = currentValue;
        }
        p += `- ${attr.icon || 'â€¢'} ${attr.name}ï¼š${valueStr}\n`;
      });
      p += '\n';
    }
  }
  
  // v24: æ·»åŠ èƒŒåŒ…ç‰©å“
  if(story.inventory && story.inventory.length > 0){
    p += '\n### ğŸ’ èƒŒåŒ…ç‰©å“\n';
    p += 'ä»¥ä¸‹æ˜¯ç©å®¶ç›®å‰æŒæœ‰çš„ç‰©å“ï¼Œè«‹åœ¨åŠ‡æƒ…ä¸­åˆç†ä½¿ç”¨é€™äº›ç‰©å“ï¼š\n\n';
    
    // æŒ‰åˆ†é¡æ•´ç†ç‰©å“
    const categories = {
      'weapon': 'âš”ï¸ æ­¦å™¨',
      'armor': 'ğŸ›¡ï¸ é˜²å…·',
      'consumable': 'ğŸ§ª æ¶ˆè€—å“',
      'material': 'ğŸ“¦ ææ–™',
      'key': 'ğŸ”‘ é—œéµç‰©å“',
      'other': 'ğŸ“‹ å…¶ä»–'
    };
    
    const itemsByCategory = {};
    story.inventory.forEach(item => {
      const cat = item.category || 'other';
      if(!itemsByCategory[cat]) itemsByCategory[cat] = [];
      itemsByCategory[cat].push(item);
    });
    
    for(const [catKey, catName] of Object.entries(categories)){
      const items = itemsByCategory[catKey];
      if(items && items.length > 0){
        p += `**${catName}**\n`;
        items.forEach(item => {
          p += `- ${item.icon || 'â€¢'} ${item.name}`;
          if(item.quantity && item.quantity > 1) p += ` Ã—${item.quantity}`;
          if(item.description) p += `ï¼ˆ${item.description}ï¼‰`;
          p += '\n';
        });
        p += '\n';
      }
    }
  }
  
  // v14: æ‡‰ç”¨æ¨¡æ¿è®Šé‡æ›¿æ›
  p = replaceTemplateVars(p);

  // v16: æ·»åŠ ç°¡ç¹è½‰æ›æŒ‡ç¤º
  p += getChineseConvertPrompt();

  // v16: æ·»åŠ ç•¶å‰å ´æ™¯ä¿¡æ¯
  p += await getActiveScenePrompt();

  // v22: æ·»åŠ  Persona ä¿¡æ¯
  p += buildPersonaPrompt();

  return p;
}

// æ‰“å­—æ©Ÿæ•ˆæœ
function showTyping(){const c=document.getElementById('content-area'),d=document.createElement('div');d.id='typing';d.className='typing';d.innerHTML='<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';c.appendChild(d);c.scrollTop=c.scrollHeight;}
function hideTyping(){const t=document.getElementById('typing');if(t)t.remove();}
async function typewriter(m){
  const c=document.getElementById('content-area'),d=document.createElement('div');
  d.className='msg';d.dataset.id=m.id;d.oncontextmenu=e=>showMsgMenu(e,m.id);
  c.appendChild(d);
  const text=m.content;
  const speed=settings.typingSpeed||0;
  
  // è§£æå…§å®¹
  const parsed = parseAIResponse(text);
  const storyText = parsed.story;
  
  // å®Œæˆå¾Œæ¸²æŸ“çš„å‡½æ•¸
  const renderFinal = () => {
    let html = `<div class="msg-ai-story">${marked.parse(storyText)}</div>`;
    if(parsed.characters && parsed.characters.length > 0){
      html += renderStatusCards(parsed.characters, m.id);
      // åŒæ­¥è§’è‰²ç‹€æ…‹åˆ°æ•¸æ“šåº«
      syncCharacterStatus(parsed.characters);
    }
    if(parsed.formatWarning){
      html += `<div class="msg-format-warning"><span class="icon">âš ï¸</span>AI æœªæŒ‰æ ¼å¼è¼¸å‡ºç‹€æ…‹æ•¸æ“šï¼Œå·²é¡¯ç¤ºåŸæ–‡</div>`;
    }
    if(m.tokens){
      html += `<div class="msg-timestamp">${m.tokens} tokens</div>`;
    }
    d.innerHTML = html;
    
    // v25: æª¢æŸ¥ä¸¦è‡ªå‹•åˆ‡æ›è§’è‰²è¡¨æƒ…
    checkAutoExpressionSwitch(storyText);
  };
  
  // å¦‚æœé€Ÿåº¦ç‚º 0ï¼Œç›´æ¥é¡¯ç¤ºå…¨éƒ¨å…§å®¹
  if(speed===0){
    renderFinal();
    c.scrollTop=c.scrollHeight;
    return;
  }
  
  // æ‰“å­—æ©Ÿæ•ˆæœåªå°åŠ‡æƒ…éƒ¨åˆ†
  let i=0;
  return new Promise(resolve=>{
    typingCtrl={cancelled:false};
    function type(){
      if(typingCtrl.cancelled){
        renderFinal();
        c.scrollTop=c.scrollHeight;
        resolve();
        return;
      }
      if(i<storyText.length){
        d.innerHTML=`<div class="msg-ai-story"><span>${marked.parse(storyText.slice(0,i+1))}</span><span class="typing-cursor"></span></div>`;
        c.scrollTop=c.scrollHeight;
        i++;
        setTimeout(type,speed);
      }else{
        renderFinal();
        c.scrollTop=c.scrollHeight;
        resolve();
      }
    }
    type();
  });
}

// åŒæ­¥è§’è‰²ç‹€æ…‹åˆ°æ•¸æ“šåº«
async function syncCharacterStatus(characters){
  if(!story || !characters || characters.length === 0) return;
  
  for(const char of characters){
    try{
      // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨
      const existing = await db.characters.where('storyId').equals(story.id).filter(c => c.name === char.name).first();
      
      if(existing){
        // æ›´æ–°ç¾æœ‰è§’è‰²
        const updates = {};
        if(char.title) updates.title = char.title;
        if(char.location) updates.location = char.location;
        if(char.stats) updates.stats = {...(existing.stats||{}), ...char.stats};
        if(char.mood) updates.mood = char.mood;
        if(char.note) updates.description = char.note;
        if(char.tags && char.tags.length) updates.tags = char.tags;
        updates.updatedAt = Date.now();
        
        await db.characters.update(existing.id, updates);
        console.log('Updated character:', char.name);
      }else{
        // å‰µå»ºæ–°è§’è‰²
        const newChar = {
          id: crypto.randomUUID(),
          storyId: story.id,
          name: char.name,
          title: char.title || '',
          avatar: char.avatar || 'ğŸ‘¤',
          stats: char.stats || {},
          tags: char.tags || [],
          description: char.note || '',
          location: char.location || '',
          mood: char.mood || '',
          createdAt: Date.now(),
          updatedAt: Date.now()
        };
        await db.characters.put(newChar);
        console.log('Created new character:', char.name);
      }
    }catch(e){
      console.error('Error syncing character:', char.name, e);
    }
  }
}

// ============================================
// Lorebook è§¸ç™¼ç³»çµ±
// ============================================

let editLorebookId = null;
let lorebookConditions = [];

// æ¸²æŸ“ Lorebook åˆ—è¡¨
async function renderLorebook(){
  if(!story) return;
  const c = document.getElementById('lorebook-list');
  const entries = await db.lorebook.where('storyId').equals(story.id).toArray();
  
  // æŒ‰å„ªå…ˆç´šæ’åº
  entries.sort((a,b) => (b.priority||0) - (a.priority||0));
  
  if(!entries.length){
    c.innerHTML = `<div class="empty" style="padding:40px 20px">
      <div class="empty-icon">ğŸ”®</div>
      <div class="empty-title">Lorebook ç‚ºç©º</div>
      <div class="empty-desc">æ·»åŠ è¨­å®šæ¢ç›®ï¼Œç•¶å°è©±åŒ…å«é—œéµè©æ™‚è‡ªå‹•æ³¨å…¥</div>
      <button class="action-btn primary" style="margin-top:12px" onclick="addLorebook()">â• æ·»åŠ æ¢ç›®</button>
      <button class="action-btn secondary" style="margin-top:8px" onclick="importFromLore()">ğŸ“¥ å¾è³‡æ–™åº«å°å…¥</button>
    </div>`;
    return;
  }
  
  let html = '';
  for(const entry of entries){
    const hasConditions = entry.conditions && entry.conditions.length > 0;
    const keywords = (entry.keywords || []).slice(0,3).join(', ');
    const moreKeywords = (entry.keywords || []).length > 3 ? ` +${entry.keywords.length-3}` : '';
    
    html += `<div class="lorebook-card ${entry.isEnabled?'':'disabled'}">
      <div class="lorebook-card-header">
        <div class="lorebook-card-status"></div>
        <div class="lorebook-card-title">${esc(entry.name)}</div>
        ${hasConditions ? '<span class="lorebook-card-lock">ğŸ”</span>' : ''}
      </div>
      <div class="lorebook-card-triggers">ğŸ·ï¸ ${esc(keywords)}${moreKeywords}</div>
      <div class="lorebook-card-stats">
        <span>å·²è§¸ç™¼ ${entry.triggerCount||0} æ¬¡</span>
        <span>å„ªå…ˆç´š ${entry.priority||100}</span>
      </div>
      <div class="lorebook-card-actions">
        <button class="action-btn secondary" onclick="editLorebook('${entry.id}')">ç·¨è¼¯</button>
        <button class="action-btn secondary" onclick="toggleLorebookEnabled('${entry.id}')">${entry.isEnabled?'ç¦ç”¨':'å•Ÿç”¨'}</button>
        <button class="action-btn secondary" onclick="deleteLorebook('${entry.id}')">ğŸ—‘ï¸</button>
      </div>
    </div>`;
  }
  c.innerHTML = html;
}

// æ·»åŠ  Lorebook æ¢ç›®
function addLorebook(){
  if(!story){toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'),'warning');return;}
  editLorebookId = null;
  lorebookConditions = [];
  document.getElementById('lorebook-id').value = '';
  document.getElementById('lorebook-name').value = '';
  document.getElementById('lorebook-keywords').value = '';
  document.getElementById('lorebook-content').value = '';
  document.getElementById('lorebook-depth').value = '2';
  document.getElementById('lorebook-priority').value = '100';
  document.getElementById('lorebook-cooldown').value = '0';
  document.getElementById('lorebook-max-triggers').value = '0';
  document.getElementById('lorebook-one-time').checked = false;
  document.getElementById('lorebook-condition-list').innerHTML = '';
  document.getElementById('lorebook-advanced').style.display = 'none';
  document.getElementById('lorebook-conditions').style.display = 'none';
  showModal('lorebook-modal');
}

// ç·¨è¼¯ Lorebook æ¢ç›®
async function editLorebook(id){
  const entry = await db.lorebook.get(id);
  if(!entry) return;
  
  editLorebookId = id;
  lorebookConditions = entry.conditions || [];
  
  document.getElementById('lorebook-id').value = id;
  document.getElementById('lorebook-name').value = entry.name || '';
  document.getElementById('lorebook-keywords').value = (entry.keywords || []).join(', ');
  document.getElementById('lorebook-content').value = entry.content || '';
  document.getElementById('lorebook-depth').value = entry.depth || '2';
  document.getElementById('lorebook-priority').value = entry.priority || '100';
  document.getElementById('lorebook-cooldown').value = entry.cooldown || '0';
  document.getElementById('lorebook-max-triggers').value = entry.maxTriggers || '0';
  document.getElementById('lorebook-one-time').checked = entry.oneTime || false;
  
  // è¨­ç½®æ¢ä»¶é‚è¼¯
  const logicRadios = document.querySelectorAll('input[name="lorebook-logic"]');
  logicRadios.forEach(r => r.checked = r.value === (entry.conditionLogic || 'AND'));
  
  // æ¸²æŸ“æ¢ä»¶åˆ—è¡¨
  renderLorebookConditions();
  
  showModal('lorebook-modal');
}

// ä¿å­˜ Lorebook æ¢ç›®
async function saveLorebook(){
  const name = document.getElementById('lorebook-name').value.trim();
  const keywordsStr = document.getElementById('lorebook-keywords').value.trim();
  const content = document.getElementById('lorebook-content').value.trim();
  
  if(!name){toast(T('è«‹è¼¸å…¥åç¨±'),'warning');return;}
  if(!keywordsStr){toast(T('è«‹è¼¸å…¥è§¸ç™¼é—œéµè©'),'warning');return;}
  if(!content){toast(T('è«‹è¼¸å…¥å…§å®¹'),'warning');return;}
  
  const keywords = keywordsStr.split(/[,ï¼Œ]/).map(k=>k.trim()).filter(k=>k);
  const conditionLogic = document.querySelector('input[name="lorebook-logic"]:checked')?.value || 'AND';
  
  const entry = {
    id: editLorebookId || crypto.randomUUID(),
    storyId: story.id,
    name,
    keywords,
    content,
    depth: parseInt(document.getElementById('lorebook-depth').value) || 2,
    priority: parseInt(document.getElementById('lorebook-priority').value) || 100,
    cooldown: parseInt(document.getElementById('lorebook-cooldown').value) || 0,
    maxTriggers: parseInt(document.getElementById('lorebook-max-triggers').value) || 0,
    oneTime: document.getElementById('lorebook-one-time').checked,
    conditions: lorebookConditions,
    conditionLogic,
    isEnabled: true,
    triggerCount: 0,
    lastTriggered: null,
    createdAt: editLorebookId ? undefined : Date.now(),
    updatedAt: Date.now()
  };
  
  // ä¿ç•™åŸæœ‰çš„ triggerCount
  if(editLorebookId){
    const existing = await db.lorebook.get(editLorebookId);
    if(existing){
      entry.triggerCount = existing.triggerCount;
      entry.lastTriggered = existing.lastTriggered;
      entry.createdAt = existing.createdAt;
      entry.isEnabled = existing.isEnabled;
    }
  }
  
  await db.lorebook.put(entry);
  closeModal('lorebook-modal');
  toast(editLorebookId ? 'æ¢ç›®å·²æ›´æ–°' : 'æ¢ç›®å·²æ·»åŠ ', 'success');
  renderLorebook();
}

// åˆ‡æ›å•Ÿç”¨ç‹€æ…‹
async function toggleLorebookEnabled(id){
  const entry = await db.lorebook.get(id);
  if(entry){
    await db.lorebook.update(id, {isEnabled: !entry.isEnabled});
    toast(entry.isEnabled ? 'å·²ç¦ç”¨' : 'å·²å•Ÿç”¨');
    renderLorebook();
  }
}

// åˆªé™¤ Lorebook æ¢ç›®
function deleteLorebook(id){
  showConfirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æ¢ç›®å—ï¼Ÿ', async()=>{
    await db.lorebook.delete(id);
    toast(T('å·²åˆªé™¤'),'success');
    renderLorebook();
  });
}

// å¾è³‡æ–™åº«å°å…¥
async function importFromLore(){
  if(!story){toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'),'warning');return;}
  
  const entries = await db.loreEntries.where('storyId').equals(story.id).toArray();
  if(!entries.length){
    toast(T('è³‡æ–™åº«ç‚ºç©ºï¼Œæ²’æœ‰å¯å°å…¥çš„æ¢ç›®'),'warning');
    return;
  }
  
  showConfirm(`ç¢ºå®šè¦å¾è³‡æ–™åº«å°å…¥ ${entries.length} å€‹æ¢ç›®å—ï¼Ÿ`, async()=>{
    let count = 0;
    for(const e of entries){
      // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
      const existing = await db.lorebook.where('storyId').equals(story.id).filter(l=>l.name===e.name).first();
      if(existing) continue;
      
      await db.lorebook.put({
        id: crypto.randomUUID(),
        storyId: story.id,
        name: e.name,
        keywords: [e.name],
        content: e.content || e.description || '',
        depth: 2,
        priority: 100,
        cooldown: 0,
        maxTriggers: 0,
        oneTime: false,
        conditions: [],
        conditionLogic: 'AND',
        isEnabled: true,
        triggerCount: 0,
        lastTriggered: null,
        createdAt: Date.now(),
        updatedAt: Date.now()
      });
      count++;
    }
    toast(`å·²å°å…¥ ${count} å€‹æ¢ç›®`,'success');
    renderLorebook();
  });
}

// é€²éšè¨­ç½®é–‹é—œ
function toggleLorebookAdvanced(){
  const el = document.getElementById('lorebook-advanced');
  const toggle = document.getElementById('lorebook-advanced-toggle');
  if(el.style.display === 'none'){
    el.style.display = 'block';
    toggle.textContent = 'â–²';
  }else{
    el.style.display = 'none';
    toggle.textContent = 'â–¼';
  }
}

// æ¢ä»¶è¨­ç½®é–‹é—œ
function toggleLorebookConditions(){
  const el = document.getElementById('lorebook-conditions');
  const toggle = document.getElementById('lorebook-conditions-toggle');
  if(el.style.display === 'none'){
    el.style.display = 'block';
    toggle.textContent = 'â–²';
  }else{
    el.style.display = 'none';
    toggle.textContent = 'â–¼';
  }
}

// æ·»åŠ æ¢ä»¶
async function addLorebookCondition(){
  lorebookConditions.push({
    type: 'stat',
    character: '',
    stat: '',
    operator: '>=',
    value: 50
  });
  renderLorebookConditions();
}

// æ¸²æŸ“æ¢ä»¶åˆ—è¡¨
async function renderLorebookConditions(){
  const container = document.getElementById('lorebook-condition-list');
  const chars = story ? await db.characters.where('storyId').equals(story.id).toArray() : [];
  
  let html = '';
  lorebookConditions.forEach((cond, idx) => {
    // ç²å–è§’è‰²çš„å±¬æ€§åˆ—è¡¨
    const charOptions = chars.map(c => `<option value="${esc(c.name)}" ${cond.character===c.name?'selected':''}>${esc(c.name)}</option>`).join('');
    
    // ç²å–é¸ä¸­è§’è‰²çš„å±¬æ€§
    const selectedChar = chars.find(c => c.name === cond.character);
    const statOptions = selectedChar && selectedChar.stats 
      ? Object.keys(selectedChar.stats).map(s => `<option value="${esc(s)}" ${cond.stat===s?'selected':''}>${esc(s)}</option>`).join('')
      : '<option value="">è«‹å…ˆé¸æ“‡è§’è‰²</option>';
    
    html += `<div class="lorebook-condition" data-idx="${idx}">
      <select onchange="updateLorebookCondition(${idx},'character',this.value);setTimeout(()=>renderLorebookConditions(),0)">
        <option value="">é¸æ“‡è§’è‰²</option>
        ${charOptions}
      </select>
      <select onchange="updateLorebookCondition(${idx},'stat',this.value)">
        <option value="">é¸æ“‡å±¬æ€§</option>
        ${statOptions}
      </select>
      <select onchange="updateLorebookCondition(${idx},'operator',this.value)">
        <option value=">=" ${cond.operator==='>='?'selected':''}>â‰¥</option>
        <option value=">" ${cond.operator==='>'?'selected':''}>></option>
        <option value="<=" ${cond.operator==='<='?'selected':''}>â‰¤</option>
        <option value="<" ${cond.operator==='<'?'selected':''}><</option>
        <option value="==" ${cond.operator==='=='?'selected':''}>ï¼</option>
      </select>
      <input type="number" value="${cond.value}" onchange="updateLorebookCondition(${idx},'value',parseInt(this.value))">
      <span style="cursor:pointer;color:var(--error)" onclick="removeLorebookCondition(${idx})">ğŸ—‘ï¸</span>
    </div>`;
  });
  
  container.innerHTML = html || '<div style="font-size:12px;color:var(--text-tertiary);text-align:center;padding:12px">æš«ç„¡æ¢ä»¶ï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•æ·»åŠ </div>';
}

// æ›´æ–°æ¢ä»¶
function updateLorebookCondition(idx, field, value){
  if(lorebookConditions[idx]){
    lorebookConditions[idx][field] = value;
  }
}

// ç§»é™¤æ¢ä»¶
function removeLorebookCondition(idx){
  lorebookConditions.splice(idx, 1);
  renderLorebookConditions();
}

// æª¢æ¸¬é—œéµè©åŒ¹é…
function checkKeywordMatch(entry, userMessage, recentMessages){
  const keywords = entry.keywords || [];
  const depth = entry.depth || 2;

  // é©—è­‰è¼¸å…¥
  if(!userMessage || typeof userMessage !== 'string'){
    userMessage = '';
  }

  // åˆä½µæœ€è¿‘æ¶ˆæ¯
  let textToCheck = userMessage;
  const recentSlice = recentMessages.slice(-depth);
  recentSlice.forEach(m => {
    textToCheck += ' ' + (m.content || '');
  });
  textToCheck = textToCheck.toLowerCase();
  
  // æª¢æŸ¥é—œéµè©
  for(const keyword of keywords){
    if(textToCheck.includes(keyword.toLowerCase())){
      entry._matchedKeyword = keyword;
      return true;
    }
  }
  return false;
}

// æª¢æŸ¥è§¸ç™¼æ¢ä»¶
async function checkLorebookConditions(entry){
  if(!entry.conditions || entry.conditions.length === 0) return true;
  
  const chars = await db.characters.where('storyId').equals(story.id).toArray();
  const results = [];
  
  for(const cond of entry.conditions){
    const char = chars.find(c => c.name === cond.character);
    if(!char || !char.stats) {
      results.push(false);
      continue;
    }
    
    const statValue = char.stats[cond.stat];
    if(statValue === undefined){
      results.push(false);
      continue;
    }
    
    let met = false;
    switch(cond.operator){
      case '>=': met = statValue >= cond.value; break;
      case '>': met = statValue > cond.value; break;
      case '<=': met = statValue <= cond.value; break;
      case '<': met = statValue < cond.value; break;
      case '==': met = statValue === cond.value; break;
    }
    results.push(met);
  }
  
  if(entry.conditionLogic === 'OR'){
    return results.some(r => r);
  }else{
    return results.every(r => r);
  }
}

// ç²å–è§¸ç™¼çš„ Lorebook å…§å®¹
async function getTriggeredLorebook(userMessage){
  if(!story) return [];
  
  const entries = await db.lorebook.where('storyId').equals(story.id).filter(e => e.isEnabled).toArray();
  const triggered = [];
  const recentMsgs = msgs.slice(-5);
  
  for(const entry of entries){
    // æª¢æŸ¥é—œéµè©
    if(!checkKeywordMatch(entry, userMessage, recentMsgs)) continue;
    
    // æª¢æŸ¥æ¢ä»¶
    const conditionsMet = await checkLorebookConditions(entry);
    if(!conditionsMet) continue;
    
    // æª¢æŸ¥å†·å»
    if(entry.cooldown > 0 && entry.lastTriggered){
      const msgsSinceTrigger = msgs.filter(m => m.createdAt > entry.lastTriggered).length;
      if(msgsSinceTrigger < entry.cooldown) continue;
    }
    
    // æª¢æŸ¥æœ€å¤§è§¸ç™¼æ¬¡æ•¸
    if(entry.maxTriggers > 0 && (entry.triggerCount || 0) >= entry.maxTriggers) continue;
    
    triggered.push(entry);
  }
  
  // v25: æª¢æŸ¥è§’è‰²å°ˆå±¬Lorebook
  const chars = await db.characters.where('storyId').equals(story.id).toArray();
  const activeScene = await getActiveScene();
  
  for(const char of chars){
    if(!char.character_book || !char.character_book.entries) continue;
    
    // æª¢æŸ¥è§¸ç™¼æ¨¡å¼
    const triggerMode = char.character_book.triggerMode || 'scene';
    
    // å¦‚æœæ˜¯å ´æ™¯æ¨¡å¼ï¼Œæª¢æŸ¥è§’è‰²æ˜¯å¦åœ¨ç•¶å‰å ´æ™¯ä¸­
    if(triggerMode === 'scene'){
      if(activeScene && activeScene.characterIds){
        if(!activeScene.characterIds.includes(char.id)) continue;
      }
    }
    
    // æª¢æŸ¥æ¯å€‹æ¢ç›®
    for(const entry of char.character_book.entries){
      if(!entry.enabled) continue;
      
      // å¸¸é§æ¢ç›®ç›´æ¥è§¸ç™¼
      if(entry.constant){
        triggered.push({
          ...entry,
          name: `[${char.name}] ${entry.keys?.join(', ') || 'å¸¸é§'}`,
          isCharacterBook: true,
          characterName: char.name
        });
        continue;
      }
      
      // æª¢æŸ¥é—œéµè©åŒ¹é…
      const keywords = entry.keys || [];
      const searchText = userMessage + ' ' + recentMsgs.map(m => m.content).join(' ');
      const matched = keywords.some(kw => searchText.toLowerCase().includes(kw.toLowerCase()));
      
      if(matched){
        triggered.push({
          ...entry,
          name: `[${char.name}] ${entry.keys?.join(', ')}`,
          isCharacterBook: true,
          characterName: char.name
        });
      }
    }
  }
  
  // æŒ‰å„ªå…ˆç´šæ’åº
  triggered.sort((a, b) => (b.priority || 0) - (a.priority || 0));
  
  return triggered;
}

// v25: ç²å–ç•¶å‰æ´»å‹•å ´æ™¯
async function getActiveScene(){
  if(!story) return null;
  const scenes = await db.scenes.where('storyId').equals(story.id).toArray();
  return scenes.find(s => s.isActive);
}

// é¡¯ç¤ºè§¸ç™¼æç¤º
function showLorebookTriggerToast(entries){
  if(!entries || entries.length === 0) return;
  
  const names = entries.map(e => e.name).join('ã€');
  const toast = document.createElement('div');
  toast.className = 'lore-trigger-toast';
  toast.innerHTML = `<span>ğŸ”®</span><span>å·²è§¸ç™¼ï¼š${esc(names)}</span>`;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(-50%) translateY(-10px)';
    setTimeout(() => toast.remove(), 300);
  }, 2500);
}

// æ‰“å­—æ©Ÿé»æ“Šå–æ¶ˆåŠŸèƒ½
function initTypingCancel(){
  const contentArea = document.getElementById('content-area');
  if(contentArea){
    contentArea.addEventListener('click', () => {
      if(typingCtrl && !typingCtrl.cancelled) typingCtrl.cancelled = true;
    });
  }
}

// è³‡æ–™åº«
async function renderLore(){
  if(!story)return;
  const c=document.getElementById('lore-list');
  const entries=await db.loreEntries.where('storyId').equals(story.id).toArray();
  const grouped={character:[],location:[],item:[],setting:[]};
  entries.forEach(e=>{if(grouped[e.category])grouped[e.category].push(e);});
  const labels={character:{icon:'ğŸ‘¥',label:'è§’è‰²'},location:{icon:'ğŸ—ºï¸',label:'åœ°é»'},item:{icon:'ğŸ“¦',label:'ç‰©å“'},setting:{icon:'ğŸ“œ',label:'è¨­å®š'}};
  let html='',selCount=0;
  for(const[cat,items]of Object.entries(grouped)){
    if(!items.length)continue;
    const{icon,label}=labels[cat];
    html+=`<div class="lore-section"><div class="lore-header" onclick="toggleLoreSection(this)"><div class="lore-header-left"><span>${icon}</span><span>${label}</span><span class="lore-count">(${items.length})</span></div><span class="lore-toggle">â–¼</span></div><div class="lore-list">`;
    for(const e of items){
      if(e.isSelected)selCount++;
      html+=`<div class="lore-item" onclick="toggleLoreSel('${e.id}')"><div class="lore-checkbox ${e.isSelected?'checked':''}" data-id="${e.id}"></div><div class="lore-icon ${cat.slice(0,3)}">${e.icon||icon}</div><div class="lore-content"><div class="lore-name">${esc(e.name)}</div><div class="lore-desc">${esc(e.description||'')}</div></div><div class="lore-actions" onclick="event.stopPropagation()"><span onclick="editLore('${e.id}')">âœï¸</span><span onclick="deleteLore('${e.id}')">ğŸ—‘ï¸</span></div></div>`;
    }
    html+='</div></div>';
  }
  if(!html)html=`<div class="empty"><div class="empty-icon">ğŸ“–</div><div class="empty-title">${T('è³‡æ–™åº«ç‚ºç©º')}</div><div class="empty-desc">${T('é»æ“Šå³ä¸Šè§’æ·»åŠ è§’è‰²ã€åœ°é»ç­‰è¨­å®š')}</div><button class="action-btn primary" style="margin-top:12px" onclick="addLore()">â• ${T('æ·»åŠ è³‡æ–™')}</button></div>`;
  c.innerHTML=html;
  document.getElementById('lore-count').textContent=`${T('å·²é¸')} ${selCount} ${T('é …')}`;
}
function toggleLoreSection(h){h.querySelector('.lore-toggle').classList.toggle('collapsed');h.nextElementSibling.classList.toggle('collapsed');}
async function toggleLoreSel(id){const e=await db.loreEntries.get(id);if(e){await db.loreEntries.update(id,{isSelected:!e.isSelected});renderLore();}}

let editLoreId=null;
function addLore(){
  if(!story){toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'),'warning');return;}
  editLoreId=null;
  document.getElementById('lore-name').value='';
  document.getElementById('lore-category').value='character';
  document.getElementById('lore-desc').value='';
  document.getElementById('lore-content-input').value='';
  showModal('lore-modal');
}
async function editLore(id){
  const e=await db.loreEntries.get(id);
  if(!e)return;
  editLoreId=id;
  document.getElementById('lore-name').value=e.name||'';
  document.getElementById('lore-category').value=e.category||'character';
  document.getElementById('lore-desc').value=e.description||'';
  document.getElementById('lore-content-input').value=e.content||'';
  showModal('lore-modal');
}
async function saveLore(){
  const name=document.getElementById('lore-name').value.trim();
  const category=document.getElementById('lore-category').value;
  const description=document.getElementById('lore-desc').value.trim();
  const content=document.getElementById('lore-content-input').value.trim();
  if(!name){toast(T('è«‹è¼¸å…¥åç¨±'),'warning');return;}
  const entry={
    id:editLoreId||crypto.randomUUID(),
    storyId:story.id,
    name,category,description,content,
    isSelected:false,
    createdAt:Date.now()
  };
  await db.loreEntries.put(entry);
  closeModal('lore-modal');
  toast(editLoreId?'è³‡æ–™å·²æ›´æ–°':'è³‡æ–™å·²æ·»åŠ ','success');
  renderLore();
}
async function deleteLore(id){
  showConfirm('ç¢ºå®šè¦åˆªé™¤é€™æ¢è³‡æ–™å—ï¼Ÿ',async()=>{
    await db.loreEntries.delete(id);
    toast(T('è³‡æ–™å·²åˆªé™¤'),'success');
    renderLore();
  });
}

// è³‡æ–™æœç´¢
async function filterLore(){
  const keyword=document.getElementById('lore-search').value.trim().toLowerCase();
  if(!story)return;
  const c=document.getElementById('lore-list');
  const entries=await db.loreEntries.where('storyId').equals(story.id).toArray();
  
  // éæ¿¾
  const filtered=keyword?entries.filter(e=>
    e.name.toLowerCase().includes(keyword)||
    (e.description||'').toLowerCase().includes(keyword)||
    (e.content||'').toLowerCase().includes(keyword)
  ):entries;
  
  const grouped={character:[],location:[],item:[],setting:[]};
  filtered.forEach(e=>{if(grouped[e.category])grouped[e.category].push(e);});
  const labels={character:{icon:'ğŸ‘¥',label:'è§’è‰²'},location:{icon:'ğŸ—ºï¸',label:'åœ°é»'},item:{icon:'ğŸ“¦',label:'ç‰©å“'},setting:{icon:'ğŸ“œ',label:'è¨­å®š'}};
  let html='',selCount=0;
  for(const[cat,items]of Object.entries(grouped)){
    if(!items.length)continue;
    const{icon,label}=labels[cat];
    html+=`<div class="lore-section"><div class="lore-header" onclick="toggleLoreSection(this)"><div class="lore-header-left"><span>${icon}</span><span>${label}</span><span class="lore-count">(${items.length})</span></div><span class="lore-toggle">â–¼</span></div><div class="lore-list">`;
    for(const e of items){
      if(e.isSelected)selCount++;
      html+=`<div class="lore-item" onclick="toggleLoreSel('${e.id}')"><div class="lore-checkbox ${e.isSelected?'checked':''}" data-id="${e.id}"></div><div class="lore-icon ${cat.slice(0,3)}">${e.icon||icon}</div><div class="lore-content"><div class="lore-name">${esc(e.name)}</div><div class="lore-desc">${esc(e.description||'')}</div></div><div class="lore-actions" onclick="event.stopPropagation()"><span onclick="editLore('${e.id}')">âœï¸</span><span onclick="deleteLore('${e.id}')">ğŸ—‘ï¸</span></div></div>`;
    }
    html+='</div></div>';
  }
  if(!html){
    if(keyword)html=`<div class="empty"><div class="empty-icon">ğŸ”</div><div class="empty-title">${T('æœªæ‰¾åˆ°åŒ¹é…è³‡æ–™')}</div></div>`;
    else html=`<div class="empty"><div class="empty-icon">ğŸ“–</div><div class="empty-title">${T('è³‡æ–™åº«ç‚ºç©º')}</div><div class="empty-desc">${T('é»æ“Šå³ä¸Šè§’æ·»åŠ è§’è‰²ã€åœ°é»ç­‰è¨­å®š')}</div><button class="action-btn primary" style="margin-top:12px" onclick="addLore()">â• ${T('æ·»åŠ è³‡æ–™')}</button></div>`;
  }
  c.innerHTML=html;
  document.getElementById('lore-count').textContent=`${T('å·²é¸')} ${selCount} ${T('é …')}`;
}

// AI æå–ä¸–ç•Œè§€è¨­å®š
let aiExtractData = null;
async function aiExtractLore(){
  if(!story){toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'),'warning');return;}
  
  // æ”¶é›†ä¾†æºæ•¸æ“š
  let sourceContent = '';
  
  // 1. å¾æŒ‡ä»¤ Prompt æå–
  const bindings = await db.storyInstructions.where('storyId').equals(story.id).toArray();
  if(bindings.length > 0){
    const instIds = bindings.map(b => b.instructionId);
    const instructions = await db.instructions.where('id').anyOf(instIds).toArray();
    instructions.forEach(inst => {
      sourceContent += `\nã€æŒ‡ä»¤è¨­å®šã€‘\n${inst.content || ''}\n`;
    });
  }
  
  // 2. å¾æ•…äº‹åŠ‡æƒ…æå–ï¼ˆæœ€è¿‘ N æ¢æ¶ˆæ¯ï¼‰
  if(msgs && msgs.length > 0){
    const recentMsgs = msgs.slice(-30); // æœ€è¿‘ 30 æ¢
    const storyContent = recentMsgs.map(m => m.content).join('\n');
    sourceContent += `\nã€æ•…äº‹åŠ‡æƒ…ã€‘\n${storyContent}\n`;
  }
  
  if(!sourceContent.trim()){
    toast(T('æ²’æœ‰å¯æå–çš„å…§å®¹'),'warning');
    return;
  }
  
  showLoading('AI æ­£åœ¨åˆ†æä¸¦æå–è¨­å®š...');
  
  const prompt = `è«‹åˆ†æä»¥ä¸‹å…§å®¹ï¼Œæå–å…¶ä¸­çš„ä¸–ç•Œè§€è¨­å®šã€‚è«‹ä»¥ JSON æ ¼å¼è¿”å›ï¼ŒåŒ…å«ä»¥ä¸‹é¡åˆ¥ï¼š

1. charactersï¼ˆè§’è‰²ï¼‰ï¼šåŒ…å« name, description, details
2. locationsï¼ˆåœ°é»ï¼‰ï¼šåŒ…å« name, description
3. itemsï¼ˆç‰©å“ï¼‰ï¼šåŒ…å« name, description
4. settingsï¼ˆè¨­å®š/è¦å‰‡ï¼‰ï¼šåŒ…å« name, description

æ³¨æ„ï¼š
- åªæå–æ˜ç¢ºå‡ºç¾æˆ–æåŠçš„å…§å®¹
- æ¯å€‹é¡åˆ¥æœ€å¤šæå– 10 å€‹æœ€é‡è¦çš„æ¢ç›®
- æè¿°è¦ç°¡æ½”ä½†å®Œæ•´

è«‹åªè¿”å› JSONï¼Œä¸è¦å…¶ä»–å…§å®¹ï¼š
{
  "characters": [{"name": "", "description": ""}],
  "locations": [{"name": "", "description": ""}],
  "items": [{"name": "", "description": ""}],
  "settings": [{"name": "", "description": ""}]
}

å¾…åˆ†æå…§å®¹ï¼š
${sourceContent.slice(0, 15000)}`;

  try{
    const response = await callAI(prompt);
    hideLoading();
    
    // è§£æ JSON - response æ˜¯å°è±¡ï¼Œéœ€è¦å– content
    const responseText = response.content || response;
    let data;
    const jsonMatch = responseText.match(/\{[\s\S]*\}/);
    if(jsonMatch){
      data = JSON.parse(jsonMatch[0]);
    }else{
      throw new Error('ç„¡æ³•è§£æ AI è¿”å›çš„å…§å®¹');
    }
    
    // é¡¯ç¤ºæå–çµæœä¾›ç”¨æˆ¶ç¢ºèª
    aiExtractData = data;
    showAiExtractResults(data);
  }catch(e){
    hideLoading();
    toast('æå–å¤±æ•—: ' + e.message, 'error');
  }
}

function showAiExtractResults(data){
  const categoryLabels = {
    characters: {icon: 'ğŸ‘¥', label: 'è§’è‰²', category: 'character'},
    locations: {icon: 'ğŸ—ºï¸', label: 'åœ°é»', category: 'location'},
    items: {icon: 'ğŸ“¦', label: 'ç‰©å“', category: 'item'},
    settings: {icon: 'ğŸ“œ', label: 'è¨­å®š', category: 'setting'}
  };
  
  let html = '<div style="max-height:400px;overflow-y:auto">';
  let totalCount = 0;
  
  for(const [key, items] of Object.entries(data)){
    if(!items || !items.length) continue;
    const {icon, label, category} = categoryLabels[key] || {icon: 'ğŸ“„', label: key, category: 'setting'};
    
    html += `<div style="margin-bottom:16px">`;
    html += `<div style="font-weight:600;margin-bottom:8px">${icon} ${label} (${items.length})</div>`;
    
    items.forEach((item, idx) => {
      totalCount++;
      const itemId = `extract-${key}-${idx}`;
      html += `<div style="display:flex;align-items:flex-start;gap:8px;padding:8px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:6px">`;
      html += `<input type="checkbox" id="${itemId}" checked style="margin-top:4px" data-category="${category}" data-name="${esc(item.name)}" data-desc="${esc(item.description || '')}">`;
      html += `<label for="${itemId}" style="flex:1;cursor:pointer">`;
      html += `<div style="font-weight:500">${esc(item.name)}</div>`;
      if(item.description) html += `<div style="font-size:12px;color:var(--text-secondary)">${esc(item.description.slice(0, 100))}${item.description.length > 100 ? '...' : ''}</div>`;
      html += `</label></div>`;
    });
    
    html += `</div>`;
  }
  
  if(totalCount === 0){
    html = '<div style="text-align:center;color:var(--text-secondary);padding:20px">æœªæå–åˆ°ä»»ä½•è¨­å®š</div>';
  }
  
  html += '</div>';
  
  document.getElementById('confirm-title').textContent = `ğŸ¤– AI æå–çµæœ (${totalCount} é …)`;
  document.getElementById('confirm-content').innerHTML = html;
  document.getElementById('confirm-content').style.whiteSpace = 'normal';
  document.getElementById('confirm-btn').textContent = 'ä¿å­˜é¸ä¸­é …';
  document.getElementById('confirm-btn').style.display = '';
  confirmCb = saveExtractedLore;
  showModal('confirm-modal');
}

async function saveExtractedLore(){
  const checkboxes = document.querySelectorAll('#confirm-content input[type="checkbox"]:checked');
  let savedCount = 0;
  
  for(const cb of checkboxes){
    const entry = {
      id: crypto.randomUUID(),
      storyId: story.id,
      name: cb.dataset.name,
      category: cb.dataset.category,
      description: cb.dataset.desc,
      content: '',
      isSelected: false,
      createdAt: Date.now()
    };
    await db.loreEntries.put(entry);
    savedCount++;
  }
  
  toast(`å·²ä¿å­˜ ${savedCount} æ¢è¨­å®š`, 'success');
  closeModal('confirm-modal');
  renderLore();
}

// æœç´¢åŠŸèƒ½
async function initContentSearch(){
  const c=document.getElementById('search-results');
  const input=document.getElementById('content-search');
  
  // æ¸…ç©ºæœç´¢æ¡†
  if(input) input.value='';
  
  // æª¢æŸ¥æ˜¯å¦æœ‰æ•…äº‹
  if(!story){
    c.innerHTML='<div class="empty"><div class="empty-icon">ğŸ“š</div><div class="empty-title">è«‹å…ˆé¸æ“‡æ•…äº‹</div><div class="empty-desc">è¿”å›æ•…äº‹åˆ—è¡¨é¸æ“‡ä¸€å€‹æ•…äº‹å¾Œå†æœç´¢</div></div>';
    return;
  }
  
  // ç›´æ¥å¾æ•¸æ“šåº«ç²å–æ¶ˆæ¯æ•¸é‡
  const msgCount = await db.messages.where('[storyId+branchId]').equals([story.id, story.currentBranchId]).count();
  
  if(!msgCount){
    c.innerHTML=`<div class="empty"><div class="empty-icon">âœ¨</div><div class="empty-title">${T('æ•…äº‹å…§å®¹ç‚ºç©º')}</div><div class="empty-desc">${T('é–‹å§‹è¬›è¿°æ•…äº‹å¾Œæ‰èƒ½æœç´¢å…§å®¹')}</div></div>`;
    return;
  }
  
  c.innerHTML=`<div class="empty"><div class="empty-icon">ğŸ”</div><div class="empty-title">${T('è¼¸å…¥é—œéµè©æœç´¢')}</div><div class="empty-desc">${T('å…±æœ‰')} ${msgCount} ${T('æ¢æ¶ˆæ¯å¯æœç´¢')}</div></div>`;
}

async function doContentSearch(){
  const keyword=document.getElementById('content-search').value.trim().toLowerCase();
  const c=document.getElementById('search-results');
  
  // æª¢æŸ¥æ˜¯å¦æœ‰æ•…äº‹
  if(!story){
    c.innerHTML=`<div class="empty"><div class="empty-icon">ğŸ“š</div><div class="empty-title">${T('è«‹å…ˆé¸æ“‡æ•…äº‹')}</div><div class="empty-desc">${T('è¿”å›æ•…äº‹åˆ—è¡¨é¸æ“‡ä¸€å€‹æ•…äº‹å¾Œå†æœç´¢')}</div></div>`;
    return;
  }
  
  // ç›´æ¥å¾æ•¸æ“šåº«è®€å–æ‰€æœ‰æ¶ˆæ¯ï¼ˆä¸ä¾è³´å…¨å±€è®Šé‡ï¼‰
  const allMsgs = await db.messages.where('[storyId+branchId]').equals([story.id, story.currentBranchId]).sortBy('createdAt');
  
  if(!allMsgs||!allMsgs.length){
    c.innerHTML=`<div class="empty"><div class="empty-icon">âœ¨</div><div class="empty-title">${T('æ•…äº‹å…§å®¹ç‚ºç©º')}</div><div class="empty-desc">${T('é–‹å§‹è¬›è¿°æ•…äº‹å¾Œæ‰èƒ½æœç´¢å…§å®¹')}</div></div>`;
    return;
  }
  
  if(!keyword){
    c.innerHTML=`<div class="empty"><div class="empty-icon">ğŸ”</div><div class="empty-title">${T('è¼¸å…¥é—œéµè©æœç´¢')}</div><div class="empty-desc">${T('å…±æœ‰')} ${allMsgs.length} ${T('æ¢æ¶ˆæ¯å¯æœç´¢')}</div></div>`;
    return;
  }
  
  // ä½¿ç”¨ includes é€²è¡Œæœç´¢
  const msgResults=allMsgs.filter(m=>{
    if(!m.content)return false;
    return m.content.toLowerCase().includes(keyword);
  });
  
  // v22: åŒæ™‚æœç´¢æ‘˜è¦
  const summaries = story.summaries || [];
  const rollingSummaries = story.rollingSummaries || [];
  const summaryResults = [];
  summaries.forEach((s, i) => {
    if(s.content && s.content.toLowerCase().includes(keyword)){
      summaryResults.push({...s, type: 'å£“ç¸®æ‘˜è¦', idx: i});
    }
  });
  rollingSummaries.forEach((s, i) => {
    if(s.content && s.content.toLowerCase().includes(keyword)){
      summaryResults.push({...s, type: 'æ»¾å‹•æ‘˜è¦', idx: i});
    }
  });
  
  if(!msgResults.length && !summaryResults.length){
    c.innerHTML=`<div class="empty"><div class="empty-icon">ğŸ”</div><div class="empty-title">æœªæ‰¾åˆ°åŒ¹é…å…§å®¹</div><div class="empty-desc">å˜—è©¦æœç´¢å…¶ä»–é—œéµè©<br><span style="font-size:11px;color:var(--text-tertiary)">ï¼ˆ${allMsgs.length} æ¢æ¶ˆæ¯ä¸­æœç´¢ï¼‰</span></div></div>`;
    return;
  }
  
  // é¡¯ç¤ºçµæœ
  let html = `<div style="padding:8px;color:var(--text-secondary);font-size:13px">æ‰¾åˆ° ${msgResults.length} æ¢æ¶ˆæ¯`;
  if(summaryResults.length > 0) html += ` + ${summaryResults.length} æ¢æ‘˜è¦`;
  html += '</div>';
  
  // é¡¯ç¤ºæ‘˜è¦çµæœï¼ˆå¦‚æœæœ‰ï¼‰
  if(summaryResults.length > 0){
    html += '<div style="padding:4px 8px;font-size:12px;color:var(--primary);font-weight:600">ğŸ“š æ‘˜è¦ä¸­çš„åŒ¹é…</div>';
    html += summaryResults.map(s => {
      const content = s.content || '';
      const lowerContent = content.toLowerCase();
      const idx = lowerContent.indexOf(keyword);
      const start = Math.max(0, idx - 40);
      const end = Math.min(content.length, idx + keyword.length + 60);
      let preview = content.slice(start, end);
      if(start > 0) preview = '...' + preview;
      if(end < content.length) preview = preview + '...';
      const regex = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      const highlighted = esc(preview).replace(regex, '<mark style="background:var(--warning);color:black;padding:0 2px">$1</mark>');
      return `<div class="card"><div class="card-cover" style="background:var(--info)">ğŸ“š</div><div class="card-info"><div class="card-header"><div class="card-title">${s.type} #${s.idx+1}</div><div class="card-time">${fmtDate(s.createdAt)}</div></div><div class="card-preview">${highlighted}</div></div></div>`;
    }).join('');
  }
  
  // é¡¯ç¤ºæ¶ˆæ¯çµæœ
  if(msgResults.length > 0){
    if(summaryResults.length > 0) html += '<div style="padding:4px 8px;font-size:12px;color:var(--primary);font-weight:600;margin-top:8px">ğŸ’¬ æ¶ˆæ¯ä¸­çš„åŒ¹é…</div>';
    html += msgResults.map(m=>{
      const preview=m.content.slice(0,150);
      const keywordLower = keyword.toLowerCase();
      const previewLower = preview.toLowerCase();
      const idx = previewLower.indexOf(keywordLower);
      let highlighted = esc(preview);
      if(idx >= 0){
        const before = esc(preview.slice(0, idx));
        const match = esc(preview.slice(idx, idx + keyword.length));
        const after = esc(preview.slice(idx + keyword.length));
        highlighted = `${before}<mark style="background:var(--warning);color:black;padding:0 2px;border-radius:2px">${match}</mark>${after}`;
      }
      return `<div class="card" onclick="jumpToMessage('${m.id}')">
        <div class="card-cover" style="background:${m.role==='user'?'var(--primary)':'var(--bg-tertiary)'}">${m.role==='user'?'ğŸ‘¤':'ğŸ¤–'}</div>
        <div class="card-info">
          <div class="card-header"><div class="card-title">${m.role==='user'?'ç”¨æˆ¶':'AI'}</div><div class="card-time">${fmtDate(m.createdAt)}</div></div>
          <div class="card-preview">${highlighted}...</div>
        </div>
      </div>`;
    }).join('');
  }
  
  c.innerHTML = html;
}
function showAdvancedSearch(){
  document.getElementById('adv-search-keyword').value=document.getElementById('content-search').value;
  showModal('advanced-search-modal');
}
function doAdvancedSearch(){
  const keyword=document.getElementById('adv-search-keyword').value.trim();
  const scope=document.getElementById('adv-search-scope').value;
  const caseSensitive=document.getElementById('adv-search-case').checked;
  if(!keyword){toast(T('è«‹è¼¸å…¥é—œéµè©'),'warning');return;}
  
  closeModal('advanced-search-modal');
  const c=document.getElementById('search-results');
  
  if(!story||!msgs||!msgs.length){
    c.innerHTML='<div class="empty"><div class="empty-icon">ğŸ“š</div><div class="empty-title">æ²’æœ‰å¯æœç´¢çš„å…§å®¹</div></div>';
    return;
  }
  
  let filtered=msgs;
  if(scope==='user')filtered=msgs.filter(m=>m.role==='user');
  else if(scope==='ai')filtered=msgs.filter(m=>m.role==='assistant');
  
  const results=filtered.filter(m=>{
    if(!m.content)return false;
    const content=caseSensitive?m.content:m.content.toLowerCase();
    const search=caseSensitive?keyword:keyword.toLowerCase();
    return content.includes(search);
  });
  
  if(!results.length){
    c.innerHTML='<div class="empty"><div class="empty-icon">ğŸ”</div><div class="empty-title">æœªæ‰¾åˆ°åŒ¹é…å…§å®¹</div></div>';
    return;
  }
  
  c.innerHTML=`<div style="padding:8px;color:var(--text-secondary);font-size:13px">æ‰¾åˆ° ${results.length} æ¢çµæœ</div>`+results.map(m=>{
    const preview=m.content.slice(0,150);
    return `<div class="card" onclick="jumpToMessage('${m.id}')">
      <div class="card-cover" style="background:${m.role==='user'?'var(--primary)':'var(--bg-tertiary)'}">${m.role==='user'?'ğŸ‘¤':'ğŸ¤–'}</div>
      <div class="card-info">
        <div class="card-header"><div class="card-title">${m.role==='user'?'ç”¨æˆ¶':'AI'}</div><div class="card-time">${fmtDate(m.createdAt)}</div></div>
        <div class="card-preview">${esc(preview)}...</div>
      </div>
    </div>`;
  }).join('');
}
function jumpToMessage(msgId){
  goBack();
  setTimeout(()=>{
    const el=document.querySelector(`.msg[data-id="${msgId}"]`);
    if(el){el.scrollIntoView({behavior:'smooth',block:'center'});el.style.animation='highlight 1s';}
  },300);
}

// æ™‚é–“è»¸
async function renderTimeline(){
  if(!story)return;
  const c=document.getElementById('timeline-content');
  const tl=await db.timeline.where('storyId').equals(story.id).sortBy('order');
  let html=`<div class="timeline-current"><span>ğŸ“…</span><span class="timeline-label">ç•¶å‰æ™‚é–“ï¼š</span><span class="timeline-value">${esc(story.storyTime||'æœªè¨­å®š')}</span></div>`;
  if(!tl.length)html+='<div class="empty" style="padding:40px 20px"><div class="empty-icon">ğŸ“…</div><div class="empty-title">æ™‚é–“è»¸ç‚ºç©º</div></div>';
  else{
    html+='<div class="timeline-list">';
    tl.forEach(t=>{
      const cur=t.timeLabel===story.storyTime;
      const evts=(t.events||[]).map(e=>`<div class="timeline-event"><div class="timeline-event-dot"></div><span>${esc(e)}</span></div>`).join('');
      html+=`<div class="timeline-item ${cur?'current':''}"><div class="timeline-date">${esc(t.timeLabel)} ${cur?'â† ç•¶å‰':''}</div><div class="timeline-events">${evts}</div></div>`;
    });
    html+='</div>';
  }
  html+='<button class="action-btn primary" style="width:100%;margin-top:16px" onclick="addTimeline()">â• æ·»åŠ æ™‚é–“é»</button>';
  c.innerHTML=html;
}

// æ™‚é–“è»¸åŠŸèƒ½
function addTimeline(){
  if(!story){toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'),'warning');return;}
  document.getElementById('timeline-label').value='';
  document.getElementById('timeline-event').value='';
  document.getElementById('timeline-set-current').checked=true;
  showModal('timeline-modal');
}
async function saveTimeline(){
  const label=document.getElementById('timeline-label').value.trim();
  const event=document.getElementById('timeline-event').value.trim();
  const setCurrent=document.getElementById('timeline-set-current').checked;
  if(!label){toast(T('è«‹è¼¸å…¥æ™‚é–“æ¨™è¨˜'),'warning');return;}
  
  // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ™‚é–“é»
  const existing=await db.timeline.where('storyId').equals(story.id).filter(t=>t.timeLabel===label).first();
  if(existing){
    // æ·»åŠ äº‹ä»¶åˆ°ç¾æœ‰æ™‚é–“é»
    const events=existing.events||[];
    if(event)events.push(event);
    await db.timeline.update(existing.id,{events});
  }else{
    // å‰µå»ºæ–°æ™‚é–“é»
    const count=await db.timeline.where('storyId').equals(story.id).count();
    const tl={
      id:crypto.randomUUID(),
      storyId:story.id,
      timeLabel:label,
      events:event?[event]:[],
      order:count,
      messageId:msgs[msgs.length-1]?.id,
      createdAt:Date.now()
    };
    await db.timeline.add(tl);
  }
  
  // è¨­ç‚ºç•¶å‰æ™‚é–“
  if(setCurrent){
    story.storyTime=label;
    await db.stories.update(story.id,{storyTime:label});
  }
  
  closeModal('timeline-modal');
  toast(T('æ™‚é–“é»å·²æ·»åŠ '),'success');
  renderTimeline();
}

async function timeJump(){
  if(!story){toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'),'warning');return;}
  showInputDialog('æ™‚é–“è·³èº','è¼¸å…¥è¦è·³è½‰åˆ°çš„æ™‚é–“ï¼ˆä¾‹å¦‚ï¼šä¸‰å¤©å¾Œã€ä¸€æœˆåæ—¥ï¼‰',async(input)=>{
    if(!input)return;
    showLoading('æ­£åœ¨è®“ AI è™•ç†æ™‚é–“è·³èº...');
    try{
      const prompt=`æ•…äº‹æ™‚é–“å¾ã€Œ${story.storyTime||'æœªçŸ¥'}ã€è·³èºåˆ°ã€Œ${input}ã€ã€‚
è«‹ç°¡çŸ­æè¿°é€™æ®µæ™‚é–“å…§å¯èƒ½ç™¼ç”Ÿçš„äº‹æƒ…ï¼ˆ2-3å¥è©±ï¼‰ï¼Œä»¥åŠç•¶å‰çš„å ´æ™¯ç‹€æ³ã€‚
ä¿æŒèˆ‡æ•…äº‹é¢¨æ ¼ä¸€è‡´ã€‚`;
      const resp=await callApi(prompt);
      hideLoading();
      
      // æ›´æ–°æ•…äº‹æ™‚é–“
      story.storyTime=input;
      await db.stories.update(story.id,{storyTime:input});
      
      // æ·»åŠ åˆ°æ™‚é–“è»¸
      const count=await db.timeline.where('storyId').equals(story.id).count();
      await db.timeline.add({
        id:crypto.randomUUID(),
        storyId:story.id,
        timeLabel:input,
        events:['æ™‚é–“è·³èº'],
        order:count,
        createdAt:Date.now()
      });
      
      // æ·»åŠ  AI ç”Ÿæˆçš„å…§å®¹ä½œç‚ºæ¶ˆæ¯
      const aiMsg={id:crypto.randomUUID(),storyId:story.id,branchId:story.currentBranchId,role:'assistant',content:`â”€â”€â”€â”€â”€ ${input} â”€â”€â”€â”€â”€\n\n${resp.content}`,tokens:resp.tokens,createdAt:Date.now()};
      await db.messages.add(aiMsg);
      msgs.push(aiMsg);
      renderMsgs();
      
      toast(T('æ™‚é–“è·³èºå®Œæˆ'),'success');
      renderTimeline();
    }catch(e){
      hideLoading();
      toast('æ™‚é–“è·³èºå¤±æ•—: '+e.message,'error');
    }
  });
}

// ä¼ç­†/äº‹ä»¶
let fTab='foreshadow';
async function renderForeshadow(){
  if(!story)return;
  const c=document.getElementById('foreshadow-content');
  if(fTab==='foreshadow'){
    const fs=await db.foreshadowing.where('storyId').equals(story.id).toArray();
    const unres=fs.filter(f=>!f.isResolved),res=fs.filter(f=>f.isResolved);
    let html='<div class="section-title"><span>ğŸ“Œ</span><span>æœªå›æ”¶çš„ä¼ç­†</span></div>';
    if(!unres.length)html+='<div style="text-align:center;padding:20px;color:var(--text-tertiary)">æš«ç„¡</div>';
    else unres.forEach(f=>{const w=f.mentionCount>30;html+=`<div class="f-card ${w?'warning':''}"><div class="f-card-header"><span class="f-card-icon">${w?'âš ï¸':'ğŸ’œ'}</span><span class="f-card-title">${esc(f.title)}</span></div><div class="f-card-desc">${esc(f.description)}</div><div class="f-card-meta"><span>ğŸ“ ${esc(f.timeLabel||'')}</span><span>å·²é ${f.mentionCount||0} æ¢å°è©±</span></div></div>`;});
    if(res.length){html+=`<div class="section-title" style="margin-top:20px"><span>âœ…</span><span>å·²å›æ”¶ (${res.length})</span></div>`;res.forEach(f=>{html+=`<div class="f-card resolved"><div class="f-card-header"><span class="f-card-icon">âœ“</span><span class="f-card-title">${esc(f.title)}</span></div><div class="f-card-desc">å·²å›æ”¶</div></div>`;});}
    c.innerHTML=html;
  }else{
    const evts=await db.events.where('storyId').equals(story.id).reverse().toArray();
    let html='<div class="section-title"><span>ğŸ“‹</span><span>é‡è¦äº‹ä»¶è¨˜éŒ„</span></div>';
    if(!evts.length)html+='<div style="text-align:center;padding:40px;color:var(--text-tertiary)">æš«ç„¡</div>';
    else evts.forEach(e=>{const icons={character_change:'ğŸ’€',relation_change:'ğŸ¤',plot_twist:'âš¡',other:'ğŸ“'};html+=`<div class="f-card"><div class="f-card-header"><span class="f-card-icon">${icons[e.eventType]||'ğŸ“'}</span><span class="f-card-title">${esc(e.title)}</span></div><div class="f-card-desc">${esc(e.description)}</div><div class="f-card-meta"><span>ğŸ“ ${esc(e.storyTime||'')}</span></div></div>`;});
    c.innerHTML=html;
  }
}
function switchFTab(t,el){fTab=t;document.querySelectorAll('#view-foreshadow .tab-btn').forEach(b=>b.classList.remove('active'));el.classList.add('active');renderForeshadow();}

// æ·»åŠ ä¼ç­†æˆ–äº‹ä»¶
function addForeshadowOrEvent(){
  if(!story){toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'),'warning');return;}
  if(fTab==='foreshadow'){
    showInputDialog('æ·»åŠ ä¼ç­†','è¼¸å…¥ä¼ç­†æ¨™é¡Œ',async(title)=>{
      if(!title)return;
      showInputDialog('ä¼ç­†æè¿°','æè¿°é€™å€‹ä¼ç­†çš„å…§å®¹ï¼ˆå¯é¸ï¼‰',async(desc)=>{
        const f={id:crypto.randomUUID(),storyId:story.id,messageId:msgs[msgs.length-1]?.id,title,description:desc||'',isResolved:false,mentionCount:0,timeLabel:story.storyTime,createdAt:Date.now()};
        await db.foreshadowing.add(f);
        toast(T('ä¼ç­†å·²æ·»åŠ '),'success');
        renderForeshadow();
      });
    });
  }else{
    showInputDialog('æ·»åŠ äº‹ä»¶','è¼¸å…¥äº‹ä»¶æ¨™é¡Œ',async(title)=>{
      if(!title)return;
      showInputDialog('äº‹ä»¶æè¿°','æè¿°é€™å€‹äº‹ä»¶ï¼ˆå¯é¸ï¼‰',async(desc)=>{
        const e={id:crypto.randomUUID(),storyId:story.id,messageId:msgs[msgs.length-1]?.id,title,description:desc||'',eventType:'other',storyTime:story.storyTime,createdAt:Date.now()};
        await db.events.add(e);
        toast(T('äº‹ä»¶å·²æ·»åŠ '),'success');
        renderForeshadow();
      });
    });
  }
}

// AI åˆ†æä¼ç­†
async function aiAnalyzeForeshadow(){
  if(!story){toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'),'warning');return;}
  showLoading('AI åˆ†æä¸­...');
  try{
    const fs=await db.foreshadowing.where('storyId').equals(story.id).filter(f=>!f.isResolved).toArray();
    const prompt=`è«‹åˆ†æä»¥ä¸‹æ•…äº‹ä¸­çš„ä¼ç­†ï¼Œåˆ¤æ–·å“ªäº›å¯èƒ½éœ€è¦å›æ”¶ï¼Œä¸¦çµ¦å‡ºå›æ”¶å»ºè­°ï¼š

ç•¶å‰ä¼ç­†ï¼š
${fs.map(f=>`- ${f.title}ï¼š${f.description||'ç„¡æè¿°'}ï¼ˆå·²é${f.mentionCount||0}æ¢å°è©±ï¼‰`).join('\n')}

æœ€è¿‘çš„æ•…äº‹å…§å®¹ï¼š
${msgs.slice(-10).map(m=>m.content.slice(0,200)).join('\n\n')}

è«‹æŒ‡å‡ºï¼š
1. å“ªäº›ä¼ç­†å¯èƒ½è¢«éºå¿˜äº†éœ€è¦å„˜å¿«å›æ”¶
2. å“ªäº›ä¼ç­†èˆ‡ç•¶å‰åŠ‡æƒ…ç›¸é—œå¯ä»¥è‡ªç„¶å›æ”¶
3. å¦‚ä½•å„ªé›…åœ°å›æ”¶é€™äº›ä¼ç­†`;
    const resp=await callApi(prompt);
    hideLoading();
    showAlert('AI ä¼ç­†åˆ†æ',resp.content);
  }catch(e){
    hideLoading();
    toast('åˆ†æå¤±æ•—: '+e.message,'error');
  }
}

// é¡¯ç¤ºè­¦å‘Š/ä¿¡æ¯å½ˆçª—
function showAlert(title,content){
  showConfirm(content,null,false,title);
}

// å­˜æª”
async function renderSaves(){
  if(!story)return;
  const c=document.getElementById('saves-content');
  const saves=await db.saves.where('storyId').equals(story.id).reverse().toArray();
  const manual=saves.filter(s=>!s.isAuto),auto=saves.filter(s=>s.isAuto);
  let html=`<div class="section-title"><span>ğŸ’¾</span><span>æ‰‹å‹•å­˜æª” (${manual.length}/8)</span></div>`;
  if(!manual.length)html+='<div style="text-align:center;padding:20px;color:var(--text-tertiary)">æš«ç„¡</div>';
  else manual.forEach(s=>html+=renderSaveCard(s));
  html+=`<div class="section-title" style="margin-top:20px"><span>ğŸ”„</span><span>è‡ªå‹•å­˜æª” (${auto.length}/5)</span></div>`;
  if(!auto.length)html+='<div style="text-align:center;padding:20px;color:var(--text-tertiary)">æš«ç„¡</div>';
  else auto.forEach(s=>html+=renderSaveCard(s,true));
  c.innerHTML=html;
}
function renderSaveCard(s,isAuto=false){
  const t=timeAgo(s.createdAt),tagCls=s.labelColor==='#EF4444'?'be':s.labelColor==='#F59E0B'?'key':'';
  return `<div class="save-card"><div class="save-card-header"><div class="save-card-title">${isAuto?`è‡ªå‹• #${s.slotIndex}`:`å­˜æª” ${s.slotIndex}`}${s.label?`<span class="save-card-tag ${tagCls}">${esc(s.label)}</span>`:''}</div></div><div class="save-card-preview">${esc(s.preview||'')}</div><div class="save-card-meta"><span>ğŸ“ ${esc(s.storyTime||'')}</span><span>ğŸ• ${t}</span></div><div class="save-card-actions"><button class="action-btn primary" onclick="loadSave('${s.id}')">è®€å–</button>${isAuto?`<button class="action-btn secondary" onclick="toast(T('è½‰ç‚ºæ‰‹å‹•'))">è½‰ç‚ºæ‰‹å‹•</button>`:`<button class="action-btn secondary" onclick="toast(T('è¦†è“‹'))">è¦†è“‹</button>`}<button class="action-btn secondary" onclick="deleteSave('${s.id}')">ğŸ—‘ï¸</button></div></div>`;
}
async function createSave(){
  if(!story||!msgs.length){toast(T('æ²’æœ‰å¯ä¿å­˜çš„å…§å®¹'),'warning');return;}
  const existing=await db.saves.where('storyId').equals(story.id).filter(s=>!s.isAuto).toArray();
  if(existing.length>=8){toast(T('å­˜æª”æ§½ä½å·²æ»¿'),'warning');return;}
  const slot=existing.length+1,last=msgs[msgs.length-1];
  const save={id:crypto.randomUUID(),storyId:story.id,slotIndex:slot,isAuto:false,label:'',preview:last?.content?.slice(0,100)||'',storyTime:story.storyTime||'',branchId:story.currentBranchId,messageId:last?.id,createdAt:Date.now()};
  await db.saves.put(save);
  toast(T('å­˜æª”å‰µå»ºæˆåŠŸï¼'),'success');
  renderSaves();
}
async function loadSave(id){showConfirm('ç¢ºå®šè¦è®€å–æ­¤å­˜æª”å—ï¼Ÿç•¶å‰é€²åº¦å°‡ä¸Ÿå¤±ã€‚',async()=>{showLoading('è®€å–å­˜æª”...');try{const s=await db.saves.get(id);if(!s)throw new Error('å­˜æª”ä¸å­˜åœ¨');await db.stories.update(story.id,{currentBranchId:s.branchId,currentMessageId:s.messageId,storyTime:s.storyTime});await openStory(story.id);toast(T('å­˜æª”è®€å–æˆåŠŸï¼'),'success');}catch(e){toast('è®€å–å¤±æ•—: '+e.message,'error');}hideLoading();});}
async function deleteSave(id){showConfirm('ç¢ºå®šè¦åˆªé™¤æ­¤å­˜æª”å—ï¼Ÿ',async()=>{await db.saves.delete(id);toast(T('å­˜æª”å·²åˆªé™¤'),'success');renderSaves();});}

// æŒ‡ä»¤
async function renderInst(){
  const c=document.getElementById('inst-list');
  const list=await db.instructions.toArray();
  if(!list.length){c.innerHTML='<div class="empty"><div class="empty-icon">ğŸ“œ</div><div class="empty-title">é‚„æ²’æœ‰æŒ‡ä»¤</div><div class="empty-desc">å°å…¥ .md æˆ– .txt æ–‡ä»¶ä½œç‚ºè¨­å®šæŒ‡ä»¤</div><button class="empty-btn" onclick="importInst()">å°å…¥æŒ‡ä»¤</button></div>';return;}
  
  // ç²å–æ‰€æœ‰ç¶å®šé—œä¿‚å’Œæ•…äº‹åç¨±
  const allBindings = await db.storyInstructions.toArray();
  const allStories = await db.stories.toArray();
  const storyMap = Object.fromEntries(allStories.map(s=>[s.id, s.title]));
  
  // ç‚ºæ¯å€‹æŒ‡ä»¤æ‰¾åˆ°ç¶å®šçš„æ•…äº‹
  const enrichedList = list.map(inst => {
    const bindings = allBindings.filter(b => b.instructionId === inst.id);
    const boundStoryNames = bindings.map(b => storyMap[b.storyId]).filter(Boolean);
    return {
      ...inst,
      boundStoryNames: boundStoryNames.length ? boundStoryNames : null
    };
  });
  
  c.innerHTML=enrichedList.map(i=>`<div class="inst-card"><div class="inst-header"><div class="inst-icon">ğŸ“„</div><div class="inst-info"><div class="inst-name">${esc(i.name)}</div><div class="inst-meta">${fmtNum(i.content?.length||0)} å­—</div><div class="inst-binding">ç¶å®šï¼š${i.boundStoryNames ? i.boundStoryNames.map(n=>esc(n)).join(', ') : 'æœªç¶å®š'}</div></div></div>${i.content?`<div class="inst-preview">${esc(i.content.slice(0,100))}...</div>`:''}<div class="inst-actions"><button class="action-btn secondary" onclick="previewInst('${i.id}')">é è¦½</button><button class="action-btn secondary" onclick="editInst('${i.id}')">ç·¨è¼¯</button><button class="action-btn secondary" onclick="deleteInst('${i.id}')">ğŸ—‘ï¸</button></div></div>`).join('');
}

// é è¦½æŒ‡ä»¤
async function previewInst(id){
  const inst = await db.instructions.get(id);
  if(!inst) return;
  showConfirm(inst.content || 'ï¼ˆç©ºå…§å®¹ï¼‰', null, false, `ğŸ“„ ${inst.name}`);
}

// ç·¨è¼¯æŒ‡ä»¤
let editInstId = null;
async function editInst(id){
  const inst = await db.instructions.get(id);
  if(!inst) return;
  editInstId = id;
  document.getElementById('edit-inst-name').value = inst.name;
  document.getElementById('edit-inst-content').value = inst.content || '';
  showModal('edit-inst-modal');
}

async function saveEditInst(){
  if(!editInstId) return;
  const name = document.getElementById('edit-inst-name').value.trim();
  const content = document.getElementById('edit-inst-content').value;
  if(!name){toast(T('è«‹è¼¸å…¥åç¨±'),'warning');return;}
  await db.instructions.update(editInstId, { name, content });
  closeModal('edit-inst-modal');
  toast(T('æŒ‡ä»¤å·²æ›´æ–°'),'success');
  renderInst();
  editInstId = null;
}
function importInst(){
  const input=document.getElementById('file-input');
  input.onchange=async e=>{
    const f=e.target.files[0];if(!f)return;
    const content=await f.text();
    const inst={id:crypto.randomUUID(),name:f.name,content,createdAt:Date.now()};
    await db.instructions.put(inst);
    toast(T('æŒ‡ä»¤å°å…¥æˆåŠŸï¼'),'success');
    renderInst();
    input.value='';
  };
  input.click();
}
async function deleteInst(id){showConfirm('ç¢ºå®šè¦åˆªé™¤æ­¤æŒ‡ä»¤å—ï¼Ÿ',async()=>{await db.instructions.delete(id);await db.storyInstructions.where('instructionId').equals(id).delete();toast(T('æŒ‡ä»¤å·²åˆªé™¤'),'success');renderInst();});}

// APIé è¨­
async function renderApi(){
  const c=document.getElementById('api-list');if(!c)return;
  const list=await db.apiPresets.toArray();
  if(!list.length){c.innerHTML='<div class="empty"><div class="empty-icon">ğŸ¤–</div><div class="empty-title">æœªé…ç½® API</div><div class="empty-desc">æ·»åŠ  Claude æˆ– OpenAI API ä¾†é–‹å§‹</div><button class="empty-btn" onclick="addApi()">æ·»åŠ  API</button></div>';return;}
  c.innerHTML=list.map(p=>`<div class="api-card ${p.isActive?'active':''}"><div class="api-header" onclick="selectApi('${p.id}')"><span class="api-name">${esc(p.name)}</span>${p.isActive?'<span class="api-badge">ä½¿ç”¨ä¸­</span>':''}</div><div class="api-info" onclick="selectApi('${p.id}')">${p.type==='anthropic'?'Anthropic':p.type==='openai'?'OpenAI':'è‡ªå®šç¾©'} Â· ${esc(p.model)}</div><div class="api-actions" style="display:flex;gap:8px;margin-top:10px"><button class="action-btn secondary" onclick="editApi('${p.id}')">âœï¸ ç·¨è¼¯</button><button class="action-btn secondary" onclick="deleteApi('${p.id}')" style="color:var(--error)">ğŸ—‘ï¸ åˆªé™¤</button></div></div>`).join('')+`<div style="text-align:center;margin-top:16px"><button class="action-btn primary" style="width:auto;padding:12px 24px" onclick="addApi()">â• æ·»åŠ æ–°é è¨­</button></div>`;
}
function addApi(){
  editApiId=null;
  document.getElementById('api-name').value='';
  document.getElementById('api-type').value='anthropic';
  document.getElementById('api-key').value='';
  document.getElementById('api-model').value='';
  document.getElementById('api-url').value='';
  // é‡ç½®è‡ªå‹•è£œå…¨å¾©é¸æ¡†ç‚ºé¸ä¸­ç‹€æ…‹
  const autoCompleteCheckbox = document.getElementById('api-url-autocomplete');
  if(autoCompleteCheckbox) autoCompleteCheckbox.checked = true;
  updateApiFields();
  showModal('api-modal');
}
async function editApi(id){
  const p=await db.apiPresets.get(id);
  if(!p)return;
  editApiId=id;
  document.getElementById('api-name').value=p.name||'';
  document.getElementById('api-type').value=p.type||'anthropic';
  document.getElementById('api-key').value=p.apiKey||'';
  document.getElementById('api-url').value=p.url||'';
  updateApiFields();
  document.getElementById('api-model').value=p.model||'';
  // åŠ è¼‰è‡ªå‹•è£œå…¨è¨­ç½®
  const autoCompleteCheckbox = document.getElementById('api-url-autocomplete');
  if(autoCompleteCheckbox) autoCompleteCheckbox.checked = p.urlAutoComplete !== false;
  showModal('api-modal');
}
async function deleteApi(id){
  showConfirm('ç¢ºå®šè¦åˆªé™¤æ­¤ API é è¨­å—ï¼Ÿ',async()=>{
    const p=await db.apiPresets.get(id);
    await db.apiPresets.delete(id);
    if(p&&p.isActive){
      const first=await db.apiPresets.toCollection().first();
      if(first)await db.apiPresets.update(first.id,{isActive:true});
    }
    toast(T('API é è¨­å·²åˆªé™¤'),'success');
    renderApi();
  });
}
function updateApiFields(){
  const t=document.getElementById('api-type').value,m=document.getElementById('api-model'),dl=document.getElementById('model-list'),u=document.getElementById('api-url-group');
  if(t==='anthropic'){
    dl.innerHTML='<option value="claude-sonnet-4-20250514">Claude Sonnet 4</option><option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option><option value="claude-3-opus-20240229">Claude 3 Opus</option><option value="claude-3-5-haiku-20241022">Claude 3.5 Haiku</option>';
    m.placeholder='é¸æ“‡æˆ–è¼¸å…¥æ¨¡å‹åç¨±';
    u.classList.add('hidden');
  }else if(t==='openai'){
    dl.innerHTML='<option value="gpt-4o">GPT-4o</option><option value="gpt-4o-mini">GPT-4o Mini</option><option value="gpt-4-turbo">GPT-4 Turbo</option><option value="gpt-3.5-turbo">GPT-3.5 Turbo</option><option value="o1">o1</option><option value="o1-mini">o1-mini</option>';
    m.placeholder='é¸æ“‡æˆ–è¼¸å…¥æ¨¡å‹åç¨±';
    u.classList.add('hidden');
  }else{
    dl.innerHTML='';
    m.placeholder='è¼¸å…¥æ¨¡å‹åç¨±';
    u.classList.remove('hidden');
  }
}
async function saveApi(){
  const name=document.getElementById('api-name').value.trim(),type=document.getElementById('api-type').value,apiKey=document.getElementById('api-key').value.trim(),model=document.getElementById('api-model').value.trim(),url=document.getElementById('api-url').value.trim();
  const urlAutoComplete = document.getElementById('api-url-autocomplete')?.checked ?? true;
  if(!name||!apiKey){toast(T('è«‹å¡«å¯«åç¨±å’Œ API Key'),'warning');return;}
  if(!model){toast(T('è«‹è¼¸å…¥æˆ–é¸æ“‡æ¨¡å‹'),'warning');return;}
  if(type==='custom'&&!url){toast(T('è«‹è¼¸å…¥ API URL'),'warning');return;}
  
  // å¦‚æœæ˜¯ç·¨è¼¯ï¼Œä¿ç•™åŸæœ¬çš„ isActive ç‹€æ…‹ï¼›å¦‚æœæ˜¯æ–°å»ºï¼Œè¨­ç‚º true ä¸¦å–æ¶ˆå…¶ä»–çš„æ¿€æ´»ç‹€æ…‹
  let isActive = true;
  if(editApiId){
    const existing = await db.apiPresets.get(editApiId);
    isActive = existing?.isActive || false;
  } else {
    // æ–°å»ºæ™‚ï¼Œå–æ¶ˆå…¶ä»– API çš„æ¿€æ´»ç‹€æ…‹ï¼Œè®“æ–°çš„æˆç‚ºæ¿€æ´»ç‹€æ…‹
    await db.apiPresets.toCollection().modify({isActive: false});
  }
  
  const p={id:editApiId||crypto.randomUUID(),name,type,apiKey,model,url:type==='custom'?url:'',urlAutoComplete,isActive,createdAt:Date.now()};
  await db.apiPresets.put(p);
  closeModal('api-modal');
  toast(T('API é è¨­å·²ä¿å­˜') + (isActive ? 'ï¼ˆå·²æ¿€æ´»ï¼‰' : ''), 'success');
  renderApi();
}
async function testApi(){
  const type=document.getElementById('api-type').value,apiKey=document.getElementById('api-key').value.trim(),model=document.getElementById('api-model').value.trim(),url=document.getElementById('api-url').value.trim();
  const resultEl=document.getElementById('api-test-result');
  resultEl.style.display='block';
  resultEl.style.color='var(--text-secondary)';
  resultEl.innerHTML='<span class="typing"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></span> æ¸¬è©¦é€£æ¥ä¸­...';
  if(!apiKey){resultEl.style.color='var(--error)';resultEl.textContent='âŒ è«‹å…ˆå¡«å¯« API Key';return;}
  if(!model){resultEl.style.color='var(--error)';resultEl.textContent='âŒ è«‹å…ˆå¡«å¯«æ¨¡å‹åç¨±';return;}
  
  // å‰µå»ºè¶…æ™‚æ§åˆ¶
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 30000);
  
  try{
    let r;
    // iOS å…¼å®¹æ€§ï¼šæ˜ç¢ºè¨­ç½® mode å’Œ credentials
    const fetchOptions = { 
      signal: controller.signal,
      method: 'POST',
      mode: 'cors',
      credentials: 'omit',
      cache: 'no-cache'
    };
    
    if(type==='anthropic'){
      r=await fetch('https://api.anthropic.com/v1/messages',{
        ...fetchOptions,
        headers:{
          'Content-Type':'application/json',
          'x-api-key':apiKey,
          'anthropic-version':'2023-06-01',
          'anthropic-dangerous-direct-browser-access':'true'
        },
        body:JSON.stringify({model:model,max_tokens:10,messages:[{role:'user',content:'Hi'}]})
      });
    }else if(type==='openai'){
      r=await fetch('https://api.openai.com/v1/chat/completions',{
        ...fetchOptions,
        headers:{
          'Content-Type':'application/json',
          'Authorization':`Bearer ${apiKey}`
        },
        body:JSON.stringify({model:model,messages:[{role:'user',content:'Hi'}],max_tokens:10})
      });
    }else{
      if(!url){resultEl.style.color='var(--error)';resultEl.textContent='âŒ è«‹å…ˆå¡«å¯« API URL';return;}
      const autoComplete = document.getElementById('api-url-autocomplete')?.checked ?? true;
      const apiUrl = normalizeApiUrl(url, autoComplete);
      console.log('Testing Custom API:', url, 'â†’', apiUrl, '(autoComplete:', autoComplete, ')');
      r=await fetch(apiUrl,{
        ...fetchOptions,
        headers:{
          'Content-Type':'application/json',
          'Authorization':`Bearer ${apiKey}`
        },
        body:JSON.stringify({model:model,messages:[{role:'user',content:'Hi'}],max_tokens:10})
      });
    }
    clearTimeout(timeoutId);
    const text = await r.text();
    console.log('Test API response:', r.status, text.slice(0, 500));
    if(r.ok){
      try {
        const d = JSON.parse(text);
        const hasValidStructure = d.choices?.[0]?.message !== undefined || d.content?.[0] !== undefined;
        if(hasValidStructure) {
          resultEl.style.color='var(--success)';
          resultEl.textContent='âœ… é€£æ¥æˆåŠŸï¼API å¯æ­£å¸¸ä½¿ç”¨';
        } else {
          resultEl.style.color='var(--warning)';
          resultEl.textContent='âš ï¸ é€£æ¥æˆåŠŸä½†è¿”å›æ ¼å¼ç•°å¸¸';
        }
      } catch(e) {
        resultEl.style.color='var(--error)';
        resultEl.textContent='âŒ è¿”å›éJSON: ' + text.slice(0, 50);
      }
    }else{
      try {
        const e = JSON.parse(text);
        resultEl.style.color='var(--error)';
        resultEl.textContent='âŒ ' + (e.error?.message || `HTTP ${r.status}`);
      } catch(e) {
        resultEl.style.color='var(--error)';
        resultEl.textContent='âŒ HTTP ' + r.status + ': ' + text.slice(0, 50);
      }
    }
  }catch(e){
    clearTimeout(timeoutId);
    resultEl.style.color='var(--error)';
    console.error('Test API error:', e);
    const errMsg = e.message || e.toString() || 'æœªçŸ¥éŒ¯èª¤';
    if(e.name === 'AbortError') {
      resultEl.innerHTML='âŒ é€£æ¥è¶…æ™‚ï¼ˆ30ç§’ï¼‰<br><span style="font-size:11px;color:var(--text-tertiary)">è«‹æª¢æŸ¥ç¶²çµ¡æˆ– URL æ˜¯å¦æ­£ç¢º</span>';
    } else if(errMsg.includes('Load failed') || errMsg.includes('Failed to fetch') || errMsg.includes('NetworkError') || e.name === 'TypeError') {
      // æª¢æ¸¬æ˜¯å¦ç‚º iOS
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      let hint = 'ç€è¦½å™¨å®‰å…¨ç­–ç•¥é˜»æ­¢äº†è«‹æ±‚ã€‚';
      if(isIOS) {
        hint += '<br>iOS è¨­å‚™å¯èƒ½éœ€è¦ï¼š<br>â€¢ æª¢æŸ¥ Safari è¨­ç½®ä¸­çš„ã€Œé˜»æ­¢è·¨ç¶²ç«™è¿½è¹¤ã€<br>â€¢ å˜—è©¦é—œé–‰ã€Œéš±ç§ç€è¦½ã€æ¨¡å¼';
      }
      hint += '<br>â€¢ ç¢ºèª API æœå‹™å·²é–‹å•Ÿ CORS æ”¯æŒ';
      resultEl.innerHTML='âŒ é€£æ¥å¤±æ•—<br><span style="font-size:11px;color:var(--text-tertiary)">' + hint + '</span>';
    } else {
      resultEl.innerHTML='âŒ é€£æ¥å¤±æ•—: ' + errMsg;
    }
  }
}
async function selectApi(id){await db.apiPresets.toCollection().modify({isActive:false});await db.apiPresets.update(id,{isActive:true});toast(T('å·²åˆ‡æ› API'),'success');renderApi();}

// æ²‰æµ¸æ¨¡å¼
let immIdx=0,immPars=[];
function enterImm(){
  if(!msgs.length){toast(T('æ²’æœ‰å…§å®¹'),'warning');return;}
  closeAll();
  immPars=msgs.filter(m=>m.role==='assistant').map(m=>m.content);
  immIdx=0;
  document.getElementById('immersive').classList.add('active');
  showImm();
}
function showImm(){const c=document.getElementById('immersive-content');if(immIdx<immPars.length){c.innerHTML=marked.parse(immPars[immIdx]);document.getElementById('imm-progress').style.width=((immIdx+1)/immPars.length*100)+'%';}}
function nextImm(){immIdx++;if(immIdx>=immPars.length){exitImm();return;}showImm();}
function exitImm(){document.getElementById('immersive').classList.remove('active');}

// é¢æ¿å’Œèœå–®
function showSheet(){
  document.getElementById('overlay').classList.add('active');
  const sheet=document.getElementById('sheet');
  // å…¨å±æ¨¡å¼ä¸‹ä¸é™åˆ¶å¯¬åº¦
  if(settings.screen==='fullscreen'){
    sheet.style.maxWidth='100%';
  }else{
    sheet.style.maxWidth='420px';
  }
  sheet.classList.add('active');
}
function showMore(e){
  e.stopPropagation();
  const m=document.getElementById('more-menu');
  m.style.top='100px';
  m.style.right='16px';
  // v19: æ ¹æ“šæ¨¡å¼é¡¯ç¤º/éš±è—ç¶“ç‡Ÿæ¨¡å¼é¸é …
  const isSimMode = story?.mode === 'simulation';
  m.querySelectorAll('.sim-only').forEach(el => {
    el.style.display = isSimMode ? '' : 'none';
  });
  m.classList.add('active');
}
function showMsgMenu(e,id){e.preventDefault();e.stopPropagation();selMsgId=id;const m=document.getElementById('msg-menu');m.style.top=Math.min(e.clientY,window.innerHeight-300)+'px';m.style.left=Math.min(e.clientX,window.innerWidth-180)+'px';m.classList.add('active');}

// ç‚¹å‡»å¼¹å‡ºæ¶ˆæ¯æ“ä½œèœå•
function showMsgActionMenu(e, msgId, msgType) {
  e.preventDefault();
  e.stopPropagation();
  
  // ç§»é™¤å·²å­˜åœ¨çš„èœå•
  const existingMenu = document.querySelector('.msg-action-menu');
  if (existingMenu) existingMenu.remove();
  
  selMsgId = msgId;
  
  // åˆ›å»ºèœå•
  const menu = document.createElement('div');
  menu.className = 'msg-action-menu';
  
  let menuHtml = '';
  if (msgType === 'user') {
    menuHtml = `
      <div class="msg-action-item" onclick="editMsgFromMenu()"><span class="icon">âœï¸</span>ç·¨è¼¯</div>
      <div class="msg-action-item danger" onclick="deleteMsgFromMenu()"><span class="icon">ğŸ—‘ï¸</span>åˆªé™¤</div>
    `;
  } else {
    menuHtml = `
      <div class="msg-action-item" onclick="regenMsgFromMenu()"><span class="icon">ğŸ”„</span>é‡æ–°ç”Ÿæˆ</div>
      <div class="msg-action-item" onclick="editMsgFromMenu()"><span class="icon">âœï¸</span>ç·¨è¼¯</div>
      <div class="msg-action-item" onclick="copyMsgFromMenu()"><span class="icon">ğŸ“‹</span>è¤‡è£½</div>
      <div class="msg-action-item danger" onclick="deleteMsgFromMenu()"><span class="icon">ğŸ—‘ï¸</span>åˆªé™¤</div>
    `;
  }
  menu.innerHTML = menuHtml;
  
  // å®šä½èœå•
  document.body.appendChild(menu);
  const rect = e.target.getBoundingClientRect();
  let top = rect.bottom + 4;
  let left = rect.left - 60;
  
  // é˜²æ­¢è¶…å‡ºå±å¹•
  if (top + 180 > window.innerHeight) top = rect.top - 180;
  if (left < 10) left = 10;
  if (left + 130 > window.innerWidth) left = window.innerWidth - 140;
  
  menu.style.top = top + 'px';
  menu.style.left = left + 'px';
  
  // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
  setTimeout(() => {
    document.addEventListener('click', closeMsgActionMenu, { once: true });
  }, 10);
}

function closeMsgActionMenu() {
  const menu = document.querySelector('.msg-action-menu');
  if (menu) menu.remove();
}

function editMsgFromMenu() {
  closeMsgActionMenu();
  editMsg();
}

function deleteMsgFromMenu() {
  closeMsgActionMenu();
  deleteMsg();
}

async function regenMsgFromMenu() {
  closeMsgActionMenu();
  if (!selMsgId || generating) return;
  
  // æ‰¾åˆ°è¿™æ¡AIæ¶ˆæ¯
  const msgIndex = msgs.findIndex(m => m.id === selMsgId);
  if (msgIndex < 0) return;
  
  const currentMsg = msgs[msgIndex];
  if (currentMsg.role !== 'assistant') {
    toast(T('åªèƒ½é‡æ–°ç”Ÿæˆ AI å›è¦†'), 'warning');
    return;
  }
  
  // åˆ é™¤å½“å‰AIæ¶ˆæ¯
  await db.messages.delete(selMsgId);
  msgs.splice(msgIndex, 1);
  renderMsgs();
  
  // é‡æ–°ç”Ÿæˆ
  generating = true;
  const sendBtn = document.getElementById('send-btn');
  sendBtn.disabled = true;
  
  toast(T('æ­£åœ¨é‡æ–°ç”Ÿæˆ...'), 'info');
  
  const useStreaming = settings.enableStreaming;
  // è·å–ä¸Šä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ä½œä¸ºä¸Šä¸‹æ–‡
  const lastUserMsg = msgs.filter(m => m.role === 'user').pop();
  const content = lastUserMsg?.content || 'ç¹¼çºŒ';
  
  if (useStreaming) {
    await sendWithStreaming(content, sendBtn);
  } else {
    showTyping();
    try {
      const resp = await callAI(content);
      hideTyping();
      const aiMsgId = crypto.randomUUID();
      const estimatedTokens = Math.round(resp.content.length / 2);
      const aiMsg = {id: aiMsgId, storyId: story.id, branchId: story.currentBranchId, role: 'assistant', content: resp.content, tokens: resp.tokens || estimatedTokens, storyTime: story.storyTime || '', createdAt: Date.now()};
      await db.messages.put(aiMsg);
      msgs.push(aiMsg);
      await db.stories.update(story.id, {updatedAt: Date.now(), preview: resp.content.slice(0, 100), currentMessageId: aiMsgId});
      renderMsgs();
      parsePlayerStatusFromAI(resp.content);
    } catch (e) {
      hideTyping();
      toast('é‡æ–°ç”Ÿæˆå¤±æ•—: ' + e.message, 'error');
    }
  }
  
  generating = false;
  sendBtn.disabled = false;
}

async function copyMsgFromMenu() {
  closeMsgActionMenu();
  if (!selMsgId) return;
  
  const msg = msgs.find(m => m.id === selMsgId);
  if (!msg) return;
  
  try {
    await navigator.clipboard.writeText(msg.content);
    toast(T('å·²è¤‡è£½åˆ°å‰ªè²¼æ¿'), 'success');
  } catch (e) {
    toast(T('è¤‡è£½å¤±æ•—'), 'error');
  }
}

function hideMenu(){document.querySelectorAll('.context-menu').forEach(m=>m.classList.remove('active'));closeMsgActionMenu();}

// æ•…äº‹èœå–®ç›¸é—œ
let menuStoryId = null;
function showStoryMenu(id) {
  menuStoryId = id;
  const m = document.getElementById('story-menu');
  m.style.top = '120px';
  m.style.left = '50%';
  m.style.transform = 'translateX(-50%)';
  m.classList.add('active');
}
function editStoryCover() {
  hideMenu();
  if (!menuStoryId) return;
  // è¨­ç½®ä¸Šå‚³ç›®æ¨™ç‚ºå¸¶æœ‰storyIdçš„å°è±¡ï¼Œé¿å…asyncå°è‡´çš„å®‰å…¨ç­–ç•¥å•é¡Œ
  imageUploadTarget = { type: 'storyCover', storyId: menuStoryId };
  document.getElementById('image-upload').click();
}
async function toggleStoryPin() {
  hideMenu();
  if (!menuStoryId) return;
  const s = await db.stories.get(menuStoryId);
  if (!s) return;
  await db.stories.update(menuStoryId, { isPinned: !s.isPinned });
  toast(s.isPinned ? 'å·²å–æ¶ˆç½®é ‚' : 'å·²ç½®é ‚', 'success');
  await renderStories();
}
async function deleteStoryFromMenu() {
  hideMenu();
  if (!menuStoryId) return;
  const s = await db.stories.get(menuStoryId);
  if (!s) return;
  showConfirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${s.title}ã€å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ï¼`, async () => {
    await db.stories.delete(menuStoryId);
    await db.messages.where('storyId').equals(menuStoryId).delete();
    await db.branches.where('storyId').equals(menuStoryId).delete();
    toast(T('æ•…äº‹å·²åˆªé™¤'), 'success');
    await renderStories();
  }, true);
}

function closeAll(){document.getElementById('overlay').classList.remove('active');document.getElementById('sheet').classList.remove('active');hideMenu();}
document.addEventListener('click',e=>{if(!e.target.closest('.context-menu')&&!e.target.closest('.nav-btn'))hideMenu();});

// Modal
function showModal(id){document.getElementById('overlay').classList.add('active');document.getElementById(id).classList.add('active');}
function closeModal(id){
  document.getElementById('overlay').classList.remove('active');
  document.getElementById(id).classList.remove('active');
  
  // ç‰¹æ®Šè™•ç†ï¼šè§’è‰²ç·¨è¼¯æ¨¡æ…‹æ¡†é—œé–‰æ™‚é‡ç½®ç‹€æ…‹
  if(id === 'char-add-modal'){
    const modal = document.getElementById('char-add-modal');
    if(modal){
      modal.querySelector('.modal-title').textContent = 'â• æ·»åŠ è§’è‰²';
      const confirmBtn = modal.querySelector('.modal-btn.confirm');
      if(confirmBtn) confirmBtn.onclick = saveCharacterManual;
    }
    currentCharacterId = null;
  }
}
// å–æ¶ˆå›èª¿è®Šé‡
let cancelCb = null;

function showConfirm(msg,cb,danger=false,title='ç¢ºèª',onCancel=null){
  document.getElementById('confirm-title').textContent=title;
  const contentEl = document.getElementById('confirm-content');
  contentEl.textContent=msg;
  contentEl.style.whiteSpace=title==='ç¢ºèª'?'normal':'pre-wrap';
  contentEl.style.maxHeight='50vh';
  contentEl.style.overflowY='auto';
  const b=document.getElementById('confirm-btn');
  const cancelBtn = document.querySelector('#confirm-modal .modal-btn.cancel');
  b.className=danger?'modal-btn danger':'modal-btn confirm';
  b.style.display=cb?'':'none';
  // ç•¶æ²’æœ‰ç¢ºèªå›èª¿æ™‚ï¼Œå°‡å–æ¶ˆæŒ‰éˆ•æ”¹ç‚º"é—œé–‰"
  cancelBtn.textContent = cb ? 'å–æ¶ˆ' : 'é—œé–‰';
  confirmCb=cb;
  cancelCb=onCancel;  // ä¿å­˜å–æ¶ˆå›èª¿
  showModal('confirm-modal');
}
function confirmAction(){closeModal('confirm-modal');if(confirmCb){confirmCb();confirmCb=null;}cancelCb=null;}
function cancelConfirm(){closeModal('confirm-modal');if(cancelCb){cancelCb();cancelCb=null;}confirmCb=null;}
function showInputDialog(title,ph,cb){document.getElementById('input-title').textContent=title;document.getElementById('modal-input').placeholder=ph;document.getElementById('modal-input').value='';inputCb=cb;showModal('input-modal');}
function confirmInput(){const v=document.getElementById('modal-input').value.trim();closeModal('input-modal');if(inputCb){inputCb(v);inputCb=null;}}

// æ¶ˆæ¯æ“ä½œ
async function markForeshadow(){hideMenu();showInputDialog('æ¨™è¨˜ä¼ç­†','è¼¸å…¥ä¼ç­†æ¨™é¡Œ',async t=>{if(!t)return;const f={id:crypto.randomUUID(),storyId:story.id,messageId:selMsgId,title:t,description:'',isResolved:false,mentionCount:0,createdAt:Date.now()};await db.foreshadowing.put(f);toast(T('ä¼ç­†å·²æ¨™è¨˜'),'success');});}
function copyMsg(){hideMenu();const m=msgs.find(x=>x.id===selMsgId);if(m){navigator.clipboard.writeText(m.content);toast(T('å·²è¤‡è£½'),'success');}}

// åˆªé™¤æ¶ˆæ¯
function deleteMsg(){
  hideMenu();
  showConfirm('ç¢ºå®šè¦åˆªé™¤é€™æ¢æ¶ˆæ¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤éŠ·ã€‚',async()=>{
    const idx=msgs.findIndex(m=>m.id===selMsgId);
    if(idx===-1)return;
    await db.messages.delete(selMsgId);
    msgs.splice(idx,1);
    const el=document.querySelector(`.msg[data-id="${selMsgId}"]`);
    if(el)el.remove();
    toast(T('æ¶ˆæ¯å·²åˆªé™¤'),'success');
  });
}

// ç·¨è¼¯æ¶ˆæ¯
function editMsg(){
  hideMenu();
  const m=msgs.find(x=>x.id===selMsgId);
  if(!m)return;
  document.getElementById('edit-msg-content').value=m.content;
  showModal('edit-msg-modal');
}
async function saveEditMsg(){
  const content=document.getElementById('edit-msg-content').value.trim();
  if(!content){toast(T('å…§å®¹ä¸èƒ½ç‚ºç©º'),'warning');return;}
  const m=msgs.find(x=>x.id===selMsgId);
  if(!m)return;
  m.content=content;
  await db.messages.update(selMsgId,{content});
  const el=document.querySelector(`.msg[data-id="${selMsgId}"]`);
  if(el)el.innerHTML=marked.parse(content);
  closeModal('edit-msg-modal');
  toast(T('æ¶ˆæ¯å·²æ›´æ–°'),'success');
}

// é‡æ–°ç”Ÿæˆ
function regenerateMsg(){
  hideMenu();
  const m=msgs.find(x=>x.id===selMsgId);
  if(!m||m.role!=='assistant'){toast(T('åªèƒ½é‡æ–°ç”Ÿæˆ AI æ¶ˆæ¯'),'warning');return;}
  document.getElementById('regen-note').value='';
  showModal('regen-modal');
}
async function doRegenerate(){
  closeModal('regen-modal');
  if(generating){toast(T('æ­£åœ¨ç”Ÿæˆä¸­'),'warning');return;}
  const note=document.getElementById('regen-note').value.trim();
  const idx=msgs.findIndex(m=>m.id===selMsgId);
  if(idx===-1)return;
  
  // æ‰¾åˆ°é€™æ¢æ¶ˆæ¯ä¹‹å‰çš„ç”¨æˆ¶æ¶ˆæ¯
  let userMsg='';
  for(let i=idx-1;i>=0;i--){
    if(msgs[i].role==='user'){userMsg=msgs[i].content;break;}
  }
  if(note)userMsg+='\n\n[è£œå……èªªæ˜ï¼š'+note+']';
  
  // åˆªé™¤ç•¶å‰æ¶ˆæ¯
  await db.messages.delete(selMsgId);
  msgs.splice(idx,1);
  const el=document.querySelector(`.msg[data-id="${selMsgId}"]`);
  if(el)el.remove();
  
  // é‡æ–°ç”Ÿæˆ
  generating=true;
  showTyping();
  try{
    const resp=await callApi(userMsg);
    hideTyping();
    const aiMsg={id:crypto.randomUUID(),storyId:story.id,branchId:story.currentBranchId,role:'assistant',content:resp.content,tokens:resp.tokens,createdAt:Date.now()};
    await db.messages.add(aiMsg);
    msgs.push(aiMsg);
    await typewriter(aiMsg);
    toast(T('é‡æ–°ç”Ÿæˆå®Œæˆ'),'success');
  }catch(e){
    hideTyping();
    toast('ç”Ÿæˆå¤±æ•—: '+e.message,'error');
  }
  generating=false;
}

// å›æº¯åˆ°æ­¤
function rollbackTo(){
  hideMenu();
  const idx=msgs.findIndex(m=>m.id===selMsgId);
  if(idx===-1)return;
  const deleteCount=msgs.length-idx-1;
  if(deleteCount===0){toast(T('å·²ç¶“æ˜¯æœ€æ–°æ¶ˆæ¯'),'info');return;}
  showConfirm(`ç¢ºå®šè¦å›æº¯åˆ°æ­¤æ¶ˆæ¯å—ï¼Ÿå°‡åˆªé™¤ä¹‹å¾Œçš„ ${deleteCount} æ¢æ¶ˆæ¯ã€‚`,async()=>{
    const toDelete=msgs.slice(idx+1).map(m=>m.id);
    await db.messages.bulkDelete(toDelete);
    msgs=msgs.slice(0,idx+1);
    renderMsgs();
    toast(T('å·²å›æº¯'),'success');
  });
}

// è¨˜æ†¶ç®¡ç†
async function showMemoryManager(){
  closeAll();
  if(!story){toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'),'warning');return;}
  
  // è¨ˆç®— Token ä¼°ç®—
  let totalChars = 0;
  msgs.forEach(m => totalChars += m.content.length);
  const estimatedTokens = Math.round(totalChars / 2); // ç²—ç•¥ä¼°ç®—ï¼šä¸­æ–‡ç´„ 2 å­—ç¬¦/token
  const tokenColor = estimatedTokens > 8000 ? 'var(--error)' : estimatedTokens > 4000 ? 'var(--warning)' : 'var(--success)';
  
  // è¨ˆç®—å—ä¿è­·æ¶ˆæ¯æ•¸
  const protectedMsgIds = new Set();
  const foreshadows = await db.foreshadowing.where('storyId').equals(story.id).toArray();
  const bookmarks = await db.bookmarks.where('storyId').equals(story.id).toArray();
  const plotTags = await db.plotTags.where('storyId').equals(story.id).toArray();
  foreshadows.forEach(f => protectedMsgIds.add(f.messageId));
  bookmarks.forEach(b => protectedMsgIds.add(b.messageId));
  plotTags.forEach(t => protectedMsgIds.add(t.messageId));
  
  // è¨ˆç®—æ»¾å‹•æ‘˜è¦æ•¸
  const rollingSummaries = (story.rollingSummaries || []).length;
  
  // æ›´æ–° UI
  document.getElementById('memory-msg-count').textContent = msgs.length;
  document.getElementById('memory-compressed').textContent = story.compressedCount || 0;
  document.getElementById('memory-summary-count').textContent = story.summaries?.length || 0;
  document.getElementById('memory-rolling-count').textContent = rollingSummaries;
  document.getElementById('memory-token-estimate').innerHTML = `â‰ˆ <span style="color:${tokenColor}">${fmtNum(estimatedTokens)}</span> tokens`;
  
  const protectedInfo = document.getElementById('memory-protected-info');
  if(protectedMsgIds.size > 0){
    protectedInfo.textContent = `âš ï¸ ${protectedMsgIds.size} æ¢é‡è¦æ¶ˆæ¯å—ä¿è­·ï¼ˆä¼ç­†/æ›¸ç±¤/æ¨™ç±¤ï¼‰`;
    protectedInfo.style.display = '';
  } else {
    protectedInfo.style.display = 'none';
  }
  
  // åˆå§‹åŒ–æ»¾å‹•æ‘˜è¦è¨­ç½®
  const rollingEnabled = story.rollingEnabled || false;
  const rollingInterval = story.rollingInterval || 30;
  document.getElementById('tog-rolling-summary').classList.toggle('active', rollingEnabled);
  document.getElementById('rolling-interval').value = rollingInterval;
  
  // åŠ è¼‰ç« ç¯€é¸é …
  await updateCompressOptions();
  
  // é‡ç½®é¸é …å¡
  switchMemTab('compress');
  
  showModal('memory-modal');
}

// åˆ‡æ›è¨˜æ†¶ç®¡ç†é¸é …å¡
function switchMemTab(tab){
  ['compress','rolling','analyze'].forEach(t => {
    document.getElementById('mem-tab-'+t).classList.toggle('secondary', t===tab);
    document.getElementById('mem-tab-'+t).style.background = t===tab ? '' : 'var(--bg-tertiary)';
    document.getElementById('mem-panel-'+t).style.display = t===tab ? '' : 'none';
  });
  // æ›´æ–°æŒ‰éˆ•æ–‡å­—
  const btn = document.getElementById('mem-compress-btn');
  if(tab === 'compress'){
    btn.textContent = 'ğŸ¤– æ™ºèƒ½å£“ç¸®';
    btn.onclick = compressMemory;
  } else if(tab === 'rolling'){
    btn.style.display = 'none';
  } else {
    btn.style.display = 'none';
  }
  if(tab === 'compress'){
    btn.style.display = '';
  }
}

// æ›´æ–°å£“ç¸®é¸é …
async function updateCompressOptions(){
  const mode = document.getElementById('compress-mode').value;
  document.getElementById('compress-count-group').style.display = mode === 'count' ? '' : 'none';
  document.getElementById('compress-chapter-group').style.display = mode === 'chapter' ? '' : 'none';
  
  if(mode === 'chapter' && story){
    const chapters = await db.chapters.where('storyId').equals(story.id).sortBy('order');
    const select = document.getElementById('compress-chapter');
    if(chapters.length === 0){
      select.innerHTML = '<option value="">æš«ç„¡ç« ç¯€ï¼Œè«‹å…ˆæ·»åŠ ç« ç¯€</option>';
    } else {
      select.innerHTML = chapters.map((ch, i) => 
        `<option value="${ch.messageId}">ç¬¬ ${i+1} ç« ï¼š${esc(ch.title)}</option>`
      ).join('');
    }
  }
}

// åˆ‡æ›æ»¾å‹•æ‘˜è¦
async function toggleRollingSummary(){
  if(!story) return;
  const toggle = document.getElementById('tog-rolling-summary');
  const enabled = !toggle.classList.contains('active');
  toggle.classList.toggle('active', enabled);
  
  const interval = parseInt(document.getElementById('rolling-interval').value) || 30;
  await db.stories.update(story.id, { rollingEnabled: enabled, rollingInterval: interval });
  story.rollingEnabled = enabled;
  story.rollingInterval = interval;
  
  toast(enabled ? 'å·²å•Ÿç”¨è‡ªå‹•æ»¾å‹•æ‘˜è¦' : 'å·²é—œé–‰è‡ªå‹•æ»¾å‹•æ‘˜è¦', 'success');
}

// è¨˜æ†¶å£“ç¸®è‡¨æ™‚æ•¸æ“š
let pendingCompressData = null;

async function compressMemory(){
  const mode = document.getElementById('compress-mode').value;
  let count = 0;
  let toCompress = [];
  
  // ç²å–å—ä¿è­·çš„æ¶ˆæ¯ ID
  const protectedMsgIds = new Set();
  const foreshadows = await db.foreshadowing.where('storyId').equals(story.id).toArray();
  const bookmarks = await db.bookmarks.where('storyId').equals(story.id).toArray();
  const plotTags = await db.plotTags.where('storyId').equals(story.id).toArray();
  foreshadows.forEach(f => protectedMsgIds.add(f.messageId));
  bookmarks.forEach(b => protectedMsgIds.add(b.messageId));
  plotTags.forEach(t => protectedMsgIds.add(t.messageId));
  
  if(mode === 'chapter'){
    // æŒ‰ç« ç¯€å£“ç¸®
    const chapterMsgId = document.getElementById('compress-chapter').value;
    if(!chapterMsgId){
      toast(T('è«‹é¸æ“‡ç« ç¯€'),'warning');
      return;
    }
    const chapterMsgIdx = msgs.findIndex(m => m.id === chapterMsgId);
    if(chapterMsgIdx <= 0){
      toast(T('è©²ç« ç¯€ä¹‹å‰æ²’æœ‰å¯å£“ç¸®çš„æ¶ˆæ¯'),'info');
      closeModal('memory-modal');
      return;
    }
    // å£“ç¸®ç« ç¯€ä¹‹å‰çš„æ¶ˆæ¯ï¼ˆæ’é™¤å—ä¿è­·çš„ï¼‰
    for(let i = 0; i < chapterMsgIdx; i++){
      if(!protectedMsgIds.has(msgs[i].id)){
        toCompress.push(msgs[i]);
      }
    }
    count = toCompress.length;
  } else {
    // æŒ‰æ•¸é‡å£“ç¸®
    const option = document.getElementById('compress-count').value;
    let targetCount = parseInt(option) || 10;
    if(option === 'all') targetCount = Math.max(0, msgs.length - 20);
    
    // å¾æœ€æ—©çš„æ¶ˆæ¯é–‹å§‹ï¼Œæ’é™¤å—ä¿è­·çš„
    for(let i = 0; i < msgs.length && toCompress.length < targetCount; i++){
      if(!protectedMsgIds.has(msgs[i].id)){
        toCompress.push(msgs[i]);
      }
    }
    count = toCompress.length;
  }
  
  if(count <= 0){
    toast(T('æ²’æœ‰å¯å£“ç¸®çš„æ¶ˆæ¯ï¼ˆé‡è¦æ¶ˆæ¯å·²å—ä¿è­·ï¼‰'),'info');
    closeModal('memory-modal');
    return;
  }
  
  // é¡¯ç¤ºç¢ºèª
  const skipped = (mode === 'chapter' ? msgs.slice(0, msgs.findIndex(m => m.id === document.getElementById('compress-chapter').value)).length : parseInt(document.getElementById('compress-count').value) || 10) - count;
  let confirmMsg = `å°‡å£“ç¸® ${count} æ¢æ¶ˆæ¯`;
  if(skipped > 0){
    confirmMsg += `ï¼ˆå·²è·³é ${skipped} æ¢å—ä¿è­·æ¶ˆæ¯ï¼‰`;
  }
  confirmMsg += '\n\nAI å°‡ç”Ÿæˆæ™ºèƒ½æ‘˜è¦ä¿ç•™é—œéµä¿¡æ¯ã€‚ç¢ºå®šç¹¼çºŒï¼Ÿ';
  
  // å…ˆé—œé–‰è¨˜æ†¶ç®¡ç†ç•Œé¢ï¼Œå†é¡¯ç¤ºç¢ºèªå°è©±æ¡†
  closeModal('memory-modal');
  
  showConfirm(confirmMsg, async () => {
    showLoading('AI æ­£åœ¨ç”Ÿæˆæ™ºèƒ½æ‘˜è¦...');
    try{
      // å£“ç¸®å‰ä¿å­˜è§’è‰²å¿«ç…§
      await saveCharacterSnapshot();
      
      // ä½¿ç”¨ AI ç”Ÿæˆæ™ºèƒ½æ‘˜è¦
      let summary;
      try {
        summary = await generateAISummary(toCompress);
      } catch(aiError) {
        console.warn('AI æ‘˜è¦ç”Ÿæˆå¤±æ•—ï¼Œä½¿ç”¨ç°¡å–®æ‘˜è¦:', aiError);
        summary = generateSimpleSummary(toCompress);
      }
      
      hideLoading();
      
      // ä¿å­˜å¾…å£“ç¸®æ•¸æ“šï¼Œé¡¯ç¤ºé è¦½è®“ç”¨æˆ¶ç·¨è¼¯
      pendingCompressData = {
        toCompress,
        count,
        summary
      };
      
      // é¡¯ç¤ºæ‘˜è¦é è¦½
      document.getElementById('summary-preview-content').value = summary;
      showModal('summary-preview-modal');
      
    }catch(e){
      hideLoading();
      toast('ç”Ÿæˆæ‘˜è¦å¤±æ•—: '+e.message,'error');
    }
  });
}

// å–æ¶ˆæ‘˜è¦é è¦½
function cancelSummaryPreview(){
  closeModal('summary-preview-modal');
  pendingCompressData = null;
  toast(T('å·²å–æ¶ˆå£“ç¸®'),'info');
}

// ç¢ºèªå£“ç¸®æ‘˜è¦
async function confirmSummaryCompress(){
  if(!pendingCompressData){
    toast(T('æ²’æœ‰å¾…å£“ç¸®çš„æ•¸æ“š'),'error');
    closeModal('summary-preview-modal');
    return;
  }
  
  const { toCompress, count } = pendingCompressData;
  const editedSummary = document.getElementById('summary-preview-content').value.trim();
  
  if(!editedSummary){
    toast(T('æ‘˜è¦å…§å®¹ä¸èƒ½ç‚ºç©º'),'warning');
    return;
  }
  
  showLoading('æ­£åœ¨å£“ç¸®æ¶ˆæ¯...');
  
  try{
    // åˆªé™¤èˆŠæ¶ˆæ¯
    const ids = toCompress.map(m => m.id);
    await db.messages.bulkDelete(ids);
    msgs = msgs.filter(m => !ids.includes(m.id));
    
    // ä¿å­˜æ‘˜è¦åˆ°æ•…äº‹
    const summaries = story.summaries || [];
    summaries.push({
      content: editedSummary,
      createdAt: Date.now(),
      count,
      isAI: true,
      type: 'compressed'
    });
    await db.stories.update(story.id, {summaries, compressedCount: (story.compressedCount||0)+count});
    story.summaries = summaries;
    story.compressedCount = (story.compressedCount||0)+count;
    
    renderMsgs();
    hideLoading();
    closeModal('summary-preview-modal');
    pendingCompressData = null;
    
    // é¡¯ç¤ºæˆåŠŸæç¤ºï¼Œå‘ŠçŸ¥ç”¨æˆ¶å¯ä»¥ç·¨è¼¯
    showConfirm(
      `âœ… å·²æˆåŠŸå£“ç¸® ${count} æ¢æ¶ˆæ¯ï¼\n\næ‘˜è¦å·²ä¿å­˜ã€‚å¦‚éœ€ä¿®æ”¹ï¼Œå¯å‰å¾€ã€Œè¨˜æ†¶ç®¡ç†ã€â†’ã€ŒğŸ“Š æŸ¥çœ‹ã€ç·¨è¼¯æ‘˜è¦å…§å®¹ã€‚`,
      null, false, 'å£“ç¸®å®Œæˆ'
    );
  }catch(e){
    hideLoading();
    toast('å£“ç¸®å¤±æ•—: '+e.message,'error');
  }
}

// v18: AI æ™ºèƒ½æ‘˜è¦ç”Ÿæˆ
async function generateAISummary(messages){
  const preset = await db.apiPresets.filter(p=>p.isActive).first();
  if(!preset || !preset.apiKey){
    throw new Error('æœªé…ç½® API');
  }
  
  // æ§‹å»ºè¦æ‘˜è¦çš„å…§å®¹
  const content = messages.map(m => {
    const role = m.role === 'user' ? 'ã€ç©å®¶è¡Œå‹•ã€‘' : 'ã€åŠ‡æƒ…ç™¼å±•ã€‘';
    return `${role}\n${m.content}`;
  }).join('\n\n---\n\n');
  
  // é™åˆ¶é•·åº¦é¿å…è¶…å‡º token
  const truncatedContent = content.slice(0, 15000);
  
  const summaryPrompt = `è«‹ç‚ºä»¥ä¸‹äº’å‹•å°èªªç‰‡æ®µç”Ÿæˆä¸€ä»½çµæ§‹åŒ–æ‘˜è¦ã€‚é€™ä»½æ‘˜è¦å°‡ç”¨æ–¼å¹«åŠ© AI åœ¨å¾ŒçºŒåŠ‡æƒ…ä¸­ä¿æŒé€£è²«æ€§ã€‚

ã€è¦æ‘˜è¦çš„å…§å®¹ã€‘
${truncatedContent}

ã€æ‘˜è¦è¦æ±‚ã€‘
è«‹æŒ‰ä»¥ä¸‹æ ¼å¼è¼¸å‡ºæ‘˜è¦ï¼ˆç¸½é•·åº¦æ§åˆ¶åœ¨ 800 å­—ä»¥å…§ï¼‰ï¼š

## ğŸ“– åŠ‡æƒ…æ¦‚è¦
ï¼ˆç”¨ 2-3 æ®µè©±æ¦‚è¿°ä¸»è¦äº‹ä»¶ç™¼å±•ï¼‰

## ğŸ‘¥ è§’è‰²å‹•æ…‹
ï¼ˆåˆ—å‡ºå‡ºç¾çš„é‡è¦è§’è‰²åŠå…¶ç‹€æ…‹è®ŠåŒ–ã€é—œä¿‚è®ŠåŒ–ï¼‰

## ğŸ”‘ é—œéµä¿¡æ¯
ï¼ˆåˆ—å‡ºé‡è¦çš„åœ°é»ã€ç‰©å“ã€ç·šç´¢ã€ç´„å®šç­‰éœ€è¦è¨˜ä½çš„ç´°ç¯€ï¼‰

## âš¡ ç•¶å‰å±€å‹¢
ï¼ˆç°¡è¿°ç›®å‰çš„è™•å¢ƒå’Œå¾…è§£æ±ºçš„å•é¡Œï¼‰

è«‹ç›´æ¥è¼¸å‡ºæ‘˜è¦å…§å®¹ï¼Œä¸è¦æœ‰å…¶ä»–èªªæ˜ã€‚`;

  // èª¿ç”¨ AI
  let response;
  if(preset.type === 'anthropic'){
    response = await callAnthropicDirect(preset, summaryPrompt);
  } else if(preset.type === 'openai'){
    response = await callOpenAIDirect(preset, summaryPrompt);
  } else {
    response = await callCustomDirect(preset, summaryPrompt);
  }
  
  return response.content;
}

// ç›´æ¥èª¿ç”¨ APIï¼ˆä¸å¸¶æ•…äº‹ä¸Šä¸‹æ–‡ï¼‰
async function callAnthropicDirect(p, prompt){
  const r = await fetch('https://api.anthropic.com/v1/messages',{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'x-api-key':p.apiKey,
      'anthropic-version':'2023-06-01',
      'anthropic-dangerous-direct-browser-access':'true'
    },
    body:JSON.stringify({
      model: p.model,
      max_tokens: 1500,
      messages: [{role:'user', content: prompt}]
    })
  });
  if(!r.ok){
    const e = await r.json().catch(()=>({}));
    throw new Error(e.error?.message || `APIéŒ¯èª¤ (${r.status})`);
  }
  const d = await r.json();
  return {content: d.content[0].text};
}

async function callOpenAIDirect(p, prompt){
  const r = await fetch(p.baseUrl || 'https://api.openai.com/v1/chat/completions',{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'Authorization':'Bearer '+p.apiKey
    },
    body:JSON.stringify({
      model: p.model,
      max_tokens: 1500,
      messages: [{role:'user', content: prompt}]
    })
  });
  if(!r.ok){
    const e = await r.json().catch(()=>({}));
    throw new Error(e.error?.message || `APIéŒ¯èª¤ (${r.status})`);
  }
  const d = await r.json();
  return {content: d.choices[0].message.content};
}

async function callCustomDirect(p, prompt){
  const r = await fetch(p.baseUrl,{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'Authorization':'Bearer '+p.apiKey
    },
    body:JSON.stringify({
      model: p.model,
      max_tokens: 1500,
      messages: [{role:'user', content: prompt}]
    })
  });
  if(!r.ok){
    const e = await r.json().catch(()=>({}));
    throw new Error(e.error?.message || `APIéŒ¯èª¤ (${r.status})`);
  }
  const d = await r.json();
  // å˜—è©¦å¤šç¨®æ ¼å¼
  if(d.choices?.[0]?.message?.content) return {content: d.choices[0].message.content};
  if(d.content?.[0]?.text) return {content: d.content[0].text};
  if(d.response) return {content: d.response};
  throw new Error('ç„¡æ³•è§£æ API å›æ‡‰');
}

// ç°¡å–®æ‘˜è¦ï¼ˆAI å¤±æ•—æ™‚çš„å‚™é¸æ–¹æ¡ˆï¼‰
function generateSimpleSummary(messages){
  const events = [];
  const characters = new Set();
  const locations = new Set();
  
  messages.forEach(m => {
    if(m.role === 'user'){
      events.push(`â€¢ ç©å®¶ï¼š${m.content.slice(0, 80)}${m.content.length > 80 ? '...' : ''}`);
    } else {
      // æå–å‰ 200 å­—ä½œç‚ºæ‘˜è¦
      const preview = m.content.slice(0, 200).replace(/\n+/g, ' ');
      events.push(`â€¢ åŠ‡æƒ…ï¼š${preview}${m.content.length > 200 ? '...' : ''}`);
      
      // å˜—è©¦æå–è§’è‰²åï¼ˆç°¡å–®å•Ÿç™¼å¼ï¼‰
      const nameMatches = m.content.match(/ã€Œ[^ã€]+ã€|ã€[^ã€]+ã€|ã€[^ã€‘]+ã€‘/g);
      if(nameMatches){
        nameMatches.slice(0, 5).forEach(n => characters.add(n));
      }
    }
  });
  
  let summary = '## ğŸ“– åŠ‡æƒ…æ¦‚è¦\n';
  summary += events.slice(0, 15).join('\n') + '\n';
  
  if(characters.size > 0){
    summary += '\n## ğŸ‘¥ å‡ºç¾è§’è‰²\n';
    summary += Array.from(characters).slice(0, 10).join('ã€') + '\n';
  }
  
  summary += '\n## âš ï¸ æ³¨æ„\n';
  summary += 'æ­¤ç‚ºç°¡æ˜“æ‘˜è¦ï¼Œéƒ¨åˆ†ç´°ç¯€å¯èƒ½éºæ¼ã€‚';
  
  return summary;
}

// v18: æŸ¥çœ‹æ‘˜è¦
let editSummaryIdx = null;
let editSummaryType = null; // 'compressed' | 'rolling'

function viewSummaries(){
  if(!story){toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'),'warning');return;}
  
  const summaries = story.summaries || [];
  const rollingSummaries = story.rollingSummaries || [];
  const c = document.getElementById('summaries-list');
  
  if(!summaries.length && !rollingSummaries.length){
    c.innerHTML = '<div class="empty" style="padding:30px"><div class="empty-icon">ğŸ“­</div><div class="empty-title">æš«ç„¡æ‘˜è¦</div><div class="empty-desc">å£“ç¸®è¨˜æ†¶æˆ–ç”Ÿæˆæ»¾å‹•æ‘˜è¦å¾Œæœƒé¡¯ç¤ºåœ¨é€™è£¡</div></div>';
    showModal('summaries-modal');
    return;
  }
  
  let html = '';
  
  // å£“ç¸®æ‘˜è¦
  if(summaries.length > 0){
    html += '<div style="font-weight:600;margin-bottom:8px;color:var(--primary)">ğŸ“¦ å£“ç¸®æ‘˜è¦</div>';
    html += summaries.map((s, idx) => {
      const time = new Date(s.createdAt).toLocaleString();
      const aiTag = s.isAI ? '<span style="background:var(--primary);color:white;padding:2px 6px;border-radius:4px;font-size:11px;margin-left:6px">ğŸ¤– AI</span>' : '<span style="background:var(--text-tertiary);color:white;padding:2px 6px;border-radius:4px;font-size:11px;margin-left:6px">ç°¡æ˜“</span>';
      const typeTag = s.type === 'merged' ? '<span style="background:var(--warning);color:black;padding:2px 6px;border-radius:4px;font-size:11px;margin-left:6px">å·²åˆä½µ</span>' : '';
      return `
        <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <span style="font-weight:600">è¨˜æ†¶ç‰‡æ®µ ${idx + 1}${aiTag}${typeTag}</span>
            <span style="font-size:12px;color:var(--text-tertiary)">${time}</span>
          </div>
          <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px">å£“ç¸®äº† ${s.count || 0} æ¢æ¶ˆæ¯</div>
          <div style="font-size:13px;white-space:pre-wrap;line-height:1.6;max-height:200px;overflow-y:auto;background:var(--bg-secondary);padding:10px;border-radius:6px">${esc(s.content)}</div>
          <div style="margin-top:8px;text-align:right;display:flex;justify-content:flex-end;gap:12px">
            <button onclick="editSummary(${idx},'compressed')" style="background:none;border:none;color:var(--primary);cursor:pointer;font-size:12px">âœï¸ ç·¨è¼¯</button>
            <button onclick="deleteSummary(${idx},'compressed')" style="background:none;border:none;color:var(--error);cursor:pointer;font-size:12px">ğŸ—‘ï¸ åˆªé™¤</button>
          </div>
        </div>
      `;
    }).join('');
  }
  
  // æ»¾å‹•æ‘˜è¦
  if(rollingSummaries.length > 0){
    html += '<div style="font-weight:600;margin:16px 0 8px;color:var(--success)">ğŸ“œ æ»¾å‹•æ‘˜è¦ï¼ˆä¸åˆªé™¤åŸæ–‡ï¼‰</div>';
    html += rollingSummaries.map((s, idx) => {
      const time = new Date(s.createdAt).toLocaleString();
      return `
        <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;margin-bottom:12px;border-left:3px solid var(--success)">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <span style="font-weight:600">èƒŒæ™¯æ‘˜è¦ ${idx + 1}</span>
            <span style="font-size:12px;color:var(--text-tertiary)">${time}</span>
          </div>
          <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px">æ¶µè“‹ ${s.msgCount || '?'} æ¢æ¶ˆæ¯</div>
          <div style="font-size:13px;white-space:pre-wrap;line-height:1.6;max-height:150px;overflow-y:auto;background:var(--bg-secondary);padding:10px;border-radius:6px">${esc(s.content)}</div>
          <div style="margin-top:8px;text-align:right;display:flex;justify-content:flex-end;gap:12px">
            <button onclick="editSummary(${idx},'rolling')" style="background:none;border:none;color:var(--primary);cursor:pointer;font-size:12px">âœï¸ ç·¨è¼¯</button>
            <button onclick="deleteSummary(${idx},'rolling')" style="background:none;border:none;color:var(--error);cursor:pointer;font-size:12px">ğŸ—‘ï¸ åˆªé™¤</button>
          </div>
        </div>
      `;
    }).join('');
  }
  
  c.innerHTML = html;
  showModal('summaries-modal');
}

// ç·¨è¼¯æ‘˜è¦
function editSummary(idx, type){
  const summaries = type === 'rolling' ? (story.rollingSummaries || []) : (story.summaries || []);
  const summary = summaries[idx];
  if(!summary) return;
  
  editSummaryIdx = idx;
  editSummaryType = type;
  
  const title = type === 'rolling' ? `âœï¸ ç·¨è¼¯æ»¾å‹•æ‘˜è¦ #${idx + 1}` : `âœï¸ ç·¨è¼¯è¨˜æ†¶ç‰‡æ®µ #${idx + 1}`;
  document.getElementById('edit-summary-title').textContent = title;
  document.getElementById('edit-summary-content').value = summary.content;
  
  showModal('edit-summary-modal');
}

// ä¿å­˜æ‘˜è¦ç·¨è¼¯
async function saveSummaryEdit(){
  if(editSummaryIdx === null || !editSummaryType) return;
  
  const content = document.getElementById('edit-summary-content').value.trim();
  if(!content){
    toast(T('æ‘˜è¦å…§å®¹ä¸èƒ½ç‚ºç©º'),'warning');
    return;
  }
  
  const field = editSummaryType === 'rolling' ? 'rollingSummaries' : 'summaries';
  const summaries = story[field] || [];
  
  if(summaries[editSummaryIdx]){
    summaries[editSummaryIdx].content = content;
    summaries[editSummaryIdx].updatedAt = Date.now();
    
    await db.stories.update(story.id, { [field]: summaries });
    story[field] = summaries;
    
    closeModal('edit-summary-modal');
    viewSummaries(); // åˆ·æ–°åˆ—è¡¨
    toast(T('æ‘˜è¦å·²æ›´æ–°'), 'success');
  }
  
  editSummaryIdx = null;
  editSummaryType = null;
}

// åˆªé™¤å–®æ¢æ‘˜è¦
async function deleteSummary(idx, type = 'compressed'){
  const typeName = type === 'rolling' ? 'æ»¾å‹•æ‘˜è¦' : 'è¨˜æ†¶æ‘˜è¦';
  if(!confirm(`ç¢ºå®šåˆªé™¤é€™æ¢${typeName}ï¼Ÿåˆªé™¤å¾Œ AI å°‡ç„¡æ³•åƒè€ƒé€™æ®µè¨˜æ†¶ã€‚`)) return;
  
  const field = type === 'rolling' ? 'rollingSummaries' : 'summaries';
  const summaries = story[field] || [];
  summaries.splice(idx, 1);
  
  await db.stories.update(story.id, { [field]: summaries });
  story[field] = summaries;
  
  // æ›´æ–°UIè¨ˆæ•¸
  if(type === 'rolling'){
    document.getElementById('memory-rolling-count').textContent = summaries.length;
  } else {
    document.getElementById('memory-summary-count').textContent = summaries.length;
  }
  
  viewSummaries(); // åˆ·æ–°åˆ—è¡¨
  toast(T('æ‘˜è¦å·²åˆªé™¤'), 'success');
}

// æ¸…ç©ºæ‰€æœ‰æ‘˜è¦
async function clearAllSummaries(){
  if(!story){return;}
  
  const summaries = story.summaries || [];
  const rollingSummaries = story.rollingSummaries || [];
  const totalCount = summaries.length + rollingSummaries.length;
  
  if(totalCount === 0){
    toast(T('æš«ç„¡æ‘˜è¦å¯æ¸…ç©º'), 'info');
    return;
  }
  
  let confirmMsg = `ç¢ºå®šæ¸…ç©ºå…¨éƒ¨æ‘˜è¦å—ï¼Ÿ\n\n`;
  if(summaries.length > 0) confirmMsg += `â€¢ ${summaries.length} æ¢å£“ç¸®æ‘˜è¦\n`;
  if(rollingSummaries.length > 0) confirmMsg += `â€¢ ${rollingSummaries.length} æ¢æ»¾å‹•æ‘˜è¦\n`;
  confirmMsg += `\nâš ï¸ æ¸…ç©ºå¾Œ AI å°‡å®Œå…¨å¤±å»å°é€™äº›åŠ‡æƒ…çš„è¨˜æ†¶ï¼`;
  
  if(!confirm(confirmMsg)) return;
  
  await db.stories.update(story.id, {
    summaries: [], 
    rollingSummaries: [],
    compressedCount: 0
  });
  story.summaries = [];
  story.rollingSummaries = [];
  story.compressedCount = 0;
  
  document.getElementById('memory-summary-count').textContent = '0';
  document.getElementById('memory-compressed').textContent = '0';
  document.getElementById('memory-rolling-count').textContent = '0';
  closeModal('summaries-modal');
  toast(T('æ‰€æœ‰æ‘˜è¦å·²æ¸…ç©º'), 'success');
}

// ============ v22 æ–°å¢ï¼šæ»¾å‹•æ‘˜è¦ã€æ™ºèƒ½åˆ†æã€æ‘˜è¦æœç´¢ ============

// ç”Ÿæˆæ»¾å‹•æ‘˜è¦ï¼ˆä¸åˆªé™¤åŸæ–‡ï¼‰
async function generateRollingSummary(){
  if(!story){toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'),'warning');return;}
  if(msgs.length < 10){toast(T('æ¶ˆæ¯å¤ªå°‘ï¼Œå»ºè­°ç´¯ç©æ›´å¤šå…§å®¹å¾Œå†ç”Ÿæˆ'),'info');return;}
  
  showLoading('æ­£åœ¨ç”Ÿæˆæ»¾å‹•æ‘˜è¦...');
  try{
    const preset = await db.apiPresets.filter(p=>p.isActive).first();
    if(!preset || !preset.apiKey){
      throw new Error('æœªé…ç½® API');
    }
    
    // å–æœ€è¿‘çš„æ¶ˆæ¯ï¼ˆæ’é™¤å·²æœ‰æ»¾å‹•æ‘˜è¦è¦†è“‹çš„éƒ¨åˆ†ï¼‰
    const rollingSummaries = story.rollingSummaries || [];
    const lastSummaryMsgIdx = rollingSummaries.length > 0 ? 
      msgs.findIndex(m => m.id === rollingSummaries[rollingSummaries.length - 1].lastMessageId) : -1;
    
    const startIdx = lastSummaryMsgIdx >= 0 ? lastSummaryMsgIdx + 1 : 0;
    const toSummarize = msgs.slice(startIdx);
    
    if(toSummarize.length < 5){
      hideLoading();
      toast(T('è·é›¢ä¸Šæ¬¡æ‘˜è¦å¾Œæ¶ˆæ¯å¤ªå°‘ï¼Œå»ºè­°ç¹¼çºŒéŠæˆ²å¾Œå†ç”Ÿæˆ'),'info');
      return;
    }
    
    // æ§‹å»ºå…§å®¹
    const content = toSummarize.map(m => {
      const role = m.role === 'user' ? 'ã€ç©å®¶ã€‘' : 'ã€åŠ‡æƒ…ã€‘';
      return `${role} ${m.content.slice(0, 500)}`;
    }).join('\n\n');
    
    const prompt = `è«‹ç‚ºä»¥ä¸‹äº’å‹•å°èªªç‰‡æ®µç”Ÿæˆä¸€ä»½ç°¡çŸ­çš„èƒŒæ™¯æ‘˜è¦ï¼ˆ200å­—ä»¥å…§ï¼‰ã€‚é€™ä»½æ‘˜è¦å°‡ä½œç‚ºä¸Šä¸‹æ–‡èƒŒæ™¯ï¼Œå¹«åŠ©AIç†è§£æ•…äº‹é€²å±•ã€‚

ã€å…§å®¹ã€‘
${content.slice(0, 8000)}

ã€è¦æ±‚ã€‘
- ç”¨ 2-3 å¥è©±æ¦‚è¿°ä¸»è¦äº‹ä»¶
- è¨˜éŒ„é—œéµçš„è§’è‰²äº’å‹•æˆ–ç‹€æ…‹è®ŠåŒ–
- ä¸éœ€è¦è©³ç´°ï¼Œåªéœ€è¦æ ¸å¿ƒè¦é»
- ç›´æ¥è¼¸å‡ºæ‘˜è¦ï¼Œä¸è¦å…¶ä»–èªªæ˜`;

    let response;
    if(preset.type === 'anthropic'){
      response = await callAnthropicDirect(preset, prompt);
    } else if(preset.type === 'openai'){
      response = await callOpenAIDirect(preset, prompt);
    } else {
      response = await callCustomDirect(preset, prompt);
    }
    
    // ä¿å­˜æ»¾å‹•æ‘˜è¦
    rollingSummaries.push({
      content: response.content,
      createdAt: Date.now(),
      lastMessageId: msgs[msgs.length - 1].id,
      msgCount: toSummarize.length
    });
    
    await db.stories.update(story.id, { rollingSummaries });
    story.rollingSummaries = rollingSummaries;
    
    hideLoading();
    document.getElementById('memory-rolling-count').textContent = rollingSummaries.length;
    toast(T('æ»¾å‹•æ‘˜è¦å·²ç”Ÿæˆï¼ˆåŸæ¶ˆæ¯ä¿ç•™ï¼‰'),'success');
  }catch(e){
    hideLoading();
    toast('ç”Ÿæˆå¤±æ•—: '+e.message,'error');
  }
}

// åˆä½µå¤šæ¢æ‘˜è¦
async function mergeSummaries(){
  if(!story){toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'),'warning');return;}
  
  const summaries = story.summaries || [];
  if(summaries.length < 2){
    toast(T('è‡³å°‘éœ€è¦ 2 æ¢æ‘˜è¦æ‰èƒ½åˆä½µ'),'info');
    return;
  }
  
  showConfirm(`ç¢ºå®šè¦åˆä½µ ${summaries.length} æ¢æ‘˜è¦å—ï¼Ÿ\n\nAI å°‡é‡æ–°æ•´ç†æ‰€æœ‰æ‘˜è¦ï¼Œç”Ÿæˆä¸€ä»½æ›´ç²¾ç°¡çš„çµ±ä¸€ç‰ˆæœ¬ã€‚`, async () => {
    showLoading('AI æ­£åœ¨åˆä½µæ‘˜è¦...');
    try{
      const preset = await db.apiPresets.filter(p=>p.isActive).first();
      if(!preset || !preset.apiKey){
        throw new Error('æœªé…ç½® API');
      }
      
      const allContent = summaries.map((s, i) => `--- æ‘˜è¦ ${i+1} ---\n${s.content}`).join('\n\n');
      
      const prompt = `ä»¥ä¸‹æ˜¯å¤šä»½äº’å‹•å°èªªçš„åŠ‡æƒ…æ‘˜è¦ï¼Œè«‹å°‡å®ƒå€‘åˆä½µæ•´ç†æˆä¸€ä»½çµ±ä¸€çš„æ‘˜è¦ã€‚

${allContent.slice(0, 12000)}

ã€è¦æ±‚ã€‘
- ä¿ç•™æ‰€æœ‰é‡è¦ä¿¡æ¯ï¼Œå»é™¤é‡è¤‡å…§å®¹
- æŒ‰æ™‚é–“é †åºæ•´ç†
- ç¸½é•·åº¦æ§åˆ¶åœ¨ 1000 å­—ä»¥å…§
- ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼š

## ğŸ“– å®Œæ•´åŠ‡æƒ…å›é¡§
ï¼ˆæŒ‰æ™‚é–“é †åºæ¦‚è¿°æ‰€æœ‰é‡è¦äº‹ä»¶ï¼‰

## ğŸ‘¥ è§’è‰²ç‹€æ…‹
ï¼ˆç•¶å‰å„è§’è‰²çš„ç‹€æ…‹å’Œé—œä¿‚ï¼‰

## ğŸ”‘ é—œéµè¦é»
ï¼ˆéœ€è¦è¨˜ä½çš„é‡è¦ä¿¡æ¯ï¼‰

ç›´æ¥è¼¸å‡ºåˆä½µå¾Œçš„æ‘˜è¦ã€‚`;

      let response;
      if(preset.type === 'anthropic'){
        response = await callAnthropicDirect(preset, prompt);
      } else if(preset.type === 'openai'){
        response = await callOpenAIDirect(preset, prompt);
      } else {
        response = await callCustomDirect(preset, prompt);
      }
      
      // è¨ˆç®—ç¸½å£“ç¸®æ•¸
      const totalCount = summaries.reduce((sum, s) => sum + (s.count || 0), 0);
      
      // ç”¨æ–°æ‘˜è¦æ›¿æ›æ‰€æœ‰èˆŠæ‘˜è¦
      const newSummaries = [{
        content: response.content,
        createdAt: Date.now(),
        count: totalCount,
        isAI: true,
        type: 'merged'
      }];
      
      await db.stories.update(story.id, { summaries: newSummaries });
      story.summaries = newSummaries;
      
      hideLoading();
      document.getElementById('memory-summary-count').textContent = '1';
      closeModal('memory-modal');
      toast(T('æ‘˜è¦å·²åˆä½µç‚ºä¸€ä»½'),'success');
    }catch(e){
      hideLoading();
      toast('åˆä½µå¤±æ•—: '+e.message,'error');
    }
  });
}

// æ™ºèƒ½åˆ†æè¨˜æ†¶
async function analyzeMemory(){
  if(!story){toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'),'warning');return;}
  if(msgs.length < 5){toast(T('æ¶ˆæ¯å¤ªå°‘ï¼Œç„¡éœ€åˆ†æ'),'info');return;}
  
  const resultEl = document.getElementById('memory-analysis-result');
  resultEl.style.display = '';
  resultEl.innerHTML = 'ğŸ”„ AI æ­£åœ¨åˆ†æ...';
  
  try{
    const preset = await db.apiPresets.filter(p=>p.isActive).first();
    if(!preset || !preset.apiKey){
      throw new Error('æœªé…ç½® API');
    }
    
    // æ§‹å»ºåˆ†æå…§å®¹
    const content = msgs.slice(0, 50).map((m, i) => {
      const role = m.role === 'user' ? 'ã€ç©å®¶ã€‘' : 'ã€AIã€‘';
      return `[${i+1}] ${role} ${m.content.slice(0, 300)}`;
    }).join('\n\n');
    
    const prompt = `è«‹åˆ†æä»¥ä¸‹äº’å‹•å°èªªå°è©±ï¼Œå¾è¨˜æ†¶ç®¡ç†è§’åº¦æä¾›å»ºè­°ã€‚

ã€å°è©±å…§å®¹ã€‘ï¼ˆå…± ${msgs.length} æ¢æ¶ˆæ¯ï¼‰
${content.slice(0, 10000)}

ã€åˆ†æè¦æ±‚ã€‘
1. è­˜åˆ¥å“ªäº›æ¶ˆæ¯åŒ…å«é‡è¦ä¿¡æ¯ï¼ˆé—œéµåŠ‡æƒ…ã€è§’è‰²è¨­å®šã€ä¼ç­†ï¼‰
2. è­˜åˆ¥å“ªäº›æ¶ˆæ¯å¯ä»¥å®‰å…¨å£“ç¸®ï¼ˆæ—¥å¸¸å°è©±ã€éæ¸¡æ€§æå¯«ï¼‰
3. çµ¦å‡ºå…·é«”çš„å£“ç¸®å»ºè­°

è«‹ç”¨ä»¥ä¸‹æ ¼å¼è¼¸å‡ºï¼š

ğŸ”´ é‡è¦æ¶ˆæ¯ï¼ˆå»ºè­°ä¿ç•™ï¼‰ï¼š
- [æ¶ˆæ¯ç·¨è™Ÿ] åŸå› 

ğŸŸ¢ å¯å£“ç¸®æ¶ˆæ¯ï¼š
- [æ¶ˆæ¯ç·¨è™Ÿç¯„åœ] åŸå› 

ğŸ’¡ å»ºè­°ï¼š
ï¼ˆå…·é«”çš„è¨˜æ†¶ç®¡ç†å»ºè­°ï¼‰`;

    let response;
    if(preset.type === 'anthropic'){
      response = await callAnthropicDirect(preset, prompt);
    } else if(preset.type === 'openai'){
      response = await callOpenAIDirect(preset, prompt);
    } else {
      response = await callCustomDirect(preset, prompt);
    }
    
    resultEl.innerHTML = `<div style="white-space:pre-wrap;line-height:1.6">${esc(response.content)}</div>`;
  }catch(e){
    resultEl.innerHTML = `<div style="color:var(--error)">åˆ†æå¤±æ•—: ${esc(e.message)}</div>`;
  }
}

// æœç´¢æ‘˜è¦
function searchSummaries(){
  if(!story){toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'),'warning');return;}
  document.getElementById('summary-search-input').value = '';
  document.getElementById('summary-search-results').innerHTML = '<div class="empty"><div class="empty-icon">ğŸ”</div><div class="empty-title">è¼¸å…¥é—œéµè©æœç´¢</div></div>';
  closeModal('memory-modal');
  showModal('summary-search-modal');
}

function doSummarySearch(){
  const keyword = document.getElementById('summary-search-input').value.trim().toLowerCase();
  const resultsEl = document.getElementById('summary-search-results');
  
  if(!keyword){
    resultsEl.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ”</div><div class="empty-title">è¼¸å…¥é—œéµè©æœç´¢</div></div>';
    return;
  }
  
  const summaries = story.summaries || [];
  const rollingSummaries = story.rollingSummaries || [];
  const allSummaries = [
    ...summaries.map((s, i) => ({...s, type: 'å£“ç¸®æ‘˜è¦', idx: i})),
    ...rollingSummaries.map((s, i) => ({...s, type: 'æ»¾å‹•æ‘˜è¦', idx: i}))
  ];
  
  const results = allSummaries.filter(s => s.content.toLowerCase().includes(keyword));
  
  if(results.length === 0){
    resultsEl.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ”</div><div class="empty-title">æœªæ‰¾åˆ°åŒ¹é…å…§å®¹</div></div>';
    return;
  }
  
  resultsEl.innerHTML = results.map(s => {
    const content = s.content;
    const lowerContent = content.toLowerCase();
    const idx = lowerContent.indexOf(keyword);
    const start = Math.max(0, idx - 50);
    const end = Math.min(content.length, idx + keyword.length + 50);
    let preview = content.slice(start, end);
    if(start > 0) preview = '...' + preview;
    if(end < content.length) preview = preview + '...';
    
    // é«˜äº®é—œéµè©
    const regex = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    preview = esc(preview).replace(regex, '<mark style="background:var(--warning);color:black;padding:0 2px">$1</mark>');
    
    return `
      <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;margin-bottom:8px">
        <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:4px">${s.type} #${s.idx + 1}</div>
        <div style="font-size:13px;line-height:1.5">${preview}</div>
      </div>
    `;
  }).join('');
}

// æª¢æŸ¥æ˜¯å¦éœ€è¦è‡ªå‹•ç”Ÿæˆæ»¾å‹•æ‘˜è¦
async function checkAutoRollingSummary(){
  if(!story || !story.rollingEnabled) return;
  
  const interval = story.rollingInterval || 30;
  const rollingSummaries = story.rollingSummaries || [];
  
  // è¨ˆç®—è·é›¢ä¸Šæ¬¡æ‘˜è¦å¾Œçš„æ¶ˆæ¯æ•¸
  let msgsSinceLastSummary = msgs.length;
  if(rollingSummaries.length > 0){
    const lastMsgId = rollingSummaries[rollingSummaries.length - 1].lastMessageId;
    const lastIdx = msgs.findIndex(m => m.id === lastMsgId);
    if(lastIdx >= 0){
      msgsSinceLastSummary = msgs.length - lastIdx - 1;
    }
  }
  
  if(msgsSinceLastSummary >= interval){
    // éœé»˜ç”Ÿæˆæ»¾å‹•æ‘˜è¦
    try{
      await generateRollingSummary();
    }catch(e){
      console.warn('è‡ªå‹•æ»¾å‹•æ‘˜è¦ç”Ÿæˆå¤±æ•—:', e);
    }
  }
}

// æŸ¥æ‰¾æ›¿æ›
function showFindReplace(){
  closeAll();
  if(!story){toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'),'warning');return;}
  document.getElementById('find-text').value='';
  document.getElementById('replace-text').value='';
  document.getElementById('find-result').textContent='';
  showModal('find-replace-modal');
}
function findNext(){
  const find=document.getElementById('find-text').value;
  if(!find){toast(T('è«‹è¼¸å…¥æŸ¥æ‰¾å…§å®¹'),'warning');return;}
  const caseSensitive=document.getElementById('find-case-sensitive').checked;
  let count=0;
  msgs.forEach(m=>{
    const content=caseSensitive?m.content:m.content.toLowerCase();
    const search=caseSensitive?find:find.toLowerCase();
    const matches=(content.match(new RegExp(search.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'g'))||[]).length;
    count+=matches;
  });
  document.getElementById('find-result').textContent=`æ‰¾åˆ° ${count} è™•åŒ¹é…`;
}
async function replaceAll(){
  const find=document.getElementById('find-text').value;
  const replace=document.getElementById('replace-text').value;
  if(!find){toast(T('è«‹è¼¸å…¥æŸ¥æ‰¾å…§å®¹'),'warning');return;}
  
  const caseSensitive=document.getElementById('find-case-sensitive').checked;
  const regex=new RegExp(find.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),caseSensitive?'g':'gi');
  let count=0;
  
  for(const m of msgs){
    const newContent=m.content.replace(regex,(match)=>{count++;return replace;});
    if(newContent!==m.content){
      m.content=newContent;
      await db.messages.update(m.id,{content:newContent});
    }
  }
  
  if(count>0){
    renderMsgs();
    document.getElementById('find-result').textContent=`å·²æ›¿æ› ${count} è™•`;
    toast(`å·²æ›¿æ› ${count} è™•`,'success');
  }else{
    document.getElementById('find-result').textContent='æœªæ‰¾åˆ°åŒ¹é…å…§å®¹';
  }
}

// çµ±è¨ˆé¢æ¿
function showStats(){
  closeAll();
  if(!story){toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'),'warning');return;}
  
  let totalChars=0,userChars=0,aiChars=0,totalTokens=0;
  msgs.forEach(m=>{
    totalChars+=m.content.length;
    if(m.role==='user')userChars+=m.content.length;
    else aiChars+=m.content.length;
    totalTokens+=(m.tokens||0);
  });
  
  document.getElementById('stats-chars').textContent=fmtNum(totalChars);
  document.getElementById('stats-msgs').textContent=msgs.length;
  document.getElementById('stats-tokens').textContent=fmtNum(totalTokens);
  document.getElementById('stats-time').textContent=Math.round((story.statistics?.playTimeMinutes||0)/60)+'h';
  document.getElementById('stats-user-chars').textContent=fmtNum(userChars);
  document.getElementById('stats-ai-chars').textContent=fmtNum(aiChars);
  
  showModal('stats-modal');
}

// å°å‡ºæ•…äº‹
function exportStory(){
  closeAll();
  if(!story){toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'),'warning');return;}
  
  let content='# '+story.title+'\n\n';
  if(story.description)content+='> '+story.description+'\n\n';
  content+='---\n\n';
  
  msgs.forEach(m=>{
    if(m.role==='user')content+='**ã€ç©å®¶ã€‘** '+m.content+'\n\n';
    else content+=m.content+'\n\n---\n\n';
  });
  
  const blob=new Blob([content],{type:'text/markdown'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=story.title+'.md';
  a.click();
  URL.revokeObjectURL(url);
  toast(T('æ•…äº‹å·²å°å‡º'),'success');
}

// ============ ç« ç¯€ç®¡ç† ============
async function renderChapters(){
  if(!story)return;
  const c=document.getElementById('chapter-list');
  const chapters=await db.chapters.where('storyId').equals(story.id).sortBy('order');
  if(!chapters.length){
    c.innerHTML='<div class="empty"><div class="empty-icon">ğŸ“‘</div><div class="empty-title">æš«ç„¡ç« ç¯€</div><div class="empty-desc">é»æ“Šå³ä¸Šè§’æ·»åŠ ç« ç¯€æ¨™è¨˜</div></div>';
    return;
  }
  c.innerHTML=chapters.map((ch,i)=>{
    const msg=msgs.find(m=>m.id===ch.messageId);
    const preview=msg?.content?.slice(0,50)||'';
    return `<div class="card" onclick="jumpToChapter('${ch.id}')">
      <div class="card-cover" style="background:linear-gradient(135deg,var(--primary),var(--info))">ğŸ“‘</div>
      <div class="card-info">
        <div class="card-header"><div class="card-title">${esc(ch.title)}</div><div class="card-time">${fmtDate(ch.createdAt)}</div></div>
        <div class="card-preview">${esc(preview)}...</div>
        <div class="card-meta"><span class="card-stats">ç¬¬ ${i+1} ç« </span></div>
      </div>
    </div>`;
  }).join('')+'<button class="action-btn secondary" style="width:100%;margin-top:12px" onclick="addChapter()">â• æ·»åŠ ç« ç¯€</button>';
}
function addChapter(){
  if(!story){toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'),'warning');return;}
  if(!selMsgId&&msgs.length>0)selMsgId=msgs[msgs.length-1].id;
  document.getElementById('chapter-title').value='';
  showModal('chapter-modal');
}
async function saveChapter(){
  const title=document.getElementById('chapter-title').value.trim();
  if(!title){toast(T('è«‹è¼¸å…¥ç« ç¯€æ¨™é¡Œ'),'warning');return;}
  const chapters=await db.chapters.where('storyId').equals(story.id).toArray();
  const ch={id:crypto.randomUUID(),storyId:story.id,messageId:selMsgId||msgs[msgs.length-1]?.id,title,order:chapters.length,createdAt:Date.now()};
  await db.chapters.add(ch);
  closeModal('chapter-modal');
  toast(T('ç« ç¯€å·²æ·»åŠ '),'success');
  renderChapters();
}
async function jumpToChapter(chId){
  const ch=await db.chapters.get(chId);
  if(!ch)return;
  goBack();
  setTimeout(()=>{
    const el=document.querySelector(`.msg[data-id="${ch.messageId}"]`);
    if(el)el.scrollIntoView({behavior:'smooth',block:'center'});
  },300);
}

// ============ æ›¸ç±¤ç®¡ç† ============
async function renderBookmarks(){
  if(!story)return;
  const c=document.getElementById('bookmark-list');
  const bookmarks=await db.bookmarks.where('storyId').equals(story.id).reverse().sortBy('createdAt');
  if(!bookmarks.length){
    c.innerHTML='<div class="empty"><div class="empty-icon">ğŸ”–</div><div class="empty-title">æš«ç„¡æ›¸ç±¤</div><div class="empty-desc">é•·æŒ‰æ¶ˆæ¯å¯æ·»åŠ æ›¸ç±¤</div></div>';
    return;
  }
  c.innerHTML=bookmarks.map(bm=>{
    const msg=msgs.find(m=>m.id===bm.messageId);
    const preview=msg?.content?.slice(0,80)||'';
    return `<div class="card" onclick="jumpToBookmark('${bm.id}')">
      <div class="card-cover" style="background:linear-gradient(135deg,var(--warning),var(--primary))">ğŸ”–</div>
      <div class="card-info">
        <div class="card-header"><div class="card-title">${esc(bm.name)}</div><div class="card-time">${fmtDate(bm.createdAt)}</div></div>
        <div class="card-preview">${esc(preview)}...</div>
      </div>
      <div style="position:absolute;right:12px;top:50%;transform:translateY(-50%)" onclick="event.stopPropagation();deleteBookmark('${bm.id}')">ğŸ—‘ï¸</div>
    </div>`;
  }).join('');
}
function addBookmark(){
  hideMenu();
  if(!selMsgId){toast(T('è«‹å…ˆé¸æ“‡æ¶ˆæ¯'),'warning');return;}
  document.getElementById('bookmark-name').value='';
  showModal('bookmark-modal');
}
async function saveBookmark(){
  const name=document.getElementById('bookmark-name').value.trim()||'æ›¸ç±¤ '+(await db.bookmarks.where('storyId').equals(story.id).count()+1);
  const bm={id:crypto.randomUUID(),storyId:story.id,messageId:selMsgId,name,createdAt:Date.now()};
  await db.bookmarks.add(bm);
  closeModal('bookmark-modal');
  toast(T('æ›¸ç±¤å·²æ·»åŠ '),'success');
}
async function jumpToBookmark(bmId){
  const bm=await db.bookmarks.get(bmId);
  if(!bm)return;
  goBack();
  setTimeout(()=>{
    const el=document.querySelector(`.msg[data-id="${bm.messageId}"]`);
    if(el){el.scrollIntoView({behavior:'smooth',block:'center'});el.style.animation='highlight 1s';}
  },300);
}
async function deleteBookmark(id){await db.bookmarks.delete(id);toast(T('æ›¸ç±¤å·²åˆªé™¤'),'success');renderBookmarks();}

// ============ åŠ‡æƒ…æ¨™ç±¤ ============
function addPlotTag(){
  hideMenu();
  if(!selMsgId){toast(T('è«‹å…ˆé¸æ“‡æ¶ˆæ¯'),'warning');return;}
  document.getElementById('tag-note').value='';
  showModal('tag-modal');
}
async function savePlotTag(){
  const type=document.getElementById('tag-type').value;
  const note=document.getElementById('tag-note').value.trim();
  const tag={id:crypto.randomUUID(),storyId:story.id,messageId:selMsgId,type,note,createdAt:Date.now()};
  await db.plotTags.add(tag);
  closeModal('tag-modal');
  toast(T('æ¨™ç±¤å·²æ·»åŠ '),'success');
  // åœ¨æ¶ˆæ¯ä¸Šé¡¯ç¤ºæ¨™ç±¤
  const el=document.querySelector(`.msg[data-id="${selMsgId}"]`);
  if(el){
    const labels={key:'ğŸ”‘é—œéµ',scene:'ğŸ¬åå ´é¢',clue:'ğŸ”ç·šç´¢',turning:'ğŸ”„è½‰æŠ˜',emotion:'ğŸ’•æƒ…æ„Ÿ'};
    let tagEl=el.querySelector('.plot-tags');
    if(!tagEl){tagEl=document.createElement('div');tagEl.className='plot-tags';tagEl.style.cssText='margin-top:8px;display:flex;gap:4px;flex-wrap:wrap';el.appendChild(tagEl);}
    tagEl.innerHTML+=`<span style="font-size:10px;padding:2px 6px;background:var(--bg-tertiary);border-radius:4px;color:var(--primary)">${labels[type]||type}</span>`;
  }
}

// ============ åˆ†æ”¯ç®¡ç† ============
async function renderBranches(){
  if(!story)return;
  const c=document.getElementById('branch-list');
  const branches=await db.branches.where('storyId').equals(story.id).toArray();
  if(!branches.length){
    // å‰µå»ºé»˜èªä¸»åˆ†æ”¯
    const main={id:'branch_main',storyId:story.id,name:'ä¸»ç·š',description:'',parentBranchId:null,createdAt:Date.now()};
    await db.branches.add(main);
    branches.push(main);
  }
  c.innerHTML=branches.map(br=>{
    const isActive=br.id===story.currentBranchId;
    return `<div class="card ${isActive?'selected':''}" onclick="switchBranch('${br.id}')">
      <div class="card-cover" style="background:linear-gradient(135deg,${isActive?'var(--success)':'var(--bg-tertiary)'},var(--primary))">ğŸ”€</div>
      <div class="card-info">
        <div class="card-header"><div class="card-title">${esc(T(br.name))}</div>${isActive?`<span class="api-badge">${T('ç•¶å‰')}</span>`:''}</div>
        <div class="card-preview">${esc(br.description||T('ç„¡æè¿°'))}</div>
        <div class="card-meta"><span class="card-stats">${fmtDate(br.createdAt)}</span></div>
      </div>
    </div>`;
  }).join('')+`<button class="action-btn primary" style="width:100%;margin-top:12px" onclick="createBranch()">â• ${T('å‰µå»ºæ–°åˆ†æ”¯')}</button>`;
}
function createBranch(){
  if(!story){toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'),'warning');return;}
  document.getElementById('branch-name').value='';
  document.getElementById('branch-desc').value='';
  showModal('branch-modal');
}
async function saveBranch(){
  const name=document.getElementById('branch-name').value.trim();
  if(!name){toast(T('è«‹è¼¸å…¥åˆ†æ”¯åç¨±'),'warning');return;}
  const desc=document.getElementById('branch-desc').value.trim();
  const br={id:crypto.randomUUID(),storyId:story.id,name,description:desc,parentBranchId:story.currentBranchId,forkMessageId:msgs[msgs.length-1]?.id,createdAt:Date.now()};
  await db.branches.add(br);
  // è¤‡è£½ç•¶å‰åˆ†æ”¯çš„æ¶ˆæ¯åˆ°æ–°åˆ†æ”¯
  const currentMsgs=await db.messages.where('[storyId+branchId]').equals([story.id,story.currentBranchId]).toArray();
  const newMsgs=currentMsgs.map(m=>({...m,id:crypto.randomUUID(),branchId:br.id}));
  await db.messages.bulkAdd(newMsgs);
  closeModal('branch-modal');
  toast(T('åˆ†æ”¯å·²å‰µå»º'),'success');
  renderBranches();
}
async function switchBranch(brId){
  if(brId===story.currentBranchId)return;
  story.currentBranchId=brId;
  await db.stories.update(story.id,{currentBranchId:brId});
  msgs=await db.messages.where('[storyId+branchId]').equals([story.id,brId]).sortBy('createdAt');
  renderMsgs();
  toast(T('å·²åˆ‡æ›åˆ†æ”¯'),'success');
  renderBranches();
}

// ============ AI åŠŸèƒ½ ============
let lastAiCheckResult = null; // ä¿å­˜æœ€å¾Œä¸€æ¬¡ AI æª¢æŸ¥çµæœ

function aiConsistencyCheck(){
  if(!story||!msgs.length){toast(T('è«‹å…ˆé¸æ“‡æœ‰å…§å®¹çš„æ•…äº‹'),'warning');return;}
  document.getElementById('ai-check-result').textContent='é»æ“Šã€Œé–‹å§‹æª¢æŸ¥ã€é€²è¡Œåˆ†æ...';
  document.getElementById('ai-fix-btn').style.display='none';
  showModal('ai-check-modal');
}
async function doAiConsistencyCheck(){
  const resultEl=document.getElementById('ai-check-result');
  resultEl.textContent='åˆ†æä¸­ï¼Œè«‹ç¨å€™...';
  
  const prompt=`ä½ æ˜¯ä¸€å€‹æ•…äº‹ä¸€è‡´æ€§æª¢æŸ¥åŠ©æ‰‹ã€‚è«‹åˆ†æä»¥ä¸‹æ•…äº‹å…§å®¹ï¼Œæª¢æŸ¥æ˜¯å¦å­˜åœ¨ï¼š
1. è¨­å®šçŸ›ç›¾ï¼ˆè§’è‰²æ€§æ ¼ã€èƒ½åŠ›ã€èƒŒæ™¯ä¸ä¸€è‡´ï¼‰
2. æ™‚é–“ç·šéŒ¯èª¤ï¼ˆäº‹ä»¶é †åºä¸åˆç†ï¼‰
3. è§’è‰²è¡Œç‚ºä¸ä¸€è‡´ï¼ˆèˆ‡ä¹‹å‰å»ºç«‹çš„æ€§æ ¼ä¸ç¬¦ï¼‰
4. é‚è¼¯æ¼æ´ï¼ˆæƒ…ç¯€ä¸åˆç†ï¼‰

è«‹åˆ—å‡ºç™¼ç¾çš„å•é¡Œï¼Œä¸¦çµ¦å‡ºå…·é«”ä½ç½®å’Œä¿®æ”¹å»ºè­°ã€‚å¦‚æœæ²’æœ‰å•é¡Œï¼Œè«‹èªªæ˜æ•…äº‹æ•´é«”ä¸€è‡´æ€§è‰¯å¥½ã€‚

æ•…äº‹å…§å®¹ï¼š
${msgs.slice(-30).map(m=>(m.role==='user'?'ã€ç©å®¶ã€‘':'ã€AIã€‘')+m.content).join('\n\n')}`;

  try{
    const resp=await callApi(prompt);
    resultEl.textContent=resp.content;
    lastAiCheckResult=resp.content;
    // å¦‚æœç™¼ç¾å•é¡Œï¼Œé¡¯ç¤ºä¿®å¾©æŒ‰éˆ•
    if(!resp.content.includes('ä¸€è‡´æ€§è‰¯å¥½') && !resp.content.includes('æ²’æœ‰ç™¼ç¾å•é¡Œ') && !resp.content.includes('æ²’æœ‰æ˜é¡¯')){
      document.getElementById('ai-fix-btn').style.display='block';
    }
  }catch(e){
    resultEl.textContent='æª¢æŸ¥å¤±æ•—: '+e.message;
  }
}

function showAiFix(){
  closeModal('ai-check-modal');
  showModal('ai-fix-modal');
}

async function applyAiFix(method){
  closeModal('ai-fix-modal');
  
  if(method==='auto'){
    // å°‡ä¸€è‡´æ€§å•é¡Œæ·»åŠ åˆ°ä¸‹æ¬¡ AI å›è¦†çš„æç¤ºä¸­
    story.consistencyNote=`è«‹æ³¨æ„ä»¥ä¸‹ä¸€è‡´æ€§å•é¡Œä¸¦åœ¨å›è¦†ä¸­è‡ªç„¶åœ°ç³¾æ­£ï¼š\n${lastAiCheckResult.slice(0,500)}`;
    await db.stories.update(story.id,{consistencyNote:story.consistencyNote});
    toast(T('å·²è¨­ç½®è‡ªå‹•ä¿®å¾©ï¼ŒAI å°‡åœ¨ä¸‹æ¬¡å›è¦†ä¸­ç³¾æ­£'),'success');
  }else if(method==='note'){
    // æ·»åŠ åˆ°ä¸–ç•Œè§€è¨­å®š
    const note={
      id:crypto.randomUUID(),
      storyId:story.id,
      category:'setting',
      name:'ä¸€è‡´æ€§ç­†è¨˜ - '+new Date().toLocaleDateString(),
      description:'AI æª¢æ¸¬åˆ°çš„å•é¡Œ',
      content:lastAiCheckResult,
      isSelected:false,
      createdAt:Date.now()
    };
    await db.loreEntries.add(note);
    toast(T('å·²æ·»åŠ åˆ°ä¸–ç•Œè§€è¨­å®š'),'success');
  }else{
    toast(T('å·²å¿½ç•¥'),'info');
  }
}

function aiChapterSummary(){
  if(!story||!msgs.length){toast(T('è«‹å…ˆé¸æ“‡æœ‰å…§å®¹çš„æ•…äº‹'),'warning');return;}
  document.getElementById('ai-summary-result').textContent='é»æ“Šã€Œç”Ÿæˆç¸½çµã€é–‹å§‹...';
  showModal('ai-summary-modal');
}
async function doAiChapterSummary(){
  const resultEl=document.getElementById('ai-summary-result');
  resultEl.textContent='ç”Ÿæˆä¸­ï¼Œè«‹ç¨å€™...';
  
  const prompt=`è«‹ç‚ºä»¥ä¸‹æ•…äº‹å…§å®¹ç”Ÿæˆä¸€å€‹ç°¡æ½”çš„ç« ç¯€ç¸½çµï¼ŒåŒ…æ‹¬ï¼š
1. ä¸»è¦äº‹ä»¶æ¦‚è¿°ï¼ˆ3-5å¥è©±ï¼‰
2. é‡è¦è§’è‰²ç‹€æ…‹è®ŠåŒ–
3. é—œéµæ±ºç­–é»
4. æœªè§£æ±ºçš„ä¼ç­†/æ‡¸å¿µ

æ•…äº‹å…§å®¹ï¼š
${msgs.slice(-50).map(m=>(m.role==='user'?'ã€ç©å®¶ã€‘':'ã€AIã€‘')+m.content).join('\n\n')}`;

  try{
    const resp=await callApi(prompt);
    resultEl.textContent=resp.content;
  }catch(e){
    resultEl.textContent='ç”Ÿæˆå¤±æ•—: '+e.message;
  }
}
function copySummary(){
  const text=document.getElementById('ai-summary-result').textContent;
  navigator.clipboard.writeText(text);
  toast(T('å·²è¤‡è£½åˆ°å‰ªè²¼æ¿'),'success');
}

function aiSuggestions(){
  if(!story||!msgs.length){toast(T('è«‹å…ˆé¸æ“‡æœ‰å…§å®¹çš„æ•…äº‹'),'warning');return;}
  document.getElementById('ai-suggest-result').textContent='é»æ“Šã€Œç²å–å»ºè­°ã€é–‹å§‹...';
  showModal('ai-suggest-modal');
}
async function doAiSuggestions(){
  const resultEl=document.getElementById('ai-suggest-result');
  resultEl.textContent='æ€è€ƒä¸­ï¼Œè«‹ç¨å€™...';
  
  const prompt=`åŸºæ–¼ä»¥ä¸‹æ•…äº‹çš„ç•¶å‰é€²å±•ï¼Œè«‹ç‚ºç©å®¶æä¾› 3-5 å€‹å¯èƒ½çš„è¡Œå‹•å»ºè­°ã€‚æ¯å€‹å»ºè­°æ‡‰è©²ï¼š
1. ç¬¦åˆç•¶å‰æƒ…å¢ƒ
2. æœ‰ä¸åŒçš„é¢¨éšª/æ”¶ç›Šå‚¾å‘
3. èƒ½æ¨å‹•åŠ‡æƒ…ç™¼å±•

è«‹ç”¨ç°¡æ½”çš„æ–¹å¼åˆ—å‡ºå»ºè­°ï¼Œæ¯å€‹å»ºè­°é™„ä¸Šç°¡çŸ­çš„å¯èƒ½å¾Œæœé æ¸¬ã€‚

ç•¶å‰æ•…äº‹é€²å±•ï¼š
${msgs.slice(-20).map(m=>(m.role==='user'?'ã€ç©å®¶ã€‘':'ã€AIã€‘')+m.content).join('\n\n')}`;

  try{
    const resp=await callApi(prompt);
    resultEl.textContent=resp.content;
  }catch(e){
    resultEl.textContent='ç²å–å»ºè­°å¤±æ•—: '+e.message;
  }
}

// ============ v7: è§’è‰²å¡ç‰‡ç³»çµ± ============
let currentCharacterId = null; // ç•¶å‰é¸ä¸­çš„è§’è‰²ID
let charBatchMode = false; // æ‰¹é‡æ“ä½œæ¨¡å¼
let selectedCharIds = new Set(); // å·²é¸ä¸­çš„è§’è‰²ID

// v25: æ¸²æŸ“è§’è‰²åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†çµ„ã€æœç´¢ã€ç¯©é¸ï¼‰
async function renderCharacters(){
  if(!story){
    document.getElementById('character-list').innerHTML='<div class="char-empty"><div class="char-empty-icon">ğŸ“š</div><div class="char-empty-text">è«‹å…ˆé¸æ“‡æ•…äº‹</div></div>';
    return;
  }
  
  let chars = await db.characters.where('storyId').equals(story.id).toArray();
  const c = document.getElementById('character-list');
  
  // æ‡‰ç”¨æœç´¢ç¯©é¸
  const searchText = document.getElementById('char-search-input')?.value?.toLowerCase() || '';
  const categoryFilter = document.getElementById('char-filter-category')?.value || 'all';
  
  if(searchText){
    chars = chars.filter(char => 
      char.name?.toLowerCase().includes(searchText) ||
      char.title?.toLowerCase().includes(searchText) ||
      char.description?.toLowerCase().includes(searchText) ||
      (char.tags || []).some(t => t.toLowerCase().includes(searchText))
    );
  }
  
  if(categoryFilter !== 'all'){
    chars = chars.filter(char => char.category === categoryFilter);
  }
  
  // æ›´æ–°è¨ˆæ•¸
  const totalCount = await db.characters.where('storyId').equals(story.id).count();
  document.getElementById('char-count').textContent = chars.length === totalCount 
    ? `${totalCount} ä½è§’è‰²` 
    : `${chars.length} / ${totalCount} ä½è§’è‰²`;
  
  if(!chars.length){
    c.innerHTML = searchText || categoryFilter !== 'all'
      ? `<div class="char-empty"><div class="char-empty-icon">ğŸ”</div><div class="char-empty-text">æ²’æœ‰æ‰¾åˆ°åŒ¹é…çš„è§’è‰²</div></div>`
      : `<div class="char-empty"><div class="char-empty-icon">ğŸ‘¥</div><div class="char-empty-text">å°šæœªè­˜åˆ¥è§’è‰²</div><div style="font-size:12px;color:var(--text-tertiary);margin-top:8px">é»æ“Šã€ŒAI æ›´æ–°ç‹€æ…‹ã€è‡ªå‹•è­˜åˆ¥<br>æˆ–æ‰‹å‹•æ·»åŠ è§’è‰²</div></div>`;
    return;
  }
  
  // æŒ‰åˆ†é¡åˆ†çµ„
  const groups = {
    protagonist: { label: 'â­ ä¸»è§’', chars: [] },
    supporting: { label: 'ğŸ‘¤ é…è§’', chars: [] },
    npc: { label: 'ğŸ‘¥ NPC', chars: [] }
  };
  
  chars.forEach(char => {
    const cat = char.category || 'supporting';
    if(groups[cat]){
      groups[cat].chars.push(char);
    } else {
      groups.supporting.chars.push(char);
    }
  });
  
  // æ¸²æŸ“åˆ†çµ„
  let html = '';
  const batchClass = charBatchMode ? 'batch-mode' : '';
  
  for(const [catKey, group] of Object.entries(groups)){
    if(group.chars.length === 0) continue;
    
    html += `
      <div class="char-group" data-category="${catKey}">
        <div class="char-group-header" onclick="toggleCharGroup('${catKey}')">
          <span class="char-group-arrow">â–¼</span>
          <span>${group.label}</span>
          <span class="char-group-count">(${group.chars.length})</span>
        </div>
        <div class="char-group-list ${batchClass}">
          ${group.chars.map(char => renderCharCardSimple(char)).join('')}
        </div>
      </div>
    `;
  }
  
  c.innerHTML = html;
  
  // æ›´æ–°æ‰¹é‡é¸æ“‡ç‹€æ…‹
  updateBatchCount();
}

// v25: ç°¡åŒ–çš„è§’è‰²å¡ç‰‡ï¼ˆç”¨æ–¼åˆ—è¡¨ï¼‰
function renderCharCardSimple(char){
  const isSelected = selectedCharIds.has(char.id);
  const categoryLabels = {
    protagonist: { label: 'ä¸»è§’', cls: 'protagonist' },
    supporting: { label: 'é…è§’', cls: 'supporting' },
    npc: { label: 'NPC', cls: 'npc' }
  };
  const catInfo = categoryLabels[char.category] || categoryLabels.supporting;
  
  // ä¸»è¦å±¬æ€§æ‘˜è¦
  const stats = char.stats || {};
  const statKeys = Object.keys(stats).slice(0, 2);
  const statHtml = statKeys.map(k => `<span>${k}: ${stats[k]}</span>`).join(' Â· ');
  
  // V2ç‰¹æ€§å¾½ç« 
  const badges = [];
  if(char.first_mes) badges.push('ğŸ’¬');
  if(char.expressions?.length) badges.push('ğŸ¨');
  if(char.relationships?.length) badges.push('ğŸ‘¥');
  if(char.character_book?.entries?.length) badges.push('ğŸ“š');
  
  return `
    <div class="char-card ${isSelected ? 'selected' : ''}" 
         data-char-id="${char.id}"
         onclick="handleCharCardClick('${char.id}', event)">
      <div class="char-card-checkbox ${isSelected ? 'checked' : ''}" onclick="event.stopPropagation();toggleCharSelect('${char.id}')">
        ${isSelected ? 'âœ“' : ''}
      </div>
      <div class="char-card-avatar">
        ${char.avatarImage ? `<img src="${char.avatarImage}" alt="">` : (char.avatar || 'ğŸ‘¤')}
      </div>
      <div class="char-card-info">
        <div class="char-card-name">
          ${esc(char.name)}
          ${badges.length ? `<span style="font-size:12px">${badges.join('')}</span>` : ''}
        </div>
        ${char.title ? `<div class="char-card-title">${esc(char.title)}</div>` : ''}
        ${char.tags?.length ? `<div class="char-card-tags">${char.tags.slice(0,3).map(t => `<span class="char-card-tag">${esc(t)}</span>`).join('')}</div>` : ''}
      </div>
      <div class="char-card-stats">
        <span class="char-card-category ${catInfo.cls}">${catInfo.label}</span>
        ${statHtml ? `<div class="char-card-stat">${statHtml}</div>` : ''}
      </div>
    </div>
  `;
}

// v25: è™•ç†å¡ç‰‡é»æ“Š
function handleCharCardClick(charId, event){
  if(charBatchMode){
    toggleCharSelect(charId);
  } else {
    showCharDetail(charId);
  }
}

// v25: åˆ‡æ›åˆ†çµ„å±•é–‹/æ”¶èµ·
function toggleCharGroup(category){
  const group = document.querySelector(`.char-group[data-category="${category}"]`);
  if(group) group.classList.toggle('collapsed');
}

// v25: ç¯©é¸è§’è‰²
function filterCharacters(){
  renderCharacters();
}

// v25: æ‰¹é‡æ“ä½œæ¨¡å¼
function toggleCharBatchMode(){
  charBatchMode = !charBatchMode;
  const btn = document.getElementById('char-batch-btn');
  const bar = document.getElementById('char-batch-bar');
  
  if(charBatchMode){
    btn.style.color = 'var(--primary)';
    bar.style.display = 'flex';
    document.querySelectorAll('.char-group-list').forEach(el => el.classList.add('batch-mode'));
  } else {
    btn.style.color = '';
    bar.style.display = 'none';
    selectedCharIds.clear();
    document.querySelectorAll('.char-group-list').forEach(el => el.classList.remove('batch-mode'));
    document.querySelectorAll('.char-card').forEach(el => el.classList.remove('selected'));
    document.querySelectorAll('.char-card-checkbox').forEach(el => {
      el.classList.remove('checked');
      el.textContent = '';
    });
  }
  
  updateBatchCount();
}

// v25: åˆ‡æ›è§’è‰²é¸æ“‡
function toggleCharSelect(charId){
  if(selectedCharIds.has(charId)){
    selectedCharIds.delete(charId);
  } else {
    selectedCharIds.add(charId);
  }
  
  const card = document.querySelector(`.char-card[data-char-id="${charId}"]`);
  if(card){
    const isSelected = selectedCharIds.has(charId);
    card.classList.toggle('selected', isSelected);
    const checkbox = card.querySelector('.char-card-checkbox');
    if(checkbox){
      checkbox.classList.toggle('checked', isSelected);
      checkbox.textContent = isSelected ? 'âœ“' : '';
    }
  }
  
  updateBatchCount();
}

// v25: å…¨é¸/å–æ¶ˆå…¨é¸
async function toggleSelectAllChars(){
  const selectAll = document.getElementById('char-select-all');
  const chars = await db.characters.where('storyId').equals(story.id).toArray();
  
  if(selectAll.checked){
    chars.forEach(c => selectedCharIds.add(c.id));
  } else {
    selectedCharIds.clear();
  }
  
  document.querySelectorAll('.char-card').forEach(card => {
    const charId = card.dataset.charId;
    const isSelected = selectedCharIds.has(charId);
    card.classList.toggle('selected', isSelected);
    const checkbox = card.querySelector('.char-card-checkbox');
    if(checkbox){
      checkbox.classList.toggle('checked', isSelected);
      checkbox.textContent = isSelected ? 'âœ“' : '';
    }
  });
  
  updateBatchCount();
}

// v25: æ›´æ–°é¸ä¸­è¨ˆæ•¸
function updateBatchCount(){
  const countEl = document.getElementById('char-batch-count');
  if(countEl){
    countEl.textContent = `å·²é¸ ${selectedCharIds.size} å€‹`;
  }
  
  // æ›´æ–°å…¨é¸ç‹€æ…‹
  const selectAll = document.getElementById('char-select-all');
  if(selectAll){
    db.characters.where('storyId').equals(story?.id || 0).count().then(total => {
      selectAll.checked = selectedCharIds.size === total && total > 0;
      selectAll.indeterminate = selectedCharIds.size > 0 && selectedCharIds.size < total;
    });
  }
}

// v25: æ‰¹é‡åˆªé™¤
async function batchDeleteChars(){
  if(selectedCharIds.size === 0){
    toast(T('è«‹å…ˆé¸æ“‡è§’è‰²'), 'warning');
    return;
  }
  
  if(!confirm(`ç¢ºå®šè¦åˆªé™¤ ${selectedCharIds.size} å€‹è§’è‰²å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤éŠ·ã€‚`)) return;
  
  showLoading(T('æ­£åœ¨åˆªé™¤...'));
  
  try {
    for(const charId of selectedCharIds){
      await db.characters.delete(charId);
    }
    
    selectedCharIds.clear();
    updateBatchCount();
    renderCharacters();
    
    hideLoading();
    toast(T('è§’è‰²å·²åˆªé™¤'), 'success');
  } catch(err){
    hideLoading();
    console.error('Batch delete error:', err);
    toast(T('åˆªé™¤å¤±æ•—: ') + err.message, 'error');
  }
}

// v25: æ‰¹é‡å°å‡º
async function batchExportChars(){
  if(selectedCharIds.size === 0){
    toast(T('è«‹å…ˆé¸æ“‡è§’è‰²'), 'warning');
    return;
  }
  
  showLoading(T('æ­£åœ¨å°å‡º...'));
  
  try {
    const chars = [];
    for(const charId of selectedCharIds){
      const char = await db.characters.get(charId);
      if(char) chars.push(char);
    }
    
    const exportData = {
      format: 'zhimeng_characters_v2',
      exportedAt: new Date().toISOString(),
      storyTitle: story.title,
      characters: chars.map(c => ({
        name: c.name,
        title: c.title || '',
        avatar: c.avatar || 'ğŸ‘¤',
        category: c.category || 'supporting',
        description: c.description || '',
        personality: c.personality || '',
        tags: c.tags || [],
        stats: c.stats || {},
        first_mes: c.first_mes || '',
        alternate_greetings: c.alternate_greetings || [],
        scenario: c.scenario || '',
        mes_example: c.mes_example || '',
        system_prompt: c.system_prompt || '',
        post_history_instructions: c.post_history_instructions || '',
        character_book: c.character_book || null,
        relationships: c.relationships || [],
        expressions: c.expressions || [],
        creator: c.creator || '',
        character_version: c.character_version || '1.0'
      }))
    };
    
    const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `è§’è‰²å°å‡º_${selectedCharIds.size}å€‹_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    hideLoading();
    toast(T(`å·²å°å‡º ${selectedCharIds.size} å€‹è§’è‰²`), 'success');
  } catch(err){
    hideLoading();
    console.error('Batch export error:', err);
    toast(T('å°å‡ºå¤±æ•—: ') + err.message, 'error');
  }
}

// èˆŠç‰ˆæ¸²æŸ“å‡½æ•¸ï¼ˆä¿ç•™å…¼å®¹ï¼‰
function renderCharacterCard(char){
  const stats = char.stats || {};
  const tags = char.tags || [];
  const relations = char.relations || [];
  
  // ç²å–å¿«é€Ÿé è¦½çš„é—œéµæ•¸å€¼
  const quickStats = [];
  if(stats['å¥½æ„Ÿ'] !== undefined || stats['è¡¨é¢å¥½æ„Ÿ'] !== undefined){
    const favor = stats['è¡¨é¢å¥½æ„Ÿ'] || stats['å¥½æ„Ÿ'] || 0;
    quickStats.push(`<div class="char-quick-item"><span>ğŸ’œ</span><span class="char-quick-val">${favor}</span></div>`);
  }
  if(stats['çœŸå¯¦å¥½æ„Ÿ'] !== undefined){
    const realFavor = stats['çœŸå¯¦å¥½æ„Ÿ'];
    const color = realFavor > 50 ? 'var(--success)' : realFavor > 20 ? 'var(--warning)' : 'var(--error)';
    quickStats.push(`<div class="char-quick-item"><span>â¤ï¸</span><span class="char-quick-val" style="color:${color}">${realFavor}</span></div>`);
  }
  if(stats['å¿ èª '] !== undefined){
    const loyalty = stats['å¿ èª '];
    const color = loyalty > 50 ? 'var(--success)' : 'var(--error)';
    quickStats.push(`<div class="char-quick-item"><span>ğŸ¤</span><span class="char-quick-val" style="color:${color}">${loyalty}</span></div>`);
  }
  if(stats['é‡å¿ƒ'] !== undefined){
    quickStats.push(`<div class="char-quick-item"><span>ğŸ”¥</span><span class="char-quick-val" style="color:var(--warning)">${stats['é‡å¿ƒ']}</span></div>`);
  }
  // å…¶ä»–å¸¸è¦‹å±¬æ€§
  const otherKeys = Object.keys(stats).filter(k => !['å¥½æ„Ÿ','è¡¨é¢å¥½æ„Ÿ','çœŸå¯¦å¥½æ„Ÿ','å¿ èª ','é‡å¿ƒ'].includes(k));
  otherKeys.slice(0,2).forEach(k => {
    quickStats.push(`<div class="char-quick-item"><span>ğŸ“Š</span><span class="char-quick-val">${stats[k]}</span></div>`);
  });
  
  // æ§‹å»ºå±¬æ€§æ¢
  const statBars = Object.entries(stats).map(([key, val]) => {
    const numVal = parseInt(val) || 0;
    let colorClass = 'purple';
    if(['é‡å¿ƒ','æ•µæ„','å±éšª'].some(k => key.includes(k))) colorClass = 'red';
    else if(['å¿ èª ','å¥½æ„Ÿ','ä¿¡ä»»'].some(k => key.includes(k))) colorClass = numVal > 50 ? 'green' : 'red';
    else if(['æ™ºè¬€','æ™ºåŠ›','é­…åŠ›'].some(k => key.includes(k))) colorClass = 'blue';
    else if(['å®¹è²Œ','é­…åŠ›'].some(k => key.includes(k))) colorClass = 'pink';
    else if(['å®¶ä¸–','è²¡å¯Œ','åœ°ä½'].some(k => key.includes(k))) colorClass = 'gold';
    return `<div class="char-stat-bar">
      <div class="char-stat-header">
        <span class="char-stat-label">${key}</span>
        <span class="char-stat-value">${val}</span>
      </div>
      <div class="char-stat-track"><div class="char-stat-fill ${colorClass}" style="width:${Math.min(100,numVal)}%"></div></div>
    </div>`;
  }).join('');
  
  // æ¨™ç±¤
  const tagHtml = tags.map(t => {
    let cls = '';
    if(['å±éšª','é‡å¿ƒ','æ•µå°','é™°éšª'].some(k => t.includes(k))) cls = 'danger';
    else if(['è­¦å‘Š','æ³¨æ„','å°å¿ƒ'].some(k => t.includes(k))) cls = 'warning';
    else if(['å‹å¥½','å¿ èª ','å¯ä¿¡'].some(k => t.includes(k))) cls = 'success';
    else cls = 'info';
    return `<span class="char-tag ${cls}">${esc(t)}</span>`;
  }).join('');
  
  // é—œä¿‚
  const relationHtml = relations.map(r => `
    <div class="char-relation">
      <div class="char-relation-avatar" style="background:linear-gradient(135deg,${r.type==='æ•µå°'?'#ef4444,#f87171':r.type==='å‹å¥½'?'#22c55e,#4ade80':'#3b82f6,#60a5fa'})">
        ${r.avatar || 'ğŸ‘¤'}
      </div>
      <div class="char-relation-info">
        <div class="char-relation-name">${esc(r.name)}</div>
        <div class="char-relation-type">${esc(r.description || r.type || '')}</div>
      </div>
      <span class="char-relation-status ${r.type==='æ•µå°'?'enemy':r.type==='å‹å¥½'?'ally':'neutral'}">${esc(r.type || 'ä¸­ç«‹')}</span>
    </div>
  `).join('');
  
  return `<div class="char-card" id="char-${char.id}" onclick="toggleCharCard('${char.id}')">
    <div class="char-header">
      <div class="char-avatar" style="background:linear-gradient(135deg,${char.color||'var(--primary)'},${char.colorLight||'var(--primary-light)'})" onclick="event.stopPropagation();uploadCharAvatar('${char.id}')">
        ${char.avatarImage ? `<img src="${char.avatarImage}" alt="${esc(char.name)}">` : (char.avatar || 'ğŸ‘¤')}
        ${char.rank ? `<span class="char-avatar-rank">${esc(char.rank)}</span>` : ''}
        <div class="upload-btn">ğŸ“·</div>
      </div>
      <div class="char-info">
        <div class="char-name">
          ${esc(char.name)}
          ${char.title ? `<span class="char-title">${esc(char.title)}</span>` : ''}
        </div>
        <div class="char-brief">${esc(char.brief || char.description || '')}</div>
        <div class="char-quick">${quickStats.join('')}</div>
      </div>
      <div class="char-expand">â–¼</div>
    </div>
    <div class="char-content">
      <div class="char-inner">
        <div class="char-tabs">
          <div class="char-tab active" onclick="event.stopPropagation();switchCharTab('${char.id}','basic')">åŸºæœ¬</div>
          <div class="char-tab" onclick="event.stopPropagation();switchCharTab('${char.id}','stats')">å±¬æ€§</div>
          <div class="char-tab" onclick="event.stopPropagation();switchCharTab('${char.id}','relation')">é—œä¿‚</div>
        </div>
        <div class="char-tab-content active" id="char-${char.id}-basic">
          ${char.description ? `<div class="char-desc">${esc(char.description)}</div>` : ''}
          ${tagHtml ? `<div class="char-tags">${tagHtml}</div>` : ''}
          ${char.extraInfo ? `<div class="char-mini-stats">${Object.entries(char.extraInfo).map(([k,v])=>`<div class="char-mini-stat"><div class="char-mini-val">${esc(String(v))}</div><div class="char-mini-label">${esc(k)}</div></div>`).join('')}</div>` : ''}
        </div>
        <div class="char-tab-content" id="char-${char.id}-stats">
          <div class="char-section">
            <div class="char-section-title">å±¬æ€§æ•¸å€¼</div>
            ${statBars || '<div style="font-size:12px;color:var(--text-tertiary)">æš«ç„¡å±¬æ€§æ•¸æ“š</div>'}
          </div>
        </div>
        <div class="char-tab-content" id="char-${char.id}-relation">
          <div class="char-section">
            <div class="char-section-title">äººç‰©é—œä¿‚</div>
            ${relationHtml || '<div style="font-size:12px;color:var(--text-tertiary)">æš«ç„¡é—œä¿‚æ•¸æ“š</div>'}
          </div>
        </div>
        <div class="char-actions">
          <button class="char-action-btn secondary" onclick="event.stopPropagation();showCharHistory('${char.id}')">ğŸ“œ æ­·å²</button>
          <button class="char-action-btn primary" onclick="event.stopPropagation();showCharDetail('${char.id}')">ğŸ“ è©³æƒ…</button>
        </div>
      </div>
    </div>
  </div>`;
}

// å±•é–‹/æ”¶èµ·è§’è‰²å¡
function toggleCharCard(charId){
  const card = document.getElementById('char-'+charId);
  if(card) card.classList.toggle('expanded');
}

// åˆ‡æ›è§’è‰²Tab
function switchCharTab(charId, tabName){
  const card = document.getElementById('char-'+charId);
  if(!card) return;
  card.querySelectorAll('.char-tab').forEach((t,i) => {
    t.classList.toggle('active', t.textContent.includes(tabName==='basic'?'åŸºæœ¬':tabName==='stats'?'å±¬æ€§':'é—œä¿‚'));
  });
  card.querySelectorAll('.char-tab-content').forEach(c => c.classList.remove('active'));
  const target = document.getElementById(`char-${charId}-${tabName}`);
  if(target) target.classList.add('active');
}

// åˆ·æ–°/æ›´æ–°è§’è‰²ç‹€æ…‹ï¼ˆAIè§£æï¼‰
function refreshCharacters(){
  if(!story){toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'),'warning');return;}
  if(!msgs.length){toast(T('æ•…äº‹å…§å®¹ç‚ºç©ºï¼Œè«‹å…ˆé–‹å§‹æ•…äº‹'),'warning');return;}
  document.getElementById('char-update-result').textContent='é»æ“Šã€Œé–‹å§‹åˆ†æã€è®“ AI è­˜åˆ¥è§’è‰²...';
  document.getElementById('char-update-btn').textContent='é–‹å§‹åˆ†æ';
  document.getElementById('char-update-btn').disabled=false;
  showModal('char-update-modal');
}

async function doCharacterUpdate(){
  const resultEl = document.getElementById('char-update-result');
  const btn = document.getElementById('char-update-btn');
  btn.disabled = true;
  btn.textContent = 'åˆ†æä¸­...';
  resultEl.textContent = 'æ­£åœ¨åˆ†ææ•…äº‹å…§å®¹ï¼Œè­˜åˆ¥è§’è‰²...';
  
  // æ§‹å»ºæç¤ºè©
  const prompt = `ä½ æ˜¯ä¸€å€‹è§’è‰²ç‹€æ…‹æå–åŠ©æ‰‹ã€‚è«‹åˆ†æä»¥ä¸‹æ•…äº‹å…§å®¹ï¼Œè­˜åˆ¥æ‰€æœ‰å‡ºç¾çš„é‡è¦è§’è‰²ï¼Œä¸¦æå–ä»–å€‘çš„ç‹€æ…‹ä¿¡æ¯ã€‚

è«‹ä»¥ JSON æ ¼å¼è¿”å›ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
\`\`\`json
{
  "characters": [
    {
      "name": "è§’è‰²å",
      "title": "é ­éŠœ/èº«ä»½ï¼ˆå¦‚çš‡å¤«ã€é¸ä¾ç­‰ï¼‰",
      "rank": "å“ç´šï¼ˆå¦‚ä¸€å“ã€å…­å“ç­‰ï¼Œæ²’æœ‰å‰‡ç•™ç©ºï¼‰",
      "avatar": "ä¸€å€‹ä»£è¡¨è§’è‰²çš„emoji",
      "brief": "ä¸€å¥è©±ç°¡ä»‹",
      "description": "è©³ç´°æè¿°ï¼ˆæ€§æ ¼ã€èƒŒæ™¯ã€ç‰¹é»ï¼‰",
      "stats": {
        "å±¬æ€§å": æ•¸å€¼ï¼ˆ0-100ï¼‰
      },
      "tags": ["æ¨™ç±¤1", "æ¨™ç±¤2"],
      "relations": [
        {"name": "é—œä¿‚å°è±¡", "type": "å‹å¥½/æ•µå°/ä¸­ç«‹", "description": "é—œä¿‚æè¿°"}
      ],
      "extraInfo": {
        "å¹´é½¡": "19æ­²",
        "å…¶ä»–ä¿¡æ¯": "å€¼"
      }
    }
  ]
}
\`\`\`

æ ¹æ“šæ•…äº‹é¡å‹è‡ªå‹•åˆ¤æ–·åˆé©çš„å±¬æ€§ï¼š
- å¾Œå®®/å®®é¬¥ï¼šå¥½æ„Ÿã€è¡¨é¢å¥½æ„Ÿã€çœŸå¯¦å¥½æ„Ÿã€å¿ èª ã€é‡å¿ƒã€å¯µæ„›åº¦ç­‰
- ä¿®ä»™/ç„å¹»ï¼šå¢ƒç•Œã€éˆåŠ›ã€å£½å…ƒã€åŠŸæ³•ç­‰ç´šç­‰
- æœ«æ—¥/ç”Ÿå­˜ï¼šç”Ÿå‘½ã€é£¢é¤“ã€ç²¾ç¥ã€æ„ŸæŸ“åº¦ç­‰
- å†’éšª/RPGï¼šHPã€MPã€åŠ›é‡ã€æ•æ·ã€ç­‰ç´šç­‰

æ•…äº‹å…§å®¹ï¼š
${msgs.slice(-30).map(m=>(m.role==='user'?'ã€ç©å®¶ã€‘':'ã€AIã€‘')+m.content).join('\n\n')}

è«‹åªè¿”å›JSONï¼Œä¸è¦å…¶ä»–è§£é‡‹ã€‚`;

  try{
    const resp = await callApi(prompt);
    let content = resp.content;
    resultEl.textContent = 'è§£æAIå›è¦†...';
    
    // æå–JSON
    const jsonMatch = content.match(/```json\s*([\s\S]*?)\s*```/) || content.match(/\{[\s\S]*"characters"[\s\S]*\}/);
    if(!jsonMatch){
      resultEl.textContent = 'âŒ AI å›è¦†æ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•è§£æè§’è‰²æ•¸æ“š\n\nåŸå§‹å›è¦†ï¼š\n' + content.slice(0,500);
      btn.disabled = false;
      btn.textContent = 'é‡è©¦';
      return;
    }
    
    const jsonStr = jsonMatch[1] || jsonMatch[0];
    const data = JSON.parse(jsonStr);
    
    if(!data.characters || !data.characters.length){
      resultEl.textContent = 'âŒ æœªè­˜åˆ¥åˆ°è§’è‰²ï¼Œè«‹ç¢ºä¿æ•…äº‹ä¸­æœ‰è§’è‰²å‡ºç¾';
      btn.disabled = false;
      btn.textContent = 'é‡è©¦';
      return;
    }
    
    resultEl.textContent = `âœ… è­˜åˆ¥åˆ° ${data.characters.length} å€‹è§’è‰²ï¼Œæ­£åœ¨ä¿å­˜...`;
    
    // ç²å–ç¾æœ‰è§’è‰²
    const existing = await db.characters.where('storyId').equals(story.id).toArray();
    const existingMap = {};
    existing.forEach(c => existingMap[c.name] = c);
    
    // æ›´æ–°æˆ–æ–°å¢è§’è‰²
    for(const char of data.characters){
      const existingChar = existingMap[char.name];
      if(existingChar){
        // è¨˜éŒ„æ­·å²è®ŠåŒ–
        const oldStats = existingChar.stats || {};
        const newStats = char.stats || {};
        const changes = [];
        for(const [key, newVal] of Object.entries(newStats)){
          const oldVal = oldStats[key];
          if(oldVal !== undefined && oldVal !== newVal){
            changes.push({attr: key, from: oldVal, to: newVal});
          }
        }
        if(changes.length){
          await db.characterHistory.add({
            id: crypto.randomUUID(),
            storyId: story.id,
            characterId: existingChar.id,
            changes,
            createdAt: Date.now()
          });
        }
        // æ›´æ–°è§’è‰²
        await db.characters.update(existingChar.id, {
          ...char,
          id: existingChar.id,
          storyId: story.id,
          updatedAt: Date.now()
        });
      }else{
        // æ–°å¢è§’è‰²
        await db.characters.add({
          ...char,
          id: crypto.randomUUID(),
          storyId: story.id,
          createdAt: Date.now(),
          updatedAt: Date.now()
        });
      }
    }
    
    resultEl.textContent = `âœ… æˆåŠŸæ›´æ–° ${data.characters.length} å€‹è§’è‰²ï¼`;
    closeModal('char-update-modal');
    renderCharacters();
    toast(`å·²æ›´æ–° ${data.characters.length} å€‹è§’è‰²`,'success');
    
  }catch(e){
    console.error('Character update error:', e);
    resultEl.textContent = 'âŒ æ›´æ–°å¤±æ•—: ' + e.message;
    btn.disabled = false;
    btn.textContent = 'é‡è©¦';
  }
}

// æ‰‹å‹•æ·»åŠ è§’è‰²
let editingCharacterId = null; // è¨˜éŒ„æ­£åœ¨ç·¨è¼¯çš„è§’è‰²ID
let charAltGreetings = []; // æ›¿ä»£é–‹å ´ç™½æ•¸çµ„
let charLorebookEntries = []; // è§’è‰²Lorebookæ¢ç›®

function addCharacterManual(){
  if(!story){toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'),'warning');return;}
  editingCharacterId = null;
  resetCharEditForm();
  document.getElementById('char-modal-title').textContent = 'â• æ·»åŠ è§’è‰²';
  showModal('char-add-modal');
}

// é‡ç½®è¡¨å–®
function resetCharEditForm(){
  // å®‰å…¨è¨­ç½®å€¼çš„è¼”åŠ©å‡½æ•¸
  const setVal = (id, val) => {
    const el = document.getElementById(id);
    if(el) el.value = val;
  };
  
  setVal('char-add-name', '');
  setVal('char-add-title', '');
  setVal('char-add-avatar', '');
  setVal('char-add-category', 'supporting');
  setVal('char-add-desc', '');
  setVal('char-add-personality', '');
  setVal('char-add-tags', '');
  setVal('char-add-firstmes', '');
  setVal('char-add-scenario', '');
  setVal('char-add-example', '');
  setVal('char-add-sysprompt', '');
  setVal('char-add-posthistory', '');
  setVal('char-add-creatornotes', '');
  setVal('char-add-creator', '');
  setVal('char-add-version', '1.0');
  setVal('char-add-lore-trigger', 'scene');
  setVal('char-add-stats', '');
  
  // é‡ç½®æ›¿ä»£é–‹å ´ç™½
  charAltGreetings = [];
  renderAltGreetings();
  
  // é‡ç½®Lorebookæ¢ç›®
  charLorebookEntries = [];
  renderCharLorebookEntries();
  
  // v25: é‡ç½®é—œä¿‚æ•¸æ“š
  charRelationships = [];
  renderCharRelationships();
  
  // v25: é‡ç½®è¡¨æƒ…æ•¸æ“š
  charExpressions = [];
  renderCharExpressions();
  const exprModeEl = document.getElementById('char-add-expr-mode');
  if(exprModeEl) exprModeEl.value = 'manual';
  
  // é‡ç½®é¢æ¿ç‹€æ…‹ï¼ˆåªå±•é–‹åŸºæœ¬ä¿¡æ¯ï¼‰
  document.querySelectorAll('.char-panel').forEach(p => {
    const panel = p.dataset.panel;
    const content = p.querySelector('.char-panel-content');
    const arrow = p.querySelector('.char-panel-arrow');
    if(content && arrow){
      if(panel === 'basic'){
        content.style.display = 'block';
        arrow.textContent = 'â–¼';
        p.classList.add('expanded');
      } else {
        content.style.display = 'none';
        arrow.textContent = 'â–¶';
        p.classList.remove('expanded');
      }
    }
  });
  
  updateCharTokenCount();
}

// é—œé–‰è§’è‰²ç·¨è¼¯æ¨¡æ…‹æ¡†
function closeCharEditModal(){
  closeModal('char-add-modal');
  editingCharacterId = null;
}

// åˆ‡æ›é¢æ¿å±•é–‹/æŠ˜ç–Š
function toggleCharPanel(panelName){
  const panel = document.querySelector(`.char-panel[data-panel="${panelName}"]`);
  if(!panel) return;
  
  const content = panel.querySelector('.char-panel-content');
  const arrow = panel.querySelector('.char-panel-arrow');
  
  if(content.style.display === 'none'){
    content.style.display = 'block';
    arrow.textContent = 'â–¼';
    panel.classList.add('expanded');
  } else {
    content.style.display = 'none';
    arrow.textContent = 'â–¶';
    panel.classList.remove('expanded');
  }
}

// æ·»åŠ æ›¿ä»£é–‹å ´ç™½
function addAltGreeting(){
  charAltGreetings.push('');
  renderAltGreetings();
}

// æ¸²æŸ“æ›¿ä»£é–‹å ´ç™½
function renderAltGreetings(){
  const container = document.getElementById('char-alt-greetings');
  if(!container) return;
  
  container.innerHTML = charAltGreetings.map((g, i) => `
    <div class="alt-greeting-item">
      <textarea class="form-textarea" placeholder="æ›¿ä»£é–‹å ´ç™½ ${i + 1}..." oninput="charAltGreetings[${i}]=this.value">${esc(g)}</textarea>
      <button class="delete-btn" onclick="removeAltGreeting(${i})">âœ•</button>
    </div>
  `).join('');
}

// ç§»é™¤æ›¿ä»£é–‹å ´ç™½
function removeAltGreeting(index){
  charAltGreetings.splice(index, 1);
  renderAltGreetings();
}

// æ·»åŠ è§’è‰²Lorebookæ¢ç›®
function addCharLorebookEntry(){
  charLorebookEntries.push({
    id: crypto.randomUUID(),
    keys: [],
    content: '',
    enabled: true,
    priority: 10
  });
  renderCharLorebookEntries();
}

// æ¸²æŸ“è§’è‰²Lorebookæ¢ç›®
function renderCharLorebookEntries(){
  const container = document.getElementById('char-lorebook-entries');
  if(!container) return;
  
  container.innerHTML = charLorebookEntries.map((entry, i) => `
    <div class="char-lore-entry">
      <button class="delete-btn" onclick="removeCharLorebookEntry(${i})">âœ•</button>
      <div class="form-group" style="margin-bottom:8px">
        <input type="text" class="form-input" placeholder="è§¸ç™¼è©ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰" 
               value="${esc(entry.keys?.join(', ') || '')}"
               oninput="charLorebookEntries[${i}].keys=this.value.split(',').map(s=>s.trim()).filter(s=>s)"
               style="font-size:13px;padding:8px 12px">
      </div>
      <textarea class="form-textarea" placeholder="å…§å®¹..." rows="2"
                oninput="charLorebookEntries[${i}].content=this.value"
                style="font-size:13px;min-height:60px">${esc(entry.content || '')}</textarea>
    </div>
  `).join('');
}

// ç§»é™¤è§’è‰²Lorebookæ¢ç›®
function removeCharLorebookEntry(index){
  charLorebookEntries.splice(index, 1);
  renderCharLorebookEntries();
}

// Token è¨ˆæ•¸ï¼ˆç°¡æ˜“ä¼°ç®—ï¼‰
function updateCharTokenCount(){
  const desc = document.getElementById('char-add-desc')?.value || '';
  const firstmes = document.getElementById('char-add-firstmes')?.value || '';
  const example = document.getElementById('char-add-example')?.value || '';
  const sysprompt = document.getElementById('char-add-sysprompt')?.value || '';
  
  // ç°¡æ˜“ä¼°ç®—ï¼šä¸­æ–‡ç´„1.5å­—ç¬¦/tokenï¼Œè‹±æ–‡ç´„4å­—ç¬¦/token
  const estimateTokens = (text) => {
    const chineseChars = (text.match(/[\u4e00-\u9fff]/g) || []).length;
    const otherChars = text.length - chineseChars;
    return Math.ceil(chineseChars / 1.5 + otherChars / 4);
  };
  
  const descTokens = estimateTokens(desc);
  const firstmesTokens = estimateTokens(firstmes);
  const exampleTokens = estimateTokens(example);
  const syspromptTokens = estimateTokens(sysprompt);
  const total = descTokens + firstmesTokens + exampleTokens + syspromptTokens;
  
  // æ›´æ–°é¡¯ç¤º
  const descHint = document.getElementById('desc-tokens');
  const firstmesHint = document.getElementById('firstmes-tokens');
  const exampleHint = document.getElementById('example-tokens');
  const syspromptHint = document.getElementById('sysprompt-tokens');
  const totalHint = document.getElementById('char-token-count');
  
  if(descHint) descHint.textContent = descTokens > 0 ? `(~${descTokens} tokens)` : '';
  if(firstmesHint) firstmesHint.textContent = firstmesTokens > 0 ? `(~${firstmesTokens} tokens)` : '';
  if(exampleHint) exampleHint.textContent = exampleTokens > 0 ? `(~${exampleTokens} tokens)` : '';
  if(syspromptHint) syspromptHint.textContent = syspromptTokens > 0 ? `(~${syspromptTokens} tokens)` : '';
  if(totalHint) totalHint.textContent = total > 0 ? `ç¸½è¨ˆ ~${total} tokens` : '';
}

// å¯è¦–åŒ–å°è©±ç¤ºä¾‹ç·¨è¼¯å™¨ï¼ˆç°¡æ˜“ç‰ˆï¼‰
function openVisualExampleEditor(){
  const current = document.getElementById('char-add-example')?.value || '';
  toast(T('å¯è¦–åŒ–ç·¨è¼¯å™¨é–‹ç™¼ä¸­ï¼Œè«‹ç›´æ¥åœ¨æ–‡æœ¬æ¡†ä¸­ç·¨è¼¯'), 'info');
}

// ç²å–ç•¶å‰æ´»å‹•çš„APIé è¨­
async function getActivePreset(){
  const preset = await db.apiPresets.filter(p => p.isActive).first();
  return preset;
}

// AI è¼”åŠ©å¡«å¯«
async function aiGenerateCharFields(){
  const name = document.getElementById('char-add-name')?.value?.trim();
  const desc = document.getElementById('char-add-desc')?.value?.trim();
  
  if(!name && !desc){
    toast(T('è«‹å…ˆå¡«å¯«è§’è‰²åç¨±æˆ–æè¿°'), 'warning');
    return;
  }
  
  const preset = await getActivePreset();
  if(!preset){
    toast(T('è«‹å…ˆè¨­ç½® API'), 'warning');
    return;
  }
  
  if(!preset.apiKey){
    toast(T('è«‹å…ˆè¨­ç½® API Key'), 'warning');
    return;
  }
  
  showLoading(T('AI æ­£åœ¨ç”Ÿæˆè§’è‰²è¨­å®š...'));
  
  try {
    const prompt = `æ ¹æ“šä»¥ä¸‹è§’è‰²ä¿¡æ¯ï¼Œå¹«æˆ‘ç”Ÿæˆå®Œæ•´çš„è§’è‰²è¨­å®šï¼š

è§’è‰²åç¨±ï¼š${name || '(æœªå¡«å¯«)'}
å·²æœ‰æè¿°ï¼š${desc || '(æœªå¡«å¯«)'}

è«‹ç”Ÿæˆä»¥ä¸‹å…§å®¹ï¼ˆJSONæ ¼å¼ï¼‰ï¼š
{
  "personality": "æ€§æ ¼æ‘˜è¦ï¼ˆä¸€å¥è©±æè¿°æ€§æ ¼ç‰¹é»ï¼‰",
  "first_mes": "é–‹å ´ç™½ï¼ˆè§’è‰²çš„ç¬¬ä¸€æ¢æ¶ˆæ¯ï¼Œç”¨*æè¿°å‹•ä½œ*ï¼Œç”¨ã€Œå°è©±ã€ï¼‰",
  "scenario": "å ´æ™¯æè¿°ï¼ˆå°è©±ç™¼ç”Ÿçš„èƒŒæ™¯ï¼‰",
  "tags": ["æ¨™ç±¤1", "æ¨™ç±¤2", "æ¨™ç±¤3"]
}

åªè¼¸å‡ºJSONï¼Œä¸è¦å…¶ä»–å…§å®¹ã€‚`;

    const response = await callLLMForJSON(prompt, preset);
    
    if(response){
      if(response.personality && !document.getElementById('char-add-personality')?.value){
        document.getElementById('char-add-personality').value = response.personality;
      }
      if(response.first_mes && !document.getElementById('char-add-firstmes')?.value){
        document.getElementById('char-add-firstmes').value = response.first_mes;
      }
      if(response.scenario && !document.getElementById('char-add-scenario')?.value){
        document.getElementById('char-add-scenario').value = response.scenario;
      }
      if(response.tags && !document.getElementById('char-add-tags')?.value){
        document.getElementById('char-add-tags').value = response.tags.join(', ');
      }
      
      // å±•é–‹å°è©±è¨­ç½®é¢æ¿
      const dialoguePanel = document.querySelector('.char-panel[data-panel="dialogue"]');
      if(dialoguePanel){
        const content = dialoguePanel.querySelector('.char-panel-content');
        const arrow = dialoguePanel.querySelector('.char-panel-arrow');
        content.style.display = 'block';
        arrow.textContent = 'â–¼';
        dialoguePanel.classList.add('expanded');
      }
      
      updateCharTokenCount();
      toast(T('AI å·²ç”Ÿæˆè§’è‰²è¨­å®š'), 'success');
    }
    
    hideLoading();
  } catch(err){
    hideLoading();
    console.error('AI generate error:', err);
    toast(T('AI ç”Ÿæˆå¤±æ•—: ') + err.message, 'error');
  }
}

// èª¿ç”¨LLMç²å–JSONéŸ¿æ‡‰
async function callLLMForJSON(prompt, preset){
  const messages = [{role: 'user', content: prompt}];
  
  let apiUrl, headers, body;
  
  if(preset.type === 'anthropic'){
    apiUrl = 'https://api.anthropic.com/v1/messages';
    headers = {
      'Content-Type': 'application/json',
      'x-api-key': preset.apiKey,
      'anthropic-version': '2023-06-01'
    };
    body = {
      model: preset.model || 'claude-3-haiku-20240307',
      max_tokens: 1000,
      messages
    };
  } else if(preset.type === 'openai'){
    apiUrl = preset.baseUrl ? `${preset.baseUrl}/chat/completions` : 'https://api.openai.com/v1/chat/completions';
    headers = {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${preset.apiKey}`
    };
    body = {
      model: preset.model || 'gpt-3.5-turbo',
      max_tokens: 1000,
      messages
    };
  } else if(preset.type === 'custom'){
    apiUrl = preset.baseUrl;
    headers = {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${preset.apiKey}`
    };
    body = {
      model: preset.model,
      max_tokens: 1000,
      messages
    };
  }
  
  const res = await fetch(apiUrl, {
    method: 'POST',
    headers,
    body: JSON.stringify(body)
  });
  
  if(!res.ok){
    throw new Error(`API éŒ¯èª¤: ${res.status}`);
  }
  
  const data = await res.json();
  let content = '';
  
  if(preset.type === 'anthropic'){
    content = data.content?.[0]?.text || '';
  } else {
    content = data.choices?.[0]?.message?.content || '';
  }
  
  // å˜—è©¦æå–JSON
  const jsonMatch = content.match(/\{[\s\S]*\}/);
  if(jsonMatch){
    return JSON.parse(jsonMatch[0]);
  }
  
  return null;
}

async function saveCharacterManual(){
  const getVal = (id) => document.getElementById(id)?.value?.trim() || '';
  
  const name = getVal('char-add-name');
  if(!name){toast(T('è«‹è¼¸å…¥è§’è‰²åç¨±'),'warning');return;}
  
  // æ”¶é›†æ‰€æœ‰å­—æ®µ
  const title = getVal('char-add-title');
  const avatar = getVal('char-add-avatar') || 'ğŸ‘¤';
  const category = getVal('char-add-category') || 'supporting';
  const desc = getVal('char-add-desc');
  const personality = getVal('char-add-personality');
  const tagsText = getVal('char-add-tags');
  const tags = tagsText ? tagsText.split(',').map(s => s.trim()).filter(s => s) : [];
  
  // å°è©±è¨­ç½®
  const first_mes = getVal('char-add-firstmes');
  const scenario = getVal('char-add-scenario');
  const mes_example = getVal('char-add-example');
  const alternate_greetings = charAltGreetings.filter(g => g.trim());
  
  // é«˜ç´šè¨­ç½®
  const system_prompt = getVal('char-add-sysprompt');
  const post_history_instructions = getVal('char-add-posthistory');
  const creator_notes = getVal('char-add-creatornotes');
  const creator = getVal('char-add-creator');
  const character_version = getVal('char-add-version') || '1.0';
  
  // Lorebook
  const triggerMode = getVal('char-add-lore-trigger') || 'scene';
  const character_book = charLorebookEntries.length > 0 ? {
    entries: charLorebookEntries.filter(e => e.keys?.length > 0 || e.content),
    triggerMode
  } : null;
  
  // v25: é—œä¿‚æ•¸æ“š
  const relationships = charRelationships.filter(r => r.targetId);
  
  // v25: è¡¨æƒ…æ•¸æ“š
  const expressions = charExpressions;
  const expressionMode = document.getElementById('char-add-expr-mode')?.value || 'manual';
  
  // å±¬æ€§
  const statsText = getVal('char-add-stats');
  const stats = {};
  if(statsText){
    statsText.split('\n').forEach(line => {
      const [key, val] = line.split(':').map(s => s.trim());
      if(key && val) stats[key] = parseInt(val) || val;
    });
  }
  
  const now = Date.now();
  
  if(editingCharacterId){
    // æ›´æ–°ç¾æœ‰è§’è‰²
    await db.characters.update(editingCharacterId, {
      name, title, avatar, category, description: desc, personality, tags,
      first_mes, alternate_greetings, scenario, mes_example,
      system_prompt, post_history_instructions, creator_notes, creator, character_version,
      character_book, stats, relationships, expressions, expressionMode,
      updatedAt: now
    });
    toast(T('è§’è‰²å·²æ›´æ–°'), 'success');
  } else {
    // å‰µå»ºæ–°è§’è‰²
    const char = {
      id: crypto.randomUUID(),
      storyId: story.id,
      name, title, avatar, category, description: desc, personality, tags,
      first_mes, alternate_greetings, scenario, mes_example,
      system_prompt, post_history_instructions, creator_notes, creator, character_version,
      character_book, stats, relationships, expressions, expressionMode,
      createdAt: now,
      updatedAt: now
    };
    
    await db.characters.add(char);
    toast(T('è§’è‰²å·²æ·»åŠ '), 'success');
  }
  
  closeCharEditModal();
  renderCharacters();
}

// ============ è§’è‰²å¡å°å…¥/å°å‡ºç³»çµ± ============
function showCharacterMenu(){
  const menu = document.getElementById('char-menu');
  menu.style.top = '50px';
  menu.style.right = '16px';
  menu.style.left = 'auto';
  menu.classList.add('active');
}

async function exportAllCharacters(){
  if(!story){toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'),'warning');return;}
  const chars = await db.characters.where('storyId').equals(story.id).toArray();
  if(!chars.length){toast(T('æ²’æœ‰è§’è‰²å¯å°å‡º'),'warning');return;}
  
  // è½‰æ›ç‚ºé€šç”¨æ ¼å¼ï¼ˆå…¼å®¹ SillyTavernï¼‰
  const exportData = {
    format: 'zhimeng_characters_v1',
    exportedAt: new Date().toISOString(),
    storyTitle: story.title,
    characters: chars.map(c => ({
      name: c.name,
      title: c.title || '',
      avatar: c.avatar || 'ğŸ‘¤',
      description: c.description || '',
      personality: c.personality || '',
      stats: c.stats || {},
      tags: c.tags || [],
      relations: c.relations || [],
      mood: c.mood || '',
      note: c.note || '',
      location: c.location || ''
    }))
  };
  
  const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `è§’è‰²å¡_${story.title}_${new Date().toLocaleDateString()}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast(`å·²å°å‡º ${chars.length} ä½è§’è‰²`,'success');
}

function importCharacterCard(){
  if(!story){toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'),'warning');return;}
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json,.png'; // æ”¯æŒ JSON å’Œ PNGï¼ˆSillyTavern æ ¼å¼ï¼‰
  input.onchange = async e => {
    const file = e.target.files[0];
    if(!file) return;
    
    try {
      showLoading('æ­£åœ¨å°å…¥...');
      
      if(file.name.endsWith('.png')){
        // SillyTavern PNG æ ¼å¼ï¼ˆè§’è‰²å¡åµŒå…¥åœ¨ PNG å…ƒæ•¸æ“šä¸­ï¼‰
        await importSillyTavernPNG(file);
      } else {
        // JSON æ ¼å¼
        const text = await file.text();
        const data = JSON.parse(text);
        await importCharacterJSON(data);
      }
      
      hideLoading();
      renderCharacters();
    } catch(err) {
      hideLoading();
      console.error('Import error:', err);
      toast('å°å…¥å¤±æ•—: ' + err.message, 'error');
    }
  };
  input.click();
}

async function importCharacterJSON(data){
  let imported = 0;
  
  // æª¢æ¸¬æ ¼å¼
  if(data.format === 'zhimeng_characters_v1' && data.characters){
    // ç¹”å¤¢æ ¼å¼
    for(const c of data.characters){
      await addImportedCharacter(c);
      imported++;
    }
  } else if(data.spec === 'chara_card_v2' || data.data){
    // SillyTavern/Character Card V2 æ ¼å¼
    const charData = data.data || data;
    
    // å®Œæ•´æå– V2 æ‰€æœ‰å­—æ®µ
    const charToImport = {
      name: charData.name || data.name || 'æœªçŸ¥è§’è‰²',
      description: charData.description || data.description || '',
      personality: charData.personality || data.personality || '',
      tags: charData.tags || data.tags || [],
      avatar: 'ğŸ‘¤',
      
      // ğŸ†• V2 å­—æ®µ
      scenario: charData.scenario || '',
      first_mes: charData.first_mes || '',
      alternate_greetings: charData.alternate_greetings || [],
      mes_example: charData.mes_example || '',
      system_prompt: charData.system_prompt || '',
      post_history_instructions: charData.post_history_instructions || '',
      character_book: charData.character_book || null,
      creator_notes: charData.creator_notes || '',
      creator: charData.creator || '',
      character_version: charData.character_version || '1.0',
      
      // ç¹”å¤¢æ“´å±•å­—æ®µï¼ˆå¦‚æœæœ‰ï¼‰
      ...(charData.extensions?.zhimeng || {})
    };
    
    const result = await addImportedCharacter(charToImport);
    if(result) imported = 1;
  } else if(data.name){
    // ç°¡å–®æ ¼å¼ï¼ˆå–®å€‹è§’è‰²ï¼‰
    const result = await addImportedCharacter(data);
    if(result) imported = 1;
  } else if(Array.isArray(data)){
    // è§’è‰²æ•¸çµ„
    for(const c of data){
      if(c.name){
        const result = await addImportedCharacter(c);
        if(result) imported++;
      }
    }
  } else {
    throw new Error('ç„¡æ³•è­˜åˆ¥çš„è§’è‰²å¡æ ¼å¼');
  }
  
  if(imported > 0){
    toast(T(`å·²å°å…¥ ${imported} ä½è§’è‰²`),'success');
  } else {
    toast(T('å°å…¥å·²å–æ¶ˆ'),'info');
  }
}

async function importSillyTavernPNG(file){
  // è®€å– PNG ä¸­åµŒå…¥çš„è§’è‰²æ•¸æ“š
  // SillyTavern å°‡è§’è‰²æ•¸æ“šå­˜åœ¨ PNG çš„ tEXt chunk ä¸­
  const arrayBuffer = await file.arrayBuffer();
  const uint8Array = new Uint8Array(arrayBuffer);
  
  // æŸ¥æ‰¾ tEXt chunkï¼ˆåŒ…å« "chara" é—œéµå­—ï¼‰
  const textDecoder = new TextDecoder('utf-8');
  let charaData = null;
  
  // ç°¡åŒ–è™•ç†ï¼šæœç´¢ "chara" é—œéµå­—å¾Œçš„ base64 æ•¸æ“š
  const str = textDecoder.decode(uint8Array);
  const charaMatch = str.match(/chara\x00([A-Za-z0-9+/=]+)/);
  
  if(charaMatch){
    try {
      const base64 = charaMatch[1];
      const jsonStr = atob(base64);
      charaData = JSON.parse(jsonStr);
    } catch(e){
      console.error('Failed to parse embedded data:', e);
    }
  }
  
  if(!charaData){
    // å˜—è©¦ä½œç‚ºæ™®é€š JSON å°å…¥ï¼ˆç”¨æˆ¶å¯èƒ½é¸éŒ¯äº†æ–‡ä»¶ï¼‰
    throw new Error('ç„¡æ³•å¾ PNG ä¸­è®€å–è§’è‰²æ•¸æ“šï¼Œè«‹ç¢ºèªé€™æ˜¯æœ‰æ•ˆçš„è§’è‰²å¡åœ–ç‰‡');
  }
  
  await importCharacterJSON(charaData);
}

async function addImportedCharacter(c, skipConflictCheck = false){
  // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåè§’è‰²
  const existing = await db.characters.where('storyId').equals(story.id).filter(x => x.name === c.name).first();
  
  // è™•ç†é‡åè¡çª
  let finalName = c.name || 'æœªçŸ¥è§’è‰²';
  let useExistingId = false;
  
  if(existing && !skipConflictCheck){
    // é¡¯ç¤ºè¡çªè™•ç†é¸é …
    const action = await showImportConflictDialog(c.name);
    
    if(action === 'cancel'){
      return null; // å–æ¶ˆå°å…¥
    } else if(action === 'rename'){
      // è‡ªå‹•é‡å‘½å
      let suffix = 1;
      let newName = `${c.name}(${suffix})`;
      while(await db.characters.where('storyId').equals(story.id).filter(x => x.name === newName).first()){
        suffix++;
        newName = `${c.name}(${suffix})`;
      }
      finalName = newName;
    } else if(action === 'overwrite'){
      // è¦†è“‹ç¾æœ‰è§’è‰²
      useExistingId = true;
    }
  }
  
  // Character Card V2 å®Œæ•´å­—æ®µæ”¯æŒ
  const char = {
    // åŸºæœ¬ä¿¡æ¯
    id: useExistingId ? existing.id : crypto.randomUUID(),
    storyId: story.id,
    name: finalName,
    title: c.title || '',
    avatar: c.avatar || 'ğŸ‘¤',
    avatarImage: c.avatarImage || c.avatar_image || '',
    description: c.description || '',
    personality: c.personality || '',
    tags: c.tags || [],
    
    // ğŸ†• åˆ†é¡ç³»çµ±
    category: c.category || 'supporting', // protagonist/supporting/npc/custom
    
    // ğŸ†• é—œä¿‚ç³»çµ±
    relationships: c.relationships || c.relations || [],
    
    // ğŸ†• å°è©±è¨­ç½®ï¼ˆCharacter Card V2ï¼‰
    scenario: c.scenario || '',
    first_mes: c.first_mes || c.firstMessage || '',
    alternate_greetings: c.alternate_greetings || [],
    mes_example: c.mes_example || c.messageExample || '',
    
    // ğŸ†• é«˜ç´šè¨­ç½®ï¼ˆCharacter Card V2ï¼‰
    system_prompt: c.system_prompt || c.systemPrompt || '',
    post_history_instructions: c.post_history_instructions || c.postHistoryInstructions || '',
    
    // ğŸ†• è§’è‰²å°ˆå±¬ Lorebook
    character_book: c.character_book || null,
    
    // ğŸ†• è¡¨æƒ…ç³»çµ±
    expressions: c.expressions || [],
    expressionMode: c.expressionMode || 'manual', // manual/auto
    currentExpression: c.currentExpression || null,
    
    // ğŸ†• å‰µä½œè€…ä¿¡æ¯
    creator_notes: c.creator_notes || '',
    creator: c.creator || '',
    character_version: c.character_version || '1.0',
    
    // ç¾æœ‰å­—æ®µ
    stats: c.stats || {},
    mood: c.mood || '',
    note: c.note || '',
    location: c.location || '',
    
    // æ™‚é–“æˆ³
    createdAt: useExistingId ? existing.createdAt : Date.now(),
    updatedAt: Date.now()
  };
  
  await db.characters.put(char);
  return char;
}

// é¡¯ç¤ºå°å…¥è¡çªå°è©±æ¡†
function showImportConflictDialog(charName){
  return new Promise(resolve => {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000';
    modal.innerHTML = `
      <div class="modal" style="display:block;position:relative;transform:none;max-width:min(90%,360px)">
        <div class="modal-title">âš ï¸ è§’è‰²åç¨±è¡çª</div>
        <div style="padding:16px 0;text-align:center">
          <p style="margin-bottom:12px">è§’è‰²ã€Œ<strong>${esc(charName)}</strong>ã€å·²å­˜åœ¨</p>
          <p style="color:var(--text-secondary);font-size:14px">è«‹é¸æ“‡è™•ç†æ–¹å¼ï¼š</p>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;padding:0 0 16px">
          <button class="modal-btn" onclick="this.closest('.modal-overlay').dataset.action='overwrite';this.closest('.modal-overlay').remove()" style="padding:12px">
            ğŸ”„ è¦†è“‹ç¾æœ‰è§’è‰²
          </button>
          <button class="modal-btn secondary" onclick="this.closest('.modal-overlay').dataset.action='rename';this.closest('.modal-overlay').remove()" style="padding:12px">
            ğŸ“ é‡å‘½åç‚ºã€Œ${esc(charName)}(1)ã€
          </button>
          <button class="modal-btn cancel" onclick="this.closest('.modal-overlay').dataset.action='cancel';this.closest('.modal-overlay').remove()" style="padding:12px">
            âŒ å–æ¶ˆå°å…¥
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // ç›£è½ç§»é™¤äº‹ä»¶
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        mutation.removedNodes.forEach((node) => {
          if(node === modal){
            observer.disconnect();
            resolve(modal.dataset.action || 'cancel');
          }
        });
      });
    });
    observer.observe(document.body, {childList: true});
  });
}

async function exportSingleCharacter(charId){
  const char = await db.characters.get(charId);
  if(!char){toast(T('è§’è‰²ä¸å­˜åœ¨'),'error');return;}
  
  // å®Œæ•´çš„ Character Card V2 æ ¼å¼å°å‡º
  const exportData = {
    spec: 'chara_card_v2',
    spec_version: '2.0',
    data: {
      // åŸºæœ¬ä¿¡æ¯
      name: char.name,
      description: char.description || '',
      personality: char.personality || '',
      tags: char.tags || [],
      
      // ğŸ†• å°è©±è¨­ç½®ï¼ˆå°å‡ºå¯¦éš›æ•¸æ“šï¼‰
      scenario: char.scenario || '',
      first_mes: char.first_mes || '',
      alternate_greetings: char.alternate_greetings || [],
      mes_example: char.mes_example || '',
      
      // ğŸ†• é«˜ç´šè¨­ç½®ï¼ˆå°å‡ºå¯¦éš›æ•¸æ“šï¼‰
      system_prompt: char.system_prompt || '',
      post_history_instructions: char.post_history_instructions || '',
      
      // ğŸ†• è§’è‰²å°ˆå±¬ Lorebook
      character_book: char.character_book || null,
      
      // å‰µä½œè€…ä¿¡æ¯
      creator_notes: char.creator_notes || `å¾ç¹”å¤¢å°å‡º - ${story?.title || ''}`,
      creator: char.creator || 'ç¹”å¤¢',
      character_version: char.character_version || '1.0',
      
      // ç¹”å¤¢æ“´å±•å­—æ®µ
      extensions: {
        zhimeng: {
          title: char.title || '',
          avatar: char.avatar || 'ğŸ‘¤',
          avatarImage: char.avatarImage || '',
          category: char.category || 'supporting',
          relationships: char.relationships || [],
          expressions: char.expressions || [],
          expressionMode: char.expressionMode || 'manual',
          stats: char.stats || {},
          mood: char.mood || '',
          note: char.note || '',
          location: char.location || ''
        }
      }
    }
  };
  
  const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${char.name}_è§’è‰²å¡.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast(`å·²å°å‡ºè§’è‰²ã€Œ${char.name}ã€`,'success');
}

// ğŸ†• PNG è§’è‰²å¡å°å‡º
async function exportCharacterAsPNG(charId){
  const char = await db.characters.get(charId);
  if(!char){toast(T('è§’è‰²ä¸å­˜åœ¨'),'error');return;}
  
  showLoading(T('æ­£åœ¨ç”Ÿæˆ PNG è§’è‰²å¡...'));
  
  try {
    // æº–å‚™è§’è‰²æ•¸æ“š
    const charData = {
      spec: 'chara_card_v2',
      spec_version: '2.0',
      data: {
        name: char.name,
        description: char.description || '',
        personality: char.personality || '',
        tags: char.tags || [],
        scenario: char.scenario || '',
        first_mes: char.first_mes || '',
        alternate_greetings: char.alternate_greetings || [],
        mes_example: char.mes_example || '',
        system_prompt: char.system_prompt || '',
        post_history_instructions: char.post_history_instructions || '',
        character_book: char.character_book || null,
        creator_notes: char.creator_notes || `å¾ç¹”å¤¢å°å‡º`,
        creator: char.creator || 'ç¹”å¤¢',
        character_version: char.character_version || '1.0',
        extensions: {
          zhimeng: {
            title: char.title,
            avatar: char.avatar,
            category: char.category,
            relationships: char.relationships,
            expressions: char.expressions,
            stats: char.stats
          }
        }
      }
    };
    
    // å°‡æ•¸æ“šç·¨ç¢¼ç‚º base64
    const jsonStr = JSON.stringify(charData);
    const base64Data = btoa(unescape(encodeURIComponent(jsonStr)));
    
    // å‰µå»º canvas
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // å¦‚æœæœ‰é ­åƒåœ–ç‰‡ï¼Œä½¿ç”¨å®ƒï¼›å¦å‰‡ç”Ÿæˆé»˜èªåœ–ç‰‡
    if(char.avatarImage && char.avatarImage.startsWith('data:image')){
      // ä½¿ç”¨è§’è‰²é ­åƒ
      const img = new Image();
      img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        
        // å°å‡ºå¸¶å…ƒæ•¸æ“šçš„ PNG
        exportPNGWithMetadata(canvas, base64Data, char.name);
      };
      img.onerror = () => {
        // é ­åƒåŠ è¼‰å¤±æ•—ï¼Œä½¿ç”¨é»˜èªåœ–ç‰‡
        generateDefaultCharacterPNG(canvas, ctx, char, base64Data);
      };
      img.src = char.avatarImage;
    } else {
      // ç”Ÿæˆé»˜èªè§’è‰²å¡åœ–ç‰‡
      generateDefaultCharacterPNG(canvas, ctx, char, base64Data);
    }
  } catch(err) {
    hideLoading();
    console.error('PNG export error:', err);
    toast(T('PNG å°å‡ºå¤±æ•—: ') + err.message, 'error');
  }
}

// ç”Ÿæˆé»˜èªè§’è‰²å¡åœ–ç‰‡
function generateDefaultCharacterPNG(canvas, ctx, char, base64Data){
  canvas.width = 400;
  canvas.height = 600;
  
  // èƒŒæ™¯æ¼¸è®Š
  const gradient = ctx.createLinearGradient(0, 0, 0, 600);
  gradient.addColorStop(0, '#1a1a2e');
  gradient.addColorStop(1, '#16213e');
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, 400, 600);
  
  // è£é£¾é‚Šæ¡†
  ctx.strokeStyle = '#8b7cf7';
  ctx.lineWidth = 4;
  ctx.strokeRect(10, 10, 380, 580);
  
  // é ­åƒå€åŸŸï¼ˆä½¿ç”¨ emojiï¼‰
  ctx.fillStyle = '#252540';
  ctx.beginPath();
  ctx.arc(200, 150, 80, 0, Math.PI * 2);
  ctx.fill();
  
  ctx.font = '72px sans-serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(char.avatar || 'ğŸ‘¤', 200, 150);
  
  // è§’è‰²å
  ctx.fillStyle = '#e5e7eb';
  ctx.font = 'bold 32px sans-serif';
  ctx.fillText(char.name, 200, 280);
  
  // é ­éŠœ
  if(char.title){
    ctx.fillStyle = '#9ca3af';
    ctx.font = '18px sans-serif';
    ctx.fillText(char.title, 200, 320);
  }
  
  // åˆ†éš”ç·š
  ctx.strokeStyle = '#8b7cf7';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(50, 360);
  ctx.lineTo(350, 360);
  ctx.stroke();
  
  // æè¿°ï¼ˆæˆªå–å‰100å­—ï¼‰
  const desc = (char.description || '').slice(0, 100);
  if(desc){
    ctx.fillStyle = '#9ca3af';
    ctx.font = '14px sans-serif';
    ctx.textAlign = 'left';
    
    // è‡ªå‹•æ›è¡Œ
    const words = desc.split('');
    let line = '';
    let y = 400;
    const maxWidth = 320;
    
    for(let i = 0; i < words.length && y < 560; i++){
      const testLine = line + words[i];
      const metrics = ctx.measureText(testLine);
      if(metrics.width > maxWidth){
        ctx.fillText(line, 40, y);
        line = words[i];
        y += 24;
      } else {
        line = testLine;
      }
    }
    if(line && y < 560){
      ctx.fillText(line + (desc.length > 100 ? '...' : ''), 40, y);
    }
  }
  
  // åº•éƒ¨æ¨™è­˜
  ctx.fillStyle = '#6b7280';
  ctx.font = '12px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('ç¹”å¤¢ Character Card V2', 200, 580);
  
  // å°å‡º
  exportPNGWithMetadata(canvas, base64Data, char.name);
}

// å°‡å…ƒæ•¸æ“šåµŒå…¥ PNG ä¸¦å°å‡º
function exportPNGWithMetadata(canvas, base64Data, charName){
  // ç²å– PNG æ•¸æ“š
  canvas.toBlob(async blob => {
    try {
      const arrayBuffer = await blob.arrayBuffer();
      const uint8Array = new Uint8Array(arrayBuffer);
      
      // å‰µå»º tEXt chunk
      // tEXt chunk æ ¼å¼ï¼šé•·åº¦(4å­—ç¯€) + "tEXt"(4å­—ç¯€) + é—œéµå­— + null + æ•¸æ“š + CRC(4å­—ç¯€)
      const keyword = 'chara';
      const keywordBytes = new TextEncoder().encode(keyword);
      const dataBytes = new TextEncoder().encode(base64Data);
      
      // chunk å…§å®¹ = é—œéµå­— + nullåˆ†éš”ç¬¦ + æ•¸æ“š
      const chunkContent = new Uint8Array(keywordBytes.length + 1 + dataBytes.length);
      chunkContent.set(keywordBytes, 0);
      chunkContent[keywordBytes.length] = 0; // null åˆ†éš”ç¬¦
      chunkContent.set(dataBytes, keywordBytes.length + 1);
      
      // è¨ˆç®— CRC32
      const typeAndData = new Uint8Array(4 + chunkContent.length);
      typeAndData.set(new TextEncoder().encode('tEXt'), 0);
      typeAndData.set(chunkContent, 4);
      const crc = crc32(typeAndData);
      
      // æ§‹å»ºå®Œæ•´çš„ tEXt chunk
      const chunkLength = chunkContent.length;
      const textChunk = new Uint8Array(4 + 4 + chunkContent.length + 4);
      // é•·åº¦ï¼ˆå¤§ç«¯åºï¼‰
      textChunk[0] = (chunkLength >> 24) & 0xff;
      textChunk[1] = (chunkLength >> 16) & 0xff;
      textChunk[2] = (chunkLength >> 8) & 0xff;
      textChunk[3] = chunkLength & 0xff;
      // é¡å‹
      textChunk.set(new TextEncoder().encode('tEXt'), 4);
      // å…§å®¹
      textChunk.set(chunkContent, 8);
      // CRC
      textChunk[textChunk.length - 4] = (crc >> 24) & 0xff;
      textChunk[textChunk.length - 3] = (crc >> 16) & 0xff;
      textChunk[textChunk.length - 2] = (crc >> 8) & 0xff;
      textChunk[textChunk.length - 1] = crc & 0xff;
      
      // æ‰¾åˆ° IEND chunk çš„ä½ç½®ï¼ˆPNG çµå°¾ï¼‰
      // IEND æ¨™è­˜æ˜¯ "IEND" å‰é¢4å­—ç¯€æ˜¯é•·åº¦(0)
      let iendPos = uint8Array.length - 12;
      for(let i = uint8Array.length - 12; i >= 8; i--){
        if(uint8Array[i] === 0x49 && uint8Array[i+1] === 0x45 && 
           uint8Array[i+2] === 0x4E && uint8Array[i+3] === 0x44){
          iendPos = i - 4; // IEND chunk é–‹å§‹ä½ç½®ï¼ˆå«é•·åº¦å­—ç¯€ï¼‰
          break;
        }
      }
      
      // æ§‹å»ºæ–°çš„ PNG æ–‡ä»¶
      const newPng = new Uint8Array(uint8Array.length + textChunk.length);
      newPng.set(uint8Array.slice(0, iendPos), 0);
      newPng.set(textChunk, iendPos);
      newPng.set(uint8Array.slice(iendPos), iendPos + textChunk.length);
      
      // ä¸‹è¼‰
      const finalBlob = new Blob([newPng], {type: 'image/png'});
      const url = URL.createObjectURL(finalBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${charName}_è§’è‰²å¡.png`;
      a.click();
      URL.revokeObjectURL(url);
      
      hideLoading();
      toast(T(`å·²å°å‡º PNG è§’è‰²å¡ã€Œ${charName}ã€`), 'success');
    } catch(err){
      hideLoading();
      console.error('PNG metadata error:', err);
      toast(T('PNG å…ƒæ•¸æ“šå¯«å…¥å¤±æ•—'), 'error');
    }
  }, 'image/png');
}

// CRC32 è¨ˆç®—ï¼ˆç”¨æ–¼ PNG chunkï¼‰
function crc32(data){
  let crc = 0xffffffff;
  const table = crc32Table();
  for(let i = 0; i < data.length; i++){
    crc = (crc >>> 8) ^ table[(crc ^ data[i]) & 0xff];
  }
  return (crc ^ 0xffffffff) >>> 0;
}

function crc32Table(){
  const table = new Uint32Array(256);
  for(let i = 0; i < 256; i++){
    let c = i;
    for(let j = 0; j < 8; j++){
      c = (c & 1) ? (0xedb88320 ^ (c >>> 1)) : (c >>> 1);
    }
    table[i] = c;
  }
  return table;
}

// ğŸ†• å¾ URL å°å…¥è§’è‰²å¡
async function importCharacterFromURL(){
  if(!story){toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'),'warning');return;}
  
  // æ¸…ç©ºè¾“å…¥æ¡†
  const input = document.getElementById('char-url-input');
  if(input) input.value = '';
  
  showModal('char-url-import-modal');
}

// æ‰§è¡ŒURLå¯¼å…¥
async function doImportFromURL(){
  const input = document.getElementById('char-url-input');
  const url = input?.value?.trim();
  
  if(!url){
    toast(T('è«‹è¼¸å…¥ URL'),'warning');
    return;
  }
  
  closeModal('char-url-import-modal');
  showLoading(T('æ­£åœ¨å¾ URL å°å…¥...'));
  
  try {
    let charData = null;
    
    // æª¢æ¸¬ URL é¡å‹
    if(url.includes('chub.ai') || url.includes('characterhub.org')){
      // Chub.ai / CharacterHub å¹³å°
      charData = await importFromChub(url);
    } else if(url.endsWith('.json')){
      // ç›´æ¥ JSON æ–‡ä»¶
      const response = await fetch(url);
      if(!response.ok) throw new Error('ç„¡æ³•ç²å–æ–‡ä»¶');
      charData = await response.json();
    } else if(url.endsWith('.png')){
      // ç›´æ¥ PNG æ–‡ä»¶
      const response = await fetch(url);
      if(!response.ok) throw new Error('ç„¡æ³•ç²å–æ–‡ä»¶');
      const blob = await response.blob();
      const file = new File([blob], 'character.png', {type: 'image/png'});
      await importSillyTavernPNG(file);
      hideLoading();
      renderCharacters();
      return;
    } else {
      // å˜—è©¦ä½œç‚º JSON ç²å–
      const response = await fetch(url);
      if(!response.ok) throw new Error('ç„¡æ³•ç²å–æ–‡ä»¶');
      const text = await response.text();
      try {
        charData = JSON.parse(text);
      } catch(e){
        throw new Error('ç„¡æ³•è§£æç‚º JSON æ ¼å¼');
      }
    }
    
    if(charData){
      await importCharacterJSON(charData);
    }
    
    hideLoading();
    renderCharacters();
  } catch(err){
    hideLoading();
    console.error('URL import error:', err);
    toast(T('å¾ URL å°å…¥å¤±æ•—: ') + err.message, 'error');
  }
}

// å¾ Chub.ai / CharacterHub å°å…¥
async function importFromChub(url){
  // æå–è§’è‰² ID
  // Chub.ai URL æ ¼å¼: https://chub.ai/characters/username/character-name
  // CharacterHub URL æ ¼å¼: https://www.characterhub.org/characters/username/character-name
  
  let apiUrl = '';
  
  if(url.includes('chub.ai')){
    // Chub.ai API
    const match = url.match(/chub\.ai\/characters\/([^\/]+\/[^\/\?]+)/);
    if(!match) throw new Error('ç„¡æ³•è§£æ Chub.ai URL');
    const charPath = match[1];
    apiUrl = `https://api.chub.ai/api/characters/${charPath}?full=true`;
  } else if(url.includes('characterhub.org')){
    // CharacterHub - å˜—è©¦ç²å– JSON
    const match = url.match(/characterhub\.org\/characters\/([^\/]+\/[^\/\?]+)/);
    if(!match) throw new Error('ç„¡æ³•è§£æ CharacterHub URL');
    const charPath = match[1];
    // CharacterHub å¯èƒ½æœ‰ä¸åŒçš„ API çµæ§‹ï¼Œé€™è£¡å˜—è©¦å¸¸è¦‹æ ¼å¼
    apiUrl = `https://www.characterhub.org/api/v1/characters/${charPath}`;
  }
  
  if(!apiUrl){
    throw new Error('ä¸æ”¯æŒçš„å¹³å° URL');
  }
  
  try {
    const response = await fetch(apiUrl, {
      headers: {
        'Accept': 'application/json'
      }
    });
    
    if(!response.ok){
      // å¦‚æœ API å¤±æ•—ï¼Œå˜—è©¦ç›´æ¥ç²å–é é¢ä¸¦æå–æ•¸æ“š
      throw new Error('API è«‹æ±‚å¤±æ•—ï¼Œå¯èƒ½éœ€è¦ç™»éŒ„æˆ–è©²å¹³å°ä¸æ”¯æŒå…¬é–‹ API');
    }
    
    const data = await response.json();
    
    // è½‰æ›ç‚º Character Card V2 æ ¼å¼
    if(data.node || data.fullPath){
      // Chub.ai æ ¼å¼
      const node = data.node || data;
      return {
        spec: 'chara_card_v2',
        data: {
          name: node.name || data.name,
          description: node.description || data.description || '',
          personality: node.personality || '',
          scenario: node.scenario || '',
          first_mes: node.first_mes || node.greeting || '',
          mes_example: node.mes_example || node.example_dialogs || '',
          system_prompt: node.system_prompt || '',
          post_history_instructions: node.post_history_instructions || '',
          alternate_greetings: node.alternate_greetings || [],
          tags: node.topics || node.tags || [],
          creator: node.creator?.username || node.fullPath?.split('/')[0] || '',
          character_version: node.version || '1.0'
        }
      };
    }
    
    // å¦‚æœå·²ç¶“æ˜¯æ¨™æº–æ ¼å¼ï¼Œç›´æ¥è¿”å›
    return data;
  } catch(err){
    console.error('Chub import error:', err);
    throw new Error('å¾å¹³å°å°å…¥å¤±æ•—: ' + err.message + '\n\næç¤ºï¼šæŸäº›å¹³å°å¯èƒ½éœ€è¦ç™»éŒ„æ‰èƒ½è¨ªå•è§’è‰²æ•¸æ“šã€‚æ‚¨å¯ä»¥å˜—è©¦ï¼š\n1. åœ¨å¹³å°ä¸Šä¸‹è¼‰è§’è‰²å¡æ–‡ä»¶\n2. ä½¿ç”¨ã€Œå°å…¥è§’è‰²å¡ï¼ˆæ–‡ä»¶ï¼‰ã€åŠŸèƒ½å°å…¥');
  }
}

async function clearAllCharacters(){
  if(!story){toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'),'warning');return;}
  if(!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è§’è‰²å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ï¼')) return;
  
  await db.characters.where('storyId').equals(story.id).delete();
  renderCharacters();
  toast(T('å·²æ¸…ç©ºæ‰€æœ‰è§’è‰²'),'success');
}

function exportCurrentCharacter(){
  showCharExportOptions();
}

function showCharExportOptions(){
  if(!currentCharacterId){
    toast(T('è«‹å…ˆé¸æ“‡è§’è‰²'),'warning');
    return;
  }
  showModal('char-export-modal');
}

function exportCurrentCharacterJSON(){
  closeModal('char-export-modal');
  if(currentCharacterId){
    exportSingleCharacter(currentCharacterId);
  }
}

function exportCurrentCharacterPNG(){
  closeModal('char-export-modal');
  if(currentCharacterId){
    exportCharacterAsPNG(currentCharacterId);
  }
}

// ============ èƒŒåŒ…ç³»çµ± ============
let editInventoryItemId = null;
let selectedInventoryIcon = 'ğŸ“¦';

// æ¸²æŸ“èƒŒåŒ…åˆ—è¡¨
async function renderInventory(){
  if(!story) return;
  const container = document.getElementById('inventory-list');
  const inventory = story.inventory || [];
  
  if(!inventory.length){
    container.innerHTML = `<div class="empty" style="padding:40px 20px">
      <div class="empty-icon">ğŸ’</div>
      <div class="empty-title">èƒŒåŒ…æ˜¯ç©ºçš„</div>
      <div class="empty-desc">é»æ“Šå³ä¸Šè§’ â• æ‰‹å‹•æ·»åŠ ç‰©å“ï¼Œæˆ–é»æ“Š ğŸ¤– è®“ AI å¾å°è©±ä¸­æ™ºèƒ½è­˜åˆ¥</div>
    </div>`;
    return;
  }
  
  const searchTerm = (document.getElementById('inventory-search')?.value || '').toLowerCase();
  const categoryFilter = document.getElementById('inventory-filter')?.value || 'all';
  
  const filtered = inventory.filter(item => {
    const matchSearch = !searchTerm || 
      item.name.toLowerCase().includes(searchTerm) || 
      (item.description || '').toLowerCase().includes(searchTerm);
    const matchCategory = categoryFilter === 'all' || item.category === categoryFilter;
    return matchSearch && matchCategory;
  });
  
  if(!filtered.length){
    container.innerHTML = `<div class="empty" style="padding:40px 20px">
      <div class="empty-icon">ğŸ”</div>
      <div class="empty-title">æ²’æœ‰åŒ¹é…çš„ç‰©å“</div>
    </div>`;
    return;
  }
  
  const categoryNames = {
    weapon: 'âš”ï¸ æ­¦å™¨', armor: 'ğŸ›¡ï¸ é˜²å…·', consumable: 'ğŸ§ª æ¶ˆè€—å“',
    material: 'ğŸ“¦ ææ–™', key: 'ğŸ”‘ é—œéµç‰©å“', other: 'ğŸ“‹ å…¶ä»–'
  };
  
  container.innerHTML = filtered.map(item => {
    const hasLorebook = item.lorebookId ? 'has-lorebook' : '';
    return `<div class="inventory-item ${hasLorebook}" data-id="${item.id}">
      <div class="inventory-item-icon">${esc(item.icon || 'ğŸ“¦')}</div>
      <div class="inventory-item-info">
        <div class="inventory-item-name">
          ${esc(item.name)}
          ${item.quantity > 1 ? `<span class="quantity">Ã—${item.quantity}</span>` : ''}
        </div>
        <div class="inventory-item-category">${categoryNames[item.category] || 'ğŸ“‹ å…¶ä»–'}${item.lorebookId ? ' Â· ğŸ”® å·²é€£çµLorebook' : ''}</div>
        ${item.description ? `<div class="inventory-item-desc">${esc(item.description)}</div>` : ''}
      </div>
      <div class="inventory-item-actions">
        <button class="inventory-item-btn" onclick="editInventoryItem('${item.id}')">âœï¸</button>
        <button class="inventory-item-btn danger" onclick="deleteInventoryItem('${item.id}')">ğŸ—‘ï¸</button>
      </div>
    </div>`;
  }).join('');
}

// è¿‡æ»¤èƒŒåŒ…
function filterInventory(){
  renderInventory();
}

// é€‰æ‹©å›¾æ ‡
function selectInventoryIcon(icon){
  selectedInventoryIcon = icon;
  document.getElementById('inventory-item-icon').value = icon;
  document.querySelectorAll('#inventory-icon-picker .icon-option').forEach(el => {
    el.classList.toggle('selected', el.textContent === icon);
  });
}

// æ·»åŠ ç‰©å“
function addInventoryItem(){
  editInventoryItemId = null;
  selectedInventoryIcon = 'ğŸ“¦';
  document.getElementById('inventory-modal-title').textContent = 'â• æ·»åŠ ç‰©å“';
  document.getElementById('inventory-item-icon').value = '';
  document.getElementById('inventory-item-name').value = '';
  document.getElementById('inventory-item-quantity').value = '1';
  document.getElementById('inventory-item-category').value = 'other';
  document.getElementById('inventory-item-desc').value = '';
  document.getElementById('inventory-item-lorebook').checked = true;
  document.querySelectorAll('#inventory-icon-picker .icon-option').forEach(el => el.classList.remove('selected'));
  showModal('inventory-item-modal');
}

// ç¼–è¾‘ç‰©å“
function editInventoryItem(id){
  const inventory = story.inventory || [];
  const item = inventory.find(i => i.id === id);
  if(!item) return;
  
  editInventoryItemId = id;
  selectedInventoryIcon = item.icon || 'ğŸ“¦';
  document.getElementById('inventory-modal-title').textContent = 'âœï¸ ç·¨è¼¯ç‰©å“';
  document.getElementById('inventory-item-icon').value = item.icon || '';
  document.getElementById('inventory-item-name').value = item.name;
  document.getElementById('inventory-item-quantity').value = item.quantity || 1;
  document.getElementById('inventory-item-category').value = item.category || 'other';
  document.getElementById('inventory-item-desc').value = item.description || '';
  document.getElementById('inventory-item-lorebook').checked = !!item.lorebookId;
  
  document.querySelectorAll('#inventory-icon-picker .icon-option').forEach(el => {
    el.classList.toggle('selected', el.textContent === selectedInventoryIcon);
  });
  showModal('inventory-item-modal');
}

// ä¿å­˜ç‰©å“
async function saveInventoryItem(){
  const name = document.getElementById('inventory-item-name').value.trim();
  if(!name){
    toast(T('è«‹è¼¸å…¥ç‰©å“åç¨±'),'warning');
    return;
  }
  
  const icon = document.getElementById('inventory-item-icon').value.trim() || selectedInventoryIcon || 'ğŸ“¦';
  const quantity = parseInt(document.getElementById('inventory-item-quantity').value) || 1;
  const category = document.getElementById('inventory-item-category').value;
  const description = document.getElementById('inventory-item-desc').value.trim();
  const syncLorebook = document.getElementById('inventory-item-lorebook').checked;
  
  let inventory = story.inventory || [];
  let item;
  
  if(editInventoryItemId){
    // ç¼–è¾‘ç°æœ‰ç‰©å“
    const idx = inventory.findIndex(i => i.id === editInventoryItemId);
    if(idx >= 0){
      item = inventory[idx];
      item.name = name;
      item.icon = icon;
      item.quantity = quantity;
      item.category = category;
      item.description = description;
      item.updatedAt = Date.now();
    }
  } else {
    // æ·»åŠ æ–°ç‰©å“
    item = {
      id: crypto.randomUUID(),
      name,
      icon,
      quantity,
      category,
      description,
      createdAt: Date.now()
    };
    inventory.push(item);
  }
  
  // åŒæ­¥åˆ°Lorebook
  if(syncLorebook && item){
    await syncInventoryToLorebook(item);
  } else if(!syncLorebook && item && item.lorebookId){
    // å–æ¶ˆåŒæ­¥ï¼Œåˆ é™¤Lorebookæ¡ç›®
    await db.lorebook.delete(item.lorebookId);
    item.lorebookId = null;
  }
  
  story.inventory = inventory;
  await db.stories.update(story.id, { inventory });
  
  closeModal('inventory-item-modal');
  renderInventory();
  toast(editInventoryItemId ? 'ç‰©å“å·²æ›´æ–°' : 'ç‰©å“å·²æ·»åŠ ', 'success');
}

// åŒæ­¥åˆ°Lorebook
async function syncInventoryToLorebook(item){
  const categoryNames = {
    weapon: 'æ­¦å™¨', armor: 'é˜²å…·', consumable: 'æ¶ˆè€—å“',
    material: 'ææ–™', key: 'é—œéµç‰©å“', other: 'ç‰©å“'
  };
  
  const content = `ã€${categoryNames[item.category] || 'ç‰©å“'}ã€‘${item.name}
${item.description || 'ç©å®¶èƒŒåŒ…ä¸­çš„ç‰©å“ã€‚'}`;
  
  if(item.lorebookId){
    // æ›´æ–°ç°æœ‰Lorebook
    await db.lorebook.update(item.lorebookId, {
      name: `ğŸ’ ${item.name}`,
      keywords: [item.name],
      content,
      updatedAt: Date.now()
    });
  } else {
    // åˆ›å»ºæ–°Lorebook
    const lorebookId = crypto.randomUUID();
    await db.lorebook.put({
      id: lorebookId,
      storyId: story.id,
      name: `ğŸ’ ${item.name}`,
      keywords: [item.name],
      content,
      isEnabled: true,
      priority: 5,
      insertPosition: 'before',
      createdAt: Date.now()
    });
    item.lorebookId = lorebookId;
  }
}

// åˆ é™¤ç‰©å“
async function deleteInventoryItem(id){
  showConfirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ç‰©å“å—ï¼Ÿ', async () => {
    let inventory = story.inventory || [];
    const item = inventory.find(i => i.id === id);
    
    // åˆ é™¤å…³è”çš„Lorebook
    if(item && item.lorebookId){
      await db.lorebook.delete(item.lorebookId);
    }
    
    inventory = inventory.filter(i => i.id !== id);
    story.inventory = inventory;
    await db.stories.update(story.id, { inventory });
    
    renderInventory();
    toast(T('ç‰©å“å·²åˆªé™¤'), 'success');
  });
}

// AIæ™ºèƒ½åŒæ­¥èƒŒåŒ…
async function aiSyncInventory(){
  if(!story) return;
  
  const preset = await db.apiPresets.filter(p => p.isActive).first();
  if(!preset || !preset.apiKey){
    toast(T('è«‹å…ˆé…ç½® API'), 'warning');
    return;
  }
  
  if(msgs.length < 2){
    toast(T('å°è©±è¨˜éŒ„å¤ªå°‘ï¼Œç„¡æ³•åˆ†æ'), 'info');
    return;
  }
  
  showLoading('AI æ­£åœ¨åˆ†æå°è©±ä¸­çš„ç‰©å“...');
  
  try {
    // è·å–æœ€è¿‘çš„å¯¹è¯å†…å®¹
    const recentMsgs = msgs.slice(-20);
    const dialogContent = recentMsgs.map(m => {
      const role = m.role === 'user' ? 'ã€ç©å®¶ã€‘' : 'ã€åŠ‡æƒ…ã€‘';
      return `${role} ${m.content.slice(0, 500)}`;
    }).join('\n\n');
    
    const existingItems = (story.inventory || []).map(i => i.name).join('ã€') || 'ç„¡';
    
    const prompt = `åˆ†æä»¥ä¸‹å°è©±å…§å®¹ï¼Œè­˜åˆ¥ç©å®¶ç²å¾—ã€ä½¿ç”¨æˆ–å¤±å»çš„ç‰©å“ã€‚

ç¾æœ‰èƒŒåŒ…ç‰©å“ï¼š${existingItems}

å°è©±å…§å®¹ï¼š
${dialogContent}

è«‹ä»¥ JSON æ ¼å¼è¿”å›ç‰©å“è®ŠåŒ–ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
{
  "items": [
    {
      "action": "add" æˆ– "remove" æˆ– "update",
      "name": "ç‰©å“åç¨±",
      "icon": "é©åˆçš„emoji",
      "quantity": æ•¸é‡,
      "category": "weapon/armor/consumable/material/key/other",
      "description": "ç°¡çŸ­æè¿°"
    }
  ]
}

æ³¨æ„ï¼š
1. åªè¿”å›ç¢ºå¯¦åœ¨å°è©±ä¸­æ˜ç¢ºæåˆ°ç²å¾—/ä½¿ç”¨/å¤±å»çš„ç‰©å“
2. ä¸è¦é‡è¤‡æ·»åŠ å·²æœ‰ç‰©å“ï¼ˆé™¤éæ•¸é‡è®ŠåŒ–ï¼‰
3. å¦‚æœæ²’æœ‰ç‰©å“è®ŠåŒ–ï¼Œè¿”å›ç©ºæ•¸çµ„ {"items":[]}
4. åªè¿”å› JSONï¼Œä¸è¦å…¶ä»–æ–‡å­—`;

    let result;
    if(preset.type === 'anthropic'){
      const r = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': preset.apiKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: preset.model || 'claude-sonnet-4-20250514',
          max_tokens: 1000,
          messages: [{ role: 'user', content: prompt }]
        })
      });
      const data = await r.json();
      result = data.content?.[0]?.text || '{}';
    } else {
      const r = await fetch(preset.baseUrl || 'https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${preset.apiKey}`
        },
        body: JSON.stringify({
          model: preset.model || 'gpt-4o-mini',
          messages: [{ role: 'user', content: prompt }],
          max_tokens: 1000
        })
      });
      const data = await r.json();
      result = data.choices?.[0]?.message?.content || '{}';
    }
    
    // è§£æç»“æœ
    const jsonMatch = result.match(/\{[\s\S]*\}/);
    if(!jsonMatch){
      hideLoading();
      toast(T('AI æœªèƒ½è­˜åˆ¥åˆ°ç‰©å“è®ŠåŒ–'), 'info');
      return;
    }
    
    const parsed = JSON.parse(jsonMatch[0]);
    const items = parsed.items || [];
    
    if(!items.length){
      hideLoading();
      toast(T('æœªç™¼ç¾æ–°çš„ç‰©å“è®ŠåŒ–'), 'info');
      return;
    }
    
    // å¤„ç†ç‰©å“å˜åŒ–
    let inventory = story.inventory || [];
    let addCount = 0, updateCount = 0, removeCount = 0;
    
    for(const item of items){
      if(item.action === 'add'){
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        const existing = inventory.find(i => i.name === item.name);
        if(existing){
          existing.quantity = (existing.quantity || 1) + (item.quantity || 1);
          existing.updatedAt = Date.now();
          updateCount++;
        } else {
          const newItem = {
            id: crypto.randomUUID(),
            name: item.name,
            icon: item.icon || 'ğŸ“¦',
            quantity: item.quantity || 1,
            category: item.category || 'other',
            description: item.description || '',
            createdAt: Date.now()
          };
          // è‡ªåŠ¨åŒæ­¥åˆ°Lorebook
          await syncInventoryToLorebook(newItem);
          inventory.push(newItem);
          addCount++;
        }
      } else if(item.action === 'remove'){
        const idx = inventory.findIndex(i => i.name === item.name);
        if(idx >= 0){
          const existing = inventory[idx];
          if(item.quantity && existing.quantity > item.quantity){
            existing.quantity -= item.quantity;
            updateCount++;
          } else {
            if(existing.lorebookId){
              await db.lorebook.delete(existing.lorebookId);
            }
            inventory.splice(idx, 1);
            removeCount++;
          }
        }
      } else if(item.action === 'update'){
        const existing = inventory.find(i => i.name === item.name);
        if(existing){
          if(item.quantity) existing.quantity = item.quantity;
          if(item.description) existing.description = item.description;
          existing.updatedAt = Date.now();
          updateCount++;
        }
      }
    }
    
    story.inventory = inventory;
    await db.stories.update(story.id, { inventory });
    
    hideLoading();
    renderInventory();
    
    const changes = [];
    if(addCount) changes.push(`æ–°å¢ ${addCount} å€‹`);
    if(updateCount) changes.push(`æ›´æ–° ${updateCount} å€‹`);
    if(removeCount) changes.push(`ç§»é™¤ ${removeCount} å€‹`);
    
    toast(`èƒŒåŒ…å·²åŒæ­¥ï¼š${changes.join('ï¼Œ') || 'ç„¡è®ŠåŒ–'}`, 'success');
    
  } catch(e) {
    hideLoading();
    console.error('AI sync inventory error:', e);
    toast('åŒæ­¥å¤±æ•—: ' + e.message, 'error');
  }
}

// ============ å ´æ™¯ç®¡ç†ç³»çµ± ============
let currentEditSceneId = null;

async function showSceneManager(){
  if(!story){toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'),'warning');return;}
  closeAll();
  await renderSceneList();
  await updateCurrentSceneSelect();
  showModal('scene-modal');
}

async function renderSceneList(){
  const container = document.getElementById('scene-list');
  const scenes = await db.scenes.where('storyId').equals(story.id).toArray();
  
  if(!scenes.length){
    container.innerHTML = `<div style="text-align:center;padding:16px;color:var(--text-tertiary);font-size:13px">é‚„æ²’æœ‰å ´æ™¯ï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•å‰µå»º</div>`;
    document.getElementById('scene-detail-section').style.display = 'none';
    return;
  }
  
  let html = '';
  scenes.forEach(s => {
    const charCount = s.characterIds?.length || 0;
    html += `
      <div class="scene-item" style="display:flex;align-items:center;padding:10px;background:${s.isActive?'rgba(139,92,246,0.15)':'var(--bg-secondary)'};border-radius:8px;margin-bottom:6px;cursor:pointer" onclick="selectSceneForDetail('${s.id}')">
        <div style="flex:1;min-width:0">
          <div style="font-size:14px;font-weight:500;color:${s.isActive?'var(--primary)':'var(--text-primary)'}">${esc(s.name)} ${s.isActive?'âœ“':''}</div>
          <div style="font-size:11px;color:var(--text-tertiary)">${charCount} ä½è§’è‰²åœ¨å ´</div>
        </div>
        <div style="display:flex;gap:4px">
          <button class="icon-btn" style="padding:4px 8px;font-size:12px" onclick="event.stopPropagation();editScene('${s.id}')">âœï¸</button>
          <button class="icon-btn" style="padding:4px 8px;font-size:12px;color:var(--error)" onclick="event.stopPropagation();deleteScene('${s.id}')">ğŸ—‘ï¸</button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

async function updateCurrentSceneSelect(){
  const select = document.getElementById('current-scene');
  const scenes = await db.scenes.where('storyId').equals(story.id).toArray();
  
  let html = '<option value="">ç„¡å ´æ™¯ï¼ˆæ‰€æœ‰è§’è‰²ï¼‰</option>';
  scenes.forEach(s => {
    html += `<option value="${s.id}" ${s.isActive?'selected':''}>${esc(s.name)}</option>`;
  });
  select.innerHTML = html;
}

async function switchScene(sceneId){
  if(!story) return;
  
  // æ¸…é™¤æ‰€æœ‰å ´æ™¯çš„æ¿€æ´»ç‹€æ…‹
  const scenes = await db.scenes.where('storyId').equals(story.id).toArray();
  for(const s of scenes){
    if(s.isActive){
      s.isActive = false;
      await db.scenes.put(s);
    }
  }
  
  // æ¿€æ´»é¸ä¸­çš„å ´æ™¯
  if(sceneId){
    const scene = await db.scenes.get(sceneId);
    if(scene){
      scene.isActive = true;
      await db.scenes.put(scene);
      toast(`å·²åˆ‡æ›åˆ°å ´æ™¯ã€Œ${scene.name}ã€`,'success');
    }
  } else {
    toast(T('å·²åˆ‡æ›ç‚ºç„¡å ´æ™¯æ¨¡å¼'),'success');
  }
  
  await renderSceneList();
}

async function selectSceneForDetail(sceneId){
  const scene = await db.scenes.get(sceneId);
  if(!scene) return;
  
  const section = document.getElementById('scene-detail-section');
  section.style.display = 'block';
  
  const container = document.getElementById('scene-characters');
  const charIds = scene.characterIds || [];
  
  if(!charIds.length){
    container.innerHTML = `<div style="text-align:center;padding:12px;color:var(--text-tertiary);font-size:12px">æ­¤å ´æ™¯æ²’æœ‰è§’è‰²</div>`;
    return;
  }
  
  let html = '';
  for(const cid of charIds){
    const char = await db.characters.get(cid);
    if(char){
      html += `
        <div style="display:flex;align-items:center;padding:8px;background:var(--bg-secondary);border-radius:6px;margin-bottom:4px">
          <span style="font-size:20px;margin-right:8px">${char.avatar||'ğŸ‘¤'}</span>
          <span style="flex:1;font-size:13px">${esc(char.name)}</span>
          ${char.title?`<span style="font-size:11px;color:var(--text-tertiary)">${esc(char.title)}</span>`:''}
        </div>
      `;
    }
  }
  container.innerHTML = html;
}

async function createNewScene(){
  currentEditSceneId = null;
  document.getElementById('scene-edit-title').textContent = 'å‰µå»ºå ´æ™¯';
  document.getElementById('scene-edit-id').value = '';
  document.getElementById('scene-edit-name').value = '';
  document.getElementById('scene-edit-desc').value = '';
  
  await renderSceneCharSelector([]);
  showModal('scene-edit-modal');
}

async function editScene(sceneId){
  const scene = await db.scenes.get(sceneId);
  if(!scene) return;
  
  currentEditSceneId = sceneId;
  document.getElementById('scene-edit-title').textContent = 'ç·¨è¼¯å ´æ™¯';
  document.getElementById('scene-edit-id').value = sceneId;
  document.getElementById('scene-edit-name').value = scene.name;
  document.getElementById('scene-edit-desc').value = scene.description || '';
  
  await renderSceneCharSelector(scene.characterIds || []);
  showModal('scene-edit-modal');
}

async function renderSceneCharSelector(selectedIds){
  const container = document.getElementById('scene-char-selector');
  const chars = await db.characters.where('storyId').equals(story.id).toArray();
  
  if(!chars.length){
    container.innerHTML = `<div style="text-align:center;padding:12px;color:var(--text-tertiary);font-size:12px">é‚„æ²’æœ‰è§’è‰²ï¼Œè«‹å…ˆæ·»åŠ è§’è‰²</div>`;
    return;
  }
  
  let html = '';
  chars.forEach(c => {
    const checked = selectedIds.includes(c.id);
    html += `
      <label style="display:flex;align-items:center;padding:8px;cursor:pointer;border-radius:6px;margin-bottom:4px;background:${checked?'rgba(139,92,246,0.1)':'transparent'}">
        <input type="checkbox" class="scene-char-cb" value="${c.id}" ${checked?'checked':''} style="margin-right:10px;width:18px;height:18px">
        <span style="font-size:18px;margin-right:8px">${c.avatar||'ğŸ‘¤'}</span>
        <span style="flex:1;font-size:13px">${esc(c.name)}</span>
        ${c.title?`<span style="font-size:11px;color:var(--text-tertiary)">${esc(c.title)}</span>`:''}
      </label>
    `;
  });
  container.innerHTML = html;
}

async function saveScene(){
  const name = document.getElementById('scene-edit-name').value.trim();
  if(!name){toast(T('è«‹è¼¸å…¥å ´æ™¯åç¨±'),'warning');return;}
  
  const description = document.getElementById('scene-edit-desc').value.trim();
  const checkboxes = document.querySelectorAll('.scene-char-cb:checked');
  const characterIds = Array.from(checkboxes).map(cb => cb.value);
  
  const sceneId = document.getElementById('scene-edit-id').value || crypto.randomUUID();
  
  const scene = {
    id: sceneId,
    storyId: story.id,
    name,
    description,
    characterIds,
    isActive: false,
    createdAt: currentEditSceneId ? (await db.scenes.get(sceneId))?.createdAt || Date.now() : Date.now()
  };
  
  await db.scenes.put(scene);
  closeModal('scene-edit-modal');
  await renderSceneList();
  await updateCurrentSceneSelect();
  toast(currentEditSceneId ? 'å ´æ™¯å·²æ›´æ–°' : 'å ´æ™¯å·²å‰µå»º', 'success');
}

async function deleteScene(sceneId){
  if(!confirm('ç¢ºå®šåˆªé™¤é€™å€‹å ´æ™¯ï¼Ÿ')) return;
  await db.scenes.delete(sceneId);
  await renderSceneList();
  await updateCurrentSceneSelect();
  toast(T('å ´æ™¯å·²åˆªé™¤'),'success');
}

// ============ ç©å®¶é¢æ¿ç³»çµ± ============
let currentPlayerPanel = null;
let tempPlayerAttrs = [];

async function showPlayerPanel(){
  if(!story){toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'),'warning');return;}
  closeAll();
  
  // è¼‰å…¥ç•¶å‰æ•…äº‹çš„é¢æ¿é…ç½®
  currentPlayerPanel = await db.playerPanels.where('storyId').equals(story.id).first();
  
  renderPlayerPanelContent();
  showModal('player-panel-modal');
}

function renderPlayerPanelContent(){
  const container = document.getElementById('player-panel-content');
  const syncBtn = document.getElementById('player-sync-btn');
  
  if(!currentPlayerPanel || !currentPlayerPanel.attributes?.length){
    container.innerHTML = `
      <div style="text-align:center;padding:24px;color:var(--text-tertiary)">
        <div style="font-size:32px;margin-bottom:12px">ğŸ“‹</div>
        <div style="font-size:14px">é‚„æ²’æœ‰è¨­ç½®ç‹€æ…‹é¢æ¿</div>
        <div style="font-size:12px;margin-top:4px">é»æ“Šä¸‹æ–¹ã€Œè¨­ç½®é¢æ¿ã€å‰µå»º</div>
      </div>
    `;
    if(syncBtn) syncBtn.style.display = 'none';
    return;
  }
  
  // é¡¯ç¤ºAIåŒæ­¥æŒ‰éˆ•
  if(syncBtn) syncBtn.style.display = 'flex';
  
  const p = currentPlayerPanel;
  
  // æŒ‰åˆ†çµ„æ•´ç†å±¬æ€§
  const groupConfig = {
    'default': { icon: 'ğŸ“Š', title: 'å±¬æ€§' },
    'stats': { icon: 'ğŸ’ª', title: 'åŸºç¤å±¬æ€§' },
    'status': { icon: 'â¤ï¸', title: 'ç•¶å‰ç‹€æ…‹' },
    'finance': { icon: 'ğŸ’°', title: 'è²¡å‹™ç‹€æ³' }
  };
  
  const groups = {};
  for(const attr of p.attributes){
    const groupKey = attr.group || 'default';
    if(!groups[groupKey]) groups[groupKey] = [];
    groups[groupKey].push(attr);
  }
  
  let html = `<div class="player-panel">`;
  html += `<div class="player-panel-header">`;
  html += `<div class="player-panel-title">ğŸ“‹ ${esc(p.name || 'æˆ‘çš„ç‹€æ…‹')}</div>`;
  html += `</div>`;
  
  // å¦‚æœåªæœ‰ä¸€å€‹åˆ†çµ„ä¸”ç‚ºdefaultï¼Œä¸é¡¯ç¤ºåˆ†çµ„æ¨™é¡Œ
  const groupKeys = Object.keys(groups);
  const showGroupHeaders = groupKeys.length > 1 || (groupKeys.length === 1 && groupKeys[0] !== 'default');
  
  for(const [groupKey, attrs] of Object.entries(groups)){
    const config = groupConfig[groupKey] || { icon: 'âœ¨', title: groupKey };
    
    html += `<div class="player-group">`;
    
    if(showGroupHeaders){
      html += `<div class="player-group-header">`;
      html += `<span class="player-group-icon">${config.icon}</span>`;
      html += `<span class="player-group-title">${esc(config.title)}</span>`;
      html += `<span class="player-group-toggle" onclick="togglePlayerGroup(this)">â–¼</span>`;
      html += `</div>`;
    }
    
    // æ ¹æ“šå±¬æ€§æ•¸é‡æ±ºå®šç¶²æ ¼åˆ—æ•¸
    const gridClass = attrs.length >= 6 ? 'grid-3' : '';
    html += `<div class="player-group-content"><div class="player-stat-grid ${gridClass}">`;
    
    for(const attr of attrs){
      const value = p.values?.[attr.name] ?? attr.defaultValue ?? 0;
      const colorClass = attr.color || 'default';
      
      html += `<div class="player-stat-item color-${colorClass}">`;
      html += `<div class="player-stat-label">${attr.icon || 'ğŸ“Š'} ${esc(attr.name)}</div>`;
      
      if(attr.type === 'percent'){
        const max = attr.maxValue || 100;
        const percent = Math.min(100, Math.max(0, (value / max) * 100));
        const barColorClass = attr.name.includes('é«”åŠ›') || attr.name.includes('å¥åº·') || attr.name.includes('HP') ? 'health' : 
                             attr.name.includes('ç²¾ç¥') || attr.name.includes('èƒ½é‡') || attr.name.includes('MP') ? 'energy' :
                             attr.name.includes('å¿ƒæƒ…') || attr.name.includes('æƒ…ç·’') ? 'mood' : 'default';
        html += `<div class="player-stat-value">${value}<span class="unit">%</span></div>`;
        html += `<div class="player-stat-bar"><div class="player-stat-bar-fill ${barColorClass}" style="width:${percent}%"></div></div>`;
      } else if(attr.type === 'number'){
        const isNegative = typeof value === 'number' && value < 0;
        const isPositive = typeof value === 'number' && value > 0 && (attr.name.includes('ç¾é‡‘') || attr.name.includes('é‡‘éŒ¢') || attr.name.includes('é¤˜é¡'));
        const unit = attr.unit || '';
        html += `<div class="player-stat-value ${isNegative ? 'negative' : ''} ${isPositive ? 'positive' : ''}">${typeof value === 'number' ? value.toLocaleString() : value}${unit ? `<span class="unit">${esc(unit)}</span>` : ''}</div>`;
      } else {
        // æ–‡å­—é¡å‹ä½¿ç”¨æ¨™ç±¤æ¨£å¼
        html += `<div class="player-stat-tag">${esc(String(value))}</div>`;
      }
      
      html += `</div>`;
    }
    
    html += `</div></div></div>`;
  }
  
  html += `</div>`;
  container.innerHTML = html;
}

// åˆ‡æ›åˆ†çµ„å±•é–‹/æ”¶èµ·
function togglePlayerGroup(el){
  el.classList.toggle('collapsed');
  const content = el.closest('.player-group').querySelector('.player-group-content');
  if(content){
    if(content.classList.contains('collapsed')){
      content.style.maxHeight = content.scrollHeight + 'px';
      content.classList.remove('collapsed');
    } else {
      content.style.maxHeight = content.scrollHeight + 'px';
      requestAnimationFrame(() => {
        content.classList.add('collapsed');
      });
    }
  }
}

async function showPlayerPanelSetup(){
  closeModal('player-panel-modal');
  
  // è¼‰å…¥ç¾æœ‰é…ç½®
  if(currentPlayerPanel){
    document.getElementById('player-panel-name').value = currentPlayerPanel.name || '';
    tempPlayerAttrs = [...(currentPlayerPanel.attributes || [])];
  } else {
    document.getElementById('player-panel-name').value = '';
    tempPlayerAttrs = [];
  }
  
  renderPlayerAttrList();
  showModal('player-panel-setup-modal');
}

function renderPlayerAttrList(){
  const container = document.getElementById('player-attr-list');
  
  if(!tempPlayerAttrs.length){
    container.innerHTML = `<div style="text-align:center;padding:16px;color:var(--text-tertiary);font-size:13px">é‚„æ²’æœ‰å±¬æ€§ï¼Œé»æ“Šæ·»åŠ </div>`;
    return;
  }
  
  const groupConfig = {
    'default': { icon: 'ğŸ“Š', title: 'é è¨­' },
    'stats': { icon: 'ğŸ’ª', title: 'åŸºç¤å±¬æ€§' },
    'status': { icon: 'â¤ï¸', title: 'ç•¶å‰ç‹€æ…‹' },
    'finance': { icon: 'ğŸ’°', title: 'è²¡å‹™' }
  };
  
  let html = '';
  tempPlayerAttrs.forEach((attr, i) => {
    const typeLabel = attr.type === 'percent' ? 'ç™¾åˆ†æ¯”' : attr.type === 'number' ? 'æ•¸å­—' : 'æ–‡å­—';
    const groupInfo = groupConfig[attr.group] || { icon: 'âœ¨', title: attr.group || 'é è¨­' };
    const colorStyle = attr.color && attr.color !== 'default' ? `border-left-color:${getColorHex(attr.color)}` : '';
    html += `
      <div class="player-attr-card" style="${colorStyle}">
        <div class="player-attr-icon">${attr.icon || 'ğŸ“Š'}</div>
        <div class="player-attr-info">
          <div class="player-attr-name">${esc(attr.name)}</div>
          <div class="player-attr-type">${typeLabel} Â· åˆå§‹å€¼: ${attr.defaultValue ?? 0}</div>
          <div class="player-attr-group">${groupInfo.icon} ${groupInfo.title}</div>
        </div>
        <button class="icon-btn" style="padding:4px 8px;font-size:12px" onclick="editPlayerAttribute(${i})">âœï¸</button>
        <button class="icon-btn" style="padding:4px 8px;font-size:12px;color:var(--error)" onclick="deletePlayerAttribute(${i})">ğŸ—‘ï¸</button>
      </div>
    `;
  });
  container.innerHTML = html;
}

function getColorHex(color){
  const colors = {
    'red': '#EF4444',
    'orange': '#F59E0B',
    'yellow': '#EAB308',
    'green': '#10B981',
    'blue': '#3B82F6',
    'purple': '#8B5CF6',
    'pink': '#EC4899'
  };
  return colors[color] || 'var(--primary)';
}

function selectAttrGroup(el){
  document.querySelectorAll('#player-attr-group-selector .group-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  const group = el.dataset.group;
  document.getElementById('player-attr-group').value = group;
  document.getElementById('player-attr-custom-group').style.display = group === 'custom' ? 'block' : 'none';
}

function selectAttrColor(el){
  el.parentElement.querySelectorAll('.group-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('player-attr-color').value = el.dataset.color;
}

function addPlayerAttribute(){
  document.getElementById('player-attr-modal-title').textContent = 'â• æ·»åŠ å±¬æ€§';
  document.getElementById('player-attr-edit-index').value = '-1';
  document.getElementById('player-attr-name').value = '';
  document.getElementById('player-attr-icon').value = '';
  document.getElementById('player-attr-type').value = 'number';
  document.getElementById('player-attr-default').value = '0';
  document.getElementById('player-attr-max').value = '100';
  document.getElementById('player-attr-keywords').value = '';
  // é‡ç½®åˆ†çµ„é¸æ“‡
  document.getElementById('player-attr-group').value = 'default';
  document.querySelectorAll('#player-attr-group-selector .group-chip').forEach(c => c.classList.remove('active'));
  document.querySelector('#player-attr-group-selector .group-chip[data-group="default"]')?.classList.add('active');
  document.getElementById('player-attr-custom-group').style.display = 'none';
  document.getElementById('player-attr-custom-group-name').value = '';
  // é‡ç½®é¡è‰²é¸æ“‡
  document.getElementById('player-attr-color').value = 'default';
  document.querySelectorAll('#player-attr-modal .group-chip[data-color]').forEach(c => c.classList.remove('active'));
  document.querySelector('#player-attr-modal .group-chip[data-color="default"]')?.classList.add('active');
  updatePlayerAttrTypeUI();
  showModal('player-attr-modal');
}

function editPlayerAttribute(index){
  const attr = tempPlayerAttrs[index];
  if(!attr) return;
  
  document.getElementById('player-attr-modal-title').textContent = 'âœï¸ ç·¨è¼¯å±¬æ€§';
  document.getElementById('player-attr-edit-index').value = index;
  document.getElementById('player-attr-name').value = attr.name || '';
  document.getElementById('player-attr-icon').value = attr.icon || '';
  document.getElementById('player-attr-type').value = attr.type || 'number';
  document.getElementById('player-attr-default').value = attr.defaultValue ?? '0';
  document.getElementById('player-attr-max').value = attr.maxValue || 100;
  document.getElementById('player-attr-keywords').value = (attr.keywords || []).join(', ');
  // è¨­ç½®åˆ†çµ„
  const group = attr.group || 'default';
  document.getElementById('player-attr-group').value = group;
  document.querySelectorAll('#player-attr-group-selector .group-chip').forEach(c => c.classList.remove('active'));
  const groupChip = document.querySelector(`#player-attr-group-selector .group-chip[data-group="${group}"]`);
  if(groupChip){
    groupChip.classList.add('active');
    document.getElementById('player-attr-custom-group').style.display = 'none';
  } else {
    // è‡ªå®šç¾©åˆ†çµ„
    document.querySelector('#player-attr-group-selector .group-chip[data-group="custom"]')?.classList.add('active');
    document.getElementById('player-attr-custom-group').style.display = 'block';
    document.getElementById('player-attr-custom-group-name').value = group;
  }
  // è¨­ç½®é¡è‰²
  const color = attr.color || 'default';
  document.getElementById('player-attr-color').value = color;
  document.querySelectorAll('#player-attr-modal .group-chip[data-color]').forEach(c => c.classList.remove('active'));
  document.querySelector(`#player-attr-modal .group-chip[data-color="${color}"]`)?.classList.add('active');
  updatePlayerAttrTypeUI();
  showModal('player-attr-modal');
}

function deletePlayerAttribute(index){
  if(!confirm('ç¢ºå®šåˆªé™¤é€™å€‹å±¬æ€§ï¼Ÿ')) return;
  tempPlayerAttrs.splice(index, 1);
  renderPlayerAttrList();
}

function updatePlayerAttrTypeUI(){
  const type = document.getElementById('player-attr-type').value;
  const maxGroup = document.getElementById('player-attr-max-group');
  maxGroup.style.display = type === 'percent' ? 'block' : 'none';
}

function savePlayerAttribute(){
  const name = document.getElementById('player-attr-name').value.trim();
  if(!name){toast(T('è«‹è¼¸å…¥å±¬æ€§åç¨±'),'warning');return;}
  
  // ç²å–åˆ†çµ„
  let group = document.getElementById('player-attr-group').value;
  if(group === 'custom'){
    group = document.getElementById('player-attr-custom-group-name').value.trim() || 'default';
  }
  
  const attr = {
    name,
    icon: document.getElementById('player-attr-icon').value.trim() || 'ğŸ“Š',
    type: document.getElementById('player-attr-type').value,
    defaultValue: document.getElementById('player-attr-type').value === 'text' 
      ? document.getElementById('player-attr-default').value 
      : parseFloat(document.getElementById('player-attr-default').value) || 0,
    maxValue: parseInt(document.getElementById('player-attr-max').value) || 100,
    keywords: document.getElementById('player-attr-keywords').value.split(',').map(k => k.trim()).filter(k => k),
    group: group,
    color: document.getElementById('player-attr-color').value || 'default'
  };
  
  const editIndex = parseInt(document.getElementById('player-attr-edit-index').value);
  if(editIndex >= 0){
    tempPlayerAttrs[editIndex] = attr;
  } else {
    tempPlayerAttrs.push(attr);
  }
  
  closeModal('player-attr-modal');
  renderPlayerAttrList();
}

async function savePlayerPanelSetup(){
  const name = document.getElementById('player-panel-name').value.trim() || 'æˆ‘çš„ç‹€æ…‹';
  
  // ä¿ç•™ç¾æœ‰æ•¸å€¼
  const existingValues = currentPlayerPanel?.values || {};
  const newValues = {};
  tempPlayerAttrs.forEach(attr => {
    newValues[attr.name] = existingValues[attr.name] ?? attr.defaultValue ?? 0;
  });
  
  const panel = {
    id: currentPlayerPanel?.id || crypto.randomUUID(),
    storyId: story.id,
    name,
    attributes: tempPlayerAttrs,
    values: newValues,
    createdAt: currentPlayerPanel?.createdAt || Date.now(),
    updatedAt: Date.now()
  };
  
  await db.playerPanels.put(panel);
  currentPlayerPanel = panel;
  
  closeModal('player-panel-setup-modal');
  toast(T('é¢æ¿è¨­ç½®å·²ä¿å­˜'),'success');
  showPlayerPanel();
}

function manualUpdatePlayerPanel(){
  if(!currentPlayerPanel?.attributes?.length){
    toast(T('è«‹å…ˆè¨­ç½®é¢æ¿å±¬æ€§'),'warning');
    return;
  }
  
  const container = document.getElementById('player-update-fields');
  let html = '';
  
  for(const attr of currentPlayerPanel.attributes){
    const value = currentPlayerPanel.values?.[attr.name] ?? attr.defaultValue ?? 0;
    html += `
      <div class="form-group">
        <label class="form-label">${attr.icon || 'ğŸ“Š'} ${esc(attr.name)}</label>
        <input type="${attr.type === 'text' ? 'text' : 'number'}" class="form-input" 
          data-attr-name="${esc(attr.name)}" value="${esc(String(value))}"
          ${attr.type === 'percent' ? `min="0" max="${attr.maxValue || 100}"` : ''}>
      </div>
    `;
  }
  
  container.innerHTML = html;
  closeModal('player-panel-modal');
  showModal('player-update-modal');
}

async function savePlayerUpdate(){
  if(!currentPlayerPanel) return;
  
  const inputs = document.querySelectorAll('#player-update-fields input[data-attr-name]');
  const newValues = {...currentPlayerPanel.values};
  
  inputs.forEach(input => {
    const attrName = input.dataset.attrName;
    const attr = currentPlayerPanel.attributes.find(a => a.name === attrName);
    if(attr){
      newValues[attrName] = attr.type === 'text' ? input.value : parseFloat(input.value) || 0;
    }
  });
  
  currentPlayerPanel.values = newValues;
  currentPlayerPanel.updatedAt = Date.now();
  await db.playerPanels.put(currentPlayerPanel);
  
  closeModal('player-update-modal');
  toast(T('ç‹€æ…‹å·²æ›´æ–°'),'success');
  showPlayerPanel();
}

async function aiGeneratePlayerPanel(){
  toast(T('AI æ­£åœ¨åˆ†æè¨­å®š...'),'info');
  
  try {
    // æ”¶é›†æ•…äº‹ä¿¡æ¯
    let context = '';
    if(story.systemPrompt){
      context += 'ã€System Promptã€‘\n' + story.systemPrompt.slice(0, 3000) + '\n\n';
    }
    
    const lorebooks = await db.lorebook.where('storyId').equals(story.id).limit(5).toArray();
    if(lorebooks.length){
      context += 'ã€Lorebook æ¢ç›®ã€‘\n';
      lorebooks.forEach(l => {
        context += `- ${l.name}: ${l.content?.slice(0, 200)}...\n`;
      });
    }
    
    const response = await callAI(`ä½ æ˜¯ä¸€å€‹æ–‡æ¸¸å±¬æ€§è¨­è¨ˆå°ˆå®¶ã€‚æ ¹æ“šä»¥ä¸‹è¨­å®šï¼Œæ¨è–¦é©åˆè¿½è¹¤çš„ç©å®¶å±¬æ€§ï¼ˆ5-10å€‹ï¼‰ï¼Œä¸¦æŒ‰åˆ†çµ„æ•´ç†ã€‚

${context}

è«‹ç”¨ JSON æ ¼å¼è¿”å›ï¼Œæ¯å€‹å±¬æ€§åŒ…å«ï¼š
- name: å±¬æ€§åç¨±
- icon: emoji åœ–æ¨™
- type: "number"ï¼ˆæ•¸å­—ï¼‰ã€"percent"ï¼ˆç™¾åˆ†æ¯” 0-100ï¼‰æˆ– "text"ï¼ˆæ–‡å­—ï¼‰
- defaultValue: åˆå§‹å€¼
- keywords: ç”¨æ–¼è‡ªå‹•è§£æçš„é—œéµè©æ•¸çµ„
- group: åˆ†çµ„åç¨±ï¼ˆstats=åŸºç¤å±¬æ€§, status=ç•¶å‰ç‹€æ…‹, finance=è²¡å‹™, æˆ–å…¶ä»–è‡ªå®šç¾©åˆ†çµ„åï¼‰
- color: é¡è‰²ï¼ˆred/orange/green/blue/purple/pink/defaultï¼‰

ç¯„ä¾‹ï¼š
\`\`\`json
[
  {"name": "é­…åŠ›", "icon": "âœ¨", "type": "number", "defaultValue": 50, "keywords": ["é­…åŠ›"], "group": "stats", "color": "pink"},
  {"name": "é«”åŠ›", "icon": "â¤ï¸", "type": "percent", "defaultValue": 100, "keywords": ["é«”åŠ›", "HP"], "group": "status", "color": "red"},
  {"name": "ç¾é‡‘", "icon": "ğŸ’°", "type": "number", "defaultValue": 1000, "keywords": ["ç¾é‡‘", "é¤˜é¡"], "group": "finance", "color": "green"},
  {"name": "è·ä½", "icon": "ğŸ‘”", "type": "text", "defaultValue": "æ–°äºº", "keywords": ["è·ä½", "è·ç´š"], "group": "status", "color": "blue"}
]
\`\`\`

åªè¿”å› JSONï¼Œä¸è¦å…¶ä»–å…§å®¹ã€‚`);
    
    const match = response.content.match(/```json\s*([\s\S]*?)\s*```/) || response.content.match(/\[\s*\{[\s\S]*\}\s*\]/);
    if(match){
      const attrs = JSON.parse(match[1] || match[0]);
      if(Array.isArray(attrs) && attrs.length){
        tempPlayerAttrs = attrs.map(a => ({
          name: a.name || 'æœªå‘½å',
          icon: a.icon || 'ğŸ“Š',
          type: ['number', 'percent', 'text'].includes(a.type) ? a.type : 'number',
          defaultValue: a.defaultValue ?? 0,
          maxValue: 100,
          keywords: Array.isArray(a.keywords) ? a.keywords : [],
          group: a.group || 'default',
          color: a.color || 'default'
        }));
        renderPlayerAttrList();
        toast(`å·²ç”Ÿæˆ ${tempPlayerAttrs.length} å€‹å±¬æ€§å»ºè­°`,'success');
      }
    } else {
      toast(T('AI è¿”å›æ ¼å¼éŒ¯èª¤'),'error');
    }
  } catch(e){
    toast('ç”Ÿæˆå¤±æ•—: ' + e.message,'error');
  }
}

// AI æ™ºèƒ½åŒæ­¥ - å¾å°è©±ä¸­è§£ææ•¸å€¼è®ŠåŒ–
async function aiSyncPlayerStatus(){
  if(!currentPlayerPanel?.attributes?.length){
    toast(T('è«‹å…ˆè¨­ç½®é¢æ¿å±¬æ€§'),'warning');
    return;
  }
  
  const btn = document.getElementById('player-sync-btn');
  btn.disabled = true;
  btn.innerHTML = 'â³ AI æ­£åœ¨åˆ†æå°è©±...';
  
  try {
    // ç²å–æœ€è¿‘çš„å°è©±è¨˜éŒ„
    const messages = await db.messages.where('storyId').equals(story.id).reverse().limit(20).toArray();
    if(!messages.length){
      toast(T('æ²’æœ‰å°è©±è¨˜éŒ„å¯åˆ†æ'),'warning');
      btn.disabled = false;
      btn.innerHTML = 'ğŸ¤– AI æ™ºèƒ½åŒæ­¥ï¼ˆå¾å°è©±ä¸­è§£ææ•¸å€¼è®ŠåŒ–ï¼‰';
      return;
    }
    
    const recentContent = messages.reverse().map(m => `[${m.role}]: ${m.content}`).join('\n\n');
    
    // æ§‹å»ºç•¶å‰å±¬æ€§ä¿¡æ¯
    const attrInfo = currentPlayerPanel.attributes.map(a => {
      const currentValue = currentPlayerPanel.values?.[a.name] ?? a.defaultValue;
      return `- ${a.icon} ${a.name} (${a.type}): ç•¶å‰å€¼=${currentValue}, é—œéµè©=[${[a.name, ...(a.keywords||[])].join(',')}]`;
    }).join('\n');
    
    const response = await callAI(`ä½ æ˜¯ä¸€å€‹æ–‡æ¸¸æ•¸å€¼è§£æå°ˆå®¶ã€‚è«‹æ ¹æ“šä»¥ä¸‹å°è©±å…§å®¹ï¼Œåˆ†æç©å®¶å±¬æ€§çš„è®ŠåŒ–ã€‚

ã€ç•¶å‰è¿½è¹¤çš„å±¬æ€§ã€‘
${attrInfo}

ã€æœ€è¿‘çš„å°è©±å…§å®¹ã€‘
${recentContent.slice(-4000)}

è«‹åˆ†æå°è©±ä¸­æåˆ°çš„æ•¸å€¼è®ŠåŒ–ï¼Œè¿”å› JSON æ ¼å¼ï¼š
\`\`\`json
{
  "changes": [
    {"name": "å±¬æ€§åç¨±", "newValue": æ–°æ•¸å€¼æˆ–æ–‡å­—, "reason": "è®ŠåŒ–åŸå› "}
  ],
  "summary": "ç°¡çŸ­çš„è®ŠåŒ–æ‘˜è¦"
}
\`\`\`

æ³¨æ„ï¼š
1. åªè¿”å›æœ‰è®ŠåŒ–çš„å±¬æ€§
2. æ•¸å­—é¡å‹è¿”å›æ•¸å­—ï¼Œç™¾åˆ†æ¯”é¡å‹è¿”å›0-100çš„æ•¸å­—ï¼Œæ–‡å­—é¡å‹è¿”å›å­—ç¬¦ä¸²
3. å¦‚æœæ²’æœ‰ç™¼ç¾ä»»ä½•è®ŠåŒ–ï¼Œè¿”å›ç©ºçš„ changes æ•¸çµ„
4. åªè¿”å› JSONï¼Œä¸è¦å…¶ä»–å…§å®¹`);
    
    const match = response.content.match(/```json\s*([\s\S]*?)\s*```/) || response.content.match(/\{[\s\S]*\}/);
    if(match){
      const result = JSON.parse(match[1] || match[0]);
      
      if(result.changes?.length){
        // é¡¯ç¤ºç¢ºèªå°è©±æ¡†
        let changeHtml = '<div style="max-height:300px;overflow-y:auto">';
        changeHtml += `<div style="margin-bottom:12px;color:var(--text-tertiary);font-size:12px">${esc(result.summary || '')}</div>`;
        
        for(const change of result.changes){
          const attr = currentPlayerPanel.attributes.find(a => a.name === change.name);
          if(attr){
            const oldValue = currentPlayerPanel.values?.[change.name] ?? attr.defaultValue;
            const isIncrease = typeof change.newValue === 'number' && typeof oldValue === 'number' && change.newValue > oldValue;
            const isDecrease = typeof change.newValue === 'number' && typeof oldValue === 'number' && change.newValue < oldValue;
            changeHtml += `
              <div style="padding:10px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:8px">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
                  <span>${attr.icon}</span>
                  <span style="font-weight:500">${esc(change.name)}</span>
                </div>
                <div style="display:flex;align-items:center;gap:8px;font-size:14px">
                  <span style="color:var(--text-tertiary)">${oldValue}</span>
                  <span style="color:${isIncrease ? 'var(--success)' : isDecrease ? 'var(--error)' : 'var(--text-primary)'}">â†’ ${change.newValue}</span>
                </div>
                <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">${esc(change.reason || '')}</div>
              </div>
            `;
          }
        }
        changeHtml += '</div>';
        
        // ä½¿ç”¨è‡¨æ™‚è®Šé‡ä¿å­˜è®ŠåŒ–
        window._pendingPlayerChanges = result.changes;
        
        document.getElementById('summary-preview-content').innerHTML = changeHtml;
        document.getElementById('summary-preview-title').textContent = 'ğŸ“Š å±¬æ€§è®ŠåŒ–é è¦½';
        document.getElementById('summary-preview-confirm-btn').onclick = applyPlayerChanges;
        showModal('summary-preview-modal');
      } else {
        toast(T('æœªç™¼ç¾å±¬æ€§è®ŠåŒ–'),'info');
      }
    } else {
      toast(T('AI è¿”å›æ ¼å¼éŒ¯èª¤'),'error');
    }
  } catch(e){
    toast('åŒæ­¥å¤±æ•—: ' + e.message,'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'ğŸ¤– AI æ™ºèƒ½åŒæ­¥ï¼ˆå¾å°è©±ä¸­è§£ææ•¸å€¼è®ŠåŒ–ï¼‰';
  }
}

// æ‡‰ç”¨å±¬æ€§è®ŠåŒ–
async function applyPlayerChanges(){
  const changes = window._pendingPlayerChanges;
  if(!changes?.length || !currentPlayerPanel) return;
  
  const newValues = {...currentPlayerPanel.values};
  
  for(const change of changes){
    const attr = currentPlayerPanel.attributes.find(a => a.name === change.name);
    if(attr){
      newValues[change.name] = change.newValue;
    }
  }
  
  currentPlayerPanel.values = newValues;
  currentPlayerPanel.updatedAt = Date.now();
  await db.playerPanels.put(currentPlayerPanel);
  
  closeModal('summary-preview-modal');
  toast(`å·²æ›´æ–° ${changes.length} å€‹å±¬æ€§`,'success');
  renderPlayerPanelContent();
  
  delete window._pendingPlayerChanges;
}

// è‡ªå‹•è§£æ AI å›è¦†ä¸­çš„ç©å®¶ç‹€æ…‹æ›´æ–°
async function parsePlayerStatusFromAI(content){
  if(!story) return;
  
  const panel = await db.playerPanels.where('storyId').equals(story.id).first();
  if(!panel?.attributes?.length) return;
  
  let updated = false;
  const newValues = {...panel.values};
  
  for(const attr of panel.attributes){
    // æ§‹å»ºé—œéµè©æ­£å‰‡
    const keywords = [attr.name, ...(attr.keywords || [])];
    for(const kw of keywords){
      // åŒ¹é…å„ç¨®æ ¼å¼ï¼šã€Œç¾é‡‘ï¼š1000ã€ã€Œç¾é‡‘: 1000ã€ã€ŒğŸ’° 1000ã€ã€Œç¾é‡‘ â†’ 1000ã€
      const patterns = [
        new RegExp(`${kw}[ï¼š:\\sâ†’]+([\\d,.-]+)`, 'i'),
        new RegExp(`${attr.icon}\\s*[ï¼š:\\sâ†’]*([\\d,.-]+)`, 'i'),
        new RegExp(`${kw}[ï¼š:\\sâ†’]+([^\\d]*?)([\\d,.-]+)`, 'i')
      ];
      
      for(const pattern of patterns){
        const match = content.match(pattern);
        if(match){
          let value = match[1] || match[2];
          value = value.replace(/,/g, '');
          
          if(attr.type === 'text'){
            newValues[attr.name] = value;
          } else {
            const num = parseFloat(value);
            if(!isNaN(num)){
              newValues[attr.name] = num;
              updated = true;
              break;
            }
          }
        }
      }
    }
  }
  
  if(updated){
    panel.values = newValues;
    panel.updatedAt = Date.now();
    await db.playerPanels.put(panel);
  }
}

// ============ AI ç”Ÿæˆ Lorebook ============
function showAiLorebookModal(){
  if(!story){toast(T('è«‹å…ˆé¸æ“‡æ•…äº‹'),'warning');return;}
  document.getElementById('ai-lorebook-input').value = '';
  document.getElementById('ai-lorebook-preview').style.display = 'none';
  showModal('ai-lorebook-modal');
}

async function generateAiLorebook(){
  const input = document.getElementById('ai-lorebook-input').value.trim();
  if(!input){toast(T('è«‹è²¼å…¥è¨­å®šæ›¸å…§å®¹'),'warning');return;}
  
  const extractChars = document.getElementById('ai-lorebook-chars').checked;
  const extractPlayer = document.getElementById('ai-lorebook-player').checked;
  
  const btn = document.getElementById('ai-lorebook-generate-btn');
  btn.textContent = 'â³ ç”Ÿæˆä¸­...';
  btn.disabled = true;
  
  try {
    const response = await callAI(`ä½ æ˜¯ä¸€å€‹ Lorebook æ‹†åˆ†å°ˆå®¶ã€‚è«‹å°‡ä»¥ä¸‹è¨­å®šæ›¸æ‹†åˆ†æˆå¤šå€‹ Lorebook æ¢ç›®ã€‚

ã€è¨­å®šæ›¸å…§å®¹ã€‘
${input.slice(0, 8000)}

ã€è¦æ±‚ã€‘
1. æ¯å€‹æ¢ç›®æ‡‰è©²æ˜¯ä¸€å€‹ç¨ç«‹çš„è¨­å®šç‰‡æ®µï¼ˆå¦‚ï¼šä¸€å€‹è§’è‰²ã€ä¸€å€‹åœ°é»ã€ä¸€å€‹ç³»çµ±è¦å‰‡ï¼‰
2. ç‚ºæ¯å€‹æ¢ç›®è¨­å®š 2-5 å€‹è§¸ç™¼é—œéµè©
3. ${extractChars ? 'è­˜åˆ¥å‡ºæ‰€æœ‰è§’è‰²ï¼Œæ¨™è¨˜ isCharacter: true' : 'ä¸éœ€è¦ç‰¹åˆ¥æ¨™è¨˜è§’è‰²'}
4. ${extractPlayer ? 'è­˜åˆ¥å‡ºç©å®¶/ä¸»è§’éœ€è¦è¿½è¹¤çš„å±¬æ€§ï¼Œæ¨™è¨˜ç‚º playerAttributes' : 'ä¸éœ€è¦æå–ç©å®¶å±¬æ€§'}

è«‹ç”¨ JSON æ ¼å¼è¿”å›ï¼š
\`\`\`json
{
  "entries": [
    {
      "name": "æ¢ç›®åç¨±",
      "keywords": ["é—œéµè©1", "é—œéµè©2"],
      "content": "æ¢ç›®å…§å®¹...",
      "isCharacter": false
    }
  ],
  "characters": [
    {
      "name": "è§’è‰²å",
      "title": "é ­éŠœ/èº«ä»½",
      "avatar": "emoji",
      "description": "è§’è‰²æè¿°",
      "personality": "æ€§æ ¼"
    }
  ],
  "playerAttributes": [
    {
      "name": "å±¬æ€§å",
      "icon": "emoji",
      "type": "number/percent/text",
      "defaultValue": 0,
      "keywords": ["é—œéµè©"]
    }
  ]
}
\`\`\`

åªè¿”å› JSONï¼Œä¸è¦å…¶ä»–å…§å®¹ã€‚`);
    
    const match = response.content.match(/```json\s*([\s\S]*?)\s*```/) || response.content.match(/\{[\s\S]*"entries"[\s\S]*\}/);
    if(!match) throw new Error('AI è¿”å›æ ¼å¼éŒ¯èª¤');
    
    const result = JSON.parse(match[1] || match[0]);
    
    // é è¦½
    let previewHtml = '';
    
    if(result.entries?.length){
      previewHtml += `<div style="margin-bottom:12px"><strong>ğŸ“š Lorebook æ¢ç›® (${result.entries.length})</strong></div>`;
      result.entries.slice(0, 5).forEach(e => {
        previewHtml += `<div style="padding:6px 0;border-bottom:1px solid var(--divider)">
          <div style="font-weight:500">${esc(e.name)}</div>
          <div style="font-size:11px;color:var(--text-tertiary)">é—œéµè©: ${e.keywords?.join(', ') || 'ç„¡'}</div>
        </div>`;
      });
      if(result.entries.length > 5){
        previewHtml += `<div style="font-size:11px;color:var(--text-tertiary);padding:6px 0">...é‚„æœ‰ ${result.entries.length - 5} å€‹æ¢ç›®</div>`;
      }
    }
    
    if(result.characters?.length){
      previewHtml += `<div style="margin:12px 0 8px"><strong>ğŸ‘¥ è§’è‰² (${result.characters.length})</strong></div>`;
      result.characters.forEach(c => {
        previewHtml += `<div style="padding:4px 0">${c.avatar || 'ğŸ‘¤'} ${esc(c.name)} ${c.title ? '- ' + esc(c.title) : ''}</div>`;
      });
    }
    
    if(result.playerAttributes?.length){
      previewHtml += `<div style="margin:12px 0 8px"><strong>ğŸ“‹ ç©å®¶å±¬æ€§ (${result.playerAttributes.length})</strong></div>`;
      result.playerAttributes.forEach(a => {
        previewHtml += `<div style="padding:4px 0">${a.icon || 'ğŸ“Š'} ${esc(a.name)}</div>`;
      });
    }
    
    document.getElementById('ai-lorebook-preview-content').innerHTML = previewHtml;
    document.getElementById('ai-lorebook-preview').style.display = 'block';
    
    // æ›´æ”¹æŒ‰éˆ•ç‚ºç¢ºèªå°å…¥
    btn.textContent = 'âœ… ç¢ºèªå°å…¥';
    btn.onclick = async () => {
      await importAiLorebookResult(result);
    };
    btn.disabled = false;
    
  } catch(e){
    toast('ç”Ÿæˆå¤±æ•—: ' + e.message,'error');
    btn.textContent = 'ğŸ¤– é–‹å§‹ç”Ÿæˆ';
    btn.disabled = false;
  }
}

async function importAiLorebookResult(result){
  let counts = { entries: 0, characters: 0, attributes: 0 };
  
  // å°å…¥ Lorebook æ¢ç›®
  if(result.entries?.length){
    for(const e of result.entries){
      await db.lorebook.put({
        id: crypto.randomUUID(),
        storyId: story.id,
        name: e.name || 'æœªå‘½å',
        keywords: e.keywords || [e.name],
        content: e.content || '',
        depth: 2,
        priority: 100,
        cooldown: 0,
        maxTriggers: 0,
        oneTime: false,
        conditions: [],
        conditionLogic: 'AND',
        isEnabled: true,
        triggerCount: 0,
        lastTriggered: null,
        createdAt: Date.now(),
        updatedAt: Date.now()
      });
      counts.entries++;
    }
  }
  
  // å°å…¥è§’è‰²
  if(result.characters?.length){
    for(const c of result.characters){
      await db.characters.put({
        id: crypto.randomUUID(),
        storyId: story.id,
        name: c.name || 'æœªå‘½å',
        title: c.title || '',
        avatar: c.avatar || 'ğŸ‘¤',
        description: c.description || '',
        personality: c.personality || '',
        stats: {},
        tags: [],
        relations: [],
        mood: '',
        note: '',
        location: '',
        createdAt: Date.now(),
        updatedAt: Date.now()
      });
      counts.characters++;
    }
  }
  
  // å°å…¥ç©å®¶å±¬æ€§
  if(result.playerAttributes?.length){
    let panel = await db.playerPanels.where('storyId').equals(story.id).first();
    const newAttrs = result.playerAttributes.map(a => ({
      name: a.name || 'æœªå‘½å',
      icon: a.icon || 'ğŸ“Š',
      type: ['number', 'percent', 'text'].includes(a.type) ? a.type : 'number',
      defaultValue: a.defaultValue ?? 0,
      maxValue: 100,
      keywords: a.keywords || []
    }));
    
    if(panel){
      panel.attributes = [...(panel.attributes || []), ...newAttrs];
      newAttrs.forEach(a => {
        if(!(a.name in panel.values)){
          panel.values[a.name] = a.defaultValue;
        }
      });
    } else {
      const values = {};
      newAttrs.forEach(a => values[a.name] = a.defaultValue);
      panel = {
        id: crypto.randomUUID(),
        storyId: story.id,
        name: 'æˆ‘çš„ç‹€æ…‹',
        attributes: newAttrs,
        values,
        createdAt: Date.now(),
        updatedAt: Date.now()
      };
    }
    await db.playerPanels.put(panel);
    counts.attributes = newAttrs.length;
  }
  
  closeModal('ai-lorebook-modal');
  
  let msg = 'å°å…¥å®Œæˆï¼';
  if(counts.entries) msg += ` ${counts.entries} å€‹æ¢ç›®`;
  if(counts.characters) msg += ` ${counts.characters} å€‹è§’è‰²`;
  if(counts.attributes) msg += ` ${counts.attributes} å€‹å±¬æ€§`;
  
  toast(msg, 'success');
  renderLorebook();
}

// ç²å–ç•¶å‰å ´æ™¯çš„è§’è‰²ä¿¡æ¯ï¼ˆç”¨æ–¼ System Promptï¼‰
async function getActiveScenePrompt(){
  if(!story) return '';
  
  const activeScene = await db.scenes.where('storyId').equals(story.id).filter(s => s.isActive).first();
  if(!activeScene || !activeScene.characterIds?.length) return '';
  
  let prompt = `\n\n### ç•¶å‰å ´æ™¯ï¼š${activeScene.name}\n`;
  if(activeScene.description){
    prompt += `${activeScene.description}\n\n`;
  }
  prompt += `åœ¨å ´è§’è‰²ï¼š\n`;
  
  for(const cid of activeScene.characterIds){
    const char = await db.characters.get(cid);
    if(char){
      prompt += `- **${char.name}**`;
      if(char.title) prompt += `ï¼ˆ${char.title}ï¼‰`;
      if(char.mood) prompt += ` [ç•¶å‰æƒ…ç·’ï¼š${char.mood}]`;
      prompt += '\n';
    }
  }
  
  prompt += `\nè«‹è®“é€™äº›åœ¨å ´çš„è§’è‰²æ ¹æ“šå„è‡ªçš„æ€§æ ¼å’Œé—œä¿‚é€²è¡Œäº’å‹•ï¼Œå¯ä»¥æœ‰å°è©±ã€å‹•ä½œã€è¡¨æƒ…ç­‰ã€‚\n`;
  
  return prompt;
}

// é¡¯ç¤ºè§’è‰²è©³æƒ…
async function showCharDetail(charId){
  currentCharacterId = charId;
  const char = await db.characters.get(charId);
  if(!char){toast(T('è§’è‰²ä¸å­˜åœ¨'),'error');return;}
  
  document.getElementById('char-detail-title').textContent = char.name + ' è©³æƒ…';
  
  // åˆ†é¡æ¨™ç±¤
  const categoryLabels = {
    'protagonist': 'â­ ä¸»è§’',
    'supporting': 'ğŸ‘¤ é…è§’',
    'npc': 'ğŸ‘¥ NPC'
  };
  const categoryLabel = categoryLabels[char.category] || 'ğŸ‘¤ é…è§’';
  
  let html = `
    <div style="text-align:center;margin-bottom:16px">
      <div style="width:64px;height:64px;border-radius:16px;background:linear-gradient(135deg,var(--primary),var(--primary-light));display:inline-flex;align-items:center;justify-content:center;font-size:32px;background-size:cover;background-position:center;overflow:hidden">${char.avatarImage ? `<img src="${char.avatarImage}" style="width:100%;height:100%;object-fit:cover">` : (char.avatar||'ğŸ‘¤')}</div>
      <div style="font-size:18px;font-weight:600;margin-top:8px">${esc(char.name)}</div>
      ${char.title?`<div style="font-size:13px;color:var(--text-secondary)">${esc(char.title)}</div>`:''}
      <div style="font-size:11px;color:var(--primary);margin-top:4px">${categoryLabel}</div>
    </div>
  `;
  
  // æ€§æ ¼
  if(char.personality){
    html += `<div style="font-size:12px;color:var(--text-tertiary);margin-bottom:4px">ğŸ­ æ€§æ ¼</div>`;
    html += `<div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px;padding:10px;background:var(--bg-tertiary);border-radius:8px">${esc(char.personality)}</div>`;
  }
  
  // æè¿°
  if(char.description){
    html += `<div style="font-size:12px;color:var(--text-tertiary);margin-bottom:4px">ğŸ“ æè¿°</div>`;
    html += `<div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px;padding:10px;background:var(--bg-tertiary);border-radius:8px;max-height:120px;overflow-y:auto">${esc(char.description)}</div>`;
  }
  
  // å±¬æ€§
  if(char.stats && Object.keys(char.stats).length){
    html += `<div style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">ğŸ“Š å±¬æ€§</div>`;
    html += `<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:12px">`;
    for(const [k,v] of Object.entries(char.stats)){
      html += `<div style="background:var(--bg-tertiary);padding:8px;border-radius:6px;font-size:13px"><span style="color:var(--text-secondary)">${esc(k)}:</span> <strong>${esc(String(v))}</strong></div>`;
    }
    html += `</div>`;
  }
  
  // æ¨™ç±¤
  if(char.tags && char.tags.length){
    html += `<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px">${char.tags.map(t=>`<span style="font-size:11px;padding:4px 8px;background:var(--bg-tertiary);border-radius:8px">${esc(t)}</span>`).join('')}</div>`;
  }
  
  // v25: é—œä¿‚ä¿¡æ¯
  if(char.relationships && char.relationships.length){
    html += `<div style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">ğŸ‘¥ é—œä¿‚</div>`;
    html += `<div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px">`;
    char.relationships.forEach(rel => {
      const typeInfo = RELATIONSHIP_TYPES.find(t => t.code === rel.type);
      const icon = typeInfo ? typeInfo.icon : 'ğŸ”—';
      const color = typeInfo ? typeInfo.color : '#888';
      html += `
        <div style="background:var(--bg-tertiary);padding:8px 10px;border-radius:6px;font-size:13px;display:flex;align-items:center;gap:8px">
          <span style="font-size:14px">${icon}</span>
          <span style="color:var(--text-secondary)">${esc(rel.targetName || 'æœªçŸ¥è§’è‰²')}</span>
          <span style="color:${color};font-weight:500">${esc(rel.label || rel.type)}</span>
          ${rel.mutual ? '<span style="font-size:10px;color:var(--text-tertiary)">â†”ï¸</span>' : ''}
        </div>
      `;
    });
    html += `</div>`;
  }
  
  // v25: è¡¨æƒ…é è¦½
  if(char.expressions && char.expressions.length){
    html += `<div style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">ğŸ¨ è¡¨æƒ…ï¼ˆ${char.expressionMode === 'auto' ? 'AIè‡ªå‹•åˆ‡æ›' : 'æ‰‹å‹•åˆ‡æ›'}ï¼‰</div>`;
    html += `<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px">`;
    char.expressions.forEach(expr => {
      const isDefault = expr.isDefault ? 'border:2px solid var(--success);' : '';
      html += `
        <div style="text-align:center">
          <img src="${expr.image}" style="width:50px;height:50px;border-radius:8px;object-fit:cover;${isDefault}">
          <div style="font-size:10px;color:var(--text-secondary);margin-top:2px">${esc(expr.name)}</div>
        </div>
      `;
    });
    html += `</div>`;
  }
  
  // V2 å­—æ®µæ‘˜è¦ï¼ˆå¦‚æœæœ‰ï¼‰
  let v2Features = [];
  if(char.first_mes) v2Features.push('é–‹å ´ç™½');
  if(char.alternate_greetings?.length) v2Features.push(`${char.alternate_greetings.length}å€‹æ›¿ä»£é–‹å ´ç™½`);
  if(char.mes_example) v2Features.push('å°è©±ç¤ºä¾‹');
  if(char.system_prompt) v2Features.push('å°ˆå±¬ç³»çµ±æç¤º');
  if(char.character_book?.entries?.length) v2Features.push(`${char.character_book.entries.length}å€‹Lorebookæ¢ç›®`);
  if(char.relationships?.length) v2Features.push(`${char.relationships.length}å€‹é—œä¿‚`);
  if(char.expressions?.length) v2Features.push(`${char.expressions.length}å€‹è¡¨æƒ…`);
  
  if(v2Features.length){
    html += `<div style="font-size:11px;color:var(--primary);background:rgba(139,124,247,.1);padding:8px 10px;border-radius:6px;margin-bottom:12px">âœ¨ åŒ…å«ï¼š${v2Features.join('ã€')}</div>`;
  }
  
  // å‰µä½œè€…ä¿¡æ¯
  if(char.creator || char.character_version){
    html += `<div style="font-size:11px;color:var(--text-tertiary);margin-bottom:4px">`;
    if(char.creator) html += `å‰µä½œè€…: ${esc(char.creator)} `;
    if(char.character_version) html += `v${esc(char.character_version)}`;
    html += `</div>`;
  }
  
  html += `<div style="font-size:11px;color:var(--text-tertiary);text-align:right">æ›´æ–°æ–¼ ${fmtDate(char.updatedAt)}</div>`;
  
  document.getElementById('char-detail-content').innerHTML = html;
  showModal('char-detail-modal');
}

// ç·¨è¼¯è§’è‰²ï¼ˆè·³è½‰åˆ°æ·»åŠ é é¢ä¸¦å¡«å……æ•¸æ“šï¼‰
async function editCharacter(){
  try {
    if(!currentCharacterId) {
      return;
    }
    const char = await db.characters.get(currentCharacterId);
    if(!char) {
      toast(T('æ‰¾ä¸åˆ°è§’è‰²æ•¸æ“š'), 'error');
      return;
    }
    
    // åªé—œé–‰è©³æƒ…æ¨¡æ…‹æ¡†ï¼Œä¸ç§»é™¤overlay
    document.getElementById('char-detail-modal').classList.remove('active');
    
    // è¨­ç½®ç·¨è¼¯æ¨¡å¼
    editingCharacterId = currentCharacterId;
    
    // å®‰å…¨è¨­ç½®å€¼çš„è¼”åŠ©å‡½æ•¸
    const setVal = (id, val) => {
      const el = document.getElementById(id);
      if(el) el.value = val;
    };
    
    // å¡«å……åŸºæœ¬ä¿¡æ¯
    setVal('char-add-name', char.name || '');
    setVal('char-add-title', char.title || '');
    setVal('char-add-avatar', char.avatar || '');
    setVal('char-add-category', char.category || 'supporting');
    setVal('char-add-desc', char.description || '');
    setVal('char-add-personality', char.personality || '');
    setVal('char-add-tags', (char.tags || []).join(', '));
    
    // å¡«å……å°è©±è¨­ç½®
    setVal('char-add-firstmes', char.first_mes || '');
    setVal('char-add-scenario', char.scenario || '');
    setVal('char-add-example', char.mes_example || '');
    
    // æ›¿ä»£é–‹å ´ç™½
    charAltGreetings = char.alternate_greetings || [];
    renderAltGreetings();
    
    // å¡«å……é«˜ç´šè¨­ç½®
    setVal('char-add-sysprompt', char.system_prompt || '');
    setVal('char-add-posthistory', char.post_history_instructions || '');
    setVal('char-add-creatornotes', char.creator_notes || '');
    setVal('char-add-creator', char.creator || '');
    setVal('char-add-version', char.character_version || '1.0');
    
    // Lorebook
    if(char.character_book){
      setVal('char-add-lore-trigger', char.character_book.triggerMode || 'scene');
      charLorebookEntries = char.character_book.entries || [];
    } else {
      setVal('char-add-lore-trigger', 'scene');
      charLorebookEntries = [];
    }
    renderCharLorebookEntries();
    
    // v25: é—œä¿‚æ•¸æ“š
    charRelationships = char.relationships || [];
    renderCharRelationships();
    
    // v25: è¡¨æƒ…æ•¸æ“š
    charExpressions = char.expressions || [];
    setVal('char-add-expr-mode', char.expressionMode || 'manual');
    renderCharExpressions();
    
    // å±¬æ€§
    if(char.stats && Object.keys(char.stats).length > 0){
      setVal('char-add-stats', Object.entries(char.stats).map(([k,v])=>`${k}:${v}`).join('\n'));
    } else {
      setVal('char-add-stats', '');
    }
    
    // æ›´æ–°æ¨™é¡Œ
    const titleEl = document.getElementById('char-modal-title');
    if(titleEl) titleEl.textContent = 'âœï¸ ç·¨è¼¯è§’è‰²';
    
    // é‡ç½®é¢æ¿ç‹€æ…‹ï¼ˆåªå±•é–‹åŸºæœ¬ä¿¡æ¯ï¼‰
    document.querySelectorAll('.char-panel').forEach(p => {
      const panel = p.dataset.panel;
      const content = p.querySelector('.char-panel-content');
      const arrow = p.querySelector('.char-panel-arrow');
      if(content && arrow){
        if(panel === 'basic'){
          content.style.display = 'block';
          arrow.textContent = 'â–¼';
          p.classList.add('expanded');
        } else {
          content.style.display = 'none';
          arrow.textContent = 'â–¶';
          p.classList.remove('expanded');
        }
      }
    });
    
    updateCharTokenCount();
    
    // ç¢ºä¿overlayæ˜¯activeçš„ï¼Œç„¶å¾Œç›´æ¥æ‰“é–‹ç·¨è¼¯æ¨¡æ…‹æ¡†
    document.getElementById('overlay').classList.add('active');
    document.getElementById('char-add-modal').classList.add('active');
  } catch(err) {
    console.error('editCharacter error:', err);
    toast(T('ç·¨è¼¯è§’è‰²æ™‚å‡ºéŒ¯: ') + err.message, 'error');
  }
}

// åˆªé™¤è§’è‰²
async function deleteCharacter(){
  if(!currentCharacterId) return;
  if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹è§’è‰²å—ï¼Ÿ')) return;
  
  await db.characters.delete(currentCharacterId);
  await db.characterHistory.where('characterId').equals(currentCharacterId).delete();
  closeModal('char-detail-modal');
  currentCharacterId = null;
  renderCharacters();
  toast(T('è§’è‰²å·²åˆªé™¤'),'success');
}

// é¡¯ç¤ºè§’è‰²æ­·å²
async function showCharHistory(charId){
  const history = await db.characterHistory.where('characterId').equals(charId).reverse().toArray();
  const char = await db.characters.get(charId);
  
  let html = '';
  if(!history.length){
    html = '<div style="text-align:center;padding:20px;color:var(--text-secondary)">æš«ç„¡å±¬æ€§è®ŠåŒ–è¨˜éŒ„</div>';
  }else{
    html = history.map(h => {
      const changeHtml = h.changes.map(c => {
        const diff = (parseInt(c.to)||0) - (parseInt(c.from)||0);
        const color = diff > 0 ? 'var(--success)' : diff < 0 ? 'var(--error)' : 'var(--text-secondary)';
        const arrow = diff > 0 ? 'â†‘' : diff < 0 ? 'â†“' : 'â†’';
        return `<span style="display:inline-block;margin:2px 4px;padding:2px 6px;background:var(--bg-tertiary);border-radius:4px;font-size:11px">${esc(c.attr)}: ${c.from} <span style="color:${color}">${arrow} ${c.to}</span></span>`;
      }).join('');
      return `<div style="padding:10px;border-bottom:1px solid var(--divider)">
        <div style="font-size:11px;color:var(--text-tertiary);margin-bottom:4px">${fmtDate(h.createdAt)}</div>
        <div>${changeHtml}</div>
      </div>`;
    }).join('');
  }
  
  document.getElementById('char-history-content').innerHTML = html;
  showModal('char-history-modal');
}

// åœ¨å£“ç¸®è¨˜æ†¶å‰ä¿å­˜è§’è‰²å¿«ç…§
async function saveCharacterSnapshot(){
  if(!story) return;
  const chars = await db.characters.where('storyId').equals(story.id).toArray();
  if(!chars.length) return;
  
  await db.characterSnapshots.add({
    id: crypto.randomUUID(),
    storyId: story.id,
    characters: chars,
    messageCount: msgs.length,
    createdAt: Date.now()
  });
}

// é¡¯ç¤ºæ•¸å€¼è®ŠåŒ–å‹•ç•«
function showValueChange(element, value, isUp){
  const rect = element.getBoundingClientRect();
  const change = document.createElement('div');
  change.className = 'char-value-change ' + (isUp ? 'up' : 'down');
  change.textContent = (isUp ? '+' : '') + value + (isUp ? ' â†‘' : ' â†“');
  change.style.left = rect.left + 'px';
  change.style.top = rect.top + 'px';
  document.body.appendChild(change);
  setTimeout(() => change.remove(), 1500);
}

// åœ¨goToå‡½æ•¸ä¸­æ·»åŠ è§’è‰²è¦–åœ–çš„æ¸²æŸ“
const originalGoTo = typeof goTo === 'function' ? goTo : null;

// æ•¸æ“šå°å…¥å°å‡º
async function exportAll(){
  showLoading('å°å‡ºä¸­...');
  try{
    const data={
      version:'4.6',
      exportedAt:Date.now(),
      stories:await db.stories.toArray(),
      messages:await db.messages.toArray(),
      branches:await db.branches.toArray(),
      instructions:await db.instructions.toArray(),
      storyInstructions:await db.storyInstructions.toArray(),
      loreEntries:await db.loreEntries.toArray(),
      foreshadowing:await db.foreshadowing.toArray(),
      events:await db.events.toArray(),
      saves:await db.saves.toArray(),
      apiPresets:await db.apiPresets.toArray(),
      settings:await db.settings.toArray(),
      timeline:await db.timeline.toArray(),
      chapters:await db.chapters.toArray(),
      bookmarks:await db.bookmarks.toArray(),
      plotTags:await db.plotTags.toArray(),
      characters:await db.characters.toArray(),
      characterSnapshots:await db.characterSnapshots.toArray(),
      characterHistory:await db.characterHistory.toArray(),
      lorebook:await db.lorebook.toArray(),
      lorebookTriggerLog:await db.lorebookTriggerLog.toArray(),
      // v16 æ–°å¢
      quickCommands:await db.quickCommands.toArray(),
      scenes:await db.scenes.toArray(),
      // è£œå……éºæ¼çš„è¡¨
      characterStates:await db.characterStates.toArray()
    };
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;a.download=`zhimeng_backup_${new Date().toISOString().slice(0,10)}.json`;a.click();
    URL.revokeObjectURL(url);
    toast(T('æ•¸æ“šå°å‡ºæˆåŠŸï¼'),'success');
  }catch(e){toast('å°å‡ºå¤±æ•—: '+e.message,'error');}
  hideLoading();
}
function importAll(){
  const input=document.getElementById('import-input');
  input.onchange=async e=>{
    const f=e.target.files[0];if(!f)return;
    showLoading('å°å…¥ä¸­...');
    try{
      const text=await f.text(),data=JSON.parse(text);
      if(!data.version||!data.stories)throw new Error('ç„¡æ•ˆçš„å‚™ä»½æ–‡ä»¶');
      if(data.stories)await db.stories.bulkPut(data.stories);
      if(data.messages)await db.messages.bulkPut(data.messages);
      if(data.branches)await db.branches.bulkPut(data.branches);
      if(data.instructions)await db.instructions.bulkPut(data.instructions);
      if(data.storyInstructions)await db.storyInstructions.bulkPut(data.storyInstructions);
      if(data.loreEntries)await db.loreEntries.bulkPut(data.loreEntries);
      if(data.foreshadowing)await db.foreshadowing.bulkPut(data.foreshadowing);
      if(data.events)await db.events.bulkPut(data.events);
      if(data.saves)await db.saves.bulkPut(data.saves);
      if(data.apiPresets)await db.apiPresets.bulkPut(data.apiPresets);
      if(data.settings)await db.settings.bulkPut(data.settings);
      if(data.timeline)await db.timeline.bulkPut(data.timeline);
      if(data.chapters)await db.chapters.bulkPut(data.chapters);
      if(data.bookmarks)await db.bookmarks.bulkPut(data.bookmarks);
      if(data.plotTags)await db.plotTags.bulkPut(data.plotTags);
      // v7: è§’è‰²æ•¸æ“š
      if(data.characters)await db.characters.bulkPut(data.characters);
      if(data.characterSnapshots)await db.characterSnapshots.bulkPut(data.characterSnapshots);
      if(data.characterHistory)await db.characterHistory.bulkPut(data.characterHistory);
      // v13: Lorebook æ•¸æ“š
      if(data.lorebook)await db.lorebook.bulkPut(data.lorebook);
      if(data.lorebookTriggerLog)await db.lorebookTriggerLog.bulkPut(data.lorebookTriggerLog);
      // v16: å¿«æ·æŒ‡ä»¤å’Œå ´æ™¯
      if(data.quickCommands)await db.quickCommands.bulkPut(data.quickCommands);
      if(data.scenes)await db.scenes.bulkPut(data.scenes);
      // è£œå……éºæ¼çš„è¡¨
      if(data.characterStates)await db.characterStates.bulkPut(data.characterStates);
      await loadSettings();await renderStories();await renderInst();await renderQuickCommands();
      toast(T('æ•¸æ“šå°å…¥æˆåŠŸï¼'),'success');
    }catch(e){toast('å°å…¥å¤±æ•—: '+e.message,'error');}
    hideLoading();input.value='';
  };
  input.click();
}
function clearAll(){showConfirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ•¸æ“šå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ï¼',async()=>{showLoading('æ¸…ç©ºä¸­...');try{await db.delete();await initDB();await renderStories();await renderInst();toast(T('æ•¸æ“šå·²æ¸…ç©º'),'success');}catch(e){toast('æ¸…ç©ºå¤±æ•—: '+e.message,'error');}hideLoading();},true);}

// Toast & Loading
let toastTimeout = null;
function toast(msg,type=''){
  const t=document.getElementById('toast');
  document.getElementById('toast-text').textContent=msg;
  t.className='toast active '+type;
  // æ¸…é™¤ä¹‹å‰çš„å®šæ™‚å™¨ï¼Œé¿å…é‡ç–Š
  if(toastTimeout) clearTimeout(toastTimeout);
  toastTimeout = setTimeout(()=>{
    t.classList.remove('active');
    toastTimeout = null;
  },2500);
}
function showLoading(txt='è™•ç†ä¸­...'){document.getElementById('loading-text').textContent=txt;document.getElementById('loading').classList.add('active');}
function hideLoading(){document.getElementById('loading').classList.remove('active');}

// å·¥å…·å‡½æ•¸
function esc(t){if(!t)return'';const d=document.createElement('div');d.textContent=t;return d.innerHTML;}
function fmtNum(n){return n>=10000?(n/10000).toFixed(1)+'è¬':n.toLocaleString();}
function fmtDate(ts){if(!ts)return'æœªçŸ¥';const d=new Date(ts);return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;}
function timeAgo(ts){const d=Date.now()-ts,m=Math.floor(d/60000),h=Math.floor(d/3600000),dy=Math.floor(d/86400000);if(m<1)return'å‰›å‰›';if(m<60)return m+'åˆ†é˜å‰';if(h<24)return h+'å°æ™‚å‰';if(dy<7)return dy+'å¤©å‰';const dt=new Date(ts);return(dt.getMonth()+1)+'/'+dt.getDate();}

console.log('ç¹”å¤¢ v5.3 - AIäº’å‹•å°èªªé–±è®€å™¨ æº–å‚™å°±ç·’ï¼');

// PWA æ”¯æŒ
let deferredPrompt = null;

// è¨»å†Š Service Worker (ä½¿ç”¨å…§åµŒæ–¹å¼)
// æ³¨æ„ï¼šBlob URL æ–¹å¼åœ¨æŸäº›ç€è¦½å™¨ï¼ˆå¦‚ Safariï¼‰å¯èƒ½ä¸æ”¯æŒï¼Œé€™æ˜¯æ­£å¸¸ç¾è±¡
if ('serviceWorker' in navigator) {
  const swCode = `
    const CACHE_NAME = 'zhimeng-v5.3';
    const urlsToCache = [self.location.href];
    
    self.addEventListener('install', e => {
      e.waitUntil(
        caches.open(CACHE_NAME)
          .then(cache => cache.addAll(urlsToCache))
          .then(() => self.skipWaiting())
      );
    });
    
    self.addEventListener('activate', e => {
      e.waitUntil(
        caches.keys().then(names => 
          Promise.all(names.filter(n => n !== CACHE_NAME).map(n => caches.delete(n)))
        ).then(() => self.clients.claim())
      );
    });
    
    self.addEventListener('fetch', e => {
      if (e.request.method !== 'GET') return;
      e.respondWith(
        caches.match(e.request).then(cached => {
          const fetchPromise = fetch(e.request).then(response => {
            if (response.ok) {
              const clone = response.clone();
              caches.open(CACHE_NAME).then(cache => cache.put(e.request, clone));
            }
            return response;
          }).catch(() => cached);
          return cached || fetchPromise;
        })
      );
    });
  `;
  
  try {
    const swBlob = new Blob([swCode], {type: 'application/javascript'});
    const swUrl = URL.createObjectURL(swBlob);
    
    navigator.serviceWorker.register(swUrl, {scope: './'})
      .then(reg => console.log('ServiceWorker è¨»å†ŠæˆåŠŸ:', reg.scope))
      .catch(err => {
        // Blob URL æ–¹å¼åœ¨æŸäº›ç’°å¢ƒä¸‹ä¸æ”¯æŒï¼Œé€™æ˜¯æ­£å¸¸çš„
        console.log('ServiceWorker è¨»å†Šå¤±æ•— (Blob URL æ–¹å¼å¯èƒ½ä¸å—æ”¯æŒ):', err.message);
      });
  } catch(e) {
    console.log('ServiceWorker åˆå§‹åŒ–å¤±æ•—:', e.message);
  }
}

// å‰µå»ºä¸¦æ³¨å…¥ manifest
const manifest = {
  "name": "ç¹”å¤¢ - AIäº’å‹•å°èªªé–±è®€å™¨",
  "short_name": "ç¹”å¤¢",
  "description": "AIäº’å‹•å°èªªé–±è®€å™¨ - å‰µå»ºä½ çš„å°ˆå±¬æ•…äº‹",
  "start_url": "./",
  "display": "standalone",
  "background_color": "#0F0F1A",
  "theme_color": "#8B7CF7",
  "orientation": "portrait",
  "icons": [
    {
      "src": "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect fill='%238B7CF7' width='512' height='512' rx='80'/><text x='256' y='340' text-anchor='middle' fill='white' font-size='280' font-family='serif'>ç¹”</text></svg>",
      "sizes": "512x512",
      "type": "image/svg+xml",
      "purpose": "any maskable"
    },
    {
      "src": "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%238B7CF7' width='192' height='192' rx='30'/><text x='96' y='130' text-anchor='middle' fill='white' font-size='110' font-family='serif'>ç¹”</text></svg>",
      "sizes": "192x192",
      "type": "image/svg+xml"
    }
  ]
};

const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
const manifestUrl = URL.createObjectURL(manifestBlob);
const manifestLink = document.createElement('link');
manifestLink.rel = 'manifest';
manifestLink.href = manifestUrl;
document.head.appendChild(manifestLink);

// ç›£è½å®‰è£æç¤ºäº‹ä»¶
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  // æ›´æ–°å®‰è£ç‹€æ…‹é¡¯ç¤º
  const statusEl = document.getElementById('pwa-install-status');
  if (statusEl) statusEl.textContent = 'å¯å®‰è£ â€º';
  // é¡¯ç¤ºå®‰è£æç¤º
  showInstallBanner();
});

// ç›£è½å®‰è£å®Œæˆ
window.addEventListener('appinstalled', () => {
  console.log('PWA å·²å®‰è£');
  deferredPrompt = null;
  const statusEl = document.getElementById('pwa-install-status');
  if (statusEl) statusEl.textContent = 'âœ“ å·²å®‰è£';
});

// é¡¯ç¤ºå®‰è£æç¤ºæ©«å¹…
function showInstallBanner() {
  // æª¢æŸ¥æ˜¯å¦å·²ç¶“å®‰è£æˆ–å·²ç¶“é¡¯ç¤ºé
  if (window.matchMedia('(display-mode: standalone)').matches) return;
  if (localStorage.getItem('pwa-install-dismissed')) return;
  
  const banner = document.createElement('div');
  banner.id = 'install-banner';
  banner.innerHTML = `
    <div style="position:fixed;bottom:80px;left:16px;right:16px;max-width:388px;margin:0 auto;background:linear-gradient(135deg,var(--primary-dark),var(--primary));padding:16px;border-radius:12px;box-shadow:0 4px 20px rgba(139,124,247,0.4);z-index:1000;display:flex;align-items:center;gap:12px;">
      <div style="font-size:32px">ğŸ“±</div>
      <div style="flex:1">
        <div style="font-size:14px;font-weight:600;color:white;margin-bottom:4px">å®‰è£åˆ°ä¸»ç•«é¢</div>
        <div style="font-size:12px;color:rgba(255,255,255,0.8)">åƒ App ä¸€æ¨£ä½¿ç”¨ç¹”å¤¢</div>
      </div>
      <button onclick="installPWA()" style="padding:8px 16px;background:white;color:var(--primary);border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer">å®‰è£</button>
      <button onclick="dismissInstallBanner()" style="padding:8px;background:transparent;color:rgba(255,255,255,0.8);border:none;font-size:18px;cursor:pointer">Ã—</button>
    </div>
  `;
  document.body.appendChild(banner);
}

// èª¿è©¦ API é€£æ¥
async function debugApiTest() {
  const testUrl = 'https://api.deepseek.com/v1/chat/completions';
  const info = {
    userAgent: navigator.userAgent,
    platform: navigator.platform,
    isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent),
    isAndroid: /Android/.test(navigator.userAgent),
    isSafari: /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent),
    isChrome: /Chrome/.test(navigator.userAgent),
    location: window.location.href,
    protocol: window.location.protocol,
    online: navigator.onLine
  };
  
  let result = `ğŸ“± è¨­å‚™ä¿¡æ¯ï¼š\n`;
  result += `â€¢ å¹³å°: ${info.platform}\n`;
  result += `â€¢ iOS: ${info.isIOS}\n`;
  result += `â€¢ Safari: ${info.isSafari}\n`;
  result += `â€¢ Chrome: ${info.isChrome}\n`;
  result += `â€¢ åœ¨ç·š: ${info.online}\n`;
  result += `â€¢ å”è­°: ${info.protocol}\n\n`;
  
  result += `ğŸ”— æ¸¬è©¦é€£æ¥åˆ°: ${testUrl}\n\n`;
  
  // æ¸¬è©¦ 1: ç°¡å–® GET è«‹æ±‚
  result += `æ¸¬è©¦ 1: HEAD è«‹æ±‚...\n`;
  try {
    const r1 = await fetch(testUrl, { method: 'HEAD', mode: 'cors' });
    result += `âœ… HEAD æˆåŠŸ: ${r1.status}\n\n`;
  } catch(e) {
    result += `âŒ HEAD å¤±æ•—: ${e.name} - ${e.message}\n\n`;
  }
  
  // æ¸¬è©¦ 2: POST è«‹æ±‚ï¼ˆç„¡ bodyï¼‰
  result += `æ¸¬è©¦ 2: POST è«‹æ±‚ï¼ˆç„¡èªè­‰ï¼‰...\n`;
  try {
    const r2 = await fetch(testUrl, { 
      method: 'POST', 
      mode: 'cors',
      credentials: 'omit',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({})
    });
    const t2 = await r2.text();
    result += `âœ… POST ç‹€æ…‹: ${r2.status}\n`;
    result += `éŸ¿æ‡‰: ${t2.slice(0, 100)}...\n\n`;
  } catch(e) {
    result += `âŒ POST å¤±æ•—: ${e.name} - ${e.message}\n`;
    result += `éŒ¯èª¤é¡å‹: ${e.constructor.name}\n\n`;
  }
  
  // æ¸¬è©¦ 3: æ¸¬è©¦å¦ä¸€å€‹ API
  const testUrl2 = 'https://httpbin.org/post';
  result += `æ¸¬è©¦ 3: httpbin.orgï¼ˆCORS æ¸¬è©¦æœå‹™ï¼‰...\n`;
  try {
    const r3 = await fetch(testUrl2, { 
      method: 'POST', 
      mode: 'cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ test: 'hello' })
    });
    const t3 = await r3.text();
    result += `âœ… httpbin æˆåŠŸ: ${r3.status}\n`;
    result += `éŸ¿æ‡‰: ${t3.slice(0, 80)}...\n\n`;
  } catch(e) {
    result += `âŒ httpbin å¤±æ•—: ${e.name} - ${e.message}\n\n`;
  }
  
  // é¡¯ç¤ºçµæœ
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.style.cssText = 'max-width:90%;max-height:80vh;overflow:auto;white-space:pre-wrap;font-family:monospace;font-size:12px;text-align:left;';
  modal.innerHTML = `
    <div class="modal-title">ğŸ”§ API èª¿è©¦çµæœ</div>
    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;margin-bottom:16px;max-height:50vh;overflow:auto;">${result}</div>
    <div class="modal-actions">
      <button class="modal-btn confirm" onclick="this.closest('.modal').remove();document.getElementById('overlay').classList.remove('active')">é—œé–‰</button>
    </div>
  `;
  document.getElementById('overlay').classList.add('active');
  document.body.appendChild(modal);
}

// å®‰è£ PWA
async function installPWA() {
  if (!deferredPrompt) {
    // å°æ–¼ iOSï¼Œé¡¯ç¤ºæ‰‹å‹•å®‰è£æŒ‡å¼•
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    if (isIOS) {
      showModal('ios-install-modal');
    } else {
      toast(T('è«‹ä½¿ç”¨ç€è¦½å™¨èœå–®ä¸­çš„ã€ŒåŠ å…¥ä¸»ç•«é¢ã€åŠŸèƒ½'), 'info');
    }
    dismissInstallBanner();
    return;
  }
  
  deferredPrompt.prompt();
  const result = await deferredPrompt.userChoice;
  console.log('å®‰è£çµæœ:', result.outcome);
  deferredPrompt = null;
  dismissInstallBanner();
  
  if (result.outcome === 'accepted') {
    toast(T('ğŸ‰ å®‰è£æˆåŠŸï¼'), 'success');
  }
}

// é—œé–‰å®‰è£æ©«å¹…
function dismissInstallBanner() {
  const banner = document.getElementById('install-banner');
  if (banner) banner.remove();
  localStorage.setItem('pwa-install-dismissed', 'true');
}

// æª¢æ¸¬æ˜¯å¦ä»¥ PWA æ¨¡å¼é‹è¡Œ
if (window.matchMedia('(display-mode: standalone)').matches) {
  console.log('æ­£åœ¨ä»¥ PWA æ¨¡å¼é‹è¡Œ');
  // æ›´æ–°å®‰è£ç‹€æ…‹
  setTimeout(() => {
    const statusEl = document.getElementById('pwa-install-status');
    if (statusEl) statusEl.textContent = 'âœ“ å·²å®‰è£';
  }, 100);
}

// ============================================
// æŒ‡ä»¤ç”Ÿæˆå‘å°ç³»çµ±
// ============================================

// å‘å°ç‹€æ…‹
let wizardState = {
  step: 0,
  data: {
    template: null,
    basic: { type: '', era: '', setting: '', theme: '' },
    protagonist: { name: '', identity: '', gender: '', personality: '', appearance: '', background: '', goal: '' },
    characters: [],
    mechanics: { attributes: [], systems: [], triggers: [] },
    style: { tone: '', perspective: '', detail: '', format: '' },
    aiRules: { dos: [], donts: [], special: '' },
    examples: { opening: '', response: '', status: '' },
    aiChat: []
  },
  aiAsked: false
};

// é è¨­æ¨¡æ¿
const wizardTemplates = [
  {
    id: 'palace',
    name: 'å®®å»·å¾Œå®®',
    icon: 'ğŸ‘‘',
    desc: 'å®®é¬¥ã€æ¬Šè¬€ã€æ„›æ¨äº¤ç¹”',
    preset: {
      type: 'å®®å»·å¾Œå®®',
      era: 'æ¶ç©ºå¤ä»£æ±æ–¹',
      attributes: ['å¥½æ„Ÿåº¦(è¡¨é¢/çœŸå¯¦)', 'å¿ èª åº¦', 'é‡å¿ƒå€¼', 'æ¬Šå‹¢', 'å¯µæ„›åº¦'],
      systems: ['æ´¾ç³»å‹¢åŠ›', 'å¾Œå®®ä½ä»½', 'æœå ‚æ”¿æ²»'],
      tone: 'æ²‰ç©©ç´°è†©',
      perspective: 'ç¬¬äºŒäººç¨±'
    }
  },
  {
    id: 'cultivation',
    name: 'ä¿®ä»™ç„å¹»',
    icon: 'âš”ï¸',
    desc: 'ä¿®ç…‰ã€æ­·ç·´ã€å•é“é•·ç”Ÿ',
    preset: {
      type: 'ä¿®ä»™ç„å¹»',
      era: 'æ¶ç©ºä»™ä¿ ä¸–ç•Œ',
      attributes: ['å¢ƒç•Œ', 'éˆåŠ›', 'å£½å…ƒ', 'æ‚Ÿæ€§', 'æ°£é‹'],
      systems: ['å®—é–€é«”ç³»', 'åŠŸæ³•å‚³æ‰¿', 'å¤©æåœ°å¯¶'],
      tone: 'ç†±è¡€æ¿€æ˜‚',
      perspective: 'ç¬¬äºŒäººç¨±'
    }
  },
  {
    id: 'apocalypse',
    name: 'æœ«æ—¥ç”Ÿå­˜',
    icon: 'ğŸ§Ÿ',
    desc: 'å»¢åœŸã€å–ªå±ã€äººæ€§è€ƒé©—',
    preset: {
      type: 'æœ«æ—¥ç”Ÿå­˜',
      era: 'è¿‘æœªä¾†å»¢åœŸ',
      attributes: ['ç”Ÿå‘½å€¼', 'é£¢é¤“åº¦', 'ç²¾ç¥å€¼', 'æ„ŸæŸ“åº¦', 'è²æœ›'],
      systems: ['æ“šé»å»ºè¨­', 'ç‰©è³‡ç®¡ç†', 'å€–å­˜è€…é—œä¿‚'],
      tone: 'ç·Šå¼µåˆºæ¿€',
      perspective: 'ç¬¬äºŒäººç¨±'
    }
  },
  {
    id: 'fantasy',
    name: 'è¥¿å¹»å†’éšª',
    icon: 'ğŸ‰',
    desc: 'åŠèˆ‡é­”æ³•çš„å²è©©æ—…é€”',
    preset: {
      type: 'è¥¿æ–¹å¥‡å¹»',
      era: 'ä¸­ä¸–ç´€é­”æ³•ä¸–ç•Œ',
      attributes: ['HP', 'MP', 'åŠ›é‡', 'æ•æ·', 'æ™ºåŠ›', 'é­…åŠ›'],
      systems: ['è·æ¥­æˆé•·', 'æŠ€èƒ½æ¨¹', 'ä»»å‹™ç³»çµ±'],
      tone: 'å²è©©å£¯é—˜',
      perspective: 'ç¬¬äºŒäººç¨±'
    }
  },
  {
    id: 'modern',
    name: 'éƒ½å¸‚æƒ…æ„Ÿ',
    icon: 'ğŸŒƒ',
    desc: 'éƒ½å¸‚æ„›æƒ…ã€è·å ´ã€æ—¥å¸¸',
    preset: {
      type: 'ç¾ä»£éƒ½å¸‚',
      era: 'ç•¶ä»£éƒ½å¸‚',
      attributes: ['å¥½æ„Ÿåº¦', 'é‡‘éŒ¢', 'ç¤¾æœƒåœ°ä½', 'å£“åŠ›å€¼', 'é­…åŠ›'],
      systems: ['ç¤¾äº¤é—œä¿‚', 'äº‹æ¥­ç™¼å±•', 'æƒ…æ„Ÿç·š'],
      tone: 'è¼•é¬†æµªæ¼«',
      perspective: 'ç¬¬äºŒäººç¨±'
    }
  },
  {
    id: 'custom',
    name: 'è‡ªå®šç¾©',
    icon: 'âœ¨',
    desc: 'å¾é›¶é–‹å§‹å‰µå»º',
    preset: null
  }
];

// å‘å°éšæ®µå®šç¾©
const wizardSteps = [
  { id: 'template', title: 'é¸æ“‡æ¨¡æ¿', icon: 'ğŸ“‹' },
  { id: 'basic', title: 'åŸºç¤è¨­å®š', icon: 'ğŸŒ' },
  { id: 'protagonist', title: 'ä¸»è§’è¨­å®š', icon: 'ğŸ‘¤' },
  { id: 'characters', title: 'é…è§’ç³»çµ±', icon: 'ğŸ‘¥' },
  { id: 'mechanics', title: 'éŠæˆ²æ©Ÿåˆ¶', icon: 'âš™ï¸' },
  { id: 'style', title: 'å¯«ä½œé¢¨æ ¼', icon: 'âœï¸' },
  { id: 'aiRules', title: 'AIè¡Œç‚º', icon: 'ğŸ¤–' },
  { id: 'finish', title: 'å®Œæˆç”Ÿæˆ', icon: 'ğŸ‰' }
];

// ç¯„ä¾‹ç‰‡æ®µ
const wizardExamples = {
  basic: `## ä¸–ç•Œè§€è¨­å®š
é€™æ˜¯ä¸€å€‹æ¶ç©ºçš„æ±æ–¹å®®å»·ä¸–ç•Œï¼Œä»¥æ˜æ¸…ç‚ºè—æœ¬ä½†èå…¥äº†æ›´å¤šå¥‡å¹»å…ƒç´ ã€‚çš‡åŸåˆ†ç‚ºå¤–æœèˆ‡å…§å»·ï¼Œå¤–æœè™•ç†æœæ”¿ï¼Œå…§å»·å‰‡æ˜¯åå¦ƒå±…æ‰€ã€‚åå®®å“ç´šå¾é«˜åˆ°ä½ç‚ºï¼šçš‡åã€çš‡è²´å¦ƒã€è²´å¦ƒã€å¦ƒã€å¬ªã€è²´äººã€å¸¸åœ¨ã€ç­”æ‡‰ã€‚`,
  protagonist: `## ä¸»è§’è¨­å®š
ä½ æ˜¯å‰›å…¥å®®çš„æ–°æ™‰è²´äººï¼Œå‡ºèº«æ±Ÿå—æ›¸é¦™é–€ç¬¬ã€‚ä½ å¤–è¡¨æº«å©‰ç«¯èŠï¼Œå¯¦å‰‡è°æ…§æ©Ÿæ•ï¼Œå¿ƒä¸­æœ‰è‘—è‡ªå·±çš„å …æŒèˆ‡åº•ç·šã€‚ä½ çš„çˆ¶è¦ªæ˜¯ç•¶æœç¿°æ—ï¼Œå› å®¶æ—éœ€è¦ä¸€å€‹åœ¨å®®ä¸­çš„æ£‹å­è€Œè¢«é€å…¥å®®ä¸­ã€‚ä½ çš„ç›®æ¨™æ˜¯åœ¨é€™åƒäººçš„å¾Œå®®ä¸­ä¿å…¨è‡ªå·±å’Œå®¶æ—ã€‚`,
  characters: `## ä¸»è¦è§’è‰²
### çš‡å¸ - è•­ç…œ
å¹´ç´„äºŒåäº”ï¼Œåœ¨ä½ä¸‰å¹´ã€‚è¡¨é¢æº«å’Œå¯¡è¨€ï¼Œå¯¦å‰‡åŸåºœæ¥µæ·±ã€‚å°å¾Œå®®è«¸äº‹çœ‹ä¼¼ä¸ä¸Šå¿ƒï¼Œå¯¦å‰‡ä¸€åˆ‡ç›¡åœ¨æŒæ¡ã€‚å–œæ€’ä¸å½¢æ–¼è‰²ï¼Œè®“äººé›£ä»¥æ‰æ‘¸ã€‚

### çš‡å - æ²ˆæ°
å¤ªåå¨˜å®¶ä¾„å¥³ï¼Œç«¯èŠè³¢æ·‘ï¼Œè™•äº‹å…¬å…ã€‚ä½†åœ¨çš‡åçš„å¤–è¡¨ä¸‹ï¼Œæš—è—è‘—å°æ¬ŠåŠ›çš„æ¸´æœ›å’Œå°è‡ªèº«è™•å¢ƒçš„ä¸å®‰ã€‚`,
  mechanics: `## éŠæˆ²æ©Ÿåˆ¶
### å¥½æ„Ÿåº¦ç³»çµ±
æ¯å€‹è§’è‰²æœ‰å…©å€‹å¥½æ„Ÿåº¦æ•¸å€¼ï¼š
- è¡¨é¢å¥½æ„Ÿï¼šNPC å°ä¸»è§’å±•ç¾çš„æ…‹åº¦ï¼ˆ0-100ï¼‰
- çœŸå¯¦å¥½æ„Ÿï¼šNPC å…§å¿ƒçœŸå¯¦çš„æƒ³æ³•ï¼ˆ0-100ï¼‰
é«˜è¡¨é¢å¥½æ„Ÿ+ä½çœŸå¯¦å¥½æ„Ÿ=å¯èƒ½æ˜¯å½è£
ä½è¡¨é¢å¥½æ„Ÿ+é«˜çœŸå¯¦å¥½æ„Ÿ=å‚²å¬Œ/æ·±è—ä¸éœ²

### æ¯æ¬¡äº’å‹•å¾Œè«‹æ›´æ–°ç‹€æ…‹ï¼š
\`\`\`
ã€ç‹€æ…‹æ›´æ–°ã€‘
æ™‚é–“ï¼šXXå¹´XXæœˆXXæ—¥ XXæ™‚
åœ°é»ï¼šXXX
è§’è‰²ç‹€æ…‹è®ŠåŒ–ï¼š
- XXXï¼šè¡¨é¢å¥½æ„Ÿ +5 â†’ 75ï¼ŒçœŸå¯¦å¥½æ„Ÿ ä¸è®Š 50
\`\`\``,
  style: `## å¯«ä½œé¢¨æ ¼è¦æ±‚
- æ¡ç”¨å¤é¢¨å…¸é›…çš„æ–‡å­—é¢¨æ ¼ï¼Œé©ç•¶ä½¿ç”¨è©©è©å…¸æ•…
- æå¯«ç´°è†©ï¼Œæ³¨é‡æ°›åœç‡Ÿé€ å’Œå¿ƒç†åˆ»ç•«
- å°è©±è¦ç¬¦åˆè§’è‰²èº«ä»½ï¼Œå®®å»·ç”¨èªå¾—é«”
- æ¯æ®µå›è¦†æ§åˆ¶åœ¨800-1500å­—
- é©æ™‚åŠ å…¥ç’°å¢ƒæå¯«å’Œè§’è‰²å¾®è¡¨æƒ…ç´°ç¯€`
};

// å•Ÿå‹•å‘å°
function startWizard() {
  wizardState = {
    step: 0,
    data: {
      template: null,
      basic: { type: '', era: '', setting: '', theme: '' },
      protagonist: { name: '', identity: '', gender: '', personality: '', appearance: '', background: '', goal: '' },
      characters: [],
      mechanics: { attributes: [], systems: [], triggers: [] },
      style: { tone: '', perspective: '', detail: '', format: '' },
      aiRules: { dos: [], donts: [], special: '' },
      examples: { opening: '', response: '', status: '' },
      aiChat: []
    },
    aiAsked: false
  };
  renderWizardStep();
  goTo('view-wizard');
}

function exitWizard() {
  showConfirm('ç¢ºå®šè¦é€€å‡ºå—ï¼Ÿå·²å¡«å¯«çš„å…§å®¹å°‡ä¸æœƒä¿å­˜ã€‚', () => {
    goBack();
  });
}

function showWizardHelp() {
  showConfirm(
    'æŒ‡ä»¤ç”Ÿæˆå‘å°å¹«åŠ©\n\n' +
    'é€™å€‹å‘å°å°‡å¼•å°ä½ å‰µå»ºä¸€å€‹å®Œæ•´çš„æ–‡æ¸¸æŒ‡ä»¤ã€‚\n\n' +
    'â€¢ å…± 8 å€‹æ­¥é©Ÿï¼Œå¯éš¨æ™‚è¿”å›ä¿®æ”¹\n' +
    'â€¢ æ¯æ­¥éƒ½æœ‰ AI æ™ºèƒ½æå•å¹«åŠ©å®Œå–„\n' +
    'â€¢ æœ€å¾Œå¯å°å‡ºç‚ºæ–‡æª”æˆ–ä¿å­˜ç‚ºæŒ‡ä»¤\n\n' +
    'å°æŠ€å·§ï¼šé¸æ“‡é è¨­æ¨¡æ¿å¯ä»¥å¿«é€Ÿé–‹å§‹ï¼',
    null, false, 'ğŸ’¡ å¹«åŠ©'
  );
}

// æ¸²æŸ“ç•¶å‰æ­¥é©Ÿ
function renderWizardStep() {
  const step = wizardSteps[wizardState.step];
  document.getElementById('wizard-title').textContent = step.title;
  document.getElementById('wizard-progress-fill').style.width = ((wizardState.step + 1) / wizardSteps.length * 100) + '%';
  document.getElementById('wizard-progress-text').textContent = `${wizardState.step + 1}/${wizardSteps.length} ${step.title}`;
  
  // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
  document.getElementById('wizard-prev').disabled = wizardState.step === 0;
  const nextBtn = document.getElementById('wizard-next');
  if (wizardState.step === wizardSteps.length - 1) {
    nextBtn.textContent = 'å®Œæˆ';
  } else {
    nextBtn.textContent = 'ä¸‹ä¸€æ­¥';
  }
  
  const content = document.getElementById('wizard-content');
  wizardState.aiAsked = false;
  
  switch(step.id) {
    case 'template': renderTemplateStep(content); break;
    case 'basic': renderBasicStep(content); break;
    case 'protagonist': renderProtagonistStep(content); break;
    case 'characters': renderCharactersStep(content); break;
    case 'mechanics': renderMechanicsStep(content); break;
    case 'style': renderStyleStep(content); break;
    case 'aiRules': renderAiRulesStep(content); break;
    case 'finish': renderFinishStep(content); break;
  }
}

// æ­¥é©Ÿ 0ï¼šé¸æ“‡æ¨¡æ¿
function renderTemplateStep(container) {
  container.innerHTML = `
    <div class="wizard-section">
      <div class="wizard-section-title">ğŸ“‹ é¸æ“‡ä¸€å€‹æ¨¡æ¿é–‹å§‹</div>
      <div class="wizard-section-desc">é¸æ“‡é è¨­æ¨¡æ¿å¯ä»¥å¿«é€Ÿå¡«å……å¸¸ç”¨è¨­å®šï¼Œä½ ä¹Ÿå¯ä»¥é¸æ“‡ã€Œè‡ªå®šç¾©ã€å¾é›¶é–‹å§‹ã€‚</div>
      <div class="wizard-options">
        ${wizardTemplates.map(t => `
          <div class="wizard-option template ${wizardState.data.template === t.id ? 'selected' : ''}" onclick="selectTemplate('${t.id}')">
            <div class="template-icon">${t.icon}</div>
            <div class="template-name">${t.name}</div>
            <div class="template-desc">${t.desc}</div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

function selectTemplate(id) {
  wizardState.data.template = id;
  const template = wizardTemplates.find(t => t.id === id);
  if (template?.preset) {
    // æ‡‰ç”¨é è¨­
    wizardState.data.basic.type = template.preset.type || '';
    wizardState.data.basic.era = template.preset.era || '';
    wizardState.data.mechanics.attributes = template.preset.attributes || [];
    wizardState.data.mechanics.systems = template.preset.systems || [];
    wizardState.data.style.tone = template.preset.tone || '';
    wizardState.data.style.perspective = template.preset.perspective || '';
  }
  renderWizardStep();
}

// æ­¥é©Ÿ 1ï¼šåŸºç¤è¨­å®š
function renderBasicStep(container) {
  const d = wizardState.data.basic;
  container.innerHTML = `
    <div class="wizard-section">
      <div class="wizard-section-title">ğŸŒ ä¸–ç•Œè§€åŸºç¤è¨­å®š</div>
      <div class="wizard-section-desc">å®šç¾©æ•…äº‹ç™¼ç”Ÿçš„ä¸–ç•ŒèƒŒæ™¯ï¼Œé€™å°‡æ±ºå®šæ•´å€‹æ•…äº‹çš„åŸºèª¿ã€‚</div>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">æ•…äº‹é¡å‹</label>
      <input class="wizard-input" id="wiz-type" value="${esc(d.type)}" placeholder="å¦‚ï¼šå®®å»·å¾Œå®®ã€ä¿®ä»™ç„å¹»ã€æœ«æ—¥ç”Ÿå­˜...">
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">æ™‚ä»£èƒŒæ™¯</label>
      <input class="wizard-input" id="wiz-era" value="${esc(d.era)}" placeholder="å¦‚ï¼šæ¶ç©ºå¤ä»£ã€è¿‘æœªä¾†ã€ä¸­ä¸–ç´€é­”æ³•ä¸–ç•Œ...">
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">ä¸–ç•Œè§€è¨­å®š</label>
      <textarea class="wizard-input wizard-textarea" id="wiz-setting" placeholder="æè¿°é€™å€‹ä¸–ç•Œçš„ç¨ç‰¹è¨­å®šã€è¦å‰‡ã€æ­·å²èƒŒæ™¯ç­‰...">${esc(d.setting)}</textarea>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">æ ¸å¿ƒä¸»é¡Œ</label>
      <input class="wizard-input" id="wiz-theme" value="${esc(d.theme)}" placeholder="å¦‚ï¼šæ¬Šè¬€é¬¥çˆ­ã€æˆé•·è›»è®Šã€æ„›æ¨ç³¾è‘›...">
      
      <div class="wizard-example">
        <div class="wizard-example-title">ğŸ“ ç¯„ä¾‹åƒè€ƒ</div>
        ${wizardExamples.basic}
      </div>
    </div>
    <div class="wizard-ai-container"></div>
  `;
  
  // è‡ªå‹•è§¸ç™¼ AI æå•
  setTimeout(() => askWizardAI('basic'), 500);
}

// æ­¥é©Ÿ 2ï¼šä¸»è§’è¨­å®š
function renderProtagonistStep(container) {
  const d = wizardState.data.protagonist;
  container.innerHTML = `
    <div class="wizard-section">
      <div class="wizard-section-title">ğŸ‘¤ ä¸»è§’è¨­å®š</div>
      <div class="wizard-section-desc">è©³ç´°è¨­å®šä¸»è§’çš„å„é …å±¬æ€§ï¼Œé€™å°‡æ˜¯ç©å®¶ä»£å…¥çš„è§’è‰²ã€‚</div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div>
          <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">ç¨±å‘¼/åå­—</label>
          <input class="wizard-input" id="wiz-pname" value="${esc(d.name)}" placeholder="å¦‚ï¼šä½ ã€å°‘ä¿ ã€æ®¿ä¸‹...">
        </div>
        <div>
          <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">æ€§åˆ¥</label>
          <select class="wizard-input" id="wiz-pgender" style="padding:12px">
            <option value="">è«‹é¸æ“‡</option>
            <option value="male" ${d.gender==='male'?'selected':''}>ç”·</option>
            <option value="female" ${d.gender==='female'?'selected':''}>å¥³</option>
            <option value="custom" ${d.gender==='custom'?'selected':''}>è‡ªå®šç¾©/ä¸é™</option>
          </select>
        </div>
      </div>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">èº«ä»½åœ°ä½</label>
      <input class="wizard-input" id="wiz-pidentity" value="${esc(d.identity)}" placeholder="å¦‚ï¼šæ–°æ™‰è²´äººã€æ•£ä¿®ã€å€–å­˜è€…...">
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">æ€§æ ¼ç‰¹é»</label>
      <input class="wizard-input" id="wiz-ppersonality" value="${esc(d.personality)}" placeholder="å¦‚ï¼šå¤–æŸ”å…§å‰›ã€è…¹é»‘æ©Ÿæ™ºã€ç†±è¡€æ­£ç›´...">
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">å¤–è²Œæè¿°</label>
      <textarea class="wizard-input wizard-textarea" id="wiz-pappearance" placeholder="ä¸»è§’çš„å¤–è²Œç‰¹å¾µ...">${esc(d.appearance)}</textarea>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">èƒŒæ™¯æ•…äº‹</label>
      <textarea class="wizard-input wizard-textarea" id="wiz-pbackground" placeholder="ä¸»è§’çš„èº«ä¸–ã€ä¾†æ­·ã€éå»çš„ç¶“æ­·...">${esc(d.background)}</textarea>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">ç›®æ¨™/å‹•æ©Ÿ</label>
      <input class="wizard-input" id="wiz-pgoal" value="${esc(d.goal)}" placeholder="ä¸»è§’åœ¨æ•…äº‹ä¸­çš„ç›®æ¨™æ˜¯ä»€éº¼ï¼Ÿ">
      
      <div class="wizard-example">
        <div class="wizard-example-title">ğŸ“ ç¯„ä¾‹åƒè€ƒ</div>
        ${wizardExamples.protagonist}
      </div>
    </div>
    <div class="wizard-ai-container"></div>
  `;
  
  setTimeout(() => askWizardAI('protagonist'), 500);
}

// æ­¥é©Ÿ 3ï¼šé…è§’ç³»çµ±
function renderCharactersStep(container) {
  const chars = wizardState.data.characters;
  container.innerHTML = `
    <div class="wizard-section">
      <div class="wizard-section-title">ğŸ‘¥ é…è§’ç³»çµ±</div>
      <div class="wizard-section-desc">æ·»åŠ æ•…äº‹ä¸­çš„é‡è¦ NPCï¼Œè±å¯Œçš„é…è§’èƒ½è®“æ•…äº‹æ›´ç²¾å½©ã€‚å»ºè­°è‡³å°‘ 3-5 å€‹ä¸»è¦è§’è‰²ã€‚</div>
      
      <div class="wizard-char-list" id="wizard-char-list">
        ${chars.length ? chars.map((c, i) => `
          <div class="wizard-char-card">
            <div class="wizard-char-avatar">${c.avatar || 'ğŸ‘¤'}</div>
            <div class="wizard-char-info">
              <div class="wizard-char-name">${esc(c.name)}</div>
              <div class="wizard-char-role">${esc(c.role)} Â· ${esc(c.relation)}</div>
            </div>
            <div class="wizard-char-actions">
              <button class="wizard-char-btn" onclick="editWizardChar(${i})">âœï¸</button>
              <button class="wizard-char-btn" onclick="deleteWizardChar(${i})">ğŸ—‘ï¸</button>
            </div>
          </div>
        `).join('') : '<div style="text-align:center;padding:20px;color:var(--text-tertiary)">å°šæœªæ·»åŠ è§’è‰²</div>'}
      </div>
      
      <button class="wizard-btn secondary" style="width:100%;margin-top:12px" onclick="addWizardChar()">â• æ·»åŠ è§’è‰²</button>
      <button class="wizard-btn secondary" style="width:100%;margin-top:8px" onclick="aiGenerateChars()">ğŸ¤– AI å»ºè­°è§’è‰²</button>
      
      <div class="wizard-example">
        <div class="wizard-example-title">ğŸ“ ç¯„ä¾‹åƒè€ƒ</div>
        ${wizardExamples.characters}
      </div>
    </div>
    <div class="wizard-ai-container"></div>
  `;
  
  setTimeout(() => askWizardAI('characters'), 500);
}

// æ­¥é©Ÿ 4ï¼šéŠæˆ²æ©Ÿåˆ¶
function renderMechanicsStep(container) {
  const d = wizardState.data.mechanics;
  const attrOptions = ['å¥½æ„Ÿåº¦', 'å¥½æ„Ÿåº¦(è¡¨é¢/çœŸå¯¦)', 'å¿ èª åº¦', 'é‡å¿ƒå€¼', 'æ¬Šå‹¢', 'å¯µæ„›åº¦', 'å¢ƒç•Œ', 'éˆåŠ›', 'å£½å…ƒ', 'ç”Ÿå‘½å€¼', 'é£¢é¤“åº¦', 'ç²¾ç¥å€¼', 'HP', 'MP', 'åŠ›é‡', 'æ•æ·', 'æ™ºåŠ›', 'é­…åŠ›', 'é‡‘éŒ¢', 'è²æœ›'];
  const sysOptions = ['æ´¾ç³»å‹¢åŠ›', 'å¥½æ„Ÿåº¦ç³»çµ±', 'æ•¸å€¼æˆé•·', 'æŠ€èƒ½æ¨¹', 'ä»»å‹™ç³»çµ±', 'ç‰©è³‡ç®¡ç†', 'æ“šé»å»ºè¨­', 'æ™‚é–“æµé€', 'éš±è—äº‹ä»¶', 'å¤šçµå±€åˆ†æ”¯', 'éš¨æ©Ÿäº‹ä»¶'];
  
  container.innerHTML = `
    <div class="wizard-section">
      <div class="wizard-section-title">âš™ï¸ éŠæˆ²æ©Ÿåˆ¶è¨­è¨ˆ</div>
      <div class="wizard-section-desc">è¨­è¨ˆè®“æ•…äº‹æ›´æœ‰äº’å‹•æ€§çš„æ©Ÿåˆ¶ï¼Œåˆç†çš„æ©Ÿåˆ¶èƒ½å¢å¼·ä»£å…¥æ„Ÿã€‚</div>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">è§’è‰²å±¬æ€§ï¼ˆå¯å¤šé¸ï¼‰</label>
      <div class="wizard-options" style="margin-bottom:16px">
        ${attrOptions.map(a => `
          <div class="wizard-option ${d.attributes.includes(a)?'selected':''}" onclick="toggleWizardOption('attributes','${a}')">${a}</div>
        `).join('')}
      </div>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">è‡ªå®šç¾©å±¬æ€§</label>
      <input class="wizard-input" id="wiz-custom-attr" placeholder="è¼¸å…¥å¾ŒæŒ‰ Enter æ·»åŠ ">
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px;margin-top:16px">éŠæˆ²ç³»çµ±ï¼ˆå¯å¤šé¸ï¼‰</label>
      <div class="wizard-options" style="margin-bottom:16px">
        ${sysOptions.map(s => `
          <div class="wizard-option ${d.systems.includes(s)?'selected':''}" onclick="toggleWizardOption('systems','${s}')">${s}</div>
        `).join('')}
      </div>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">ç‰¹æ®Šè§¸ç™¼æ©Ÿåˆ¶</label>
      <textarea class="wizard-input wizard-textarea" id="wiz-triggers" placeholder="æè¿°ä¸€äº›ç‰¹æ®Šçš„è§¸ç™¼æ¢ä»¶ï¼Œä¾‹å¦‚ï¼šå¥½æ„Ÿåº¦é”åˆ° 80 æ™‚è§£é–ç‰¹æ®ŠåŠ‡æƒ…...">${d.triggers.join('\n')}</textarea>
      
      <div class="wizard-example">
        <div class="wizard-example-title">ğŸ“ ç¯„ä¾‹åƒè€ƒ</div>
        ${wizardExamples.mechanics}
      </div>
    </div>
    <div class="wizard-ai-container"></div>
  `;
  
  // è‡ªå®šç¾©å±¬æ€§è¼¸å…¥
  document.getElementById('wiz-custom-attr')?.addEventListener('keypress', e => {
    if (e.key === 'Enter' && e.target.value.trim()) {
      if (!d.attributes.includes(e.target.value.trim())) {
        d.attributes.push(e.target.value.trim());
        renderMechanicsStep(container);
      }
      e.target.value = '';
    }
  });
  
  setTimeout(() => askWizardAI('mechanics'), 500);
}

function toggleWizardOption(type, value) {
  const arr = wizardState.data.mechanics[type];
  const idx = arr.indexOf(value);
  if (idx >= 0) arr.splice(idx, 1);
  else arr.push(value);
  renderWizardStep();
}

// æ­¥é©Ÿ 5ï¼šå¯«ä½œé¢¨æ ¼
function renderStyleStep(container) {
  const d = wizardState.data.style;
  container.innerHTML = `
    <div class="wizard-section">
      <div class="wizard-section-title">âœï¸ å¯«ä½œé¢¨æ ¼è¨­å®š</div>
      <div class="wizard-section-desc">å®šç¾© AI çš„å¯«ä½œé¢¨æ ¼ï¼Œè®“æ•…äº‹å‘ˆç¾ç¬¦åˆä½ æœŸæœ›çš„è³ªæ„Ÿã€‚</div>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">æ–‡é¢¨åŸºèª¿</label>
      <div class="wizard-options" style="margin-bottom:16px">
        ${['è¼•é¬†æ­¡å¿«', 'æ²‰ç©©ç´°è†©', 'ç†±è¡€æ¿€æ˜‚', 'é»‘æš—å£“æŠ‘', 'æµªæ¼«å”¯ç¾', 'å¹½é»˜è«·åˆº', 'å²è©©å£¯é—˜', 'æ‡¸ç–‘ç·Šå¼µ'].map(t => `
          <div class="wizard-option ${d.tone===t?'selected':''}" onclick="wizardState.data.style.tone='${t}';renderWizardStep()">${t}</div>
        `).join('')}
      </div>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">æ•˜äº‹è¦–è§’</label>
      <div class="wizard-options" style="margin-bottom:16px">
        ${['ç¬¬ä¸€äººç¨±', 'ç¬¬äºŒäººç¨±', 'ç¬¬ä¸‰äººç¨±', 'ä¸Šå¸è¦–è§’'].map(p => `
          <div class="wizard-option ${d.perspective===p?'selected':''}" onclick="wizardState.data.style.perspective='${p}';renderWizardStep()">${p}</div>
        `).join('')}
      </div>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">ç´°ç¯€ç¨‹åº¦</label>
      <div class="wizard-options" style="margin-bottom:16px">
        ${['ç°¡æ½”æ˜å¿«ï¼ˆ300-500å­—ï¼‰', 'é©ä¸­è©³ç´°ï¼ˆ500-1000å­—ï¼‰', 'è±å¯Œç´°è†©ï¼ˆ1000-2000å­—ï¼‰', 'è¶…é•·ç¯‡å¹…ï¼ˆ2000å­—+ï¼‰'].map(d2 => `
          <div class="wizard-option ${d.detail===d2?'selected':''}" onclick="wizardState.data.style.detail='${d2}';renderWizardStep()">${d2}</div>
        `).join('')}
      </div>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">ç‰¹æ®Šæ ¼å¼è¦æ±‚</label>
      <textarea class="wizard-input wizard-textarea" id="wiz-format" placeholder="ä¾‹å¦‚ï¼šæ¯æ®µé–‹é ­ç©ºå…©æ ¼ã€å°è©±ç”¨ã€Œã€ã€å…§å¿ƒç¨ç™½ç”¨ï¼ˆï¼‰...">${esc(d.format)}</textarea>
      
      <div class="wizard-example">
        <div class="wizard-example-title">ğŸ“ ç¯„ä¾‹åƒè€ƒ</div>
        ${wizardExamples.style}
      </div>
    </div>
    <div class="wizard-ai-container"></div>
  `;
  
  setTimeout(() => askWizardAI('style'), 500);
}

// æ­¥é©Ÿ 6ï¼šAI è¡Œç‚ºè¦å‰‡
function renderAiRulesStep(container) {
  const d = wizardState.data.aiRules;
  container.innerHTML = `
    <div class="wizard-section">
      <div class="wizard-section-title">ğŸ¤– AI è¡Œç‚ºè¦å‰‡</div>
      <div class="wizard-section-desc">è¨­å®š AI æ‡‰è©²åšä»€éº¼ã€ä¸è©²åšä»€éº¼ï¼Œç¢ºä¿æ•…äº‹æŒ‰ä½ çš„æœŸæœ›ç™¼å±•ã€‚</div>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">AI æ‡‰è©²åšçš„ï¼ˆDosï¼‰</label>
      <textarea class="wizard-input wizard-textarea" id="wiz-dos" placeholder="æ¯è¡Œä¸€æ¢ï¼Œä¾‹å¦‚ï¼š
- ä¿æŒè§’è‰²æ€§æ ¼ä¸€è‡´æ€§
- é©æ™‚çµ¦å‡ºè¡Œå‹•é¸é …
- æå¯«è§’è‰²å¾®è¡¨æƒ…è®ŠåŒ–">${d.dos.join('\n')}</textarea>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">AI ä¸æ‡‰è©²åšçš„ï¼ˆDon'tsï¼‰</label>
      <textarea class="wizard-input wizard-textarea" id="wiz-donts" placeholder="æ¯è¡Œä¸€æ¢ï¼Œä¾‹å¦‚ï¼š
- ä¸è¦æ“…è‡ªæ±ºå®šä¸»è§’çš„è¡Œå‹•
- ä¸è¦è·³éé‡è¦åŠ‡æƒ…
- ä¸è¦è®“è§’è‰²çªç„¶æ€§æ ¼å¤§è®Š">${d.donts.join('\n')}</textarea>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">ç‰¹æ®ŠæŒ‡ä»¤</label>
      <textarea class="wizard-input wizard-textarea" id="wiz-special" placeholder="å…¶ä»–ç‰¹æ®Šè¦æ±‚...">${esc(d.special)}</textarea>
    </div>
    <div class="wizard-ai-container"></div>
  `;
  
  setTimeout(() => askWizardAI('aiRules'), 500);
}

// æ­¥é©Ÿ 7ï¼šå®Œæˆ
function renderFinishStep(container) {
  const prompt = generatePrompt();
  const charCount = prompt.length;
  
  container.innerHTML = `
    <div class="wizard-section">
      <div class="wizard-section-title">ğŸ‰ æŒ‡ä»¤ç”Ÿæˆå®Œæˆï¼</div>
      <div class="wizard-section-desc">ä½ çš„æ–‡æ¸¸æŒ‡ä»¤å·²ç”Ÿæˆï¼Œå¯ä»¥é è¦½ã€ç·¨è¼¯æˆ–ä¿å­˜ã€‚</div>
      
      <div class="wizard-preview">
        <div class="wizard-preview-header">
          <div class="wizard-preview-title">ğŸ“„ æŒ‡ä»¤é è¦½</div>
          <div class="wizard-preview-stats">${charCount.toLocaleString()} å­—</div>
        </div>
        <div class="wizard-preview-content" id="wizard-preview-content">${esc(prompt.slice(0, 2000))}${prompt.length > 2000 ? '\n\n... (é»æ“Šå±•é–‹æŸ¥çœ‹æ›´å¤š)' : ''}</div>
      </div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:16px">
        <button class="wizard-btn secondary" onclick="previewFullPrompt()">ğŸ‘ï¸ å®Œæ•´é è¦½</button>
        <button class="wizard-btn secondary" onclick="editPrompt()">âœï¸ ç·¨è¼¯å¾®èª¿</button>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
        <button class="wizard-btn secondary" onclick="exportPrompt('md')">ğŸ“„ å°å‡º MD</button>
        <button class="wizard-btn secondary" onclick="exportPrompt('txt')">ğŸ“ å°å‡º TXT</button>
      </div>
      <button class="wizard-btn primary" style="width:100%;margin-top:8px" onclick="saveAsInstruction()">ğŸ’¾ ä¿å­˜ç‚ºæŒ‡ä»¤</button>
    </div>
    
    <div class="wizard-section" style="margin-top:24px">
      <div class="wizard-section-title">ğŸ’¬ AI å°è©±å®Œå–„</div>
      <div class="wizard-section-desc">é‚„æœ‰ä»€éº¼æƒ³è£œå……çš„ï¼Ÿå¯ä»¥å’Œ AI å°è©±ç¹¼çºŒå®Œå–„æŒ‡ä»¤ã€‚</div>
      <div class="wizard-chat" id="wizard-chat">
        ${wizardState.data.aiChat.map(m => `
          <div class="wizard-chat-msg ${m.role}">${marked.parse(m.content)}</div>
        `).join('')}
      </div>
      <div class="wizard-chat-input">
        <input class="wizard-chat-field" id="wizard-chat-input" placeholder="è¼¸å…¥ä½ çš„æƒ³æ³•..." onkeypress="if(event.key==='Enter')sendWizardChat()">
        <button class="wizard-chat-send" onclick="sendWizardChat()">â¤</button>
      </div>
    </div>
  `;
}

// ä¿å­˜ç•¶å‰æ­¥é©Ÿæ•¸æ“š
function saveWizardStepData() {
  const step = wizardSteps[wizardState.step];
  switch(step.id) {
    case 'basic':
      wizardState.data.basic = {
        type: document.getElementById('wiz-type')?.value || '',
        era: document.getElementById('wiz-era')?.value || '',
        setting: document.getElementById('wiz-setting')?.value || '',
        theme: document.getElementById('wiz-theme')?.value || ''
      };
      break;
    case 'protagonist':
      wizardState.data.protagonist = {
        name: document.getElementById('wiz-pname')?.value || '',
        identity: document.getElementById('wiz-pidentity')?.value || '',
        gender: document.getElementById('wiz-pgender')?.value || '',
        personality: document.getElementById('wiz-ppersonality')?.value || '',
        appearance: document.getElementById('wiz-pappearance')?.value || '',
        background: document.getElementById('wiz-pbackground')?.value || '',
        goal: document.getElementById('wiz-pgoal')?.value || ''
      };
      break;
    case 'mechanics':
      const triggers = document.getElementById('wiz-triggers')?.value || '';
      wizardState.data.mechanics.triggers = triggers.split('\n').filter(t => t.trim());
      break;
    case 'style':
      wizardState.data.style.format = document.getElementById('wiz-format')?.value || '';
      break;
    case 'aiRules':
      const dos = document.getElementById('wiz-dos')?.value || '';
      const donts = document.getElementById('wiz-donts')?.value || '';
      wizardState.data.aiRules = {
        dos: dos.split('\n').filter(t => t.trim()),
        donts: donts.split('\n').filter(t => t.trim()),
        special: document.getElementById('wiz-special')?.value || ''
      };
      break;
  }
}

// ä¸Šä¸€æ­¥/ä¸‹ä¸€æ­¥
function wizardPrev() {
  if (wizardState.step > 0) {
    saveWizardStepData();
    wizardState.step--;
    renderWizardStep();
  }
}

function wizardNext() {
  saveWizardStepData();
  if (wizardState.step < wizardSteps.length - 1) {
    wizardState.step++;
    renderWizardStep();
  } else {
    saveAsInstruction();
  }
}

// AI æå•
async function askWizardAI(stepId) {
  if (wizardState.aiAsked) return;
  wizardState.aiAsked = true;
  
  const box = document.querySelector('.wizard-ai-container');
  if (!box) return;
  
  box.innerHTML = `
    <div class="wizard-ai-box">
      <div class="wizard-ai-header"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span> AI æ­£åœ¨æ€è€ƒ...</div>
    </div>
  `;
  
  try {
    const preset = await db.apiPresets.filter(p => p.isActive).first();
    if (!preset) {
      box.innerHTML = `<div class="wizard-ai-box"><div class="wizard-ai-header">âš ï¸ æç¤º</div><div class="wizard-ai-content">è«‹å…ˆåœ¨è¨­ç½®ä¸­é…ç½® APIï¼Œæ‰èƒ½ä½¿ç”¨ AI æ™ºèƒ½æå•åŠŸèƒ½ã€‚</div></div>`;
      return;
    }
    
    const context = JSON.stringify(wizardState.data, null, 2);
    const prompts = {
      basic: `ç”¨æˆ¶æ­£åœ¨å‰µå»ºæ–‡æ¸¸æŒ‡ä»¤ï¼Œç›®å‰å¡«å¯«çš„åŸºç¤è¨­å®šå¦‚ä¸‹ï¼š
${context}

è«‹æ ¹æ“šç”¨æˆ¶å¡«å¯«çš„å…§å®¹ï¼Œæå‡º 1-2 å€‹æœ‰é‡å°æ€§çš„å•é¡Œï¼Œå¹«åŠ©å®Œå–„ä¸–ç•Œè§€è¨­å®šã€‚å•é¡Œè¦å…·é«”ã€æœ‰å»ºè¨­æ€§ã€‚å¦‚æœå…§å®¹å·²ç¶“å¾ˆå®Œæ•´ï¼Œå¯ä»¥çµ¦å‡ºè‚¯å®šä¸¦æå‡ºé€²éšå»ºè­°ã€‚å›è¦†è¦ç°¡æ½”ï¼ˆ100å­—å…§ï¼‰ã€‚`,
      protagonist: `ç”¨æˆ¶æ­£åœ¨è¨­å®šæ–‡æ¸¸çš„ä¸»è§’ï¼š
${context}

è«‹æ ¹æ“šä¸»è§’è¨­å®šï¼Œæå‡º 1-2 å€‹å•é¡Œå¹«åŠ©å®Œå–„ã€‚å¯ä»¥å•ï¼šä¸»è§’çš„å¼±é»/ç¼ºé™·æ˜¯ä»€éº¼ï¼Ÿæœ‰ä»€éº¼ç‰¹æ®ŠæŠ€èƒ½æˆ–èƒŒæ™¯æ•…äº‹ï¼Ÿå›è¦†ç°¡æ½”ï¼ˆ100å­—å…§ï¼‰ã€‚`,
      characters: `ç”¨æˆ¶æ­£åœ¨æ·»åŠ é…è§’ï¼š
${context}

è«‹æ ¹æ“šæ•…äº‹é¡å‹å’Œå·²æœ‰è§’è‰²ï¼Œå»ºè­°é‚„éœ€è¦ä»€éº¼é¡å‹çš„è§’è‰²ï¼Œæˆ–æå•ç¾æœ‰è§’è‰²çš„ç´°ç¯€ã€‚å›è¦†ç°¡æ½”ï¼ˆ100å­—å…§ï¼‰ã€‚`,
      mechanics: `ç”¨æˆ¶æ­£åœ¨è¨­è¨ˆéŠæˆ²æ©Ÿåˆ¶ï¼š
${context}

è«‹æ ¹æ“šæ•…äº‹é¡å‹ï¼Œæå‡ºæ©Ÿåˆ¶æ–¹é¢çš„å»ºè­°æˆ–å•é¡Œã€‚ä¾‹å¦‚ï¼šé€™äº›å±¬æ€§ä¹‹é–“å¦‚ä½•äº’ç›¸å½±éŸ¿ï¼Ÿæœ‰æ²’æœ‰ç‰¹æ®Šçš„è§¸ç™¼æ©Ÿåˆ¶ï¼Ÿå›è¦†ç°¡æ½”ï¼ˆ100å­—å…§ï¼‰ã€‚`,
      style: `ç”¨æˆ¶æ­£åœ¨è¨­å®šå¯«ä½œé¢¨æ ¼ï¼š
${context}

è«‹æ ¹æ“šæ•…äº‹é¡å‹å’Œé¢¨æ ¼é¸æ“‡ï¼Œçµ¦å‡ºå»ºè­°æˆ–æå•ã€‚ä¾‹å¦‚ï¼šè¦ä¸è¦åŠ å…¥è©©è©/å°ˆæ¥­è¡“èªï¼Ÿå°è©±é¢¨æ ¼æœ‰ä»€éº¼è¦æ±‚ï¼Ÿå›è¦†ç°¡æ½”ï¼ˆ100å­—å…§ï¼‰ã€‚`,
      aiRules: `ç”¨æˆ¶æ­£åœ¨è¨­å®š AI è¡Œç‚ºè¦å‰‡ï¼š
${context}

è«‹æ ¹æ“šæ•´é«”è¨­å®šï¼Œå»ºè­°ä¸€äº›é‡è¦çš„ AI è¡Œç‚ºè¦å‰‡ã€‚ä»€éº¼æ˜¯ AI å¿…é ˆéµå®ˆçš„ï¼Ÿä»€éº¼æ˜¯çµ•å°ä¸èƒ½åšçš„ï¼Ÿå›è¦†ç°¡æ½”ï¼ˆ100å­—å…§ï¼‰ã€‚`
    };
    
    const response = await callAI(prompts[stepId] || 'è«‹çµ¦å‡ºä¸€äº›å»ºè­°ã€‚');
    
    box.innerHTML = `
      <div class="wizard-ai-box">
        <div class="wizard-ai-header">ğŸ¤– AI æå•</div>
        <div class="wizard-ai-content">${marked.parse(response.content)}</div>
      </div>
    `;
  } catch (e) {
    box.innerHTML = `<div class="wizard-ai-box"><div class="wizard-ai-header">âš ï¸ AI æš«æ™‚ç„¡æ³•å›æ‡‰</div><div class="wizard-ai-content">${e.message}</div></div>`;
  }
}

// æ·»åŠ /ç·¨è¼¯è§’è‰²
function addWizardChar() {
  showModal('wizard-char-modal');
  document.getElementById('wiz-char-name').value = '';
  document.getElementById('wiz-char-role').value = '';
  document.getElementById('wiz-char-personality').value = '';
  document.getElementById('wiz-char-relation').value = '';
  document.getElementById('wiz-char-desc').value = '';
  document.getElementById('wiz-char-idx').value = '-1';
}

function editWizardChar(idx) {
  const c = wizardState.data.characters[idx];
  showModal('wizard-char-modal');
  document.getElementById('wiz-char-name').value = c.name || '';
  document.getElementById('wiz-char-role').value = c.role || '';
  document.getElementById('wiz-char-personality').value = c.personality || '';
  document.getElementById('wiz-char-relation').value = c.relation || '';
  document.getElementById('wiz-char-desc').value = c.description || '';
  document.getElementById('wiz-char-idx').value = idx;
}

function saveWizardChar() {
  const idx = parseInt(document.getElementById('wiz-char-idx').value);
  const char = {
    name: document.getElementById('wiz-char-name').value.trim(),
    role: document.getElementById('wiz-char-role').value.trim(),
    personality: document.getElementById('wiz-char-personality').value.trim(),
    relation: document.getElementById('wiz-char-relation').value.trim(),
    description: document.getElementById('wiz-char-desc').value.trim(),
    avatar: 'ğŸ‘¤'
  };
  if (!char.name) { toast(T('è«‹è¼¸å…¥è§’è‰²åç¨±'), 'warning'); return; }
  
  if (idx >= 0) {
    wizardState.data.characters[idx] = char;
  } else {
    wizardState.data.characters.push(char);
  }
  closeModal('wizard-char-modal');
  renderWizardStep();
}

function deleteWizardChar(idx) {
  showConfirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹è§’è‰²å—ï¼Ÿ', () => {
    wizardState.data.characters.splice(idx, 1);
    renderWizardStep();
  });
}

// AI ç”Ÿæˆè§’è‰²å»ºè­°
async function aiGenerateChars() {
  toast(T('AI æ­£åœ¨ç”Ÿæˆè§’è‰²å»ºè­°...'), 'info');
  try {
    const context = JSON.stringify(wizardState.data, null, 2);
    const response = await callAI(`æ ¹æ“šä»¥ä¸‹æ–‡æ¸¸è¨­å®šï¼Œå»ºè­° 3 å€‹é©åˆçš„é…è§’ã€‚è«‹ç”¨ JSON æ ¼å¼è¿”å›ï¼š
${context}

è¿”å›æ ¼å¼ï¼š
\`\`\`json
[
  {"name": "è§’è‰²å", "role": "èº«ä»½", "personality": "æ€§æ ¼", "relation": "èˆ‡ä¸»è§’é—œä¿‚", "description": "ç°¡ä»‹"}
]
\`\`\``);
    
    const match = response.content.match(/```json\\s*([\\s\\S]*?)\\s*```/) || response.content.match(/\\[\\s*\\{[\\s\\S]*\\}\\s*\\]/);
    if (match) {
      const chars = JSON.parse(match[1] || match[0]);
      chars.forEach(c => {
        c.avatar = 'ğŸ‘¤';
        wizardState.data.characters.push(c);
      });
      renderWizardStep();
      toast(`å·²æ·»åŠ  ${chars.length} å€‹è§’è‰²`, 'success');
    }
  } catch (e) {
    toast('ç”Ÿæˆå¤±æ•—: ' + e.message, 'error');
  }
}

// ç”Ÿæˆå®Œæ•´ Prompt
function generatePrompt() {
  const d = wizardState.data;
  let prompt = '';
  
  // ä¸–ç•Œè§€
  prompt += `# ä¸–ç•Œè§€è¨­å®š\n\n`;
  prompt += `## åŸºæœ¬ä¿¡æ¯\n`;
  prompt += `- æ•…äº‹é¡å‹ï¼š${d.basic.type}\n`;
  prompt += `- æ™‚ä»£èƒŒæ™¯ï¼š${d.basic.era}\n`;
  prompt += `- æ ¸å¿ƒä¸»é¡Œï¼š${d.basic.theme}\n\n`;
  if (d.basic.setting) {
    prompt += `## è©³ç´°è¨­å®š\n${d.basic.setting}\n\n`;
  }
  
  // ä¸»è§’
  prompt += `# ä¸»è§’è¨­å®š\n\n`;
  prompt += `- ç¨±å‘¼ï¼š${d.protagonist.name}\n`;
  prompt += `- æ€§åˆ¥ï¼š${d.protagonist.gender === 'male' ? 'ç”·' : d.protagonist.gender === 'female' ? 'å¥³' : 'è‡ªå®šç¾©'}\n`;
  prompt += `- èº«ä»½ï¼š${d.protagonist.identity}\n`;
  prompt += `- æ€§æ ¼ï¼š${d.protagonist.personality}\n`;
  if (d.protagonist.appearance) prompt += `\n## å¤–è²Œ\n${d.protagonist.appearance}\n`;
  if (d.protagonist.background) prompt += `\n## èƒŒæ™¯\n${d.protagonist.background}\n`;
  if (d.protagonist.goal) prompt += `\n## ç›®æ¨™\n${d.protagonist.goal}\n`;
  prompt += `\n`;
  
  // é…è§’
  if (d.characters.length) {
    prompt += `# ä¸»è¦è§’è‰²\n\n`;
    d.characters.forEach(c => {
      prompt += `## ${c.name}\n`;
      prompt += `- èº«ä»½ï¼š${c.role}\n`;
      prompt += `- æ€§æ ¼ï¼š${c.personality}\n`;
      prompt += `- èˆ‡ä¸»è§’é—œä¿‚ï¼š${c.relation}\n`;
      if (c.description) prompt += `\n${c.description}\n`;
      prompt += `\n`;
    });
  }
  
  // éŠæˆ²æ©Ÿåˆ¶
  prompt += `# éŠæˆ²æ©Ÿåˆ¶\n\n`;
  if (d.mechanics.attributes.length) {
    prompt += `## å±¬æ€§ç³»çµ±\n`;
    d.mechanics.attributes.forEach(a => prompt += `- ${a}\n`);
    prompt += `\n`;
  }
  if (d.mechanics.systems.length) {
    prompt += `## éŠæˆ²ç³»çµ±\n`;
    d.mechanics.systems.forEach(s => prompt += `- ${s}\n`);
    prompt += `\n`;
  }
  if (d.mechanics.triggers.length) {
    prompt += `## ç‰¹æ®Šè§¸ç™¼\n`;
    d.mechanics.triggers.forEach(t => prompt += `- ${t}\n`);
    prompt += `\n`;
  }
  
  // å¯«ä½œé¢¨æ ¼
  prompt += `# å¯«ä½œè¦æ±‚\n\n`;
  prompt += `- æ–‡é¢¨ï¼š${d.style.tone}\n`;
  prompt += `- è¦–è§’ï¼š${d.style.perspective}\n`;
  prompt += `- ç¯‡å¹…ï¼š${d.style.detail}\n`;
  if (d.style.format) prompt += `\n## æ ¼å¼è¦æ±‚\n${d.style.format}\n`;
  prompt += `\n`;
  
  // AI è¦å‰‡
  prompt += `# AI è¡Œç‚ºè¦å‰‡\n\n`;
  if (d.aiRules.dos.length) {
    prompt += `## å¿…é ˆéµå®ˆ\n`;
    d.aiRules.dos.forEach(r => prompt += `- ${r}\n`);
    prompt += `\n`;
  }
  if (d.aiRules.donts.length) {
    prompt += `## ç¦æ­¢äº‹é …\n`;
    d.aiRules.donts.forEach(r => prompt += `- ${r}\n`);
    prompt += `\n`;
  }
  if (d.aiRules.special) {
    prompt += `## ç‰¹æ®ŠæŒ‡ä»¤\n${d.aiRules.special}\n`;
  }
  
  return prompt;
}

// é è¦½å®Œæ•´ Prompt
function previewFullPrompt() {
  const prompt = generatePrompt();
  showConfirm(prompt, null, false, 'ğŸ“„ å®Œæ•´æŒ‡ä»¤é è¦½');
}

// ç·¨è¼¯ Prompt
function editPrompt() {
  const prompt = generatePrompt();
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.style.cssText = 'max-width:90%;max-height:80vh;';
  modal.innerHTML = `
    <div class="modal-title">âœï¸ ç·¨è¼¯æŒ‡ä»¤</div>
    <textarea class="form-input" id="edit-prompt-text" style="min-height:50vh;font-family:monospace;font-size:13px;line-height:1.6">${esc(prompt)}</textarea>
    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="this.closest('.modal').remove();document.getElementById('overlay').classList.remove('active')">å–æ¶ˆ</button>
      <button class="modal-btn confirm" onclick="applyEditedPrompt()">æ‡‰ç”¨ä¿®æ”¹</button>
    </div>
  `;
  document.getElementById('overlay').classList.add('active');
  document.body.appendChild(modal);
}

function applyEditedPrompt() {
  const text = document.getElementById('edit-prompt-text').value;
  wizardState.editedPrompt = text;
  document.querySelector('.modal')?.remove();
  document.getElementById('overlay').classList.remove('active');
  toast(T('å·²æ‡‰ç”¨ä¿®æ”¹'), 'success');
  renderWizardStep();
}

// å°å‡º Prompt
function exportPrompt(format) {
  const prompt = wizardState.editedPrompt || generatePrompt();
  const filename = `æ–‡æ¸¸æŒ‡ä»¤_${wizardState.data.basic.type || 'è‡ªå®šç¾©'}_${Date.now()}`;
  
  if (format === 'md') {
    downloadFile(prompt, filename + '.md', 'text/markdown');
  } else {
    downloadFile(prompt, filename + '.txt', 'text/plain');
  }
  toast(T('å·²å°å‡ºæŒ‡ä»¤æ–‡æª”'), 'success');
}

function downloadFile(content, filename, type) {
  const blob = new Blob([content], { type: type + ';charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ä¿å­˜ç‚ºæŒ‡ä»¤
async function saveAsInstruction() {
  const prompt = wizardState.editedPrompt || generatePrompt();
  const name = wizardState.data.basic.type || 'è‡ªå®šç¾©æŒ‡ä»¤';
  
  const inst = {
    id: crypto.randomUUID(),
    name: name + ' - ' + new Date().toLocaleDateString(),
    icon: wizardTemplates.find(t => t.id === wizardState.data.template)?.icon || 'ğŸ“œ',
    systemPrompt: prompt,
    createdAt: Date.now()
  };
  
  await db.instructions.put(inst);
  toast(T('æŒ‡ä»¤å·²ä¿å­˜ï¼'), 'success');
  goTo('view-instructions');
  await renderInst();
}

// å°è©±å®Œå–„
async function sendWizardChat() {
  const input = document.getElementById('wizard-chat-input');
  const msg = input.value.trim();
  if (!msg) return;
  
  input.value = '';
  wizardState.data.aiChat.push({ role: 'user', content: msg });
  renderWizardStep();
  
  try {
    const prompt = generatePrompt();
    const response = await callAI(`ç”¨æˆ¶æ­£åœ¨å®Œå–„ä»¥ä¸‹æ–‡æ¸¸æŒ‡ä»¤ï¼š

${prompt}

ç”¨æˆ¶èªªï¼š${msg}

è«‹æ ¹æ“šç”¨æˆ¶çš„æ„è¦‹ï¼Œçµ¦å‡ºä¿®æ”¹å»ºè­°æˆ–å›ç­”å•é¡Œã€‚å¦‚æœç”¨æˆ¶è¦æ±‚ä¿®æ”¹æŸéƒ¨åˆ†ï¼Œè«‹æ˜ç¢ºæŒ‡å‡ºæ‡‰è©²å¦‚ä½•ä¿®æ”¹ã€‚å›è¦†è¦æœ‰å»ºè¨­æ€§ã€‚`);
    
    wizardState.data.aiChat.push({ role: 'ai', content: response.content });
    renderWizardStep();
  } catch (e) {
    toast('å›è¦†å¤±æ•—: ' + e.message, 'error');
  }
}

// ============================================
// Prompt åˆ†æç³»çµ±
// ============================================

let analyzeState = {
  originalPrompt: '',
  improvedPrompt: '',
  analysis: null,
  moduleImprovements: {},
  chatHistory: []
};

const analyzeModules = [
  { id: 'worldview', name: 'ä¸–ç•Œè§€è¨­å®š', icon: 'ğŸŒ', keywords: ['ä¸–ç•Œ', 'èƒŒæ™¯', 'æ™‚ä»£', 'è¨­å®š', 'æ­·å²', 'é­”æ³•', 'ç³»çµ±'] },
  { id: 'protagonist', name: 'ä¸»è§’è¨­å®š', icon: 'ğŸ‘¤', keywords: ['ä¸»è§’', 'ä½ ', 'ç©å®¶', 'èº«ä»½', 'æ€§æ ¼', 'ç›®æ¨™'] },
  { id: 'characters', name: 'é…è§’ç³»çµ±', icon: 'ğŸ‘¥', keywords: ['è§’è‰²', 'NPC', 'äººç‰©', 'é—œä¿‚', 'é…è§’'] },
  { id: 'mechanics', name: 'éŠæˆ²æ©Ÿåˆ¶', icon: 'âš™ï¸', keywords: ['å±¬æ€§', 'æ•¸å€¼', 'å¥½æ„Ÿ', 'ç³»çµ±', 'æ©Ÿåˆ¶', 'è§¸ç™¼'] },
  { id: 'style', name: 'å¯«ä½œé¢¨æ ¼', icon: 'âœï¸', keywords: ['é¢¨æ ¼', 'æ–‡é¢¨', 'è¦–è§’', 'æå¯«', 'ç¯‡å¹…', 'å­—æ•¸'] },
  { id: 'aiRules', name: 'AI è¡Œç‚ºè¦å‰‡', icon: 'ğŸ¤–', keywords: ['AI', 'è¦å‰‡', 'ç¦æ­¢', 'å¿…é ˆ', 'ä¸è¦', 'æ‡‰è©²', 'è¼¸å‡º'] }
];

// å•Ÿå‹•åˆ†æ
function startAnalyze() {
  analyzeState = {
    originalPrompt: '',
    improvedPrompt: '',
    analysis: null,
    moduleImprovements: {},
    chatHistory: []
  };
  renderAnalyzeImport();
  goTo('view-analyze');
}

function showAnalyzeHelp() {
  showConfirm(
    'Prompt åˆ†æåŠŸèƒ½å¹«åŠ©\n\n' +
    'é€™å€‹åŠŸèƒ½å¯ä»¥åˆ†æä½ ç¾æœ‰çš„ Promptï¼Œæ‰¾å‡ºä¸è¶³ä¹‹è™•ä¸¦æä¾›æ”¹é€²å»ºè­°ã€‚\n\n' +
    'â€¢ æ”¯æŒä¸Šå‚³ .txt / .md æ–‡æª”æˆ–ç›´æ¥ç²˜è²¼\n' +
    'â€¢ AI æœƒæ·±åº¦åˆ†æ 6 å€‹ç¶­åº¦\n' +
    'â€¢ å¯ä»¥åˆ†æ¨¡å¡Šå–®ç¨å®Œå–„\n' +
    'â€¢ æ”¯æŒåŸç‰ˆèˆ‡æ”¹é€²ç‰ˆå°æ¯”\n\n' +
    'åˆ†æå®Œæˆå¾Œå¯ä»¥å°å‡ºæˆ–ä¿å­˜ç‚ºæŒ‡ä»¤ã€‚',
    null, false, 'ğŸ’¡ å¹«åŠ©'
  );
}

// æ¸²æŸ“å°å…¥ç•Œé¢
function renderAnalyzeImport() {
  const container = document.getElementById('analyze-content');
  container.innerHTML = `
    <div class="wizard-section">
      <div class="wizard-section-title">ğŸ“¥ å°å…¥ä½ çš„ Prompt</div>
      <div class="wizard-section-desc">ä¸Šå‚³æ–‡æª”æˆ–ç›´æ¥ç²˜è²¼ä½ æƒ³åˆ†æçš„ Prompt å…§å®¹ã€‚</div>
      
      <div class="analyze-import">
        <div class="analyze-import-btn" onclick="document.getElementById('analyze-file').click()">
          <div class="icon">ğŸ“„</div>
          <div class="label">ä¸Šå‚³æ–‡æª”<br><small style="color:var(--text-tertiary)">.txt / .md</small></div>
        </div>
        <div class="analyze-import-btn" onclick="pasteFromClipboard()">
          <div class="icon">ğŸ“‹</div>
          <div class="label">å¾å‰ªè²¼æ¿ç²˜è²¼</div>
        </div>
      </div>
      
      <div class="wizard-section-title" style="margin-top:20px">æˆ–ç›´æ¥è¼¸å…¥</div>
      <textarea class="analyze-textarea" id="analyze-input" placeholder="åœ¨æ­¤ç²˜è²¼ä½ çš„ Prompt å…§å®¹..."></textarea>
      
      <div id="analyze-file-info" style="display:none;margin-top:12px;padding:12px;background:var(--bg-card);border-radius:8px">
        <div style="display:flex;align-items:center;gap:8px">
          <span>ğŸ“„</span>
          <span id="analyze-file-name" style="flex:1;font-size:14px"></span>
          <button onclick="clearAnalyzeFile()" style="background:none;border:none;color:var(--error);cursor:pointer">âœ•</button>
        </div>
      </div>
      
      <button class="wizard-btn primary" style="width:100%;margin-top:16px" onclick="startDeepAnalyze()">ğŸ” é–‹å§‹æ·±åº¦åˆ†æ</button>
    </div>
  `;
}

// è™•ç†æ–‡ä»¶ä¸Šå‚³
async function handleAnalyzeFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  try {
    let text = '';
    if (file.name.endsWith('.docx')) {
      toast(T('æ­£åœ¨è§£ææ–‡æª”...'), 'info');
      // ç°¡å–®è™•ç†ï¼Œå¯¦éš›éœ€è¦ mammoth.js
      toast(T('æš«ä¸æ”¯æŒ .docx æ ¼å¼ï¼Œè«‹ä½¿ç”¨ .txt æˆ– .md'), 'warning');
      return;
    } else {
      text = await file.text();
    }
    
    analyzeState.originalPrompt = text;
    document.getElementById('analyze-input').value = text;
    document.getElementById('analyze-file-info').style.display = 'block';
    document.getElementById('analyze-file-name').textContent = file.name;
    toast(T('æ–‡ä»¶å·²è¼‰å…¥'), 'success');
  } catch (e) {
    toast('è®€å–æ–‡ä»¶å¤±æ•—: ' + e.message, 'error');
  }
  
  event.target.value = '';
}

async function pasteFromClipboard() {
  try {
    const text = await navigator.clipboard.readText();
    if (text) {
      document.getElementById('analyze-input').value = text;
      analyzeState.originalPrompt = text;
      toast(T('å·²ç²˜è²¼å…§å®¹'), 'success');
    }
  } catch (e) {
    toast(T('ç„¡æ³•è¨ªå•å‰ªè²¼æ¿ï¼Œè«‹æ‰‹å‹•ç²˜è²¼'), 'warning');
  }
}

function clearAnalyzeFile() {
  analyzeState.originalPrompt = '';
  document.getElementById('analyze-input').value = '';
  document.getElementById('analyze-file-info').style.display = 'none';
}

// é–‹å§‹æ·±åº¦åˆ†æ
async function startDeepAnalyze() {
  const input = document.getElementById('analyze-input');
  const prompt = input?.value?.trim() || analyzeState.originalPrompt;
  
  if (!prompt) {
    toast(T('è«‹å…ˆè¼¸å…¥æˆ–ä¸Šå‚³ Prompt å…§å®¹'), 'warning');
    return;
  }
  
  if (prompt.length < 100) {
    toast(T('Prompt å…§å®¹å¤ªçŸ­ï¼Œè‡³å°‘éœ€è¦ 100 å­—'), 'warning');
    return;
  }
  
  analyzeState.originalPrompt = prompt;
  
  // é¡¯ç¤ºåˆ†æä¸­
  const container = document.getElementById('analyze-content');
  container.innerHTML = `
    <div style="text-align:center;padding:60px 20px">
      <div class="typing-dot" style="display:inline-block"></div>
      <div class="typing-dot" style="display:inline-block"></div>
      <div class="typing-dot" style="display:inline-block"></div>
      <div style="margin-top:20px;font-size:15px;color:var(--text-secondary)">AI æ­£åœ¨æ·±åº¦åˆ†æä½ çš„ Prompt...</div>
      <div style="margin-top:8px;font-size:13px;color:var(--text-tertiary)">é€™å¯èƒ½éœ€è¦ 30-60 ç§’</div>
    </div>
  `;
  
  try {
    const preset = await db.apiPresets.filter(p => p.isActive).first();
    if (!preset) {
      toast(T('è«‹å…ˆåœ¨è¨­ç½®ä¸­é…ç½® API'), 'error');
      renderAnalyzeImport();
      return;
    }
    
    // èª¿ç”¨ AI åˆ†æ
    const response = await callAI(`ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„æ–‡æ¸¸ Prompt åˆ†æå°ˆå®¶ã€‚è«‹æ·±åº¦åˆ†æä»¥ä¸‹ Promptï¼Œä¸¦çµ¦å‡ºè©³ç´°è©•ä¼°ã€‚

ã€å¾…åˆ†æçš„ Promptã€‘
${prompt}

è«‹æŒ‰ä»¥ä¸‹ JSON æ ¼å¼è¿”å›åˆ†æçµæœï¼š
\`\`\`json
{
  "overallScore": 0-100çš„æ•´é«”è©•åˆ†,
  "overallComment": "æ•´é«”è©•åƒ¹ï¼ˆ50å­—å…§ï¼‰",
  "modules": {
    "worldview": {
      "score": 0-100,
      "found": true/false æ˜¯å¦æ‰¾åˆ°ç›¸é—œå…§å®¹,
      "content": "æ‰¾åˆ°çš„ç›¸é—œå…§å®¹æ‘˜è¦ï¼ˆ50å­—å…§ï¼‰",
      "issues": ["å•é¡Œ1", "å•é¡Œ2"],
      "suggestions": ["å»ºè­°1", "å»ºè­°2"]
    },
    "protagonist": {
      "score": 0-100,
      "found": true/false,
      "content": "æ‘˜è¦",
      "issues": [],
      "suggestions": []
    },
    "characters": {
      "score": 0-100,
      "found": true/false,
      "content": "æ‘˜è¦",
      "issues": [],
      "suggestions": []
    },
    "mechanics": {
      "score": 0-100,
      "found": true/false,
      "content": "æ‘˜è¦",
      "issues": [],
      "suggestions": []
    },
    "style": {
      "score": 0-100,
      "found": true/false,
      "content": "æ‘˜è¦",
      "issues": [],
      "suggestions": []
    },
    "aiRules": {
      "score": 0-100,
      "found": true/false,
      "content": "æ‘˜è¦",
      "issues": [],
      "suggestions": []
    }
  },
  "criticalIssues": ["æœ€åš´é‡çš„å•é¡Œ1", "å•é¡Œ2"],
  "topSuggestions": ["æœ€é‡è¦çš„å»ºè­°1", "å»ºè­°2", "å»ºè­°3"]
}
\`\`\`

è©•åˆ†æ¨™æº–ï¼š
- 90-100ï¼šéå¸¸å®Œå–„ï¼Œå¹¾ä¹æ²’æœ‰æ”¹é€²ç©ºé–“
- 70-89ï¼šè‰¯å¥½ï¼Œæœ‰å°çš„æ”¹é€²ç©ºé–“
- 50-69ï¼šä¸€èˆ¬ï¼Œæœ‰æ˜é¡¯ä¸è¶³
- 30-49ï¼šè¼ƒå·®ï¼Œç¼ºå¤±é‡è¦å…§å®¹
- 0-29ï¼šå¾ˆå·®ï¼ŒåŸºæœ¬æ²’æœ‰ç›¸é—œå…§å®¹

è«‹åš´æ ¼æŒ‰ç…§ JSON æ ¼å¼è¿”å›ï¼Œä¸è¦æœ‰å…¶ä»–å…§å®¹ã€‚`);
    
    // è§£æçµæœ
    const match = response.content.match(/```json\s*([\s\S]*?)\s*```/) || response.content.match(/\{[\s\S]*\}/);
    if (match) {
      const analysis = JSON.parse(match[1] || match[0]);
      analyzeState.analysis = analysis;
      renderAnalyzeResult();
    } else {
      throw new Error('ç„¡æ³•è§£æ AI è¿”å›çš„çµæœ');
    }
  } catch (e) {
    toast('åˆ†æå¤±æ•—: ' + e.message, 'error');
    renderAnalyzeImport();
  }
}

// æ¸²æŸ“åˆ†æçµæœ
function renderAnalyzeResult() {
  const a = analyzeState.analysis;
  const container = document.getElementById('analyze-content');
  
  // è¨ˆç®—çµ±è¨ˆ
  const charCount = analyzeState.originalPrompt.length;
  const lineCount = analyzeState.originalPrompt.split('\n').length;
  const issueCount = Object.values(a.modules).reduce((sum, m) => sum + (m.issues?.length || 0), 0);
  
  container.innerHTML = `
    <div class="analyze-stats">
      <div class="analyze-stat"><div class="analyze-stat-value">${charCount.toLocaleString()}</div><div class="analyze-stat-label">å­—æ•¸</div></div>
      <div class="analyze-stat"><div class="analyze-stat-value">${lineCount}</div><div class="analyze-stat-label">è¡Œæ•¸</div></div>
      <div class="analyze-stat"><div class="analyze-stat-value">${issueCount}</div><div class="analyze-stat-label">å•é¡Œ</div></div>
    </div>
    
    <div class="analyze-score">
      <div class="analyze-score-ring">
        <svg width="120" height="120" viewBox="0 0 120 120">
          <circle class="bg" cx="60" cy="60" r="52"/>
          <circle class="fill" cx="60" cy="60" r="52" 
            stroke-dasharray="${2 * Math.PI * 52}" 
            stroke-dashoffset="${2 * Math.PI * 52 * (1 - a.overallScore / 100)}"/>
        </svg>
        <div class="analyze-score-value">
          <div class="analyze-score-num">${a.overallScore}</div>
          <div class="analyze-score-label">ç¸½åˆ†</div>
        </div>
      </div>
      <div class="analyze-score-text">${a.overallComment || 'åˆ†æå®Œæˆ'}</div>
    </div>
    
    <div class="wizard-section-title">ğŸ“‹ æ¨¡å¡Šè©•åˆ†</div>
    <div class="analyze-modules" id="analyze-modules">
      ${analyzeModules.map(m => {
        const data = a.modules[m.id] || { score: 0, found: false, issues: [], suggestions: [] };
        const scoreClass = data.score >= 70 ? 'high' : data.score >= 40 ? 'medium' : 'low';
        const statusIcon = data.score >= 70 ? 'âœ…' : data.score >= 40 ? 'âš ï¸' : 'âŒ';
        const improved = analyzeState.moduleImprovements[m.id];
        return `
          <div class="analyze-module ${improved ? 'improved' : ''}" id="module-${m.id}">
            <div class="analyze-module-header" onclick="toggleAnalyzeModule('${m.id}')">
              <span class="analyze-module-icon">${m.icon}</span>
              <span class="analyze-module-name">${m.name}</span>
              <div class="analyze-module-score">
                <div class="analyze-module-bar"><div class="analyze-module-bar-fill ${scoreClass}" style="width:${data.score}%"></div></div>
                <span class="analyze-module-num">${data.score}</span>
                <span class="analyze-module-status">${improved ? 'âœ¨' : statusIcon}</span>
              </div>
            </div>
            <div class="analyze-module-body">
              ${data.found ? `<div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px;padding:10px;background:var(--bg-tertiary);border-radius:8px">${esc(data.content || 'å·²æ‰¾åˆ°ç›¸é—œå…§å®¹')}</div>` : '<div style="font-size:13px;color:var(--warning);margin-bottom:12px">âš ï¸ æœªæ‰¾åˆ°ç›¸é—œå…§å®¹</div>'}
              ${data.issues?.length ? `
                <div class="analyze-module-issues">
                  ${data.issues.map(issue => `
                    <div class="analyze-issue">
                      <span class="analyze-issue-icon">âš ï¸</span>
                      <span class="analyze-issue-text">${esc(issue)}</span>
                    </div>
                  `).join('')}
                </div>
              ` : ''}
              ${data.suggestions?.length ? `
                <div style="margin-bottom:12px">
                  <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:6px">ğŸ’¡ å»ºè­°</div>
                  ${data.suggestions.map(s => `<div style="font-size:13px;color:var(--text-secondary);padding:4px 0">â€¢ ${esc(s)}</div>`).join('')}
                </div>
              ` : ''}
              ${improved ? `
                <div style="margin-bottom:12px;padding:10px;background:rgba(16,185,129,.1);border-radius:8px;border-left:3px solid var(--success)">
                  <div style="font-size:12px;color:var(--success);margin-bottom:6px">âœ¨ å·²æ”¹é€²</div>
                  <div style="font-size:13px;color:var(--text-secondary);white-space:pre-wrap;max-height:150px;overflow-y:auto">${esc(improved.slice(0, 500))}${improved.length > 500 ? '...' : ''}</div>
                </div>
              ` : ''}
              <div class="analyze-module-actions">
                <button class="analyze-module-btn ${improved ? '' : 'primary'}" onclick="improveModule('${m.id}')">
                  ${improved ? 'ğŸ”„ é‡æ–°ç”Ÿæˆ' : 'ğŸ¤– AI å®Œå–„'}
                </button>
                <button class="analyze-module-btn" onclick="editModule('${m.id}')">âœï¸ æ‰‹å‹•ç·¨è¼¯</button>
              </div>
            </div>
          </div>
        `;
      }).join('')}
    </div>
    
    ${a.criticalIssues?.length ? `
      <div class="analyze-suggestions" style="border-left-color:var(--error)">
        <div class="analyze-suggestions-title"><span>âŒ</span> åš´é‡å•é¡Œ</div>
        <div class="analyze-suggestions-content">
          ${a.criticalIssues.map((issue, i) => `${i + 1}. ${esc(issue)}`).join('<br>')}
        </div>
      </div>
    ` : ''}
    
    <div class="analyze-suggestions">
      <div class="analyze-suggestions-title"><span>ğŸ’¡</span> AI å»ºè­°</div>
      <div class="analyze-suggestions-content">
        ${a.topSuggestions?.map((s, i) => `${i + 1}. ${esc(s)}`).join('<br>') || 'æš«ç„¡å»ºè­°'}
      </div>
    </div>
    
    <div class="wizard-section-title" style="margin-top:24px">ğŸ“¤ å°å‡ºé¸é …</div>
    <div class="analyze-actions">
      <button class="wizard-btn secondary" onclick="showAnalyzeCompare()">ğŸ“Š å°æ¯”æŸ¥çœ‹</button>
      <button class="wizard-btn secondary" onclick="previewImprovedPrompt()">ğŸ‘ï¸ é è¦½æ”¹é€²ç‰ˆ</button>
      <button class="wizard-btn secondary" onclick="exportAnalyzedPrompt('md')">ğŸ“„ å°å‡º MD</button>
      <button class="wizard-btn secondary" onclick="exportAnalyzedPrompt('txt')">ğŸ“ å°å‡º TXT</button>
    </div>
    <button class="wizard-btn primary" style="width:100%;margin-top:12px" onclick="saveAnalyzedAsInstruction()">ğŸ’¾ ä¿å­˜ç‚ºæŒ‡ä»¤</button>
    
    <div class="analyze-chat">
      <div class="wizard-section-title">ğŸ’¬ å°è©±è¨è«–</div>
      <div class="wizard-section-desc">æœ‰ç–‘å•ï¼Ÿå’Œ AI è¨è«–å…·é«”å•é¡Œã€‚</div>
      <div class="wizard-chat" id="analyze-chat-list">
        ${analyzeState.chatHistory.map(m => `
          <div class="wizard-chat-msg ${m.role}">${marked.parse(m.content)}</div>
        `).join('')}
      </div>
      <div class="wizard-chat-input">
        <input class="wizard-chat-field" id="analyze-chat-input" placeholder="è©¢å• AI é—œæ–¼ Prompt çš„å•é¡Œ..." onkeypress="if(event.key==='Enter')sendAnalyzeChat()">
        <button class="wizard-chat-send" onclick="sendAnalyzeChat()">â¤</button>
      </div>
    </div>
  `;
}

// åˆ‡æ›æ¨¡å¡Šå±•é–‹
function toggleAnalyzeModule(id) {
  const module = document.getElementById('module-' + id);
  if (module) {
    module.classList.toggle('expanded');
  }
}

// AI å®Œå–„å–®å€‹æ¨¡å¡Š
async function improveModule(moduleId) {
  const module = analyzeModules.find(m => m.id === moduleId);
  if (!module) return;
  
  toast(`AI æ­£åœ¨å®Œå–„ ${module.name}...`, 'info');
  
  try {
    const a = analyzeState.analysis;
    const moduleData = a.modules[moduleId] || {};
    
    const response = await callAI(`ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„æ–‡æ¸¸ Prompt å¯«ä½œå°ˆå®¶ã€‚

ã€åŸå§‹ Promptã€‘
${analyzeState.originalPrompt}

ã€ç•¶å‰æ¨¡å¡Šã€‘${module.name}
ã€ç¾æœ‰å…§å®¹ã€‘${moduleData.content || 'ç„¡'}
ã€ç™¼ç¾çš„å•é¡Œã€‘${moduleData.issues?.join('ã€') || 'ç„¡'}
ã€æ”¹é€²å»ºè­°ã€‘${moduleData.suggestions?.join('ã€') || 'ç„¡'}

è«‹ç‚ºé€™å€‹æ¨¡å¡Šç”Ÿæˆæ”¹é€²å¾Œçš„å…§å®¹ã€‚è¦æ±‚ï¼š
1. ä¿æŒèˆ‡åŸ Prompt é¢¨æ ¼ä¸€è‡´
2. è§£æ±ºç™¼ç¾çš„å•é¡Œ
3. æ¡ç´å»ºè­°é€²è¡Œå„ªåŒ–
4. å…§å®¹è¦å…·é«”ã€å¯ç”¨

ç›´æ¥è¼¸å‡ºæ”¹é€²å¾Œçš„å…§å®¹ï¼Œä¸è¦æœ‰å…¶ä»–è§£é‡‹ã€‚è¼¸å‡ºæ ¼å¼ä¿æŒ Markdownã€‚`);
    
    analyzeState.moduleImprovements[moduleId] = response.content;
    toast(`${module.name} å·²å®Œå–„`, 'success');
    renderAnalyzeResult();
    
    // å±•é–‹é€™å€‹æ¨¡å¡Š
    setTimeout(() => {
      const el = document.getElementById('module-' + moduleId);
      if (el) el.classList.add('expanded');
    }, 100);
  } catch (e) {
    toast('å®Œå–„å¤±æ•—: ' + e.message, 'error');
  }
}

// æ‰‹å‹•ç·¨è¼¯æ¨¡å¡Š
function editModule(moduleId) {
  const module = analyzeModules.find(m => m.id === moduleId);
  if (!module) return;
  
  const current = analyzeState.moduleImprovements[moduleId] || '';
  const moduleData = analyzeState.analysis?.modules[moduleId] || {};
  
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.style.cssText = 'max-width:90%;max-height:80vh;';
  modal.innerHTML = `
    <div class="modal-title">âœï¸ ç·¨è¼¯ ${module.name}</div>
    <div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">
      ${moduleData.suggestions?.length ? 'ğŸ’¡ AI å»ºè­°ï¼š' + moduleData.suggestions.join('ï¼›') : ''}
    </div>
    <textarea class="form-input" id="edit-module-text" style="min-height:40vh;font-family:monospace;font-size:13px;line-height:1.6">${esc(current)}</textarea>
    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="this.closest('.modal').remove();document.getElementById('overlay').classList.remove('active')">å–æ¶ˆ</button>
      <button class="modal-btn confirm" onclick="saveModuleEdit('${moduleId}')">ä¿å­˜</button>
    </div>
  `;
  document.getElementById('overlay').classList.add('active');
  document.body.appendChild(modal);
}

function saveModuleEdit(moduleId) {
  const text = document.getElementById('edit-module-text').value.trim();
  if (text) {
    analyzeState.moduleImprovements[moduleId] = text;
  } else {
    delete analyzeState.moduleImprovements[moduleId];
  }
  document.querySelector('.modal')?.remove();
  document.getElementById('overlay').classList.remove('active');
  toast(T('å·²ä¿å­˜'), 'success');
  renderAnalyzeResult();
}

// ç”Ÿæˆæ”¹é€²å¾Œçš„ Prompt
function generateImprovedPrompt() {
  let improved = analyzeState.originalPrompt;
  
  // å¦‚æœæœ‰æ¨¡å¡Šæ”¹é€²ï¼Œé™„åŠ åˆ°æœ«å°¾
  const improvements = Object.entries(analyzeState.moduleImprovements);
  if (improvements.length > 0) {
    improved += '\n\n---\n\n# è£œå……èˆ‡æ”¹é€²\n\n';
    improvements.forEach(([id, content]) => {
      const module = analyzeModules.find(m => m.id === id);
      improved += `## ${module?.icon || 'ğŸ“'} ${module?.name || id}\n\n${content}\n\n`;
    });
  }
  
  analyzeState.improvedPrompt = improved;
  return improved;
}

// é¡¯ç¤ºå°æ¯”
function showAnalyzeCompare() {
  const improved = generateImprovedPrompt();
  const original = analyzeState.originalPrompt;
  
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.style.cssText = 'max-width:95%;max-height:85vh;width:800px;';
  modal.innerHTML = `
    <div class="modal-title">ğŸ“Š åŸç‰ˆ vs æ”¹é€²ç‰ˆå°æ¯”</div>
    <div class="analyze-compare" style="max-height:60vh">
      <div class="analyze-compare-col">
        <div class="analyze-compare-title">ğŸ“„ åŸç‰ˆ (${original.length} å­—)</div>
        <div class="analyze-compare-content">${esc(original)}</div>
      </div>
      <div class="analyze-compare-col">
        <div class="analyze-compare-title">âœ¨ æ”¹é€²ç‰ˆ (${improved.length} å­—)</div>
        <div class="analyze-compare-content">${esc(improved)}</div>
      </div>
    </div>
    <div style="margin-top:12px;font-size:13px;color:var(--text-secondary)">
      ${Object.keys(analyzeState.moduleImprovements).length > 0 
        ? `âœ… å·²æ”¹é€² ${Object.keys(analyzeState.moduleImprovements).length} å€‹æ¨¡å¡Š` 
        : 'âš ï¸ å°šæœªé€²è¡Œä»»ä½•æ”¹é€²'}
    </div>
    <div class="modal-actions">
      <button class="modal-btn confirm" onclick="this.closest('.modal').remove();document.getElementById('overlay').classList.remove('active')">é—œé–‰</button>
    </div>
  `;
  document.getElementById('overlay').classList.add('active');
  document.body.appendChild(modal);
}

// é è¦½æ”¹é€²ç‰ˆ
function previewImprovedPrompt() {
  const improved = generateImprovedPrompt();
  
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.style.cssText = 'max-width:90%;max-height:80vh;';
  modal.innerHTML = `
    <div class="modal-title">ğŸ‘ï¸ æ”¹é€²ç‰ˆé è¦½</div>
    <div style="font-size:13px;color:var(--text-tertiary);margin-bottom:12px">${improved.length.toLocaleString()} å­—</div>
    <div style="background:var(--bg-tertiary);border-radius:8px;padding:12px;max-height:50vh;overflow-y:auto;font-size:13px;line-height:1.7;white-space:pre-wrap;font-family:monospace">${esc(improved)}</div>
    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="this.closest('.modal').remove();document.getElementById('overlay').classList.remove('active')">é—œé–‰</button>
      <button class="modal-btn confirm" onclick="copyImprovedPrompt()">ğŸ“‹ è¤‡è£½</button>
    </div>
  `;
  document.getElementById('overlay').classList.add('active');
  document.body.appendChild(modal);
}

async function copyImprovedPrompt() {
  const improved = generateImprovedPrompt();
  try {
    await navigator.clipboard.writeText(improved);
    toast(T('å·²è¤‡è£½åˆ°å‰ªè²¼æ¿'), 'success');
  } catch (e) {
    toast(T('è¤‡è£½å¤±æ•—'), 'error');
  }
}

// å°å‡º
function exportAnalyzedPrompt(format) {
  const improved = generateImprovedPrompt();
  const filename = `Promptåˆ†ææ”¹é€²ç‰ˆ_${Date.now()}`;
  
  if (format === 'md') {
    downloadFile(improved, filename + '.md', 'text/markdown');
  } else {
    downloadFile(improved, filename + '.txt', 'text/plain');
  }
  toast(T('å·²å°å‡º'), 'success');
}

// ä¿å­˜ç‚ºæŒ‡ä»¤
async function saveAnalyzedAsInstruction() {
  const improved = generateImprovedPrompt();
  
  const inst = {
    id: crypto.randomUUID(),
    name: 'åˆ†ææ”¹é€²ç‰ˆ - ' + new Date().toLocaleDateString(),
    icon: 'âœ¨',
    systemPrompt: improved,
    createdAt: Date.now()
  };
  
  await db.instructions.put(inst);
  toast(T('å·²ä¿å­˜ç‚ºæŒ‡ä»¤ï¼'), 'success');
  goTo('view-instructions');
  await renderInst();
}

// å°è©±è¨è«–
async function sendAnalyzeChat() {
  const input = document.getElementById('analyze-chat-input');
  const msg = input.value.trim();
  if (!msg) return;
  
  input.value = '';
  analyzeState.chatHistory.push({ role: 'user', content: msg });
  renderAnalyzeResult();
  
  try {
    const response = await callAI(`ä½ æ˜¯ Prompt åˆ†æå°ˆå®¶ã€‚ç”¨æˆ¶æ­£åœ¨åˆ†æä»¥ä¸‹ Promptï¼š

ã€åŸå§‹ Prompt æ‘˜è¦ã€‘
${analyzeState.originalPrompt.slice(0, 2000)}...

ã€åˆ†æçµæœã€‘
ç¸½åˆ†ï¼š${analyzeState.analysis?.overallScore || 'æœªçŸ¥'}
ä¸»è¦å•é¡Œï¼š${analyzeState.analysis?.criticalIssues?.join('ã€') || 'ç„¡'}

ã€ç”¨æˆ¶å•é¡Œã€‘
${msg}

è«‹é‡å°ç”¨æˆ¶çš„å•é¡Œçµ¦å‡ºå°ˆæ¥­ã€å…·é«”çš„å›ç­”ã€‚å›è¦†è¦ç°¡æ½”å¯¦ç”¨ã€‚`);
    
    analyzeState.chatHistory.push({ role: 'ai', content: response.content });
    renderAnalyzeResult();
    
    // æ»¾å‹•åˆ°åº•éƒ¨
    setTimeout(() => {
      const chatList = document.getElementById('analyze-chat-list');
      if (chatList) chatList.scrollTop = chatList.scrollHeight;
    }, 100);
  } catch (e) {
    toast('å›è¦†å¤±æ•—: ' + e.message, 'error');
  }
}

// ==================== åŠ‡æœ¬æ™ºèƒ½æ‹†åˆ†åŠŸèƒ½ ====================

let scriptImportState = {
  step: 1,
  rawContent: '',
  rawTokens: 0,
  sourceType: 'paste',
  fileName: null,
  result: null,
  analyzing: false
};

function showScriptImport() {
  // å…³é—­æ•…äº‹è®¾ç½®é¢æ¿
  closeAll();
  
  // é‡ç½®çŠ¶æ€
  scriptImportState = {
    step: 1,
    rawContent: '',
    rawTokens: 0,
    sourceType: 'paste',
    fileName: null,
    result: null,
    analyzing: false
  };
  
  // ä½¿ç”¨å»¶æ—¶ç¡®ä¿closeAllå®Œæˆ
  setTimeout(() => {
    // é‡ç½®UIå…ƒç´ 
    const textInput = document.getElementById('script-input-text');
    if (textInput) textInput.value = '';
    const tokenCount = document.getElementById('script-token-count');
    if (tokenCount) tokenCount.textContent = '0';
    const fileDrop = document.getElementById('script-file-drop');
    if (fileDrop) fileDrop.style.display = 'block';
    const fileSelected = document.getElementById('script-file-selected');
    if (fileSelected) fileSelected.style.display = 'none';
    const pasteArea = document.getElementById('script-paste-area');
    if (pasteArea) pasteArea.style.display = 'block';
    const fileArea = document.getElementById('script-file-area');
    if (fileArea) fileArea.style.display = 'none';
    
    // æ›´æ–°æ­¥éª¤UI
    updateScriptImportUI();
    
    // æ‰“å¼€æ¨¡æ€æ¡†
    showModal('script-import-modal');
  }, 50);
}

function closeScriptImport() {
  if (scriptImportState.analyzing) {
    showConfirm('æ­£åœ¨åˆ†æä¸­ï¼Œç¢ºå®šè¦å–æ¶ˆå—ï¼Ÿ', () => {
      scriptImportState.analyzing = false;
      closeModal('script-import-modal');
    });
  } else {
    closeModal('script-import-modal');
  }
}

function updateScriptImportUI() {
  try {
    const step = scriptImportState.step;
    
    // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
    document.querySelectorAll('.script-step').forEach((el, i) => {
      el.classList.remove('active', 'done');
      if (i + 1 < step) el.classList.add('done');
      if (i + 1 === step) el.classList.add('active');
    });
    
    // æ˜¾ç¤ºå¯¹åº”æ­¥éª¤å†…å®¹
    for (let i = 1; i <= 4; i++) {
      const content = document.getElementById(`script-step-${i}`);
      if (content) content.style.display = i === step ? 'block' : 'none';
    }
    
    // æ›´æ–°æŒ‰é’®
    const prevBtn = document.getElementById('script-prev-btn');
    const nextBtn = document.getElementById('script-next-btn');
    
    if (prevBtn) {
      prevBtn.style.display = step > 1 && step < 4 ? 'inline-block' : 'none';
    }
    
    if (nextBtn) {
      if (step === 1) {
        nextBtn.textContent = 'ä¸‹ä¸€æ­¥ â†’';
        nextBtn.disabled = !scriptImportState.rawContent.trim();
        nextBtn.style.display = 'inline-block';
      } else if (step === 2) {
        nextBtn.style.display = 'none';
      } else if (step === 3) {
        nextBtn.textContent = 'ç¢ºèªå°å…¥ â†’';
        nextBtn.style.display = 'inline-block';
      } else if (step === 4) {
        nextBtn.textContent = 'å®Œæˆ';
        if (prevBtn) prevBtn.style.display = 'none';
      }
    }
  } catch(e) {
    // é™é»˜å¤„ç†UIæ›´æ–°é”™è¯¯
  }
}

function switchScriptTab(type) {
  scriptImportState.sourceType = type;
  document.querySelectorAll('.script-tab').forEach(t => t.classList.remove('active'));
  if (event && event.target) event.target.classList.add('active');
  
  const pasteArea = document.getElementById('script-paste-area');
  const fileArea = document.getElementById('script-file-area');
  if (pasteArea) pasteArea.style.display = type === 'paste' ? 'block' : 'none';
  if (fileArea) fileArea.style.display = type === 'file' ? 'block' : 'none';
}

// åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ 
document.addEventListener('DOMContentLoaded', () => {
  const fileInput = document.getElementById('script-file-input');
  const fileDrop = document.getElementById('script-file-drop');
  const textInput = document.getElementById('script-input-text');
  
  if (fileInput) {
    fileInput.addEventListener('change', handleScriptFile);
  }
  
  if (fileDrop) {
    fileDrop.addEventListener('click', () => fileInput?.click());
    fileDrop.addEventListener('dragover', (e) => {
      e.preventDefault();
      fileDrop.classList.add('dragover');
    });
    fileDrop.addEventListener('dragleave', () => {
      fileDrop.classList.remove('dragover');
    });
    fileDrop.addEventListener('drop', (e) => {
      e.preventDefault();
      fileDrop.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) processScriptFile(file);
    });
  }
  
  if (textInput) {
    textInput.addEventListener('input', () => {
      scriptImportState.rawContent = textInput.value;
      scriptImportState.rawTokens = estimateTokens(textInput.value);
      document.getElementById('script-token-count').textContent = scriptImportState.rawTokens.toLocaleString();
      updateScriptImportUI();
    });
  }
});

function handleScriptFile(e) {
  const file = e.target.files[0];
  if (file) processScriptFile(file);
}

async function processScriptFile(file) {
  const ext = file.name.split('.').pop().toLowerCase();
  
  if (!['txt', 'md', 'docx'].includes(ext)) {
    toast(T('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œè«‹ä½¿ç”¨ .txt / .md / .docx'), 'error');
    return;
  }
  
  try {
    let content = '';
    
    if (ext === 'docx') {
      // ä½¿ç”¨ mammoth è¯»å– docx
      const arrayBuffer = await file.arrayBuffer();
      if (typeof mammoth !== 'undefined') {
        const result = await mammoth.extractRawText({ arrayBuffer });
        content = result.value;
      } else {
        // åŠ¨æ€åŠ è½½ mammoth
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js');
        const result = await mammoth.extractRawText({ arrayBuffer });
        content = result.value;
      }
    } else {
      content = await file.text();
    }
    
    scriptImportState.rawContent = content;
    scriptImportState.rawTokens = estimateTokens(content);
    scriptImportState.fileName = file.name;
    
    document.getElementById('script-file-drop').style.display = 'none';
    document.getElementById('script-file-selected').style.display = 'flex';
    document.getElementById('script-file-name').textContent = `ğŸ“„ ${file.name} (${scriptImportState.rawTokens.toLocaleString()} tokens)`;
    document.getElementById('script-token-count').textContent = scriptImportState.rawTokens.toLocaleString();
    
    updateScriptImportUI();
  } catch (e) {
    toast('è®€å–æ–‡ä»¶å¤±æ•—: ' + e.message, 'error');
  }
}

function loadScript(src) {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = src;
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
}

function clearScriptFile() {
  scriptImportState.rawContent = '';
  scriptImportState.rawTokens = 0;
  scriptImportState.fileName = null;
  
  document.getElementById('script-file-drop').style.display = 'block';
  document.getElementById('script-file-selected').style.display = 'none';
  document.getElementById('script-file-input').value = '';
  document.getElementById('script-token-count').textContent = '0';
  
  updateScriptImportUI();
}

function estimateTokens(text) {
  if (!text) return 0;
  const chineseChars = (text.match(/[\u4e00-\u9fff]/g) || []).length;
  const otherChars = text.length - chineseChars;
  return Math.ceil(chineseChars * 1.5 + otherChars * 0.3);
}

async function scriptNextStep() {
  const step = scriptImportState.step;
  
  if (step === 1) {
    if (!scriptImportState.rawContent.trim()) {
      toast(T('è«‹å…ˆè¼¸å…¥æˆ–ä¸Šå‚³åŠ‡æœ¬å…§å®¹'), 'warning');
      return;
    }
    scriptImportState.step = 2;
    updateScriptImportUI();
    await analyzeScript();
  } else if (step === 3) {
    await importScriptResult();
  } else if (step === 4) {
    closeModal('script-import-modal');
  }
}

function scriptPrevStep() {
  if (scriptImportState.step > 1) {
    scriptImportState.step--;
    updateScriptImportUI();
  }
}

async function analyzeScript() {
  scriptImportState.analyzing = true;
  
  const steps = ['analyze-step-1', 'analyze-step-2', 'analyze-step-3', 'analyze-step-4', 'analyze-step-5'];
  let progress = 0;
  
  // æ¨¡æ‹Ÿè¿›åº¦
  const progressInterval = setInterval(() => {
    if (progress < 90) {
      progress += Math.random() * 5;
      document.getElementById('script-progress').style.width = progress + '%';
      document.getElementById('script-progress-text').textContent = Math.round(progress) + '%';
      
      // æ›´æ–°æ­¥éª¤çŠ¶æ€
      const stepIndex = Math.floor(progress / 20);
      steps.forEach((id, i) => {
        const el = document.getElementById(id);
        if (i < stepIndex) {
          el.className = 'script-analyze-step done';
          el.textContent = 'âœ“ ' + el.textContent.replace(/^[â—‹âœ“â†’]\s*/, '');
        } else if (i === stepIndex) {
          el.className = 'script-analyze-step active';
          el.textContent = 'â†’ ' + el.textContent.replace(/^[â—‹âœ“â†’]\s*/, '');
        }
      });
    }
  }, 200);
  
  try {
    // æ„å»ºåˆ†ææç¤ºè¯
    const analysisPrompt = buildScriptAnalysisPrompt();
    
    // è°ƒç”¨ AI
    const preset = await getActivePreset();
    if (!preset) {
      throw new Error('è«‹å…ˆè¨­ç½® API');
    }
    
    const response = await callAIForScriptAnalysis(preset, analysisPrompt, scriptImportState.rawContent);
    
    // è§£æç»“æœ
    scriptImportState.result = parseScriptAnalysisResult(response);
    
    // å®Œæˆè¿›åº¦
    clearInterval(progressInterval);
    document.getElementById('script-progress').style.width = '100%';
    document.getElementById('script-progress-text').textContent = '100%';
    steps.forEach(id => {
      const el = document.getElementById(id);
      el.className = 'script-analyze-step done';
      el.textContent = 'âœ“ ' + el.textContent.replace(/^[â—‹âœ“â†’]\s*/, '');
    });
    
    await new Promise(r => setTimeout(r, 500));
    
    scriptImportState.step = 3;
    scriptImportState.analyzing = false;
    updateScriptImportUI();
    renderScriptPreview();
    
  } catch (e) {
    clearInterval(progressInterval);
    scriptImportState.analyzing = false;
    toast('åˆ†æå¤±æ•—: ' + e.message, 'error');
    scriptImportState.step = 1;
    updateScriptImportUI();
  }
}

function buildScriptAnalysisPrompt() {
  return `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„æ–‡å­—éŠæˆ²åŠ‡æœ¬åˆ†æåŠ©æ‰‹ã€‚ä½ çš„ä»»å‹™æ˜¯å°‡ç”¨æˆ¶æä¾›çš„åŠ‡æœ¬æ™ºèƒ½æ‹†åˆ†ï¼Œä»¥å„ªåŒ– token æ¶ˆè€—ã€‚

## æ ¸å¿ƒåŸå‰‡

**è‡ªé©æ‡‰åˆ†æ**ï¼šä¸è¦é è¨­å›ºå®šåˆ†é¡ï¼Œæ ¹æ“šåŠ‡æœ¬å¯¦éš›å…§å®¹å‹•æ…‹è­˜åˆ¥å’Œåˆ†é¡ã€‚

ä¸åŒé¡å‹çš„åŠ‡æœ¬æœ‰å®Œå…¨ä¸åŒçš„çµæ§‹ï¼š
- å¥³åƒ•å’–å•¡å»³ï¼šèœå–®ã€æœå‹™è¦ç¯„ã€è·ç´šç³»çµ±
- ä¿®ä»™ï¼šå®—é–€ã€åŠŸæ³•ã€å¢ƒç•Œé«”ç³»ã€ä¸¹è—¥
- è³½åšæœ‹å…‹ï¼šå¹«æ´¾ã€å€åŸŸã€æ­¦å™¨ã€æ”¹é€ éƒ¨ä»¶
- æ ¡åœ’æˆ€æ„›ï¼šå­¸æ ¡è¨­å®šã€ç¤¾åœ˜ã€ç­ç´š

ä½ éœ€è¦**ç†è§£é€™å€‹åŠ‡æœ¬æ˜¯ä»€éº¼é¡å‹**ï¼Œç„¶å¾Œæ ¹æ“šå…¶å…§å®¹ç‰¹é»é€²è¡Œåˆé©çš„æ‹†åˆ†ã€‚

## æ‹†åˆ†ç›®æ¨™

### 1. æŒ‡ä»¤ï¼ˆinstructionï¼‰
æ”¾å…¥ã€Œæ¯æ¬¡å°è©±éƒ½å¿…é ˆç™¼é€ã€çš„æ ¸å¿ƒå…§å®¹ï¼š
- AI è¡Œç‚ºè¦å‰‡ï¼ˆå¦‚ä½•å›æ‡‰ã€ä»€éº¼é¢¨æ ¼ã€ä»€éº¼è¦–è§’ï¼‰
- æ•˜äº‹è¨­å®šï¼ˆäººç¨±ã€èªæ°£ã€æ ¼å¼è¦æ±‚ï¼‰
- éŠæˆ²æ ¸å¿ƒæ©Ÿåˆ¶
- å…¨å±€ç´„æŸ

**ä¸æ‡‰æ”¾å…¥æŒ‡ä»¤çš„å…§å®¹**ï¼šå…·é«”æ•¸æ“šè¡¨ã€è©³ç´°è§’è‰²è¨­å®šã€è©³ç´°åœ°é»æè¿°

### 2. Lorebook æ¢ç›®ï¼ˆlorebookEntriesï¼‰
æ”¾å…¥ã€Œç‰¹å®šæƒ…æ³æ‰éœ€è¦ã€çš„è¨­å®šï¼Œé€šéè§¸ç™¼è©æŒ‰éœ€èª¿ç”¨ã€‚
**é‡è¦**ï¼šå¦‚æœå­˜åœ¨å¤šå€‹åŒé¡å¯¦é«”ï¼ˆå¦‚å¤šå€‹é¤å»³çš„èœå–®ã€å¤šå€‹å®—é–€çš„è¨­å®šï¼‰ï¼Œå¿…é ˆæ‹†åˆ†ç‚ºç¨ç«‹æ¢ç›®ã€‚

### 3. ä¸–ç•Œè§€è³‡æ–™ï¼ˆworldInfoEntriesï¼‰
æ”¾å…¥ã€ŒèƒŒæ™¯åƒè€ƒã€é¡å…§å®¹ï¼ˆå®è§€ä¸–ç•Œè§€ã€æ™‚ä»£èƒŒæ™¯ã€åœ°ç†æ–‡åŒ–ï¼‰ã€‚

### 4. è§’è‰²ï¼ˆcharactersï¼‰
æ‰€æœ‰å‘½åè§’è‰²ï¼ˆæœ‰åå­—çš„è§’è‰²ï¼‰ã€‚

## è¼¸å‡ºæ ¼å¼

è«‹ä»¥ JSON æ ¼å¼è¼¸å‡ºï¼ˆä¸è¦æœ‰å…¶ä»–å…§å®¹ï¼‰ï¼š

\`\`\`json
{
  "scriptType": "åŠ‡æœ¬é¡å‹",
  "instruction": {
    "content": "æ ¸å¿ƒè¦å‰‡å…§å®¹",
    "reasoning": "è§£é‡‹"
  },
  "lorebookEntries": [
    {
      "name": "æ¢ç›®åç¨±",
      "content": "æ¢ç›®å…§å®¹",
      "keys": ["è§¸ç™¼è©1", "è§¸ç™¼è©2"],
      "category": "åˆ†é¡å",
      "reasoning": "è§£é‡‹"
    }
  ],
  "worldInfoEntries": [
    {
      "title": "æ¨™é¡Œ",
      "content": "å…§å®¹",
      "category": "åˆ†é¡å"
    }
  ],
  "characters": [
    {
      "name": "è§’è‰²å",
      "title": "é ­éŠœ",
      "description": "æè¿°",
      "personality": "æ€§æ ¼",
      "category": "protagonist|supporting|npc"
    }
  ],
  "detectedCategories": [
    {"name": "åˆ†é¡å", "type": "lorebook", "count": 3, "icon": "ğŸ½ï¸"}
  ]
}
\`\`\`

## è§¸ç™¼è©è¨­è¨ˆåŸå‰‡

1. æ¯å€‹æ¢ç›® 5-10 å€‹è§¸ç™¼è©
2. å¤šå¯¦é«”æƒ…æ³å¿…é ˆåŒ…å«å¯¦é«”åç¨±ä»¥å€åˆ†
3. é¿å…éæ–¼é€šç”¨çš„è©

ç¾åœ¨è«‹åˆ†æä»¥ä¸‹åŠ‡æœ¬ï¼š`;
}

async function callAIForScriptAnalysis(preset, systemPrompt, scriptContent) {
  const messages = [
    { role: 'user', content: systemPrompt + '\n\n---\n\n' + scriptContent }
  ];
  
  const config = {
    model: preset.model,
    messages,
    max_tokens: 16000,
    temperature: 0.3
  };
  
  let response;
  
  if (preset.type === 'anthropic') {
    response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': preset.apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: preset.model,
        max_tokens: 16000,
        temperature: 0.3,
        messages
      })
    });
    
    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.error?.message || 'API è«‹æ±‚å¤±æ•—');
    }
    
    const data = await response.json();
    return data.content[0].text;
    
  } else if (preset.type === 'openai') {
    response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${preset.apiKey}`
      },
      body: JSON.stringify({
        model: preset.model,
        messages,
        max_tokens: 16000,
        temperature: 0.3
      })
    });
    
    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.error?.message || 'API è«‹æ±‚å¤±æ•—');
    }
    
    const data = await response.json();
    return data.choices[0].message.content;
    
  } else if (preset.type === 'custom') {
    const url = preset.baseUrl.replace(/\/$/, '') + '/chat/completions';
    response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${preset.apiKey}`
      },
      body: JSON.stringify({
        model: preset.model,
        messages,
        max_tokens: 16000,
        temperature: 0.3
      })
    });
    
    if (!response.ok) {
      const err = await response.json().catch(() => ({}));
      throw new Error(err.error?.message || 'API è«‹æ±‚å¤±æ•—');
    }
    
    const data = await response.json();
    return data.choices[0].message.content;
  }
  
  throw new Error('ä¸æ”¯æŒçš„ API é¡å‹');
}

function parseScriptAnalysisResult(responseText) {
  // æå– JSON
  const jsonMatch = responseText.match(/```json\n?([\s\S]*?)\n?```/) || 
                    responseText.match(/\{[\s\S]*\}/);
  
  if (!jsonMatch) {
    throw new Error('AI è¿”å›æ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•è§£æ JSON');
  }
  
  const jsonStr = jsonMatch[1] || jsonMatch[0];
  const result = JSON.parse(jsonStr);
  
  // è®¡ç®— token æ•°
  if (result.instruction) {
    result.instruction.tokens = estimateTokens(result.instruction.content);
  }
  
  if (result.lorebookEntries) {
    result.lorebookEntries.forEach((entry, i) => {
      entry.id = 'le_' + Date.now() + '_' + i;
      entry.tokens = estimateTokens(entry.content);
      entry.selected = true;
    });
  }
  
  if (result.worldInfoEntries) {
    result.worldInfoEntries.forEach((entry, i) => {
      entry.id = 'wi_' + Date.now() + '_' + i;
      entry.tokens = estimateTokens(entry.content);
      entry.selected = true;
    });
  }
  
  if (result.characters) {
    result.characters.forEach((char, i) => {
      char.id = 'ch_' + Date.now() + '_' + i;
      char.tokens = estimateTokens((char.description || '') + (char.personality || ''));
      char.selected = true;
    });
  }
  
  return result;
}

function renderScriptPreview() {
  const result = scriptImportState.result;
  if (!result) return;
  
  // æ¸²æŸ“æŒ‡ä»¤
  const instructionPreview = document.getElementById('instruction-preview');
  const instructionTokens = document.getElementById('instruction-tokens');
  if (result.instruction) {
    instructionPreview.textContent = result.instruction.content;
    instructionTokens.textContent = result.instruction.tokens.toLocaleString() + ' tk';
  }
  
  // æ¸²æŸ“ Lorebook
  renderLorebookPreview();
  
  // æ¸²æŸ“ä¸–ç•Œè§‚
  renderWorldInfoPreview();
  
  // æ¸²æŸ“è§’è‰²
  renderCharactersPreview();
  
  // æ˜¾ç¤ºç¬¬ä¸€ä¸ªæ ‡ç­¾é¡µ
  switchPreviewTab('instruction');
}

function renderLorebookPreview() {
  const result = scriptImportState.result;
  const container = document.getElementById('lorebook-categories');
  const tokensEl = document.getElementById('lorebook-tokens');
  
  if (!result.lorebookEntries || result.lorebookEntries.length === 0) {
    container.innerHTML = '<div style="text-align:center;color:var(--text-tertiary);padding:20px">æ²’æœ‰è­˜åˆ¥åˆ° Lorebook æ¢ç›®</div>';
    tokensEl.textContent = '0 tk';
    return;
  }
  
  // æŒ‰åˆ†ç±»åˆ†ç»„
  const categories = {};
  let totalTokens = 0;
  
  result.lorebookEntries.forEach(entry => {
    const cat = entry.category || 'å…¶ä»–';
    if (!categories[cat]) categories[cat] = [];
    categories[cat].push(entry);
    if (entry.selected) totalTokens += entry.tokens;
  });
  
  tokensEl.textContent = totalTokens.toLocaleString() + ' tk';
  
  // æ¸²æŸ“
  let html = '';
  for (const [catName, entries] of Object.entries(categories)) {
    const icon = result.detectedCategories?.find(c => c.name === catName)?.icon || 'ğŸ“';
    html += `
      <div class="script-category-group">
        <div class="script-category-header" onclick="toggleScriptCategory(this)">
          <span>${icon} ${catName}</span>
          <span class="count">${entries.length} å€‹æ¢ç›® â–¼</span>
        </div>
        <div class="script-category-items">
    `;
    
    entries.forEach(entry => {
      html += `
        <div class="script-entry-item" data-id="${entry.id}">
          <input type="checkbox" ${entry.selected ? 'checked' : ''} onchange="toggleScriptEntry('${entry.id}')">
          <div class="script-entry-info">
            <div class="script-entry-name">${esc(entry.name)}</div>
            <div class="script-entry-keys">è§¸ç™¼è©ï¼š${esc(entry.keys?.join(', ') || '')}</div>
            <div class="script-entry-tokens">${entry.tokens} tokens</div>
          </div>
          <div class="script-entry-actions">
            <button onclick="previewScriptEntry('${entry.id}')">é è¦½</button>
            <button onclick="editScriptEntry('${entry.id}')">ç·¨è¼¯</button>
            <button onclick="deleteScriptEntry('${entry.id}')">åˆªé™¤</button>
          </div>
        </div>
      `;
    });
    
    html += '</div></div>';
  }
  
  container.innerHTML = html;
}

function renderWorldInfoPreview() {
  const result = scriptImportState.result;
  const container = document.getElementById('worldinfo-list');
  const tokensEl = document.getElementById('worldinfo-tokens');
  
  if (!result.worldInfoEntries || result.worldInfoEntries.length === 0) {
    container.innerHTML = '<div style="text-align:center;color:var(--text-tertiary);padding:20px">æ²’æœ‰è­˜åˆ¥åˆ°ä¸–ç•Œè§€è³‡æ–™</div>';
    tokensEl.textContent = '0 tk';
    return;
  }
  
  let totalTokens = 0;
  let html = '';
  
  result.worldInfoEntries.forEach(entry => {
    if (entry.selected) totalTokens += entry.tokens;
    html += `
      <div class="script-entry-item" data-id="${entry.id}">
        <input type="checkbox" ${entry.selected ? 'checked' : ''} onchange="toggleWorldInfoEntry('${entry.id}')">
        <div class="script-entry-info">
          <div class="script-entry-name">ğŸŒ ${esc(entry.title)}</div>
          <div class="script-entry-keys">${esc(entry.category || '')}</div>
          <div class="script-entry-tokens">${entry.tokens} tokens</div>
        </div>
        <div class="script-entry-actions">
          <button onclick="previewWorldInfoEntry('${entry.id}')">é è¦½</button>
          <button onclick="editWorldInfoEntry('${entry.id}')">ç·¨è¼¯</button>
        </div>
      </div>
    `;
  });
  
  tokensEl.textContent = totalTokens.toLocaleString() + ' tk';
  container.innerHTML = html;
}

function renderCharactersPreview() {
  const result = scriptImportState.result;
  const container = document.getElementById('characters-list');
  const tokensEl = document.getElementById('characters-tokens');
  
  if (!result.characters || result.characters.length === 0) {
    container.innerHTML = '<div style="text-align:center;color:var(--text-tertiary);padding:20px">æ²’æœ‰è­˜åˆ¥åˆ°è§’è‰²</div>';
    tokensEl.textContent = '0 tk';
    return;
  }
  
  let totalTokens = 0;
  let html = '';
  
  const categoryLabels = {
    protagonist: 'ä¸»è§’',
    supporting: 'é…è§’',
    npc: 'NPC'
  };
  
  result.characters.forEach(char => {
    if (char.selected) totalTokens += char.tokens;
    html += `
      <div class="script-char-item" data-id="${char.id}">
        <input type="checkbox" ${char.selected ? 'checked' : ''} onchange="toggleCharacterEntry('${char.id}')" style="margin-right:8px">
        <div class="script-char-avatar">${char.name?.charAt(0) || '?'}</div>
        <div class="script-char-info">
          <div class="script-char-name">${esc(char.name)}</div>
          <div class="script-char-title">${esc(char.title || '')}</div>
        </div>
        <span class="script-char-category ${char.category}">${categoryLabels[char.category] || char.category}</span>
        <div class="script-entry-actions">
          <button onclick="previewCharacterEntry('${char.id}')">é è¦½</button>
          <button onclick="editCharacterEntry('${char.id}')">ç·¨è¼¯</button>
        </div>
      </div>
    `;
  });
  
  tokensEl.textContent = totalTokens.toLocaleString() + ' tk';
  container.innerHTML = html;
}

function switchPreviewTab(tab) {
  document.querySelectorAll('.script-preview-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.script-preview-content').forEach(c => c.classList.remove('active'));
  
  event?.target?.classList.add('active') || document.querySelector(`.script-preview-tab[onclick*="${tab}"]`)?.classList.add('active');
  document.getElementById(`preview-${tab}`).classList.add('active');
}

function toggleScriptCategory(header) {
  const items = header.nextElementSibling;
  const isHidden = items.style.display === 'none';
  items.style.display = isHidden ? 'block' : 'none';
  header.querySelector('.count').textContent = header.querySelector('.count').textContent.replace(/[â–¼â–²]/, isHidden ? 'â–¼' : 'â–²');
}

function toggleScriptEntry(id) {
  const entry = scriptImportState.result.lorebookEntries.find(e => e.id === id);
  if (entry) {
    entry.selected = !entry.selected;
    renderLorebookPreview();
  }
}

function toggleWorldInfoEntry(id) {
  const entry = scriptImportState.result.worldInfoEntries.find(e => e.id === id);
  if (entry) {
    entry.selected = !entry.selected;
    renderWorldInfoPreview();
  }
}

function toggleCharacterEntry(id) {
  const entry = scriptImportState.result.characters.find(e => e.id === id);
  if (entry) {
    entry.selected = !entry.selected;
    renderCharactersPreview();
  }
}

let currentEditingEntry = null;

function editScriptEntry(id) {
  const entry = scriptImportState.result.lorebookEntries.find(e => e.id === id);
  if (!entry) return;
  
  currentEditingEntry = { type: 'lorebook', id };
  
  document.getElementById('script-entry-name').value = entry.name || '';
  document.getElementById('script-entry-category').value = entry.category || '';
  document.getElementById('script-entry-keys').value = entry.keys?.join(', ') || '';
  document.getElementById('script-entry-content').value = entry.content || '';
  document.getElementById('script-entry-tokens').textContent = entry.tokens + ' tk';
  document.getElementById('script-entry-reasoning').textContent = entry.reasoning || '';
  
  showModal('script-entry-edit-modal');
}

function saveScriptEntry() {
  if (!currentEditingEntry) return;
  
  const name = document.getElementById('script-entry-name').value.trim();
  const category = document.getElementById('script-entry-category').value.trim();
  const keys = document.getElementById('script-entry-keys').value.split(',').map(k => k.trim()).filter(k => k);
  const content = document.getElementById('script-entry-content').value;
  
  if (currentEditingEntry.type === 'lorebook') {
    const entry = scriptImportState.result.lorebookEntries.find(e => e.id === currentEditingEntry.id);
    if (entry) {
      entry.name = name;
      entry.category = category;
      entry.keys = keys;
      entry.content = content;
      entry.tokens = estimateTokens(content);
    }
    renderLorebookPreview();
  } else if (currentEditingEntry.type === 'worldInfo') {
    const entry = scriptImportState.result.worldInfoEntries.find(e => e.id === currentEditingEntry.id);
    if (entry) {
      entry.title = name;
      entry.category = category;
      entry.content = content;
      entry.tokens = estimateTokens(content);
    }
    renderWorldInfoPreview();
  } else if (currentEditingEntry.type === 'character') {
    const char = scriptImportState.result.characters.find(e => e.id === currentEditingEntry.id);
    if (char) {
      char.name = name;
      char.category = category;
      char.title = document.getElementById('script-entry-keys').value.trim();
      char.description = content;
      char.tokens = estimateTokens(content);
    }
    renderCharactersPreview();
  } else if (currentEditingEntry.type === 'instruction') {
    if (scriptImportState.result.instruction) {
      scriptImportState.result.instruction.content = content;
      scriptImportState.result.instruction.tokens = estimateTokens(content);
    }
    renderInstructionPreview();
  }
  
  closeModal('script-entry-edit-modal');
  currentEditingEntry = null;
}

function deleteScriptEntry(id) {
  showConfirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æ¢ç›®å—ï¼Ÿ', () => {
    const idx = scriptImportState.result.lorebookEntries.findIndex(e => e.id === id);
    if (idx > -1) {
      scriptImportState.result.lorebookEntries.splice(idx, 1);
      renderLorebookPreview();
    }
  });
}

function previewScriptEntry(id) {
  const entry = scriptImportState.result.lorebookEntries.find(e => e.id === id);
  if (!entry) return;
  
  showAlert(`ğŸ“š ${entry.name}\n\nè§¸ç™¼è©ï¼š${entry.keys?.join(', ') || ''}\n\n${entry.content}`, entry.name);
}

function previewWorldInfoEntry(id) {
  const entry = scriptImportState.result.worldInfoEntries.find(e => e.id === id);
  if (!entry) return;
  
  showAlert(`ğŸŒ ${entry.title}\n\n${entry.content}`, entry.title);
}

function previewCharacterEntry(id) {
  const char = scriptImportState.result.characters.find(e => e.id === id);
  if (!char) return;
  
  showAlert(`ğŸ‘¤ ${char.name}\n\né ­éŠœï¼š${char.title || 'ç„¡'}\n\næè¿°ï¼š${char.description || ''}\n\næ€§æ ¼ï¼š${char.personality || ''}`, char.name);
}

// ç·¨è¼¯ä¸–ç•Œè§€æ¢ç›®
function editWorldInfoEntry(id) {
  const entry = scriptImportState.result.worldInfoEntries.find(e => e.id === id);
  if (!entry) return;
  
  currentEditingEntry = { type: 'worldInfo', id: id };
  
  const nameEl = document.getElementById('script-entry-name');
  const categoryEl = document.getElementById('script-entry-category');
  const keysEl = document.getElementById('script-entry-keys');
  const contentEl = document.getElementById('script-entry-content');
  const tokensEl = document.getElementById('script-entry-tokens');
  const reasoningEl = document.getElementById('script-entry-reasoning');
  
  if(nameEl) nameEl.value = entry.title || '';
  if(categoryEl) categoryEl.value = entry.category || '';
  if(keysEl) keysEl.value = '';
  if(contentEl) contentEl.value = entry.content || '';
  if(tokensEl) tokensEl.textContent = (entry.tokens || 0) + ' tk';
  if(reasoningEl) reasoningEl.textContent = entry.reasoning || '';
  
  // é¡¯ç¤ºæ‰€æœ‰å­—æ®µ
  if(nameEl?.parentElement) nameEl.parentElement.style.display = '';
  if(categoryEl?.parentElement) categoryEl.parentElement.style.display = '';
  if(keysEl?.parentElement) keysEl.parentElement.style.display = 'none';
  
  showModal('script-entry-edit-modal');
}

// ç·¨è¼¯è§’è‰²æ¢ç›®
function editCharacterEntry(id) {
  const char = scriptImportState.result.characters.find(e => e.id === id);
  if (!char) return;
  
  currentEditingEntry = { type: 'character', id: id };
  
  const nameEl = document.getElementById('script-entry-name');
  const categoryEl = document.getElementById('script-entry-category');
  const keysEl = document.getElementById('script-entry-keys');
  const contentEl = document.getElementById('script-entry-content');
  const tokensEl = document.getElementById('script-entry-tokens');
  const reasoningEl = document.getElementById('script-entry-reasoning');
  
  if(nameEl) nameEl.value = char.name || '';
  if(categoryEl) categoryEl.value = char.category || 'supporting';
  if(keysEl) keysEl.value = char.title || '';
  if(contentEl) contentEl.value = char.description || '';
  if(tokensEl) tokensEl.textContent = (char.tokens || 0) + ' tk';
  if(reasoningEl) reasoningEl.textContent = char.reasoning || '';
  
  // é¡¯ç¤ºæ‰€æœ‰å­—æ®µï¼ŒkeysElç”¨æ–¼é ­éŠœ
  if(nameEl?.parentElement) nameEl.parentElement.style.display = '';
  if(categoryEl?.parentElement) categoryEl.parentElement.style.display = '';
  if(keysEl?.parentElement){
    keysEl.parentElement.style.display = '';
    keysEl.previousElementSibling.textContent = 'é ­éŠœ';
  }
  
  showModal('script-entry-edit-modal');
}

function editScriptInstruction() {
  const instruction = scriptImportState.result.instruction;
  if (!instruction) return;
  
  currentEditingEntry = { type: 'instruction' };
  
  document.getElementById('script-entry-name').value = 'æ ¸å¿ƒè¦å‰‡';
  document.getElementById('script-entry-category').value = 'æŒ‡ä»¤';
  document.getElementById('script-entry-keys').value = '';
  document.getElementById('script-entry-content').value = instruction.content || '';
  document.getElementById('script-entry-tokens').textContent = instruction.tokens + ' tk';
  document.getElementById('script-entry-reasoning').textContent = instruction.reasoning || '';
  
  // éšè—ä¸éœ€è¦çš„å­—æ®µ
  document.getElementById('script-entry-name').parentElement.style.display = 'none';
  document.getElementById('script-entry-category').parentElement.style.display = 'none';
  document.getElementById('script-entry-keys').parentElement.style.display = 'none';
  
  showModal('script-entry-edit-modal');
}

async function importScriptResult() {
  const result = scriptImportState.result;
  const story = currentStory;
  
  if (!story) {
    toast(T('è«‹å…ˆé¸æ“‡ä¸€å€‹æ•…äº‹'), 'error');
    return;
  }
  
  try {
    let instructionCount = 0;
    let lorebookCount = 0;
    let worldInfoCount = 0;
    let characterCount = 0;
    
    // 1. å¯¼å…¥æŒ‡ä»¤
    if (result.instruction && result.instruction.content) {
      const existingPrompts = await db.prompts.where('storyId').equals(story.id).toArray();
      const newPrompt = {
        storyId: story.id,
        name: 'ğŸ“œ åŠ‡æœ¬æ ¸å¿ƒè¦å‰‡',
        content: result.instruction.content,
        isActive: true,
        order: existingPrompts.length,
        createdAt: Date.now()
      };
      await db.prompts.add(newPrompt);
      instructionCount = 1;
    }
    
    // 2. å¯¼å…¥ Lorebook
    const selectedLorebook = result.lorebookEntries?.filter(e => e.selected) || [];
    for (const entry of selectedLorebook) {
      await db.lorebook.add({
        storyId: story.id,
        name: entry.name,
        content: entry.content,
        keys: entry.keys || [],
        enabled: true,
        priority: 50,
        createdAt: Date.now()
      });
      lorebookCount++;
    }
    
    // 3. å¯¼å…¥ä¸–ç•Œè§‚
    const selectedWorldInfo = result.worldInfoEntries?.filter(e => e.selected) || [];
    for (const entry of selectedWorldInfo) {
      await db.worldInfo.add({
        storyId: story.id,
        title: entry.title,
        content: entry.content,
        selected: true,
        createdAt: Date.now()
      });
      worldInfoCount++;
    }
    
    // 4. å¯¼å…¥è§’è‰²
    const selectedCharacters = result.characters?.filter(e => e.selected) || [];
    for (const char of selectedCharacters) {
      await db.characters.add({
        storyId: story.id,
        name: char.name,
        title: char.title || '',
        avatar: char.name?.charAt(0) || 'ğŸ‘¤',
        description: char.description || '',
        personality: char.personality || '',
        stats: [],
        createdAt: Date.now()
      });
      characterCount++;
    }
    
    // è®¡ç®—ä¼˜åŒ–æ•ˆæœ
    const originalTokens = scriptImportState.rawTokens;
    const lorebookTokens = selectedLorebook.reduce((sum, e) => sum + e.tokens, 0);
    const worldInfoTokens = selectedWorldInfo.reduce((sum, e) => sum + e.tokens, 0);
    const characterTokens = selectedCharacters.reduce((sum, e) => sum + e.tokens, 0);
    const instructionTokens = result.instruction?.tokens || 0;
    
    // å‡è®¾å¹³å‡è§¦å‘ç‡ 20%
    const avgTokensPerRequest = instructionTokens + (lorebookTokens * 0.2) + (characterTokens * 0.3);
    const savingsPercent = Math.round((1 - avgTokensPerRequest / originalTokens) * 100);
    
    // æ¸²æŸ“å®Œæˆé¡µé¢
    document.getElementById('script-complete-stats').innerHTML = `
      <div class="script-complete-stat"><span>ğŸ“‹ æŒ‡ä»¤</span><span>${instructionCount} å€‹ï¼ˆ${instructionTokens.toLocaleString()} tokensï¼‰</span></div>
      <div class="script-complete-stat"><span>ğŸ“š Lorebook</span><span>${lorebookCount} å€‹æ¢ç›®ï¼ˆ${lorebookTokens.toLocaleString()} tokensï¼‰</span></div>
      <div class="script-complete-stat"><span>ğŸŒ ä¸–ç•Œè§€</span><span>${worldInfoCount} å€‹è³‡æ–™ï¼ˆ${worldInfoTokens.toLocaleString()} tokensï¼‰</span></div>
      <div class="script-complete-stat"><span>ğŸ‘¥ è§’è‰²</span><span>${characterCount} å€‹ï¼ˆ${characterTokens.toLocaleString()} tokensï¼‰</span></div>
    `;
    
    document.getElementById('script-optimization').innerHTML = `
      <div>
        <div style="font-size:24px;font-weight:bold">${originalTokens.toLocaleString()}</div>
        <div style="font-size:11px;color:var(--text-tertiary)">åŸå§‹</div>
      </div>
      <div class="script-optimization-arrow">â†’</div>
      <div>
        <div style="font-size:24px;font-weight:bold">~${Math.round(avgTokensPerRequest).toLocaleString()}</div>
        <div style="font-size:11px;color:var(--text-tertiary)">å¹³å‡/æ¬¡</div>
      </div>
      <div class="script-optimization-arrow">â‰ˆ</div>
      <div class="script-optimization-savings">
        <div style="font-size:24px;font-weight:bold">~${savingsPercent}%</div>
        <div style="font-size:11px">ç¯€çœ ğŸ‰</div>
      </div>
    `;
    
    scriptImportState.step = 4;
    updateScriptImportUI();
    
    toast(T('åŠ‡æœ¬å°å…¥æˆåŠŸï¼'), 'success');
    
  } catch (e) {
    toast('å°å…¥å¤±æ•—: ' + e.message, 'error');
  }
}

function addScriptLorebookEntry() {
  const newEntry = {
    id: 'le_' + Date.now(),
    name: 'æ–°æ¢ç›®',
    content: '',
    keys: [],
    category: 'è‡ªå®šç¾©',
    tokens: 0,
    selected: true,
    reasoning: ''
  };
  
  scriptImportState.result.lorebookEntries.push(newEntry);
  renderLorebookPreview();
  editScriptEntry(newEntry.id);
}

function mergeSelectedEntries() {
  const selected = scriptImportState.result.lorebookEntries.filter(e => e.selected);
  if (selected.length < 2) {
    toast(T('è«‹è‡³å°‘é¸æ“‡ 2 å€‹æ¢ç›®é€²è¡Œåˆä½µ'), 'warning');
    return;
  }
  
  showConfirm(`ç¢ºå®šè¦åˆä½µé¸ä¸­çš„ ${selected.length} å€‹æ¢ç›®å—ï¼Ÿ`, () => {
    const mergedContent = selected.map(e => `## ${e.name}\n${e.content}`).join('\n\n');
    const mergedKeys = [...new Set(selected.flatMap(e => e.keys || []))];
    
    const mergedEntry = {
      id: 'le_' + Date.now(),
      name: selected.map(e => e.name).join(' + '),
      content: mergedContent,
      keys: mergedKeys,
      category: selected[0].category,
      tokens: estimateTokens(mergedContent),
      selected: true,
      reasoning: 'åˆä½µè‡ªå¤šå€‹æ¢ç›®'
    };
    
    // åˆ é™¤åŸæ¡ç›®
    selected.forEach(e => {
      const idx = scriptImportState.result.lorebookEntries.findIndex(x => x.id === e.id);
      if (idx > -1) scriptImportState.result.lorebookEntries.splice(idx, 1);
    });
    
    // æ·»åŠ åˆå¹¶åçš„æ¡ç›®
    scriptImportState.result.lorebookEntries.push(mergedEntry);
    renderLorebookPreview();
    
    toast('å·²åˆä½µ ' + selected.length + ' å€‹æ¢ç›®', 'success');
  });
}

// æ·»åŠ å†…å®¹è¾“å…¥ç›‘å¬
document.getElementById('script-entry-content')?.addEventListener('input', function() {
  const tokens = estimateTokens(this.value);
  document.getElementById('script-entry-tokens').textContent = tokens + ' tk';
});
</script>
</body>
</html>
