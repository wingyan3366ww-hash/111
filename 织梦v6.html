<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#8B7CF7">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ÁπîÂ§¢">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="description" content="AI‰∫íÂãïÂ∞èË™™Èñ±ËÆÄÂô® - ÂâµÂª∫‰Ω†ÁöÑÂ∞àÂ±¨ÊïÖ‰∫ã">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%238B7CF7' width='100' height='100' rx='20'/><text x='50' y='65' text-anchor='middle' fill='white' font-size='50'>Áπî</text></svg>">
  <title>ÁπîÂ§¢ - AI‰∫íÂãïÂ∞èË™™Èñ±ËÆÄÂô® v6.1</title>
  <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.min.js"></script>
  <style>
:root{--primary:#8B7CF7;--primary-light:#A89CFF;--primary-dark:#6B5CE7;--bg-primary:#0F0F1A;--bg-secondary:#1A1A2E;--bg-tertiary:#252540;--bg-card:#1E1E32;--text-primary:#E5E7EB;--text-secondary:#9CA3AF;--text-tertiary:#6B7280;--divider:#2D2D44;--success:#10B981;--warning:#F59E0B;--error:#EF4444;--info:#3B82F6;--font-size:16px;--line-height:1.6;--paragraph-spacing:1em}
[data-theme="light"]{--primary:#6B5CE7;--primary-light:#8B7CF7;--bg-primary:#FFFFFF;--bg-secondary:#F5F5F7;--bg-tertiary:#E8E8ED;--bg-card:#FFFFFF;--text-primary:#1A1A2E;--text-secondary:#6B7280;--text-tertiary:#9CA3AF;--divider:#E5E7EB}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,BlinkMacSystemFont,"PingFang SC",sans-serif;font-size:16px;background:#000;color:var(--text-primary);height:100vh;height:100dvh;overflow:hidden;user-select:none}
.app{width:100%;max-width:420px;height:100vh;height:100dvh;margin:0 auto;display:flex;flex-direction:column;background:var(--bg-primary);position:relative;box-shadow:0 0 50px rgba(139,124,247,0.2);overflow:hidden}
@media(min-width:421px) and (min-height:901px){.app{max-height:900px;margin-top:calc((100vh - 900px)/2);border-radius:40px}}
.app.fullscreen{max-width:100%;max-height:100%;border-radius:0;margin:0}
.status-bar{height:44px;background:var(--bg-secondary);display:flex;justify-content:space-between;align-items:center;padding:0 20px;font-size:14px;font-weight:500;flex-shrink:0}
.views{flex:1;position:relative;overflow:hidden}
.view{position:absolute;inset:0;display:flex;flex-direction:column;overflow:hidden;opacity:0;transform:translateX(100%);transition:all .3s ease;pointer-events:none;background:var(--bg-primary)}
.view.active{opacity:1;transform:translateX(0);pointer-events:auto;z-index:1}
.view.out{transform:translateX(-30%);opacity:.5;z-index:0}
.nav{height:52px;background:var(--bg-secondary);display:flex;justify-content:space-between;align-items:center;padding:0 16px;border-bottom:1px solid var(--divider);flex-shrink:0}
.nav-back{color:var(--primary);font-size:24px;cursor:pointer;padding:8px;margin:-8px}
.nav-title{font-size:17px;font-weight:600;flex:1;text-align:center}
.nav-right{display:flex;gap:4px}
.nav-btn{width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;color:var(--text-secondary);border-radius:8px;transition:all .2s}
.nav-btn:hover{color:var(--primary);background:rgba(139,124,247,.1)}
.list-nav{height:52px;background:var(--bg-secondary);display:flex;justify-content:space-between;align-items:center;padding:0 16px;border-bottom:1px solid var(--divider);flex-shrink:0}
.list-nav-title{font-size:22px;font-weight:700;background:linear-gradient(135deg,var(--primary),var(--primary-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.search-bar{padding:12px 16px;background:var(--bg-secondary);flex-shrink:0}
.search-wrap{background:var(--bg-tertiary);border-radius:10px;padding:10px 14px;display:flex;align-items:center;gap:10px}
.search-wrap:focus-within{box-shadow:0 0 0 2px var(--primary)}
.search-input{flex:1;border:none;background:transparent;font-size:15px;outline:none;color:var(--text-primary);-webkit-text-fill-color:var(--text-primary)}
.search-input::placeholder{color:var(--text-tertiary)}
.search-input:-webkit-autofill,.search-input:-webkit-autofill:hover,.search-input:-webkit-autofill:focus{-webkit-text-fill-color:var(--text-primary)!important;-webkit-box-shadow:0 0 0 1000px var(--bg-tertiary) inset!important;transition:background-color 5000s ease-in-out 0s}
.progress-wrap{padding:0 16px 8px;background:var(--bg-secondary);display:flex;align-items:center;gap:8px;flex-shrink:0}
.progress-bar{flex:1;height:4px;background:var(--bg-tertiary);border-radius:2px;overflow:hidden;cursor:pointer}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--primary-dark),var(--primary));border-radius:2px;transition:width .3s}
.progress-text{font-size:11px;color:var(--text-tertiary);min-width:32px}
.scroll{flex:1;overflow-y:auto;padding:12px 16px}
.scroll::-webkit-scrollbar{display:none}
.card{display:flex;padding:14px;background:var(--bg-card);border-radius:12px;margin-bottom:12px;cursor:pointer;transition:all .2s;position:relative;border:1px solid transparent}
.card-menu-btn{position:absolute;top:8px;right:8px;width:28px;height:28px;border-radius:50%;background:var(--bg-tertiary);display:flex;align-items:center;justify-content:center;font-size:16px;color:var(--text-secondary);opacity:0.7;transition:all .2s;z-index:2}
.card-menu-btn:hover{opacity:1;background:var(--primary);color:white}
.card:hover{transform:translateY(-2px);box-shadow:0 4px 20px rgba(139,124,247,.15)}
.card:active{transform:scale(.98)}
.card.pinned::before{content:'üìå';position:absolute;top:-6px;left:-6px;font-size:16px}
.card.selected{border-color:var(--primary)}
.card-cover{width:56px;height:70px;border-radius:8px;margin-right:12px;flex-shrink:0;background:linear-gradient(135deg,var(--primary-dark),var(--primary));display:flex;align-items:center;justify-content:center;font-size:24px;background-size:cover;background-position:center;overflow:hidden;position:relative}
.card-cover img{width:100%;height:100%;object-fit:cover}
.card-cover .cover-emoji{font-size:24px}
.upload-btn{position:absolute;bottom:4px;right:4px;width:20px;height:20px;background:rgba(0,0,0,0.6);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;cursor:pointer;opacity:0;transition:opacity 0.2s}
.card-cover:hover .upload-btn,.char-avatar:hover .upload-btn{opacity:1}
.content.has-bg{background-size:cover;background-position:center;background-attachment:fixed}
.content.has-bg::before{content:'';position:absolute;inset:0;background:rgba(15,15,26,0.85);z-index:0}
.content.has-bg .msg{position:relative;z-index:1}
.card-info{flex:1;min-width:0}
.card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px}
.card-title{font-size:15px;font-weight:600}
.card-time{font-size:11px;color:var(--text-tertiary)}
.card-preview{font-size:12px;color:var(--text-secondary);margin-bottom:6px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;line-height:1.4}
.card-meta{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.card-instruction{font-size:10px;color:var(--primary);background:rgba(139,124,247,.15);padding:2px 6px;border-radius:4px}
.card-stats{font-size:10px;color:var(--text-tertiary)}
.card-tags{display:flex;gap:4px;margin-top:4px}
.tag{font-size:9px;padding:2px 5px;border-radius:3px;background:var(--bg-tertiary);color:var(--text-secondary)}
.tab-bar{display:flex;background:var(--bg-secondary);border-top:1px solid var(--divider);padding:6px 0;padding-bottom:calc(6px + env(safe-area-inset-bottom, 0px));flex-shrink:0}
.tab-item{flex:1;display:flex;flex-direction:column;align-items:center;padding:4px 0;cursor:pointer}
.tab-item .tab-icon{font-size:20px;margin-bottom:2px;transition:transform .2s}
.tab-item .tab-label{font-size:10px;color:var(--text-tertiary)}
.tab-item.active .tab-icon{transform:scale(1.1)}
.tab-item.active .tab-label{color:var(--primary)}
.content{flex:1;overflow-y:auto;padding:16px;font-family:"Noto Serif SC",Georgia,serif;font-size:var(--font-size);line-height:var(--line-height);word-break:break-word;overflow-wrap:break-word}
.content::-webkit-scrollbar{display:none}
.content.sys{font-family:-apple-system,sans-serif;font-size:15px;line-height:1.5}
.content p{margin-bottom:16px;word-break:break-word;overflow-wrap:break-word}
.content strong{color:var(--primary-light)}
.content blockquote{border-left:3px solid var(--primary);padding-left:12px;margin:12px 0;color:var(--text-secondary);word-break:break-word;overflow-wrap:break-word}
.content pre{white-space:pre-wrap;word-break:break-word;overflow-wrap:break-word;background:var(--bg-tertiary);padding:12px;border-radius:8px;overflow-x:auto;max-width:100%}
.content code{word-break:break-all}
/* Â∞èË™™Èñ±ËÆÄÂºè UI */
.msg{margin-bottom:24px;word-break:break-word;overflow-wrap:break-word;max-width:100%}
.msg.user{margin:24px 0}
.msg-user-action{text-align:center;padding:16px 0}
.msg-user-action .action-divider{color:var(--primary);font-size:13px;margin-bottom:8px;display:flex;align-items:center;justify-content:center;gap:12px}
.msg-user-action .action-divider::before,.msg-user-action .action-divider::after{content:'';flex:1;max-width:60px;height:1px;background:linear-gradient(90deg,transparent,var(--primary),transparent)}
.msg-user-action .action-content{color:var(--primary-light);font-style:italic;font-size:calc(var(--font-size) * 0.95)}
.msg-ai-story{padding:0 4px}
.msg-ai-story p{text-indent:2em;margin-bottom:var(--paragraph-spacing)}
.msg-ai-story p:first-child{text-indent:0}
/* ÊîπÂñÑÈÅ∏È†ÖÂàóË°®È°ØÁ§∫ */
.msg-ai-story br{display:block;content:'';margin-top:calc(var(--paragraph-spacing) * 0.5)}
.msg-ai-story ol,.msg-ai-story ul{margin:1em 0;padding-left:2em;text-indent:0}
.msg-ai-story li{margin-bottom:0.5em;text-indent:0}
/* Á¢∫‰øùÂúàËôüÈÅ∏È†ÖÊ≠£Á¢∫ÊèõË°å - ‰ΩøÁî®Êõ¥Á≤æÁ¢∫ÁöÑÈÅ∏ÊìáÂô® */
.msg-ai-story{white-space:pre-line}
.msg-timestamp{text-align:center;font-size:11px;color:var(--text-tertiary);margin-top:12px}
.msg-floor{position:absolute;right:8px;top:8px;font-size:10px;color:var(--text-tertiary);font-family:sans-serif;opacity:0.6}
.msg-menu-btn{position:absolute;right:28px;top:6px;width:24px;height:24px;border-radius:6px;background:var(--bg-tertiary);display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--text-secondary);cursor:pointer;opacity:0.4;transition:opacity .2s;z-index:5}
.msg:hover .msg-menu-btn,.msg-menu-btn:focus,.msg-menu-btn:active{opacity:1}
.msg-menu-btn:active{background:var(--primary);color:white}
.msg-action-menu{position:fixed;background:var(--bg-card);border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.3);padding:6px;z-index:1002;min-width:120px}
.msg-action-item{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:8px;font-size:14px;color:var(--text-primary);cursor:pointer;transition:background .2s}
.msg-action-item:hover{background:var(--bg-tertiary)}
.msg-action-item.danger{color:var(--error)}
.msg-action-item .icon{font-size:16px}
.msg{position:relative}
/* ÈáçË¶ÅË®òÊÜ∂Ê®ôË®ò */
.msg-important{background:linear-gradient(90deg,transparent,rgba(255,215,0,0.08),transparent);border-left:2px solid #FFD700;padding-left:12px}
.msg-important-badge{position:absolute;left:8px;top:8px;font-size:14px;animation:starPulse 2s infinite;z-index:3}
@keyframes starPulse{0%,100%{opacity:0.8;transform:scale(1)}50%{opacity:1;transform:scale(1.1)}}
/* Lorebook Ê®£Âºè */
.lore-trigger-toast{position:fixed;top:60px;left:50%;transform:translateX(-50%);background:rgba(139,124,247,0.95);color:white;padding:8px 16px;border-radius:20px;font-size:12px;z-index:1001;animation:slideDown .3s ease;display:flex;align-items:center;gap:6px}
@keyframes slideDown{from{opacity:0;transform:translateX(-50%) translateY(-10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.lorebook-card{background:var(--bg-card);border-radius:12px;padding:14px;margin-bottom:12px;border-left:3px solid var(--primary)}
/* ËÉåÂåÖÁâ©ÂìÅÊ®£Âºè */
.inventory-item{background:var(--bg-card);border-radius:12px;padding:12px;margin-bottom:10px;display:flex;align-items:center;gap:12px;position:relative}
.inventory-item-icon{font-size:28px;width:44px;height:44px;display:flex;align-items:center;justify-content:center;background:var(--bg-tertiary);border-radius:10px;flex-shrink:0}
.inventory-item-info{flex:1;min-width:0}
.inventory-item-name{font-weight:600;font-size:15px;color:var(--text-primary);display:flex;align-items:center;gap:6px}
.inventory-item-name .quantity{font-size:12px;color:var(--primary);font-weight:500}
.inventory-item-category{font-size:11px;color:var(--text-tertiary);margin-top:2px}
.inventory-item-desc{font-size:12px;color:var(--text-secondary);margin-top:4px;line-height:1.4}
.inventory-item-actions{display:flex;gap:6px}
.inventory-item-btn{padding:6px 10px;border-radius:6px;font-size:12px;border:none;cursor:pointer;background:var(--bg-tertiary);color:var(--text-secondary)}
.inventory-item-btn:hover{background:var(--bg-hover)}
.inventory-item-btn.danger{color:var(--error)}
.inventory-item.has-lorebook{border-left:3px solid var(--primary)}
/* ÂúñÊ®ôÈÅ∏ÊìáÂô® */
.icon-option{width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-size:20px;background:var(--bg-tertiary);border-radius:8px;cursor:pointer;transition:all .2s}
.icon-option:hover,.icon-option.selected{background:var(--primary);transform:scale(1.1)}
.lorebook-card.disabled{opacity:0.5;border-left-color:var(--text-tertiary)}
.lorebook-card-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.lorebook-card-status{width:8px;height:8px;border-radius:50%;background:var(--success)}
.lorebook-card.disabled .lorebook-card-status{background:var(--text-tertiary)}
.lorebook-card-title{flex:1;font-size:14px;font-weight:600}
.lorebook-card-lock{font-size:12px}
.lorebook-card-triggers{font-size:12px;color:var(--text-secondary);margin-bottom:6px}
.lorebook-card-stats{font-size:11px;color:var(--text-tertiary);display:flex;gap:12px}
.lorebook-card-actions{display:flex;gap:8px;margin-top:10px}
.lorebook-condition{display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-tertiary);border-radius:6px;margin-bottom:8px;flex-wrap:wrap}
.lorebook-condition select,.lorebook-condition input{padding:6px 8px;border:1px solid var(--divider);border-radius:4px;background:var(--bg-card);color:var(--text-primary);font-size:13px}
.lorebook-condition input[type="number"]{width:60px}
/* Áé©ÂÆ∂Èù¢ÊùøÊ®£Âºè - Â¢ûÂº∑Áâà */
.player-panel{background:var(--bg-card);border-radius:16px;padding:16px;margin-bottom:16px;border:1px solid var(--divider)}
.player-panel-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.player-panel-title{font-size:16px;font-weight:600;display:flex;align-items:center;gap:8px}
.player-panel-edit{font-size:12px;color:var(--primary);cursor:pointer}
/* ÂàÜÁµÑÊ®£Âºè */
.player-group{margin-bottom:16px}
.player-group:last-child{margin-bottom:0}
.player-group-header{display:flex;align-items:center;gap:8px;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--divider)}
.player-group-icon{font-size:16px}
.player-group-title{font-size:13px;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.5px}
.player-group-toggle{margin-left:auto;font-size:12px;color:var(--text-tertiary);cursor:pointer;transition:transform .2s}
.player-group-toggle.collapsed{transform:rotate(-90deg)}
.player-group-content{overflow:hidden;transition:max-height .3s ease}
.player-group-content.collapsed{max-height:0!important}
/* Â±¨ÊÄßÁ∂≤Ê†º */
.player-stat-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.player-stat-grid.grid-3{grid-template-columns:repeat(3,1fr)}
.player-stat-item{background:var(--bg-tertiary);border-radius:12px;padding:12px;position:relative;overflow:hidden;transition:transform .2s,box-shadow .2s}
.player-stat-item:active{transform:scale(0.98)}
.player-stat-item::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;opacity:0.8}
.player-stat-item.color-red::before{background:linear-gradient(90deg,#EF4444,#F87171)}
.player-stat-item.color-orange::before{background:linear-gradient(90deg,#F59E0B,#FBBF24)}
.player-stat-item.color-yellow::before{background:linear-gradient(90deg,#EAB308,#FDE047)}
.player-stat-item.color-green::before{background:linear-gradient(90deg,#10B981,#34D399)}
.player-stat-item.color-blue::before{background:linear-gradient(90deg,#3B82F6,#60A5FA)}
.player-stat-item.color-purple::before{background:linear-gradient(90deg,#8B5CF6,#A78BFA)}
.player-stat-item.color-pink::before{background:linear-gradient(90deg,#EC4899,#F472B6)}
.player-stat-item.color-default::before{background:linear-gradient(90deg,var(--primary),var(--primary-light))}
.player-stat-label{font-size:11px;color:var(--text-tertiary);margin-bottom:4px;display:flex;align-items:center;gap:4px}
.player-stat-value{font-size:18px;font-weight:700;color:var(--text-primary);display:flex;align-items:baseline;gap:4px}
.player-stat-value .unit{font-size:12px;font-weight:400;color:var(--text-tertiary)}
.player-stat-value.positive{color:var(--success)}
.player-stat-value.negative{color:var(--error)}
/* ÈÄ≤Â∫¶Ê¢ùÂãïÁï´ */
.player-stat-bar{height:8px;background:var(--bg-primary);border-radius:4px;margin-top:8px;overflow:hidden;position:relative}
.player-stat-bar-fill{height:100%;border-radius:4px;transition:width .5s ease;position:relative}
.player-stat-bar-fill::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3),transparent);animation:shimmer 2s infinite}
@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.player-stat-bar-fill.health{background:linear-gradient(90deg,#10B981,#34D399)}
.player-stat-bar-fill.energy{background:linear-gradient(90deg,#F59E0B,#FBBF24)}
.player-stat-bar-fill.mood{background:linear-gradient(90deg,#EC4899,#F472B6)}
.player-stat-bar-fill.default{background:linear-gradient(90deg,var(--primary),var(--primary-light))}
/* ÊñáÂ≠óÈ°ûÂûãÊ®ôÁ±§ */
.player-stat-tag{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;background:var(--bg-primary);border-radius:20px;font-size:13px;font-weight:500;color:var(--text-primary)}
/* Â±¨ÊÄßÂç°ÁâáÔºàË®≠ÁΩÆÈ†ÅÔºâ */
.player-attr-card{background:var(--bg-tertiary);border-radius:10px;padding:12px;margin-bottom:8px;display:flex;align-items:center;gap:10px;border-left:3px solid var(--primary)}
.player-attr-icon{font-size:20px;width:32px;text-align:center}
.player-attr-info{flex:1}
.player-attr-name{font-size:13px;font-weight:500}
.player-attr-type{font-size:11px;color:var(--text-tertiary)}
.player-attr-group{font-size:10px;color:var(--primary);margin-top:2px}
/* AIÂêåÊ≠•ÊåâÈàï */
.player-sync-btn{width:100%;padding:12px;background:linear-gradient(135deg,var(--primary),var(--primary-light));color:white;border:none;border-radius:10px;font-size:14px;font-weight:500;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-top:12px;transition:opacity .2s,transform .2s}
.player-sync-btn:active{transform:scale(0.98)}
.player-sync-btn:disabled{opacity:0.6;cursor:not-allowed}
/* ÂàÜÁµÑÈÅ∏ÊìáÂô® */
.group-selector{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.group-chip{padding:6px 12px;background:var(--bg-tertiary);border-radius:16px;font-size:12px;cursor:pointer;transition:all .2s;border:1px solid transparent}
.group-chip:hover{background:var(--bg-primary)}
.group-chip.active{background:var(--primary);color:white;border-color:var(--primary)}
.time-div{display:flex;align-items:center;justify-content:center;margin:20px 0;color:var(--text-tertiary);font-size:13px;cursor:pointer}
.time-div::before,.time-div::after{content:'';flex:1;height:1px;background:var(--divider);margin:0 12px}
.typing{display:flex;align-items:center;gap:4px;padding:12px 0}
.typing-dot{width:8px;height:8px;background:var(--primary);border-radius:50%;animation:typing 1.4s infinite ease-in-out}
.typing-dot:nth-child(1){animation-delay:0s}
.typing-dot:nth-child(2){animation-delay:.2s}
.typing-dot:nth-child(3){animation-delay:.4s}
@keyframes typing{0%,60%,100%{transform:translateY(0);opacity:.4}30%{transform:translateY(-6px);opacity:1}}
@keyframes highlight{0%,100%{background:transparent}50%{background:rgba(139,124,247,0.3)}}
.typing-cursor{display:inline-block;width:2px;height:1em;background:var(--primary);margin-left:2px;animation:blink 1s infinite}
@keyframes blink{0%,50%{opacity:1}51%,100%{opacity:0}}
.quick-cmds{display:flex;gap:8px;padding:10px 16px;background:var(--bg-secondary);overflow-x:auto;border-top:1px solid var(--divider);flex-shrink:0}
.quick-cmds::-webkit-scrollbar{display:none}
.quick-cmd{padding:6px 14px;background:var(--bg-tertiary);border-radius:16px;font-size:13px;color:var(--text-secondary);white-space:nowrap;cursor:pointer;border:none;transition:all .2s}
.quick-cmd:hover{background:var(--primary);color:white}
.quick-cmd.add{background:transparent;border:1px dashed var(--text-tertiary);color:var(--text-tertiary)}
.quick-cmd-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:8px}
.quick-cmd-item .drag-handle{cursor:grab;color:var(--text-tertiary);font-size:14px}
.quick-cmd-item .cmd-info{flex:1;min-width:0}
.quick-cmd-item .cmd-label{font-size:14px;font-weight:500;color:var(--text-primary)}
.quick-cmd-item .cmd-content{font-size:11px;color:var(--text-tertiary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.quick-cmd-item .cmd-actions{display:flex;gap:6px}
.quick-cmd-item .cmd-actions button{padding:4px 8px;font-size:12px;border:none;border-radius:4px;cursor:pointer}
.quick-cmd-item .cmd-actions .edit-btn{background:var(--bg-secondary);color:var(--text-secondary)}
.quick-cmd-item .cmd-actions .del-btn{background:rgba(239,68,68,0.1);color:#ef4444}
.persona-bar{background:var(--bg-secondary);padding:8px 16px;display:flex;align-items:center;gap:8px;border-top:1px solid var(--divider);flex-shrink:0}
.persona-selector{flex:1;display:flex;align-items:center;gap:8px;padding:6px 12px;background:var(--bg-tertiary);border-radius:12px;cursor:pointer;transition:all .2s}
.persona-selector:hover{background:rgba(139,124,247,.1);box-shadow:0 0 0 1px var(--primary)}
.persona-avatar{font-size:18px}
.persona-info{flex:1;min-width:0}
.persona-label{font-size:11px;color:var(--text-tertiary)}
.persona-name{font-size:13px;color:var(--text-primary);font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.persona-dropdown{font-size:12px;color:var(--text-tertiary)}
.input-bar{background:var(--bg-secondary);padding:10px 16px;display:flex;align-items:flex-end;gap:10px;border-top:1px solid var(--divider);flex-shrink:0}
.input-wrap{flex:1;background:var(--bg-tertiary);border-radius:20px;min-height:40px;max-height:120px;display:flex;align-items:center;padding:0 16px}
.input-field{flex:1;border:none;background:transparent;padding:10px 0;font-size:15px;outline:none;color:var(--text-primary)}
.input-field::placeholder{color:var(--text-tertiary)}
.send-btn{width:40px;height:40px;background:var(--primary);border:none;border-radius:50%;color:white;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.send-btn:hover{background:var(--primary-light);transform:scale(1.05)}
.send-btn:disabled{background:var(--bg-tertiary);opacity:.5;cursor:not-allowed}
.lore-section{margin-bottom:16px}
.lore-header{display:flex;justify-content:space-between;align-items:center;padding:10px 0;cursor:pointer}
.lore-header-left{display:flex;align-items:center;gap:8px;font-size:15px;font-weight:600}
.lore-count{font-size:12px;color:var(--text-tertiary);font-weight:normal}
.lore-toggle{color:var(--text-tertiary);transition:transform .3s;font-size:12px}
.lore-toggle.collapsed{transform:rotate(-90deg)}
.lore-list{max-height:1000px;overflow:hidden;transition:all .3s ease}
.lore-list.collapsed{max-height:0;opacity:0}
.lore-item{display:flex;align-items:flex-start;padding:12px;background:var(--bg-card);border-radius:10px;margin-bottom:8px;cursor:pointer;position:relative}
.lore-actions{position:absolute;right:8px;top:50%;transform:translateY(-50%);display:flex;gap:8px;font-size:14px;opacity:0.6}
.lore-actions:hover{opacity:1}
.lore-item:hover{background:var(--bg-tertiary)}
.lore-checkbox{width:20px;height:20px;border:2px solid var(--text-tertiary);border-radius:4px;margin-right:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer}
.lore-checkbox.checked{background:var(--primary);border-color:var(--primary)}
.lore-checkbox.checked::after{content:'‚úì';color:white;font-size:12px}
.lore-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;margin-right:12px;font-size:18px;flex-shrink:0}
.lore-icon.char{background:rgba(59,130,246,.2)}
.lore-icon.loc{background:rgba(16,185,129,.2)}
.lore-icon.item{background:rgba(249,115,22,.2)}
.lore-icon.set{background:rgba(168,85,247,.2)}
.lore-content{flex:1;min-width:0}
.lore-name{font-size:14px;font-weight:600;margin-bottom:2px;display:flex;align-items:center;gap:8px}
.lore-affection{font-size:11px}
.lore-affection.pos{color:var(--success)}
.lore-affection.neg{color:var(--error)}
.lore-desc{font-size:12px;color:var(--text-secondary);margin-bottom:4px}
.lore-status{font-size:11px;color:var(--text-tertiary)}
.timeline-current{background:var(--bg-card);padding:12px 16px;border-radius:10px;margin-bottom:20px;display:flex;align-items:center;gap:8px}
.timeline-label{font-size:13px;color:var(--text-secondary)}
.timeline-value{font-size:15px;font-weight:600;color:var(--primary)}
.timeline-list{position:relative;padding-left:24px}
.timeline-list::before{content:'';position:absolute;left:8px;top:0;bottom:0;width:2px;background:var(--divider)}
.timeline-item{position:relative;margin-bottom:20px;cursor:pointer}
.timeline-item::before{content:'';position:absolute;left:-24px;top:6px;width:12px;height:12px;border-radius:50%;background:var(--bg-tertiary);border:2px solid var(--text-tertiary)}
.timeline-item.current::before{background:var(--primary);border-color:var(--primary);box-shadow:0 0 0 4px rgba(139,124,247,.2)}
.timeline-date{font-size:14px;font-weight:600;margin-bottom:6px}
.timeline-events{font-size:13px;color:var(--text-secondary)}
.timeline-event{display:flex;align-items:center;gap:6px;margin-bottom:4px}
.timeline-event-dot{width:4px;height:4px;background:var(--text-tertiary);border-radius:50%}
.tabs-bar{display:flex;background:var(--bg-secondary);padding:0 16px;flex-shrink:0;border-bottom:1px solid var(--divider)}
.tab-btn{padding:12px 20px;font-size:14px;color:var(--text-secondary);cursor:pointer;border:none;border-bottom:2px solid transparent;background:none}
.tab-btn.active{color:var(--primary);border-bottom-color:var(--primary)}
.section-title{font-size:13px;color:var(--text-tertiary);padding:12px 0;display:flex;align-items:center;gap:8px}
.f-card{background:var(--bg-card);border-radius:10px;padding:14px;margin-bottom:10px;cursor:pointer;transition:transform .2s}
.f-card:hover{transform:translateX(4px)}
.f-card.warning{border-left:3px solid var(--warning)}
.f-card.resolved{opacity:.6}
.f-card-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.f-card-icon{font-size:14px}
.f-card-title{font-size:14px;font-weight:600;flex:1}
.f-card-desc{font-size:13px;color:var(--text-secondary);margin-bottom:8px;word-break:break-word;overflow-wrap:break-word}
.f-card-meta{display:flex;align-items:center;gap:12px;font-size:11px;color:var(--text-tertiary);flex-wrap:wrap}
.save-card{background:var(--bg-card);border-radius:10px;padding:14px;margin-bottom:10px}
.save-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.save-card-title{font-size:14px;font-weight:600;display:flex;align-items:center;gap:8px}
.save-card-tag{font-size:10px;padding:2px 8px;border-radius:4px;background:var(--success);color:white}
.save-card-tag.be{background:var(--error)}
.save-card-tag.key{background:var(--warning)}
.save-card-preview{font-size:12px;color:var(--text-secondary);margin-bottom:8px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.save-card-meta{font-size:11px;color:var(--text-tertiary);display:flex;gap:12px;flex-wrap:wrap}
.save-card-actions{display:flex;gap:8px;margin-top:10px}
.action-btn{flex:1;padding:8px;border:none;border-radius:6px;font-size:12px;cursor:pointer}
.action-btn.primary{background:var(--primary);color:white}
.action-btn.secondary{background:var(--bg-tertiary);color:var(--text-secondary)}
.action-btn.danger{background:var(--error);color:white}
.font-option{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:12px 8px;background:var(--bg-tertiary);border:2px solid var(--divider);border-radius:8px;cursor:pointer;transition:all .2s;color:var(--text-primary)}
.font-option:hover{border-color:var(--primary);background:rgba(139,124,247,.1)}
.font-option.active{border-color:var(--primary);background:rgba(139,124,247,.2)}
.inst-card{background:var(--bg-card);border-radius:12px;padding:16px;margin-bottom:12px}
.inst-header{display:flex;align-items:flex-start;margin-bottom:12px}
.inst-icon{font-size:28px;margin-right:12px}
.inst-info{flex:1}
.inst-name{font-size:15px;font-weight:600;margin-bottom:4px}
.inst-meta{font-size:12px;color:var(--text-secondary)}
.inst-binding{font-size:12px;color:var(--text-tertiary);margin-top:4px}
.inst-preview{font-size:12px;color:var(--text-secondary);padding:8px;background:var(--bg-tertiary);border-radius:6px;margin-bottom:12px;max-height:60px;overflow:hidden}
.inst-actions{display:flex;gap:8px}
.settings-section{margin-bottom:24px}
.settings-section-title{font-size:13px;color:var(--text-tertiary);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.settings-card{background:var(--bg-card);border-radius:12px;overflow:hidden}
.settings-item{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--divider);cursor:pointer}
.settings-item:last-child{border-bottom:none}
.settings-item:hover{background:var(--bg-tertiary)}
.settings-item-label{font-size:15px}
.settings-item-value{font-size:14px;color:var(--text-secondary);display:flex;align-items:center;gap:4px}
.settings-item.danger .settings-item-label{color:var(--error)}
.toggle{width:44px;height:24px;background:var(--bg-tertiary);border-radius:12px;position:relative;cursor:pointer}
.toggle.active{background:var(--primary)}
.toggle::after{content:'';width:20px;height:20px;background:white;border-radius:50%;position:absolute;top:2px;left:2px;transition:left .2s}
.toggle.active::after{left:22px}
.immersive{position:fixed;inset:0;background:#0A0A12;z-index:1000;display:none;flex-direction:column}
.immersive.active{display:flex}
.immersive-content{flex:1;display:flex;align-items:center;justify-content:center;padding:40px 32px;font-family:"Noto Serif SC",serif;font-size:20px;line-height:2;color:#E5E7EB;text-align:justify;overflow-y:auto;word-break:break-word;overflow-wrap:break-word}
.immersive-footer{padding:16px 20px;display:flex;align-items:center;gap:16px;background:rgba(0,0,0,.5)}
.immersive-progress{flex:1;height:4px;background:rgba(255,255,255,.1);border-radius:2px}
.immersive-progress-fill{height:100%;background:var(--primary);border-radius:2px}
.immersive-hint{font-size:12px;color:rgba(255,255,255,.4)}
.immersive-close{width:36px;height:36px;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,.6);cursor:pointer;font-size:20px;border-radius:50%}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;opacity:0;visibility:hidden;transition:all .3s}
.overlay.active{opacity:1;visibility:visible}
.bottom-sheet{position:fixed;bottom:0;left:50%;transform:translateX(-50%) translateY(100%);width:100%;max-width:420px;background:var(--bg-secondary);border-radius:20px 20px 0 0;padding:20px;transition:transform .3s ease;z-index:101;max-height:85vh;overflow-y:auto;box-sizing:border-box}
.bottom-sheet.active{transform:translateX(-50%) translateY(0)}
.bottom-sheet-handle{width:40px;height:4px;background:var(--bg-tertiary);border-radius:2px;margin:0 auto 16px}
.bottom-sheet-title{font-size:17px;font-weight:600;margin-bottom:16px}
.sheet-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding-bottom:20px}
.sheet-item{text-align:center;padding:16px 8px;background:var(--bg-tertiary);border-radius:12px;cursor:pointer}
.sheet-item.danger .sheet-item-label{color:var(--error)}
.sheet-item:hover{background:var(--primary);color:white}
.sheet-item-icon{font-size:24px;margin-bottom:6px}
.sheet-item-label{font-size:12px}
.modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(.9);background:var(--bg-secondary);border-radius:16px;padding:20px;width:calc(100% - 32px);max-width:360px;max-height:calc(100vh - 100px);overflow-y:auto;z-index:102;opacity:0;visibility:hidden;transition:all .3s;box-sizing:border-box}
.modal.active{opacity:1;visibility:visible;transform:translate(-50%,-50%) scale(1)}
.modal-title{font-size:18px;font-weight:600;margin-bottom:12px}
.modal-content{font-size:14px;color:var(--text-secondary);margin-bottom:20px;line-height:1.6;max-height:40vh;overflow-y:auto;word-break:break-word;overflow-wrap:break-word}
.modal-input{width:100%;padding:12px 16px;background:var(--bg-tertiary);border:1px solid var(--divider);border-radius:8px;font-size:15px;color:var(--text-primary);outline:none;margin-bottom:16px}
.modal-input:focus{border-color:var(--primary)}
.modal-actions{display:flex;gap:12px}
.modal-btn{flex:1;padding:12px;border:none;border-radius:8px;font-size:15px;cursor:pointer}
.modal-btn.cancel{background:var(--bg-tertiary);color:var(--text-secondary)}
.modal-btn.confirm{background:var(--primary);color:white}
.modal-btn.danger{background:var(--error);color:white}
/* v19: Ê®°ÂºèÈÅ∏ÊìáÂç°Áâá */
.mode-card{background:var(--bg-tertiary);border:2px solid var(--divider);border-radius:12px;padding:12px;text-align:center;cursor:pointer;transition:all 0.2s}
.mode-card:hover{border-color:var(--primary);background:var(--bg-secondary)}
.mode-card.active{border-color:var(--primary);background:rgba(123,97,255,0.1)}
/* v19: Ë≥áÊ∫êÈù¢Êùø */
.sim-resource-bar{display:flex;gap:12px;padding:10px 16px;background:var(--bg-secondary);border-bottom:1px solid var(--divider);overflow-x:auto;flex-wrap:wrap}
.sim-resource-item{display:flex;align-items:center;gap:4px;font-size:13px;white-space:nowrap}
.sim-resource-icon{font-size:16px}
.sim-resource-value{font-weight:600;color:var(--text-primary)}
.sim-resource-name{color:var(--text-secondary);font-size:11px}
.sim-resource-change{font-size:11px;margin-left:2px}
.sim-resource-change.up{color:var(--success)}
.sim-resource-change.down{color:var(--error)}
.sim-day-badge{background:var(--primary);color:white;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:600}
.context-menu{position:fixed;background:var(--bg-card);border-radius:12px;padding:8px 0;box-shadow:0 4px 20px rgba(0,0,0,.4);z-index:200;min-width:160px;opacity:0;visibility:hidden;transform:scale(.95);transition:all .2s}
.context-menu.active{opacity:1;visibility:visible;transform:scale(1)}
.context-menu-item{padding:12px 16px;font-size:14px;cursor:pointer;display:flex;align-items:center;gap:10px}
.context-menu-item:hover{background:var(--bg-tertiary)}
.context-menu-item.danger{color:var(--error)}
.context-menu-divider{height:1px;background:var(--divider);margin:4px 0}
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--bg-card);color:var(--text-primary);padding:12px 20px;border-radius:8px;font-size:14px;box-shadow:0 4px 20px rgba(0,0,0,.3);opacity:0;transition:all .3s;z-index:300;display:flex;align-items:center;gap:8px}
.toast.active{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.success{border-left:3px solid var(--success)}
.toast.error{border-left:3px solid var(--error)}
.toast.warning{border-left:3px solid var(--warning)}
.loading{position:fixed;inset:0;background:rgba(15,15,26,.8);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:500;opacity:0;visibility:hidden;transition:all .3s}
.loading.active{opacity:1;visibility:visible}
.loading-spinner{width:40px;height:40px;border:3px solid var(--bg-tertiary);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{margin-top:16px;font-size:14px;color:var(--text-secondary)}
.empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;text-align:center}
.empty-icon{font-size:64px;opacity:.5;margin-bottom:16px}
.empty-title{font-size:18px;font-weight:600;margin-bottom:8px}
.empty-desc{font-size:14px;color:var(--text-secondary);margin-bottom:24px;max-width:260px}
.empty-btn{padding:12px 24px;background:var(--primary);color:white;border:none;border-radius:8px;font-size:15px;cursor:pointer}
.api-card{background:var(--bg-card);border-radius:12px;padding:16px;margin-bottom:12px;border:2px solid transparent;cursor:pointer}
.api-card:hover{background:var(--bg-tertiary)}
.api-card.active{border-color:var(--primary)}
.api-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.api-name{font-size:15px;font-weight:600}
.api-badge{font-size:10px;padding:2px 8px;background:var(--primary);color:white;border-radius:4px}
.api-info{font-size:12px;color:var(--text-secondary)}
.form-group{margin-bottom:16px}
.form-label{display:block;font-size:13px;color:var(--text-secondary);margin-bottom:6px}
.form-input{width:100%;padding:12px 16px;background:var(--bg-tertiary);border:1px solid var(--divider);border-radius:8px;font-size:15px;color:var(--text-primary);outline:none}
.form-input:focus{border-color:var(--primary)}
.form-select{width:100%;padding:12px 16px;background:var(--bg-tertiary);border:1px solid var(--divider);border-radius:8px;font-size:15px;color:var(--text-primary);outline:none;cursor:pointer;appearance:none}
.form-textarea{width:100%;padding:12px 16px;background:var(--bg-tertiary);border:1px solid var(--divider);border-radius:8px;font-size:14px;color:var(--text-primary);outline:none;resize:vertical;min-height:80px;font-family:inherit;line-height:1.5}
.form-textarea:focus{border-color:var(--primary)}
/* Ë®òÊÜ∂ÂèØË¶ñÂåñÊ®£Âºè */
.mem-viz-item{display:grid;grid-template-columns:90px 1fr 60px;gap:8px;align-items:center;margin-bottom:10px}
.mem-viz-label{font-size:12px;color:var(--text-secondary)}
.mem-viz-bar-container{height:20px;background:var(--bg-primary);border-radius:10px;overflow:hidden}
.mem-viz-bar{height:100%;border-radius:10px;transition:width .5s ease;min-width:2px}
.mem-viz-value{font-size:12px;font-weight:600;color:var(--text-primary);text-align:right}
/* v8 ËßíËâ≤Á∑®ËºØÈù¢ÊùøÊ®£Âºè */
.char-panel{background:var(--bg-card);border-radius:12px;margin-bottom:10px;border:1px solid var(--divider);overflow:hidden}
.char-panel-header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;cursor:pointer;font-size:14px;font-weight:600;color:var(--text-primary);transition:background .2s}
.char-panel-header:hover{background:rgba(139,124,247,.05)}
.char-panel-header:active{background:rgba(139,124,247,.1)}
.char-panel-arrow{font-size:10px;color:var(--text-secondary);transition:transform .2s}
.char-panel.expanded .char-panel-arrow{transform:rotate(90deg)}
.char-panel-content{padding:0 16px 16px;border-top:1px solid var(--divider)}
.greeting-option{padding:12px;margin-bottom:10px;background:var(--bg-tertiary);border-radius:10px;cursor:pointer;border:2px solid transparent;transition:all .2s}
.greeting-option:hover{background:var(--bg-card)}
.greeting-option.selected{border-color:var(--primary);background:rgba(139,124,247,.1)}
.greeting-option-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.greeting-char-avatar{font-size:20px}
.greeting-char-name{font-weight:600;font-size:14px}
.greeting-badge{font-size:10px;padding:2px 6px;background:var(--primary);color:white;border-radius:4px;margin-left:auto}
.greeting-preview{font-size:13px;color:var(--text-secondary);line-height:1.5;max-height:60px;overflow:hidden}
.relationship-item{background:var(--bg-tertiary);border-radius:10px;padding:12px;position:relative}
.relationship-item .delete-btn{position:absolute;top:8px;right:8px;width:24px;height:24px;border-radius:50%;background:var(--error);color:white;border:none;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center}
.relationship-row{display:flex;gap:8px;margin-bottom:8px}
.relationship-row .form-input,.relationship-row .form-select{flex:1;padding:8px 10px;font-size:13px}
.rel-type-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:6px;font-size:11px;font-weight:500}
.rel-graph-node{position:absolute;width:70px;height:70px;border-radius:50%;background:var(--bg-card);border:3px solid var(--primary);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:move;transition:transform .2s,box-shadow .2s;z-index:2}
.rel-graph-node:hover{transform:scale(1.1);box-shadow:0 4px 20px rgba(139,124,247,.4)}
.rel-graph-node .node-avatar{font-size:24px}
.rel-graph-node .node-name{font-size:10px;margin-top:2px;max-width:60px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:center}
.rel-graph-node.protagonist{border-color:#FFD700}
.rel-graph-node.npc{border-color:var(--text-tertiary)}
.rel-graph-line{position:absolute;pointer-events:none;z-index:1}
.rel-graph-label{position:absolute;background:var(--bg-secondary);padding:2px 6px;border-radius:4px;font-size:10px;color:var(--text-secondary);white-space:nowrap;z-index:1}
/* ‰ºèÁ≠ÜÊôÇÈñìÁ∑öÊ®£Âºè */
.timeline-container{position:relative;padding:20px 0}
.timeline-item{position:relative;padding-left:40px;margin-bottom:24px}
.timeline-item::before{content:'';position:absolute;left:12px;top:30px;bottom:-24px;width:2px;background:var(--divider)}
.timeline-item:last-child::before{display:none}
.timeline-marker{position:absolute;left:0;top:0;width:28px;height:28px;border-radius:50%;background:var(--primary);color:white;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;border:3px solid var(--bg-primary);z-index:2}
.timeline-item.resolved .timeline-marker{background:var(--success)}
.timeline-item.warning .timeline-marker{background:var(--warning);animation:pulse 2s infinite}
.timeline-item.critical .timeline-marker{background:var(--error);animation:pulse 1s infinite}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,.7)}50%{box-shadow:0 0 0 8px rgba(239,68,68,0)}}
.timeline-content{background:var(--bg-card);padding:12px;border-radius:8px;border:1px solid var(--divider)}
.timeline-title{font-size:14px;font-weight:600;margin-bottom:4px}
.timeline-meta{font-size:11px;color:var(--text-tertiary);margin-top:4px}
.timeline-resolved{font-size:12px;color:var(--success);margin-top:8px;padding-top:8px;border-top:1px solid var(--divider)}
/* ‰ºèÁ≠ÜÊèêÈÜíÊ©´ÂπÖ */
.foreshadow-reminder{position:fixed;top:52px;left:50%;transform:translateX(-50%);max-width:420px;width:calc(100% - 32px);padding:12px 16px;border-radius:0 0 12px 12px;display:flex;align-items:center;justify-content:space-between;gap:12px;z-index:999;font-size:13px;box-shadow:0 4px 12px rgba(0,0,0,.2)}
.foreshadow-reminder.warning{background:linear-gradient(135deg,#F59E0B,#EF4444);color:white}
.foreshadow-reminder button{background:rgba(255,255,255,.2);color:white;border:1px solid rgba(255,255,255,.3);padding:6px 12px;border-radius:6px;font-size:12px;cursor:pointer;transition:all .2s}
.foreshadow-reminder button:hover{background:rgba(255,255,255,.3)}
/* Âª∫Ë≠∞È†ÖÁõÆÊ®£Âºè */
.suggestions-list{padding:12px}
.suggestion-item{background:var(--bg-tertiary);padding:12px;border-radius:8px;margin-bottom:12px;display:flex;gap:12px;align-items:flex-start;transition:all .2s}
.suggestion-item input[type="checkbox"]{margin-top:4px;width:18px;height:18px;cursor:pointer}
.suggestion-item label{flex:1;cursor:pointer}
.suggestion-item strong{display:block;font-size:14px;margin-bottom:4px}
.suggestion-item p{font-size:13px;color:var(--text-secondary);margin-bottom:4px}
.suggestion-item small{font-size:11px;color:var(--text-tertiary)}
/* ÈáçË§á‰ºèÁ≠ÜË≠¶ÂëäÊ®£Âºè */
.suggestion-duplicate{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3)}
.duplicate-warning{margin-top:8px;padding:8px;background:rgba(239,68,68,.15);border-left:3px solid var(--error);border-radius:4px;font-size:12px;color:var(--error)}
.expression-item{position:relative;background:var(--bg-tertiary);border-radius:10px;padding:8px;cursor:pointer;border:2px solid transparent;transition:all .2s}
.expression-item:hover{background:var(--bg-card)}
.expression-item.selected{border-color:var(--primary);background:rgba(139,124,247,.1)}
.expression-item.default{border-color:var(--success)}
.expression-item .expr-img{width:100%;aspect-ratio:1;border-radius:8px;object-fit:cover;background:var(--bg-secondary)}
.expression-item .expr-name{font-size:11px;text-align:center;margin-top:6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.expression-item .expr-badge{position:absolute;top:4px;left:4px;font-size:9px;padding:2px 5px;background:var(--success);color:white;border-radius:4px}
.expression-item .expr-delete{position:absolute;top:4px;right:4px;width:20px;height:20px;border-radius:50%;background:rgba(0,0,0,.5);color:white;border:none;cursor:pointer;font-size:10px;display:none;align-items:center;justify-content:center}
.expression-item:hover .expr-delete{display:flex}
.expression-edit-modal{background:var(--bg-secondary);border-radius:12px;padding:16px;margin-top:10px}
.char-expr-display{width:80px;height:80px;border-radius:12px;object-fit:cover;border:2px solid var(--primary);cursor:pointer;transition:transform .2s}
.char-expr-display:hover{transform:scale(1.05)}
.expr-selector{position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:var(--bg-card);border-radius:12px;padding:8px;display:none;flex-wrap:wrap;gap:6px;max-width:200px;box-shadow:0 4px 20px rgba(0,0,0,.3);z-index:100}
.expr-selector.active{display:flex}
.expr-selector-item{width:50px;height:50px;border-radius:8px;object-fit:cover;cursor:pointer;border:2px solid transparent;transition:all .2s}
.expr-selector-item:hover{border-color:var(--primary)}
.expr-selector-item.active{border-color:var(--primary);box-shadow:0 0 10px rgba(139,124,247,.5)}
.char-filter-bar{display:flex;gap:10px;padding:10px 16px;background:var(--bg-secondary);border-bottom:1px solid var(--divider)}
.char-search-wrap{flex:1;position:relative}
.char-search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:14px;opacity:.5}
.char-search-input{width:100%;padding:10px 12px 10px 36px;border:1px solid var(--divider);border-radius:10px;background:var(--bg-tertiary);color:var(--text-primary);-webkit-text-fill-color:var(--text-primary);font-size:14px}
.char-search-input:focus{outline:none;border-color:var(--primary)}
.char-search-input:-webkit-autofill,.char-search-input:-webkit-autofill:hover,.char-search-input:-webkit-autofill:focus{-webkit-text-fill-color:var(--text-primary)!important;-webkit-box-shadow:0 0 0 1000px var(--bg-tertiary) inset!important;transition:background-color 5000s ease-in-out 0s}
.char-filter-select{padding:10px 12px;border:1px solid var(--divider);border-radius:10px;background:var(--bg-tertiary);color:var(--text-primary);font-size:13px;min-width:100px}
.char-batch-bar{display:flex;align-items:center;gap:12px;padding:10px 16px;background:rgba(139,124,247,.1);border-bottom:1px solid var(--primary)}
.char-batch-select-all{display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer}
.char-batch-count{font-size:12px;color:var(--primary);font-weight:500}
.char-batch-actions{margin-left:auto;display:flex;gap:8px}
.char-batch-btn{padding:6px 12px;border:none;border-radius:6px;background:var(--bg-tertiary);color:var(--text-primary);font-size:12px;cursor:pointer;transition:background .2s}
.char-batch-btn:hover{background:var(--bg-card)}
.char-group{margin-bottom:16px}
.char-group-header{display:flex;align-items:center;gap:8px;padding:8px 16px;font-size:13px;font-weight:600;color:var(--text-secondary);cursor:pointer}
.char-group-header:hover{color:var(--text-primary)}
.char-group-arrow{transition:transform .2s}
.char-group.collapsed .char-group-arrow{transform:rotate(-90deg)}
.char-group.collapsed .char-group-list{display:none}
.char-group-count{font-size:11px;color:var(--text-tertiary);font-weight:normal}
.char-card{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--bg-card);margin:0 16px 8px;border-radius:12px;cursor:pointer;transition:all .2s;position:relative}
.char-card:hover{background:var(--bg-tertiary);transform:translateX(4px)}
.char-card.selected{background:rgba(139,124,247,.15);border:1px solid var(--primary)}
.char-card-checkbox{width:20px;height:20px;border-radius:4px;border:2px solid var(--divider);display:none;align-items:center;justify-content:center;flex-shrink:0}
.char-card-checkbox.checked{background:var(--primary);border-color:var(--primary);color:white}
.batch-mode .char-card-checkbox{display:flex}
.char-card-avatar{width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--primary-light));display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;overflow:hidden}
.char-card-avatar img{width:100%;height:100%;object-fit:cover}
.char-card-info{flex:1;min-width:0}
.char-card-name{font-size:15px;font-weight:600;margin-bottom:2px;display:flex;align-items:center;gap:6px}
.char-card-title{font-size:12px;color:var(--text-secondary);margin-bottom:4px}
.char-card-tags{display:flex;flex-wrap:wrap;gap:4px}
.char-card-tag{font-size:10px;padding:2px 6px;background:var(--bg-tertiary);border-radius:4px;color:var(--text-secondary)}
.char-card-stats{display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0}
.char-card-stat{font-size:11px;color:var(--text-secondary);display:flex;align-items:center;gap:4px}
.char-card-category{font-size:10px;padding:2px 6px;border-radius:4px;font-weight:500}
.char-card-category.protagonist{background:rgba(255,215,0,.2);color:#FFD700}
.char-card-category.supporting{background:rgba(139,124,247,.2);color:var(--primary)}
.char-card-category.npc{background:rgba(156,163,175,.2);color:#9ca3af}
.char-empty{text-align:center;padding:40px 20px;color:var(--text-tertiary)}
.char-empty-icon{font-size:48px;margin-bottom:12px;opacity:.5}
.char-empty-text{font-size:14px;margin-bottom:16px}
.char-form-row{display:flex;gap:12px}
.token-hint{font-size:11px;color:var(--text-tertiary);font-weight:normal}
.char-lore-entry{background:var(--bg-tertiary);border-radius:8px;padding:12px;position:relative}
.char-lore-entry .delete-btn{position:absolute;top:8px;right:8px;width:24px;height:24px;border-radius:50%;background:var(--error);color:white;border:none;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center}
.alt-greeting-item{display:flex;gap:8px;align-items:flex-start}
.alt-greeting-item textarea{flex:1;min-height:60px}
.alt-greeting-item .delete-btn{width:28px;height:28px;border-radius:6px;background:var(--bg-tertiary);color:var(--text-secondary);border:none;cursor:pointer;flex-shrink:0}
.alt-greeting-item .delete-btn:hover{background:var(--error);color:white}
.hidden{display:none!important}
/* PWA ÂÆâË£ùÊ©´ÂπÖÂãïÁï´ */
#install-banner>div{animation:slideUp .3s ease}
@keyframes slideUp{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}
/* ÊñáÂ≠óÊ∫¢Âá∫‰øÆÂæ© */
.scroll{word-break:break-word;overflow-wrap:break-word}
.lore-desc,.lore-name,.inst-preview,.card-preview,.save-card-preview{word-break:break-word;overflow-wrap:break-word}
/* ====== v7 ËßíËâ≤Âç°ÁâáÁ≥ªÁµ± CSS ====== */
.char-card{background:var(--bg-card);border-radius:16px;margin-bottom:12px;border:1px solid var(--divider);overflow:hidden;transition:all .3s}
.char-card.expanded{box-shadow:0 8px 32px rgba(139,124,247,.15)}
.char-header{display:flex;align-items:center;padding:14px;cursor:pointer;transition:background .2s}
.char-header:active{background:rgba(255,255,255,.03)}
.char-avatar{width:52px;height:52px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--primary-light));display:flex;align-items:center;justify-content:center;font-size:22px;margin-right:12px;flex-shrink:0;position:relative;background-size:cover;background-position:center;overflow:hidden;cursor:pointer}
.char-avatar img{width:100%;height:100%;object-fit:cover}
.char-avatar-rank{position:absolute;bottom:-4px;right:-4px;background:var(--warning);color:#000;font-size:9px;padding:2px 6px;border-radius:8px;font-weight:600}
.char-info{flex:1;min-width:0}
.char-name{font-size:16px;font-weight:600;display:flex;align-items:center;gap:8px}
.char-title{font-size:10px;background:linear-gradient(135deg,#d4a574,#e8c9a0);color:#000;padding:2px 8px;border-radius:4px;font-weight:500}
.char-brief{font-size:12px;color:var(--text-secondary);margin-top:3px}
.char-quick{display:flex;gap:10px;margin-top:6px}
.char-quick-item{display:flex;align-items:center;gap:3px;font-size:11px}
.char-quick-val{font-weight:600}
.char-expand{width:28px;height:28px;border-radius:50%;background:var(--bg-secondary);display:flex;align-items:center;justify-content:center;transition:transform .3s;flex-shrink:0;font-size:12px}
.char-card.expanded .char-expand{transform:rotate(180deg)}
.char-content{max-height:0;overflow:hidden;transition:max-height .4s ease}
.char-card.expanded .char-content{max-height:800px}
.char-inner{padding:0 14px 14px}
.char-tabs{display:flex;gap:4px;background:var(--bg-secondary);padding:4px;border-radius:10px;margin-bottom:12px}
.char-tab{flex:1;padding:8px;border-radius:8px;font-size:12px;text-align:center;cursor:pointer;transition:all .2s;color:var(--text-secondary)}
.char-tab.active{background:var(--primary);color:white;font-weight:500}
.char-tab-content{display:none;animation:fadeIn .3s}
.char-tab-content.active{display:block}
@keyframes charFadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.char-section{margin-bottom:14px}
.char-section-title{font-size:11px;color:var(--text-tertiary);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.char-section-title::after{content:'';flex:1;height:1px;background:var(--divider)}
.char-stat-bar{margin-bottom:10px}
.char-stat-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.char-stat-label{font-size:12px;color:var(--text-secondary);display:flex;align-items:center;gap:4px}
.char-stat-value{font-size:13px;font-weight:600}
.char-stat-track{height:5px;background:var(--bg-secondary);border-radius:3px;overflow:hidden}
.char-stat-fill{height:100%;border-radius:3px;transition:width .5s}
.char-stat-fill.purple{background:linear-gradient(90deg,#8b5cf6,#a78bfa)}
.char-stat-fill.gold{background:linear-gradient(90deg,#d4a574,#e8c9a0)}
.char-stat-fill.blue{background:linear-gradient(90deg,#3b82f6,#60a5fa)}
.char-stat-fill.red{background:linear-gradient(90deg,#ef4444,#f87171)}
.char-stat-fill.green{background:linear-gradient(90deg,#22c55e,#4ade80)}
.char-stat-fill.pink{background:linear-gradient(90deg,#ec4899,#f472b6)}
.char-favor{background:var(--bg-secondary);border-radius:12px;padding:12px;margin-bottom:10px}
.char-favor-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.char-favor-title{font-size:13px;font-weight:500}
.char-favor-level{font-size:11px;color:var(--warning);background:rgba(245,158,11,.15);padding:3px 8px;border-radius:10px}
.char-favor-item{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.char-favor-item:last-child{margin-bottom:0}
.char-favor-icon{width:26px;height:26px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0}
.char-favor-icon.surface{background:rgba(139,124,247,.2)}
.char-favor-icon.real{background:rgba(239,68,68,.2)}
.char-favor-info{flex:1}
.char-favor-label{font-size:11px;color:var(--text-secondary)}
.char-favor-track{height:4px;background:rgba(255,255,255,.1);border-radius:2px;margin-top:3px;overflow:hidden}
.char-favor-fill{height:100%;border-radius:2px;transition:width .5s}
.char-favor-fill.surface{background:var(--primary)}
.char-favor-fill.real{background:var(--error)}
.char-favor-fill.true{background:var(--success)}
.char-favor-val{font-size:13px;font-weight:600;min-width:28px;text-align:right}
.char-desc{font-size:12px;line-height:1.6;color:var(--text-secondary);background:var(--bg-secondary);padding:12px;border-radius:10px;border-left:3px solid var(--primary)}
.char-tags{display:flex;flex-wrap:wrap;gap:5px;margin-top:10px}
.char-tag{font-size:10px;padding:4px 8px;border-radius:10px;background:var(--bg-secondary);color:var(--text-secondary)}
.char-tag.danger{background:rgba(239,68,68,.15);color:#f87171}
.char-tag.warning{background:rgba(234,179,8,.15);color:#fbbf24}
.char-tag.info{background:rgba(59,130,246,.15);color:#60a5fa}
.char-tag.success{background:rgba(34,197,94,.15);color:#4ade80}
.char-mini-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:10px}
.char-mini-stat{background:var(--bg-secondary);padding:8px;border-radius:8px;text-align:center}
.char-mini-val{font-size:16px;font-weight:600}
.char-mini-label{font-size:10px;color:var(--text-tertiary);margin-top:2px}
.char-relation{display:flex;align-items:center;padding:10px;background:var(--bg-secondary);border-radius:10px;margin-bottom:8px}
.char-relation-avatar{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#3b82f6,#60a5fa);display:flex;align-items:center;justify-content:center;font-size:16px;margin-right:10px}
.char-relation-info{flex:1}
.char-relation-name{font-size:13px;font-weight:500}
.char-relation-type{font-size:11px;color:var(--text-secondary)}
.char-relation-status{font-size:10px;padding:3px 8px;border-radius:10px}
.char-relation-status.ally{background:rgba(34,197,94,.2);color:var(--success)}
.char-relation-status.enemy{background:rgba(239,68,68,.2);color:var(--error)}
.char-relation-status.neutral{background:rgba(255,255,255,.1);color:var(--text-secondary)}
.char-actions{display:flex;gap:8px;margin-top:12px}
.char-action-btn{flex:1;padding:10px;border-radius:10px;border:none;font-size:12px;cursor:pointer;transition:all .2s}
.char-action-btn.primary{background:var(--primary);color:white}
.char-action-btn.secondary{background:var(--bg-secondary);color:var(--text-primary)}
.char-action-btn:active{transform:scale(.97)}
/* Êï∏ÂÄºËÆäÂåñÂãïÁï´ */
.char-value-change{position:fixed;font-size:14px;font-weight:600;animation:charFloatUp 1.5s ease forwards;pointer-events:none;z-index:9999}
.char-value-change.up{color:var(--success)}
.char-value-change.down{color:var(--error)}
@keyframes charFloatUp{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-24px)}}
/* ËßíËâ≤ÂàóË°®Á©∫ÁãÄÊÖã */
.char-empty{text-align:center;padding:40px 20px;color:var(--text-secondary)}
.char-empty-icon{font-size:48px;margin-bottom:12px}
.char-empty-title{font-size:15px;font-weight:500;margin-bottom:6px;color:var(--text-primary)}
.char-empty-desc{font-size:13px}
/* ËßíËâ≤Êõ¥Êñ∞‰∏≠ÊèêÁ§∫ */
.char-updating{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.8);padding:12px 20px;border-radius:12px;font-size:13px;display:flex;align-items:center;gap:8px}
.char-updating-spin{width:16px;height:16px;border:2px solid var(--primary);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite}
/* Êåá‰ª§ÁîüÊàêÂêëÂ∞éÊ®£Âºè */
.wizard-progress{display:flex;align-items:center;padding:16px;background:var(--bg-secondary);border-bottom:1px solid var(--divider)}
.wizard-progress-bar{flex:1;height:6px;background:var(--bg-tertiary);border-radius:3px;overflow:hidden;margin-right:12px}
.wizard-progress-fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--primary-light));border-radius:3px;transition:width .3s}
.wizard-progress-text{font-size:12px;color:var(--text-secondary);white-space:nowrap}
.wizard-content{flex:1;overflow-y:auto;padding:16px}
.wizard-section{margin-bottom:24px}
.wizard-section-title{font-size:16px;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.wizard-section-desc{font-size:13px;color:var(--text-secondary);margin-bottom:16px;line-height:1.6}
.wizard-options{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px}
.wizard-option{padding:10px 16px;background:var(--bg-tertiary);border:2px solid transparent;border-radius:10px;font-size:14px;cursor:pointer;transition:all .2s}
.wizard-option:hover{border-color:var(--primary-light)}
.wizard-option.selected{background:rgba(139,124,247,.2);border-color:var(--primary);color:var(--primary-light)}
.wizard-option.template{display:flex;flex-direction:column;padding:16px;min-width:calc(50% - 4px)}
.wizard-option.template .template-icon{font-size:28px;margin-bottom:8px}
.wizard-option.template .template-name{font-weight:600;margin-bottom:4px}
.wizard-option.template .template-desc{font-size:11px;color:var(--text-tertiary)}
.wizard-input{width:100%;padding:12px 16px;background:var(--bg-tertiary);border:1px solid var(--divider);border-radius:10px;font-size:14px;color:var(--text-primary);outline:none;margin-bottom:12px}
.wizard-input:focus{border-color:var(--primary)}
.wizard-textarea{min-height:100px;resize:vertical;font-family:inherit;line-height:1.6}
.wizard-ai-box{background:var(--bg-card);border-radius:12px;padding:16px;margin-top:16px;border-left:3px solid var(--primary)}
.wizard-ai-header{display:flex;align-items:center;gap:8px;margin-bottom:12px;font-size:13px;color:var(--primary-light)}
.wizard-ai-content{font-size:14px;line-height:1.7;color:var(--text-secondary)}
.wizard-ai-options{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
.wizard-ai-btn{padding:8px 16px;background:var(--bg-tertiary);border:none;border-radius:8px;font-size:13px;color:var(--text-primary);cursor:pointer;transition:all .2s}
.wizard-ai-btn:hover{background:var(--primary);color:white}
.wizard-ai-btn.loading{opacity:.6;pointer-events:none}
.wizard-char-list{margin-top:16px}
.wizard-char-card{background:var(--bg-card);border-radius:10px;padding:12px;margin-bottom:8px;display:flex;align-items:center;gap:12px}
.wizard-char-avatar{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--primary-light));display:flex;align-items:center;justify-content:center;font-size:18px}
.wizard-char-info{flex:1}
.wizard-char-name{font-size:14px;font-weight:600}
.wizard-char-role{font-size:12px;color:var(--text-secondary)}
.wizard-char-actions{display:flex;gap:8px}
.wizard-char-btn{width:28px;height:28px;border-radius:6px;background:var(--bg-tertiary);border:none;font-size:12px;cursor:pointer}
.wizard-example{background:var(--bg-tertiary);border-radius:10px;padding:12px;margin-top:12px;font-size:13px;color:var(--text-secondary);line-height:1.6;max-height:150px;overflow-y:auto}
.wizard-example-title{font-size:12px;color:var(--text-tertiary);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.wizard-footer{display:flex;gap:12px;padding:16px;background:var(--bg-secondary);border-top:1px solid var(--divider)}
.wizard-btn{flex:1;padding:14px;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;transition:all .2s}
.wizard-btn.primary{background:var(--primary);color:white}
.wizard-btn.secondary{background:var(--bg-tertiary);color:var(--text-secondary)}
.wizard-btn:disabled{opacity:.5;cursor:not-allowed}
.wizard-btn:active:not(:disabled){transform:scale(.98)}
.wizard-preview{background:var(--bg-card);border-radius:12px;padding:16px;margin-top:16px}
.wizard-preview-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.wizard-preview-title{font-size:14px;font-weight:600}
.wizard-preview-stats{font-size:12px;color:var(--text-tertiary)}
.wizard-preview-content{background:var(--bg-tertiary);border-radius:8px;padding:12px;font-size:13px;line-height:1.7;max-height:300px;overflow-y:auto;white-space:pre-wrap;font-family:monospace}
.wizard-chat{display:flex;flex-direction:column;gap:12px;margin-top:16px}
.wizard-chat-msg{max-width:85%;padding:12px 16px;border-radius:16px;font-size:14px;line-height:1.6}
.wizard-chat-msg.ai{background:var(--bg-card);border-bottom-left-radius:4px;align-self:flex-start}
.wizard-chat-msg.user{background:var(--primary);color:white;border-bottom-right-radius:4px;align-self:flex-end}
.wizard-chat-input{display:flex;gap:8px;margin-top:12px}
.wizard-chat-field{flex:1;padding:12px 16px;background:var(--bg-tertiary);border:none;border-radius:20px;font-size:14px;color:var(--text-primary);outline:none}
.wizard-chat-send{width:40px;height:40px;background:var(--primary);border:none;border-radius:50%;color:white;font-size:16px;cursor:pointer}
/* Prompt ÂàÜÊûêÂäüËÉΩÊ®£Âºè */
.analyze-import{display:flex;gap:12px;margin-bottom:16px}
.analyze-import-btn{flex:1;padding:40px 16px;background:var(--bg-card);border:2px dashed var(--divider);border-radius:12px;cursor:pointer;text-align:center;transition:all .2s}
.analyze-import-btn:hover{border-color:var(--primary);background:rgba(139,124,247,.05)}
.analyze-import-btn .icon{font-size:32px;margin-bottom:8px}
.analyze-import-btn .label{font-size:14px;color:var(--text-secondary)}
.analyze-textarea{width:100%;min-height:200px;padding:16px;background:var(--bg-tertiary);border:1px solid var(--divider);border-radius:12px;font-size:14px;color:var(--text-primary);font-family:monospace;line-height:1.6;resize:vertical;outline:none}
.analyze-textarea:focus{border-color:var(--primary)}
.analyze-stats{display:flex;gap:16px;margin:16px 0;padding:12px 16px;background:var(--bg-card);border-radius:10px}
.analyze-stat{text-align:center}
.analyze-stat-value{font-size:20px;font-weight:700;color:var(--primary)}
.analyze-stat-label{font-size:11px;color:var(--text-tertiary)}
.analyze-score{text-align:center;padding:24px;background:var(--bg-card);border-radius:16px;margin-bottom:20px}
.analyze-score-ring{width:120px;height:120px;margin:0 auto 12px;position:relative}
.analyze-score-ring svg{transform:rotate(-90deg)}
.analyze-score-ring circle{fill:none;stroke-width:8}
.analyze-score-ring .bg{stroke:var(--bg-tertiary)}
.analyze-score-ring .fill{stroke:var(--primary);stroke-linecap:round;transition:stroke-dashoffset .5s}
.analyze-score-value{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.analyze-score-num{font-size:36px;font-weight:700}
.analyze-score-label{font-size:12px;color:var(--text-tertiary)}
.analyze-score-text{font-size:14px;color:var(--text-secondary)}
.analyze-modules{margin-bottom:20px}
.analyze-module{background:var(--bg-card);border-radius:12px;margin-bottom:8px;overflow:hidden}
.analyze-module-header{display:flex;align-items:center;padding:14px 16px;cursor:pointer}
.analyze-module-icon{font-size:18px;margin-right:10px}
.analyze-module-name{flex:1;font-size:14px;font-weight:500}
.analyze-module-score{display:flex;align-items:center;gap:8px}
.analyze-module-bar{width:60px;height:6px;background:var(--bg-tertiary);border-radius:3px;overflow:hidden}
.analyze-module-bar-fill{height:100%;border-radius:3px;transition:width .3s}
.analyze-module-bar-fill.high{background:var(--success)}
.analyze-module-bar-fill.medium{background:var(--warning)}
.analyze-module-bar-fill.low{background:var(--error)}
.analyze-module-num{font-size:13px;font-weight:600;min-width:28px;text-align:right}
.analyze-module-status{font-size:14px;margin-left:4px}
.analyze-module-body{padding:0 16px 14px;display:none}
.analyze-module.expanded .analyze-module-body{display:block}
.analyze-module-issues{margin-bottom:12px}
.analyze-issue{display:flex;align-items:flex-start;gap:8px;padding:8px 0;border-bottom:1px solid var(--divider);font-size:13px}
.analyze-issue:last-child{border-bottom:none}
.analyze-issue-icon{flex-shrink:0}
.analyze-issue-text{flex:1;color:var(--text-secondary);line-height:1.5}
.analyze-module-actions{display:flex;gap:8px}
.analyze-module-btn{padding:8px 16px;background:var(--bg-tertiary);border:none;border-radius:8px;font-size:13px;color:var(--text-primary);cursor:pointer;transition:all .2s}
.analyze-module-btn:hover{background:var(--primary);color:white}
.analyze-module-btn.primary{background:var(--primary);color:white}
.analyze-suggestions{background:var(--bg-card);border-radius:12px;padding:16px;margin-bottom:20px;border-left:3px solid var(--primary)}
.analyze-suggestions-title{font-size:14px;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.analyze-suggestions-content{font-size:14px;line-height:1.7;color:var(--text-secondary)}
.analyze-compare{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px}
.analyze-compare-col{background:var(--bg-tertiary);border-radius:10px;padding:12px;max-height:300px;overflow-y:auto}
.analyze-compare-title{font-size:12px;font-weight:600;margin-bottom:8px;color:var(--text-tertiary);display:flex;align-items:center;gap:6px}
.analyze-compare-content{font-size:12px;line-height:1.6;white-space:pre-wrap;font-family:monospace;color:var(--text-secondary)}
.analyze-compare-content .added{background:rgba(16,185,129,.2);color:var(--success)}
.analyze-compare-content .removed{background:rgba(239,68,68,.2);color:var(--error);text-decoration:line-through}
.analyze-actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:16px}
.analyze-chat{margin-top:20px;padding-top:20px;border-top:1px solid var(--divider)}
/* Ê∂àÊÅØÁãÄÊÖãÂç°ÁâáÊ®£Âºè */
.msg-story{line-height:var(--line-height)}
.msg-status-section{margin-top:16px;border-top:1px solid var(--divider);padding-top:12px}
.msg-status-header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--bg-tertiary);border-radius:10px;cursor:pointer;transition:all .2s}
.msg-status-header:hover{background:var(--bg-card)}
.msg-status-header .title{display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500;color:var(--text-secondary)}
.msg-status-header .toggle{font-size:12px;color:var(--text-tertiary);transition:transform .2s}
.msg-status-header.expanded .toggle{transform:rotate(180deg)}
.msg-status-cards{display:none;margin-top:10px;gap:10px}
.msg-status-header.expanded+.msg-status-cards{display:flex;flex-direction:column}
.status-card{background:var(--bg-card);border-radius:12px;padding:14px;border:1px solid var(--divider)}
.status-card-header{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.status-card-avatar{width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--primary-light));display:flex;align-items:center;justify-content:center;font-size:20px;color:white;flex-shrink:0}
.status-card-avatar img{width:100%;height:100%;object-fit:cover;border-radius:10px}
.status-card-info{flex:1;min-width:0}
.status-card-name{font-size:15px;font-weight:600;display:flex;align-items:center;gap:6px}
.status-card-title{font-size:12px;color:var(--primary-light);background:rgba(139,124,247,.15);padding:2px 8px;border-radius:4px}
.status-card-meta{font-size:12px;color:var(--text-tertiary);margin-top:2px}
.status-card-stats{display:flex;flex-direction:column;gap:8px}
.status-stat-row{display:flex;align-items:center;gap:10px}
.status-stat-label{font-size:12px;color:var(--text-secondary);min-width:70px}
.status-stat-bar{flex:1;height:6px;background:var(--bg-tertiary);border-radius:3px;overflow:hidden}
.status-stat-fill{height:100%;border-radius:3px;transition:width .3s}
.status-stat-fill.high{background:linear-gradient(90deg,var(--success),#34d399)}
.status-stat-fill.medium{background:linear-gradient(90deg,var(--warning),#fbbf24)}
.status-stat-fill.low{background:linear-gradient(90deg,var(--error),#f87171)}
.status-stat-fill.primary{background:linear-gradient(90deg,var(--primary),var(--primary-light))}
.status-stat-value{font-size:12px;font-weight:600;min-width:28px;text-align:right}
.status-card-footer{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;padding-top:10px;border-top:1px solid var(--divider)}
.status-tag{font-size:11px;padding:3px 8px;background:var(--bg-tertiary);border-radius:4px;color:var(--text-secondary)}
.status-tag.mood{background:rgba(59,130,246,.15);color:var(--info)}
.status-tag.note{background:rgba(245,158,11,.15);color:var(--warning)}
.msg-format-warning{display:flex;align-items:center;gap:8px;padding:10px 14px;background:rgba(245,158,11,.1);border-radius:8px;margin-top:12px;font-size:12px;color:var(--warning)}
.msg-format-warning .icon{font-size:16px}

.form-group{margin-bottom:12px}
.form-group label{display:block;font-size:12px;color:var(--text-secondary);margin-bottom:6px}
.modal-textarea{width:100%;padding:10px;border:1px solid var(--divider);border-radius:8px;background:var(--bg-secondary);color:var(--text-primary);font-size:13px;resize:vertical;font-family:inherit}
  </style>
</head>
<body>
<div class="app" id="app">
  <div class="status-bar">
    <span id="status-time">09:41</span>
    <div style="display:flex;gap:4px;font-size:12px"><span>üì∂</span><span>üîã</span></div>
  </div>
  <div class="views">
    <!-- ÊïÖ‰∫ãÂàóË°® -->
    <div class="view active" id="view-stories">
      <div class="list-nav">
        <span class="list-nav-title">ÁπîÂ§¢</span>
        <div style="display:flex;gap:4px">
          <div class="nav-btn" onclick="toggleScreen()" title="ÂàáÊèõÊ®°Âºè" role="button" tabindex="0">üñ•Ô∏è</div>
          <div class="nav-btn" onclick="importBook()" title="Â∞éÂÖ•Êõ∏Á±ç" role="button" tabindex="0">üì•</div>
          <div class="nav-btn" onclick="createStory()" title="Êñ∞Âª∫" role="button" tabindex="0">‚ûï</div>
        </div>
      </div>
      <div class="search-bar">
        <div class="search-wrap">
          <span style="color:var(--text-tertiary)">üîç</span>
          <input type="text" class="search-input" placeholder="ÊêúÁ¥¢ÊïÖ‰∫ã" id="story-search" oninput="filterStories()">
        </div>
      </div>
      <div class="scroll" id="story-list"></div>
      <div class="tab-bar">
        <div class="tab-item active" onclick="switchTab('stories')" role="button" tabindex="0"><span class="tab-icon">üìö</span><span class="tab-label">ÊïÖ‰∫ã</span></div>
        <div class="tab-item" onclick="switchTab('instructions')" role="button" tabindex="0"><span class="tab-icon">üìú</span><span class="tab-label">Êåá‰ª§</span></div>
        <div class="tab-item" onclick="switchTab('settings')" role="button" tabindex="0"><span class="tab-icon">‚öôÔ∏è</span><span class="tab-label">Ë®≠ÁΩÆ</span></div>
      </div>
    </div>
    <!-- Èñ±ËÆÄÈ†Å -->
    <div class="view" id="view-reading">
      <div class="nav">
        <div class="nav-back" onclick="goBack()" role="button" tabindex="0" aria-label="ËøîÂõû">‚Äπ</div>
        <span class="nav-title" id="reading-title">ÊïÖ‰∫ã</span>
        <div class="nav-right">
          <div class="nav-btn" onclick="goTo('view-characters')" title="ËßíËâ≤ÁãÄÊÖã" id="btn-characters" role="button" tabindex="0">üë•</div>
          <div class="nav-btn" onclick="goTo('view-lore')" title="Ë≥áÊñôÂ∫´" role="button" tabindex="0">üìñ</div>
          <div class="nav-btn" onclick="goTo('view-search')" title="ÊêúÁ¥¢" role="button" tabindex="0">üîç</div>
          <div class="nav-btn" onclick="showSheet()" title="Ë®≠ÁΩÆ" role="button" tabindex="0">‚öôÔ∏è</div>
          <div class="nav-btn" onclick="showMore(event)" title="Êõ¥Â§ö" role="button" tabindex="0">‚ãØ</div>
        </div>
      </div>
      <!-- v19: Á∂ìÁáüÊ®°ÂºèË≥áÊ∫êÈù¢Êùø -->
      <div class="sim-resource-bar" id="sim-resource-bar" style="display:none">
        <div class="sim-day-badge" id="sim-day-badge">üìÖ Á¨¨ 1 Â§©</div>
        <!-- Ë≥áÊ∫êÈ†ÖÁõÆÂãïÊÖãÊ∏≤Êüì -->
      </div>
      <div class="progress-wrap">
        <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
        <span class="progress-text" id="progress-text">0%</span>
      </div>
      <!-- ‰∏ÄËá¥ÊÄß‰øÆÂæ©ÊèêÁ§∫Ê¢ù -->
      <div id="consistency-fix-banner" style="display:none;background:linear-gradient(135deg,#F59E0B,#FBBF24);color:white;padding:10px 16px;font-size:13px;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(0,0,0,0.1)">
        <div style="display:flex;align-items:center;gap:8px;flex:1">
          <span style="font-size:16px">üîß</span>
          <div style="flex:1">
            <div style="font-weight:600;margin-bottom:2px">AI ‰∏ÄËá¥ÊÄß‰øÆÂæ©‰∏≠</div>
            <div style="font-size:11px;opacity:0.9" id="consistency-fix-info">Ââ©È§ò 3 Ê¨°Â∞çË©±</div>
          </div>
        </div>
        <button onclick="cancelConsistencyFix()" style="background:rgba(255,255,255,0.2);border:none;color:white;padding:4px 12px;border-radius:6px;font-size:12px;cursor:pointer;font-weight:500">ÂèñÊ∂à</button>
      </div>
      <div class="content" id="content-area"></div>
      <div class="quick-cmds" id="quick-cmds">
        <!-- ÂãïÊÖãÊ∏≤Êüì -->
      </div>
      <div class="persona-bar">
        <div class="persona-selector" onclick="showPersonaSelector()">
          <span class="persona-avatar" id="current-persona-avatar">üë§</span>
          <div class="persona-info">
            <div class="persona-label">Áï∂ÂâçË∫´‰ªΩ</div>
            <div class="persona-name" id="current-persona-name">ÁÑ°ÁâπÂÆöË∫´‰ªΩ</div>
          </div>
          <span class="persona-dropdown">‚ñº</span>
        </div>
      </div>
      <div class="input-bar">
        <div class="input-wrap"><input type="text" class="input-field" id="user-input" placeholder="Ëº∏ÂÖ•‰Ω†ÁöÑË°åÂãïÊàñÂ∞çË©±..." onkeydown="handleInputKey(event)"></div>
        <button class="send-btn" id="send-btn" onclick="send()">‚Üë</button>
      </div>
    </div>
    <!-- Ë≥áÊñôÂ∫´ -->
    <div class="view" id="view-lore">
      <div class="nav">
        <div class="nav-back" onclick="goBack()" role="button" tabindex="0" aria-label="ËøîÂõû">‚Äπ</div>
        <span class="nav-title">‰∏ñÁïåËßÄË≥áÊñôÂ∫´</span>
        <div class="nav-right">
          <div class="nav-btn" onclick="aiExtractLore()" role="button" tabindex="0" title="AIÊèêÂèñ">ü§ñ</div>
          <div class="nav-btn" onclick="addLore()" role="button" tabindex="0" title="Ê∑ªÂä†">‚ûï</div>
        </div>
      </div>
      <div class="search-bar">
        <div class="search-wrap">
          <span style="color:var(--text-tertiary)">üîç</span>
          <input type="text" class="search-input" placeholder="ÊêúÁ¥¢Ë≥áÊñô" id="lore-search" oninput="filterLore()">
        </div>
      </div>
      <div class="scroll sys" id="lore-list" style="padding-bottom:20px"></div>
      <div class="input-bar" style="justify-content:center">
        <span style="font-size:12px;color:var(--text-tertiary)" id="lore-count">Â∑≤ÈÅ∏ 0 È†Ö</span>
      </div>
    </div>
    <!-- ÊôÇÈñìËª∏ -->
    <div class="view" id="view-timeline">
      <div class="nav">
        <div class="nav-back" onclick="goBack()" role="button" tabindex="0" aria-label="ËøîÂõû">‚Äπ</div>
        <span class="nav-title">ÊïÖ‰∫ãÊôÇÈñìËª∏</span>
        <div class="nav-right">
          <div class="nav-btn" onclick="addTimeline()" role="button" tabindex="0" title="Ê∑ªÂä†">‚ûï</div>
          <div class="nav-btn" onclick="timeJump()" role="button" tabindex="0" title="ÊôÇÈñìË∑≥Ë∫ç">‚è≠Ô∏è</div>
        </div>
      </div>
      <div class="scroll sys" id="timeline-content"></div>
    </div>
    <!-- ‰ºèÁ≠Ü/‰∫ã‰ª∂ -->
    <div class="view" id="view-foreshadow">
      <div class="nav">
        <div class="nav-back" onclick="goBack()" role="button" tabindex="0" aria-label="ËøîÂõû">‚Äπ</div>
        <span class="nav-title">‰ºèÁ≠ÜËàá‰∫ã‰ª∂</span>
        <div class="nav-right">
          <div class="nav-btn" onclick="aiAnalyzeForeshadow()" role="button" tabindex="0" title="AIÂàÜÊûê">ü§ñ</div>
          <div class="nav-btn" onclick="addForeshadowOrEvent()" role="button" tabindex="0" title="Ê∑ªÂä†">‚ûï</div>
        </div>
      </div>
      <div class="tabs-bar">
        <button class="tab-btn active" onclick="switchFTab('foreshadow',this)">‰ºèÁ≠Ü</button>
        <button class="tab-btn" onclick="switchFTab('events',this)">‰∫ã‰ª∂</button>
      </div>
      <div class="scroll sys" id="foreshadow-content"></div>
    </div>
    <!-- Â≠òÊ™î -->
    <div class="view" id="view-saves">
      <div class="nav">
        <div class="nav-back" onclick="goBack()" role="button" tabindex="0" aria-label="ËøîÂõû">‚Äπ</div>
        <span class="nav-title">Â≠òÊ™îÁÆ°ÁêÜ</span>
        <div class="nav-right"><div class="nav-btn" onclick="toast(T('Â≠òÊ™îË®≠ÁΩÆ'))" role="button" tabindex="0" title="Ë®≠ÁΩÆ">‚öôÔ∏è</div></div>
      </div>
      <div class="scroll sys" id="saves-content"></div>
      <div class="input-bar"><button class="action-btn primary" style="flex:1" onclick="createSave()">üíæ ÂâµÂª∫Êñ∞Â≠òÊ™î</button></div>
    </div>
    <!-- ÊêúÁ¥¢ -->
    <div class="view" id="view-search">
      <div class="nav">
        <div class="nav-back" onclick="goBack()" role="button" tabindex="0" aria-label="ËøîÂõû">‚Äπ</div>
        <span class="nav-title">ÊêúÁ¥¢</span>
        <div class="nav-right"><div class="nav-btn" style="font-size:13px;width:auto;padding:0 8px" onclick="showAdvancedSearch()" role="button" tabindex="0" title="È´òÁ¥öÊêúÁ¥¢">È´òÁ¥ö</div></div>
      </div>
      <div class="search-bar">
        <div class="search-wrap">
          <span style="color:var(--text-tertiary)">üîç</span>
          <input type="text" class="search-input" placeholder="ÊêúÁ¥¢ÊïÖ‰∫ãÂÖßÂÆπ" id="content-search" oninput="doContentSearch()">
        </div>
      </div>
      <div class="scroll sys" id="search-results"><div class="empty"><div class="empty-icon">üîç</div><div class="empty-title">Ëº∏ÂÖ•ÈóúÈçµË©ûÊêúÁ¥¢</div></div></div>
    </div>
    <!-- Êåá‰ª§ÁÆ°ÁêÜ -->
    <div class="view" id="view-instructions">
      <div class="list-nav">
        <span class="list-nav-title" style="background:none;-webkit-text-fill-color:var(--text-primary)">Êåá‰ª§ÁÆ°ÁêÜ</span>
        <div style="display:flex;gap:4px">
          <div class="nav-btn" onclick="startAnalyze()" title="ÂàÜÊûêPrompt" role="button" tabindex="0">üîç</div>
          <div class="nav-btn" onclick="startWizard()" title="AIÁîüÊàêÊåá‰ª§" role="button" tabindex="0">ü™Ñ</div>
          <div class="nav-btn" onclick="importInst()" role="button" tabindex="0" title="Â∞éÂÖ•">‚ûï</div>
        </div>
      </div>
      <div class="scroll sys" id="inst-list"></div>
      <div class="tab-bar">
        <div class="tab-item" onclick="switchTab('stories')" role="button" tabindex="0"><span class="tab-icon">üìö</span><span class="tab-label">ÊïÖ‰∫ã</span></div>
        <div class="tab-item active" onclick="switchTab('instructions')" role="button" tabindex="0"><span class="tab-icon">üìú</span><span class="tab-label">Êåá‰ª§</span></div>
        <div class="tab-item" onclick="switchTab('settings')" role="button" tabindex="0"><span class="tab-icon">‚öôÔ∏è</span><span class="tab-label">Ë®≠ÁΩÆ</span></div>
      </div>
    </div>
    <!-- Ë®≠ÁΩÆ -->
    <div class="view" id="view-settings">
      <div class="list-nav">
        <span class="list-nav-title" style="background:none;-webkit-text-fill-color:var(--text-primary)">Ë®≠ÁΩÆ</span>
      </div>
      <div class="scroll sys" style="padding-bottom:80px">
        <div class="settings-section">
          <div class="settings-section-title">üé® Â§ñËßÄ</div>
          <div class="settings-card">
            <div class="settings-item" onclick="toggleTheme()"><span class="settings-item-label">‰∏ªÈ°å</span><span class="settings-item-value" id="theme-val">Ê∑±Ëâ≤Ê®°Âºè ‚Ä∫</span></div>
            <div class="settings-item" onclick="toggleScreen()"><span class="settings-item-label">Â±èÂπïÊ®°Âºè</span><span class="settings-item-value" id="screen-val">ÊâãÊ©üÊ®°Êì¨Âô® ‚Ä∫</span></div>
            <div class="settings-item" onclick="setChatBackground()"><span class="settings-item-label">ËÅäÂ§©ËÉåÊôØ</span><span class="settings-item-value" id="chat-bg-val">ÈªòË™ç ‚Ä∫</span></div>
            <div class="settings-item" onclick="showFontSettings()"><span class="settings-item-label">Â≠óÈ´îÂ§ßÂ∞è</span><span class="settings-item-value" id="font-size-val">16px ‚Ä∫</span></div>
            <div class="settings-item" onclick="showLineHeightSettings()"><span class="settings-item-label">Ë°åÈñìË∑ù</span><span class="settings-item-value" id="line-height-val">1.8x ‚Ä∫</span></div>
            <div class="settings-item" onclick="showParagraphSpacingSettings()"><span class="settings-item-label">ÊÆµËêΩÈñìË∑ù</span><span class="settings-item-value" id="paragraph-spacing-val">1em ‚Ä∫</span></div>
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">ü§ñ AIË®≠ÁΩÆ</div>
          <div class="settings-card">
            <div class="settings-item" onclick="goTo('view-api')"><span class="settings-item-label">API È†êË®≠ÁÆ°ÁêÜ</span><span class="settings-item-value">‚Ä∫</span></div>
            <div class="settings-item" onclick="showContextSettings()"><span class="settings-item-label">‰∏ä‰∏ãÊñáË®≠ÁΩÆ</span><span class="settings-item-value" id="context-val">20Ê¢ùÊ∂àÊÅØ ‚Ä∫</span></div>
            <div class="settings-item" onclick="showCharacterSelectionSettings()"><span class="settings-item-label">üë• Êô∫ËÉΩËßíËâ≤ÈÅ∏Êìá</span><span class="settings-item-value" id="char-selection-val">Â∑≤ÈñãÂïü ‚Ä∫</span></div>
            <div class="settings-item" onclick="showMaxTokensSettings()"><span class="settings-item-label">ÊúÄÂ§ßÁîüÊàêÈï∑Â∫¶</span><span class="settings-item-value" id="max-tokens-val">4096 ‚Ä∫</span></div>
            <div class="settings-item" onclick="showStreamingSettings()"><span class="settings-item-label">ÊµÅÂºèÈüøÊáâ</span><span class="settings-item-value" id="streaming-val">Â∑≤ÈñãÂïü ‚Ä∫</span></div>
            <div class="settings-item" onclick="showDefaultAIParams()"><span class="settings-item-label">AI ÂèÉÊï∏ÈªòË™çÂÄº</span><span class="settings-item-value" id="ai-params-val">T:0.8 ‚Ä∫</span></div>
            <div class="settings-item" onclick="showTemplateVarsSettings()"><span class="settings-item-label">Ê®°ÊùøËÆäÈáè</span><span class="settings-item-value" id="template-vars-val">Ë®≠ÁΩÆ ‚Ä∫</span></div>
            <div class="settings-item"><span class="settings-item-label">‰∏ÄËá¥ÊÄßÊ™¢Êü•</span><div class="toggle active" id="tog-consist" onclick="toggleSet('consist')"></div></div>
            <div class="settings-item"><span class="settings-item-label">Ëá™ÂãïÁ´†ÁØÄÁ∏ΩÁµê</span><div class="toggle active" id="tog-summary" onclick="toggleSet('summary')"></div></div>
            <div class="settings-item"><span class="settings-item-label">Ëá™ÂãïÁîüÊàêÊëòË¶Å</span><div class="toggle active" id="tog-autoSummary" onclick="toggleSet('autoSummary')"></div></div>
            <div class="settings-item" onclick="showAutoSummaryFrequencySettings()"><span class="settings-item-label">ÊëòË¶ÅÁîüÊàêÈ†ªÁéá</span><span class="settings-item-value" id="auto-summary-freq-val">ÊØè15Ê¢ùÊ∂àÊÅØ ‚Ä∫</span></div>
            <div class="settings-item"><span class="settings-item-label">ü§ñ AIÊô∫ËÉΩÊèêÂèñLorebook</span><div class="toggle" id="tog-autoLorebook" onclick="toggleSet('autoLorebook')"></div></div>
            <div class="settings-item" onclick="showAutoLorebookFrequencySettings()"><span class="settings-item-label">üìä LorebookÊèêÂèñÈ†ªÁéá</span><span class="settings-item-value" id="auto-lorebook-freq-val">ÊØè10Ê¢ùÊ∂àÊÅØ ‚Ä∫</span></div>
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">‚å®Ô∏è Ëº∏ÂÖ•</div>
          <div class="settings-card">
            <div class="settings-item" onclick="showTypingSpeedSettings()"><span class="settings-item-label">ÊâìÂ≠óÊ©üÊïàÊûú</span><span class="settings-item-value" id="typing-speed-val">30ms ‚Ä∫</span></div>
            <div class="settings-item" onclick="toggleSendKey()"><span class="settings-item-label">ÁôºÈÄÅÂø´Êç∑Èçµ</span><span class="settings-item-value" id="send-key-val">Enter ‚Ä∫</span></div>
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">üåê Ë™ûË®Ä</div>
          <div class="settings-card">
            <div class="settings-item" onclick="showChineseConvertSettings()"><span class="settings-item-label">Ë™ûË®ÄË®≠ÁΩÆ</span><span class="settings-item-value" id="cn-convert-val">ÁÆÄ‰Ωì ‚Ä∫</span></div>
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">üíæ Êï∏Êìö</div>
          <div class="settings-card">
            <div class="settings-item" onclick="showCloudSyncSettings()"><span class="settings-item-label">‚òÅÔ∏è Èõ≤Á´ØÂêåÊ≠•Ë®≠ÁΩÆ</span><span class="settings-item-value" id="cloud-sync-status">Êú™Ë®≠ÁΩÆ ‚Ä∫</span></div>
            <div class="settings-item" onclick="uploadToCloud()"><span class="settings-item-label">‚òÅÔ∏è ‰∏äÂÇ≥Âà∞Èõ≤Á´Ø</span><span class="settings-item-value">‚Ä∫</span></div>
            <div class="settings-item" onclick="downloadFromCloud()"><span class="settings-item-label">‚òÅÔ∏è ÂæûÈõ≤Á´Ø‰∏ãËºâ</span><span class="settings-item-value">‚Ä∫</span></div>
            <div class="settings-item" onclick="exportAll()"><span class="settings-item-label">Â∞éÂá∫ÊâÄÊúâÊï∏Êìö</span><span class="settings-item-value">‚Ä∫</span></div>
            <div class="settings-item" onclick="importAll()"><span class="settings-item-label">Â∞éÂÖ•Êï∏Êìö</span><span class="settings-item-value">‚Ä∫</span></div>
            <div class="settings-item" onclick="exportBookTemplate()"><span class="settings-item-label">üìã Â∞éÂá∫Êõ∏Á±çÊ†ºÂºèÊ®°Êùø</span><span class="settings-item-value">‚Ä∫</span></div>
            <div class="settings-item danger" onclick="clearAll()"><span class="settings-item-label">Ê∏ÖÁ©∫ÊâÄÊúâÊï∏Êìö</span><span class="settings-item-value">‚Ä∫</span></div>
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">üì± ÊáâÁî®</div>
          <div class="settings-card">
            <div class="settings-item" onclick="installPWA()"><span class="settings-item-label">ÂÆâË£ùÂà∞Ê°åÈù¢</span><span class="settings-item-value" id="pwa-install-status">‚Ä∫</span></div>
            <div class="settings-item" onclick="debugApiTest()"><span class="settings-item-label">üîß API ÈÄ£Êé•Ë™øË©¶</span><span class="settings-item-value">‚Ä∫</span></div>
            <div class="settings-item"><span class="settings-item-label">ÈóúÊñºÁπîÂ§¢</span><span class="settings-item-value">v6.1 ‚Ä∫</span></div>
          </div>
        </div>
      </div>
      <div class="tab-bar">
        <div class="tab-item" onclick="switchTab('stories')" role="button" tabindex="0"><span class="tab-icon">üìö</span><span class="tab-label">ÊïÖ‰∫ã</span></div>
        <div class="tab-item" onclick="switchTab('instructions')" role="button" tabindex="0"><span class="tab-icon">üìú</span><span class="tab-label">Êåá‰ª§</span></div>
        <div class="tab-item active" onclick="switchTab('settings')" role="button" tabindex="0"><span class="tab-icon">‚öôÔ∏è</span><span class="tab-label">Ë®≠ÁΩÆ</span></div>
      </div>
    </div>
    <!-- APIË®≠ÁΩÆ -->
    <div class="view" id="view-api">
      <div class="nav">
        <div class="nav-back" onclick="goBack()" role="button" tabindex="0" aria-label="ËøîÂõû">‚Äπ</div>
        <span class="nav-title">API È†êË®≠ÁÆ°ÁêÜ</span>
        <div class="nav-right"><div class="nav-btn" onclick="addApi()" role="button" tabindex="0" title="Ê∑ªÂä†">‚ûï</div></div>
      </div>
      <div class="scroll sys" id="api-list"></div>
    </div>
    <!-- Á´†ÁØÄÁÆ°ÁêÜ -->
    <div class="view" id="view-chapters">
      <div class="nav">
        <div class="nav-back" onclick="goBack()" role="button" tabindex="0" aria-label="ËøîÂõû">‚Äπ</div>
        <span class="nav-title">Á´†ÁØÄÁÆ°ÁêÜ</span>
        <div class="nav-right"><div class="nav-btn" onclick="addChapter()" role="button" tabindex="0" title="Ê∑ªÂä†Á´†ÁØÄ">‚ûï</div></div>
      </div>
      <div class="scroll sys" id="chapter-list"></div>
    </div>
    <!-- Êõ∏Á±§ÂàóË°® -->
    <div class="view" id="view-bookmarks">
      <div class="nav">
        <div class="nav-back" onclick="goBack()" role="button" tabindex="0" aria-label="ËøîÂõû">‚Äπ</div>
        <span class="nav-title">Êõ∏Á±§ÂàóË°®</span>
        <div class="nav-right"></div>
      </div>
      <div class="scroll sys" id="bookmark-list"></div>
    </div>
    <!-- ËÉåÂåÖÁ≥ªÁµ± -->
    <div class="view" id="view-inventory">
      <div class="nav">
        <div class="nav-back" onclick="goBack()" role="button" tabindex="0" aria-label="ËøîÂõû">‚Äπ</div>
        <span class="nav-title">üéí ËÉåÂåÖ</span>
        <div class="nav-right">
          <div class="nav-btn" onclick="aiSyncInventory()" title="AIÊô∫ËÉΩÂêåÊ≠•" role="button" tabindex="0">ü§ñ</div>
          <div class="nav-btn" onclick="addInventoryItem()" role="button" tabindex="0" title="Ê∑ªÂä†Áâ©ÂìÅ">‚ûï</div>
        </div>
      </div>
      <div style="padding:8px 16px;background:var(--bg-secondary);border-bottom:1px solid var(--divider)">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input type="text" class="form-input" id="inventory-search" placeholder="üîç ÊêúÁ¥¢Áâ©ÂìÅ..." style="flex:1;min-width:120px;padding:6px 10px;font-size:13px" oninput="filterInventory()">
          <select class="form-input" id="inventory-filter" style="padding:6px 10px;font-size:13px" onchange="filterInventory()">
            <option value="all">ÂÖ®ÈÉ®</option>
            <option value="weapon">‚öîÔ∏è Ê≠¶Âô®</option>
            <option value="armor">üõ°Ô∏è Èò≤ÂÖ∑</option>
            <option value="consumable">üß™ Ê∂àËÄóÂìÅ</option>
            <option value="material">üì¶ ÊùêÊñô</option>
            <option value="key">üîë ÈóúÈçµÁâ©ÂìÅ</option>
            <option value="other">üìã ÂÖ∂‰ªñ</option>
          </select>
        </div>
      </div>
      <div class="scroll sys" id="inventory-list" style="padding:12px 16px"></div>
    </div>
    <!-- ÂàÜÊîØÁÆ°ÁêÜ -->
    <div class="view" id="view-branches">
      <div class="nav">
        <div class="nav-back" onclick="goBack()" role="button" tabindex="0" aria-label="ËøîÂõû">‚Äπ</div>
        <span class="nav-title">ÂàÜÊîØÁÆ°ÁêÜ</span>
        <div class="nav-right"><div class="nav-btn" onclick="createBranch()" role="button" tabindex="0" title="ÂâµÂª∫ÂàÜÊîØ">‚ûï</div></div>
      </div>
      <div class="scroll sys" id="branch-list"></div>
    </div>
    <!-- Lorebook Ë®≠ÂÆöÂ∫´ -->
    <div class="view" id="view-lorebook">
      <div class="nav">
        <div class="nav-back" onclick="goBack()" role="button" tabindex="0" aria-label="ËøîÂõû">‚Äπ</div>
        <span class="nav-title">üîÆ Lorebook</span>
        <div class="nav-right">
          <div class="nav-btn" onclick="showAiLorebookModal()" title="AIÁîüÊàê" role="button" tabindex="0">ü§ñ</div>
          <div class="nav-btn" onclick="importFromLore()" title="ÂæûË≥áÊñôÂ∫´Â∞éÂÖ•" role="button" tabindex="0">üì•</div>
          <div class="nav-btn" onclick="addLorebook()" role="button" tabindex="0" title="Ê∑ªÂä†">‚ûï</div>
        </div>
      </div>
      <div style="padding:8px 16px;background:var(--bg-secondary);border-bottom:1px solid var(--divider)">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <div style="flex:1;position:relative">
            <span style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text-tertiary)">üîç</span>
            <input type="text" id="lorebook-search-input" placeholder="ÊêúÁ¥¢Ê¢ùÁõÆ..." oninput="filterLorebook()" style="width:100%;padding:8px 8px 8px 32px;border:1px solid var(--divider);border-radius:8px;background:var(--bg-primary);font-size:14px;box-sizing:border-box">
          </div>
          <select id="lorebook-filter-status" onchange="filterLorebook()" style="padding:8px;border:1px solid var(--divider);border-radius:8px;background:var(--bg-primary);font-size:13px">
            <option value="all">ÂÖ®ÈÉ®</option>
            <option value="enabled">Â∑≤ÂïüÁî®</option>
            <option value="disabled">Â∑≤Á¶ÅÁî®</option>
          </select>
        </div>
        <div style="font-size:12px;color:var(--text-tertiary)">Áï∂Â∞çË©±ÂåÖÂê´ÈóúÈçµË©ûÊôÇÔºåËá™ÂãïÊ≥®ÂÖ•Áõ∏ÈóúË®≠ÂÆöÂà∞ AI ‰∏ä‰∏ãÊñá</div>
      </div>
      <div class="scroll sys" id="lorebook-list"></div>
    </div>
    <!-- v7: ËßíËâ≤Âç°ÁâáË¶ñÂúñ -->
    <div class="view" id="view-characters">
      <div class="nav">
        <div class="nav-back" onclick="goBack()" role="button" tabindex="0" aria-label="ËøîÂõû">‚Äπ</div>
        <span class="nav-title">ËßíËâ≤ÁãÄÊÖã</span>
        <div class="nav-right">
          <div class="nav-btn" onclick="toggleCharBatchMode()" title="ÊâπÈáèÊìç‰Ωú" id="char-batch-btn" role="button" tabindex="0">‚òëÔ∏è</div>
          <div class="nav-btn" onclick="showCharacterMenu()" title="Êõ¥Â§ö" role="button" tabindex="0">‚ãØ</div>
          <div class="nav-btn" onclick="addCharacterManual()" title="ÊâãÂãïÊ∑ªÂä†" role="button" tabindex="0">‚ûï</div>
        </div>
      </div>
      <!-- v25: ÊêúÁ¥¢ÂíåÁ≠õÈÄâÊ†è -->
      <div class="char-filter-bar">
        <div class="char-search-wrap">
          <span class="char-search-icon">üîç</span>
          <input type="text" class="char-search-input" id="char-search-input" placeholder="ÊêúÁ¥¢ËßíËâ≤..." oninput="filterCharacters()">
        </div>
        <select class="char-filter-select" id="char-filter-category" onchange="filterCharacters()">
          <option value="all">ÂÖ®ÈÉ®ÂàÜÈ°û</option>
          <option value="protagonist">‚≠ê ‰∏ªËßí</option>
          <option value="supporting">üë§ ÈÖçËßí</option>
          <option value="npc">üë• NPC</option>
        </select>
      </div>
      <!-- v25: ÊâπÈáèÊìç‰ΩúÊ†èÔºàÈªòËÆ§ÈöêËóèÔºâ -->
      <div class="char-batch-bar" id="char-batch-bar" style="display:none">
        <label class="char-batch-select-all">
          <input type="checkbox" id="char-select-all" onchange="toggleSelectAllChars()">
          <span>ÂÖ®ÈÅ∏</span>
        </label>
        <span class="char-batch-count" id="char-batch-count">Â∑≤ÈÅ∏ 0 ÂÄã</span>
        <div class="char-batch-actions">
          <button class="char-batch-btn" onclick="batchDeleteChars()">üóëÔ∏è Âà™Èô§</button>
          <button class="char-batch-btn" onclick="batchExportChars()">üì§ Â∞éÂá∫</button>
        </div>
      </div>
      <div class="scroll sys" id="character-list" style="position:relative"></div>
      <div class="input-bar" style="justify-content:space-between;padding:8px 16px">
        <span style="font-size:12px;color:var(--text-tertiary)" id="char-count">0 ‰ΩçËßíËâ≤</span>
        <button class="action-btn primary" style="padding:8px 16px;font-size:13px" onclick="showAICharacterUpdate()">ü§ñ AI Êõ¥Êñ∞ÁãÄÊÖã</button>
      </div>
    </div>
    <!-- Êåá‰ª§ÁîüÊàêÂêëÂ∞é -->
    <div class="view" id="view-wizard">
      <div class="nav">
        <div class="nav-back" onclick="exitWizard()" role="button" tabindex="0" aria-label="ÈÄÄÂá∫">‚Äπ</div>
        <span class="nav-title" id="wizard-title">Êåá‰ª§ÁîüÊàêÂêëÂ∞é</span>
        <div class="nav-right">
          <div class="nav-btn" onclick="showWizardHelp()" title="Âπ´Âä©" role="button" tabindex="0">‚ùì</div>
        </div>
      </div>
      <div class="wizard-progress">
        <div class="wizard-progress-bar"><div class="wizard-progress-fill" id="wizard-progress-fill" style="width:12.5%"></div></div>
        <span class="wizard-progress-text" id="wizard-progress-text">1/8 Âü∫Á§éË®≠ÂÆö</span>
      </div>
      <div class="wizard-content" id="wizard-content">
        <!-- ÂãïÊÖãÂÖßÂÆπ -->
      </div>
      <div class="wizard-footer">
        <button class="wizard-btn secondary" id="wizard-prev" onclick="wizardPrev()" disabled>‰∏ä‰∏ÄÊ≠•</button>
        <button class="wizard-btn primary" id="wizard-next" onclick="wizardNext()">‰∏ã‰∏ÄÊ≠•</button>
      </div>
    </div>
    <!-- Prompt ÂàÜÊûêÈ†ÅÈù¢ -->
    <div class="view" id="view-analyze">
      <div class="nav">
        <div class="nav-back" onclick="goBack()" role="button" tabindex="0" aria-label="ËøîÂõû">‚Äπ</div>
        <span class="nav-title">Prompt ÂàÜÊûê</span>
        <div class="nav-right">
          <div class="nav-btn" onclick="showAnalyzeHelp()" title="Âπ´Âä©" role="button" tabindex="0">‚ùì</div>
        </div>
      </div>
      <div class="wizard-content" id="analyze-content">
        <!-- ÂãïÊÖãÂÖßÂÆπ -->
      </div>
    </div>
  </div>
</div>
<!-- Ê≤âÊµ∏Ê®°Âºè -->
<div class="immersive" id="immersive">
  <div class="immersive-content" id="immersive-content" onclick="nextImm()"></div>
  <div class="immersive-footer">
    <div class="immersive-progress"><div class="immersive-progress-fill" id="imm-progress"></div></div>
    <span class="immersive-hint">ËºïËß∏ÁπºÁ∫å ‚ñ∂</span>
    <div class="immersive-close" onclick="exitImm()">‚úï</div>
  </div>
</div>
<!-- Èö±ËóèÁöÑÊñá‰ª∂Ëº∏ÂÖ• -->
<input type="file" id="image-upload" accept="image/*" style="display:none" onchange="handleImageUpload(event)">
<input type="file" id="analyze-file" accept=".txt,.md,.docx" style="display:none" onchange="handleAnalyzeFile(event)">
<!-- ÈÅÆÁΩ© -->
<div class="overlay" id="overlay" onclick="closeAll()"></div>
<!-- Â∫ïÈÉ®Èù¢Êùø -->
<div class="bottom-sheet" id="sheet">
  <div class="bottom-sheet-handle"></div>
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
    <div class="bottom-sheet-title" style="margin:0">ÊïÖ‰∫ãË®≠ÁΩÆ</div>
    <button onclick="closeAll()" style="background:none;border:none;font-size:24px;color:var(--text-tertiary);cursor:pointer;padding:4px 8px;line-height:1">‚úï</button>
  </div>
  <div class="sheet-grid">
    <div class="sheet-item" onclick="renameCurrentStory()" role="button" tabindex="0"><div class="sheet-item-icon">‚úèÔ∏è</div><div class="sheet-item-label">ÈáçÂëΩÂêç</div></div>
    <div class="sheet-item" onclick="goTo('view-characters');closeAll()" role="button" tabindex="0"><div class="sheet-item-icon">üë•</div><div class="sheet-item-label">ËßíËâ≤ÁãÄÊÖã</div></div>
    <div class="sheet-item" onclick="showRelationshipGraph()" role="button" tabindex="0"><div class="sheet-item-icon">üï∏Ô∏è</div><div class="sheet-item-label">Èóú‰øÇÂúñË≠ú</div></div>
    <div class="sheet-item" onclick="showSceneManager()" role="button" tabindex="0"><div class="sheet-item-icon">üé¨</div><div class="sheet-item-label">Â†¥ÊôØÁÆ°ÁêÜ</div></div>
    <div class="sheet-item" onclick="showPlayerPanel()" role="button" tabindex="0"><div class="sheet-item-icon">üë§</div><div class="sheet-item-label">ÊàëÁöÑÁãÄÊÖã</div></div>
    <div class="sheet-item" onclick="goTo('view-inventory');closeAll()" role="button" tabindex="0"><div class="sheet-item-icon">üéí</div><div class="sheet-item-label">ËÉåÂåÖ</div></div>
    <div class="sheet-item" onclick="goTo('view-timeline');closeAll()" role="button" tabindex="0"><div class="sheet-item-icon">üìÖ</div><div class="sheet-item-label">ÊôÇÈñìËª∏</div></div>
    <div class="sheet-item" onclick="goTo('view-foreshadow');closeAll()" role="button" tabindex="0"><div class="sheet-item-icon">üìå</div><div class="sheet-item-label">‰ºèÁ≠Ü‰∫ã‰ª∂</div></div>
    <div class="sheet-item" onclick="goTo('view-chapters');closeAll()" role="button" tabindex="0"><div class="sheet-item-icon">üìë</div><div class="sheet-item-label">Á´†ÁØÄÁÆ°ÁêÜ</div></div>
    <div class="sheet-item" onclick="goTo('view-bookmarks');closeAll()" role="button" tabindex="0"><div class="sheet-item-icon">üîñ</div><div class="sheet-item-label">Êõ∏Á±§ÂàóË°®</div></div>
    <div class="sheet-item" onclick="goTo('view-saves');closeAll()" role="button" tabindex="0"><div class="sheet-item-icon">üíæ</div><div class="sheet-item-label">Â≠òÊ™îÁÆ°ÁêÜ</div></div>
    <div class="sheet-item" onclick="goTo('view-branches');closeAll()" role="button" tabindex="0"><div class="sheet-item-icon">üîÄ</div><div class="sheet-item-label">ÂàÜÊîØÁÆ°ÁêÜ</div></div>
    <div class="sheet-item" onclick="goTo('view-lorebook');closeAll()" role="button" tabindex="0"><div class="sheet-item-icon">üîÆ</div><div class="sheet-item-label">Lorebook</div></div>
    <div class="sheet-item" onclick="showStoryAIParams()" role="button" tabindex="0"><div class="sheet-item-icon">üéõÔ∏è</div><div class="sheet-item-label">AIÂèÉÊï∏</div></div>
    <div class="sheet-item" onclick="showMemoryManager()" role="button" tabindex="0"><div class="sheet-item-icon">üß†</div><div class="sheet-item-label">Ë®òÊÜ∂ÁÆ°ÁêÜ</div></div>
    <div class="sheet-item" onclick="showFindReplace()" role="button" tabindex="0"><div class="sheet-item-icon">üîç</div><div class="sheet-item-label">Êü•ÊâæÊõøÊèõ</div></div>
    <div class="sheet-item" onclick="showStats()" role="button" tabindex="0"><div class="sheet-item-icon">üìä</div><div class="sheet-item-label">Áµ±Ë®àÈù¢Êùø</div></div>
    <div class="sheet-item" onclick="enterImm()" role="button" tabindex="0"><div class="sheet-item-icon">üé≠</div><div class="sheet-item-label">Ê≤âÊµ∏Ê®°Âºè</div></div>
    <div class="sheet-item" onclick="exportStory()" role="button" tabindex="0"><div class="sheet-item-icon">üìÑ</div><div class="sheet-item-label">Â∞éÂá∫ Markdown</div></div>
    <div class="sheet-item" onclick="exportStoryJSON()" role="button" tabindex="0"><div class="sheet-item-icon">üì¶</div><div class="sheet-item-label">Â∞éÂá∫ÂÆåÊï¥Êï∏ÊìöÂåÖ</div></div>
    <div class="sheet-item" onclick="importStoryJSON()" role="button" tabindex="0"><div class="sheet-item-icon">üì•</div><div class="sheet-item-label">Â∞éÂÖ•ÊïÖ‰∫ãÊï∏ÊìöÂåÖ</div></div>
    <div class="sheet-item danger" onclick="restartStory()" role="button" tabindex="0"><div class="sheet-item-icon">üîÑ</div><div class="sheet-item-label">ÈáçÊñ∞ÈñãÂßã</div></div>
  </div>
</div>
<!-- Êõ¥Â§öËèúÂñÆ -->
<div class="context-menu" id="more-menu">
  <!-- v19: Á∂ìÁáüÊ®°ÂºèÈÅ∏È†Ö -->
  <div class="context-menu-item sim-only" onclick="showSimResourceModal();hideMenu()" style="display:none" role="menuitem" tabindex="0">üéÆ Ë≥áÊ∫êÁÆ°ÁêÜ</div>
  <div class="context-menu-item sim-only" onclick="simNextDay();hideMenu()" style="display:none" role="menuitem" tabindex="0">‚è≠Ô∏è ÈÄ≤ÂÖ•‰∏ã‰∏ÄÂ§©</div>
  <div class="context-menu-item sim-only" onclick="showSimImportModal();hideMenu()" style="display:none" role="menuitem" tabindex="0">üì• Â∞éÂÖ•Â≠òÊ™î</div>
  <div class="context-menu-item sim-only" onclick="showSimExportModal();hideMenu()" style="display:none" role="menuitem" tabindex="0">üì§ Â∞éÂá∫Â≠òÊ™î</div>
  <div class="context-menu-divider sim-only" style="display:none"></div>
  <div class="context-menu-item" onclick="aiConsistencyCheck();hideMenu()" role="menuitem" tabindex="0">üîç AI‰∏ÄËá¥ÊÄßÊ™¢Êü•</div>
  <div class="context-menu-item" onclick="aiChapterSummary();hideMenu()" role="menuitem" tabindex="0">üìù AIÁ´†ÁØÄÁ∏ΩÁµê</div>
</div>
<!-- Ê∂àÊÅØËèúÂñÆ -->
<div class="context-menu" id="msg-menu">
  <div class="context-menu-item" onclick="editMsg()" role="menuitem" tabindex="0">‚úèÔ∏è Á∑®ËºØ</div>
  <div class="context-menu-item" onclick="regenerateMsg()" role="menuitem" tabindex="0">üîÑ ÈáçÊñ∞ÁîüÊàê</div>
  <div class="context-menu-item" onclick="resendMsg()" role="menuitem" tabindex="0">üì§ ÈáçÊñ∞ÁôºÈÄÅ</div>
  <div class="context-menu-item" onclick="markForeshadow()" role="menuitem" tabindex="0">üìå Ê®ôË®ò‰ºèÁ≠Ü</div>
  <div class="context-menu-item" onclick="addPlotTag()" role="menuitem" tabindex="0">üè∑Ô∏è Ê∑ªÂä†Ê®ôÁ±§</div>
  <div class="context-menu-divider"></div>
  <div class="context-menu-item" onclick="rollbackTo()" role="menuitem" tabindex="0">‚Ü©Ô∏è ÂõûÊ∫ØÂà∞Ê≠§</div>
  <div class="context-menu-item" onclick="copyMsg()" role="menuitem" tabindex="0">üìã Ë§áË£Ω</div>
  <div class="context-menu-item" onclick="addBookmark()" role="menuitem" tabindex="0">üîñ Ê∑ªÂä†Êõ∏Á±§</div>
  <div class="context-menu-divider"></div>
  <div class="context-menu-item danger" onclick="deleteMsg()" role="menuitem" tabindex="0">üóëÔ∏è Âà™Èô§Ê∂àÊÅØ</div>
</div>
<!-- ËßíËâ≤ËèúÂñÆ -->
<div class="context-menu" id="char-menu">
  <div class="context-menu-item" onclick="showAICharacterUpdate();hideMenu()" role="menuitem" tabindex="0">üîÑ AI Êõ¥Êñ∞ÁãÄÊÖã</div>
  <div class="context-menu-divider"></div>
  <div class="context-menu-item" onclick="importCharacterCard();hideMenu()" role="menuitem" tabindex="0">üì• Â∞éÂÖ•ËßíËâ≤Âç°ÔºàÊñá‰ª∂Ôºâ</div>
  <div class="context-menu-item" onclick="importCharacterFromURL();hideMenu()" role="menuitem" tabindex="0">üîó Âæû URL Â∞éÂÖ•</div>
  <div class="context-menu-item" onclick="exportAllCharacters();hideMenu()" role="menuitem" tabindex="0">üì§ Â∞éÂá∫ÊâÄÊúâËßíËâ≤</div>
  <div class="context-menu-divider"></div>
  <div class="context-menu-item danger" onclick="clearAllCharacters();hideMenu()" role="menuitem" tabindex="0">üóëÔ∏è Ê∏ÖÁ©∫ÊâÄÊúâËßíËâ≤</div>
</div>
<!-- ÊïÖ‰∫ãËèúÂñÆ -->
<div class="context-menu" id="story-menu">
  <div class="context-menu-item" onclick="renameStoryFromMenu()" role="menuitem" tabindex="0">‚úèÔ∏è ÈáçÂëΩÂêç</div>
  <div class="context-menu-item" onclick="editStoryCover()" role="menuitem" tabindex="0">üñºÔ∏è Êõ¥ÊèõÂ∞ÅÈù¢</div>
  <div class="context-menu-item" onclick="toggleStoryPin()" role="menuitem" tabindex="0">üìå ÁΩÆÈ†Ç/ÂèñÊ∂àÁΩÆÈ†Ç</div>
  <div class="context-menu-divider"></div>
  <div class="context-menu-item danger" onclick="deleteStoryFromMenu()" role="menuitem" tabindex="0">üóëÔ∏è Âà™Èô§ÊïÖ‰∫ã</div>
</div>

<!-- Á¢∫Ë™çÊ°Ü -->
<div class="modal" id="confirm-modal" style="z-index:110">
  <div class="modal-title" id="confirm-title">Á¢∫Ë™ç</div>
  <div class="modal-content" id="confirm-content">Á¢∫ÂÆöË¶ÅÂü∑Ë°åÊ≠§Êìç‰ΩúÂóéÔºü</div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="cancelConfirm()">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" id="confirm-btn" onclick="confirmAction()">Á¢∫ÂÆö</button>
  </div>
</div>
<!-- Ëº∏ÂÖ•Ê°Ü -->
<div class="modal" id="input-modal" style="z-index:110">
  <div class="modal-title" id="input-title">Ëº∏ÂÖ•</div>
  <div class="modal-content" id="input-desc"></div>
  <input type="text" class="modal-input" id="modal-input" placeholder="">
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('input-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="confirmInput()">Á¢∫ÂÆö</button>
  </div>
</div>
<!-- Êñ∞Âª∫ÊïÖ‰∫ã -->
<div class="modal" id="new-story-modal" style="max-width:420px">
  <div class="modal-title">Êñ∞Âª∫ÊïÖ‰∫ã</div>
  <div class="form-group"><label class="form-label">ÊïÖ‰∫ãÊ®ôÈ°å</label><input type="text" class="form-input" id="new-title" placeholder="Ëº∏ÂÖ•ÊïÖ‰∫ãÊ®ôÈ°å"></div>
  <div class="form-group"><label class="form-label">Á∞°‰ªãÔºàÂèØÈÅ∏Ôºâ</label><textarea class="form-textarea" id="new-desc" placeholder="Á∞°ÂñÆÊèèËø∞ÈÄôÂÄãÊïÖ‰∫ã..."></textarea></div>
  <div class="form-group">
    <label class="form-label">ÊïÖ‰∫ãÊ®°Âºè</label>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <div class="mode-card active" id="mode-normal" onclick="selectStoryMode('normal')">
        <div style="font-size:24px;margin-bottom:4px">üìñ</div>
        <div style="font-weight:600;font-size:13px">ÊôÆÈÄöÊ®°Âºè</div>
        <div style="font-size:11px;color:var(--text-tertiary)">ËßíËâ≤ÁãÄÊÖãËøΩËπ§</div>
      </div>
      <div class="mode-card" id="mode-simulation" onclick="selectStoryMode('simulation')">
        <div style="font-size:24px;margin-bottom:4px">üéÆ</div>
        <div style="font-weight:600;font-size:13px">Á∂ìÁáüÊ®°Âºè</div>
        <div style="font-size:11px;color:var(--text-tertiary)">Ë≥áÊ∫êÈù¢Êùø+Â≠òÊ™î</div>
      </div>
    </div>
  </div>
  <div id="sim-mode-options" style="display:none">
    <div class="form-group">
      <label class="form-label">ÂàùÂßãË≥áÊ∫êÔºàÂèØÁ®çÂæåÁ∑®ËºØÔºâ</label>
      <div id="new-sim-resources" style="display:flex;flex-direction:column;gap:6px">
        <div style="display:flex;gap:6px;align-items:center">
          <input type="text" class="form-input" style="width:60px" placeholder="üí∞" maxlength="2" value="üí∞">
          <input type="text" class="form-input" style="flex:1" placeholder="ÂêçÁ®±" value="ÈáëÂπ£">
          <input type="number" class="form-input" style="width:80px" placeholder="Êï∏ÂÄº" value="10000">
          <button onclick="removeSimResource(this)" style="background:none;border:none;color:var(--error);cursor:pointer">‚úï</button>
        </div>
      </div>
      <button onclick="addSimResource()" style="margin-top:8px;background:var(--bg-tertiary);border:none;padding:6px 12px;border-radius:6px;color:var(--text-secondary);cursor:pointer;font-size:12px">‚ûï Ê∑ªÂä†Ë≥áÊ∫ê</button>
    </div>
  </div>
  <div class="form-group"><label class="form-label">Ê®ôÁ±§ÔºàÁ©∫Ê†ºÂàÜÈöîÔºâ</label><input type="text" class="form-input" id="new-tags" placeholder="ÂÆÆÈ¨• Âè§È¢® ÊàÄÊÑõ"></div>
  <div class="form-group"><label class="form-label">Á∂ÅÂÆöÊåá‰ª§</label><select class="form-select" id="new-inst"><option value="">‰∏çÁ∂ÅÂÆöÊåá‰ª§</option></select></div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('new-story-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveNewStory()">ÂâµÂª∫</button>
  </div>
</div>
<!-- APIË®≠ÁΩÆ -->
<div class="modal" id="api-modal" style="max-width:400px">
  <div class="modal-title">API Ë®≠ÁΩÆ</div>
  <div class="form-group"><label class="form-label">È†êË®≠ÂêçÁ®±</label><input type="text" class="form-input" id="api-name" placeholder="‰æãÂ¶Ç: Claude API"></div>
  <div class="form-group"><label class="form-label">API È°ûÂûã</label><select class="form-select" id="api-type" onchange="updateApiFields()"><option value="anthropic">Anthropic (Claude)</option><option value="openai">OpenAI (GPT)</option><option value="custom">Ëá™ÂÆöÁæ© API</option></select></div>
  <div class="form-group"><label class="form-label">API Key</label><input type="password" class="form-input" id="api-key" placeholder="sk-..."></div>
  <div class="form-group"><label class="form-label">Ê®°Âûã</label><input type="text" class="form-input" id="api-model" list="model-list" placeholder="ÈÅ∏ÊìáÊàñËº∏ÂÖ•Ê®°ÂûãÂêçÁ®±"><datalist id="model-list"><option value="claude-sonnet-4-20250514">Claude Sonnet 4</option><option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option><option value="claude-3-opus-20240229">Claude 3 Opus</option></datalist></div>
  <div class="form-group hidden" id="api-url-group"><label class="form-label">API URL</label><input type="text" class="form-input" id="api-url" placeholder="https://api.example.com"><div style="margin-top:6px"><label style="font-size:12px;color:var(--text-secondary);display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="api-url-autocomplete" checked> Ëá™ÂãïË£úÂÖ® /v1/chat/completions</label></div></div>
  <div class="form-group"><button type="button" class="action-btn secondary" style="width:100%" onclick="testApi()">üîó Ê∏¨Ë©¶ÈÄ£Êé•</button><div id="api-test-result" style="margin-top:8px;font-size:12px;display:none"></div></div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('api-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveApi()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- v19: Á∂ìÁáüÊ®°Âºè - Ë≥áÊ∫êÁÆ°ÁêÜ Modal -->
<div class="modal" id="sim-resource-modal" style="max-width:min(95%,420px)">
  <div class="modal-title">üéÆ Ë≥áÊ∫êÁÆ°ÁêÜ</div>
  <div style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">
    Ëá™ÂÆöÁæ©ËøΩËπ§ÁöÑË≥áÊ∫êÊï∏ÂÄºÔºåÊúÉÈ°ØÁ§∫Âú®È†ÇÈÉ®Èù¢Êùø
  </div>
  <div class="form-group">
    <label class="form-label">Áï∂ÂâçÂ§©Êï∏/ÂõûÂêà</label>
    <div style="display:flex;gap:8px;align-items:center">
      <input type="number" class="form-input" id="sim-current-day" min="1" value="1" style="width:100px">
      <button onclick="simDayMinus()" style="background:var(--bg-tertiary);border:none;padding:8px 12px;border-radius:6px;cursor:pointer">‚àí</button>
      <button onclick="simDayPlus()" style="background:var(--bg-tertiary);border:none;padding:8px 12px;border-radius:6px;cursor:pointer">+</button>
    </div>
  </div>
  <div class="form-group">
    <label class="form-label">Ë≥áÊ∫êÂàóË°®</label>
    <div id="sim-resource-list" style="display:flex;flex-direction:column;gap:8px;max-height:250px;overflow-y:auto">
      <!-- ÂãïÊÖãÊ∏≤Êüì -->
    </div>
    <button onclick="addSimResourceInModal()" style="margin-top:10px;background:var(--bg-tertiary);border:none;padding:8px 14px;border-radius:6px;color:var(--text-secondary);cursor:pointer;font-size:13px;width:100%">‚ûï Ê∑ªÂä†Êñ∞Ë≥áÊ∫ê</button>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('sim-resource-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveSimResources()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- v19: Á∂ìÁáüÊ®°Âºè - Â≠òÊ™îÂ∞éÂÖ• Modal -->
<div class="modal" id="sim-import-modal" style="max-width:min(95%,500px)">
  <div class="modal-title">üì• Â∞éÂÖ•Â≠òÊ™î</div>
  <div style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">
    Ë≤ºÂÖ•ÊñáÈÅä prompt ÁîüÊàêÁöÑÂ≠òÊ™îÂÖßÂÆπÔºåÊúÉËá™ÂãïËß£ÊûêË≥áÊ∫êÊï∏ÂÄº
  </div>
  <div class="form-group">
    <label class="form-label">Â≠òÊ™îÂÖßÂÆπ</label>
    <textarea class="form-input" id="sim-import-content" style="min-height:200px;font-family:monospace;font-size:12px" placeholder="Ë≤ºÂÖ•Â≠òÊ™îÂÖßÂÆπ..."></textarea>
  </div>
  <div class="form-group">
    <label class="form-label">Ëß£ÊûêË¶èÂâáÔºàÊ≠£ÂâáË°®ÈÅîÂºèÔºåÂèØÈÅ∏Ôºâ</label>
    <input type="text" class="form-input" id="sim-import-regex" placeholder="‰æãÂ¶ÇÔºöüí∞ ÁèæÈáëÔºö([\\d,]+)ÂÖÉ">
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">ÁïôÁ©∫Ââá‰ΩøÁî®ÈªòË™çË¶èÂâáËß£ÊûêÂ∏∏Ë¶ãÊ†ºÂºè</div>
  </div>
  <div id="sim-import-preview" style="display:none;background:var(--bg-tertiary);padding:12px;border-radius:8px;margin-bottom:12px">
    <div style="font-size:12px;font-weight:600;margin-bottom:8px">üìä Ëß£ÊûêÈ†êË¶Ω</div>
    <div id="sim-import-preview-content"></div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn" style="background:var(--bg-tertiary);color:var(--text-secondary)" onclick="parseSimImport()">üîç Ëß£ÊûêÈ†êË¶Ω</button>
    <button class="modal-btn cancel" onclick="closeModal('sim-import-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="applySimImport()">Â∞éÂÖ•</button>
  </div>
</div>
<!-- v19: Á∂ìÁáüÊ®°Âºè - Â≠òÊ™îÂ∞éÂá∫ Modal -->
<div class="modal" id="sim-export-modal" style="max-width:min(95%,500px)">
  <div class="modal-title">üì§ Â∞éÂá∫Â≠òÊ™î</div>
  <div style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">
    ÁîüÊàêÁï∂ÂâçÁãÄÊÖãÁöÑÂ≠òÊ™îÔºåÂèØË≤ºÂà∞Êñ∞Â∞çË©±ÁπºÁ∫åÈÅäÊà≤
  </div>
  <div class="form-group">
    <label class="form-label">Â≠òÊ™îÊ†ºÂºè</label>
    <select class="form-select" id="sim-export-format" onchange="generateSimExport()">
      <option value="simple">Á∞°ÊΩîÊ†ºÂºè</option>
      <option value="detailed">Ë©≥Á¥∞Ê†ºÂºè</option>
      <option value="custom">Ëá™ÂÆöÁæ©Ê®°Êùø</option>
    </select>
  </div>
  <div class="form-group" id="sim-export-template-group" style="display:none">
    <label class="form-label">Ëá™ÂÆöÁæ©Ê®°Êùø</label>
    <textarea class="form-input" id="sim-export-template" style="min-height:100px;font-family:monospace;font-size:12px" placeholder="‰ΩøÁî® {day} {resources} {summary} Á≠âËÆäÈáè"></textarea>
  </div>
  <div class="form-group">
    <label class="form-label">Â≠òÊ™îÂÖßÂÆπ</label>
    <textarea class="form-input" id="sim-export-content" style="min-height:200px;font-family:monospace;font-size:12px" readonly></textarea>
  </div>
  <div class="modal-actions">
    <button class="modal-btn" style="background:var(--bg-tertiary);color:var(--text-secondary)" onclick="copySimExport()">üìã Ë§áË£Ω</button>
    <button class="modal-btn confirm" onclick="closeModal('sim-export-modal')">ÂÆåÊàê</button>
  </div>
</div>
<!-- Toast -->
<div class="toast" id="toast"><span id="toast-text"></span></div>
<!-- Loading -->
<div class="loading" id="loading"><div class="loading-spinner"></div><div class="loading-text" id="loading-text">ËôïÁêÜ‰∏≠...</div></div>
<!-- ‰∏ä‰∏ãÊñáË®≠ÁΩÆ Modal -->
<div class="modal" id="context-modal">
  <div class="modal-title">‰∏ä‰∏ãÊñáË®≠ÁΩÆ</div>

  <div class="form-group">
    <label class="form-label">‰∏ä‰∏ãÊñáÊ∂àÊÅØÊï∏Èáè</label>
    <p style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">ÁôºÈÄÅÁµ¶ AI ÁöÑÊ≠∑Âè≤Ê∂àÊÅØÊï∏ÈáèÔºåË∂äÂ§öË∂äËÉΩÁêÜËß£‰∏ä‰∏ãÊñáÔºå‰ΩÜÊúÉÊ∂àËÄóÊõ¥Â§ö Token</p>
    <input type="number" class="form-input" id="context-count" min="1" max="500" placeholder="Ëº∏ÂÖ•Êï∏ÈáèÔºå‰æãÂ¶ÇÔºö20">
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">Âª∫Ë≠∞ÁØÑÂúçÔºö10-50ÔºåÊúÄÂ§ßÊîØÊåÅ 500</div>
  </div>

  <div class="form-group" style="margin-top:16px">
    <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
      <input type="checkbox" id="smart-context-enabled">
      <span class="form-label" style="margin:0">üß† ÂïüÁî®Êô∫ËÉΩ‰∏ä‰∏ãÊñáÈÅ∏Êìá</span>
    </label>
    <p style="font-size:12px;color:var(--text-tertiary);margin-top:8px">
      Êô∫ËÉΩÈÅ∏ÊìáÊúÄÁõ∏ÈóúÁöÑÊ∂àÊÅØÔºåËÄå‰∏çÂè™ÊòØÊúÄËøëÁöÑNÊ¢ù„ÄÇÂåÖÊã¨Ôºö<br>
      ‚Ä¢ ÊúÄËøëÁöÑÊ∂àÊÅØÔºà‰øùË≠âÈÄ£Ë≤´ÊÄßÔºâ<br>
      ‚Ä¢ ÈáçË¶ÅÊ®ôË®òÁöÑÊ∂àÊÅØÔºà‚≠êÔºâ<br>
      ‚Ä¢ È´òÂàÜÊ∂àÊÅØÔºàÂåÖÂê´ËßíËâ≤Âêç„ÄÅÈóúÈçµË©ûÁ≠âÔºâ
    </p>
  </div>

  <div id="smart-context-options" style="margin-top:16px;padding:12px;background:var(--bg-tertiary);border-radius:8px">
    <div class="form-group">
      <label class="form-label">ÂøÖÈÅ∏ÊúÄËøëÊ∂àÊÅØÊï∏Èáè</label>
      <input type="number" class="form-input" id="smart-context-recent" min="5" max="50" placeholder="‰æãÂ¶ÇÔºö10">
      <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">‰øùË≠âÂ∞çË©±ÈÄ£Ë≤´ÊÄßÔºåÂª∫Ë≠∞ 5-15 Ê¢ù</div>
    </div>

    <div class="form-group" style="margin-top:12px">
      <label class="form-label">ÊúÄ‰ΩéÂàÜÊï∏ÈñæÂÄº</label>
      <input type="number" class="form-input" id="smart-context-min-score" min="0" max="100" placeholder="‰æãÂ¶ÇÔºö30">
      <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">Âè™ÈÅ∏ÊìáÂàÜÊï∏È´òÊñºÊ≠§ÂÄºÁöÑÊ∂àÊÅØÔºåÂª∫Ë≠∞ 20-40 ÂàÜ</div>
    </div>
  </div>

  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('context-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveContextSettings()">‰øùÂ≠ò</button>
  </div>
</div>

<!-- Êô∫ËÉΩËßíËâ≤ÈÅ∏Êìá Modal -->
<div class="modal" id="character-selection-modal">
  <div class="modal-title">üë• Êô∫ËÉΩËßíËâ≤ÈÅ∏Êìá</div>
  <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">
    Âè™ÁôºÈÄÅÊúÄËøëÂá∫Â†¥ÁöÑËßíËâ≤‰ø°ÊÅØÁµ¶ AIÔºåÁØÄÁúÅ tokens Ê∂àËÄó
  </p>

  <div class="form-group">
    <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
      <input type="checkbox" id="smart-character-enabled">
      <span class="form-label" style="margin:0">üß† ÂïüÁî®Êô∫ËÉΩËßíËâ≤ÈÅ∏Êìá</span>
    </label>
    <p style="font-size:12px;color:var(--text-tertiary);margin-top:8px">
      Êô∫ËÉΩÈÅ∏ÊìáÊáâË©≤ÁôºÈÄÅÁöÑËßíËâ≤ÔºåÂåÖÊã¨Ôºö<br>
      ‚Ä¢ ÊúÄËøëNÊ¢ùÊ∂àÊÅØ‰∏≠ÊèêÂà∞ÁöÑËßíËâ≤<br>
      ‚Ä¢ Áî®Êà∂Áï∂ÂâçËº∏ÂÖ•‰∏≠ÊèêÂà∞ÁöÑËßíËâ≤<br>
      ‚Ä¢ Ê®ôË®òÁÇ∫‰∏ªË¶ÅËßíËâ≤ÁöÑËßíËâ≤
    </p>
  </div>

  <div id="smart-character-options" style="margin-top:16px;padding:12px;background:var(--bg-tertiary);border-radius:8px">
    <div class="form-group">
      <label class="form-label">Ê™¢Êü•ÊúÄËøëÊ∂àÊÅØÊï∏Èáè</label>
      <input type="number" class="form-input" id="character-recent-messages" min="5" max="100" placeholder="‰æãÂ¶ÇÔºö20">
      <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">Ê™¢Êü•ÊúÄËøëNÊ¢ùÊ∂àÊÅØ‰∏≠ÊèêÂà∞ÁöÑËßíËâ≤ÔºåÂª∫Ë≠∞ 15-30 Ê¢ù</div>
    </div>

    <div class="form-group" style="margin-top:12px">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
        <input type="checkbox" id="always-include-main-chars">
        <span class="form-label" style="margin:0">Á∏ΩÊòØÂåÖÂê´‰∏ªË¶ÅËßíËâ≤</span>
      </label>
      <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">
        ÁÑ°Ë´ñÊòØÂê¶ÊúÄËøëÂá∫Â†¥ÔºåÈÉΩÊúÉÂåÖÂê´Ê®ôË®òÁÇ∫„Äå‰∏ªË¶Å„ÄçÂàÜÈ°ûÁöÑËßíËâ≤
      </div>
    </div>
  </div>

  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('character-selection-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveCharacterSelectionSettings()">‰øùÂ≠ò</button>
  </div>
</div>

<!-- ÊúÄÂ§ß Token Modal -->
<div class="modal" id="max-tokens-modal">
  <div class="modal-title">ÊúÄÂ§ßÁîüÊàêÈï∑Â∫¶</div>
  <div class="form-group">
    <label class="form-label">Max Tokens</label>
    <p style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">AI ÂñÆÊ¨°ÂõûÂæ©ÁöÑÊúÄÂ§ßÈï∑Â∫¶ÔºåË∂äÂ§ßÂõûÂæ©Ë∂äÈï∑‰ΩÜ‰πüË∂äÊÖ¢</p>
    <input type="number" class="form-input" id="max-tokens-input" min="100" placeholder="Ëº∏ÂÖ•Êï∏ÈáèÔºå‰æãÂ¶ÇÔºö4096">
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">Âª∫Ë≠∞ÁØÑÂúçÔºö1024-8192ÔºåÂèØÊ†πÊìöÊ®°ÂûãÊîØÊåÅËá™Ë°åË™øÊï¥</div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('max-tokens-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveMaxTokensSettings()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- ÊâìÂ≠óÊ©üÊïàÊûú Modal -->
<div class="modal" id="typing-modal">
  <div class="modal-title">ÊâìÂ≠óÊ©üÊïàÊûú</div>
  <div class="form-group">
    <label class="form-label">ÊâìÂ≠óÈÄüÂ∫¶</label>
    <p style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">ÊØèÂÄãÂ≠óÈ°ØÁ§∫ÁöÑÈñìÈöîÊôÇÈñìÔºå0 ÁÇ∫ÈóúÈñâÊâìÂ≠óÊ©üÊïàÊûú</p>
    <select class="form-select" id="typing-speed-select">
      <option value="0">ÈóúÈñâ</option>
      <option value="10">10msÔºàÂø´ÈÄüÔºâ</option>
      <option value="20">20ms</option>
      <option value="30">30msÔºàÊé®Ëñ¶Ôºâ</option>
      <option value="50">50ms</option>
      <option value="80">80msÔºàÊÖ¢ÈÄüÔºâ</option>
    </select>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('typing-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveTypingSpeedSettings()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- ÊµÅÂºèÈüøÊáâË®≠ÁΩÆ Modal -->
<div class="modal" id="streaming-modal">
  <div class="modal-title">‚ö° ÊµÅÂºèÈüøÊáâ</div>
  <div class="form-group">
    <label class="form-label">ÂïüÁî®ÊµÅÂºèÈüøÊáâ</label>
    <p style="font-size:12px;color:var(--text-tertiary);margin-bottom:12px">AI ÈÇäÁîüÊàêÈÇäÈ°ØÁ§∫ÔºåÂπæÁßíÈêòÂ∞±ËÉΩÈñãÂßãÈñ±ËÆÄÔºå‰∏¶ÂèØÈö®ÊôÇÂÅúÊ≠¢ÁîüÊàê</p>
    <div style="display:flex;align-items:center;gap:12px">
      <div class="toggle active" id="toggle-streaming" onclick="toggleStreamingEnabled()"></div>
      <span id="toggle-streaming-text" style="font-size:13px;color:var(--text-secondary)">Â∑≤ÈñãÂïü</span>
    </div>
  </div>
  <div id="streaming-advanced-options">
    <div class="form-group">
      <label class="form-label">ÊâìÂ≠óÊ©üÂª∂ÈÅ≤</label>
      <p style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">Êî∂Âà∞ÊñáÂ≠óÂæåÁöÑÈ°ØÁ§∫Âª∂ÈÅ≤ÔºåËÆìÊµÅÂºèÈ°ØÁ§∫Êõ¥Âπ≥Êªë</p>
      <select class="form-select" id="streaming-chunk-delay-select">
        <option value="0">ÁÑ°Âª∂ÈÅ≤ÔºàÁ´ãÂç≥È°ØÁ§∫Ôºâ</option>
        <option value="10">10msÔºàÊ•µÂø´Ôºâ</option>
        <option value="20">20msÔºàÊé®Ëñ¶Ôºâ</option>
        <option value="30">30ms</option>
        <option value="50">50msÔºàÂπ≥ÊªëÔºâ</option>
      </select>
    </div>
    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;font-size:12px;color:var(--text-secondary);margin-top:12px">
      <div style="font-weight:600;margin-bottom:6px">üí° ÊèêÁ§∫</div>
      <div style="line-height:1.6">
        ‚Ä¢ ÊµÅÂºèÈüøÊáâÂèØÂ§ßÂπÖÊ∏õÂ∞ëÁ≠âÂæÖÊôÇÈñì<br>
        ‚Ä¢ ÈÉ®ÂàÜ API ÂèØËÉΩ‰∏çÊîØÊåÅÊµÅÂºèÔºåÊúÉËá™ÂãïÈôçÁ¥ö<br>
        ‚Ä¢ ÂÅúÊ≠¢ÁîüÊàêÊôÇÊúÉË©¢ÂïèÊòØÂê¶‰øùÂ≠òÂ∑≤ÁîüÊàêÂÖßÂÆπ
      </div>
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('streaming-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveStreamingSettings()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- Â≠óÈ´îÂ§ßÂ∞è Modal -->
<div class="modal" id="font-size-modal">
  <div class="modal-title">üìù Â≠óÈ´îÂ§ßÂ∞è</div>
  <div class="form-group">
    <label class="form-label">ÈÅ∏ÊìáÂ≠óÈ´îÂ§ßÂ∞è</label>
    <p style="font-size:12px;color:var(--text-tertiary);margin-bottom:12px">Ë™øÊï¥ÊïÖ‰∫ãÂÖßÂÆπÁöÑÂ≠óÈ´îÂ§ßÂ∞èÔºåÊâæÂà∞ÊúÄËàíÈÅ©ÁöÑÈñ±ËÆÄÈ´îÈ©ó</p>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
      <button class="font-option" data-size="14" onclick="selectFontSize(14)">
        <span style="font-size:14px">Â∞è</span>
        <span style="font-size:11px;color:var(--text-tertiary)">14px</span>
      </button>
      <button class="font-option" data-size="16" onclick="selectFontSize(16)">
        <span style="font-size:16px">‰∏≠</span>
        <span style="font-size:11px;color:var(--text-tertiary)">16px</span>
      </button>
      <button class="font-option" data-size="18" onclick="selectFontSize(18)">
        <span style="font-size:18px">Â§ß</span>
        <span style="font-size:11px;color:var(--text-tertiary)">18px</span>
      </button>
      <button class="font-option" data-size="20" onclick="selectFontSize(20)">
        <span style="font-size:20px">ÁâπÂ§ß</span>
        <span style="font-size:11px;color:var(--text-tertiary)">20px</span>
      </button>
    </div>
    <div style="margin-top:16px;padding:16px;background:var(--bg-tertiary);border-radius:8px">
      <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">È†êË¶ΩÊïàÊûú</div>
      <div id="font-preview" style="font-family:'Noto Serif SC',Georgia,serif;line-height:1.8">
        Èôõ‰∏ãÁ∑©Ê≠•Ë°åËá≥Âæ°Ëä±ÂúíÔºåÂè™Ë¶ãÊ°ÉËä±ÁÅºÁÅºÔºåÂ´£ÁÑ∂Á∂ªÊîæÊñºÊûùÈ†≠„ÄÇ
      </div>
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('font-size-modal')">ÈóúÈñâ</button>
  </div>
</div>
<!-- Ë°åÈñìË∑ù Modal -->
<div class="modal" id="line-height-modal">
  <div class="modal-title">üìè Ë°åÈñìË∑ù</div>
  <div class="form-group">
    <label class="form-label">ÈÅ∏ÊìáË°åÈñìË∑ù</label>
    <p style="font-size:12px;color:var(--text-tertiary);margin-bottom:12px">Ë™øÊï¥Ë°åËàáË°å‰πãÈñìÁöÑË∑ùÈõ¢ÔºåÂΩ±ÈüøÈñ±ËÆÄÁØÄÂ•è</p>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
      <button class="font-option" data-lh="1.5" onclick="selectLineHeight(1.5)">
        <span>Á∑äÊπä</span>
        <span style="font-size:11px;color:var(--text-tertiary)">1.5x</span>
      </button>
      <button class="font-option" data-lh="1.6" onclick="selectLineHeight(1.6)">
        <span>Ê®ôÊ∫ñ</span>
        <span style="font-size:11px;color:var(--text-tertiary)">1.6x</span>
      </button>
      <button class="font-option" data-lh="1.8" onclick="selectLineHeight(1.8)">
        <span>ËàíÈÅ©</span>
        <span style="font-size:11px;color:var(--text-tertiary)">1.8x</span>
      </button>
      <button class="font-option" data-lh="2.0" onclick="selectLineHeight(2.0)">
        <span>ÂØ¨È¨Ü</span>
        <span style="font-size:11px;color:var(--text-tertiary)">2.0x</span>
      </button>
    </div>
    <div style="margin-top:16px;padding:16px;background:var(--bg-tertiary);border-radius:8px">
      <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">È†êË¶ΩÊïàÊûú</div>
      <div id="line-height-preview" style="font-family:'Noto Serif SC',Georgia,serif;font-size:16px">
        Èôõ‰∏ãÁ∑©Ê≠•Ë°åËá≥Âæ°Ëä±ÂúíÔºåÂè™Ë¶ãÊ°ÉËä±ÁÅºÁÅºÔºåÂ´£ÁÑ∂Á∂ªÊîæÊñºÊûùÈ†≠„ÄÇËä±Áì£Èö®È¢®È£ÑËêΩÔºåÂ¶ÇÁ≤âËâ≤ÁöÑÈõ™ÔºåËºïÊüîÂú∞ËêΩÂú®‰Ω†ÁöÑËÇ©È†≠„ÄÇ
      </div>
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('line-height-modal')">ÈóúÈñâ</button>
  </div>
</div>
<!-- ÊÆµËêΩÈñìË∑ù Modal -->
<div class="modal" id="paragraph-spacing-modal">
  <div class="modal-title">üìê ÊÆµËêΩÈñìË∑ù</div>
  <div class="form-group">
    <label class="form-label">ÈÅ∏ÊìáÊÆµËêΩÈñìË∑ù</label>
    <p style="font-size:12px;color:var(--text-tertiary);margin-bottom:12px">Ë™øÊï¥ÊÆµËêΩËàáÊÆµËêΩ‰πãÈñìÁöÑË∑ùÈõ¢</p>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
      <button class="font-option" data-ps="0.3" onclick="selectParagraphSpacing('0.3em')">
        <span>Á∑äÊπä</span>
        <span style="font-size:11px;color:var(--text-tertiary)">0.3em</span>
      </button>
      <button class="font-option" data-ps="0.5" onclick="selectParagraphSpacing('0.5em')">
        <span>ËºÉÂ∞è</span>
        <span style="font-size:11px;color:var(--text-tertiary)">0.5em</span>
      </button>
      <button class="font-option" data-ps="0.7" onclick="selectParagraphSpacing('0.7em')">
        <span>ÈÅ©‰∏≠</span>
        <span style="font-size:11px;color:var(--text-tertiary)">0.7em</span>
      </button>
      <button class="font-option" data-ps="1" onclick="selectParagraphSpacing('1em')">
        <span>Ê®ôÊ∫ñ</span>
        <span style="font-size:11px;color:var(--text-tertiary)">1em</span>
      </button>
    </div>
    <div style="margin-top:16px;padding:16px;background:var(--bg-tertiary);border-radius:8px">
      <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">È†êË¶ΩÊïàÊûú</div>
      <div id="paragraph-spacing-preview" class="msg-ai-story" style="font-family:'Noto Serif SC',Georgia,serif;font-size:16px">
        <p style="text-indent:0">Èôõ‰∏ãÁ∑©Ê≠•Ë°åËá≥Âæ°Ëä±ÂúíÔºåÂè™Ë¶ãÊ°ÉËä±ÁÅºÁÅºÔºåÂ´£ÁÑ∂Á∂ªÊîæÊñºÊûùÈ†≠„ÄÇ</p>
        <p>Ëä±Áì£Èö®È¢®È£ÑËêΩÔºåÂ¶ÇÁ≤âËâ≤ÁöÑÈõ™ÔºåËºïÊüîÂú∞ËêΩÂú®‰Ω†ÁöÑËÇ©È†≠„ÄÇÂæÆÈ¢®ÊãÇÈÅéÔºåÂ∏∂‰æÜÈô£Èô£Ëä±È¶ô„ÄÇ</p>
        <p>ÈÅ†ËôïÂÇ≥‰æÜÂÆÆÂ•≥ÁöÑËºïËÅ≤Á¥∞Ë™ûÔºåÁÇ∫ÈÄôÈùúË¨êÁöÑÂçàÂæåÂ¢ûÊ∑ª‰∫ÜÂπæÂàÜÁîüÊ∞£„ÄÇ</p>
      </div>
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('paragraph-spacing-modal')">ÈóúÈñâ</button>
  </div>
</div>
<!-- Ëá™ÂãïÊëòË¶ÅÈ†ªÁéá Modal -->
<div class="modal" id="auto-summary-freq-modal">
  <div class="modal-title">üìù Ëá™ÂãïÊëòË¶ÅÈ†ªÁéá</div>
  <div class="form-group">
    <label class="form-label">ÈÅ∏ÊìáÁîüÊàêÈ†ªÁéá</label>
    <p style="font-size:12px;color:var(--text-tertiary);margin-bottom:12px">ÊØèÁ∂ìÈÅéÊåáÂÆöÊï∏ÈáèÁöÑÊ∂àÊÅØÂæåÔºåËá™ÂãïÁîüÊàê‰∏Ä‰ªΩÊªæÂãïÊëòË¶Å</p>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
      <button class="font-option" data-freq="10" onclick="selectAutoSummaryFrequency(10)">
        <span>È†ªÁπÅ</span>
        <span style="font-size:11px;color:var(--text-tertiary)">10Ê¢ù</span>
      </button>
      <button class="font-option" data-freq="15" onclick="selectAutoSummaryFrequency(15)">
        <span>Ê®ôÊ∫ñ</span>
        <span style="font-size:11px;color:var(--text-tertiary)">15Ê¢ù</span>
      </button>
      <button class="font-option" data-freq="20" onclick="selectAutoSummaryFrequency(20)">
        <span>ÈÅ©‰∏≠</span>
        <span style="font-size:11px;color:var(--text-tertiary)">20Ê¢ù</span>
      </button>
      <button class="font-option" data-freq="30" onclick="selectAutoSummaryFrequency(30)">
        <span>Á®ÄÁñè</span>
        <span style="font-size:11px;color:var(--text-tertiary)">30Ê¢ù</span>
      </button>
      <button class="font-option" data-freq="50" onclick="selectAutoSummaryFrequency(50)">
        <span>ÂæàÂ∞ë</span>
        <span style="font-size:11px;color:var(--text-tertiary)">50Ê¢ù</span>
      </button>
    </div>
    <div style="margin-top:16px;padding:12px;background:var(--bg-tertiary);border-radius:8px;font-size:12px;color:var(--text-secondary);line-height:1.6">
      üí° <strong>Âª∫Ë≠∞Ôºö</strong>ËºÉÂ∞èÁöÑÂÄºÊúÉÁîüÊàêÊõ¥Â§öÊëòË¶ÅÔºåÊõ¥Â•ΩÂú∞‰øùÂ≠òÁ¥∞ÁØÄÔºå‰ΩÜÊúÉÂ¢ûÂä† API Ë™øÁî®Ê¨°Êï∏„ÄÇËºÉÂ§ßÁöÑÂÄºÂâáÁõ∏Âèç„ÄÇ
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('auto-summary-freq-modal')">ÈóúÈñâ</button>
  </div>
</div>
<!-- LorebookÊèêÂèñÈ†ªÁéáË®≠ÁΩÆ Modal -->
<div class="modal" id="auto-lorebook-freq-modal">
  <div class="modal-title">ü§ñ AIÊèêÂèñLorebookÈ†ªÁéá</div>
  <div class="form-group">
    <label class="form-label">ÈÅ∏ÊìáÊèêÂèñÈ†ªÁéá</label>
    <p style="font-size:12px;color:var(--text-tertiary);margin-bottom:12px">ÊØèÁ∂ìÈÅéÊåáÂÆöÊï∏ÈáèÁöÑÊ∂àÊÅØÂæåÔºåAIËá™ÂãïÂàÜÊûêÂ∞çË©±‰∏¶ÊèêÂèñLorebook</p>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
      <button class="font-option" data-freq="5" onclick="selectAutoLorebookFrequency(5)">
        <span>È†ªÁπÅ</span>
        <span style="font-size:11px;color:var(--text-tertiary)">5Ê¢ù</span>
      </button>
      <button class="font-option" data-freq="10" onclick="selectAutoLorebookFrequency(10)">
        <span>Ê®ôÊ∫ñ</span>
        <span style="font-size:11px;color:var(--text-tertiary)">10Ê¢ù</span>
      </button>
      <button class="font-option" data-freq="15" onclick="selectAutoLorebookFrequency(15)">
        <span>ÈÅ©‰∏≠</span>
        <span style="font-size:11px;color:var(--text-tertiary)">15Ê¢ù</span>
      </button>
      <button class="font-option" data-freq="20" onclick="selectAutoLorebookFrequency(20)">
        <span>Á®ÄÁñè</span>
        <span style="font-size:11px;color:var(--text-tertiary)">20Ê¢ù</span>
      </button>
      <button class="font-option" data-freq="30" onclick="selectAutoLorebookFrequency(30)">
        <span>ÂæàÂ∞ë</span>
        <span style="font-size:11px;color:var(--text-tertiary)">30Ê¢ù</span>
      </button>
    </div>
    <div style="margin-top:16px;padding:12px;background:var(--bg-tertiary);border-radius:8px;font-size:12px;color:var(--text-secondary);line-height:1.6">
      üí° <strong>Âª∫Ë≠∞Ôºö</strong>ËºÉÂ∞èÁöÑÂÄºÊúÉÊõ¥È†ªÁπÅÂú∞ÊèêÂèñ‰ø°ÊÅØÔºå‰ΩÜÊúÉÂ¢ûÂä† API Ë™øÁî®Ê¨°Êï∏ÂíåÊèêÁ§∫È†ªÁéá„ÄÇÂª∫Ë≠∞Ë®≠ÁΩÆÁÇ∫10-15Ê¢ù„ÄÇ
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('auto-lorebook-freq-modal')">ÈóúÈñâ</button>
  </div>
</div>
<!-- Lorebook Á∑®ËºØ Modal -->
<div class="modal" id="lorebook-modal" style="max-width:min(95%,450px);max-height:85vh;overflow-y:auto">
  <div class="modal-title">üîÆ Á∑®ËºØ Lorebook Ê¢ùÁõÆ</div>
  <input type="hidden" id="lorebook-id">
  <div class="form-group">
    <label class="form-label">ÂêçÁ®±</label>
    <input type="text" class="form-input" id="lorebook-name" placeholder="‰æãÂ¶ÇÔºöÂ§úÂØí - Âü∫Êú¨‰∫∫Ë®≠">
  </div>
  <div class="form-group">
    <label class="form-label">Ëß∏ÁôºÈóúÈçµË©ûÔºàÈÄóËôüÂàÜÈöîÔºâ</label>
    <input type="text" class="form-input" id="lorebook-keywords" placeholder="‰æãÂ¶ÇÔºöÂ§úÂØí, ÁöáÂ§´, Èï∑Ê®ÇÂÆÆ‰∏ª‰∫∫">
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">Áï∂Â∞çË©±‰∏≠Âá∫ÁèæÈÄô‰∫õË©ûÊôÇÊúÉËß∏ÁôºÊ≥®ÂÖ•</div>
  </div>
  <div class="form-group">
    <label class="form-label">ÂÖßÂÆπ</label>
    <textarea class="form-input" id="lorebook-content" style="min-height:120px" placeholder="Ë¶ÅÊ≥®ÂÖ•ÁöÑË®≠ÂÆöÂÖßÂÆπ..."></textarea>
  </div>
  <div class="form-group">
    <div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer" onclick="toggleLorebookAdvanced()">
      <label class="form-label" style="margin:0">‚öôÔ∏è ÈÄ≤ÈöéË®≠ÁΩÆ</label>
      <span id="lorebook-advanced-toggle" style="color:var(--text-tertiary)">‚ñº</span>
    </div>
    <div id="lorebook-advanced" style="display:none;margin-top:12px">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
        <div>
          <label style="font-size:12px;color:var(--text-secondary)">Ê™¢Ê∏¨Ê∑±Â∫¶</label>
          <select class="form-select" id="lorebook-depth" style="margin-top:4px">
            <option value="1">ÊúÄËøë 1 Ê¢ùÊ∂àÊÅØ</option>
            <option value="2" selected>ÊúÄËøë 2 Ê¢ùÊ∂àÊÅØ</option>
            <option value="3">ÊúÄËøë 3 Ê¢ùÊ∂àÊÅØ</option>
            <option value="5">ÊúÄËøë 5 Ê¢ùÊ∂àÊÅØ</option>
          </select>
        </div>
        <div>
          <label style="font-size:12px;color:var(--text-secondary)">ÂÑ™ÂÖàÁ¥ö</label>
          <input type="number" class="form-input" id="lorebook-priority" value="100" style="margin-top:4px">
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
        <div>
          <label style="font-size:12px;color:var(--text-secondary)">ÂÜ∑ÂçªÔºàÊ∂àÊÅØÊï∏Ôºâ</label>
          <input type="number" class="form-input" id="lorebook-cooldown" value="0" min="0" style="margin-top:4px">
        </div>
        <div>
          <label style="font-size:12px;color:var(--text-secondary)">ÊúÄÂ§ßËß∏ÁôºÊ¨°Êï∏</label>
          <input type="number" class="form-input" id="lorebook-max-triggers" value="0" min="0" style="margin-top:4px" placeholder="0=ÁÑ°Èôê">
        </div>
      </div>
      <label style="font-size:13px;color:var(--text-secondary);display:flex;align-items:center;gap:6px;cursor:pointer">
        <input type="checkbox" id="lorebook-one-time"> ‰∏ÄÊ¨°ÊÄßËß∏ÁôºÔºàËß∏ÁôºÂæåËá™ÂãïÁ¶ÅÁî®Ôºâ
      </label>
    </div>
  </div>
  <div class="form-group">
    <div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer" onclick="toggleLorebookConditions()">
      <label class="form-label" style="margin:0">üîê Ëß∏ÁôºÊ¢ù‰ª∂ÔºàÂèØÈÅ∏Ôºâ</label>
      <span id="lorebook-conditions-toggle" style="color:var(--text-tertiary)">‚ñº</span>
    </div>
    <div id="lorebook-conditions" style="display:none;margin-top:12px">
      <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">Èô§‰∫ÜÈóúÈçµË©ûÂåπÈÖçÔºåÈÇÑÈúÄÊªøË∂≥‰ª•‰∏ãÊ¢ù‰ª∂ÊâçÊúÉËß∏Áôº</div>
      <div id="lorebook-condition-list"></div>
      <button class="action-btn secondary" style="width:100%;margin-top:8px" onclick="addLorebookCondition()">‚ûï Ê∑ªÂä†Ê¢ù‰ª∂</button>
      <div style="margin-top:12px">
        <label style="font-size:12px;color:var(--text-secondary)">Ê¢ù‰ª∂ÈÇèËºØ</label>
        <div style="display:flex;gap:16px;margin-top:6px">
          <label style="font-size:13px;display:flex;align-items:center;gap:4px;cursor:pointer">
            <input type="radio" name="lorebook-logic" value="AND" checked> ÂÖ®ÈÉ®ÊªøË∂≥ (AND)
          </label>
          <label style="font-size:13px;display:flex;align-items:center;gap:4px;cursor:pointer">
            <input type="radio" name="lorebook-logic" value="OR"> ‰ªª‰∏ÄÊªøË∂≥ (OR)
          </label>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('lorebook-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveLorebook()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- Á∑®ËºØÊåá‰ª§ Modal -->
<div class="modal" id="edit-inst-modal" style="max-width:500px">
  <div class="modal-title">‚úèÔ∏è Á∑®ËºØÊåá‰ª§</div>
  <div class="form-group">
    <label class="form-label">Êåá‰ª§ÂêçÁ®±</label>
    <input type="text" class="form-input" id="edit-inst-name" placeholder="Ëº∏ÂÖ•Êåá‰ª§ÂêçÁ®±">
  </div>
  <div class="form-group">
    <label class="form-label">Êåá‰ª§ÂÖßÂÆπ</label>
    <textarea class="form-input" id="edit-inst-content" style="min-height:300px;resize:vertical;font-family:monospace;font-size:13px" placeholder="Ëº∏ÂÖ•Êåá‰ª§ÂÖßÂÆπ..."></textarea>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('edit-inst-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveEditInst()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- Á∑®ËºØÊ∂àÊÅØ Modal -->
<div class="modal" id="edit-msg-modal" style="max-width:min(90%,400px)">
  <div class="modal-title">Á∑®ËºØÊ∂àÊÅØ</div>
  <div class="form-group">
    <textarea class="form-input" id="edit-msg-content" style="min-height:200px;resize:vertical" placeholder="Á∑®ËºØÊ∂àÊÅØÂÖßÂÆπ..."></textarea>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('edit-msg-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveEditMsg()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- ÈáçÊñ∞ÁîüÊàê Modal -->
<div class="modal" id="regen-modal">
  <div class="modal-title">üîÑ ÈáçÊñ∞ÁîüÊàê</div>
  <div class="form-group">
    <label class="form-label">Ë£úÂÖÖË™™ÊòéÔºàÂèØÈÅ∏Ôºâ</label>
    <textarea class="form-input" id="regen-note" style="min-height:80px" placeholder="‰æãÂ¶ÇÔºöÊèèÂØ´Êõ¥Á¥∞ËÜ©‰∏Ä‰∫õ„ÄÅË™ûÊ∞£Êõ¥Âº∑Á°¨..."></textarea>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('regen-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="doRegenerate()">ÈáçÊñ∞ÁîüÊàê</button>
  </div>
</div>
<!-- Ë®òÊÜ∂ÁÆ°ÁêÜ Modal -->
<div class="modal" id="memory-modal" style="max-width:min(95%,480px)">
  <div class="modal-title">üß† Ë®òÊÜ∂ÁÆ°ÁêÜ</div>
  <div style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">
    ÁÆ°ÁêÜÊïÖ‰∫ãË®òÊÜ∂ÔºåÂ£ìÁ∏ÆËàäÊ∂àÊÅØÊàñÁîüÊàêÊªæÂãïÊëòË¶ÅÔºå‰øùÊåÅ AI Â∞çÂäáÊÉÖÁöÑÈÄ£Ë≤´ÁêÜËß£„ÄÇ
  </div>
  <div class="form-group">
    <label class="form-label">üìä Áï∂ÂâçÁãÄÊÖã</label>
    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;font-size:13px">
      <div style="display:flex;justify-content:space-between;margin-bottom:4px">
        <span>Á∏ΩÊ∂àÊÅØÊï∏Ôºö<strong id="memory-msg-count">0</strong> Ê¢ù</span>
        <span id="memory-token-estimate" style="color:var(--text-tertiary)"></span>
      </div>
      <div>Â∑≤Â£ìÁ∏ÆÔºö<span id="memory-compressed">0</span> Ê¢ù</div>
      <div>ÊëòË¶ÅÊï∏Ôºö<span id="memory-summary-count">0</span> Ê¢ù 
        <span style="color:var(--primary);cursor:pointer;margin-left:8px" onclick="viewSummaries()">üìñ Êü•Áúã</span>
        <span style="color:var(--primary);cursor:pointer;margin-left:8px" onclick="searchSummaries()">üîç ÊêúÁ¥¢</span>
      </div>
      <div>ÊªæÂãïÊëòË¶ÅÔºö<span id="memory-rolling-count">0</span> Ê¢ù <span style="color:var(--text-tertiary);font-size:11px">(‰∏çÂà™Èô§ÂéüÊñá)</span></div>
      <div id="memory-protected-info" style="color:var(--warning);font-size:12px;margin-top:6px"></div>
    </div>
  </div>
  
  <!-- ÂäüËÉΩÈÅ∏È†ÖÂç° -->
  <div style="display:flex;gap:8px;margin-bottom:12px">
    <button class="modal-btn secondary" id="mem-tab-compress" onclick="switchMemTab('compress')" style="flex:1;font-size:11px;padding:8px">üóúÔ∏è Â£ìÁ∏Æ</button>
    <button class="modal-btn" id="mem-tab-rolling" onclick="switchMemTab('rolling')" style="flex:1;font-size:11px;padding:8px;background:var(--bg-tertiary)">üìú ÊªæÂãï</button>
    <button class="modal-btn" id="mem-tab-viz" onclick="switchMemTab('viz')" style="flex:1;font-size:11px;padding:8px;background:var(--bg-tertiary)">üìä ÂèØË¶ñÂåñ</button>
    <button class="modal-btn" id="mem-tab-analyze" onclick="switchMemTab('analyze')" style="flex:1;font-size:11px;padding:8px;background:var(--bg-tertiary)">üîç ÂàÜÊûê</button>
  </div>
  
  <!-- Â£ìÁ∏ÆÈÅ∏È†Ö -->
  <div id="mem-panel-compress">
    <div class="form-group">
      <label class="form-label">Â£ìÁ∏ÆÊñπÂºè</label>
      <select class="form-select" id="compress-mode" onchange="updateCompressOptions()">
        <option value="count">ÊåâÊ∂àÊÅØÊï∏Èáè</option>
        <option value="chapter">ÊåâÁ´†ÁØÄÂ£ìÁ∏Æ</option>
        <option value="manual">ÊâãÂãïÈÅ∏ÊìáÊ∂àÊÅØ</option>
      </select>
    </div>
    <div class="form-group" id="compress-count-group">
      <label class="form-label">Â£ìÁ∏ÆÊï∏Èáè</label>
      <select class="form-select" id="compress-count">
        <option value="10">Â£ìÁ∏ÆÊúÄÊó© 10 Ê¢ùÊ∂àÊÅØ</option>
        <option value="20">Â£ìÁ∏ÆÊúÄÊó© 20 Ê¢ùÊ∂àÊÅØ</option>
        <option value="50">Â£ìÁ∏ÆÊúÄÊó© 50 Ê¢ùÊ∂àÊÅØ</option>
        <option value="all">Â£ìÁ∏ÆÊâÄÊúâËàäÊ∂àÊÅØÔºà‰øùÁïôÊúÄËøë20Ê¢ùÔºâ</option>
      </select>
    </div>
    <div class="form-group" id="compress-chapter-group" style="display:none">
      <label class="form-label">ÈÅ∏ÊìáÁ´†ÁØÄ</label>
      <select class="form-select" id="compress-chapter"></select>
      <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">Â∞áÂ£ìÁ∏ÆË©≤Á´†ÁØÄ‰πãÂâçÁöÑÊâÄÊúâÊ∂àÊÅØ</div>
    </div>
    <div class="form-group" id="compress-manual-group" style="display:none">
      <label class="form-label">ÈÅ∏ÊìáË¶ÅÂ£ìÁ∏ÆÁöÑÊ∂àÊÅØ</label>
      <div style="font-size:11px;color:var(--text-secondary);margin-bottom:8px">
        ÈªûÊìä„ÄåÈÅ∏ÊìáÊ∂àÊÅØ„ÄçÊåâÈàïÔºåÂãæÈÅ∏Ë¶ÅÂêà‰ΩµÂ£ìÁ∏ÆÁöÑÊ∂àÊÅØÔºàÂ∑≤ÈÅ∏ <span id="manual-select-count">0</span> Ê¢ùÔºâ
      </div>
      <button class="modal-btn secondary" onclick="showManualSelectModal()" style="width:100%">üìã ÈÅ∏ÊìáÊ∂àÊÅØ</button>
    </div>
    <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:12px;padding:8px;background:var(--bg-tertiary);border-radius:6px">
      üí° Â∏∂Êúâ‰ºèÁ≠ÜÊ®ôË®ò„ÄÅÊõ∏Á±§„ÄÅÂäáÊÉÖÊ®ôÁ±§ÁöÑÈáçË¶ÅÊ∂àÊÅØÊúÉËá™ÂãïË∑≥ÈÅé‰øùË≠∑„ÄÇ
    </div>
  </div>
  
  <!-- ÊªæÂãïÊëòË¶ÅÈÅ∏È†Ö -->
  <div id="mem-panel-rolling" style="display:none">
    <div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">
      Ëá™ÂãïÁÇ∫Â∞çË©±ÁîüÊàêËÉåÊôØÊëòË¶ÅÔºå<strong>‰∏çÂà™Èô§ÂéüÊñá</strong>ÔºåÂπ´Âä© AI Êõ¥Â•ΩÂú∞ÁêÜËß£‰∏ä‰∏ãÊñá„ÄÇ
    </div>
    <div class="form-group">
      <label class="form-label">Ëá™ÂãïÊªæÂãïÊëòË¶Å</label>
      <div style="display:flex;align-items:center;gap:12px">
        <div class="toggle" id="tog-rolling-summary" onclick="toggleRollingSummary()"></div>
        <span style="font-size:13px;color:var(--text-secondary)">ÊØè <input type="number" id="rolling-interval" value="30" min="10" max="100" style="width:50px;padding:4px;border:1px solid var(--divider);border-radius:4px;background:var(--bg-tertiary);color:var(--text-primary)"> Ê¢ùÊ∂àÊÅØËá™ÂãïÁîüÊàê</span>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">ÊâãÂãïÊìç‰Ωú</label>
      <button class="modal-btn secondary" onclick="generateRollingSummary()" style="width:100%;margin-bottom:8px">üìú Á´ãÂç≥ÁîüÊàêÊªæÂãïÊëòË¶Å</button>
      <button class="modal-btn" onclick="mergeSummaries()" style="width:100%;background:var(--bg-tertiary)">üîó Âêà‰ΩµÂ§öÊ¢ùÊëòË¶Å</button>
    </div>
  </div>

  <!-- Ë®òÊÜ∂ÂèØË¶ñÂåñÈù¢Êùø -->
  <div id="mem-panel-viz" style="display:none">
    <div style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">
      ÂèØË¶ñÂåñÊü•ÁúãÁï∂ÂâçË®òÊÜ∂Á≥ªÁµ±ÁöÑ‰ΩøÁî®ÊÉÖÊ≥ÅÂíåÂàÜ‰Ωà
    </div>

    <!-- Ë®òÊÜ∂È°ûÂûãÁµ±Ë®à -->
    <div class="form-group">
      <label class="form-label">üì¶ Ë®òÊÜ∂È°ûÂûãÂàÜ‰Ωà</label>
      <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px">
        <div class="mem-viz-item">
          <div class="mem-viz-label">‚≠ê ÈáçË¶ÅË®òÊÜ∂</div>
          <div class="mem-viz-bar-container">
            <div class="mem-viz-bar" id="viz-bar-important" style="width:0%;background:#FFD700"></div>
          </div>
          <div class="mem-viz-value"><span id="viz-count-important">0</span> Ê¢ù</div>
        </div>
        <div class="mem-viz-item">
          <div class="mem-viz-label">üìö ÊïÖ‰∫ãÊëòË¶Å</div>
          <div class="mem-viz-bar-container">
            <div class="mem-viz-bar" id="viz-bar-summaries" style="width:0%;background:var(--primary)"></div>
          </div>
          <div class="mem-viz-value"><span id="viz-count-summaries">0</span> Ê¢ù</div>
        </div>
        <div class="mem-viz-item">
          <div class="mem-viz-label">üìú ÊªæÂãïÊëòË¶Å</div>
          <div class="mem-viz-bar-container">
            <div class="mem-viz-bar" id="viz-bar-rolling" style="width:0%;background:var(--info)"></div>
          </div>
          <div class="mem-viz-value"><span id="viz-count-rolling">0</span> Ê¢ù</div>
        </div>
        <div class="mem-viz-item">
          <div class="mem-viz-label">üí¨ ÂéüÂßãÊ∂àÊÅØ</div>
          <div class="mem-viz-bar-container">
            <div class="mem-viz-bar" id="viz-bar-messages" style="width:0%;background:var(--text-tertiary)"></div>
          </div>
          <div class="mem-viz-value"><span id="viz-count-messages">0</span> Ê¢ù</div>
        </div>
      </div>
    </div>

    <!-- Token ‰ΩøÁî®‰º∞ÁÆó -->
    <div class="form-group">
      <label class="form-label">üî¢ Token ‰ΩøÁî®‰º∞ÁÆó</label>
      <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;font-size:13px">
        <div style="display:flex;justify-content:space-between;margin-bottom:6px">
          <span>ÈáçË¶ÅË®òÊÜ∂</span>
          <span id="viz-tokens-important" style="color:var(--primary)">~0 tokens</span>
        </div>
        <div style="display:flex;justify-content:space-between;margin-bottom:6px">
          <span>ÊëòË¶ÅÁ≥ªÁµ±</span>
          <span id="viz-tokens-summaries" style="color:var(--primary)">~0 tokens</span>
        </div>
        <div style="display:flex;justify-content:space-between;margin-bottom:6px">
          <span>ÊúÄËøë‰∏ä‰∏ãÊñá (<span id="viz-context-count">20</span>Ê¢ù)</span>
          <span id="viz-tokens-context" style="color:var(--primary)">~0 tokens</span>
        </div>
        <div style="border-top:1px solid var(--divider);margin-top:8px;padding-top:8px;display:flex;justify-content:space-between">
          <strong>È†ê‰º∞Á∏ΩË®à</strong>
          <strong id="viz-tokens-total" style="color:var(--success)">~0 tokens</strong>
        </div>
      </div>
    </div>

    <!-- Ë®òÊÜ∂ÂÅ•Â∫∑Â∫¶ -->
    <div class="form-group">
      <label class="form-label">üíö Ë®òÊÜ∂ÂÅ•Â∫∑Â∫¶</label>
      <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;font-size:13px">
        <div style="margin-bottom:8px">
          <div style="display:flex;justify-content:space-between;margin-bottom:4px">
            <span>Êï¥È´îË©ïÂàÜ</span>
            <strong id="viz-health-score" style="color:var(--success)">ËâØÂ•Ω</strong>
          </div>
          <div style="height:8px;background:var(--bg-primary);border-radius:4px;overflow:hidden">
            <div id="viz-health-bar" style="height:100%;background:var(--success);width:80%;transition:all .3s"></div>
          </div>
        </div>
        <div id="viz-health-tips" style="font-size:12px;color:var(--text-secondary);line-height:1.6"></div>
      </div>
    </div>

    <!-- Âø´Êç∑Êìç‰Ωú -->
    <div class="form-group">
      <label class="form-label">‚ö° Âø´Êç∑Êìç‰Ωú</label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <button class="modal-btn secondary" onclick="showImportantMessages()" style="font-size:12px">‚≠ê Êü•ÁúãÈáçË¶Å</button>
        <button class="modal-btn secondary" onclick="viewSummaries()" style="font-size:12px">üìö Êü•ÁúãÊëòË¶Å</button>
        <button class="modal-btn secondary" onclick="generateRollingSummary()" style="font-size:12px">üìú ÁîüÊàêÊëòË¶Å</button>
        <button class="modal-btn secondary" onclick="updateMemoryViz()" style="font-size:12px">üîÑ Âà∑Êñ∞Êï∏Êìö</button>
      </div>
    </div>
  </div>

  <!-- Êô∫ËÉΩÂàÜÊûêÈÅ∏È†Ö -->
  <div id="mem-panel-analyze" style="display:none">
    <div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">
      ËÆì AI ÂàÜÊûêÁï∂ÂâçÂ∞çË©±ÔºåË≠òÂà•Âì™‰∫õÂÖßÂÆπÈáçË¶Å„ÄÅÂì™‰∫õÂèØ‰ª•ÂÆâÂÖ®Â£ìÁ∏Æ„ÄÇ
    </div>
    <button class="modal-btn secondary" onclick="analyzeMemory()" style="width:100%;margin-bottom:12px">üîç AI Êô∫ËÉΩÂàÜÊûê</button>
    <div id="memory-analysis-result" style="display:none;background:var(--bg-tertiary);padding:12px;border-radius:8px;font-size:13px;max-height:200px;overflow-y:auto"></div>
  </div>
  
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('memory-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" id="mem-compress-btn" onclick="compressMemory()">ü§ñ Êô∫ËÉΩÂ£ìÁ∏Æ</button>
  </div>
</div>
<!-- ÊëòË¶ÅÊü•Áúã Modal -->
<div class="modal" id="summaries-modal" style="max-width:min(95%,500px)">
  <div class="modal-title">üìö Ë®òÊÜ∂ÊëòË¶Å</div>
  <div id="summaries-list" style="max-height:60vh;overflow-y:auto"></div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('summaries-modal')">ÈóúÈñâ</button>
    <button class="modal-btn" style="background:var(--error)" onclick="clearAllSummaries()">üóëÔ∏è Ê∏ÖÁ©∫ÊëòË¶Å</button>
  </div>
</div>
<!-- ÊëòË¶ÅÁ∑®ËºØ Modal -->
<div class="modal" id="edit-summary-modal" style="max-width:min(95%,550px)">
  <div class="modal-title" id="edit-summary-title">‚úèÔ∏è Á∑®ËºØÊëòË¶Å</div>
  <div class="modal-content" style="padding:0">
    <textarea id="edit-summary-content" class="form-input" style="min-height:250px;max-height:50vh;font-size:14px;line-height:1.6" placeholder="ÊëòË¶ÅÂÖßÂÆπ..."></textarea>
    <div style="font-size:12px;color:var(--text-tertiary);margin-top:8px">
      üí° Á∑®ËºØÊëòË¶ÅÂÖßÂÆπÊúÉÂΩ±Èüø AI Â∞çÊïÖ‰∫ãÁöÑÁêÜËß£ÔºåË´ãË¨πÊÖé‰øÆÊîπ„ÄÇ
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('edit-summary-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveSummaryEdit()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- ÊëòË¶ÅÊêúÁ¥¢ Modal -->
<div class="modal" id="summary-search-modal" style="max-width:min(95%,500px)">
  <div class="modal-title">üîç ÊêúÁ¥¢Ë®òÊÜ∂ÊëòË¶Å</div>
  <div class="form-group">
    <input type="text" class="form-input" id="summary-search-input" placeholder="Ëº∏ÂÖ•ÈóúÈçµË©ûÊêúÁ¥¢ÊëòË¶ÅÂÖßÂÆπ" oninput="doSummarySearch()">
  </div>
  <div id="summary-search-results" style="max-height:50vh;overflow-y:auto">
    <div class="empty"><div class="empty-icon">üîç</div><div class="empty-title">Ëº∏ÂÖ•ÈóúÈçµË©ûÊêúÁ¥¢</div></div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('summary-search-modal')">ÈóúÈñâ</button>
  </div>
</div>
<!-- ÊëòË¶ÅÈ†êË¶Ω Modal -->
<div class="modal" id="summary-preview-modal" style="max-width:min(95%,550px)">
  <div class="modal-title" id="summary-preview-title">üìù Ë®òÊÜ∂ÊëòË¶ÅÈ†êË¶Ω</div>
  <div class="modal-content" style="padding:0">
    <div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;padding:0 4px" id="summary-preview-desc">
      AI Â∑≤ÁîüÊàê‰ª•‰∏ãÊëòË¶ÅÔºå‰Ω†ÂèØ‰ª•Á∑®ËºØÂæåÂÜçÁ¢∫Ë™çÂ£ìÁ∏ÆÔºö
    </div>
    <textarea id="summary-preview-content" class="form-input" style="min-height:200px;max-height:40vh;font-size:14px;line-height:1.6" placeholder="ÊëòË¶ÅÂÖßÂÆπ..."></textarea>
    <div style="background:var(--bg-tertiary);border-radius:8px;padding:10px 12px;margin-top:12px;font-size:12px;color:var(--text-secondary)" id="summary-preview-tips">
      <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px">
        <span>üí°</span>
        <span style="font-weight:600">ÊèêÁ§∫</span>
      </div>
      <div>Á¢∫Ë™çÂæåÂ∞áÂà™Èô§ÂéüÂßãÊ∂àÊÅØ‰∏¶‰øùÂ≠òÊ≠§ÊëòË¶Å„ÄÇÂ£ìÁ∏ÆÂæå‰ªçÂèØÂú®„Äåüìä Êü•Áúã„Äç‰∏≠Á∑®ËºØÊëòË¶ÅÂÖßÂÆπ„ÄÇ</div>
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="cancelSummaryPreview()">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" id="summary-preview-confirm-btn" onclick="confirmSummaryCompress()">Á¢∫Ë™ç‰∏¶Â£ìÁ∏Æ</button>
  </div>
</div>

<!-- ÊâãÂãïÈÅ∏ÊìáÊ∂àÊÅØÂ£ìÁ∏Æ Modal -->
<div class="modal" id="manual-select-modal" style="max-width:min(95%,700px);max-height:85vh">
  <div class="modal-title">üìã ÈÅ∏ÊìáË¶ÅÂ£ìÁ∏ÆÁöÑÊ∂àÊÅØ</div>
  <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">
    ÂãæÈÅ∏Ë¶ÅÂêà‰ΩµÂ£ìÁ∏ÆÁöÑÊ∂àÊÅØÔºåAI ÊúÉÂ∞áÂÆÉÂÄëÂêà‰ΩµÊàê‰∏ÄÊ¢ùÊëòË¶Å
  </p>

  <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
    <button class="action-btn secondary" onclick="selectAllMessages()" style="padding:6px 12px;font-size:12px">‚úÖ ÂÖ®ÈÅ∏</button>
    <button class="action-btn secondary" onclick="unselectAllMessages()" style="padding:6px 12px;font-size:12px">‚ùå ÂèñÊ∂àÂÖ®ÈÅ∏</button>
    <button class="action-btn secondary" onclick="selectOldMessages()" style="padding:6px 12px;font-size:12px">‚è™ ÈÅ∏ÊìáÂâç50Ê¢ù</button>
    <div style="flex:1"></div>
    <span style="font-size:12px;color:var(--text-tertiary);display:flex;align-items:center">
      Â∑≤ÈÅ∏ <span id="modal-selected-count" style="color:var(--primary);font-weight:600;margin:0 4px">0</span> Ê¢ù
    </span>
  </div>

  <div id="manual-select-list" style="max-height:50vh;overflow-y:auto;border:1px solid var(--divider);border-radius:8px;padding:8px"></div>

  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('manual-select-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="confirmManualSelection()">Á¢∫Ë™çÈÅ∏Êìá</button>
  </div>
</div>

<!-- AI ÂêåÊ≠•È†êË¶Ω Modal -->
<div class="modal" id="ai-preview-modal" style="max-width:min(95%,550px)">
  <div class="modal-title" id="ai-preview-title">ü§ñ AI ÂêåÊ≠•È†êË¶Ω</div>
  <div class="modal-content" style="padding:0">
    <div id="ai-preview-content" style="max-height:50vh;overflow-y:auto"></div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('ai-preview-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" id="ai-preview-confirm-btn">Á¢∫Ë™ç</button>
  </div>
</div>
<!-- ËÉåÂåÖÁâ©ÂìÅÁ∑®ËºØ Modal -->
<div class="modal" id="inventory-item-modal" style="max-width:min(95%,450px)">
  <div class="modal-title" id="inventory-modal-title">‚ûï Ê∑ªÂä†Áâ©ÂìÅ</div>
  <div class="form-group">
    <label class="form-label">Áâ©ÂìÅÂúñÊ®ô</label>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px" id="inventory-icon-picker">
      <span class="icon-option" onclick="selectInventoryIcon('‚öîÔ∏è')">‚öîÔ∏è</span>
      <span class="icon-option" onclick="selectInventoryIcon('üó°Ô∏è')">üó°Ô∏è</span>
      <span class="icon-option" onclick="selectInventoryIcon('üõ°Ô∏è')">üõ°Ô∏è</span>
      <span class="icon-option" onclick="selectInventoryIcon('üß™')">üß™</span>
      <span class="icon-option" onclick="selectInventoryIcon('üíä')">üíä</span>
      <span class="icon-option" onclick="selectInventoryIcon('üì¶')">üì¶</span>
      <span class="icon-option" onclick="selectInventoryIcon('üíé')">üíé</span>
      <span class="icon-option" onclick="selectInventoryIcon('üîë')">üîë</span>
      <span class="icon-option" onclick="selectInventoryIcon('üìú')">üìú</span>
      <span class="icon-option" onclick="selectInventoryIcon('üí∞')">üí∞</span>
      <span class="icon-option" onclick="selectInventoryIcon('üçû')">üçû</span>
      <span class="icon-option" onclick="selectInventoryIcon('üß≤')">üß≤</span>
      <span class="icon-option" onclick="selectInventoryIcon('üîÆ')">üîÆ</span>
      <span class="icon-option" onclick="selectInventoryIcon('üìø')">üìø</span>
      <span class="icon-option" onclick="selectInventoryIcon('üëë')">üëë</span>
    </div>
    <input type="text" class="form-input" id="inventory-item-icon" placeholder="ÊàñËº∏ÂÖ•Ëá™ÂÆöÁæ©ÂúñÊ®ô/emoji" maxlength="4" style="width:80px">
  </div>
  <div class="form-group">
    <label class="form-label">Áâ©ÂìÅÂêçÁ®± *</label>
    <input type="text" class="form-input" id="inventory-item-name" placeholder="‰æãÔºöÊúàÂÖâÂäç">
  </div>
  <div class="form-group">
    <label class="form-label">Êï∏Èáè</label>
    <input type="number" class="form-input" id="inventory-item-quantity" value="1" min="1" style="width:100px">
  </div>
  <div class="form-group">
    <label class="form-label">ÂàÜÈ°û</label>
    <select class="form-input" id="inventory-item-category">
      <option value="weapon">‚öîÔ∏è Ê≠¶Âô®</option>
      <option value="armor">üõ°Ô∏è Èò≤ÂÖ∑</option>
      <option value="consumable">üß™ Ê∂àËÄóÂìÅ</option>
      <option value="material">üì¶ ÊùêÊñô</option>
      <option value="key">üîë ÈóúÈçµÁâ©ÂìÅ</option>
      <option value="other">üìã ÂÖ∂‰ªñ</option>
    </select>
  </div>
  <div class="form-group">
    <label class="form-label">ÊèèËø∞</label>
    <textarea class="form-input" id="inventory-item-desc" placeholder="Áâ©ÂìÅÊèèËø∞ÔºàÂèØÈÅ∏Ôºâ" rows="2"></textarea>
  </div>
  <div class="form-group">
    <label class="form-label" style="display:flex;align-items:center;gap:8px">
      <input type="checkbox" id="inventory-item-lorebook"> ÂêåÊ≠•Âà∞ LorebookÔºàAIÂèØË≠òÂà•Ê≠§Áâ©ÂìÅÔºâ
    </label>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('inventory-item-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveInventoryItem()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- Êü•ÊâæÊõøÊèõ Modal -->
<div class="modal" id="find-replace-modal">
  <div class="modal-title">üîç Êü•ÊâæËàáÊõøÊèõ</div>
  <div class="form-group">
    <label class="form-label">Êü•Êâæ</label>
    <input type="text" class="form-input" id="find-text" placeholder="Ëº∏ÂÖ•Ë¶ÅÊü•ÊâæÁöÑÊñáÂ≠ó">
  </div>
  <div class="form-group">
    <label class="form-label">ÊõøÊèõÁÇ∫</label>
    <input type="text" class="form-input" id="replace-text" placeholder="Ëº∏ÂÖ•ÊõøÊèõÂæåÁöÑÊñáÂ≠ó">
  </div>
  <div class="form-group">
    <label style="font-size:13px;color:var(--text-secondary);display:flex;align-items:center;gap:6px;cursor:pointer">
      <input type="checkbox" id="find-case-sensitive"> ÂçÄÂàÜÂ§ßÂ∞èÂØ´
    </label>
  </div>
  <div id="find-result" style="font-size:13px;color:var(--text-tertiary);margin-bottom:12px"></div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('find-replace-modal')">ÈóúÈñâ</button>
    <button class="modal-btn secondary" onclick="findNext()">Êü•Êâæ‰∏ã‰∏ÄÂÄã</button>
    <button class="modal-btn confirm" onclick="replaceAll()">ÂÖ®ÈÉ®ÊõøÊèõ</button>
  </div>
</div>
<!-- Áµ±Ë®àÈù¢Êùø Modal -->
<div class="modal" id="stats-modal">
  <div class="modal-title">üìä Áµ±Ë®àÈù¢Êùø</div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;text-align:center">
      <div style="font-size:24px;font-weight:bold;color:var(--primary)" id="stats-chars">0</div>
      <div style="font-size:12px;color:var(--text-tertiary)">Á∏ΩÂ≠óÊï∏</div>
    </div>
    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;text-align:center">
      <div style="font-size:24px;font-weight:bold;color:var(--primary)" id="stats-msgs">0</div>
      <div style="font-size:12px;color:var(--text-tertiary)">Ê∂àÊÅØÊï∏</div>
    </div>
    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;text-align:center">
      <div style="font-size:24px;font-weight:bold;color:var(--primary)" id="stats-tokens">0</div>
      <div style="font-size:12px;color:var(--text-tertiary)">Á∏Ω Tokens</div>
    </div>
    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;text-align:center">
      <div style="font-size:24px;font-weight:bold;color:var(--primary)" id="stats-time">0h</div>
      <div style="font-size:12px;color:var(--text-tertiary)">ÈÅäÁé©ÊôÇÈï∑</div>
    </div>
  </div>
  <div style="margin-top:16px;padding:12px;background:var(--bg-tertiary);border-radius:8px;font-size:13px">
    <div style="margin-bottom:8px"><strong>Áî®Êà∂Ëº∏ÂÖ•Ôºö</strong><span id="stats-user-chars">0</span> Â≠ó</div>
    <div><strong>AI ÁîüÊàêÔºö</strong><span id="stats-ai-chars">0</span> Â≠ó</div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn confirm" onclick="closeModal('stats-modal')">ÈóúÈñâ</button>
  </div>
</div>
<!-- Ê∑ªÂä†Á´†ÁØÄ Modal -->
<div class="modal" id="chapter-modal">
  <div class="modal-title">üìë Ê∑ªÂä†Á´†ÁØÄ</div>
  <div class="form-group">
    <label class="form-label">Á´†ÁØÄÊ®ôÈ°å</label>
    <input type="text" class="form-input" id="chapter-title" placeholder="‰æãÂ¶ÇÔºöÁ¨¨‰∏ÄÁ´†„ÉªÂÖ•ÂÆÆ">
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('chapter-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveChapter()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- Ê∑ªÂä†Êõ∏Á±§ Modal -->
<div class="modal" id="bookmark-modal">
  <div class="modal-title">üîñ Ê∑ªÂä†Êõ∏Á±§</div>
  <div class="form-group">
    <label class="form-label">Êõ∏Á±§ÂêçÁ®±</label>
    <input type="text" class="form-input" id="bookmark-name" placeholder="‰æãÂ¶ÇÔºöÈáçË¶ÅÂäáÊÉÖÈªû">
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('bookmark-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveBookmark()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- Ê∑ªÂä†Ê®ôÁ±§ Modal -->
<div class="modal" id="tag-modal">
  <div class="modal-title">üè∑Ô∏è Ê∑ªÂä†ÂäáÊÉÖÊ®ôÁ±§</div>
  <div class="form-group">
    <label class="form-label">Ê®ôÁ±§È°ûÂûã</label>
    <select class="form-select" id="tag-type">
      <option value="key">üîë ÈóúÈçµÂäáÊÉÖ</option>
      <option value="scene">üé¨ ÂêçÂ†¥Èù¢</option>
      <option value="clue">üîç Á∑öÁ¥¢</option>
      <option value="turning">üîÑ ËΩâÊäòÈªû</option>
      <option value="emotion">üíï ÊÉÖÊÑüÊà≤</option>
    </select>
  </div>
  <div class="form-group">
    <label class="form-label">ÂÇôË®ªÔºàÂèØÈÅ∏Ôºâ</label>
    <input type="text" class="form-input" id="tag-note" placeholder="Á∞°Áü≠ÊèèËø∞">
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('tag-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="savePlotTag()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- ÂâµÂª∫ÂàÜÊîØ Modal -->
<div class="modal" id="branch-modal">
  <div class="modal-title">üîÄ ÂâµÂª∫ÂàÜÊîØ</div>
  <div class="form-group">
    <label class="form-label">ÂàÜÊîØÂêçÁ®±</label>
    <input type="text" class="form-input" id="branch-name" placeholder="‰æãÂ¶ÇÔºöÈÅ∏ÊìáÂπ´Âä©Â§úÂØí">
  </div>
  <div class="form-group">
    <label class="form-label">ÂàÜÊîØÊèèËø∞ÔºàÂèØÈÅ∏Ôºâ</label>
    <textarea class="form-input" id="branch-desc" style="min-height:60px" placeholder="ÈÄôÂÄãÂàÜÊîØÁöÑÁâπÈªû..."></textarea>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('branch-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveBranch()">ÂâµÂª∫</button>
  </div>
</div>
<!-- AI ‰∏ÄËá¥ÊÄßÊ™¢Êü• Modal -->
<div class="modal" id="ai-check-modal" style="max-width:min(90%,400px)">
  <div class="modal-title">üîç AI ‰∏ÄËá¥ÊÄßÊ™¢Êü•</div>
  <div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">
    AI Â∞áÂàÜÊûêÊïÖ‰∫ãÂÖßÂÆπÔºåÊ™¢Êü•ÊòØÂê¶Â≠òÂú®Ë®≠ÂÆöÁüõÁõæ„ÄÅÊôÇÈñìÁ∑öÈåØË™§„ÄÅËßíËâ≤Ë°åÁÇ∫‰∏ç‰∏ÄËá¥Á≠âÂïèÈ°å„ÄÇ
  </div>
  <div id="ai-check-result" style="background:var(--bg-tertiary);padding:12px;border-radius:8px;min-height:100px;max-height:300px;overflow-y:auto;font-size:13px;white-space:pre-wrap">
    ÈªûÊìä„ÄåÈñãÂßãÊ™¢Êü•„ÄçÈÄ≤Ë°åÂàÜÊûê...
  </div>
  <div class="modal-actions" style="flex-wrap:wrap;gap:8px">
    <button class="modal-btn secondary" id="ai-fix-btn" style="display:none;flex:0 0 auto" onclick="showAiFix()">üîß ÊáâÁî®‰øÆÂæ©</button>
    <button class="modal-btn cancel" onclick="closeModal('ai-check-modal')">ÈóúÈñâ</button>
    <button class="modal-btn confirm" onclick="doAiConsistencyCheck()">ÈñãÂßãÊ™¢Êü•</button>
  </div>
</div>
<!-- AI ‰øÆÂæ©Âª∫Ë≠∞ Modal -->
<div class="modal" id="ai-fix-modal" style="max-width:min(90%,400px)">
  <div class="modal-title">üîß AI ‰øÆÂæ©Âª∫Ë≠∞</div>
  <div style="font-size:14px;margin-bottom:16px">
    ÈÅ∏ÊìáÂ¶Ç‰ΩïËôïÁêÜÁôºÁèæÁöÑÂïèÈ°åÔºö
  </div>
  <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px">
    <button class="action-btn secondary" style="text-align:left;padding:12px" onclick="applyAiFix('auto')">ü§ñ <strong>AI Ëá™Âãï‰øÆÂæ©</strong><br><span style="font-size:12px;color:var(--text-secondary)">Âú®‰∏ãÊ¨° AI ÂõûË¶Ü‰∏≠Ëá™ÁÑ∂Âú∞Á≥æÊ≠£ÂïèÈ°å</span></button>
    <button class="action-btn secondary" style="text-align:left;padding:12px" onclick="applyAiFix('note')">üìù <strong>Ê∑ªÂä†Ë®≠ÂÆöÁ≠ÜË®ò</strong><br><span style="font-size:12px;color:var(--text-secondary)">Ë®òÈåÑÂà∞‰∏ñÁïåËßÄË≥áÊñôÂ∫´‰æõÊó•ÂæåÂèÉËÄÉ</span></button>
    <button class="action-btn secondary" style="text-align:left;padding:12px" onclick="applyAiFix('ignore')">üîï <strong>ÂøΩÁï•ÈÄôÊ¨°</strong><br><span style="font-size:12px;color:var(--text-secondary)">ÈÄôÂÄã„ÄåÂïèÈ°å„ÄçÂèØËÉΩÊòØÊïÖÊÑèË®≠Ë®àÁöÑ</span></button>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('ai-fix-modal')">ÂèñÊ∂à</button>
  </div>
</div>
<!-- v7: ËßíËâ≤ÁãÄÊÖãÊõ¥Êñ∞ Modal -->
<div class="modal" id="char-update-modal" style="max-width:min(90%,420px)">
  <div class="modal-title">ü§ñ AI ËßíËâ≤ÂàÜÊûê</div>
  <div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">
    AI ÊúÉÂàÜÊûêÊïÖ‰∫ãÂÖßÂÆπÔºåËá™ÂãïË≠òÂà•ËßíËâ≤‰∏¶ÊèêÂèñÂ±¨ÊÄß„ÄÇÈÄôÂèØËÉΩÈúÄË¶Å‰∏Ä‰∫õÊôÇÈñì„ÄÇ
  </div>
  <div id="char-update-result" style="background:var(--bg-tertiary);padding:12px;border-radius:8px;min-height:80px;max-height:250px;overflow-y:auto;font-size:12px;white-space:pre-wrap">
    ÈªûÊìä„ÄåÈñãÂßãÂàÜÊûê„ÄçËÆì AI Ë≠òÂà•ËßíËâ≤...
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('char-update-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" id="char-update-btn" onclick="doCharacterUpdate()">ÈñãÂßãÂàÜÊûê</button>
  </div>
</div>
<!-- v8: ËßíËâ≤Ê∑ªÂä†/Á∑®ËºØ ModalÔºàÈáçÊßãÁâà - ÊäòÁñäÈù¢ÊùøÔºâ -->
<div class="modal" id="char-add-modal" style="max-width:min(95%,480px);max-height:85vh;display:flex;flex-direction:column">
  <div class="modal-title" style="flex-shrink:0">
    <span id="char-modal-title">‚ûï Ê∑ªÂä†ËßíËâ≤</span>
    <span id="char-token-count" style="font-size:12px;color:var(--text-secondary);font-weight:normal;margin-left:8px"></span>
  </div>
  <div style="flex:1;overflow-y:auto;padding-right:4px" id="char-edit-scroll">
    <!-- üìã Âü∫Êú¨‰ø°ÊÅØÔºàÈªòË™çÂ±ïÈñãÔºâ -->
    <div class="char-panel" data-panel="basic">
      <div class="char-panel-header" onclick="toggleCharPanel('basic')">
        <span>üìã Âü∫Êú¨‰ø°ÊÅØ</span>
        <span class="char-panel-arrow">‚ñº</span>
      </div>
      <div class="char-panel-content" style="display:block">
        <div class="char-form-row">
          <div class="form-group" style="flex:1">
            <label class="form-label">ËßíËâ≤ÂêçÁ®± *</label>
            <input type="text" class="form-input" id="char-add-name" placeholder="‰æãÂ¶ÇÔºöÂ§úÂØí" oninput="updateCharTokenCount()">
          </div>
          <div class="form-group" style="width:120px">
            <label class="form-label">È†≠ÂÉè</label>
            <div style="display:flex;gap:4px">
              <input type="text" class="form-input" id="char-add-avatar" placeholder="üåô" maxlength="4" style="text-align:center;font-size:20px;flex:1">
              <button type="button" class="action-btn secondary" style="padding:8px;font-size:12px" onclick="uploadCharAvatarInEdit()" title="‰∏äÂÇ≥ÂúñÁâá">üñºÔ∏è</button>
            </div>
            <div id="char-avatar-preview" style="display:none;margin-top:6px;text-align:center">
              <img id="char-avatar-img" style="width:48px;height:48px;border-radius:10px;object-fit:cover">
              <button type="button" style="display:block;margin:4px auto 0;font-size:11px;color:var(--error);background:none;border:none;cursor:pointer" onclick="clearCharAvatarImage()">Ê∏ÖÈô§ÂúñÁâá</button>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">È†≠Èäú/Ë∫´‰ªΩ</label>
          <input type="text" class="form-input" id="char-add-title" placeholder="‰æãÂ¶ÇÔºöÊúàÂÖâËéäÂúíËÄÅÈóÜ">
        </div>
        <div class="form-group">
          <label class="form-label">ÂàÜÈ°û</label>
          <select class="form-input" id="char-add-category">
            <option value="protagonist">‚≠ê ‰∏ªËßí</option>
            <option value="supporting" selected>üë§ ÈÖçËßí</option>
            <option value="npc">üë• NPC</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">ÊèèËø∞ <span class="token-hint" id="desc-tokens"></span></label>
          <textarea class="form-textarea" id="char-add-desc" rows="4" placeholder="Ë©≥Á¥∞ÊèèËø∞ËßíËâ≤ÁöÑÂ§ñË≤å„ÄÅÊÄßÊ†º„ÄÅËÉåÊôØÊïÖ‰∫ã...&#10;ÊîØÊåÅ Markdown Ê†ºÂºè" oninput="updateCharTokenCount()"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">ÊÄßÊ†ºÊëòË¶Å</label>
          <input type="text" class="form-input" id="char-add-personality" placeholder="‰æãÂ¶ÇÔºöÂ§ñÂÜ∑ÂÖßÁÜ±„ÄÅ‰ΩîÊúâÊ¨≤Âº∑„ÄÅÂ∞çËàäÊÑõÂøµÂøµ‰∏çÂøò">
        </div>
        <div class="form-group">
          <label class="form-label">Ê®ôÁ±§ÔºàÁî®ÈÄóËôüÂàÜÈöîÔºâ</label>
          <input type="text" class="form-input" id="char-add-tags" placeholder="‰æãÂ¶ÇÔºöÈú∏ÈÅìÁ∏ΩË£Å, Ââç‰ªª, Ê∑±ÊÉÖ">
        </div>
      </div>
    </div>
    
    <!-- üí¨ Â∞çË©±Ë®≠ÁΩÆÔºàÈªòË™çÊäòÁñäÔºâ -->
    <div class="char-panel" data-panel="dialogue">
      <div class="char-panel-header" onclick="toggleCharPanel('dialogue')">
        <span>üí¨ Â∞çË©±Ë®≠ÁΩÆ</span>
        <span class="char-panel-arrow">‚ñ∂</span>
      </div>
      <div class="char-panel-content" style="display:none">
        <div class="form-group">
          <label class="form-label">ÈñãÂ†¥ÁôΩ <span class="token-hint" id="firstmes-tokens"></span></label>
          <textarea class="form-textarea" id="char-add-firstmes" rows="4" placeholder="ËßíËâ≤ÁöÑÁ¨¨‰∏ÄÊ¢ùÊ∂àÊÅØÔºåÁî®ÊñºÈñãÂßãÊñ∞Â∞çË©±ÊôÇ...&#10;‰æãÂ¶ÇÔºö*‰ªñÊä¨ÁúºÁúãÂêë‰Ω†ÔºåÂò¥ËßíÂæÆÂæÆ‰∏äÊèö* „Äå‰Ω†ÁµÇÊñº‰æÜ‰∫Ü„ÄÇ„Äç" oninput="updateCharTokenCount()"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Êõø‰ª£ÈñãÂ†¥ÁôΩ</label>
          <div id="char-alt-greetings" style="display:flex;flex-direction:column;gap:8px"></div>
          <button class="modal-btn secondary" style="margin-top:8px;padding:6px 12px;font-size:12px" onclick="addAltGreeting()">+ Ê∑ªÂä†Êõø‰ª£ÈñãÂ†¥ÁôΩ</button>
        </div>
        <div class="form-group">
          <label class="form-label">Â†¥ÊôØÊèèËø∞</label>
          <textarea class="form-textarea" id="char-add-scenario" rows="2" placeholder="Â∞çË©±ÁôºÁîüÁöÑËÉåÊôØÊÉÖÂ¢É..."></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Â∞çË©±Á§∫‰æã <span class="token-hint" id="example-tokens"></span></label>
          <textarea class="form-textarea" id="char-add-example" rows="4" placeholder="Á§∫ÁØÑËßíËâ≤Â¶Ç‰ΩïË™™Ë©±ÔºåÂπ´Âä© AI Â≠∏ÁøíË™ûÊ∞£...&#10;Ê†ºÂºèÔºöÁî® &lt;START&gt; ÂàÜÈöîÂ§öÊÆµÁ§∫‰æã" oninput="updateCharTokenCount()"></textarea>
          <div style="margin-top:8px">
            <button class="modal-btn secondary" style="padding:6px 12px;font-size:12px" onclick="openVisualExampleEditor()">üìù ÂèØË¶ñÂåñÁ∑®ËºØÂô®</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ‚öôÔ∏è È´òÁ¥öË®≠ÁΩÆÔºàÈªòË™çÊäòÁñäÔºâ -->
    <div class="char-panel" data-panel="advanced">
      <div class="char-panel-header" onclick="toggleCharPanel('advanced')">
        <span>‚öôÔ∏è È´òÁ¥öË®≠ÁΩÆ</span>
        <span class="char-panel-arrow">‚ñ∂</span>
      </div>
      <div class="char-panel-content" style="display:none">
        <div class="form-group">
          <label class="form-label">ËßíËâ≤Â∞àÂ±¨Á≥ªÁµ±ÊèêÁ§∫Ë©û <span class="token-hint" id="sysprompt-tokens"></span></label>
          <textarea class="form-textarea" id="char-add-sysprompt" rows="3" placeholder="Ë¶ÜËìãÊàñË£úÂÖÖÈªòË™çÁ≥ªÁµ±ÊèêÁ§∫Ë©û...&#10;ÂÉÖÂú®Ë©≤ËßíËâ≤Âá∫Â†¥ÊôÇÁîüÊïà" oninput="updateCharTokenCount()"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">ÂæåÊ≠∑Âè≤Êåá‰ª§</label>
          <textarea class="form-textarea" id="char-add-posthistory" rows="2" placeholder="Âú®Â∞çË©±Ê≠∑Âè≤‰πãÂæåÊ≥®ÂÖ•ÁöÑÊåá‰ª§..."></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Ââµ‰ΩúËÄÖÁ≠ÜË®ò</label>
          <textarea class="form-textarea" id="char-add-creatornotes" rows="2" placeholder="‰ΩøÁî®Ë™™Êòé„ÄÅÊäÄÂ∑ßÁ≠â..."></textarea>
        </div>
        <div class="char-form-row">
          <div class="form-group" style="flex:1">
            <label class="form-label">Ââµ‰ΩúËÄÖ</label>
            <input type="text" class="form-input" id="char-add-creator" placeholder="‰Ω†ÁöÑÂêçÂ≠ó">
          </div>
          <div class="form-group" style="width:100px">
            <label class="form-label">ÁâàÊú¨Ëôü</label>
            <input type="text" class="form-input" id="char-add-version" placeholder="1.0">
          </div>
        </div>
      </div>
    </div>
    
    <!-- üìö ËßíËâ≤ LorebookÔºàÈªòË™çÊäòÁñäÔºâ -->
    <div class="char-panel" data-panel="lorebook">
      <div class="char-panel-header" onclick="toggleCharPanel('lorebook')">
        <span>üìö ËßíËâ≤Â∞àÂ±¨ Lorebook</span>
        <span class="char-panel-arrow">‚ñ∂</span>
      </div>
      <div class="char-panel-content" style="display:none">
        <div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px">
          ÁÇ∫Ë©≤ËßíËâ≤ÂâµÂª∫Â∞àÂ±¨ÁöÑ‰∏ñÁïåÊõ∏Ê¢ùÁõÆÔºåÂÉÖÂú®ËßíËâ≤Âá∫Â†¥ÊôÇËß∏Áôº„ÄÇ
        </div>
        <div class="form-group">
          <label class="form-label">Ëß∏ÁôºÊ®°Âºè</label>
          <select class="form-input" id="char-add-lore-trigger">
            <option value="scene">ÂÉÖÂú®Áï∂ÂâçÂ†¥ÊôØ‰∏≠Ëß∏Áôº</option>
            <option value="always">Âè™Ë¶ÅÊïÖ‰∫ãÂåÖÂê´Ë©≤ËßíËâ≤Â∞±ÂßãÁµÇËß∏Áôº</option>
          </select>
        </div>
        <div id="char-lorebook-entries" style="display:flex;flex-direction:column;gap:8px"></div>
        <button class="modal-btn secondary" style="margin-top:8px;padding:6px 12px;font-size:12px" onclick="addCharLorebookEntry()">+ Ê∑ªÂä†Ê¢ùÁõÆ</button>
      </div>
    </div>
    
    <!-- üë• ËßíËâ≤Èóú‰øÇÔºàÈªòË™çÊäòÁñäÔºâ -->
    <div class="char-panel" data-panel="relations">
      <div class="char-panel-header" onclick="toggleCharPanel('relations')">
        <span>üë• ËßíËâ≤Èóú‰øÇ</span>
        <span class="char-panel-arrow">‚ñ∂</span>
      </div>
      <div class="char-panel-content" style="display:none">
        <div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px">
          ÂÆöÁæ©Ê≠§ËßíËâ≤ËàáÂÖ∂‰ªñËßíËâ≤ÁöÑÈóú‰øÇÔºåAIÊúÉÂèÉËÄÉÈÄô‰∫õ‰ø°ÊÅØ„ÄÇ
        </div>
        <div id="char-relationships-list" style="display:flex;flex-direction:column;gap:10px"></div>
        <button class="modal-btn secondary" style="margin-top:10px;padding:6px 12px;font-size:12px" onclick="addCharRelationship()">+ Ê∑ªÂä†Èóú‰øÇ</button>
      </div>
    </div>
    
    <!-- üé® Ë°®ÊÉÖÁ´ãÁπ™ÔºàÈªòË™çÊäòÁñäÔºâ -->
    <div class="char-panel" data-panel="expressions">
      <div class="char-panel-header" onclick="toggleCharPanel('expressions')">
        <span>üé® Ë°®ÊÉÖÁ´ãÁπ™</span>
        <span class="char-panel-arrow">‚ñ∂</span>
      </div>
      <div class="char-panel-content" style="display:none">
        <div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px">
          ‰∏äÂÇ≥ËßíËâ≤ÁöÑ‰∏çÂêåË°®ÊÉÖÂúñÁâáÔºåAIÂèØÊ†πÊìöÂ∞çË©±ÂÖßÂÆπËá™ÂãïÂàáÊèõ„ÄÇ
        </div>
        <div class="form-group">
          <label class="form-label">Ë°®ÊÉÖÊ®°Âºè</label>
          <select class="form-input" id="char-add-expr-mode" style="width:100%">
            <option value="manual">ÊâãÂãïÂàáÊèõ</option>
            <option value="auto">AI Ëá™ÂãïÂàáÊèõ</option>
          </select>
        </div>
        <div id="char-expressions-list" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px"></div>
        <button class="modal-btn secondary" style="margin-top:12px;padding:6px 12px;font-size:12px;width:100%" onclick="addCharExpression()">+ Ê∑ªÂä†Ë°®ÊÉÖ</button>
        <input type="file" id="expr-file-input" accept="image/*" style="display:none" onchange="handleExpressionUpload(event)">
      </div>
    </div>
    
    <!-- üìä ÁãÄÊÖãÂ±¨ÊÄßÔºàÈªòË™çÊäòÁñäÔºâ -->
    <div class="char-panel" data-panel="stats">
      <div class="char-panel-header" onclick="toggleCharPanel('stats')">
        <span>üìä ÁãÄÊÖãÂ±¨ÊÄß</span>
        <span class="char-panel-arrow">‚ñ∂</span>
      </div>
      <div class="char-panel-content" style="display:none">
        <div class="form-group">
          <label class="form-label">Â±¨ÊÄßÔºàÊØèË°å‰∏ÄÂÄãÔºåÊ†ºÂºèÔºöÂ±¨ÊÄßÂêç:Êï∏ÂÄºÔºâ</label>
          <textarea class="form-textarea" id="char-add-stats" rows="4" placeholder="Â•ΩÊÑü:50&#10;Âø†Ë™†:60&#10;ÈáéÂøÉ:30"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button type="button" class="action-btn secondary" style="font-size:12px" onclick="setCurrentAsInitialStats()">üíæ Ë®≠ÁÇ∫ÂàùÂßãÁãÄÊÖã</button>
            <button type="button" class="action-btn secondary" style="font-size:12px" onclick="resetToInitialStats()">üîÑ ÊÅ¢Âæ©ÂàùÂßãÁãÄÊÖã</button>
          </div>
          <div style="font-size:11px;color:var(--text-tertiary);margin-top:6px">üí° Ë®≠ÁÇ∫ÂàùÂßãÁãÄÊÖãÂæåÔºå„ÄåÈáçÊñ∞ÈñãÂßã„ÄçÊôÇÊúÉÊÅ¢Âæ©Âà∞Ê≠§Êï∏ÂÄº</div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal-actions" style="flex-shrink:0;border-top:1px solid var(--divider);padding-top:12px;margin-top:8px">
    <button class="modal-btn secondary" onclick="aiGenerateCharFields()" style="margin-right:auto">ü§ñ AI ËºîÂä©</button>
    <button class="modal-btn secondary" onclick="setCurrentAsInitialState()" title="Â∞áÁï∂ÂâçÊâÄÊúâË®≠ÂÆö‰øùÂ≠òÁÇ∫ÂàùÂßãË®≠ÂÆöÔºåÈáçÊñ∞ÈñãÂßãÊôÇÊúÉÊÅ¢Âæ©Âà∞Ê≠§ÁâàÊú¨">üíæ Â≠òÁÇ∫ÂàùÂßã</button>
    <button class="modal-btn cancel" onclick="closeCharEditModal()">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveCharacterManual()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- v7: ËßíËâ≤Ë©≥ÊÉÖ/Á∑®ËºØ Modal -->
<div class="modal" id="char-detail-modal" style="max-width:min(90%,420px)">
  <div class="modal-title" id="char-detail-title">ËßíËâ≤Ë©≥ÊÉÖ</div>
  <div id="char-detail-content" style="max-height:50vh;overflow-y:auto"></div>
  <div class="modal-actions" style="flex-wrap:wrap;gap:8px">
    <button class="modal-btn cancel" onclick="closeModal('char-detail-modal')">ÈóúÈñâ</button>
    <button class="modal-btn" onclick="showCharExportOptions()">üì§ Â∞éÂá∫</button>
    <button class="modal-btn secondary" onclick="editCharacter()">Á∑®ËºØ</button>
    <button class="modal-btn" style="background:var(--error);color:white" onclick="deleteCharacter()">Âà™Èô§</button>
  </div>
</div>
<!-- v8: ËßíËâ≤Â∞éÂá∫ÈÅ∏È†Ö Modal -->
<div class="modal" id="char-export-modal" style="max-width:min(90%,320px)">
  <div class="modal-title">üì§ Â∞éÂá∫ËßíËâ≤Âç°</div>
  <div style="padding:16px 0">
    <div style="display:flex;flex-direction:column;gap:12px">
      <button class="modal-btn" style="padding:16px;font-size:15px" onclick="exportCurrentCharacterJSON()">
        üìÑ JSON Ê†ºÂºè<br><span style="font-size:12px;color:var(--text-secondary)">ÈÄöÁî®Ê†ºÂºèÔºåÂèØÂú®ÂÖ∂‰ªñÂπ≥Âè∞Â∞éÂÖ•</span>
      </button>
      <button class="modal-btn" style="padding:16px;font-size:15px" onclick="exportCurrentCharacterPNG()">
        üñºÔ∏è PNG ÂúñÁâá<br><span style="font-size:12px;color:var(--text-secondary)">SillyTavern ÂÖºÂÆπÔºåÂ∏∂ËßíËâ≤ÂúñÁâá</span>
      </button>
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('char-export-modal')">ÂèñÊ∂à</button>
  </div>
</div>
<!-- v8: URL Â∞éÂÖ•ËßíËâ≤Âç° Modal -->
<div class="modal" id="char-url-import-modal" style="max-width:min(90%,380px)">
  <div class="modal-title">üîó Âæû URL Â∞éÂÖ•ËßíËâ≤Âç°</div>
  <div style="padding:16px 0">
    <div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">
      ÊîØÊåÅÁöÑÊ†ºÂºèÔºö<br>
      ‚Ä¢ Áõ¥Êé• JSON/PNG ÈèàÊé•<br>
      ‚Ä¢ Chub.ai ËßíËâ≤È†ÅÈù¢<br>
      ‚Ä¢ CharacterHub ËßíËâ≤È†ÅÈù¢
    </div>
    <input type="text" id="char-url-input" placeholder="Ë´ãËº∏ÂÖ•ËßíËâ≤Âç° URL..." style="width:100%;padding:12px;border:1px solid var(--divider);border-radius:8px;background:var(--bg-tertiary);color:var(--text-primary);font-size:14px">
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('char-url-import-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn" onclick="doImportFromURL()">Â∞éÂÖ•</button>
  </div>
</div>
<!-- v7: ËßíËâ≤Ê≠∑Âè≤Ë®òÈåÑ Modal -->
<div class="modal" id="char-history-modal" style="max-width:min(90%,400px)">
  <div class="modal-title">üìú Â±¨ÊÄßËÆäÂåñÊ≠∑Âè≤</div>
  <div id="char-history-content" style="max-height:50vh;overflow-y:auto"></div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('char-history-modal')">ÈóúÈñâ</button>
  </div>
</div>
<!-- v25: ÈñãÂ†¥ÁôΩÈÅ∏Êìá Modal -->
<div class="modal" id="greeting-select-modal" style="max-width:min(90%,420px)">
  <div class="modal-title">üí¨ ÈÅ∏ÊìáÈñãÂ†¥ÁôΩ</div>
  <div id="greeting-select-content" style="max-height:60vh;overflow-y:auto;padding:8px 0"></div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('greeting-select-modal');skipGreeting()">‰∏ç‰ΩøÁî®ÈñãÂ†¥ÁôΩ</button>
    <button class="modal-btn confirm" onclick="confirmGreeting()">‰ΩøÁî®ÈÅ∏‰∏≠ÁöÑÈñãÂ†¥ÁôΩ</button>
  </div>
</div>
<!-- v25: ËßíËâ≤Èóú‰øÇÂúñË≠ú Modal -->
<div class="modal" id="relationship-graph-modal" style="max-width:min(95%,600px);max-height:85vh">
  <div class="modal-title">üï∏Ô∏è ËßíËâ≤Èóú‰øÇÂúñË≠ú</div>
  <div id="relationship-graph-container" style="width:100%;height:400px;background:var(--bg-tertiary);border-radius:12px;overflow:hidden;position:relative"></div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('relationship-graph-modal')">ÈóúÈñâ</button>
    <button class="modal-btn secondary" onclick="resetGraphView()">ÈáçÁΩÆË¶ñÂúñ</button>
  </div>
</div>
<!-- ‰ºèÁ≠ÜË©≥ÊÉÖ Modal -->
<div class="modal" id="foreshadow-detail-modal" style="max-width:min(95%,500px);max-height:85vh">
  <div class="modal-title">üìå ‰ºèÁ≠ÜË©≥ÊÉÖ</div>
  <div style="max-height:60vh;overflow-y:auto;padding:4px">
    <div class="form-group">
      <label class="form-label">Ê®ôÈ°å</label>
      <input type="text" class="form-input" id="f-detail-title" placeholder="‰ºèÁ≠ÜÊ®ôÈ°å">
    </div>

    <div class="form-group">
      <label class="form-label">ÊèèËø∞</label>
      <textarea class="form-textarea" id="f-detail-desc" rows="3" placeholder="Ë©≥Á¥∞ÊèèËø∞ÈÄôÂÄã‰ºèÁ≠Ü..."></textarea>
    </div>

    <div class="form-group">
      <label class="form-label">Âüã‰∏ãÊôÇÈñì</label>
      <div style="font-size:13px;color:var(--text-secondary);padding:8px;background:var(--bg-tertiary);border-radius:6px" id="f-detail-time">Êú™Áü•</div>
      <button class="action-btn secondary" style="margin-top:8px;width:100%" onclick="jumpToForeshadowMessage()">üìç Ë∑≥ËΩâÂà∞ÂéüÊ∂àÊÅØ</button>
    </div>

    <div class="form-group">
      <label class="form-label">ÁãÄÊÖã</label>
      <select class="form-select" id="f-detail-status">
        <option value="false">üìå Êú™ÂõûÊî∂</option>
        <option value="true">‚úÖ Â∑≤ÂõûÊî∂</option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-label">ÂÑ™ÂÖàÁ¥ö</label>
      <select class="form-select" id="f-detail-priority">
        <option value="low">üü¢ ‰Ωé</option>
        <option value="medium">üü° ‰∏≠</option>
        <option value="high">üü† È´ò</option>
        <option value="urgent">üî¥ Á∑äÊÄ•</option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-label">Ê®ôÁ±§</label>
      <input type="text" class="form-input" id="f-detail-tags" placeholder="Áî®ÈÄóËôüÂàÜÈöîÔºåÂ¶ÇÔºöÊá∏Áñë,‰ºèÁ≠Ü,ÈáçË¶Å">
    </div>

    <div class="form-group">
      <label class="form-label">ÂõûÊî∂Ë®àÂäÉ</label>
      <textarea class="form-textarea" id="f-detail-plan" rows="3" placeholder="Ë®àÂäÉÂ¶Ç‰ΩïÂõûÊî∂ÈÄôÂÄã‰ºèÁ≠Ü..."></textarea>
      <button class="action-btn secondary" style="margin-top:8px;width:100%" onclick="aiGenerateRecoveryPlan()">ü§ñ AI ÁîüÊàêÂõûÊî∂ÊñπÊ°à</button>
    </div>

    <div class="form-group">
      <label class="form-label">Áõ∏ÈóúËßíËâ≤</label>
      <select class="form-select" id="f-detail-characters" multiple style="height:80px">
        <!-- ÂãïÊÖãÂ°´ÂÖÖ -->
      </select>
      <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">Êåâ‰Ωè Ctrl/Cmd ÂèØÂ§öÈÅ∏</div>
    </div>

    <div class="form-group">
      <label class="form-label">Áµ±Ë®à‰ø°ÊÅØ</label>
      <div style="font-size:12px;color:var(--text-secondary);padding:8px;background:var(--bg-tertiary);border-radius:6px">
        <div>üìä Â∑≤ÈÅéÂ∞çË©±Ôºö<span id="f-detail-count">0</span> Ê¢ù</div>
        <div style="margin-top:4px">üìÖ ÂâµÂª∫ÊôÇÈñìÔºö<span id="f-detail-created">-</span></div>
        <div id="f-detail-resolved-info" style="margin-top:4px;display:none">‚úÖ ÂõûÊî∂ÊôÇÈñìÔºö<span id="f-detail-resolved-time">-</span></div>
      </div>
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('foreshadow-detail-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn secondary" onclick="deleteForeshadowDetail()">üóëÔ∏è Âà™Èô§</button>
    <button class="modal-btn confirm" onclick="saveForeshadowDetail()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- ‰ºèÁ≠ÜÂª∫Ë≠∞ Modal -->
<div class="modal" id="foreshadow-suggestions-modal" style="max-width:min(95%,600px);max-height:85vh">
  <div class="modal-title">ü§ñ AI Ë≠òÂà•ÁöÑ‰ºèÁ≠Ü</div>
  <div id="suggestions-content" style="max-height:60vh;overflow-y:auto"></div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('foreshadow-suggestions-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="confirmForeshadowSuggestions()">Ê∑ªÂä†ÈÅ∏‰∏≠ÁöÑ‰ºèÁ≠Ü</button>
  </div>
</div>

<!-- ‰ºèÁ≠ÜÂõûÊî∂Á¢∫Ë™ç Modal -->
<div class="modal" id="foreshadow-resolved-confirm-modal" style="max-width:min(95%,650px);max-height:85vh">
  <div class="modal-title">‚úÖ AI Ê™¢Ê∏¨Âà∞Â∑≤ÂõûÊî∂ÁöÑ‰ºèÁ≠Ü</div>
  <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">
    AI ÂàÜÊûêÁôºÁèæ‰ª•‰∏ã‰ºèÁ≠ÜÂèØËÉΩÂ∑≤Âú®Â∞çË©±‰∏≠ÂõûÊî∂ÔºåË´ãÁ¢∫Ë™çÊòØÂê¶Ê®ôË®òÁÇ∫Â∑≤ÂõûÊî∂„ÄÇ
  </p>

  <!-- ÂàÜÊûêÊëòË¶Å -->
  <div id="foreshadow-analysis-summary" style="margin-bottom:16px"></div>

  <!-- Â∑≤ÂõûÊî∂ÁöÑ‰ºèÁ≠ÜÂàóË°® -->
  <div style="margin-bottom:16px">
    <div style="font-weight:600;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between">
      <span>ÈÅ∏ÊìáË¶ÅÊ®ôË®òÁöÑ‰ºèÁ≠Ü</span>
      <span style="font-size:12px;color:var(--text-tertiary)">ÔºàÈªòË™çÂÖ®ÈÅ∏Ôºâ</span>
    </div>
    <div id="resolved-foreshadow-list" style="max-height:300px;overflow-y:auto"></div>
  </div>

  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('foreshadow-resolved-confirm-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="batchMarkForeshadowResolved()">Ê®ôË®òÁÇ∫Â∑≤ÂõûÊî∂</button>
  </div>
</div>

<!-- ‰ºèÁ≠ÜÊôÇÈñìÁ∑ö Modal -->
<div class="modal" id="foreshadow-timeline-modal" style="max-width:min(95%,700px);max-height:85vh">
  <div class="modal-title">üìÖ ‰ºèÁ≠ÜÊôÇÈñìÁ∑ö</div>
  <div id="foreshadow-timeline-content" style="max-height:60vh;overflow-y:auto;padding:12px"></div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('foreshadow-timeline-modal')">ÈóúÈñâ</button>
  </div>
</div>
<!-- AI Á´†ÁØÄÁ∏ΩÁµê Modal -->
<div class="modal" id="ai-summary-modal" style="max-width:min(90%,400px)">
  <div class="modal-title">üìù AI Á´†ÁØÄÁ∏ΩÁµê</div>
  <div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">
    AI Â∞áËá™ÂãïÁîüÊàêÁï∂ÂâçÊïÖ‰∫ãÈÄ≤Â∫¶ÁöÑÊëòË¶ÅÔºåÂåÖÊã¨‰∏ªË¶Å‰∫ã‰ª∂„ÄÅËßíËâ≤ÁãÄÊÖãËÆäÂåñÁ≠â„ÄÇ
  </div>
  <div id="ai-summary-result" style="background:var(--bg-tertiary);padding:12px;border-radius:8px;min-height:100px;max-height:300px;overflow-y:auto;font-size:13px;white-space:pre-wrap">
    ÈªûÊìä„ÄåÁîüÊàêÁ∏ΩÁµê„ÄçÈñãÂßã...
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('ai-summary-modal')">ÈóúÈñâ</button>
    <button class="modal-btn secondary" onclick="copySummary()">Ë§áË£Ω</button>
    <button class="modal-btn confirm" onclick="doAiChapterSummary()">ÁîüÊàêÁ∏ΩÁµê</button>
  </div>
</div>
<!-- È´òÁ¥öÊêúÁ¥¢ Modal -->
<div class="modal" id="advanced-search-modal">
  <div class="modal-title">üîç È´òÁ¥öÊêúÁ¥¢</div>
  <div class="form-group">
    <label class="form-label">ÈóúÈçµË©û</label>
    <input type="text" class="form-input" id="adv-search-keyword" placeholder="Ëº∏ÂÖ•ÊêúÁ¥¢ÈóúÈçµË©û">
  </div>
  <div class="form-group">
    <label class="form-label">ÊêúÁ¥¢ÁØÑÂúç</label>
    <select class="form-select" id="adv-search-scope">
      <option value="all">ÂÖ®ÈÉ®ÂÖßÂÆπ</option>
      <option value="user">ÂÉÖÁî®Êà∂Ëº∏ÂÖ•</option>
      <option value="ai">ÂÉÖ AI ÂõûÂæ©</option>
    </select>
  </div>
  <div class="form-group">
    <label style="font-size:13px;color:var(--text-secondary);display:flex;align-items:center;gap:6px;cursor:pointer">
      <input type="checkbox" id="adv-search-case"> ÂçÄÂàÜÂ§ßÂ∞èÂØ´
    </label>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('advanced-search-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="doAdvancedSearch()">ÊêúÁ¥¢</button>
  </div>
</div>
<!-- Ë≥áÊñôÁ∑®ËºØ Modal -->
<div class="modal" id="lore-modal">
  <div class="modal-title">üìñ Ë≥áÊñôË®≠ÂÆö</div>
  <div class="form-group">
    <label class="form-label">ÂêçÁ®±</label>
    <input type="text" class="form-input" id="lore-name" placeholder="‰æãÂ¶ÇÔºöÂ§úÂØí„ÄÅÈ≥≥ÂÑÄÂÆÆ">
  </div>
  <div class="form-group">
    <label class="form-label">È°ûÂûã</label>
    <select class="form-select" id="lore-category">
      <option value="character">üë• ËßíËâ≤</option>
      <option value="location">üó∫Ô∏è Âú∞Èªû</option>
      <option value="item">üì¶ Áâ©ÂìÅ</option>
      <option value="setting">üìú Ë®≠ÂÆö</option>
    </select>
  </div>
  <div class="form-group">
    <label class="form-label">Á∞°‰ªã</label>
    <input type="text" class="form-input" id="lore-desc" placeholder="Á∞°Áü≠ÊèèËø∞">
  </div>
  <div class="form-group">
    <label class="form-label">Ë©≥Á¥∞ÂÖßÂÆπ</label>
    <textarea class="form-input" id="lore-content-input" style="min-height:100px" placeholder="Ë©≥Á¥∞Ë®≠ÂÆöÂÖßÂÆπÔºåÊúÉ‰ΩúÁÇ∫‰∏ä‰∏ãÊñáÁôºÈÄÅÁµ¶ AI"></textarea>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('lore-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveLore()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- ÊôÇÈñìËª∏Á∑®ËºØ Modal -->
<div class="modal" id="timeline-modal">
  <div class="modal-title">üìÖ Ê∑ªÂä†ÊôÇÈñìÈªû</div>
  <div class="form-group">
    <label class="form-label">ÊôÇÈñìÊ®ôË®ò</label>
    <input type="text" class="form-input" id="timeline-label" placeholder="‰æãÂ¶ÇÔºöÊò≠È≥≥ÂÖÉÂπ¥„Éª‰∏ÄÊúà‰∫åÊó•">
  </div>
  <div class="form-group">
    <label class="form-label">‰∫ã‰ª∂ÊèèËø∞</label>
    <textarea class="form-input" id="timeline-event" style="min-height:60px" placeholder="ÈÄôÂÄãÊôÇÈñìÈªûÁôºÁîü‰∫Ü‰ªÄÈ∫º"></textarea>
  </div>
  <div class="form-group">
    <label style="font-size:13px;color:var(--text-secondary);display:flex;align-items:center;gap:6px;cursor:pointer">
      <input type="checkbox" id="timeline-set-current" checked> Ë®≠ÁÇ∫Áï∂ÂâçÊïÖ‰∫ãÊôÇÈñì
    </label>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('timeline-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveTimeline()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- iOS ÂÆâË£ùÊåáÂºï Modal -->
<div class="modal" id="ios-install-modal">
  <div class="modal-title">üì± Âú® iPhone ‰∏äÂÆâË£ù</div>
  <div class="modal-content" style="text-align:center">
    <p style="margin-bottom:16px;font-size:15px">Ë´ãÊåâÁÖß‰ª•‰∏ãÊ≠•È©üÂÆâË£ùÂà∞‰∏ªÁï´Èù¢Ôºö</p>
    <div style="text-align:left;background:var(--bg-tertiary);padding:16px;border-radius:8px;margin-bottom:16px">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
        <span style="font-size:24px">1Ô∏è‚É£</span>
        <span>ÈªûÊìäÂ∫ïÈÉ®ÁöÑ <strong>ÂàÜ‰∫´ÊåâÈàï</strong> <span style="font-size:18px">‚¨ÜÔ∏è</span></span>
      </div>
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
        <span style="font-size:24px">2Ô∏è‚É£</span>
        <span>Âêë‰∏ãÊªëÂãïÔºåÈªûÊìä <strong>„ÄåÂä†ÂÖ•‰∏ªÁï´Èù¢„Äç</strong></span>
      </div>
      <div style="display:flex;align-items:center;gap:12px">
        <span style="font-size:24px">3Ô∏è‚É£</span>
        <span>ÈªûÊìä <strong>„ÄåÊñ∞Â¢û„Äç</strong> ÂÆåÊàêÂÆâË£ù</span>
      </div>
    </div>
    <p style="font-size:12px;color:var(--text-tertiary)">ÂÆâË£ùÂæåÔºåÁπîÂ§¢ÊúÉÂÉèÊôÆÈÄö App ‰∏ÄÊ®£Âá∫ÁèæÂú®ÊÇ®ÁöÑ‰∏ªÁï´Èù¢</p>
  </div>
  <div class="modal-actions">
    <button class="modal-btn confirm" onclick="closeModal('ios-install-modal')">Áü•ÈÅì‰∫Ü</button>
  </div>
</div>
<!-- ÂêëÂ∞éËßíËâ≤Á∑®ËºØ Modal -->
<div class="modal" id="wizard-char-modal">
  <div class="modal-title">üë§ ËßíËâ≤Ë®≠ÂÆö</div>
  <input type="hidden" id="wiz-char-idx" value="-1">
  <div class="form-group">
    <label class="form-label">ËßíËâ≤ÂêçÁ®±</label>
    <input type="text" class="form-input" id="wiz-char-name" placeholder="Â¶ÇÔºöÂ§úÂØí„ÄÅÈõ≤ÊÉú...">
  </div>
  <div class="form-group">
    <label class="form-label">Ë∫´‰ªΩÂú∞‰Ωç</label>
    <input type="text" class="form-input" id="wiz-char-role" placeholder="Â¶ÇÔºöÁöáÂ§´„ÄÅË≤ºË∫´‰æçÂ•≥...">
  </div>
  <div class="form-group">
    <label class="form-label">ÊÄßÊ†ºÁâπÈªû</label>
    <input type="text" class="form-input" id="wiz-char-personality" placeholder="Â¶ÇÔºöÊ∑±Ê≤âËÖπÈªë„ÄÅÂø†Ë™†Ê©üÊïè...">
  </div>
  <div class="form-group">
    <label class="form-label">Ëàá‰∏ªËßíÈóú‰øÇ</label>
    <input type="text" class="form-input" id="wiz-char-relation" placeholder="Â¶ÇÔºöË°®Èù¢ÊÅ≠È†ÜÊöóÊá∑ÈáéÂøÉ„ÄÅÁµïÂ∞çÂø†Ë™†...">
  </div>
  <div class="form-group">
    <label class="form-label">Ë©≥Á¥∞ÊèèËø∞ÔºàÂèØÈÅ∏Ôºâ</label>
    <textarea class="form-input" id="wiz-char-desc" style="min-height:80px" placeholder="ËßíËâ≤ÁöÑÊõ¥Â§öÁ¥∞ÁØÄ..."></textarea>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('wizard-char-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveWizardChar()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- ËÅäÂ§©ËÉåÊôØ Modal -->
<div class="modal" id="chat-bg-modal">
  <div class="modal-title">üñºÔ∏è ËÅäÂ§©ËÉåÊôØË®≠ÁΩÆ</div>
  <div class="form-group">
    <label class="form-label">ÈÅ∏ÊìáËÉåÊôØ</label>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
      <div class="bg-option" data-bg="none" onclick="selectBg('none')" style="aspect-ratio:3/4;background:var(--bg-primary);border:2px solid var(--divider);border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--text-tertiary)">ÈªòË™ç</div>
      <div class="bg-option" data-bg="gradient1" onclick="selectBg('gradient1')" style="aspect-ratio:3/4;background:linear-gradient(135deg,#1a1a2e,#16213e);border:2px solid var(--divider);border-radius:8px;cursor:pointer"></div>
      <div class="bg-option" data-bg="gradient2" onclick="selectBg('gradient2')" style="aspect-ratio:3/4;background:linear-gradient(135deg,#0f0f1a,#1e1e32);border:2px solid var(--divider);border-radius:8px;cursor:pointer"></div>
      <div class="bg-option" data-bg="gradient3" onclick="selectBg('gradient3')" style="aspect-ratio:3/4;background:linear-gradient(135deg,#1a0a0a,#2a1515);border:2px solid var(--divider);border-radius:8px;cursor:pointer"></div>
      <div class="bg-option" data-bg="gradient4" onclick="selectBg('gradient4')" style="aspect-ratio:3/4;background:linear-gradient(135deg,#0a1a0a,#152a15);border:2px solid var(--divider);border-radius:8px;cursor:pointer"></div>
      <div class="bg-option" data-bg="custom" onclick="uploadChatBg()" style="aspect-ratio:3/4;background:var(--bg-tertiary);border:2px dashed var(--divider);border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px">üì∑</div>
    </div>
    <div id="current-bg-preview" style="display:none;margin-bottom:12px">
      <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:6px">Áï∂ÂâçËá™ÂÆöÁæ©ËÉåÊôØÔºö</div>
      <div id="bg-preview-img" style="width:100%;aspect-ratio:16/9;background-size:cover;background-position:center;border-radius:8px"></div>
      <button class="modal-btn cancel" style="margin-top:8px;width:100%" onclick="clearChatBg()">Ê∏ÖÈô§Ëá™ÂÆöÁæ©ËÉåÊôØ</button>
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('chat-bg-modal')">ÈóúÈñâ</button>
  </div>
</div>
<!-- ÊïÖ‰∫ãÁ¥öÂà• AI ÂèÉÊï∏Ë®≠ÁΩÆ Modal -->
<div class="modal" id="story-ai-params-modal" style="max-height:85vh;overflow-y:auto">
  <div class="modal-title">üéõÔ∏è Êú¨ÊïÖ‰∫ã AI ÂèÉÊï∏</div>
  <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:16px">ÁÇ∫Áï∂ÂâçÊïÖ‰∫ãË®≠ÁΩÆÁç®Á´ãÁöÑ AI ÂèÉÊï∏Ôºå‰∏çÂΩ±ÈüøÂÖ∂‰ªñÊïÖ‰∫ã</div>
  
  <div style="padding:10px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px">
    <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
      <input type="checkbox" id="story-ai-use-custom" onchange="toggleStoryAICustom(this.checked)" style="width:18px;height:18px">
      <span style="font-size:13px">‰ΩøÁî®Ëá™ÂÆöÁæ©ÂèÉÊï∏ÔºàÂê¶Ââá‰ΩøÁî®ÂÖ®Â±ÄÈªòË™çÂÄºÔºâ</span>
    </label>
  </div>
  
  <div id="story-ai-params-container" style="opacity:0.5;pointer-events:none">
    <div class="form-group">
      <label class="form-label" style="display:flex;justify-content:space-between;align-items:center">
        <span>üé® ÂâµÊÑèÂ∫¶ (Temperature)</span>
        <span id="story-temp-value" style="color:var(--primary);font-weight:600">0.8</span>
      </label>
      <input type="range" id="story-temp-slider" min="0" max="200" value="80" style="width:100%" oninput="updateStoryAIParam('temperature',this.value/100)">
      <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-tertiary);margin-top:4px">
        <span>‰øùÂÆàÁ©©ÂÆö</span>
        <span>ÂâµÊÑèÂ•îÊîæ</span>
      </div>
    </div>
    
    <div class="form-group">
      <label class="form-label" style="display:flex;justify-content:space-between;align-items:center">
        <span>üìä Ë©ûÂΩôÂ§öÊ®£ÊÄß (Top P)</span>
        <span id="story-topp-value" style="color:var(--primary);font-weight:600">0.9</span>
      </label>
      <input type="range" id="story-topp-slider" min="0" max="100" value="90" style="width:100%" oninput="updateStoryAIParam('topP',this.value/100)">
      <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-tertiary);margin-top:4px">
        <span>Á≤æÊ∫ñ</span>
        <span>Â§öÊ®£</span>
      </div>
    </div>
    
    <div style="padding:12px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px">
      <div style="font-size:12px;font-weight:600;margin-bottom:8px">üéØ Âø´ÈÄüÈ†êË®≠</div>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
        <button class="modal-btn" style="padding:8px;font-size:12px" onclick="applyStoryAIPreset('creative')">üé® ÂâµÊÑèÂØ´‰Ωú</button>
        <button class="modal-btn" style="padding:8px;font-size:12px" onclick="applyStoryAIPreset('balanced')">‚öñÔ∏è Âπ≥Ë°°Ê®°Âºè</button>
        <button class="modal-btn" style="padding:8px;font-size:12px" onclick="applyStoryAIPreset('precise')">üéØ Á≤æÊ∫ñÊïò‰∫ã</button>
        <button class="modal-btn" style="padding:8px;font-size:12px" onclick="applyStoryAIPreset('wild')">üå™Ô∏è Â§©È¶¨Ë°åÁ©∫</button>
      </div>
    </div>
  </div>
  
  <div id="story-ai-current-info" style="padding:10px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px;font-size:12px">
    <div style="font-weight:600;margin-bottom:6px">üìã Áï∂ÂâçÁîüÊïàÂèÉÊï∏</div>
    <div id="story-ai-effective-params" style="color:var(--text-secondary)"></div>
  </div>
  
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('story-ai-params-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveStoryAIParams()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- AI ÂèÉÊï∏Ë®≠ÁΩÆ ModalÔºàÂÖ®Â±ÄÈªòË™çÂÄºÔºâ -->
<div class="modal" id="ai-params-modal" style="max-height:85vh;overflow-y:auto">
  <div class="modal-title">üéõÔ∏è AI ÂèÉÊï∏ÈªòË™çÂÄº</div>
  <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:16px">Ë®≠ÁΩÆÊñ∞ÊïÖ‰∫ãÁöÑÈªòË™ç AI ÂèÉÊï∏ÔºåÂ∑≤ÊúâÊïÖ‰∫ãÂèØÂú®ÊïÖ‰∫ãË®≠ÁΩÆ‰∏≠ÂñÆÁç®Ë™øÊï¥</div>
  
  <div class="form-group">
    <label class="form-label" style="display:flex;justify-content:space-between;align-items:center">
      <span>üé® ÂâµÊÑèÂ∫¶ (Temperature)</span>
      <span id="temp-value" style="color:var(--primary);font-weight:600">0.8</span>
    </label>
    <input type="range" id="temp-slider" min="0" max="200" value="80" style="width:100%" oninput="updateAIParam('temperature',this.value/100)">
    <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-tertiary);margin-top:4px">
      <span>‰øùÂÆàÁ©©ÂÆö</span>
      <span>ÂâµÊÑèÂ•îÊîæ</span>
    </div>
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:6px">0.0-0.5 ÈÅ©ÂêàÂäáÊÉÖÊé®ÈÄ≤Ôºå0.7-1.0 ÈÅ©ÂêàÂâµÊÑèÂØ´‰ΩúÔºå1.0+ Êõ¥Èö®Ê©ü</div>
  </div>
  
  <div class="form-group">
    <label class="form-label" style="display:flex;justify-content:space-between;align-items:center">
      <span>üìä Ë©ûÂΩôÂ§öÊ®£ÊÄß (Top P)</span>
      <span id="topp-value" style="color:var(--primary);font-weight:600">0.9</span>
    </label>
    <input type="range" id="topp-slider" min="0" max="100" value="90" style="width:100%" oninput="updateAIParam('topP',this.value/100)">
    <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-tertiary);margin-top:4px">
      <span>Á≤æÊ∫ñ</span>
      <span>Â§öÊ®£</span>
    </div>
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:6px">ÊéßÂà∂Ë©ûÂΩôÈÅ∏ÊìáÁØÑÂúçÔºå0.9-1.0 ËºÉÂ∏∏Áî®</div>
  </div>
  
  <div style="padding:12px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px">
    <div style="font-size:12px;font-weight:600;margin-bottom:8px">üéØ Êé®Ëñ¶È†êË®≠</div>
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
      <button class="modal-btn" style="padding:8px;font-size:12px" onclick="applyAIPreset('creative')">üé® ÂâµÊÑèÂØ´‰Ωú</button>
      <button class="modal-btn" style="padding:8px;font-size:12px" onclick="applyAIPreset('balanced')">‚öñÔ∏è Âπ≥Ë°°Ê®°Âºè</button>
      <button class="modal-btn" style="padding:8px;font-size:12px" onclick="applyAIPreset('precise')">üéØ Á≤æÊ∫ñÊïò‰∫ã</button>
      <button class="modal-btn" style="padding:8px;font-size:12px" onclick="applyAIPreset('wild')">üå™Ô∏è Â§©È¶¨Ë°åÁ©∫</button>
    </div>
  </div>
  
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('ai-params-modal')">ÈóúÈñâ</button>
  </div>
</div>
<!-- Âø´Êç∑Êåá‰ª§ÁÆ°ÁêÜ Modal -->
<div class="modal" id="quick-cmd-modal" style="max-height:85vh;overflow-y:auto">
  <div class="modal-title">‚ö° Âø´Êç∑Êåá‰ª§ÁÆ°ÁêÜ</div>
  <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:16px">
    Ëá™ÂÆöÁæ©Âø´Êç∑ÊåâÈàïÔºåÈªûÊìäÂæåÊúÉËá™ÂãïÁôºÈÄÅÂ∞çÊáâÊåá‰ª§Áµ¶ AI
  </div>
  
  <div id="quick-cmd-list" style="margin-bottom:16px">
    <!-- ÂãïÊÖãÊ∏≤Êüì -->
  </div>
  
  <div style="padding:12px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px">
    <div style="font-size:12px;font-weight:600;margin-bottom:10px">‚ûï Ê∑ªÂä†Êñ∞Êåá‰ª§</div>
    <div class="form-group" style="margin-bottom:10px">
      <input type="text" class="form-input" id="new-cmd-label" placeholder="ÊåâÈàïÈ°ØÁ§∫ÊñáÂ≠óÔºàÂ¶ÇÔºöÂõûÊÜ∂Ôºâ" maxlength="10">
    </div>
    <div class="form-group" style="margin-bottom:10px">
      <input type="text" class="form-input" id="new-cmd-content" placeholder="ÁôºÈÄÅÁµ¶AIÁöÑÊåá‰ª§ÔºàÂ¶ÇÔºöÂõûÊÜ∂ÈÅéÂéªÁöÑ‰∫ãÊÉÖÔºâ">
    </div>
    <button class="modal-btn confirm" style="width:100%" onclick="addQuickCommand()">Ê∑ªÂä†</button>
  </div>
  
  <div style="padding:10px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px;font-size:11px;color:var(--text-tertiary)">
    <div style="font-weight:600;margin-bottom:6px">üí° ÊèêÁ§∫</div>
    <div>‚Ä¢ ÊãñÂãïÊåá‰ª§ÂèØË™øÊï¥È†ÜÂ∫è</div>
    <div>‚Ä¢ È°ØÁ§∫ÊñáÂ≠óÂª∫Ë≠∞ 2-4 ÂÄãÂ≠ó</div>
    <div>‚Ä¢ Êåá‰ª§ÂÖßÂÆπÊúÉÁõ¥Êé•ÁôºÈÄÅÁµ¶ AI</div>
  </div>
  
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="resetQuickCommands()">ÊÅ¢Âæ©ÈªòË™ç</button>
    <button class="modal-btn confirm" onclick="closeModal('quick-cmd-modal')">ÂÆåÊàê</button>
  </div>
</div>
<!-- Á∑®ËºØÂø´Êç∑Êåá‰ª§ Modal -->
<div class="modal" id="edit-cmd-modal">
  <div class="modal-title">‚úèÔ∏è Á∑®ËºØÂø´Êç∑Êåá‰ª§</div>
  <input type="hidden" id="edit-cmd-id">
  <div class="form-group">
    <label class="form-label">ÊåâÈàïÈ°ØÁ§∫ÊñáÂ≠ó</label>
    <input type="text" class="form-input" id="edit-cmd-label" placeholder="Â¶ÇÔºöÂõûÊÜ∂" maxlength="10">
  </div>
  <div class="form-group">
    <label class="form-label">ÁôºÈÄÅÁµ¶AIÁöÑÊåá‰ª§</label>
    <input type="text" class="form-input" id="edit-cmd-content" placeholder="Â¶ÇÔºöÂõûÊÜ∂ÈÅéÂéªÁöÑ‰∫ãÊÉÖ">
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('edit-cmd-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveEditQuickCommand()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- Â†¥ÊôØÁÆ°ÁêÜ Modal -->
<div class="modal" id="scene-modal" style="max-height:85vh;overflow-y:auto">
  <div class="modal-title">üé¨ Â†¥ÊôØÁÆ°ÁêÜ</div>
  <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:16px">
    Ë®≠ÁΩÆÁï∂ÂâçÂ†¥ÊôØ‰∏≠Âú®Â†¥ÁöÑËßíËâ≤ÔºåAI ÊúÉËÆìÈÄô‰∫õËßíËâ≤‰∫íÂãï
  </div>
  
  <div style="margin-bottom:16px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <span style="font-size:13px;font-weight:600">Áï∂ÂâçÂ†¥ÊôØ</span>
      <select class="form-select" id="current-scene" style="width:auto;min-width:120px" onchange="switchScene(this.value)">
        <option value="">ÁÑ°Â†¥ÊôØ</option>
      </select>
    </div>
    <div style="font-size:11px;color:var(--text-tertiary)">ÈÅ∏ÊìáÂ†¥ÊôØÂæåÔºåAI ÊúÉÊ†πÊìöÂú®Â†¥ËßíËâ≤ÈÄ≤Ë°åÂ§öËßíËâ≤‰∫íÂãï</div>
  </div>
  
  <div style="padding:12px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px">
    <div style="font-size:12px;font-weight:600;margin-bottom:10px">üìã Â†¥ÊôØÂàóË°®</div>
    <div id="scene-list" style="max-height:200px;overflow-y:auto">
      <!-- ÂãïÊÖãÊ∏≤Êüì -->
    </div>
    <button class="modal-btn" style="width:100%;margin-top:10px" onclick="createNewScene()">‚ûï ÂâµÂª∫Êñ∞Â†¥ÊôØ</button>
  </div>
  
  <div id="scene-detail-section" style="display:none">
    <div style="padding:12px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px">
      <div style="font-size:12px;font-weight:600;margin-bottom:10px">üë• Âú®Â†¥ËßíËâ≤</div>
      <div id="scene-characters" style="max-height:200px;overflow-y:auto">
        <!-- ÂãïÊÖãÊ∏≤Êüì -->
      </div>
    </div>
  </div>
  
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('scene-modal')">ÈóúÈñâ</button>
  </div>
</div>
<!-- ÂâµÂª∫/Á∑®ËºØÂ†¥ÊôØ Modal -->
<div class="modal" id="scene-edit-modal">
  <div class="modal-title" id="scene-edit-title">ÂâµÂª∫Â†¥ÊôØ</div>
  <input type="hidden" id="scene-edit-id">
  <div class="form-group">
    <label class="form-label">Â†¥ÊôØÂêçÁ®±</label>
    <input type="text" class="form-input" id="scene-edit-name" placeholder="Â¶ÇÔºöÊó©Êúù„ÄÅÂÆ¥ÊúÉ„ÄÅÂæåÂÆÆËä±Âúí...">
  </div>
  <div class="form-group">
    <label class="form-label">Â†¥ÊôØÊèèËø∞ÔºàÂèØÈÅ∏Ôºâ</label>
    <textarea class="form-textarea" id="scene-edit-desc" rows="2" placeholder="ÊèèËø∞ÈÄôÂÄãÂ†¥ÊôØÁöÑÊ∞õÂúç„ÄÅÊôÇÈñì„ÄÅÂú∞ÈªûÁ≠â..."></textarea>
  </div>
  <div class="form-group">
    <label class="form-label">ÈÅ∏ÊìáÂú®Â†¥ËßíËâ≤</label>
    <div id="scene-char-selector" style="max-height:200px;overflow-y:auto;padding:8px;background:var(--bg-tertiary);border-radius:8px">
      <!-- ÂãïÊÖãÊ∏≤ÊüìËßíËâ≤Ë§áÈÅ∏Ê°Ü -->
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('scene-edit-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveScene()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- Áé©ÂÆ∂Èù¢Êùø Modal -->
<div class="modal" id="player-panel-modal" style="max-height:85vh;overflow-y:auto">
  <div class="modal-title">üë§ ÊàëÁöÑÁãÄÊÖã</div>
  <div id="player-panel-content">
    <div style="text-align:center;padding:24px;color:var(--text-tertiary)">
      <div style="font-size:32px;margin-bottom:12px">üìã</div>
      <div style="font-size:14px">ÈÇÑÊ≤íÊúâË®≠ÁΩÆÁãÄÊÖãÈù¢Êùø</div>
      <div style="font-size:12px;margin-top:4px">ÈªûÊìä‰∏ãÊñπÊåâÈàïÂâµÂª∫</div>
    </div>
  </div>
  <button class="player-sync-btn" id="player-sync-btn" onclick="aiSyncPlayerStatus()" style="display:none">
    ü§ñ AI Êô∫ËÉΩÂêåÊ≠•ÔºàÂæûÂ∞çË©±‰∏≠Ëß£ÊûêÊï∏ÂÄºËÆäÂåñÔºâ
  </button>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('player-panel-modal')">ÈóúÈñâ</button>
    <button class="modal-btn" style="background:var(--bg-tertiary);color:var(--text-primary)" onclick="showPlayerPanelSetup()">‚öôÔ∏è Ë®≠ÁΩÆÈù¢Êùø</button>
    <button class="modal-btn confirm" onclick="manualUpdatePlayerPanel()">‚úèÔ∏è Êõ¥Êñ∞Êï∏ÂÄº</button>
  </div>
</div>
<!-- Áé©ÂÆ∂Èù¢ÊùøË®≠ÁΩÆ Modal -->
<div class="modal" id="player-panel-setup-modal" style="max-height:85vh;overflow-y:auto">
  <div class="modal-title">‚öôÔ∏è Ë®≠ÁΩÆÊàëÁöÑÁãÄÊÖãÈù¢Êùø</div>
  <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:16px">
    Ëá™ÂÆöÁæ©Ë¶ÅËøΩËπ§ÁöÑÂ±¨ÊÄßÔºåAI ÊúÉÂú®ÂõûË¶Ü‰∏≠Ëá™ÂãïÊõ¥Êñ∞ÈÄô‰∫õÊï∏ÂÄº
  </div>
  <div class="form-group">
    <label class="form-label">Èù¢ÊùøÂêçÁ®±</label>
    <input type="text" class="form-input" id="player-panel-name" placeholder="Â¶ÇÔºöËßíËâ≤ÁãÄÊÖã„ÄÅÊàëÁöÑË≥áÊñô...">
  </div>
  <div class="form-group">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <label class="form-label" style="margin:0">Â±¨ÊÄßÂàóË°®</label>
      <button class="action-btn secondary" style="padding:4px 10px;font-size:12px" onclick="addPlayerAttribute()">‚ûï Ê∑ªÂä†</button>
    </div>
    <div id="player-attr-list" style="max-height:300px;overflow-y:auto">
      <div style="text-align:center;padding:16px;color:var(--text-tertiary);font-size:13px">ÈÇÑÊ≤íÊúâÂ±¨ÊÄßÔºåÈªûÊìäÊ∑ªÂä†</div>
    </div>
  </div>
  <div class="form-group">
    <button class="action-btn secondary" style="width:100%" onclick="aiGeneratePlayerPanel()">ü§ñ AI Ê†πÊìöË®≠ÂÆöËá™ÂãïÁîüÊàê</button>
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:6px;text-align:center">AI ÊúÉÊ†πÊìöÊïÖ‰∫ãÁöÑ System Prompt Âíå Lorebook Ëá™ÂãïÊé®Ëñ¶ÈÅ©ÂêàÁöÑÂ±¨ÊÄß</div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('player-panel-setup-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="savePlayerPanelSetup()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- Ê∑ªÂä†/Á∑®ËºØÁé©ÂÆ∂Â±¨ÊÄß Modal -->
<div class="modal" id="player-attr-modal">
  <div class="modal-title" id="player-attr-modal-title">‚ûï Ê∑ªÂä†Â±¨ÊÄß</div>
  <input type="hidden" id="player-attr-edit-index" value="-1">
  <div class="form-group">
    <label class="form-label">Â±¨ÊÄßÂêçÁ®±</label>
    <input type="text" class="form-input" id="player-attr-name" placeholder="Â¶ÇÔºöÁèæÈáë„ÄÅÈ´îÂäõ„ÄÅÂ•ΩÊÑüÂ∫¶...">
  </div>
  <div class="form-group">
    <label class="form-label">ÂúñÊ®ô</label>
    <input type="text" class="form-input" id="player-attr-icon" placeholder="üí∞" maxlength="2" style="width:60px">
  </div>
  <div class="form-group">
    <label class="form-label">ÊâÄÂ±¨ÂàÜÁµÑ</label>
    <div id="player-attr-group-selector" class="group-selector">
      <span class="group-chip active" data-group="default" onclick="selectAttrGroup(this)">üìä È†êË®≠</span>
      <span class="group-chip" data-group="stats" onclick="selectAttrGroup(this)">üí™ Âü∫Á§éÂ±¨ÊÄß</span>
      <span class="group-chip" data-group="status" onclick="selectAttrGroup(this)">‚ù§Ô∏è Áï∂ÂâçÁãÄÊÖã</span>
      <span class="group-chip" data-group="finance" onclick="selectAttrGroup(this)">üí∞ Ë≤°Âãô</span>
      <span class="group-chip" data-group="custom" onclick="selectAttrGroup(this)">‚ú® Ëá™ÂÆöÁæ©</span>
    </div>
    <input type="hidden" id="player-attr-group" value="default">
    <div id="player-attr-custom-group" style="display:none;margin-top:8px">
      <input type="text" class="form-input" id="player-attr-custom-group-name" placeholder="Ëº∏ÂÖ•Ëá™ÂÆöÁæ©ÂàÜÁµÑÂêçÁ®±">
    </div>
  </div>
  <div class="form-group">
    <label class="form-label">È°ûÂûã</label>
    <select class="form-select" id="player-attr-type" onchange="updatePlayerAttrTypeUI()">
      <option value="number">Êï∏Â≠óÔºàÂ¶ÇÔºöÈáëÈå¢„ÄÅÂ§©Êï∏Ôºâ</option>
      <option value="percent">ÁôæÂàÜÊØîÔºàÂ¶ÇÔºöÈ´îÂäõ„ÄÅÂ•ΩÊÑüÂ∫¶Ôºâ</option>
      <option value="text">ÊñáÂ≠óÔºàÂ¶ÇÔºöËÅ∑‰Ωç„ÄÅÁ®±ËôüÔºâ</option>
    </select>
  </div>
  <div class="form-group">
    <label class="form-label">È°èËâ≤</label>
    <div class="group-selector">
      <span class="group-chip active" data-color="default" onclick="selectAttrColor(this)" style="border-left:3px solid var(--primary)">È†êË®≠</span>
      <span class="group-chip" data-color="red" onclick="selectAttrColor(this)" style="border-left:3px solid #EF4444">Á¥Ö</span>
      <span class="group-chip" data-color="orange" onclick="selectAttrColor(this)" style="border-left:3px solid #F59E0B">Ê©ô</span>
      <span class="group-chip" data-color="green" onclick="selectAttrColor(this)" style="border-left:3px solid #10B981">Á∂†</span>
      <span class="group-chip" data-color="blue" onclick="selectAttrColor(this)" style="border-left:3px solid #3B82F6">Ëóç</span>
      <span class="group-chip" data-color="purple" onclick="selectAttrColor(this)" style="border-left:3px solid #8B5CF6">Á¥´</span>
      <span class="group-chip" data-color="pink" onclick="selectAttrColor(this)" style="border-left:3px solid #EC4899">Á≤â</span>
    </div>
    <input type="hidden" id="player-attr-color" value="default">
  </div>
  <div id="player-attr-type-options">
    <div class="form-group">
      <label class="form-label">ÂàùÂßãÂÄº</label>
      <input type="text" class="form-input" id="player-attr-default" placeholder="0">
    </div>
    <div class="form-group" id="player-attr-max-group">
      <label class="form-label">ÊúÄÂ§ßÂÄºÔºàÁôæÂàÜÊØîÁî®Ôºâ</label>
      <input type="number" class="form-input" id="player-attr-max" value="100">
    </div>
  </div>
  <div class="form-group">
    <label class="form-label">Ëß∏ÁôºÈóúÈçµË©ûÔºàÁî®ÊñºËá™ÂãïËß£ÊûêÔºâ</label>
    <input type="text" class="form-input" id="player-attr-keywords" placeholder="Â¶ÇÔºöÁèæÈáë, È§òÈ°ç, ÈáëÈå¢">
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">AI ÂõûË¶Ü‰∏≠ÂåÖÂê´ÈÄô‰∫õË©ûÊôÇÊúÉÂòóË©¶Êõ¥Êñ∞Ê≠§Â±¨ÊÄß</div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('player-attr-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="savePlayerAttribute()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- ÊâãÂãïÊõ¥Êñ∞Áé©ÂÆ∂Êï∏ÂÄº Modal -->
<div class="modal" id="player-update-modal" style="max-height:85vh;overflow-y:auto">
  <div class="modal-title">‚úèÔ∏è Êõ¥Êñ∞ÊàëÁöÑÁãÄÊÖã</div>
  <div id="player-update-fields"></div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('player-update-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="savePlayerUpdate()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- AIÁîüÊàêLorebook Modal -->
<div class="modal" id="ai-lorebook-modal" style="max-width:min(95%,500px);max-height:85vh;overflow-y:auto">
  <div class="modal-title">ü§ñ AI Êô∫ËÉΩÊèêÂèñ Lorebook</div>
  <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:16px">
    AI ÊúÉÂæûÊúÄËøëÁöÑÂ∞çË©±ÂäáÊÉÖ‰∏≠Ëá™ÂãïÊèêÂèñËßíËâ≤„ÄÅÂú∞Èªû„ÄÅÁâ©ÂìÅ„ÄÅ‰∫ã‰ª∂Á≠â‰ø°ÊÅØÔºåÁîüÊàê Lorebook Ê¢ùÁõÆ
  </div>
  <div class="form-group">
    <label class="form-label">üìä ÂàÜÊûêÁØÑÂúç</label>
    <div style="padding:12px;background:var(--bg-tertiary);border-radius:8px">
      <div style="margin-bottom:8px;color:var(--text-primary);font-size:13px">
        <span id="ai-lorebook-range-display">ÊúÄËøë 20 Ê¢ùÂ∞çË©±Ê∂àÊÅØ</span>
      </div>
      <input type="range" id="ai-lorebook-range" min="5" max="50" value="20" step="5" style="width:100%;margin:8px 0" oninput="updateLorebookRangeDisplay(this.value)">
      <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text-tertiary)">
        <span>5Ê¢ù</span>
        <span>50Ê¢ù</span>
      </div>
    </div>
  </div>
  <div class="form-group">
    <label class="form-label">üéØ ÊèêÂèñÈÅ∏È†Ö</label>
    <div style="display:flex;flex-direction:column;gap:8px">
      <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer">
        <input type="checkbox" id="ai-lorebook-chars" checked> ÊèêÂèñËßíËâ≤Ë®≠ÂÆöÁÇ∫ËßíËâ≤Âç°
      </label>
      <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer">
        <input type="checkbox" id="ai-lorebook-player" checked> ÊèêÂèñÁé©ÂÆ∂Â±¨ÊÄßÂà∞ÁãÄÊÖãÈù¢Êùø
      </label>
    </div>
  </div>
  <div id="ai-lorebook-preview" style="display:none;margin-bottom:16px">
    <div style="font-size:13px;font-weight:600;margin-bottom:8px">üìã È†êË¶Ω</div>
    <div id="ai-lorebook-preview-content" style="max-height:200px;overflow-y:auto;background:var(--bg-tertiary);border-radius:8px;padding:12px;font-size:12px"></div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('ai-lorebook-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn" id="ai-lorebook-generate-btn" style="background:var(--primary);color:white" onclick="generateAiLorebook()">ü§ñ ÈñãÂßãÊèêÂèñ</button>
  </div>
</div>
<!-- Èõ≤Á´ØÂêåÊ≠•Ë®≠ÁΩÆ Modal -->
<div class="modal" id="cloud-sync-modal" style="max-width:min(95%,500px)">
  <div class="modal-title">‚òÅÔ∏è Èõ≤Á´ØÂêåÊ≠•Ë®≠ÁΩÆ</div>
  <div style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">
    ‰ΩøÁî® GitHub Gist ‰ΩúÁÇ∫Èõ≤Á´ØÂ≠òÂÑ≤ÔºåÂØ¶ÁèæË∑®Ë®≠ÂÇôÂêåÊ≠•
  </div>

  <div class="form-group">
    <label class="form-label">GitHub Personal Access Token</label>
    <input type="password" class="form-input" id="github-token" placeholder="ghp_xxxxxxxxxxxx">
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:6px">
      ÈúÄË¶Å <code style="background:var(--bg-tertiary);padding:2px 4px;border-radius:3px">gist</code> Ê¨äÈôê
    </div>
  </div>

  <div class="form-group">
    <label class="form-label">Gist IDÔºàÂèØÈÅ∏Ôºâ</label>
    <input type="text" class="form-input" id="gist-id" placeholder="ÁïôÁ©∫Â∞áËá™ÂãïÂâµÂª∫Êñ∞ Gist">
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:6px">
      Â¶ÇÊûúÂ∑≤Êúâ GistÔºåÂ°´ÂÖ• ID ÂèØÁπºÁ∫å‰ΩøÁî®
    </div>
  </div>

  <div class="form-group">
    <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
      <input type="checkbox" id="auto-sync-enabled">
      <span class="form-label" style="margin:0">ÂïüÁî®Ëá™ÂãïÂêåÊ≠•</span>
    </label>
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:6px">
      ÊØèÊ¨°‰øùÂ≠òÊïÖ‰∫ãÊôÇËá™Âãï‰∏äÂÇ≥Âà∞Èõ≤Á´Ø
    </div>
  </div>

  <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;margin-bottom:16px">
    <div style="font-size:12px;font-weight:600;margin-bottom:8px">üìñ Â¶Ç‰ΩïÁç≤Âèñ GitHub TokenÔºü</div>
    <ol style="font-size:11px;color:var(--text-secondary);margin:0;padding-left:20px;line-height:1.6">
      <li>Ë®™Âïè <a href="https://github.com/settings/tokens/new" target="_blank" style="color:var(--primary)">GitHub Token Ë®≠ÁΩÆÈ†ÅÈù¢</a></li>
      <li>Note Â°´ÂØ´Ôºö<code style="background:var(--bg-secondary);padding:2px 4px">ÁπîÂ§¢Èõ≤Á´ØÂêåÊ≠•</code></li>
      <li>Expiration ÈÅ∏ÊìáÔºö<code style="background:var(--bg-secondary);padding:2px 4px">No expiration</code></li>
      <li>ÂãæÈÅ∏Ê¨äÈôêÔºö<code style="background:var(--bg-secondary);padding:2px 4px">gist</code></li>
      <li>ÈªûÊìäÂ∫ïÈÉ® <code style="background:var(--bg-secondary);padding:2px 4px">Generate token</code></li>
      <li>Ë§áË£ΩÁîüÊàêÁöÑ TokenÔºà‰ª• ghp_ ÈñãÈ†≠Ôºâ</li>
    </ol>
  </div>

  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('cloud-sync-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveCloudSyncSettings()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- Á∞°ÁπÅËΩâÊèõË®≠ÁΩÆ Modal -->
<div class="modal" id="cn-convert-modal">
  <div class="modal-title">üåê ËØ≠Ë®ÄËÆæÁΩÆ</div>
  <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:16px">
    ËÆæÁΩÆÁïåÈù¢ËØ≠Ë®ÄÂíå AI ËæìÂá∫ËØ≠Ë®Ä
  </div>
  <div class="form-group">
    <label class="form-label">ÁïåÈù¢ËØ≠Ë®Ä</label>
    <select class="form-select" id="ui-language-mode" onchange="updateCnConvertPreview()">
      <option value="sc">ÁÆÄ‰Ωì‰∏≠Êñá</option>
      <option value="tc">ÁπÅÈ´î‰∏≠Êñá</option>
    </select>
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:6px">
      ÂàáÊç¢ÁªáÊ¢¶ÁïåÈù¢ÁöÑÊòæÁ§∫ËØ≠Ë®Ä
    </div>
  </div>
  <div class="form-group">
    <label class="form-label">AI ËæìÂá∫ËØ≠Ë®Ä</label>
    <select class="form-select" id="cn-convert-mode" onchange="updateCnConvertPreview()">
      <option value="follow">Ë∑üÈöèÁïåÈù¢ËØ≠Ë®Ä</option>
      <option value="none">‰∏çÊåáÂÆöÔºàAI ÈªòËÆ§Ôºâ</option>
      <option value="s2t">ÁπÅÈ´î‰∏≠ÊñáÔºàÂè∞ÁÅ£/È¶ôÊ∏ØÔºâ</option>
      <option value="t2s">ÁÆÄ‰Ωì‰∏≠ÊñáÔºà‰∏≠ÂõΩÂ§ßÈôÜÔºâ</option>
    </select>
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:6px">
      ÊåáÁ§∫ AI Áî®Âì™Áßç‰∏≠ÊñáÂõûÂ§ç
    </div>
  </div>
  <div style="padding:10px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px;font-size:12px">
    <div style="font-weight:600;margin-bottom:6px">üí° ÊïàÊûúËØ¥Êòé</div>
    <div id="cn-convert-preview" style="color:var(--text-secondary)">
      ÁïåÈù¢Âíå AI ÈÉΩ‰ΩøÁî®ÁÆÄ‰Ωì‰∏≠Êñá
    </div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('cn-convert-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveChineseConvert()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- Ê®°ÊùøËÆäÈáèË®≠ÁΩÆ Modal -->
<div class="modal" id="template-vars-modal">
  <div class="modal-title">üìù Ê®°ÊùøËÆäÈáèË®≠ÁΩÆ</div>
  <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:16px">
    Ë®≠ÁΩÆÈÄô‰∫õËÆäÈáèÂæåÔºåÂèØ‰ª•Âú®Êåá‰ª§Âíå Lorebook ‰∏≠‰ΩøÁî® <code style="background:var(--bg-tertiary);padding:2px 4px;border-radius:3px">{{ËÆäÈáèÂêç}}</code> ÂºïÁî®
  </div>
  
  <div class="form-group">
    <label class="form-label">{{user}} - Áé©ÂÆ∂Á®±Âëº</label>
    <input type="text" class="form-input" id="var-player-name" placeholder="‰Ω†„ÄÅÈôõ‰∏ã„ÄÅÂ∞ë‰ø†..." value="">
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">AI Á®±ÂëºÁé©ÂÆ∂ÊôÇ‰ΩøÁî®ÁöÑÂêçÂ≠ó</div>
  </div>
  
  <div class="form-group">
    <label class="form-label">{{location}} - Áï∂ÂâçÂú∞Èªû</label>
    <input type="text" class="form-input" id="var-location" placeholder="Èï∑Ê®ÇÂÆÆ„ÄÅËÅöË≥¢Ëéä..." value="">
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">ÊïÖ‰∫ãÁï∂ÂâçÁôºÁîüÁöÑÂú∞Èªû</div>
  </div>
  
  <div style="padding:12px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:16px">
    <div style="font-size:12px;font-weight:600;margin-bottom:8px">üìã ÂèØÁî®ËÆäÈáèÂàóË°®</div>
    <div style="font-size:11px;color:var(--text-secondary);line-height:1.8">
      <div><code>{{user}}</code> ‚Üí Áé©ÂÆ∂Á®±Âëº</div>
      <div><code>{{location}}</code> ‚Üí Áï∂ÂâçÂú∞Èªû</div>
      <div><code>{{time}}</code> ‚Üí ÊïÖ‰∫ãÊôÇÈñìÔºàÂæûÊôÇÈñìËª∏ËÆÄÂèñÔºâ</div>
      <div><code>{{date}}</code> ‚Üí ÁèæÂØ¶Êó•Êúü</div>
      <div><code>{{char:ËßíËâ≤Âêç}}</code> ‚Üí ÊåáÂÆöËßíËâ≤ÁöÑ‰ø°ÊÅØ</div>
    </div>
  </div>
  
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('template-vars-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="saveTemplateVars()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- Persona ÈÅ∏ÊìáÂô® Modal -->
<div class="modal" id="persona-selector-modal">
  <div class="modal-title">üë§ ÈÅ∏ÊìáË∫´‰ªΩ</div>
  <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:16px">
    ÈÅ∏Êìá‰Ω†Âú®ÊïÖ‰∫ã‰∏≠ÊâÆÊºîÁöÑËßíËâ≤Ë∫´‰ªΩÔºåAI ÊúÉÊ†πÊìö‰Ω†ÁöÑË∫´‰ªΩË™øÊï¥ÂõûÊáâ
  </div>
  <div id="persona-list" style="max-height:calc(85vh - 200px);overflow-y:auto;margin-bottom:16px">
    <!-- ÂãïÊÖãÊ∏≤Êüì -->
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('persona-selector-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn" onclick="showPersonaManager()" style="background:var(--bg-tertiary);color:var(--text-primary)">‚öôÔ∏è ÁÆ°ÁêÜË∫´‰ªΩ</button>
  </div>
</div>
<!-- Persona Á∑®ËºØ Modal -->
<div class="modal" id="persona-edit-modal">
  <div class="modal-title" id="persona-edit-title">‚ú® ÂâµÂª∫Êñ∞Ë∫´‰ªΩ</div>
  <input type="hidden" id="persona-edit-id" value="">

  <div style="max-height:calc(85vh - 160px);overflow-y:auto;margin-bottom:16px">
    <div class="form-group">
      <label class="form-label">È†≠ÂÉè</label>
      <input type="text" class="form-input" id="persona-avatar" placeholder="üë∏" maxlength="2">
      <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">Ëº∏ÂÖ•‰∏ÄÂÄã emoji ÊàñÁïôÁ©∫‰ΩøÁî®ÈªòË™ç üë§</div>
    </div>

    <div class="form-group">
      <label class="form-label">ÂêçÁ®± *</label>
      <input type="text" class="form-input" id="persona-name" placeholder="ÊûóÂ©âÂÑø">
    </div>

    <div class="form-group">
      <label class="form-label">Á∞°‰ªã</label>
      <input type="text" class="form-input" id="persona-description" placeholder="Ê±üÂçóÂØåÂïÜ‰πãÂ•≥ÔºåÁü•Êõ∏ÈÅîÁêÜÔºåÊ∫´Â©âÂèØ‰∫∫">
    </div>

    <div class="form-group">
      <label class="form-label">ËÉåÊôØÊïÖ‰∫ã</label>
      <textarea class="form-input" id="persona-background" placeholder="ÊûóÂÆ∂ÊòØÊ±üÂçóÈ¶ñÂØåÔºåÂ©âÂÑøËá™ÂπºÈ£ΩËÆÄË©©Êõ∏..." rows="3"></textarea>
    </div>

    <div class="form-group">
      <label class="form-label">Ë™™Ë©±È¢®Ê†º</label>
      <input type="text" class="form-input" id="persona-speech-style" placeholder="Ë™™Ë©±Ê∫´ÊüîÔºåÂ∏∏Áî®„ÄåÂ•¥ÂÆ∂„ÄçËá™Á®±">
    </div>

    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;font-size:12px;color:var(--text-secondary)">
      <div style="font-weight:600;margin-bottom:6px">üí° ÊèêÁ§∫</div>
      <div style="line-height:1.6">
        ‚Ä¢ Ë®≠ÁΩÆË©≥Á¥∞ÁöÑËÉåÊôØÊïÖ‰∫ãÂèØ‰ª•ËÆì AI Êõ¥Â•ΩÂú∞ÁêÜËß£‰Ω†ÁöÑËßíËâ≤<br>
        ‚Ä¢ Ë™™Ë©±È¢®Ê†ºÊúÉÂΩ±Èüø AI Â∞ç‰Ω†ÁöÑÂõûÊáâÊñπÂºè<br>
        ‚Ä¢ ÂàáÊèõË∫´‰ªΩÂæåÔºåÂª∫Ë≠∞ÈñãÂïüÊñ∞Â∞çË©±‰ª•Áç≤ÂæóÊúÄ‰Ω≥ÊïàÊûú
      </div>
    </div>
  </div>

  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('persona-edit-modal')">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" onclick="savePersona()">‰øùÂ≠ò</button>
  </div>
</div>
<!-- Persona ÁÆ°ÁêÜ Modal -->
<div class="modal" id="persona-manager-modal">
  <div class="modal-title">‚öôÔ∏è ÁÆ°ÁêÜË∫´‰ªΩ</div>
  <div id="persona-manager-list" style="max-height:calc(85vh - 200px);overflow-y:auto;margin-bottom:16px">
    <!-- ÂãïÊÖãÊ∏≤Êüì -->
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('persona-manager-modal')">ÈóúÈñâ</button>
    <button class="modal-btn confirm" onclick="createNewPersona()">+ ÂâµÂª∫Êñ∞Ë∫´‰ªΩ</button>
  </div>
</div>
<!-- Èö±ËóèËº∏ÂÖ• -->
<input type="file" id="file-input" accept=".md,.txt,.json" style="display:none">
<input type="file" id="import-input" accept=".json" style="display:none">
<script>
// ÂÖ®Â±ÄÁä∂ÊÄÅÁÆ°ÁêÜ
// Ê≥®ÊÑèÔºö‰∏∫‰∫ÜÂáèÂ∞ëÂÖ®Â±ÄÂëΩÂêçÁ©∫Èó¥Ê±°ÊüìÔºåÊñ∞‰ª£Á†ÅÂ∫îËØ•‰ΩøÁî® window.App ÂØπË±°
// Áé∞Êúâ‰ª£Á†Å‰∏∫‰∫ÜÂÖºÂÆπÊÄßÊöÇÊó∂‰øùÁïôÁã¨Á´ãÁöÑÂÖ®Â±ÄÂèòÈáè

// Êï∞ÊçÆÂ∫ìÂíåÊ†∏ÂøÉÁä∂ÊÄÅ
let db, story=null, msgs=[], hist=['view-stories'];

// UIÁä∂ÊÄÅÂíåÊ†áÂøó
let generating=false, loadingStoryId=null;

// ÊéßÂà∂Âô®ÂíåÂõûË∞É
let typingCtrl=null, selMsgId=null, confirmCb=null, inputCb=null, editApiId=null;

// ÂÆöÊó∂Âô®
let timeUpdateInterval=null;

// „ÄêÊé®Ëçê„ÄëÁªü‰∏ÄÁöÑÁä∂ÊÄÅËÆøÈóÆÊé•Âè£ÔºàÁî®‰∫éÊú™Êù•ÈáçÊûÑÔºâ
window.App = {
  // Áä∂ÊÄÅËÆøÈóÆÂô®ÔºàËøîÂõûÂΩìÂâçÂÄºÔºâ
  getDB: () => db,
  getStory: () => story,
  getMsgs: () => msgs,
  getHist: () => hist,
  isGenerating: () => generating,

  // ‰æøÊç∑ÊñπÊ≥ï
  reset: () => {
    story = null;
    msgs = [];
    generating = false;
    loadingStoryId = null;
    console.log('[App] Áä∂ÊÄÅÂ∑≤ÈáçÁΩÆ');
  }
};
let settings={theme:'dark',screen:'phone',consist:true,summary:true,suggest:true,typingSpeed:30,contextCount:20,maxTokens:4096,sendKey:'enter',chatBg:'none',chatBgImage:'',fontSize:16,lineHeight:1.6,paragraphSpacing:'1em',
  // AI ÂèÉÊï∏
  temperature:0.8,topP:0.9,frequencyPenalty:0.3,presencePenalty:0.1,
  // Ê®°ÊùøËÆäÈáè
  playerName:'‰Ω†',currentLocation:'',
  // Á∞°ÁπÅËΩâÊèõ
  chineseConvert:'t2s',
  uiLanguage:'sc',  // sc=ÁÆÄ‰Ωì, tc=ÁπÅ‰Ωì
  // ÊµÅÂºèÈüøÊáâ
  enableStreaming:true,streamingChunkDelay:20,
  // Ëá™ÂãïÊëòË¶Å
  autoSummary:true,autoSummaryFrequency:15,maxRollingSummaries:10,
  // AIÊô∫ËÉΩÊèêÂèñLorebook
  autoLorebook:false,autoLorebookFrequency:10,lastLorebookExtractMsg:0,
  // AIËá™Âãï‰∏ÄËá¥ÊÄßÊ™¢Êü•
  autoConsistencyCheck:false,consistencyCheckFrequency:30,lastConsistencyCheckMsg:0,
  // Êô∫ËÉΩ‰∏ä‰∏ãÊñáÈÅ∏Êìá
  smartContext:true,smartContextRecent:10,smartContextMinScore:30,
  // Êô∫ËÉΩËßíËâ≤ÈÅ∏Êìá
  smartCharacterSelection:true,characterRecentMessages:20,alwaysIncludeMainCharacters:true
};

// ÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded',async()=>{
  initOpenCC(); // ÂàùÂßãÂåñ OpenCC ËΩ¨Êç¢Âô®
  await initDB();
  await loadSettings();
  
  // Á°Æ‰øù OpenCC ÂàùÂßãÂåñÂÆåÊàêÂêéÂÜçËΩ¨Êç¢ÁïåÈù¢
  // Â¶ÇÊûú OpenCC ËøòÊ≤°Âä†ËΩΩÂÆåÔºåÁ≠âÂæÖÂπ∂ÈáçËØï
  const tryTranslate = (retries = 5) => {
    if(!openccT2S && typeof OpenCC !== 'undefined'){
      initOpenCC();
    }
    if(openccT2S){
      translateUI();
      console.log('[OpenCC] ÁïåÈù¢ÁøªË≠ØÊàêÂäü');
    } else if(retries > 0){
      console.log(`[OpenCC] Á≠âÂæÖÂä†Ëºâ... Ââ©È§òÈáçË©¶Ê¨°Êï∏: ${retries}`);
      setTimeout(() => tryTranslate(retries - 1), 100);
    } else {
      // ËææÂà∞ÊúÄÂ§ßÈáçËØïÊ¨°Êï∞ÔºåËÆ∞ÂΩïË≠¶Âëä‰ΩÜ‰∏çÂΩ±ÂìçÂ∫îÁî®ËøêË°å
      console.warn('[OpenCC] OpenCC Âä†ËºâÂ§±ÊïóÔºåÂ∞á‰ΩøÁî®ÈªòË™çË™ûË®Ä');
    }
  };
  tryTranslate();
  
  await renderStories();
  await renderInst();
  await renderApi();
  await renderQuickCommands();
  initTypingCancel(); // ÂàùÂßãÂåñÊâìÂ≠óÊ©üÂèñÊ∂àÂäüËÉΩ
  initDraftAutoSave(); // ÂàùÂßãÂåñËçâÁ®øËá™Âä®‰øùÂ≠ò
  updateTime();
  // Â≠òÂÇ®ÂÆöÊó∂Âô®ÂºïÁî®Ôºå‰æø‰∫éÊ∏ÖÁêÜ
  if(timeUpdateInterval) clearInterval(timeUpdateInterval);
  timeUpdateInterval = setInterval(updateTime,60000);
});

// ============================================
// ËçâÁ®øËá™Âä®‰øùÂ≠òÂäüËÉΩ
// ============================================

// ‰øùÂ≠òËçâÁ®øÂà∞Êï∞ÊçÆÂ∫ìÔºà‰ΩøÁî®Èò≤ÊäñÔºå1ÁßíÂêé‰øùÂ≠òÔºâ
const saveDraftToDB = debounce(async (storyId, content) => {
  try {
    await db.stories.update(storyId, {
      draft: content,
      updatedAt: Date.now()
    });
    console.log('[Draft] ËçâÁ®øÂ∑≤Ëá™Âä®‰øùÂ≠ò');
  } catch(e) {
    console.error('[Draft] ‰øùÂ≠òÂ§±Ë¥•:', e);
  }
}, 1000);

// ÂàùÂßãÂåñËçâÁ®øËá™Âä®‰øùÂ≠ò
function initDraftAutoSave(){
  const input = document.getElementById('user-input');
  if(!input) {
    console.warn('[Draft] Êú™ÊâæÂà∞ËæìÂÖ•Ê°ÜÔºåËçâÁ®øËá™Âä®‰øùÂ≠òÊú™ÂêØÁî®');
    return;
  }

  // ÁõëÂê¨ËæìÂÖ•‰∫ã‰ª∂
  input.addEventListener('input', (e) => {
    if(story && e.target.value) {
      saveDraftToDB(story.id, e.target.value).catch(err => {
        console.error('[Draft] ‰øùÂ≠òËçâÁ®øÂ§±Ë¥•:', err);
      });
    }
  });

  console.log('[Draft] ËçâÁ®øËá™Âä®‰øùÂ≠òÂ∑≤ÂêØÁî®');
}

// È°µÈù¢ÂÖ≥Èó≠ÂâçÊèêÈÜíÔºàÂ¶ÇÊûúÊúâÊú™ÂèëÈÄÅÁöÑÂÜÖÂÆπÔºâ
window.addEventListener('beforeunload', (e) => {
  const input = document.getElementById('user-input');
  if(input && input.value.trim() && story) {
    e.preventDefault();
    e.returnValue = 'ÊÇ®ÊúâÊú™ÂèëÈÄÅÁöÑÂÜÖÂÆπÔºåÁ°ÆÂÆöË¶ÅÁ¶ªÂºÄÂêóÔºüÔºàÂÜÖÂÆπÂ∑≤Ëá™Âä®‰øùÂ≠ò‰∏∫ËçâÁ®øÔºâ';
    return e.returnValue;
  }
});

// Êï∏ÊìöÂ∫´
async function initDB(){
  db=new Dexie('ZhimengDB');
  db.version(7).stores({
    stories:'id,title,createdAt,updatedAt,isPinned',
    messages:'id,storyId,branchId,[storyId+branchId],createdAt',
    branches:'id,storyId,parentBranchId,createdAt',
    instructions:'id,createdAt',
    storyInstructions:'[storyId+instructionId],storyId,instructionId',
    loreEntries:'id,storyId,category,createdAt',
    foreshadowing:'id,storyId,messageId,isResolved,createdAt',
    events:'id,storyId,messageId,createdAt',
    characterStates:'id,storyId,loreEntryId',
    timeline:'id,storyId,messageId,order',
    saves:'id,storyId,slotIndex,isAuto,createdAt',
    apiPresets:'id,isActive,createdAt',
    settings:'key',
    chapters:'id,storyId,messageId,order,createdAt',
    bookmarks:'id,storyId,messageId,createdAt',
    plotTags:'id,storyId,messageId,type,createdAt',
    // v7 Êñ∞Â¢ûÔºöËßíËâ≤Á≥ªÁµ±
    characters:'id,storyId,name,createdAt,updatedAt',
    characterSnapshots:'id,storyId,createdAt',
    characterHistory:'id,storyId,characterId,createdAt',
    // v13 Êñ∞Â¢ûÔºöLorebook Á≥ªÁµ±
    lorebook:'id,storyId,name,isEnabled,priority,createdAt',
    lorebookTriggerLog:'id,storyId,lorebookId,createdAt',
    // v16 Êñ∞Â¢ûÔºöÂø´Êç∑Êåá‰ª§
    quickCommands:'id,order,createdAt',
    // v16 Êñ∞Â¢ûÔºöÂ†¥ÊôØÁ≥ªÁµ±
    scenes:'id,storyId,name,isActive,createdAt',
    // v22 Êñ∞Â¢ûÔºöPersona Á≥ªÁµ±
    personas:'id,name,createdAt',
    // v23 Êñ∞Â¢ûÔºöÁé©ÂÆ∂Èù¢ÊùøÁ≥ªÁµ±
    playerPanels:'id,storyId,createdAt'
  });
  
  // v8 Êñ∞Â¢ûÔºöËßíËâ≤Âç° V2 Â≠óÊÆµÔºàCharacter Card V2 Ë¶èÁØÑÔºâ
  // Dexie ÊúÉËá™ÂãïËôïÁêÜÂçáÁ¥öÔºåËàäÊï∏ÊìöÊúÉ‰øùÁïô
  db.version(8).stores({
    stories:'id,title,createdAt,updatedAt,isPinned',
    messages:'id,storyId,branchId,[storyId+branchId],createdAt',
    branches:'id,storyId,parentBranchId,createdAt',
    instructions:'id,createdAt',
    storyInstructions:'[storyId+instructionId],storyId,instructionId',
    loreEntries:'id,storyId,category,createdAt',
    foreshadowing:'id,storyId,messageId,isResolved,createdAt',
    events:'id,storyId,messageId,createdAt',
    characterStates:'id,storyId,loreEntryId',
    timeline:'id,storyId,messageId,order',
    saves:'id,storyId,slotIndex,isAuto,createdAt',
    apiPresets:'id,isActive,createdAt',
    settings:'key',
    chapters:'id,storyId,messageId,order,createdAt',
    bookmarks:'id,storyId,messageId,createdAt',
    plotTags:'id,storyId,messageId,type,createdAt',
    // v8 ÂçáÁ¥öÔºöËßíËâ≤Á≥ªÁµ± V2ÔºàÊîØÊåÅ Character Card V2 Ë¶èÁØÑÔºâ
    // Êñ∞Â¢ûÂ≠óÊÆµÔºöcategory, relationships, scenario, first_mes, alternate_greetings,
    //          mes_example, system_prompt, post_history_instructions, character_book,
    //          expressions, creator_notes, creator, character_version
    characters:'id,storyId,name,category,createdAt,updatedAt',
    characterSnapshots:'id,storyId,createdAt',
    characterHistory:'id,storyId,characterId,createdAt',
    lorebook:'id,storyId,name,isEnabled,priority,createdAt',
    lorebookTriggerLog:'id,storyId,lorebookId,createdAt',
    quickCommands:'id,order,createdAt',
    scenes:'id,storyId,name,isActive,createdAt',
    personas:'id,name,createdAt',
    playerPanels:'id,storyId,createdAt'
  });

  await db.open();
  // ÂàùÂßãÂåñÈªòË™çÂø´Êç∑Êåá‰ª§
  await initDefaultQuickCommands();
  // ÂàùÂßãÂåñÈªòË™ç Persona
  await initDefaultPersona();
}

// Ë®≠ÁΩÆ
async function loadSettings(){
  try{
    const s=await db.settings.toArray();
    s.forEach(x=>{if(x.key in settings)settings[x.key]=x.value});
    applySettings();
  }catch(e){
    console.error('[Settings] ËºâÂÖ•Ë®≠ÁΩÆÂ§±Êïó:', e);
    // ‰ΩøÁî®ÈªòË™çË®≠ÁΩÆÁπºÁ∫åÈÅãË°å
    applySettings();
  }
}
async function saveSetting(k,v){await db.settings.put({key:k,value:v});settings[k]=v;}
function applySettings(){
  const isSC = settings.uiLanguage === 'sc';
  document.documentElement.setAttribute('data-theme',settings.theme);

  const themeVal = document.getElementById('theme-val');
  if(themeVal) themeVal.textContent=settings.theme==='dark'?(isSC?'Ê∑±Ëâ≤Ê®°Âºè ‚Ä∫':'Ê∑±Ëâ≤Ê®°Âºè ‚Ä∫'):(isSC?'ÊµÖËâ≤Ê®°Âºè ‚Ä∫':'Ê∑∫Ëâ≤Ê®°Âºè ‚Ä∫');

  const app=document.getElementById('app');
  const screenVal = document.getElementById('screen-val');
  if(app){
    if(settings.screen==='fullscreen'){
      app.classList.add('fullscreen');
      if(screenVal) screenVal.textContent=isSC?'ÂÖ®Â±èÊ®°Âºè ‚Ä∫':'ÂÖ®Â±èÊ®°Âºè ‚Ä∫';
    } else {
      app.classList.remove('fullscreen');
      if(screenVal) screenVal.textContent=isSC?'ÊâãÊú∫Ê®°ÊãüÂô® ‚Ä∫':'ÊâãÊ©üÊ®°Êì¨Âô® ‚Ä∫';
    }
  }

  ['consist','summary','suggest','autoSummary','autoLorebook'].forEach(k=>{const t=document.getElementById('tog-'+k);if(t){if(settings[k])t.classList.add('active');else t.classList.remove('active');}});
  // Êñ∞Â¢ûË®≠ÁΩÆÈ†ÖÁöÑÈ°ØÁ§∫
  const ctxVal=document.getElementById('context-val');if(ctxVal)ctxVal.textContent=settings.contextCount+(isSC?'Êù°Ê∂àÊÅØ ‚Ä∫':'Ê¢ùÊ∂àÊÅØ ‚Ä∫');
  const autoSummFreqVal=document.getElementById('auto-summary-freq-val');if(autoSummFreqVal)autoSummFreqVal.textContent=(isSC?'ÊØè':'ÊØè')+settings.autoSummaryFrequency+(isSC?'Êù°Ê∂àÊÅØ ‚Ä∫':'Ê¢ùÊ∂àÊÅØ ‚Ä∫');
  const autoLorebookFreqVal=document.getElementById('auto-lorebook-freq-val');if(autoLorebookFreqVal)autoLorebookFreqVal.textContent=(isSC?'ÊØè':'ÊØè')+settings.autoLorebookFrequency+(isSC?'Êù°Ê∂àÊÅØ ‚Ä∫':'Ê¢ùÊ∂àÊÅØ ‚Ä∫');
  const maxVal=document.getElementById('max-tokens-val');if(maxVal)maxVal.textContent=settings.maxTokens+' ‚Ä∫';
  const typVal=document.getElementById('typing-speed-val');if(typVal)typVal.textContent=settings.typingSpeed===0?(isSC?'ÂÖ≥Èó≠ ‚Ä∫':'ÈóúÈñâ ‚Ä∫'):settings.typingSpeed+'ms ‚Ä∫';
  const keyVal=document.getElementById('send-key-val');if(keyVal)keyVal.textContent=settings.sendKey==='enter'?'Enter ‚Ä∫':'Ctrl+Enter ‚Ä∫';
  // ËÅäÂ§©ËÉåÊôØÈ°ØÁ§∫
  const bgVal=document.getElementById('chat-bg-val');
  if(bgVal){
    if(settings.chatBg==='custom'&&settings.chatBgImage)bgVal.textContent=isSC?'Ëá™ÂÆö‰πâ ‚Ä∫':'Ëá™ÂÆöÁæ© ‚Ä∫';
    else if(settings.chatBg==='none')bgVal.textContent=isSC?'ÈªòËÆ§ ‚Ä∫':'ÈªòË™ç ‚Ä∫';
    else bgVal.textContent=isSC?'Ê∏êÂèòËâ≤ ‚Ä∫':'Êº∏ËÆäËâ≤ ‚Ä∫';
  }
  // Â≠óÈ´îÂ§ßÂ∞èÂíåË°åÈñìË∑ù
  const fontVal=document.getElementById('font-size-val');if(fontVal)fontVal.textContent=settings.fontSize+'px ‚Ä∫';
  const lhVal=document.getElementById('line-height-val');if(lhVal)lhVal.textContent=settings.lineHeight+'x ‚Ä∫';
  const psVal=document.getElementById('paragraph-spacing-val');if(psVal)psVal.textContent=settings.paragraphSpacing+' ‚Ä∫';
  // ÊáâÁî®Â≠óÈ´îÂíåË°åÈ´òÂà∞ CSS ËÆäÈáè
  document.documentElement.style.setProperty('--font-size', settings.fontSize + 'px');
  document.documentElement.style.setProperty('--line-height', settings.lineHeight);
  document.documentElement.style.setProperty('--paragraph-spacing', settings.paragraphSpacing);
  // AI ÂèÉÊï∏È°ØÁ§∫
  const aiParamsVal=document.getElementById('ai-params-val');if(aiParamsVal)aiParamsVal.textContent=`T:${settings.temperature} ‚Ä∫`;
  // Ê®°ÊùøËÆäÈáèÈ°ØÁ§∫
  const templateVal=document.getElementById('template-vars-val');if(templateVal)templateVal.textContent=settings.playerName?settings.playerName+' ‚Ä∫':(isSC?'ËÆæÁΩÆ ‚Ä∫':'Ë®≠ÁΩÆ ‚Ä∫');
  // Á∞°ÁπÅËΩâÊèõÈ°ØÁ§∫
  const cnVal=document.getElementById('cn-convert-val');
  if(cnVal){
    if(settings.uiLanguage==='sc')cnVal.textContent='ÁÆÄ‰Ωì ‚Ä∫';
    else cnVal.textContent='ÁπÅÈ´î ‚Ä∫';
  }
  // ÊµÅÂºèÈüøÊáâÈ°ØÁ§∫
  const streamVal=document.getElementById('streaming-val');if(streamVal)streamVal.textContent=settings.enableStreaming?(isSC?'Â∑≤ÂºÄÂêØ ‚Ä∫':'Â∑≤ÈñãÂïü ‚Ä∫'):(isSC?'Â∑≤ÂÖ≥Èó≠ ‚Ä∫':'Â∑≤ÈóúÈñâ ‚Ä∫');
  // Êô∫ËÉΩËßíËâ≤ÈÅ∏ÊìáÈ°ØÁ§∫
  const charSelVal=document.getElementById('char-selection-val');if(charSelVal)charSelVal.textContent=settings.smartCharacterSelection?(isSC?'Â∑≤ÂºÄÂêØ ‚Ä∫':'Â∑≤ÈñãÂïü ‚Ä∫'):(isSC?'Â∑≤ÂÖ≥Èó≠ ‚Ä∫':'Â∑≤ÈóúÈñâ ‚Ä∫');
}
function toggleTheme(){settings.theme=settings.theme==='dark'?'light':'dark';saveSetting('theme',settings.theme);applySettings();toast(T('‰∏ªÈ°åÂ∑≤ÂàáÊèõ'));}
function toggleScreen(){settings.screen=settings.screen==='phone'?'fullscreen':'phone';saveSetting('screen',settings.screen);applySettings();}
function toggleSet(k){settings[k]=!settings[k];saveSetting(k,settings[k]);applySettings();}
function toggleSendKey(){settings.sendKey=settings.sendKey==='enter'?'ctrl+enter':'enter';saveSetting('sendKey',settings.sendKey);applySettings();toast(T('ÁôºÈÄÅÂø´Êç∑ÈçµÂ∑≤ÂàáÊèõ'));}

// Â≠óÈ´îÂ§ßÂ∞èË®≠ÁΩÆ
function showFontSettings(){
  showModal('font-size-modal');
  updateFontOptions();
  document.getElementById('font-preview').style.fontSize = settings.fontSize + 'px';
}
function updateFontOptions(){
  document.querySelectorAll('#font-size-modal .font-option').forEach(btn=>{
    const size = parseInt(btn.dataset.size);
    if(size === settings.fontSize) btn.classList.add('active');
    else btn.classList.remove('active');
  });
}
function selectFontSize(size){
  settings.fontSize = size;
  saveSetting('fontSize', size);
  applySettings();
  updateFontOptions();
  document.getElementById('font-preview').style.fontSize = size + 'px';
  toast('Â≠óÈ´îÂ§ßÂ∞èÂ∑≤Êõ¥ÊîπÁÇ∫ ' + size + 'px');
}

// Ë°åÈñìË∑ùË®≠ÁΩÆ
function showLineHeightSettings(){
  showModal('line-height-modal');
  updateLineHeightOptions();
  document.getElementById('line-height-preview').style.lineHeight = settings.lineHeight;
}
function updateLineHeightOptions(){
  document.querySelectorAll('#line-height-modal .font-option').forEach(btn=>{
    const lh = parseFloat(btn.dataset.lh);
    if(lh === settings.lineHeight) btn.classList.add('active');
    else btn.classList.remove('active');
  });
}
function selectLineHeight(lh){
  settings.lineHeight = lh;
  saveSetting('lineHeight', lh);
  applySettings();
  updateLineHeightOptions();
  document.getElementById('line-height-preview').style.lineHeight = lh;
  toast('Ë°åÈñìË∑ùÂ∑≤Êõ¥ÊîπÁÇ∫ ' + lh + 'x');
}

// ÊÆµËêΩÈñìË∑ùË®≠ÁΩÆ
function showParagraphSpacingSettings(){
  showModal('paragraph-spacing-modal');
  updateParagraphSpacingOptions();
  const preview = document.getElementById('paragraph-spacing-preview');
  if(preview){
    preview.querySelectorAll('p').forEach(p => {
      p.style.marginBottom = settings.paragraphSpacing;
    });
  }
}
function updateParagraphSpacingOptions(){
  document.querySelectorAll('#paragraph-spacing-modal .font-option').forEach(btn=>{
    const ps = btn.dataset.ps + 'em';
    if(ps === settings.paragraphSpacing) btn.classList.add('active');
    else btn.classList.remove('active');
  });
}
function selectParagraphSpacing(ps){
  settings.paragraphSpacing = ps;
  saveSetting('paragraphSpacing', ps);
  applySettings();
  updateParagraphSpacingOptions();
  const preview = document.getElementById('paragraph-spacing-preview');
  if(preview){
    preview.querySelectorAll('p').forEach(p => {
      p.style.marginBottom = ps;
    });
  }
  toast('ÊÆµËêΩÈñìË∑ùÂ∑≤Êõ¥ÊîπÁÇ∫ ' + ps);
}

// Ëá™ÂãïÊëòË¶ÅÈ†ªÁéáË®≠ÁΩÆ
function showAutoSummaryFrequencySettings(){
  showModal('auto-summary-freq-modal');
  updateAutoSummaryFrequencyOptions();
}
function updateAutoSummaryFrequencyOptions(){
  document.querySelectorAll('#auto-summary-freq-modal .font-option').forEach(btn=>{
    const freq = parseInt(btn.dataset.freq);
    if(freq === settings.autoSummaryFrequency) btn.classList.add('active');
    else btn.classList.remove('active');
  });
}
function selectAutoSummaryFrequency(freq){
  settings.autoSummaryFrequency = freq;
  saveSetting('autoSummaryFrequency', freq);
  applySettings();
  updateAutoSummaryFrequencyOptions();
  toast('ÊëòË¶ÅÁîüÊàêÈ†ªÁéáÂ∑≤Êõ¥ÊîπÁÇ∫ÊØè ' + freq + ' Ê¢ùÊ∂àÊÅØ');
}

// AIËá™ÂãïÊèêÂèñLorebookÈ†ªÁéáË®≠ÁΩÆ
function showAutoLorebookFrequencySettings(){
  showModal('auto-lorebook-freq-modal');
  updateAutoLorebookFrequencyOptions();
}
function updateAutoLorebookFrequencyOptions(){
  document.querySelectorAll('#auto-lorebook-freq-modal .font-option').forEach(btn=>{
    const freq = parseInt(btn.dataset.freq);
    if(freq === settings.autoLorebookFrequency) btn.classList.add('active');
    else btn.classList.remove('active');
  });
}
function selectAutoLorebookFrequency(freq){
  settings.autoLorebookFrequency = freq;
  saveSetting('autoLorebookFrequency', freq);
  applySettings();
  updateAutoLorebookFrequencyOptions();
  toast('LorebookÊèêÂèñÈ†ªÁéáÂ∑≤Êõ¥ÊîπÁÇ∫ÊØè ' + freq + ' Ê¢ùÊ∂àÊÅØ');
}

// ============ AI ÂèÉÊï∏Ë®≠ÁΩÆ ============
function showAIParamsSettings(){
  showModal('ai-params-modal');
  // Êõ¥Êñ∞ÊªëÂ°äÂÄº
  document.getElementById('temp-slider').value = settings.temperature * 100;
  document.getElementById('temp-value').textContent = settings.temperature.toFixed(1);
  document.getElementById('topp-slider').value = settings.topP * 100;
  document.getElementById('topp-value').textContent = settings.topP.toFixed(1);
}

function updateAIParam(param, value){
  value = parseFloat(value);
  settings[param] = value;
  saveSetting(param, value);
  
  // Êõ¥Êñ∞È°ØÁ§∫
  switch(param){
    case 'temperature':
      document.getElementById('temp-value').textContent = value.toFixed(1);
      break;
    case 'topP':
      document.getElementById('topp-value').textContent = value.toFixed(1);
      break;
  }
  applySettings();
}

function applyAIPreset(preset){
  const presets = {
    creative: { temperature: 1.0, topP: 0.95 },
    balanced: { temperature: 0.8, topP: 0.9 },
    precise: { temperature: 0.5, topP: 0.8 },
    wild: { temperature: 1.5, topP: 1.0 }
  };
  
  const p = presets[preset];
  if(!p) return;
  
  settings.temperature = p.temperature;
  settings.topP = p.topP;
  
  saveSetting('temperature', p.temperature);
  saveSetting('topP', p.topP);
  
  // Êõ¥Êñ∞ UI
  showAIParamsSettings();
  applySettings();
  
  const names = { creative: 'ÂâµÊÑèÂØ´‰Ωú', balanced: 'Âπ≥Ë°°Ê®°Âºè', precise: 'Á≤æÊ∫ñÊïò‰∫ã', wild: 'Â§©È¶¨Ë°åÁ©∫' };
  toast(`Â∑≤Â•óÁî®„Äå${names[preset]}„ÄçÈ†êË®≠`);
}

// ÂÖ®Â±ÄÈªòË™ç AI ÂèÉÊï∏Ë®≠ÁΩÆÔºàÂà•ÂêçÔºâ
function showDefaultAIParams(){
  showAIParamsSettings();
}

// ============ ÊïÖ‰∫ãÁ¥öÂà• AI ÂèÉÊï∏Ë®≠ÁΩÆ ============
let storyAIParamsTemp = null; // Ëá®ÊôÇÂ≠òÂÑ≤Á∑®ËºØ‰∏≠ÁöÑÂèÉÊï∏

function showStoryAIParams(){
  if(!story){toast(T('Ë´ãÂÖàÊâìÈñã‰∏ÄÂÄãÊïÖ‰∫ã'),'warning');return;}
  closeAll();
  
  // ËÆÄÂèñÊïÖ‰∫ãÁöÑ AI ÂèÉÊï∏
  const hasCustom = story.aiParams && story.aiParams.useCustom;
  const params = story.aiParams || {
    useCustom: false,
    temperature: settings.temperature,
    topP: settings.topP,
    frequencyPenalty: settings.frequencyPenalty,
    presencePenalty: settings.presencePenalty
  };
  
  storyAIParamsTemp = {...params};
  
  // Ë®≠ÁΩÆ checkbox
  document.getElementById('story-ai-use-custom').checked = hasCustom;
  toggleStoryAICustom(hasCustom);
  
  // Ë®≠ÁΩÆÊªëÂ°äÂÄº
  document.getElementById('story-temp-slider').value = params.temperature * 100;
  document.getElementById('story-temp-value').textContent = params.temperature.toFixed(1);
  document.getElementById('story-topp-slider').value = params.topP * 100;
  document.getElementById('story-topp-value').textContent = params.topP.toFixed(1);
  
  // Êõ¥Êñ∞Áï∂ÂâçÁîüÊïàÂèÉÊï∏È°ØÁ§∫
  updateEffectiveParamsDisplay();
  
  showModal('story-ai-params-modal');
}

function toggleStoryAICustom(checked){
  const container = document.getElementById('story-ai-params-container');
  if(checked){
    container.style.opacity = '1';
    container.style.pointerEvents = 'auto';
    storyAIParamsTemp.useCustom = true;
  } else {
    container.style.opacity = '0.5';
    container.style.pointerEvents = 'none';
    storyAIParamsTemp.useCustom = false;
  }
  updateEffectiveParamsDisplay();
}

function updateStoryAIParam(param, value){
  value = parseFloat(value);
  storyAIParamsTemp[param] = value;
  
  // Êõ¥Êñ∞È°ØÁ§∫
  switch(param){
    case 'temperature':
      document.getElementById('story-temp-value').textContent = value.toFixed(1);
      break;
    case 'topP':
      document.getElementById('story-topp-value').textContent = value.toFixed(1);
      break;
  }
  updateEffectiveParamsDisplay();
}

function applyStoryAIPreset(preset){
  const presets = {
    creative: { temperature: 1.0, topP: 0.95 },
    balanced: { temperature: 0.8, topP: 0.9 },
    precise: { temperature: 0.5, topP: 0.8 },
    wild: { temperature: 1.5, topP: 1.0 }
  };
  
  const p = presets[preset];
  if(!p) return;
  
  storyAIParamsTemp.temperature = p.temperature;
  storyAIParamsTemp.topP = p.topP;
  
  // Êõ¥Êñ∞ÊªëÂ°ä
  document.getElementById('story-temp-slider').value = p.temperature * 100;
  document.getElementById('story-temp-value').textContent = p.temperature.toFixed(1);
  document.getElementById('story-topp-slider').value = p.topP * 100;
  document.getElementById('story-topp-value').textContent = p.topP.toFixed(1);
  
  updateEffectiveParamsDisplay();
  
  const names = { creative: 'ÂâµÊÑèÂØ´‰Ωú', balanced: 'Âπ≥Ë°°Ê®°Âºè', precise: 'Á≤æÊ∫ñÊïò‰∫ã', wild: 'Â§©È¶¨Ë°åÁ©∫' };
  toast(`Â∑≤Â•óÁî®„Äå${names[preset]}„ÄçÈ†êË®≠`);
}

async function saveStoryAIParams(){
  if(!story) return;
  
  story.aiParams = {
    useCustom: storyAIParamsTemp.useCustom,
    temperature: storyAIParamsTemp.temperature,
    topP: storyAIParamsTemp.topP,
    frequencyPenalty: storyAIParamsTemp.frequencyPenalty,
    presencePenalty: storyAIParamsTemp.presencePenalty
  };
  story.updatedAt = Date.now();
  
  await db.stories.put(story);
  closeModal('story-ai-params-modal');

  if(story.aiParams.useCustom){
    toast(`Â∑≤‰øùÂ≠òÊú¨ÊïÖ‰∫ãÁöÑ AI ÂèÉÊï∏ (T:${story.aiParams.temperature})`,'success');
  } else {
    toast(T('Â∑≤Ë®≠ÁÇ∫‰ΩøÁî®ÂÖ®Â±ÄÈªòË™çÂèÉÊï∏'),'success');
  }

  // Ëá™ÂãïÂêåÊ≠•Âà∞Èõ≤Á´Ø
  autoSyncToCloud();
}

function updateEffectiveParamsDisplay(){
  const el = document.getElementById('story-ai-effective-params');
  if(!el) return;
  
  let params;
  let source;
  
  if(storyAIParamsTemp && storyAIParamsTemp.useCustom){
    params = storyAIParamsTemp;
    source = 'Êú¨ÊïÖ‰∫ãËá™ÂÆöÁæ©';
  } else {
    params = settings;
    source = 'ÂÖ®Â±ÄÈªòË™çÂÄº';
  }
  
  el.innerHTML = `
    <div style="margin-bottom:4px">‰æÜÊ∫êÔºö<span style="color:var(--primary)">${source}</span></div>
    <div>Temperature: ${params.temperature.toFixed(1)} | Top P: ${params.topP.toFixed(1)}</div>
  `;
}

// Áç≤ÂèñÁï∂ÂâçÊáâË©≤‰ΩøÁî®ÁöÑ AI ÂèÉÊï∏ÔºàÂÑ™ÂÖàÊïÖ‰∫ãÁ¥öÂà•ÔºåÂÖ∂Ê¨°ÂÖ®Â±ÄÈªòË™çÔºâ
function getAIParams(){
  if(story && story.aiParams && story.aiParams.useCustom){
    return {
      temperature: story.aiParams.temperature,
      topP: story.aiParams.topP,
      frequencyPenalty: story.aiParams.frequencyPenalty,
      presencePenalty: story.aiParams.presencePenalty
    };
  }
  return {
    temperature: settings.temperature || 0.8,
    topP: settings.topP || 0.9,
    frequencyPenalty: settings.frequencyPenalty || 0.3,
    presencePenalty: settings.presencePenalty || 0.1
  };
}

// ============ Ê®°ÊùøËÆäÈáèË®≠ÁΩÆ ============
function showTemplateVarsSettings(){
  showModal('template-vars-modal');
  document.getElementById('var-player-name').value = settings.playerName || '';
  document.getElementById('var-location').value = settings.currentLocation || '';
}

function saveTemplateVars(){
  const playerName = document.getElementById('var-player-name').value.trim();
  const location = document.getElementById('var-location').value.trim();
  
  settings.playerName = playerName;
  settings.currentLocation = location;
  
  saveSetting('playerName', playerName);
  saveSetting('currentLocation', location);
  
  closeModal('template-vars-modal');
  applySettings();
  toast(T('Ê®°ÊùøËÆäÈáèÂ∑≤‰øùÂ≠ò'), 'success');
}

// ÊõøÊèõÊ®°ÊùøËÆäÈáè
function replaceTemplateVars(text){
  if(!text) return text;
  
  // {{user}} - Áé©ÂÆ∂Á®±Âëº
  text = text.replace(/\{\{user\}\}/gi, settings.playerName || '‰Ω†');
  
  // {{location}} - Áï∂ÂâçÂú∞Èªû
  text = text.replace(/\{\{location\}\}/gi, settings.currentLocation || 'Ê≠§Ëôï');
  
  // {{time}} - ÊïÖ‰∫ãÊôÇÈñìÔºàÊ∑ªÂä†storyÂ≠òÂú®ÊÄßÊ™¢Êü•Ôºâ
  const storyTime = story && story.storyTime ? story.storyTime : '';
  text = text.replace(/\{\{time\}\}/gi, storyTime || 'Áï∂Ââç');
  
  // {{date}} - ÁèæÂØ¶Êó•Êúü
  const today = new Date();
  const dateStr = `${today.getFullYear()}Âπ¥${today.getMonth()+1}Êúà${today.getDate()}Êó•`;
  text = text.replace(/\{\{date\}\}/gi, dateStr);
  
  // {{char:ËßíËâ≤Âêç}} - ÊåáÂÆöËßíËâ≤ÁöÑ‰ø°ÊÅØÔºàÁï∞Ê≠•ÔºåÈÄôË£°Âè™ÂÅöÁ∞°ÂñÆÊõøÊèõÔºâ
  text = text.replace(/\{\{char:([^}]+)\}\}/gi, (match, charName) => {
    return `„Äê${charName}„Äë`;
  });
  
  return text;
}

// ÂúñÁâá‰∏äÂÇ≥Áõ∏Èóú
let imageUploadTarget = null; // 'storyCover' | 'charAvatar' | 'chatBg' | {type: 'charAvatar', charId: xxx}

// Â£ìÁ∏ÆÂúñÁâá
async function compressImage(file, maxWidth = 400, quality = 0.8) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        
        if (width > maxWidth) {
          height = (height * maxWidth) / width;
          width = maxWidth;
        }
        
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        const dataUrl = canvas.toDataURL('image/jpeg', quality);
        resolve(dataUrl);
      };
      img.onerror = reject;
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// ËôïÁêÜÂúñÁâá‰∏äÂÇ≥
async function handleImageUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  try {
    showLoading('ËôïÁêÜÂúñÁâá‰∏≠...');
    const maxWidth = imageUploadTarget === 'chatBg' ? 1920 : 400;
    const dataUrl = await compressImage(file, maxWidth, 0.85);
    
    // Âæû‰∏ªÈ†ÅÊõ¥ÊèõÂ∞ÅÈù¢ÔºàÂ∏∂storyIdÁöÑÂ∞çË±°Ôºâ
    if (typeof imageUploadTarget === 'object' && imageUploadTarget.type === 'storyCover') {
      const targetStoryId = imageUploadTarget.storyId;
      await db.stories.update(targetStoryId, { coverImage: dataUrl });
      // Â¶ÇÊûúÁï∂ÂâçÊâìÈñãÁöÑÊïÖ‰∫ãÂ∞±ÊòØÈÄôÂÄãÊïÖ‰∫ãÔºå‰πüÊõ¥Êñ∞ÂÖ®Â±ÄËÆäÈáè
      if (story && story.id === targetStoryId) {
        story.coverImage = dataUrl;
      }
      await renderStories();
      toast(T('Â∞ÅÈù¢Â∑≤Êõ¥Êñ∞'), 'success');
    } else if (imageUploadTarget === 'storyCover' && story) {
      // ÂæûÊïÖ‰∫ãÂÖßÈÉ®Êõ¥ÊèõÂ∞ÅÈù¢
      await db.stories.update(story.id, { coverImage: dataUrl });
      story.coverImage = dataUrl;
      await renderStories();
      toast(T('Â∞ÅÈù¢Â∑≤Êõ¥Êñ∞'), 'success');
    } else if (imageUploadTarget === 'chatBg') {
      settings.chatBg = 'custom';
      settings.chatBgImage = dataUrl;
      await saveSetting('chatBg', 'custom');
      await saveSetting('chatBgImage', dataUrl);
      applyChatBg();
      closeModal('chat-bg-modal');
      toast(T('ËÉåÊôØÂ∑≤Êõ¥Êñ∞'), 'success');
    } else if (typeof imageUploadTarget === 'object' && imageUploadTarget.type === 'charAvatar') {
      const charId = imageUploadTarget.charId;
      await db.characters.update(charId, { avatarImage: dataUrl, updatedAt: Date.now() });
      renderCharacters();
      toast(T('È†≠ÂÉèÂ∑≤Êõ¥Êñ∞'), 'success');
    } else if (typeof imageUploadTarget === 'object' && imageUploadTarget.type === 'charAvatarEdit') {
      // Âú®ËßíËâ≤Á∑®ËºØÁïåÈù¢‰∏äÂÇ≥ÂúñÁâáÔºàÊö´Â≠òÔºå‰øùÂ≠òÊôÇÊâçÂØ´ÂÖ•Êï∏ÊìöÂ∫´Ôºâ
      tempCharAvatarImage = dataUrl;
      document.getElementById('char-avatar-preview').style.display = 'block';
      document.getElementById('char-avatar-img').src = dataUrl;
      toast(T('ÂúñÁâáÂ∑≤ÈÅ∏ÊìáÔºå‰øùÂ≠òËßíËâ≤ÂæåÁîüÊïà'), 'success');
    }
    
    hideLoading();
  } catch (e) {
    hideLoading();
    toast('ÂúñÁâáËôïÁêÜÂ§±Êïó: ' + e.message, 'error');
  }
  
  // Ê∏ÖÁ©∫ input
  event.target.value = '';
}

// ‰∏äÂÇ≥ÊïÖ‰∫ãÂ∞ÅÈù¢
function uploadStoryCover() {
  if (!story) return toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'));
  imageUploadTarget = 'storyCover';
  document.getElementById('image-upload').click();
}

// ‰∏äÂÇ≥ËßíËâ≤È†≠ÂÉè
function uploadCharAvatar(charId) {
  imageUploadTarget = { type: 'charAvatar', charId };
  document.getElementById('image-upload').click();
}

// Âú®ËßíËâ≤Á∑®ËºØÁïåÈù¢‰∏äÂÇ≥ÂúñÁâá
let tempCharAvatarImage = null;
function uploadCharAvatarInEdit() {
  imageUploadTarget = { type: 'charAvatarEdit' };
  document.getElementById('image-upload').click();
}

// Ê∏ÖÈô§ËßíËâ≤Á∑®ËºØÁïåÈù¢ÁöÑÂúñÁâá
function clearCharAvatarImage() {
  tempCharAvatarImage = null;
  document.getElementById('char-avatar-preview').style.display = 'none';
  document.getElementById('char-avatar-img').src = '';
}

// ËÅäÂ§©ËÉåÊôØË®≠ÁΩÆ
function setChatBackground() {
  // Êõ¥Êñ∞ÈÅ∏‰∏≠ÁãÄÊÖã
  document.querySelectorAll('.bg-option').forEach(el => {
    el.style.borderColor = el.dataset.bg === settings.chatBg ? 'var(--primary)' : 'var(--divider)';
  });
  // È°ØÁ§∫Ëá™ÂÆöÁæ©ËÉåÊôØÈ†êË¶Ω
  const preview = document.getElementById('current-bg-preview');
  const previewImg = document.getElementById('bg-preview-img');
  if (settings.chatBg === 'custom' && settings.chatBgImage) {
    preview.style.display = 'block';
    previewImg.style.backgroundImage = `url(${settings.chatBgImage})`;
  } else {
    preview.style.display = 'none';
  }
  showModal('chat-bg-modal');
}

function selectBg(bg) {
  if (bg === 'custom') return; // Áî± uploadChatBg ËôïÁêÜ
  settings.chatBg = bg;
  saveSetting('chatBg', bg);
  applyChatBg();
  // Êõ¥Êñ∞ÈÅ∏‰∏≠ÁãÄÊÖã
  document.querySelectorAll('.bg-option').forEach(el => {
    el.style.borderColor = el.dataset.bg === bg ? 'var(--primary)' : 'var(--divider)';
  });
  applySettings();
  toast(T('ËÉåÊôØÂ∑≤Êõ¥Êñ∞'), 'success');
}

function uploadChatBg() {
  imageUploadTarget = 'chatBg';
  document.getElementById('image-upload').click();
}

function clearChatBg() {
  settings.chatBg = 'none';
  settings.chatBgImage = '';
  saveSetting('chatBg', 'none');
  saveSetting('chatBgImage', '');
  applyChatBg();
  document.getElementById('current-bg-preview').style.display = 'none';
  document.querySelectorAll('.bg-option').forEach(el => {
    el.style.borderColor = el.dataset.bg === 'none' ? 'var(--primary)' : 'var(--divider)';
  });
  applySettings();
  toast(T('Â∑≤ÊÅ¢Âæ©ÈªòË™çËÉåÊôØ'), 'success');
}

function applyChatBg() {
  const content = document.getElementById('content-area');
  if (!content) return;
  
  content.classList.remove('has-bg');
  content.style.backgroundImage = '';
  content.style.background = '';
  
  if (settings.chatBg === 'custom' && settings.chatBgImage) {
    content.classList.add('has-bg');
    content.style.backgroundImage = `url(${settings.chatBgImage})`;
  } else if (settings.chatBg === 'gradient1') {
    content.style.background = 'linear-gradient(135deg, #1a1a2e, #16213e)';
  } else if (settings.chatBg === 'gradient2') {
    content.style.background = 'linear-gradient(135deg, #0f0f1a, #1e1e32)';
  } else if (settings.chatBg === 'gradient3') {
    content.style.background = 'linear-gradient(135deg, #1a0a0a, #2a1515)';
  } else if (settings.chatBg === 'gradient4') {
    content.style.background = 'linear-gradient(135deg, #0a1a0a, #152a15)';
  }
}

// ËôïÁêÜËº∏ÂÖ•Ê°ÜÊåâÈçµ‰∫ã‰ª∂
function handleInputKey(event){
  if(event.key==='Enter'){
    if(settings.sendKey==='ctrl+enter'){
      if(event.ctrlKey||event.metaKey){
        event.preventDefault();
        send();
      }
    }else{
      // ÈªòË™ç Enter ÁôºÈÄÅ
      if(!event.ctrlKey&&!event.metaKey&&!event.shiftKey){
        event.preventDefault();
        send();
      }
    }
  }
}

// ‰∏ä‰∏ãÊñáË®≠ÁΩÆ
function showContextSettings(){
  document.getElementById('context-count').value=settings.contextCount||20;
  document.getElementById('smart-context-enabled').checked=settings.smartContext||false;
  document.getElementById('smart-context-recent').value=settings.smartContextRecent||10;
  document.getElementById('smart-context-min-score').value=settings.smartContextMinScore||30;

  // Ê†πÊìöÊô∫ËÉΩÊ®°ÂºèÈ°ØÁ§∫/Èö±ËóèÈÅ∏È†Ö
  const options = document.getElementById('smart-context-options');
  if(options){
    options.style.display = settings.smartContext ? 'block' : 'none';
  }

  // Áõ£ËÅΩcheckboxËÆäÂåñ
  const checkbox = document.getElementById('smart-context-enabled');
  if(checkbox){
    checkbox.onchange = function(){
      if(options){
        options.style.display = this.checked ? 'block' : 'none';
      }
    };
  }

  showModal('context-modal');
}

function saveContextSettings(){
  const input = document.getElementById('context-count');
  const val = input ? safeParseInt(input.value, 20) : 20;
  settings.contextCount=Math.max(1,Math.min(500,val));
  saveSetting('contextCount',settings.contextCount);

  // ‰øùÂ≠òÊô∫ËÉΩ‰∏ä‰∏ãÊñáË®≠ÁΩÆ
  const smartEnabled = document.getElementById('smart-context-enabled');
  if(smartEnabled){
    settings.smartContext = smartEnabled.checked;
    saveSetting('smartContext', settings.smartContext);
  }

  const smartRecent = document.getElementById('smart-context-recent');
  if(smartRecent){
    settings.smartContextRecent = Math.max(5, Math.min(50, safeParseInt(smartRecent.value, 10)));
    saveSetting('smartContextRecent', settings.smartContextRecent);
  }

  const smartMinScore = document.getElementById('smart-context-min-score');
  if(smartMinScore){
    settings.smartContextMinScore = Math.max(0, Math.min(100, safeParseInt(smartMinScore.value, 30)));
    saveSetting('smartContextMinScore', settings.smartContextMinScore);
  }

  applySettings();
  closeModal('context-modal');

  const mode = settings.smartContext ? 'Êô∫ËÉΩÊ®°Âºè' : 'ÂÇ≥Áµ±Ê®°Âºè';
  toast(T(`‰∏ä‰∏ãÊñáË®≠ÁΩÆÂ∑≤‰øùÂ≠òÔºà${mode}Ôºâ`));
}

// Êô∫ËÉΩËßíËâ≤ÈÅ∏ÊìáË®≠ÁΩÆ
function showCharacterSelectionSettings(){
  document.getElementById('smart-character-enabled').checked = settings.smartCharacterSelection || false;
  document.getElementById('character-recent-messages').value = settings.characterRecentMessages || 20;
  document.getElementById('always-include-main-chars').checked = settings.alwaysIncludeMainCharacters !== false;

  // Ê†πÊìöÊô∫ËÉΩÊ®°ÂºèÈ°ØÁ§∫/Èö±ËóèÈÅ∏È†Ö
  const options = document.getElementById('smart-character-options');
  if(options){
    options.style.display = settings.smartCharacterSelection ? 'block' : 'none';
  }

  // Áõ£ËÅΩcheckboxËÆäÂåñ
  const checkbox = document.getElementById('smart-character-enabled');
  if(checkbox){
    checkbox.onchange = function(){
      if(options){
        options.style.display = this.checked ? 'block' : 'none';
      }
    };
  }

  showModal('character-selection-modal');
}

function saveCharacterSelectionSettings(){
  // ‰øùÂ≠òÂïüÁî®ÁãÄÊÖã
  const smartEnabled = document.getElementById('smart-character-enabled');
  if(smartEnabled){
    settings.smartCharacterSelection = smartEnabled.checked;
    saveSetting('smartCharacterSelection', settings.smartCharacterSelection);
  }

  // ‰øùÂ≠òÊ™¢Êü•Ê∂àÊÅØÊï∏Èáè
  const recentMessages = document.getElementById('character-recent-messages');
  if(recentMessages){
    settings.characterRecentMessages = Math.max(5, Math.min(100, safeParseInt(recentMessages.value, 20)));
    saveSetting('characterRecentMessages', settings.characterRecentMessages);
  }

  // ‰øùÂ≠òÊòØÂê¶Á∏ΩÊòØÂåÖÂê´‰∏ªË¶ÅËßíËâ≤
  const includeMain = document.getElementById('always-include-main-chars');
  if(includeMain){
    settings.alwaysIncludeMainCharacters = includeMain.checked;
    saveSetting('alwaysIncludeMainCharacters', settings.alwaysIncludeMainCharacters);
  }

  applySettings();
  closeModal('character-selection-modal');

  const mode = settings.smartCharacterSelection ? 'Êô∫ËÉΩÊ®°Âºè' : 'ÂÖ®ÈÉ®ÁôºÈÄÅ';
  toast(T(`ËßíËâ≤ÈÅ∏ÊìáË®≠ÁΩÆÂ∑≤‰øùÂ≠òÔºà${mode}Ôºâ`));
}

// ÊúÄÂ§ß Token Ë®≠ÁΩÆ
function showMaxTokensSettings(){
  const input = document.getElementById('max-tokens-input');
  if(input) input.value = settings.maxTokens||4096;
  showModal('max-tokens-modal');
}
function saveMaxTokensSettings(){
  const input = document.getElementById('max-tokens-input');
  const val = input ? safeParseInt(input.value, 4096) : 4096;
  settings.maxTokens=Math.max(100,val);
  saveSetting('maxTokens',settings.maxTokens);
  applySettings();
  closeModal('max-tokens-modal');
  toast(T('ÊúÄÂ§ßÁîüÊàêÈï∑Â∫¶Â∑≤‰øùÂ≠ò'));
}

// ÊâìÂ≠óÊ©üÊïàÊûúË®≠ÁΩÆ
function showTypingSpeedSettings(){
  document.getElementById('typing-speed-select').value=settings.typingSpeed||30;
  showModal('typing-modal');
}
function saveTypingSpeedSettings(){
  settings.typingSpeed=parseInt(document.getElementById('typing-speed-select').value);
  saveSetting('typingSpeed',settings.typingSpeed);
  applySettings();
  closeModal('typing-modal');
  toast(T('ÊâìÂ≠óÊ©üÊïàÊûúÂ∑≤‰øùÂ≠ò'));
}

// ÊµÅÂºèÈüøÊáâË®≠ÁΩÆ
function showStreamingSettings(){
  const toggle=document.getElementById('toggle-streaming');
  const text=document.getElementById('toggle-streaming-text');
  const options=document.getElementById('streaming-advanced-options');
  if(settings.enableStreaming){
    toggle.classList.add('active');
    text.textContent='Â∑≤ÈñãÂïü';
    options.style.display='block';
  }else{
    toggle.classList.remove('active');
    text.textContent='Â∑≤ÈóúÈñâ';
    options.style.display='none';
  }
  document.getElementById('streaming-chunk-delay-select').value=settings.streamingChunkDelay||20;
  showModal('streaming-modal');
}
function toggleStreamingEnabled(){
  const toggle=document.getElementById('toggle-streaming');
  const text=document.getElementById('toggle-streaming-text');
  const options=document.getElementById('streaming-advanced-options');
  const enabled=toggle.classList.contains('active');
  if(enabled){
    toggle.classList.remove('active');
    text.textContent='Â∑≤ÈóúÈñâ';
    options.style.display='none';
  }else{
    toggle.classList.add('active');
    text.textContent='Â∑≤ÈñãÂïü';
    options.style.display='block';
  }
}
function saveStreamingSettings(){
  const enabled=document.getElementById('toggle-streaming').classList.contains('active');
  settings.enableStreaming=enabled;
  settings.streamingChunkDelay=parseInt(document.getElementById('streaming-chunk-delay-select').value)||20;
  saveSetting('enableStreaming',settings.enableStreaming);
  saveSetting('streamingChunkDelay',settings.streamingChunkDelay);
  applySettings();
  closeModal('streaming-modal');
  toast(T('ÊµÅÂºèÈüøÊáâË®≠ÁΩÆÂ∑≤‰øùÂ≠ò'),'success');
}

// ÊôÇÈñì
function updateTime(){
  const n=new Date();
  const timeEl=document.getElementById('status-time');
  if(timeEl)timeEl.textContent=`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;
}

// Â∞éËà™
function goTo(id){
  const cur=document.querySelector('.view.active'),tar=document.getElementById(id);
  if(!tar||cur===tar)return;
  hist.push(id);
  cur.classList.remove('active');cur.classList.add('out');
  tar.classList.add('active');
  setTimeout(()=>cur.classList.remove('out'),300);
  // ËºâÂÖ•Êï∏Êìö
  if(id==='view-lore')renderLore();
  else if(id==='view-timeline')renderTimeline();
  else if(id==='view-foreshadow')renderForeshadow();
  else if(id==='view-saves')renderSaves();
  else if(id==='view-api')renderApi();
  else if(id==='view-chapters')renderChapters();
  else if(id==='view-bookmarks')renderBookmarks();
  else if(id==='view-inventory')renderInventory();
  else if(id==='view-branches')renderBranches();
  else if(id==='view-characters')renderCharacters(); // v7
  else if(id==='view-lorebook')renderLorebook(); // v13
  else if(id==='view-search')initContentSearch(); // v17 ‰øÆÂæ©
}
function goBack(){
  if(hist.length>1){
    hist.pop();
    const prev=hist[hist.length-1];
    const cur=document.querySelector('.view.active'),tar=document.getElementById(prev);
    cur.classList.remove('active');tar.classList.add('active');
  }
}
function switchTab(t){
  document.querySelectorAll('.tab-bar .tab-item').forEach(x=>x.classList.remove('active'));
  if(t==='stories'){goTo('view-stories');document.querySelectorAll('.tab-bar')[0]?.querySelector('.tab-item')?.classList.add('active');}
  else if(t==='instructions'){goTo('view-instructions');}
  else if(t==='settings'){goTo('view-settings');}
}

// ÊïÖ‰∫ãÂàóË°®
async function renderStories(){
  const c=document.getElementById('story-list');
  let list=await db.stories.orderBy('updatedAt').reverse().toArray();
  list.sort((a,b)=>(a.isPinned&&!b.isPinned)?-1:(!a.isPinned&&b.isPinned)?1:0);
  if(!list.length){c.innerHTML=`<div class="empty"><div class="empty-icon">üìö</div><div class="empty-title">${T('ÈÇÑÊ≤íÊúâÊïÖ‰∫ã')}</div><div class="empty-desc">${T('ÈªûÊìäÂè≥‰∏äËßí ‚ûï ÂâµÂª∫‰Ω†ÁöÑÁ¨¨‰∏ÄÂÄã‰∫íÂãïÊïÖ‰∫ã')}</div><button class="empty-btn" onclick="createStory()">${T('ÂâµÂª∫ÊïÖ‰∫ã')}</button></div>`;return;}
  c.innerHTML=list.map(s=>{
    const t=timeAgo(s.updatedAt),stats=s.statistics||{totalChars:0},tags=(s.tags||[]).map(x=>`<span class="tag">${esc(x)}</span>`).join('');
    // ÊîØÊåÅÂ∞ÅÈù¢ÂúñÁâá
    const coverEmoji = esc(s.cover) || 'üìñ';
    const coverContent = s.coverImage 
      ? `<img src="${s.coverImage}" alt="Â∞ÅÈù¢" onerror="this.outerHTML='<span class=cover-emoji>${coverEmoji}</span>'">` 
      : `<span class="cover-emoji">${coverEmoji}</span>`;
    return `<div class="card ${s.isPinned?'pinned':''}" onclick="openStory('${escAttr(s.id)}')"><div class="card-cover">${coverContent}</div><div class="card-info"><div class="card-header"><span class="card-title">${esc(s.title)}</span><span class="card-time">${t}</span></div><div class="card-preview">${esc(s.preview||'ÈñãÂßã‰Ω†ÁöÑÂÜíÈö™...')}</div><div class="card-meta">${s.instructionName?`<span class="card-instruction">üìú ${esc(s.instructionName)}</span>`:''}<span class="card-stats">üìä ${fmtNum(stats.totalChars)}Â≠ó</span></div>${tags?`<div class="card-tags">${tags}</div>`:''}</div><div class="card-menu-btn" onclick="event.stopPropagation();showStoryMenu('${escAttr(s.id)}')">‚ãØ</div></div>`;
  }).join('');
}
function filterStories(){const q=document.getElementById('story-search').value.toLowerCase();document.querySelectorAll('#story-list .card').forEach(c=>{const t=c.querySelector('.card-title')?.textContent.toLowerCase()||'';c.style.display=t.includes(q)?'':'none';});}

// v19: Á∂ìÁáüÊ®°ÂºèÁõ∏Èóú
let selectedStoryMode = 'normal';

function selectStoryMode(mode){
  selectedStoryMode = mode;
  document.getElementById('mode-normal').classList.toggle('active', mode === 'normal');
  document.getElementById('mode-simulation').classList.toggle('active', mode === 'simulation');
  document.getElementById('sim-mode-options').style.display = mode === 'simulation' ? 'block' : 'none';
}

function addSimResource(){
  const container = document.getElementById('new-sim-resources');
  const div = document.createElement('div');
  div.style.cssText = 'display:flex;gap:6px;align-items:center';
  div.innerHTML = `
    <input type="text" class="form-input" style="width:60px" placeholder="üìä" maxlength="2">
    <input type="text" class="form-input" style="flex:1" placeholder="ÂêçÁ®±">
    <input type="number" class="form-input" style="width:80px" placeholder="Êï∏ÂÄº" value="0">
    <button onclick="removeSimResource(this)" style="background:none;border:none;color:var(--error);cursor:pointer">‚úï</button>
  `;
  container.appendChild(div);
}

function removeSimResource(btn){
  btn.parentElement.remove();
}

async function createStory(){
  const insts=await db.instructions.toArray();
  const sel=document.getElementById('new-inst');
  sel.innerHTML='<option value="">‰∏çÁ∂ÅÂÆöÊåá‰ª§</option>'+insts.map(i=>`<option value="${i.id}">${esc(i.name)}</option>`).join('');
  document.getElementById('new-title').value='';
  document.getElementById('new-desc').value='';
  document.getElementById('new-tags').value='';
  // v19: ÈáçÁΩÆÊ®°ÂºèÈÅ∏Êìá
  selectedStoryMode = 'normal';
  selectStoryMode('normal');
  // ÈáçÁΩÆÂàùÂßãË≥áÊ∫ê
  document.getElementById('new-sim-resources').innerHTML = `
    <div style="display:flex;gap:6px;align-items:center">
      <input type="text" class="form-input" style="width:60px" placeholder="üí∞" maxlength="2" value="üí∞">
      <input type="text" class="form-input" style="flex:1" placeholder="ÂêçÁ®±" value="ÈáëÂπ£">
      <input type="number" class="form-input" style="width:80px" placeholder="Êï∏ÂÄº" value="10000">
      <button onclick="removeSimResource(this)" style="background:none;border:none;color:var(--error);cursor:pointer">‚úï</button>
    </div>
  `;
  showModal('new-story-modal');
}
async function saveNewStory(){
  const title=document.getElementById('new-title').value.trim();
  if(!title){toast(T('Ë´ãËº∏ÂÖ•ÊïÖ‰∫ãÊ®ôÈ°å'),'warning');return;}
  const desc=document.getElementById('new-desc').value.trim();
  const tagsStr=document.getElementById('new-tags').value.trim();
  const tags=tagsStr?tagsStr.split(/\s+/):[];
  const instId=document.getElementById('new-inst').value;
  const storyId=crypto.randomUUID(),branchId='main_'+crypto.randomUUID(),now=Date.now();
  const s={id:storyId,title,description:desc,cover:'üìñ',tags,currentBranchId:branchId,currentMessageId:null,storyTime:'',isPinned:false,preview:'',createdAt:now,updatedAt:now,statistics:{totalChars:0,totalMessages:0},draft:'',autoSave:{enabled:true,interval:20,maxCount:5}};
  
  // v19: ‰øùÂ≠òÊ®°ÂºèÂíåË≥áÊ∫ê
  s.mode = selectedStoryMode;
  if(selectedStoryMode === 'simulation'){
    s.simDay = 1;
    s.simResources = [];
    const rows = document.querySelectorAll('#new-sim-resources > div');
    rows.forEach(row => {
      const inputs = row.querySelectorAll('input');
      if(inputs.length >= 3){
        const icon = inputs[0].value.trim() || 'üìä';
        const name = inputs[1].value.trim();
        const value = parseFloat(inputs[2].value) || 0;
        if(name) s.simResources.push({icon, name, value, prevValue: value});
      }
    });
  }
  
  if(instId){const inst=await db.instructions.get(instId);if(inst){s.instructionName=inst.name;await db.storyInstructions.put({storyId,instructionId:instId,order:0});}}
  await db.branches.put({id:branchId,storyId,name:'‰∏ªÁ∑ö',parentBranchId:null,createdAt:now});
  await db.stories.put(s);
  closeModal('new-story-modal');
  toast(T('ÊïÖ‰∫ãÂâµÂª∫ÊàêÂäüÔºÅ'),'success');
  await renderStories();
  openStory(storyId);

  // Ëá™ÂãïÂêåÊ≠•Âà∞Èõ≤Á´Ø
  autoSyncToCloud();
}

async function openStory(id){
  // Èò≤Ê≠¢Á´ûÊÄÅÊù°‰ª∂ÔºöËÆ∞ÂΩïÂΩìÂâçÊ≠£Âú®Âä†ËΩΩÁöÑÊïÖ‰∫ãID
  loadingStoryId = id;
  const currentLoadingId = id;

  showLoading('ËºâÂÖ•ÊïÖ‰∫ã...');
  try{
    story=await db.stories.get(id);

    // Ê£ÄÊü•ÊòØÂê¶ÊúâÊñ∞ÁöÑÂä†ËΩΩËØ∑Ê±ÇÔºåÂ¶ÇÊûúÊúâÂàôÊîæÂºÉÂΩìÂâçÂä†ËΩΩ
    if(loadingStoryId !== currentLoadingId){
      console.log('[OpenStory] Âä†ËºâË¢´ÂèñÊ∂àÔºåÁî®Êà∂Â∑≤ÂàáÊèõÂà∞ÂÖ∂‰ªñÊïÖ‰∫ã');
      return;
    }

    if(!story){toast(T('ÊïÖ‰∫ã‰∏çÂ≠òÂú®'),'error');hideLoading();loadingStoryId=null;return;}
    msgs=await db.messages.where('[storyId+branchId]').equals([id,story.currentBranchId]).sortBy('createdAt');

    // ÂÜçÊ¨°Ê£ÄÊü•Á´ûÊÄÅÊù°‰ª∂
    if(loadingStoryId !== currentLoadingId){
      console.log('[OpenStory] Âä†ËºâË¢´ÂèñÊ∂àÔºåÁî®Êà∂Â∑≤ÂàáÊèõÂà∞ÂÖ∂‰ªñÊïÖ‰∫ã');
      return;
    }

    const titleEl = document.getElementById('reading-title');
    if(titleEl) titleEl.textContent=story.title;
    renderMsgs();
    applyChatBg(); // ÊáâÁî®ËÅäÂ§©ËÉåÊôØ
    // v19: Á∂ìÁáüÊ®°Âºè UI ÂàáÊèõ
    updateSimulationUI();
    // v22: ËºâÂÖ• Persona
    await initDefaultPersona();

    // ‚ú® ÊÅ¢Â§çËçâÁ®ø
    const input = document.getElementById('user-input');
    if(input && story.draft) {
      input.value = story.draft;
      toast('üìù Â∑≤ÊÅ¢Â§ç‰∏äÊ¨°ÁºñËæëÁöÑÂÜÖÂÆπ', 'info');
    } else if(input) {
      input.value = ''; // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
    }

    goTo('view-reading');
    hideLoading();
    loadingStoryId = null;

    // Êõ¥Êñ∞‰∏ÄËá¥ÊÄß‰øÆÂæ©ÊèêÁ§∫Ê¢ù
    updateConsistencyFixBanner();

    // v25: Â¶ÇÊûúÊòØÊñ∞ÊïÖ‰∫ãÔºàÊ≤íÊúâÊ∂àÊÅØÔºâÔºåÊ™¢Êü•ÊòØÂê¶ÊúâÈñãÂ†¥ÁôΩ
    if(msgs.length === 0){
      await checkGreetingAvailable();
    }
  }catch(e){
    console.error('[OpenStory] ËºâÂÖ•Â§±Êïó:', e);
    toast(T('ËºâÂÖ•Â§±Êïó'),'error');
    hideLoading();
    loadingStoryId = null;
  }
}

// v25: ÈñãÂ†¥ÁôΩÁ≥ªÁµ±
let selectedGreetingIndex = -1;
let availableGreetings = [];

async function checkGreetingAvailable(){
  if(!story) return;
  
  const chars = await db.characters.where('storyId').equals(story.id).toArray();
  availableGreetings = [];
  
  // Êî∂ÈõÜÊâÄÊúâËßíËâ≤ÁöÑÈñãÂ†¥ÁôΩ
  for(const char of chars){
    if(char.first_mes){
      availableGreetings.push({
        charId: char.id,
        charName: char.name,
        charAvatar: char.avatar || 'üë§',
        content: char.first_mes,
        isDefault: true
      });
    }
    
    // Êõø‰ª£ÈñãÂ†¥ÁôΩ
    if(char.alternate_greetings && char.alternate_greetings.length > 0){
      char.alternate_greetings.forEach((greeting, idx) => {
        if(greeting.trim()){
          availableGreetings.push({
            charId: char.id,
            charName: char.name,
            charAvatar: char.avatar || 'üë§',
            content: greeting,
            isDefault: false,
            altIndex: idx + 1
          });
        }
      });
    }
  }
  
  if(availableGreetings.length > 0){
    showGreetingSelector();
  }
}

function showGreetingSelector(){
  const container = document.getElementById('greeting-select-content');
  selectedGreetingIndex = 0;
  
  let html = '';
  availableGreetings.forEach((g, idx) => {
    const isSelected = idx === 0 ? 'selected' : '';
    const badge = g.isDefault ? 'ÈªòË™ç' : `Êõø‰ª£ ${g.altIndex}`;
    html += `
      <div class="greeting-option ${isSelected}" onclick="selectGreeting(${idx})" data-idx="${idx}">
        <div class="greeting-option-header">
          <span class="greeting-char-avatar">${g.charAvatar}</span>
          <span class="greeting-char-name">${esc(g.charName)}</span>
          <span class="greeting-badge">${badge}</span>
        </div>
        <div class="greeting-preview">${esc(g.content.slice(0, 150))}${g.content.length > 150 ? '...' : ''}</div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  showModal('greeting-select-modal');
}

function selectGreeting(idx){
  selectedGreetingIndex = idx;
  document.querySelectorAll('.greeting-option').forEach((el, i) => {
    el.classList.toggle('selected', i === idx);
  });
}

async function confirmGreeting(){
  closeModal('greeting-select-modal');
  
  if(selectedGreetingIndex < 0 || selectedGreetingIndex >= availableGreetings.length) return;
  
  const greeting = availableGreetings[selectedGreetingIndex];
  
  // ÂâµÂª∫AIÊ∂àÊÅØ
  const aiMsgId = crypto.randomUUID();
  const aiMsg = {
    id: aiMsgId,
    storyId: story.id,
    branchId: story.currentBranchId,
    role: 'assistant',
    content: greeting.content,
    createdAt: Date.now(),
    isGreeting: true  // Ê®ôË®òÁÇ∫ÈñãÂ†¥ÁôΩ
  };
  
  await db.messages.put(aiMsg);
  msgs.push(aiMsg);
  renderMsgs();
  
  toast(T('Â∑≤‰ΩøÁî®ÈñãÂ†¥ÁôΩ'), 'success');
}

function skipGreeting(){
  // Áî®Êà∂ÈÅ∏Êìá‰∏ç‰ΩøÁî®ÈñãÂ†¥ÁôΩÔºå‰ªÄÈ∫ºÈÉΩ‰∏çÂÅö
  availableGreetings = [];
  selectedGreetingIndex = -1;
}

// v25: ËßíËâ≤Èóú‰øÇÁ≥ªÁµ±
let charRelationships = []; // Áï∂ÂâçÁ∑®ËºØÁöÑËßíËâ≤Èóú‰øÇ
const RELATIONSHIP_TYPES = [
  { code: 'lover', label: 'ÊàÄ‰∫∫', icon: '‚ù§Ô∏è', color: '#ff6b6b' },
  { code: 'ex', label: 'Ââç‰ªª', icon: 'üíî', color: '#ffa8a8' },
  { code: 'crush', label: 'ÊöóÊàÄ', icon: 'üíó', color: '#ffb3d9' },
  { code: 'spouse', label: 'ÈÖçÂÅ∂', icon: 'üíç', color: '#ff4757' },
  { code: 'family', label: 'ÂÆ∂‰∫∫', icon: 'üë®‚Äçüë©‚Äçüëß', color: '#4ecdc4' },
  { code: 'friend', label: 'ÊúãÂèã', icon: 'ü§ù', color: '#45b7d1' },
  { code: 'bestfriend', label: 'ÊëØÂèã', icon: 'üëØ', color: '#3498db' },
  { code: 'enemy', label: 'Êïµ‰∫∫', icon: '‚öîÔ∏è', color: '#ff4757' },
  { code: 'rival', label: 'Â∞çÊâã', icon: 'üî•', color: '#ff7f50' },
  { code: 'boss', label: '‰∏äÂè∏', icon: 'üëî', color: '#a55eea' },
  { code: 'subordinate', label: '‰∏ãÂ±¨', icon: 'üë∑', color: '#26de81' },
  { code: 'colleague', label: 'Âêå‰∫ã', icon: 'üè¢', color: '#74b9ff' },
  { code: 'mentor', label: 'Â∞éÂ∏´', icon: 'üéì', color: '#fed330' },
  { code: 'student', label: 'Â≠∏Áîü', icon: 'üìö', color: '#20bf6b' },
  { code: 'master', label: '‰∏ª‰∫∫', icon: 'üëë', color: '#6c5ce7' },
  { code: 'servant', label: 'ÂÉï‰∫∫', icon: 'üôá', color: '#81ecec' },
  { code: 'partner', label: 'Êê≠Ê™î', icon: 'ü§úü§õ', color: '#00cec9' },
  { code: 'custom', label: 'Ëá™ÂÆöÁæ©', icon: '‚úèÔ∏è', color: '#9ca3af' }
];

function addCharRelationship(){
  charRelationships.push({
    id: crypto.randomUUID(),
    targetId: null,
    targetName: '',
    type: 'friend',
    label: 'ÊúãÂèã',
    description: '',
    mutual: false
  });
  renderCharRelationships();
}

async function renderCharRelationships(){
  const container = document.getElementById('char-relationships-list');
  if(!container) return;
  
  // Áç≤ÂèñÂèØÈÅ∏ÁöÑËßíËâ≤ÂàóË°®ÔºàÊéíÈô§Áï∂ÂâçÁ∑®ËºØÁöÑËßíËâ≤Ôºâ
  const chars = await db.characters.where('storyId').equals(story?.id || 0).toArray();
  const otherChars = chars.filter(c => c.id !== editingCharacterId);
  
  const typeOptions = RELATIONSHIP_TYPES.map(t => 
    `<option value="${t.code}">${t.icon} ${t.label}</option>`
  ).join('');
  
  const charOptions = otherChars.map(c => 
    `<option value="${c.id}">${c.avatar || 'üë§'} ${c.name}</option>`
  ).join('');
  
  container.innerHTML = charRelationships.map((rel, idx) => `
    <div class="relationship-item">
      <button class="delete-btn" onclick="removeCharRelationship(${idx})">‚úï</button>
      <div class="relationship-row">
        <select class="form-input" onchange="updateRelTarget(${idx}, this.value)" style="flex:1.5">
          <option value="">ÈÅ∏ÊìáËßíËâ≤...</option>
          ${charOptions}
        </select>
        <select class="form-input" onchange="updateRelType(${idx}, this.value)">
          ${typeOptions}
        </select>
      </div>
      <div class="relationship-row">
        <input type="text" class="form-input" placeholder="Èóú‰øÇÊèèËø∞ÔºàÂèØÈÅ∏Ôºâ" 
               value="${esc(rel.description || '')}"
               oninput="charRelationships[${idx}].description=this.value">
        <label style="display:flex;align-items:center;gap:4px;font-size:12px;white-space:nowrap">
          <input type="checkbox" ${rel.mutual ? 'checked' : ''} 
                 onchange="charRelationships[${idx}].mutual=this.checked">
          ÈõôÂêë
        </label>
      </div>
    </div>
  `).join('');
  
  // Ë®≠ÁΩÆÂ∑≤ÈÅ∏‰∏≠ÁöÑÂÄº
  const selects = container.querySelectorAll('select');
  charRelationships.forEach((rel, idx) => {
    const targetSelect = selects[idx * 2];
    const typeSelect = selects[idx * 2 + 1];
    if(targetSelect && rel.targetId) targetSelect.value = rel.targetId;
    if(typeSelect) typeSelect.value = rel.type || 'friend';
  });
}

function updateRelTarget(idx, targetId){
  if(!targetId){
    charRelationships[idx].targetId = null;
    charRelationships[idx].targetName = '';
    return;
  }
  const parsedId = safeParseInt(targetId);
  if(parsedId === 0){
    console.error('[Relationship] ÁÑ°ÊïàÁöÑÁõÆÊ®ôID:', targetId);
    return;
  }
  charRelationships[idx].targetId = parsedId;
  // Áç≤ÂèñËßíËâ≤Âêç
  db.characters.get(parsedId).then(char => {
    if(char) charRelationships[idx].targetName = char.name;
  }).catch(err => {
    console.error('[Relationship] Áç≤ÂèñËßíËâ≤ÂêçÂ§±Êïó:', err);
  });
}

function updateRelType(idx, typeCode){
  const typeInfo = RELATIONSHIP_TYPES.find(t => t.code === typeCode);
  charRelationships[idx].type = typeCode;
  charRelationships[idx].label = typeInfo ? typeInfo.label : typeCode;
}

function removeCharRelationship(idx){
  charRelationships.splice(idx, 1);
  renderCharRelationships();
}

// v25: Èóú‰øÇÂúñË≠ú
async function showRelationshipGraph(){
  closeAll();
  
  if(!story){
    toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'), 'warning');
    return;
  }
  
  showLoading(T('ËºâÂÖ•Èóú‰øÇÂúñË≠ú...'));
  
  try {
    const chars = await db.characters.where('storyId').equals(story.id).toArray();
    
    if(chars.length === 0){
      hideLoading();
      toast(T('Êö´ÁÑ°ËßíËâ≤'), 'info');
      return;
    }
    
    hideLoading();
    showModal('relationship-graph-modal');
    
    // Âª∂ÈÅ≤Ê∏≤Êüì‰ª•Á¢∫‰øùÊ®°ÊÖãÊ°ÜÂ∑≤È°ØÁ§∫
    setTimeout(() => renderRelationshipGraph(chars), 100);
  } catch(err){
    hideLoading();
    console.error('Load graph error:', err);
    toast(T('ËºâÂÖ•Â§±Êïó'), 'error');
  }
}

function renderRelationshipGraph(chars){
  const container = document.getElementById('relationship-graph-container');
  if(!container) return;
  
  const width = container.offsetWidth || 400;
  const height = Math.max(container.offsetHeight, 400);
  
  // Ë®àÁÆóÁØÄÈªû‰ΩçÁΩÆÔºàÂúìÂΩ¢Â∏ÉÂ±ÄÔºâ
  const centerX = width / 2;
  const centerY = height / 2;
  const radius = Math.min(width, height) / 2 - 60;
  
  const nodes = chars.map((char, idx) => {
    const angle = (2 * Math.PI * idx) / chars.length - Math.PI / 2;
    return {
      id: char.id,
      name: char.name,
      avatar: char.avatar || 'üë§',
      category: char.category || 'supporting',
      x: centerX + radius * Math.cos(angle),
      y: centerY + radius * Math.sin(angle),
      relationships: char.relationships || []
    };
  });
  
  // Êî∂ÈõÜÊâÄÊúâÈóú‰øÇÁ∑ö
  const lines = [];
  nodes.forEach(node => {
    node.relationships.forEach(rel => {
      const targetNode = nodes.find(n => n.id === rel.targetId);
      if(targetNode){
        const typeInfo = RELATIONSHIP_TYPES.find(t => t.code === rel.type);
        lines.push({
          from: node,
          to: targetNode,
          label: rel.label || (typeInfo ? typeInfo.label : rel.type),
          color: typeInfo ? typeInfo.color : '#888',
          icon: typeInfo ? typeInfo.icon : ''
        });
      }
    });
  });
  
  // Ê∏≤ÊüìHTML
  let html = '<svg width="100%" height="100%" style="position:absolute;top:0;left:0">';
  
  // Áπ™Ë£ΩÈóú‰øÇÁ∑ö
  lines.forEach(line => {
    const midX = (line.from.x + line.to.x) / 2;
    const midY = (line.from.y + line.to.y) / 2;
    
    html += `
      <line x1="${line.from.x}" y1="${line.from.y}" 
            x2="${line.to.x}" y2="${line.to.y}" 
            stroke="${line.color}" stroke-width="2" stroke-opacity="0.6"/>
    `;
  });
  
  html += '</svg>';
  
  // Áπ™Ë£ΩÈóú‰øÇÊ®ôÁ±§
  lines.forEach(line => {
    const midX = (line.from.x + line.to.x) / 2;
    const midY = (line.from.y + line.to.y) / 2;
    
    html += `
      <div class="rel-graph-label" style="left:${midX}px;top:${midY}px;transform:translate(-50%,-50%)">
        ${line.icon} ${line.label}
      </div>
    `;
  });
  
  // Áπ™Ë£ΩÁØÄÈªû
  nodes.forEach(node => {
    const categoryClass = node.category === 'protagonist' ? 'protagonist' : 
                         node.category === 'npc' ? 'npc' : '';
    html += `
      <div class="rel-graph-node ${categoryClass}" 
           style="left:${node.x - 35}px;top:${node.y - 35}px"
           onclick="showCharDetail(${node.id})">
        <span class="node-avatar">${node.avatar}</span>
        <span class="node-name">${esc(node.name)}</span>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function resetGraphView(){
  // ÈáçÊñ∞Ê∏≤ÊüìÂúñË≠ú
  db.characters.where('storyId').equals(story?.id || 0).toArray().then(chars => {
    renderRelationshipGraph(chars);
  }).catch(err => {
    console.error('[Graph] ÈáçÊñ∞ËºâÂÖ•ÂúñË≠úÂ§±Êïó:', err);
    toast(T('ËºâÂÖ•Â§±Êïó'), 'error');
  });
}

// v25: Ë°®ÊÉÖÁ´ãÁπ™Á≥ªÁµ±
let charExpressions = []; // Áï∂ÂâçÁ∑®ËºØÁöÑËßíËâ≤Ë°®ÊÉÖ
let editingExpressionIndex = -1;

function addCharExpression(){
  document.getElementById('expr-file-input').click();
}

function handleExpressionUpload(event){
  const file = event.target.files[0];
  if(!file) return;
  
  if(!file.type.startsWith('image/')){
    toast(T('Ë´ãÈÅ∏ÊìáÂúñÁâáÊñá‰ª∂'), 'warning');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = (e) => {
    const base64 = e.target.result;
    
    // ÂâµÂª∫Êñ∞Ë°®ÊÉÖ
    const expr = {
      id: Date.now(),
      name: 'Ë°®ÊÉÖ ' + (charExpressions.length + 1),
      image: base64,
      keywords: [],
      isDefault: charExpressions.length === 0  // Á¨¨‰∏ÄÂÄãË°®ÊÉÖÈªòË™ç
    };
    
    charExpressions.push(expr);
    renderCharExpressions();
    
    // È°ØÁ§∫Á∑®ËºØÂΩàÁ™ó
    editingExpressionIndex = charExpressions.length - 1;
    showExpressionEditPopup();
  };
  
  reader.readAsDataURL(file);
  event.target.value = '';  // ÈáçÁΩÆinput
}

function renderCharExpressions(){
  const container = document.getElementById('char-expressions-list');
  if(!container) return;
  
  if(charExpressions.length === 0){
    container.innerHTML = '<div style="grid-column:span 3;text-align:center;color:var(--text-tertiary);font-size:12px;padding:20px 0">Êö´ÁÑ°Ë°®ÊÉÖÔºåÈªûÊìä‰∏ãÊñπÊåâÈàïÊ∑ªÂä†</div>';
    return;
  }
  
  container.innerHTML = charExpressions.map((expr, idx) => `
    <div class="expression-item ${expr.isDefault ? 'default' : ''}" onclick="editExpression(${idx})">
      ${expr.isDefault ? '<span class="expr-badge">ÈªòË™ç</span>' : ''}
      <button class="expr-delete" onclick="event.stopPropagation();deleteExpression(${idx})">‚úï</button>
      <img class="expr-img" src="${expr.image}" alt="${esc(expr.name)}">
      <div class="expr-name">${esc(expr.name)}</div>
    </div>
  `).join('');
}

function editExpression(idx){
  editingExpressionIndex = idx;
  showExpressionEditPopup();
}

function showExpressionEditPopup(){
  if(editingExpressionIndex < 0 || editingExpressionIndex >= charExpressions.length) return;
  
  const expr = charExpressions[editingExpressionIndex];
  
  const html = `
    <div class="expression-edit-modal" id="expr-edit-popup">
      <div style="display:flex;gap:12px;align-items:flex-start">
        <img src="${expr.image}" style="width:80px;height:80px;border-radius:10px;object-fit:cover">
        <div style="flex:1">
          <div class="form-group" style="margin-bottom:10px">
            <label class="form-label" style="font-size:11px">Ë°®ÊÉÖÂêçÁ®±</label>
            <input type="text" class="form-input" id="expr-edit-name" value="${esc(expr.name)}" placeholder="Â¶ÇÔºöÈñãÂøÉ„ÄÅÁîüÊ∞£„ÄÅÂÆ≥Áæû...">
          </div>
          <div class="form-group" style="margin-bottom:10px">
            <label class="form-label" style="font-size:11px">Ëß∏ÁôºÈóúÈçµË©ûÔºàÈÄóËôüÂàÜÈöîÔºâ</label>
            <input type="text" class="form-input" id="expr-edit-keywords" value="${(expr.keywords || []).join(', ')}" placeholder="Á¨ë, ÈñãÂøÉ, È´òËàà...">
          </div>
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer">
            <input type="checkbox" id="expr-edit-default" ${expr.isDefault ? 'checked' : ''}>
            Ë®≠ÁÇ∫ÈªòË™çË°®ÊÉÖ
          </label>
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button class="modal-btn secondary" onclick="closeExpressionEdit()" style="padding:6px 12px;font-size:12px">ÂèñÊ∂à</button>
        <button class="modal-btn confirm" onclick="saveExpressionEdit()" style="padding:6px 12px;font-size:12px">‰øùÂ≠ò</button>
      </div>
    </div>
  `;
  
  // ÁßªÈô§ËàäÁöÑÂΩàÁ™ó
  const oldPopup = document.getElementById('expr-edit-popup');
  if(oldPopup) oldPopup.remove();
  
  // Âú®Ë°®ÊÉÖÂàóË°®ÂæåÊèíÂÖ•
  const container = document.getElementById('char-expressions-list');
  container.insertAdjacentHTML('afterend', html);
}

function closeExpressionEdit(){
  const popup = document.getElementById('expr-edit-popup');
  if(popup) popup.remove();
  editingExpressionIndex = -1;
}

function saveExpressionEdit(){
  if(editingExpressionIndex < 0) return;
  
  const name = document.getElementById('expr-edit-name')?.value?.trim() || 'Ë°®ÊÉÖ';
  const keywordsText = document.getElementById('expr-edit-keywords')?.value || '';
  const keywords = keywordsText.split(',').map(s => s.trim()).filter(s => s);
  const isDefault = document.getElementById('expr-edit-default')?.checked || false;
  
  // Êõ¥Êñ∞Ë°®ÊÉÖ
  charExpressions[editingExpressionIndex].name = name;
  charExpressions[editingExpressionIndex].keywords = keywords;
  
  // Â¶ÇÊûúË®≠ÁÇ∫ÈªòË™çÔºåÂèñÊ∂àÂÖ∂‰ªñÈªòË™ç
  if(isDefault){
    charExpressions.forEach((e, i) => {
      e.isDefault = (i === editingExpressionIndex);
    });
  }
  charExpressions[editingExpressionIndex].isDefault = isDefault;
  
  closeExpressionEdit();
  renderCharExpressions();
  toast(T('Ë°®ÊÉÖÂ∑≤Êõ¥Êñ∞'), 'success');
}

function deleteExpression(idx){
  if(!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãË°®ÊÉÖÂóéÔºü')) return;
  
  const wasDefault = charExpressions[idx].isDefault;
  charExpressions.splice(idx, 1);
  
  // Â¶ÇÊûúÂà™Èô§ÁöÑÊòØÈªòË™çË°®ÊÉÖÔºåË®≠ÁΩÆÁ¨¨‰∏ÄÂÄãÁÇ∫ÈªòË™ç
  if(wasDefault && charExpressions.length > 0){
    charExpressions[0].isDefault = true;
  }
  
  renderCharExpressions();
  toast(T('Ë°®ÊÉÖÂ∑≤Âà™Èô§'), 'success');
}

// AI Ëá™ÂãïÂàáÊèõË°®ÊÉÖ
async function autoSwitchExpression(charId, aiResponse){
  const char = await db.characters.get(charId);
  if(!char || !char.expressions || char.expressions.length === 0) return null;
  if(char.expressionMode !== 'auto') return null;
  
  const responseText = aiResponse.toLowerCase();
  
  // Ê™¢Êü•ÊØèÂÄãË°®ÊÉÖÁöÑÈóúÈçµË©û
  for(const expr of char.expressions){
    if(!expr.keywords || expr.keywords.length === 0) continue;
    
    const matched = expr.keywords.some(kw => responseText.includes(kw.toLowerCase()));
    if(matched){
      // Êõ¥Êñ∞Áï∂ÂâçË°®ÊÉÖ
      await db.characters.update(charId, { currentExpression: expr.id });
      return expr;
    }
  }
  
  return null;
}

// Áç≤ÂèñËßíËâ≤Áï∂ÂâçË°®ÊÉÖ
async function getCurrentExpression(charId){
  const char = await db.characters.get(charId);
  if(!char || !char.expressions || char.expressions.length === 0) return null;
  
  // Â¶ÇÊûúÊúâÁï∂ÂâçË°®ÊÉÖÔºåËøîÂõûÂÆÉ
  if(char.currentExpression){
    const expr = char.expressions.find(e => e.id === char.currentExpression);
    if(expr) return expr;
  }
  
  // Âê¶ÂâáËøîÂõûÈªòË™çË°®ÊÉÖ
  const defaultExpr = char.expressions.find(e => e.isDefault);
  return defaultExpr || char.expressions[0];
}

// ÊâãÂãïÂàáÊèõË°®ÊÉÖ
async function switchExpression(charId, exprId){
  await db.characters.update(charId, { currentExpression: exprId });
  toast(T('Ë°®ÊÉÖÂ∑≤ÂàáÊèõ'), 'success');
  
  // Êõ¥Êñ∞È°ØÁ§∫
  renderCharacterExpressionInChat(charId);
}

// Âú®ËÅäÂ§©‰∏≠Ê∏≤ÊüìËßíËâ≤Ë°®ÊÉÖ
async function renderCharacterExpressionInChat(charId){
  const expr = await getCurrentExpression(charId);
  const displays = document.querySelectorAll(`.char-expr-display[data-char-id="${charId}"]`);
  
  displays.forEach(display => {
    if(expr && expr.image){
      display.src = expr.image;
      display.style.display = 'block';
    } else {
      display.style.display = 'none';
    }
  });
}

// Ê™¢Êü•‰∏¶Ëá™ÂãïÂàáÊèõÊâÄÊúâËßíËâ≤ÁöÑË°®ÊÉÖ
async function checkAutoExpressionSwitch(aiResponse){
  if(!story) return;
  
  const chars = await db.characters.where('storyId').equals(story.id).toArray();
  
  for(const char of chars){
    if(char.expressionMode !== 'auto') continue;
    if(!char.expressions || char.expressions.length === 0) continue;
    
    const switched = await autoSwitchExpression(char.id, aiResponse);
    if(switched){
      console.log(`Expression switched for ${char.name}: ${switched.name}`);
    }
  }
}

// v21: Êõ¥Êñ∞Á∂ìÁáüÊ®°Âºè UIÔºàÈõôËªå‰∏¶Ë°åÔºöË≥áÊ∫êÈù¢Êùø + ËßíËâ≤Á≥ªÁµ±ÈÉΩÂèØÁî®Ôºâ
function updateSimulationUI(){
  const isSimMode = story?.mode === 'simulation';
  const resourceBar = document.getElementById('sim-resource-bar');
  const btnCharacters = document.getElementById('btn-characters');
  
  if(isSimMode){
    resourceBar.style.display = 'flex';
    // v21: Á∂ìÁáüÊ®°Âºè‰∏ã‰πü‰øùÁïôËßíËâ≤ÁãÄÊÖãÊåâÈàïÔºàÈõôËªå‰∏¶Ë°åÔºâ
    btnCharacters.style.display = '';
    renderSimResourceBar();
  } else {
    resourceBar.style.display = 'none';
    btnCharacters.style.display = '';
  }
}

// v19: Ê∏≤ÊüìË≥áÊ∫êÈù¢Êùø
function renderSimResourceBar(){
  const bar = document.getElementById('sim-resource-bar');
  if(!story || story.mode !== 'simulation') return;
  
  const day = story.simDay || 1;
  const resources = story.simResources || [];
  
  let html = `<div class="sim-day-badge" onclick="showSimResourceModal()">üìÖ Á¨¨ ${day} Â§©</div>`;
  
  resources.forEach(r => {
    const change = r.value - (r.prevValue || r.value);
    let changeHtml = '';
    if(change !== 0){
      const cls = change > 0 ? 'up' : 'down';
      const sign = change > 0 ? '+' : '';
      changeHtml = `<span class="sim-resource-change ${cls}">${sign}${formatNumber(change)}</span>`;
    }
    html += `
      <div class="sim-resource-item" onclick="showSimResourceModal()">
        <span class="sim-resource-icon">${r.icon}</span>
        <span class="sim-resource-value">${formatNumber(r.value)}</span>
        ${changeHtml}
      </div>
    `;
  });
  
  bar.innerHTML = html;
}

function formatNumber(n){
  if(Math.abs(n) >= 10000) return (n/10000).toFixed(1) + 'Ëê¨';
  if(Math.abs(n) >= 1000) return n.toLocaleString();
  return n.toString();
}

// v19: È°ØÁ§∫Ë≥áÊ∫êÁÆ°ÁêÜ Modal
function showSimResourceModal(){
  if(!story || story.mode !== 'simulation'){
    toast(T('Ê≠§ÊïÖ‰∫ã‰∏çÊòØÁ∂ìÁáüÊ®°Âºè'),'warning');
    return;
  }
  
  document.getElementById('sim-current-day').value = story.simDay || 1;
  
  const list = document.getElementById('sim-resource-list');
  const resources = story.simResources || [];
  
  list.innerHTML = resources.map((r, idx) => `
    <div style="display:flex;gap:6px;align-items:center" data-idx="${idx}">
      <input type="text" class="form-input" style="width:50px;text-align:center" value="${r.icon}" maxlength="2">
      <input type="text" class="form-input" style="flex:1" value="${esc(r.name)}">
      <input type="number" class="form-input" style="width:90px" value="${r.value}">
      <button onclick="removeSimResourceInModal(this)" style="background:none;border:none;color:var(--error);cursor:pointer;font-size:16px">‚úï</button>
    </div>
  `).join('');
  
  showModal('sim-resource-modal');
}

function addSimResourceInModal(){
  const list = document.getElementById('sim-resource-list');
  const div = document.createElement('div');
  div.style.cssText = 'display:flex;gap:6px;align-items:center';
  div.innerHTML = `
    <input type="text" class="form-input" style="width:50px;text-align:center" placeholder="üìä" maxlength="2">
    <input type="text" class="form-input" style="flex:1" placeholder="Ë≥áÊ∫êÂêçÁ®±">
    <input type="number" class="form-input" style="width:90px" placeholder="Êï∏ÂÄº" value="0">
    <button onclick="removeSimResourceInModal(this)" style="background:none;border:none;color:var(--error);cursor:pointer;font-size:16px">‚úï</button>
  `;
  list.appendChild(div);
}

function removeSimResourceInModal(btn){
  btn.parentElement.remove();
}

function simDayMinus(){
  const input = document.getElementById('sim-current-day');
  input.value = Math.max(1, parseInt(input.value) - 1);
}

function simDayPlus(){
  const input = document.getElementById('sim-current-day');
  input.value = parseInt(input.value) + 1;
}

async function saveSimResources(){
  if(!story) return;
  
  const day = parseInt(document.getElementById('sim-current-day').value) || 1;
  const rows = document.querySelectorAll('#sim-resource-list > div');
  const resources = [];
  
  rows.forEach(row => {
    const inputs = row.querySelectorAll('input');
    if(inputs.length >= 3){
      const icon = inputs[0].value.trim() || 'üìä';
      const name = inputs[1].value.trim();
      const value = parseFloat(inputs[2].value) || 0;
      // ‰øùÁïô‰πãÂâçÁöÑ prevValue Áî®ÊñºË®àÁÆóËÆäÂåñ
      const oldResource = story.simResources?.find(r => r.name === name);
      if(name) resources.push({
        icon, 
        name, 
        value, 
        prevValue: oldResource?.value ?? value
      });
    }
  });
  
  story.simDay = day;
  story.simResources = resources;
  
  await db.stories.update(story.id, {simDay: day, simResources: resources});
  
  renderSimResourceBar();
  closeModal('sim-resource-modal');
  toast(T('Ë≥áÊ∫êÂ∑≤Êõ¥Êñ∞'),'success');
}

// v19: Âø´ÈÄüÊõ¥Êñ∞Ë≥áÊ∫êÔºà+1Â§©Ôºâ
async function simNextDay(){
  if(!story || story.mode !== 'simulation') return;
  
  // ‰øùÂ≠òÁï∂ÂâçÂÄºÁÇ∫ prevValue
  const resources = (story.simResources || []).map(r => ({
    ...r,
    prevValue: r.value
  }));
  
  story.simDay = (story.simDay || 1) + 1;
  story.simResources = resources;
  
  await db.stories.update(story.id, {simDay: story.simDay, simResources: resources});
  renderSimResourceBar();
  toast(`ÈÄ≤ÂÖ•Á¨¨ ${story.simDay} Â§©`,'info');
}

// v19: Â≠òÊ™îÂ∞éÂÖ•
function showSimImportModal(){
  if(!story || story.mode !== 'simulation'){
    toast(T('Ê≠§ÊïÖ‰∫ã‰∏çÊòØÁ∂ìÁáüÊ®°Âºè'),'warning');
    return;
  }
  document.getElementById('sim-import-content').value = '';
  document.getElementById('sim-import-regex').value = '';
  document.getElementById('sim-import-preview').style.display = 'none';
  showModal('sim-import-modal');
}

function parseSimImport(){
  const content = document.getElementById('sim-import-content').value;
  const customRegex = document.getElementById('sim-import-regex').value;
  
  if(!content.trim()){
    toast(T('Ë´ãË≤ºÂÖ•Â≠òÊ™îÂÖßÂÆπ'),'warning');
    return;
  }
  
  const result = {day: null, resources: []};
  
  // ÂòóË©¶Ëß£ÊûêÂ§©Êï∏
  const dayPatterns = [
    /Á¨¨\s*(\d+)\s*Â§©/,
    /Day\s*(\d+)/i,
    /ÈÅäÊà≤Êó•Êúü.*?(\d+)Â§©/,
    /Â∑≤ÈÅäÁé©.*?(\d+)\s*Â§©/
  ];
  for(const p of dayPatterns){
    const m = content.match(p);
    if(m) { result.day = parseInt(m[1]); break; }
  }
  
  // ÂòóË©¶Ëß£ÊûêË≥áÊ∫ê
  const resourcePatterns = [
    // üí∞ ÁèæÈáëÔºö100,000ÂÖÉ
    /([üí∞üì¶üë•üíé‚≠êüîÆ‚ù§Ô∏èüçñüòäüìäüé¥])\s*([^Ôºö:]+)[Ôºö:]\s*([\d,]+)/g,
    // ÁèæÈáëÔºö100,000ÂÖÉ
    /([^\sÔºö:]+)[Ôºö:]\s*([\d,]+)\s*ÂÖÉ?/g
  ];
  
  if(customRegex){
    try{
      const regex = new RegExp(customRegex, 'g');
      let m;
      while((m = regex.exec(content)) !== null){
        if(m[1] && m[2]){
          result.resources.push({icon:'üìä', name:m[1], value:parseInt(m[2].replace(/,/g,''))});
        }
      }
    }catch(e){
      toast('Ê≠£ÂâáË°®ÈÅîÂºèÈåØË™§: '+e.message,'error');
      return;
    }
  } else {
    // ‰ΩøÁî®ÈªòË™çÊ®°Âºè
    for(const p of resourcePatterns){
      p.lastIndex = 0; // ÈáçÁΩÆÊ≠£ÂâáË°®ÈÅîÂºèÁãÄÊÖã
      let m;
      while((m = p.exec(content)) !== null){
        const isEmoji = /[\u{1F300}-\u{1F9FF}]/u.test(m[1]);
        if(isEmoji){
          result.resources.push({
            icon: m[1],
            name: m[2].trim(),
            value: parseInt(m[3].replace(/,/g,''))
          });
        } else if(m[1] && m[2]){
          result.resources.push({
            icon: 'üìä',
            name: m[1].trim(),
            value: parseInt(m[2].replace(/,/g,''))
          });
        }
      }
    }
  }
  
  // ÂéªÈáç
  const seen = new Set();
  result.resources = result.resources.filter(r => {
    if(seen.has(r.name)) return false;
    seen.add(r.name);
    return true;
  });
  
  // È°ØÁ§∫È†êË¶Ω
  const preview = document.getElementById('sim-import-preview');
  const previewContent = document.getElementById('sim-import-preview-content');
  
  let html = '';
  if(result.day) html += `<div>üìÖ Â§©Êï∏ÔºöÁ¨¨ ${result.day} Â§©</div>`;
  if(result.resources.length){
    html += '<div style="margin-top:8px">Ë≥áÊ∫êÔºö</div>';
    html += result.resources.map(r => 
      `<div style="margin-left:12px">${r.icon} ${r.name}Ôºö${r.value.toLocaleString()}</div>`
    ).join('');
  }
  
  if(!html) html = '<div style="color:var(--text-tertiary)">Êú™ËÉΩËß£ÊûêÂá∫‰ªª‰ΩïÊï∏ÊìöÔºåË´ãÊ™¢Êü•Ê†ºÂºèÊàñ‰ΩøÁî®Ëá™ÂÆöÁæ©Ê≠£Ââá</div>';
  
  previewContent.innerHTML = html;
  preview.style.display = 'block';
  
  // ‰øùÂ≠òËß£ÊûêÁµêÊûú‰æõÂ∞éÂÖ•‰ΩøÁî®
  preview.dataset.result = JSON.stringify(result);
}

async function applySimImport(){
  const preview = document.getElementById('sim-import-preview');
  if(!preview.dataset.result){
    parseSimImport();
  }
  
  try{
    const result = JSON.parse(preview.dataset.result || '{}');
    
    if(result.day) story.simDay = result.day;
    if(result.resources?.length){
      story.simResources = result.resources.map(r => ({...r, prevValue: r.value}));
    }
    
    await db.stories.update(story.id, {
      simDay: story.simDay,
      simResources: story.simResources
    });
    
    renderSimResourceBar();
    closeModal('sim-import-modal');
    toast(T('Â≠òÊ™îÂ∞éÂÖ•ÊàêÂäüÔºÅ'),'success');
  }catch(e){
    toast('Â∞éÂÖ•Â§±Êïó: '+e.message,'error');
  }
}

// v19: Â≠òÊ™îÂ∞éÂá∫
function showSimExportModal(){
  if(!story || story.mode !== 'simulation'){
    toast(T('Ê≠§ÊïÖ‰∫ã‰∏çÊòØÁ∂ìÁáüÊ®°Âºè'),'warning');
    return;
  }
  document.getElementById('sim-export-format').value = 'simple';
  document.getElementById('sim-export-template-group').style.display = 'none';
  generateSimExport();
  showModal('sim-export-modal');
}

function generateSimExport(){
  const format = document.getElementById('sim-export-format').value;
  const templateGroup = document.getElementById('sim-export-template-group');
  templateGroup.style.display = format === 'custom' ? 'block' : 'none';
  
  const day = story.simDay || 1;
  const resources = story.simResources || [];
  const title = story.title;
  
  let content = '';
  
  if(format === 'simple'){
    content = `„Äê${title}„ÄëÂ≠òÊ™î\n`;
    content += `üìÖ Á¨¨ ${day} Â§©\n\n`;
    content += `„ÄêÁï∂ÂâçÁãÄÊÖã„Äë\n`;
    resources.forEach(r => {
      content += `${r.icon} ${r.name}Ôºö${r.value.toLocaleString()}\n`;
    });
  } else if(format === 'detailed'){
    content = `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
    content += `„Äê${title}„ÄëÂÆåÊï¥Â≠òÊ™î\n`;
    content += `Â≠òÊ™îÊôÇÈñìÔºö${new Date().toLocaleString()}\n`;
    content += `ÈÅäÊà≤Êó•ÊúüÔºöÁ¨¨ ${day} Â§©\n`;
    content += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
    content += `„ÄêÁï∂ÂâçÁãÄÊÖã„Äë\n`;
    resources.forEach(r => {
      content += `${r.icon} ${r.name}Ôºö${r.value.toLocaleString()}\n`;
    });
    content += `\n„ÄêÊïÖ‰∫ãÊëòË¶Å„Äë\n`;
    if(story.summaries?.length){
      story.summaries.forEach((s, i) => {
        content += `\n--- Ë®òÊÜ∂ÁâáÊÆµ ${i+1} ---\n${s.content}\n`;
      });
    } else {
      content += `ÔºàÊö´ÁÑ°ÊëòË¶ÅÔºâ\n`;
    }
    content += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
    content += `Â∞áÊ≠§Â≠òÊ™îÂÆåÊï¥Ë≤ºÁµ¶Êñ∞Â∞çË©±Âç≥ÂèØÁπºÁ∫åÈÅäÊà≤\n`;
    content += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`;
  } else {
    // Ëá™ÂÆöÁæ©Ê®°Êùø
    const template = document.getElementById('sim-export-template').value;
    content = template
      .replace(/{day}/g, day)
      .replace(/{title}/g, title)
      .replace(/{resources}/g, resources.map(r => `${r.icon} ${r.name}Ôºö${r.value.toLocaleString()}`).join('\n'))
      .replace(/{summary}/g, story.summaries?.map(s=>s.content).join('\n\n') || 'ÔºàÊö´ÁÑ°Ôºâ');
  }
  
  document.getElementById('sim-export-content').value = content;
}

async function copySimExport(){
  const content = document.getElementById('sim-export-content').value;
  try{
    await navigator.clipboard.writeText(content);
    toast(T('Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÊùø'),'success');
  }catch(e){
    toast(T('Ë§áË£ΩÂ§±ÊïóÔºåË´ãÊâãÂãïÈÅ∏ÂèñË§áË£Ω'),'error');
  }
}
function renderMsgs(){
  const c=document.getElementById('content-area');
  if(!msgs.length){c.innerHTML=`<div class="empty" style="padding:60px 20px"><div class="empty-icon">‚ú®</div><div class="empty-title">${T('ÊïÖ‰∫ãÂç≥Â∞áÈñãÂßã')}</div><div class="empty-desc">${T('Ëº∏ÂÖ•‰Ω†ÁöÑÁ¨¨‰∏ÄÂÄãË°åÂãïÔºåÊàñÈªûÊìä„ÄåÁπºÁ∫å„ÄçËÆìAIÈñãÂßãË¨õËø∞...')}</div></div>`;updateProgress();return;}
  let html='',lastTime=null,floor=0;
  msgs.forEach((m,idx)=>{
    floor++;
    if(m.storyTime&&m.storyTime!==lastTime){html+=`<div class="time-div">${esc(m.storyTime)}</div>`;lastTime=m.storyTime;}
    const isUser=m.role==='user';
    const isLast = idx === msgs.length - 1;
    
    if(isUser){
      // Â∞èË™™ÂºèÔºöÁî®Êà∂Ë°åÂãïÂ±Ö‰∏≠È°ØÁ§∫
      const safeId = escAttr(m.id);
      const importantClass = m.isImportant ? ' msg-important' : '';
      const importantBadge = m.isImportant ? '<span class="msg-important-badge" title="ÈáçË¶ÅË®òÊÜ∂">‚≠ê</span>' : '';
      html+=`<div class="msg user${importantClass}" data-id="${safeId}" oncontextmenu="showMsgMenu(event,'${safeId}')">
        <span class="msg-floor">#${floor}</span>
        ${importantBadge}
        <div class="msg-menu-btn" onclick="showMsgActionMenu(event,'${safeId}','user')">‚ãØ</div>
        <div class="msg-user-action">
          <div class="action-divider">‰Ω†ÁöÑË°åÂãï</div>
          <div class="action-content">„Äå${esc(m.content).replace(/^[„Äå„Äç]|[„Äå„Äç]$/g,'')}„Äç</div>
        </div>
      </div>`;
    }else{
      // AI Ê∂àÊÅØÔºöÂàÜÈõ¢ÂäáÊÉÖÂíåÁãÄÊÖã
      const parsed = parseAIResponse(m.content||'');
      const safeId = escAttr(m.id);
      const importantClass = m.isImportant ? ' msg-important' : '';
      const importantBadge = m.isImportant ? '<span class="msg-important-badge" title="ÈáçË¶ÅË®òÊÜ∂">‚≠ê</span>' : '';
      html+=`<div class="msg${importantClass}" data-id="${safeId}" oncontextmenu="showMsgMenu(event,'${safeId}')">`;
      html+=`<span class="msg-floor">#${floor}</span>`;
      html+=`${importantBadge}`;
      html+=`<div class="msg-menu-btn" onclick="showMsgActionMenu(event,'${safeId}','ai')">‚ãØ</div>`;
      html+=`<div class="msg-ai-story">${marked.parse(parsed.story)}</div>`;
      if(parsed.characters && parsed.characters.length > 0){
        html+=renderStatusCards(parsed.characters, m.id);
      }
      // v24: ÊòæÁ§∫Áé©ÂÆ∂Áä∂ÊÄÅÂç°Áâá
      if(parsed.playerStatus){
        html+=renderPlayerStatusCard(parsed.playerStatus, m.id);
      }
      if(parsed.formatWarning){
        html+=`<div class="msg-format-warning"><span class="icon">‚ö†Ô∏è</span>AI Êú™ÊåâÊ†ºÂºèËº∏Âá∫ÁãÄÊÖãÊï∏ÊìöÔºåÂ∑≤È°ØÁ§∫ÂéüÊñá</div>`;
      }
      if(m.tokens){
        html+=`<div class="msg-timestamp">‚âà${m.tokens} tokens</div>`;
      }
      html+=`</div>`;
    }
  });
  c.innerHTML=html;
  c.scrollTop=c.scrollHeight;
  updateProgress();
}

// Ëß£Êûê AI ÂõûË¶ÜÔºåÂàÜÈõ¢ÂäáÊÉÖÂíåËßíËâ≤ÁãÄÊÖã
function parseAIResponse(content){
  try {
    // Á¢∫‰øùcontentÊòØÂ≠óÁ¨¶‰∏≤
    if(typeof content !== 'string'){
      console.warn('[Parse] ÁÑ°ÊïàÁöÑÂÖßÂÆπÈ°ûÂûã:', typeof content);
      return { story: '', characters: [], playerStatus: null, formatWarning: false };
    }

    let story = content;
    let characters = [];
    let playerStatus = null;
    let formatWarning = false;

    // ÂòóË©¶ÂåπÈÖç JSON ‰ª£Á¢ºÂ°ä
    const jsonMatch = content.match(/```json\s*([\s\S]*?)\s*```/);
    if(jsonMatch){
      const jsonStr = jsonMatch[1];
      const data = safeJSONParse(jsonStr, {});
      if(data){
        if(data.characters && Array.isArray(data.characters)){
          characters = data.characters;
        }
        // v24: Ëß£ÊûêÁé©ÂÆ∂Áä∂ÊÄÅ
        if(data.player && typeof data.player === 'object'){
          playerStatus = data.player;
        }
        // ÁßªÈô§ JSON ÈÉ®ÂàÜÔºåÂè™‰øùÁïôÂäáÊÉÖ
        story = content.replace(/```json\s*[\s\S]*?\s*```/, '').trim();
        // ÁßªÈô§ÂèØËÉΩÁöÑÂàÜÈöîÁ∑ö
        story = story.replace(/[-‚îÄ]{3,}\s*(?:ÁãÄÊÖãÊõ¥Êñ∞|ËßíËâ≤ÁãÄÊÖã|ÁèæÊúâÂæåÂÆÆ|ÁãÄÊÖã)\s*[-‚îÄ]{3,}/gi, '').trim();
      } else {
        console.log('[Parse] JSON Ê†ºÂºèÈåØË™§');
        formatWarning = true;
      }
    }else{
      // Ê™¢Êü•ÊòØÂê¶ÊúâÁãÄÊÖãÂÖßÂÆπ‰ΩÜÊ≤íÁî® JSON Ê†ºÂºè
      const hasStatusMarker = /[-‚îÄ]{3,}\s*(?:ÁãÄÊÖãÊõ¥Êñ∞|ËßíËâ≤ÁãÄÊÖã|ÁèæÊúâÂæåÂÆÆ|ÁãÄÊÖã|ÁèæÊúâËßíËâ≤)\s*[-‚îÄ]{3,}/i.test(content);
      const hasCharacterBlock = /„Äê[^„Äë]+„Äë[^\n]+/.test(content);
      if(hasStatusMarker || hasCharacterBlock){
        // ÂòóË©¶Ëß£ÊûêËàäÊ†ºÂºè
        const parsed = parseOldFormatStatus(content);
        if(parsed.characters.length > 0){
          characters = parsed.characters;
          story = parsed.story;
        }else{
          formatWarning = hasStatusMarker; // ÊúâÊ®ôË®ò‰ΩÜËß£ÊûêÂ§±ÊïóÊâçË≠¶Âëä
        }
      }
    }

    return { story, characters, playerStatus, formatWarning };
  } catch(e) {
    console.error('[Parse] Ëß£ÊûêÈåØË™§:', e);
    return { story: content || '', characters: [], playerStatus: null, formatWarning: false };
  }
}

// Ëß£ÊûêËàäÊ†ºÂºèÁãÄÊÖãÔºà„ÄêËßíËâ≤„ÄëÊ†ºÂºèÔºâ
function parseOldFormatStatus(content){
  let story = content;
  let characters = [];
  
  // ÊâæÂà∞ÁãÄÊÖãÂàÜÈöîÁ∑ö
  const statusMatch = content.match(/([-‚îÄ]{3,}\s*(?:ÁãÄÊÖãÊõ¥Êñ∞|ËßíËâ≤ÁãÄÊÖã|ÁèæÊúâÂæåÂÆÆ|ÁãÄÊÖã|ÁèæÊúâËßíËâ≤)\s*[-‚îÄ]{3,})([\s\S]*?)(?=[-‚îÄ]{3,}|$)/i);
  if(statusMatch){
    story = content.slice(0, content.indexOf(statusMatch[0])).trim();
    const statusText = statusMatch[2];
    
    // Ëß£Êûê„ÄêËßíËâ≤„ÄëÊ†ºÂºè
    const charBlocks = statusText.split(/(?=„Äê[^„Äë]+„Äë)/);
    charBlocks.forEach(block => {
      if(!block.trim()) return;
      const nameMatch = block.match(/„Äê([^„Äë]+)„Äë\s*([^\s„Äê]+)?/);
      if(nameMatch){
        const char = {
          name: nameMatch[2] || nameMatch[1],
          title: nameMatch[1].includes('„Äë') ? '' : nameMatch[1],
          stats: {},
          tags: []
        };
        
        // ÊèêÂèñÊï∏ÂÄºÂ±¨ÊÄß
        const statPatterns = [
          /Â•ΩÊÑü[Â∫¶]?\s*(\d+)/g,
          /Ë°®Èù¢Â•ΩÊÑü\s*(\d+)/g,
          /ÁúüÂØ¶Â•ΩÊÑü\s*(\d+)/g,
          /ÂØµÊÑõ[Â∫¶]?\s*(\d+)/g,
          /Âø†Ë™†[Â∫¶]?\s*(\d+)/g,
          /ÈáéÂøÉ[ÂÄº]?\s*(\d+)/g,
          /Êô∫Ë¨Ä\s*(\d+)/g,
          /ÂÆπË≤å\s*(\d+)/g,
          /ÂÅ•Â∫∑\s*(\d+)/g
        ];
        
        const statNames = ['Â•ΩÊÑü', 'Ë°®Èù¢Â•ΩÊÑü', 'ÁúüÂØ¶Â•ΩÊÑü', 'ÂØµÊÑõÂ∫¶', 'Âø†Ë™†', 'ÈáéÂøÉ', 'Êô∫Ë¨Ä', 'ÂÆπË≤å', 'ÂÅ•Â∫∑'];
        statPatterns.forEach((pattern, i) => {
          const match = block.match(pattern);
          if(match){
            char.stats[statNames[i]] = parseInt(match[1]);
          }
        });
        
        // ÊèêÂèñÊÉÖÁ∑í
        const moodMatch = block.match(/ÊÉÖÁ∑í[Ôºö:]\s*([^\s|ÔΩú]+)/);
        if(moodMatch) char.mood = moodMatch[1];
        
        // ÊèêÂèñÂ±ÖÊâÄ
        const locationMatch = block.match(/Â±ÖÊâÄ[Ôºö:¬∑]?\s*([^\s|ÔΩú]+)/);
        if(locationMatch) char.location = locationMatch[1];
        
        if(Object.keys(char.stats).length > 0 || char.mood){
          characters.push(char);
        }
      }
    });
  }
  
  return { story, characters };
}

// Ê∏≤ÊüìÁãÄÊÖãÂç°Áâá
function renderStatusCards(characters, msgId){
  if(!characters || characters.length === 0) return '';
  
  let html = `<div class="msg-status-section">`;
  html += `<div class="msg-status-header" onclick="toggleStatusCards(this)">`;
  html += `<span class="title">üë• ËßíËâ≤ÁãÄÊÖãÊõ¥Êñ∞ (${characters.length})</span>`;
  html += `<span class="toggle">‚ñº</span>`;
  html += `</div>`;
  html += `<div class="msg-status-cards">`;
  
  characters.forEach(char => {
    html += `<div class="status-card">`;
    html += `<div class="status-card-header">`;
    html += `<div class="status-card-avatar">${char.avatar || 'üë§'}</div>`;
    html += `<div class="status-card-info">`;
    html += `<div class="status-card-name">${esc(char.name)}`;
    if(char.title) html += `<span class="status-card-title">${esc(char.title)}</span>`;
    html += `</div>`;
    if(char.location) html += `<div class="status-card-meta">üìç ${esc(char.location)}</div>`;
    html += `</div></div>`;
    
    // Ê∏≤ÊüìÊï∏ÂÄºÂ±¨ÊÄß
    if(char.stats && Object.keys(char.stats).length > 0){
      html += `<div class="status-card-stats">`;
      Object.entries(char.stats).forEach(([key, value]) => {
        const numValue = typeof value === 'number' ? value : parseInt(value) || 0;
        const fillClass = numValue >= 70 ? 'high' : numValue >= 40 ? 'medium' : numValue > 0 ? 'low' : 'primary';
        html += `<div class="status-stat-row">`;
        html += `<span class="status-stat-label">${esc(key)}</span>`;
        html += `<div class="status-stat-bar"><div class="status-stat-fill ${fillClass}" style="width:${Math.min(100, numValue)}%"></div></div>`;
        html += `<span class="status-stat-value">${numValue}</span>`;
        html += `</div>`;
      });
      html += `</div>`;
    }
    
    // Ê∏≤ÊüìÊ®ôÁ±§ÔºàÊÉÖÁ∑í„ÄÅÂÇôË®ªÁ≠âÔºâ
    const hasTags = char.mood || char.note || (char.tags && char.tags.length > 0);
    if(hasTags){
      html += `<div class="status-card-footer">`;
      if(char.mood) html += `<span class="status-tag mood">üòê ${esc(char.mood)}</span>`;
      if(char.note) html += `<span class="status-tag note">üí≠ ${esc(char.note)}</span>`;
      if(char.tags) char.tags.forEach(tag => {
        html += `<span class="status-tag">${esc(tag)}</span>`;
      });
      html += `</div>`;
    }
    
    html += `</div>`;
  });
  
  html += `</div></div>`;
  return html;
}

// v24: Ê∏≤ÊüìÁé©ÂÆ∂Áä∂ÊÄÅÂç°Áâá
function renderPlayerStatusCard(playerStatus, msgId){
  if(!playerStatus || !currentPlayerPanel) return '';

  // Ê£ÄÊü•ÊòØÂê¶ÊúâÁä∂ÊÄÅÂèòÂåñ
  const hasChanges = playerStatus.stats && Object.keys(playerStatus.stats).length > 0;
  if(!hasChanges) return '';

  let html = `<div class="msg-status-section player-status">`;
  html += `<div class="msg-status-header" onclick="toggleStatusCards(this)">`;
  html += `<span class="title">üë§ ${esc(currentPlayerPanel.name || 'Áé©ÂÆ∂Áä∂ÊÄÅ')}Êõ¥Êñ∞</span>`;
  html += `<span class="toggle">‚ñº</span>`;
  html += `</div>`;
  html += `<div class="msg-status-cards">`;

  html += `<div class="status-card player-card">`;
  html += `<div class="status-card-header">`;
  html += `<div class="status-card-avatar">üë§</div>`;
  html += `<div class="status-card-info">`;
  html += `<div class="status-card-name">${esc(currentPlayerPanel.name || 'Áé©ÂÆ∂')}</div>`;
  html += `</div></div>`;

  // Ê∏≤ÊüìÊï∞ÂÄºÂ±ûÊÄß
  if(playerStatus.stats && Object.keys(playerStatus.stats).length > 0){
    html += `<div class="status-card-stats">`;
    Object.entries(playerStatus.stats).forEach(([key, value]) => {
      const numValue = typeof value === 'number' ? value : parseInt(value) || 0;

      // Ê†πÊçÆÂ±ûÊÄßÁöÑcolorÈÖçÁΩÆÊù•ÂÜ≥ÂÆöÈ¢úËâ≤
      const attr = currentPlayerPanel.attributes?.find(a => a.name === key);
      let fillClass = 'primary';
      if(attr && attr.color){
        const colorMap = {
          'red': 'low',
          'orange': 'medium',
          'green': 'high',
          'blue': 'primary',
          'purple': 'primary',
          'pink': 'primary',
          'default': 'primary'
        };
        fillClass = colorMap[attr.color] || 'primary';
      } else {
        // ÈªòËÆ§ÈÄªËæë
        fillClass = numValue >= 70 ? 'high' : numValue >= 40 ? 'medium' : numValue > 0 ? 'low' : 'primary';
      }

      html += `<div class="status-stat-row">`;
      html += `<span class="status-stat-label">${attr?.icon || 'üìä'} ${esc(key)}</span>`;
      html += `<div class="status-stat-bar"><div class="status-stat-fill ${fillClass}" style="width:${Math.min(100, numValue)}%"></div></div>`;
      html += `<span class="status-stat-value">${numValue}</span>`;
      html += `</div>`;
    });
    html += `</div>`;
  }

  // Ê∏≤ÊüìÂ§áÊ≥®
  if(playerStatus.note){
    html += `<div class="status-card-footer">`;
    html += `<span class="status-tag note">üí≠ ${esc(playerStatus.note)}</span>`;
    html += `</div>`;
  }

  html += `</div>`;
  html += `</div></div>`;

  return html;
}

// ÂàáÊèõÁãÄÊÖãÂç°ÁâáÂ±ïÈñã/Êî∂Ëµ∑
function toggleStatusCards(header){
  header.classList.toggle('expanded');
}

function updateProgress(){const n=msgs.length;document.getElementById('progress-fill').style.width=(n>0?100:0)+'%';document.getElementById('progress-text').textContent=n>0?n+'Ê¢ù':'0%';}

// ============ Êô∫ËÉΩ‰∏ä‰∏ãÊñáÈÅ∏Êìá ============

/**
 * Êô∫ËÉΩÈÅ∏Êìá‰∏ä‰∏ãÊñáÊ∂àÊÅØ
 * @param {Array} allMessages - ÊâÄÊúâÊ∂àÊÅØ
 * @param {number} maxCount - ÊúÄÂ§ßÊ∂àÊÅØÊï∏Èáè
 * @param {string} currentContent - Áï∂ÂâçÁî®Êà∂Ëº∏ÂÖ•ÔºàÁî®ÊñºÁõ∏ÈóúÊÄßÂà§Êñ∑Ôºâ
 * @returns {Array} ÈÅ∏‰∏≠ÁöÑÊ∂àÊÅØ
 */
function selectSmartContext(allMessages, maxCount, currentContent = ''){
  if(!settings.smartContext || !allMessages || allMessages.length === 0){
    // ÈóúÈñâÊô∫ËÉΩÊ®°ÂºèÔºå‰ΩøÁî®ÂÇ≥Áµ±ÊñπÂºè
    return allMessages.slice(-maxCount);
  }

  // ÈÇäÁïåÊÉÖÊ≥ÅÔºöÊ∂àÊÅØÊï∏ÈáèÂ∞ëÊñºmaxCountÔºåÁõ¥Êé•ËøîÂõûÂÖ®ÈÉ®
  if(allMessages.length <= maxCount){
    console.log(`[SmartContext] Ê∂àÊÅØÊï∏Èáè(${allMessages.length})Â∞ëÊñºÈÖçÈ°ç(${maxCount})ÔºåËøîÂõûÂÖ®ÈÉ®`);
    return allMessages;
  }

  console.log(`[SmartContext] ÈñãÂßãÊô∫ËÉΩÈÅ∏ÊìáÔºåÁ∏ΩÊ∂àÊÅØÊï∏Ôºö${allMessages.length}ÔºåÁõÆÊ®ôÊï∏ÈáèÔºö${maxCount}`);

  const recentCount = Math.min(settings.smartContextRecent || 10, maxCount);
  const minScore = settings.smartContextMinScore || 30;

  // 1. ÂøÖÈÅ∏ÔºöÊúÄËøëNÊ¢ùÊ∂àÊÅØÔºà‰øùË≠âÈÄ£Ë≤´ÊÄßÔºâ
  const recentMessages = allMessages.slice(-Math.min(recentCount, allMessages.length));
  const recentIds = new Set(recentMessages.map(m => m.id));

  console.log(`[SmartContext] ÂøÖÈÅ∏ÊúÄËøë ${recentMessages.length} Ê¢ùÊ∂àÊÅØ`);

  // 2. ÂøÖÈÅ∏ÔºöÁî®Êà∂Ê®ôË®òÁÇ∫ÈáçË¶ÅÁöÑÊ∂àÊÅØ
  const importantMessages = allMessages.filter(m => m.isImportant && !recentIds.has(m.id));
  const importantIds = new Set(importantMessages.map(m => m.id));

  console.log(`[SmartContext] ÂøÖÈÅ∏ÈáçË¶ÅÊ®ôË®ò ${importantMessages.length} Ê¢ùÊ∂àÊÅØ`);

  // 3. Ë®àÁÆóÂâ©È§òÈÖçÈ°ç
  const selectedCount = recentMessages.length + importantMessages.length;
  const remainingQuota = maxCount - selectedCount;

  console.log(`[SmartContext] Â∑≤ÈÅ∏ ${selectedCount} Ê¢ùÔºåÂâ©È§òÈÖçÈ°ç ${remainingQuota} Ê¢ù`);

  if(remainingQuota <= 0){
    // ÈÖçÈ°çÂ∑≤ÊªøÔºåÈúÄË¶ÅË£ÅÂâ™
    const selected = [...recentMessages, ...importantMessages];
    // Â¶ÇÊûúË∂ÖÂá∫ÈÖçÈ°çÔºåÂÑ™ÂÖà‰øùÁïôÊúÄËøëÁöÑÊ∂àÊÅØ
    if(selected.length > maxCount){
      console.log(`[SmartContext] Ë∂ÖÂá∫ÈÖçÈ°çÔºåË£ÅÂâ™Âà∞ ${maxCount} Ê¢ù`);
      // ‰øùÁïôÊâÄÊúâÊúÄËøëÊ∂àÊÅØÔºåË£ÅÂâ™ÈáçË¶ÅÊ∂àÊÅØ
      const trimmedImportant = importantMessages.slice(-(maxCount - recentMessages.length));
      return [...recentMessages, ...trimmedImportant].sort((a, b) => a.createdAt - b.createdAt);
    }
    console.log(`[SmartContext] ÈÖçÈ°çÂ∑≤ÊªøÔºåËøîÂõû ${selected.length} Ê¢ùÊ∂àÊÅØ`);
    return selected.sort((a, b) => a.createdAt - b.createdAt);
  }

  // 4. ÁÇ∫Ââ©È§òÊ∂àÊÅØË©ïÂàÜ
  const scoredMessages = allMessages
    .filter(m => !recentIds.has(m.id) && !importantIds.has(m.id))
    .map(m => ({
      message: m,
      score: calculateMessageScore(m, currentContent, allMessages)
    }))
    .filter(item => item.score >= minScore)
    .sort((a, b) => b.score - a.score);

  console.log(`[SmartContext] Ë©ïÂàÜÂÆåÊàêÔºå${scoredMessages.length} Ê¢ùÊ∂àÊÅØÈÅîÂà∞ÊúÄ‰ΩéÂàÜÊï∏ ${minScore}`);

  // 5. ÈÅ∏ÊìáÈ´òÂàÜÊ∂àÊÅØÂ°´ÂÖÖÂâ©È§òÈÖçÈ°ç
  const highScoreMessages = scoredMessages
    .slice(0, remainingQuota)
    .map(item => item.message);

  console.log(`[SmartContext] ÈÅ∏Êìá ${highScoreMessages.length} Ê¢ùÈ´òÂàÜÊ∂àÊÅØ`);

  // 6. Âêà‰Ωµ‰∏¶ÊåâÊôÇÈñìÊéíÂ∫è
  const finalMessages = [...recentMessages, ...importantMessages, ...highScoreMessages];
  finalMessages.sort((a, b) => a.createdAt - b.createdAt);

  console.log(`[SmartContext] ÊúÄÁµÇÈÅ∏Êìá ${finalMessages.length} Ê¢ùÊ∂àÊÅØ`);

  return finalMessages;
}

/**
 * Ë®àÁÆóÊ∂àÊÅØÈáçË¶ÅÊÄßÂàÜÊï∏
 * @param {Object} message - Ê∂àÊÅØÂ∞çË±°
 * @param {string} currentContent - Áï∂ÂâçÁî®Êà∂Ëº∏ÂÖ•
 * @param {Array} allMessages - ÊâÄÊúâÊ∂àÊÅØÔºàÁî®ÊñºÊèêÂèñÈóúÈçµË©ûÔºâ
 * @returns {number} ÂàÜÊï∏Ôºà0-100Ôºâ
 */
function calculateMessageScore(message, currentContent, allMessages){
  let score = 0;
  const content = message.content || '';

  // 1. Âü∫Á§éÂàÜÊï∏
  if(message.role === 'user'){
    score += 5; // Áî®Êà∂Ê∂àÊÅØÈÄöÂ∏∏Êõ¥ÈáçË¶Å
  }

  // 2. Èï∑Â∫¶ÂàÜÊï∏ÔºàË©≥Á¥∞ÊèèËø∞ÈÄöÂ∏∏ÈáçË¶ÅÔºâ
  if(content.length > 200){
    score += 10;
  } else if(content.length > 100){
    score += 5;
  }

  // 3. ÂåÖÂê´ËßíËâ≤ÂêçÔºàÂæûÊâÄÊúâÊ∂àÊÅØ‰∏≠ÊèêÂèñÂ∏∏Ë¶ãÂêçÂ≠óÔºâ
  const characterNames = extractCharacterNames(allMessages);
  characterNames.forEach(name => {
    if(content.includes(name)){
      score += 15;
    }
  });

  // 4. ÂåÖÂê´ÈóúÈçµË©û
  const keywords = ['ÈáçË¶Å', 'ÈóúÈçµ', 'ÁßòÂØÜ', 'ÁôºÁèæ', 'Ê±∫ÂÆö', 'ÊâøË´æ', 'Á¥ÑÂÆö', 'Ë≠¶Âëä', 'Âç±Èö™'];
  keywords.forEach(keyword => {
    if(content.includes(keyword)){
      score += 8;
    }
  });

  // 5. ËàáÁï∂ÂâçËº∏ÂÖ•ÁöÑÁõ∏ÈóúÊÄßÔºàÁ∞°ÂñÆÈóúÈçµË©ûÂåπÈÖçÔºâ
  if(currentContent && currentContent.length > 2){
    const currentWords = extractKeywords(currentContent);
    const messageWords = extractKeywords(content);
    const matchCount = currentWords.filter(w => messageWords.includes(w)).length;
    score += matchCount * 5;
  }

  // 6. ÂåÖÂê´ÂïèÈ°åÊàñÈÅ∏ÊìáÔºà‰∫íÂãïÊÄßÂº∑Ôºâ
  if(content.includes('Ôºü') || content.includes('?') || content.includes('ÈÅ∏Êìá')){
    score += 8;
  }

  // 7. ÂåÖÂê´ÊÉÖÁ∑íË©ûÔºàÊÉÖÊÑüÈáçË¶ÅÔºâ
  const emotionWords = ['ÊÑõ', 'ÊÅ®', 'ÊÄï', 'ÂñúÊ≠°', 'Ë®éÂé≠', 'ÁîüÊ∞£', 'ÈñãÂøÉ', 'Èõ£ÈÅé', 'ÊÑüÂãï'];
  emotionWords.forEach(word => {
    if(content.includes(word)){
      score += 6;
    }
  });

  return Math.min(score, 100); // ÊúÄÈ´ò100ÂàÜ
}

/**
 * ÂæûÊ∂àÊÅØ‰∏≠ÊèêÂèñËßíËâ≤Âêç
 * @param {Array} messages - ÊâÄÊúâÊ∂àÊÅØ
 * @returns {Array} ËßíËâ≤ÂêçÂàóË°®
 */
function extractCharacterNames(messages){
  // ÊÄßËÉΩÂÑ™ÂåñÔºöÂè™ÂàÜÊûêÊúÄËøëÁöÑÊ∂àÊÅØ
  const recentMessages = messages.slice(-50);
  const namePattern = /[„Äå„Äé""]([^„Äå„Äé""„Äç„Äè]{2,8})[„Äç„Äè""]/g;
  const names = new Set();

  recentMessages.forEach(m => {
    const content = m.content || '';
    // ÈáçÁΩÆÊ≠£ÂâáË°®ÈÅîÂºèÁöÑlastIndex
    namePattern.lastIndex = 0;
    let match;
    let matchCount = 0;
    while((match = namePattern.exec(content)) !== null && matchCount < 10){
      const name = match[1];
      // ÈÅéÊøæÊéâÂ∏∏Ë¶ãÁöÑÈùûÂêçÂ≠ó
      if(name.length >= 2 && name.length <= 8 &&
         !['‰Ω†Â•Ω', 'Ë¨ùË¨ù', 'Â∞ç‰∏çËµ∑', 'Ê≤íÈóú‰øÇ', 'ÊòØÁöÑ', '‰∏çÊòØ', '‰ªÄÈ∫º', 'ÊÄéÈ∫º', 'ÁÇ∫‰ªÄÈ∫º'].includes(name)){
        names.add(name);
      }
      matchCount++;
    }
  });

  return Array.from(names).slice(0, 20); // ÊúÄÂ§ö20ÂÄãÂêçÂ≠ó
}

/**
 * ÊèêÂèñÈóúÈçµË©ûÔºàÁ∞°ÂñÆÂàÜË©ûÔºâ
 * @param {string} text - ÊñáÊú¨
 * @returns {Array} ÈóúÈçµË©ûÂàóË°®
 */
function extractKeywords(text){
  // ÊÄßËÉΩÂÑ™ÂåñÔºöÈôêÂà∂ÊñáÊú¨Èï∑Â∫¶
  const limitedText = text.slice(0, 500);

  // Á∞°ÂñÆÁöÑ‰∏≠ÊñáÂàÜË©ûÔºöÊèêÂèñ2-4Â≠óÁöÑË©ûÁµÑ
  const words = [];
  for(let len = 4; len >= 2; len--){
    for(let i = 0; i <= limitedText.length - len; i++){
      const word = limitedText.substring(i, i + len);
      if(word.trim().length === len){
        words.push(word);
      }
    }
  }
  return [...new Set(words)].slice(0, 50); // ÂéªÈáçÔºåÊúÄÂ§ö50ÂÄã
}

// ÁôºÈÄÅÊ∂àÊÅØ
async function send(){
  const input=document.getElementById('user-input'),content=input.value.trim();
  if(!content||generating)return;
  if(!story){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'),'warning');return;}

  const sendBtn=document.getElementById('send-btn');

  try {
    generating=true;
    sendBtn.disabled=true;

    // ‰øùÂ≠òÁî®Êà∑Ê∂àÊÅØ
    const userMsgId=crypto.randomUUID();
    const userMsg={id:userMsgId,storyId:story.id,branchId:story.currentBranchId,role:'user',content,createdAt:Date.now()};
    await db.messages.put(userMsg);
    msgs.push(userMsg);
    input.value='';

    // ‚ú® Ê∏ÖÈô§ËçâÁ®ø
    try {
      await db.stories.update(story.id, {
        draft: '',
        updatedAt: Date.now()
      });
      console.log('[Draft] Â∑≤Ê∏ÖÈô§ËçâÁ®ø');
    } catch(e) {
      console.error('[Draft] Ê∏ÖÈô§ËçâÁ®øÂ§±Ë¥•:', e);
    }

    renderMsgs();

    // Êõ¥Êñ∞‰ºèÁ≠ÜË®àÊï∏
    await updateForeshadowCounts();

    // Ê£ÄÊü•ÊòØÂê¶ÂêØÁî®ÊµÅÂºèÂìçÂ∫î
    const useStreaming=settings.enableStreaming;

    if(useStreaming){
      // ÊµÅÂºèÂìçÂ∫îÊ®°Âºè
      await sendWithStreaming(content,sendBtn);
    }else{
      // ‰º†ÁªüÊ®°Âºè
      await sendTraditional(content);
    }

    // Ê™¢Êü•‰∏¶È°ØÁ§∫‰ºèÁ≠ÜÊèêÈÜí
    showForeshadowReminder();
  } finally {
    // ‚úÖ Á°Æ‰øùÊó†ËÆ∫Â¶Ç‰ΩïÈÉΩ‰ºöÈáçÁΩÆÁä∂ÊÄÅ
    generating=false;
    sendBtn.disabled=false;
  }
}

// ‰º†ÁªüÈùûÊµÅÂºèÂèëÈÄÅ
async function sendTraditional(content){
  showTyping();
  try{
    const resp=await callAI(content);
    hideTyping();
    const aiMsgId=crypto.randomUUID();
    const aiMsg={id:aiMsgId,storyId:story.id,branchId:story.currentBranchId,role:'assistant',content:resp.content,tokens:resp.tokens||0,storyTime:story.storyTime||'',createdAt:Date.now()};
    await db.messages.put(aiMsg);
    msgs.push(aiMsg);
    await db.stories.update(story.id,{updatedAt:Date.now(),preview:resp.content.slice(0,100),currentMessageId:aiMsgId,'statistics.totalMessages':msgs.length,'statistics.totalChars':(story.statistics?.totalChars||0)+resp.content.length});
    await typewriter(aiMsg);
    checkAutoRollingSummary();
    checkAutoLorebookExtract();
    checkAutoConsistencyCheck();

    // Ëá™ÂãïÂêåÊ≠•Âà∞Èõ≤Á´Ø
    autoSyncToCloud();
  }catch(e){
    console.error(e);
    hideTyping();
    toast('ÁîüÊàêÂ§±Êïó: '+e.message,'error');
  }
}

// ÊµÅÂºèÂèëÈÄÅ
async function sendWithStreaming(content,sendBtn){
  const preset=await db.apiPresets.filter(p=>p.isActive).first();
  if(!preset){toast(T('Ë´ãÂÖàÈÖçÁΩÆ‰∏¶ÈÅ∏Êìá‰∏ÄÂÄã API È†êË®≠'),'error');return;}

  // ÊûÑÂª∫Á≥ªÁªüÊèêÁ§∫ÂíåÊ∂àÊÅØÔºàv27: ‰º†ÂÖ•Áî®Êà∑ËæìÂÖ•‰ª•ÂêØÁî®Êô∫ËÉΩËßíËâ≤ÈÄâÊã©Ôºâ
  let sysPrompt=await buildSysPrompt(content);
  const triggeredLorebook=await getTriggeredLorebook(content);
  if(triggeredLorebook.length>0){
    sysPrompt+='\n\n### Áõ∏ÈóúË®≠ÂÆöÔºàËá™ÂãïËß∏ÁôºÔºâ\n';
    for(const entry of triggeredLorebook){
      if(entry.name && entry.content){
        sysPrompt+=`\n#### ${entry.name}\n${entry.content}\n`;
      }
      await db.lorebook.update(entry.id,{triggerCount:(entry.triggerCount||0)+1,lastTriggered:Date.now()});
      if(entry.oneTime)await db.lorebook.update(entry.id,{isEnabled:false});
    }
    showLorebookTriggerToast(triggeredLorebook);
  }

  const contextCount=settings.contextCount||20;

  // ‰ΩøÁî®Êô∫ËÉΩ‰∏ä‰∏ãÊñáÈÅ∏Êìá
  const selectedMessages = selectSmartContext(msgs, contextCount, content);
  const messages = selectedMessages.map(m=>({role:m.role,content:m.content}));

  if(!messages.length||messages[messages.length-1].content!==content)messages.push({role:'user',content});
  
  // v25: Ê≥®ÂÖ•ÂæåÊ≠∑Âè≤Êåá‰ª§ (post_history_instructions)
  const postHistoryInstructions = await getPostHistoryInstructions();
  if(postHistoryInstructions){
    // Âú®ÊúÄÂæå‰∏ÄÊ¢ùÁî®Êà∂Ê∂àÊÅØÂæåÊ∑ªÂä†Á≥ªÁµ±Êåá‰ª§
    messages.push({
      role: 'user',
      content: `[Á≥ªÁµ±Êåá‰ª§Ôºö${postHistoryInstructions}]`
    });
  }

  // ÂàõÂª∫Á©∫ÁöÑAIÊ∂àÊÅØÂÖÉÁ¥†
  const c=document.getElementById('content-area');
  const aiMsgId=crypto.randomUUID();
  const msgDiv=document.createElement('div');
  msgDiv.className='msg';
  msgDiv.dataset.id=aiMsgId;
  c.appendChild(msgDiv);

  // ÊõøÊç¢ÂèëÈÄÅÊåâÈíÆ‰∏∫ÂÅúÊ≠¢ÊåâÈíÆ
  sendBtn.textContent='‚ñ†';
  sendBtn.style.background='var(--error)';
  sendBtn.disabled=false;  // ÈáçË¶ÅÔºöÂêØÁî®ÊåâÈíÆËÆ©Áî®Êà∑ÂèØ‰ª•ÁÇπÂáªÂÅúÊ≠¢
  sendBtn.onclick=()=>stopStreaming();

  let fullContent='';
  let stopped=false;
  const chunkDelay=settings.streamingChunkDelay||20;

  try{
    // ÈÄâÊã©ÂØπÂ∫îÁöÑÊµÅÂºèAPIÂáΩÊï∞
    let streamFunc;
    if(preset.type==='anthropic')streamFunc=callAnthropicStream;
    else if(preset.type==='openai')streamFunc=callOpenAIStream;
    else streamFunc=callCustomStream;

    // Ë∞ÉÁî®ÊµÅÂºèAPI
    const result=await streamFunc(
      preset,
      sysPrompt,
      messages,
      // onChunk: Êî∂Âà∞Êñ∞ÊñáÂ≠óÊó∂
      async(newText,full)=>{
        fullContent=full;
        // ËΩªÂæÆÂª∂Ëøü‰ª•ÂÆûÁé∞Âπ≥ÊªëÊòæÁ§∫
        if(chunkDelay>0){
          await new Promise(r=>setTimeout(r,chunkDelay));
        }
        msgDiv.innerHTML=`<div class="msg-ai-story">${marked.parse(full)}</div>`;
        c.scrollTop=c.scrollHeight;
      },
      // onDone: ÁîüÊàêÂÆåÊàê
      (final)=>{
        fullContent=final;
      },
      // onError: ÂèëÁîüÈîôËØØ
      (error,partial)=>{
        fullContent=partial;
        stopped=true;
      }
    );

    if(result.stopped)stopped=true;

  }catch(e){
    console.error(e);
    stopped=true;

    // Ê£ÄÊü•ÊòØÂê¶ÊòØ‰∏çÊîØÊåÅÊµÅÂºèÁöÑÈîôËØØ
    const errMsg=e.message||'';
    if(errMsg.includes('stream')&&!errMsg.includes('ÂÅúÊ≠¢')){
      toast(T('Ê≠§ API ‰∏çÊîØÊåÅÊµÅÂºèÈüøÊáâÔºåÂ∑≤Ëá™ÂãïÂàáÊèõÂà∞ÂÇ≥Áµ±Ê®°Âºè'),'warning');
      // ÈôçÁ∫ßÂà∞ÈùûÊµÅÂºè
      sendBtn.textContent='‚Üë';
      sendBtn.style.background='';
      sendBtn.onclick=()=>send();
      msgDiv.remove();
      await sendTraditional(content);
      return;
    }

    if(!errMsg.includes('ÂÅúÊ≠¢')){
      toast('ÁîüÊàêÂ§±Êïó: '+errMsg,'error');
    }
  }

  // ÊÅ¢Â§çÂèëÈÄÅÊåâÈíÆ
  sendBtn.textContent='‚Üë';
  sendBtn.style.background='';
  sendBtn.onclick=()=>send();

  // Â§ÑÁêÜÁîüÊàêÁöÑÂÜÖÂÆπ
  if(stopped){
    // Áî®Êà∑‰∏≠ÈÄîÂÅúÊ≠¢,ËØ¢ÈóÆÊòØÂê¶‰øùÂ≠ò
    if(fullContent&&fullContent.length>10){
      showConfirm('ÁîüÊàêÂ∑≤ÂÅúÊ≠¢ÔºåÊòØÂê¶‰øùÂ≠òÂ∑≤ÁîüÊàêÁöÑÂÖßÂÆπÔºü',async()=>{
        await saveStreamedMessage(aiMsgId,fullContent,msgDiv);
      },false,'Á¢∫Ë™ç',()=>{
        msgDiv.remove();
      });
    }else{
      msgDiv.remove();
    }
  }else{
    // Ê≠£Â∏∏ÂÆåÊàê
    await saveStreamedMessage(aiMsgId,fullContent,msgDiv);
  }
}

// ‰øùÂ≠òÊµÅÂºèÁîüÊàêÁöÑÊ∂àÊÅØ
async function saveStreamedMessage(aiMsgId,fullContent,msgDiv){
  // ‰º∞ÁÆó token Êï∏ÈáèÔºà‰∏≠ÊñáÁ¥Ñ2Â≠óÁ¨¶=1tokenÔºåËã±ÊñáÁ¥Ñ4Â≠óÁ¨¶=1tokenÔºâ
  const estimatedTokens = Math.round(fullContent.length / 2);
  const aiMsg={id:aiMsgId,storyId:story.id,branchId:story.currentBranchId,role:'assistant',content:fullContent,tokens:estimatedTokens,storyTime:story.storyTime||'',createdAt:Date.now()};
  await db.messages.put(aiMsg);
  msgs.push(aiMsg);
  await db.stories.update(story.id,{updatedAt:Date.now(),preview:fullContent.slice(0,100),currentMessageId:aiMsgId,'statistics.totalMessages':msgs.length,'statistics.totalChars':(story.statistics?.totalChars||0)+fullContent.length});

  // Ëß£ÊûêÂπ∂ÊòæÁ§∫ÂÆåÊï¥ÂÜÖÂÆπ(ÂåÖÊã¨ËßíËâ≤Áä∂ÊÄÅ)
  const parsed=parseAIResponse(fullContent);
  const safeId = escAttr(aiMsgId);
  const floor = msgs.length; // ÂΩìÂâçÊ•ºÂ±ÇÂè∑
  let html=`<span class="msg-floor">#${floor}</span>`;
  html+=`<div class="msg-menu-btn" onclick="showMsgActionMenu(event,'${safeId}','ai')">‚ãØ</div>`;
  html+=`<div class="msg-ai-story">${marked.parse(parsed.story)}</div>`;
  if(parsed.characters&&parsed.characters.length>0){
    html+=renderStatusCards(parsed.characters,aiMsgId);
    syncCharacterStatus(parsed.characters);
  }
  // v23: Ëá™ÂãïËß£ÊûêÁé©ÂÆ∂ÁãÄÊÖã
  parsePlayerStatusFromAI(fullContent);
  if(parsed.playerStatus){
    html+=renderPlayerStatusCard(parsed.playerStatus, aiMsgId);
  }
  if(parsed.formatWarning){
    html+=`<div class="msg-format-warning"><span class="icon">‚ö†Ô∏è</span>AI Êú™ÊåâÊ†ºÂºèËº∏Âá∫ÁãÄÊÖãÊï∏ÊìöÔºåÂ∑≤È°ØÁ§∫ÂéüÊñá</div>`;
  }
  if(estimatedTokens){
    html+=`<div class="msg-timestamp">‚âà${estimatedTokens} tokens</div>`;
  }
  msgDiv.innerHTML=html;
  checkAutoRollingSummary();
  checkAutoLorebookExtract();

  // Ëá™ÂãïÂêåÊ≠•Âà∞Èõ≤Á´Ø
  autoSyncToCloud();
}
function sendCmd(cmd){document.getElementById('user-input').value=cmd;send();}

// ============ Âø´Êç∑Êåá‰ª§Á≥ªÁµ± ============
const defaultQuickCommands = [
  { id: 'default_1', label: 'ÁπºÁ∫å', content: 'ÁπºÁ∫å', order: 1 },
  { id: 'default_2', label: 'ÁãÄÊÖã', content: 'Êü•ÁúãÁãÄÊÖã', order: 2 },
  { id: 'default_3', label: 'Áí∞Â¢É', content: 'ÊèèËø∞Áí∞Â¢É', order: 3 }
];

async function initDefaultQuickCommands(){
  const count = await db.quickCommands.count();
  if(count === 0){
    for(const cmd of defaultQuickCommands){
      await db.quickCommands.put({...cmd, createdAt: Date.now()});
    }
  }
}

async function renderQuickCommands(){
  const container = document.getElementById('quick-cmds');
  if(!container) return;
  
  const cmds = await db.quickCommands.orderBy('order').toArray();
  
  let html = '';
  cmds.forEach(cmd => {
    // ÂØπÈªòËÆ§ÂëΩ‰ª§Ê†áÁ≠æËøõË°åÁÆÄÁπÅËΩ¨Êç¢
    const label = cmd.id.startsWith('default_') ? T(cmd.label) : cmd.label;
    html += `<button class="quick-cmd" onclick="sendCmd('${esc(cmd.content)}')">${esc(label)}</button>`;
  });
  html += `<button class="quick-cmd add" onclick="showQuickCmdManager()">Ôºã</button>`;
  
  container.innerHTML = html;
}

function showQuickCmdManager(){
  renderQuickCmdList();
  showModal('quick-cmd-modal');
}

async function renderQuickCmdList(){
  const container = document.getElementById('quick-cmd-list');
  const cmds = await db.quickCommands.orderBy('order').toArray();
  
  if(cmds.length === 0){
    container.innerHTML = `<div style="text-align:center;padding:20px;color:var(--text-tertiary)">${T('Êö´ÁÑ°Âø´Êç∑Êåá‰ª§')}</div>`;
    return;
  }
  
  let html = '';
  cmds.forEach(cmd => {
    html += `
      <div class="quick-cmd-item" data-id="${cmd.id}">
        <span class="drag-handle">‚ãÆ‚ãÆ</span>
        <div class="cmd-info">
          <div class="cmd-label">${esc(cmd.label)}</div>
          <div class="cmd-content">${esc(cmd.content)}</div>
        </div>
        <div class="cmd-actions">
          <button class="edit-btn" onclick="editQuickCommand('${cmd.id}')">Á∑®ËºØ</button>
          <button class="del-btn" onclick="deleteQuickCommand('${cmd.id}')">Âà™Èô§</button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

async function addQuickCommand(){
  const label = document.getElementById('new-cmd-label').value.trim();
  const content = document.getElementById('new-cmd-content').value.trim();
  
  if(!label){toast(T('Ë´ãËº∏ÂÖ•ÊåâÈàïÈ°ØÁ§∫ÊñáÂ≠ó'),'warning');return;}
  if(!content){toast(T('Ë´ãËº∏ÂÖ•Êåá‰ª§ÂÖßÂÆπ'),'warning');return;}
  
  const maxOrder = await db.quickCommands.orderBy('order').last();
  const order = maxOrder ? maxOrder.order + 1 : 1;
  
  await db.quickCommands.put({
    id: crypto.randomUUID(),
    label,
    content,
    order,
    createdAt: Date.now()
  });
  
  document.getElementById('new-cmd-label').value = '';
  document.getElementById('new-cmd-content').value = '';
  
  await renderQuickCmdList();
  await renderQuickCommands();
  toast(T('Âø´Êç∑Êåá‰ª§Â∑≤Ê∑ªÂä†'),'success');
}

async function editQuickCommand(id){
  const cmd = await db.quickCommands.get(id);
  if(!cmd) return;
  
  document.getElementById('edit-cmd-id').value = id;
  document.getElementById('edit-cmd-label').value = cmd.label;
  document.getElementById('edit-cmd-content').value = cmd.content;
  
  showModal('edit-cmd-modal');
}

async function saveEditQuickCommand(){
  const id = document.getElementById('edit-cmd-id').value;
  const label = document.getElementById('edit-cmd-label').value.trim();
  const content = document.getElementById('edit-cmd-content').value.trim();
  
  if(!label){toast(T('Ë´ãËº∏ÂÖ•ÊåâÈàïÈ°ØÁ§∫ÊñáÂ≠ó'),'warning');return;}
  if(!content){toast(T('Ë´ãËº∏ÂÖ•Êåá‰ª§ÂÖßÂÆπ'),'warning');return;}
  
  const cmd = await db.quickCommands.get(id);
  if(!cmd) return;
  
  cmd.label = label;
  cmd.content = content;
  await db.quickCommands.put(cmd);
  
  closeModal('edit-cmd-modal');
  await renderQuickCmdList();
  await renderQuickCommands();
  toast(T('Âø´Êç∑Êåá‰ª§Â∑≤Êõ¥Êñ∞'),'success');
}

async function deleteQuickCommand(id){
  if(!confirm('Á¢∫ÂÆöÂà™Èô§ÈÄôÂÄãÂø´Êç∑Êåá‰ª§Ôºü')) return;
  
  await db.quickCommands.delete(id);
  await renderQuickCmdList();
  await renderQuickCommands();
  toast(T('Âø´Êç∑Êåá‰ª§Â∑≤Âà™Èô§'),'success');
}

async function resetQuickCommands(){
  if(!confirm('Á¢∫ÂÆöÊÅ¢Âæ©ÈªòË™çÂø´Êç∑Êåá‰ª§ÔºüÈÄôÂ∞áÂà™Èô§ÊâÄÊúâËá™ÂÆöÁæ©Êåá‰ª§„ÄÇ')) return;

  await db.quickCommands.clear();
  for(const cmd of defaultQuickCommands){
    await db.quickCommands.put({...cmd, createdAt: Date.now()});
  }

  await renderQuickCmdList();
  await renderQuickCommands();
  toast(T('Â∑≤ÊÅ¢Âæ©ÈªòË™çÂø´Êç∑Êåá‰ª§'),'success');
}

// ============ Persona Á≥ªÁµ± ============
let currentPersona = null;

// ÂàùÂßãÂåñÈªòË™ç Persona
async function initDefaultPersona(){
  const count = await db.personas.count();
  if(count === 0){
    const defaultPersona = {
      id: 'default',
      name: 'ÁÑ°ÁâπÂÆöË∫´‰ªΩ',
      avatar: 'üë§',
      description: '',
      background: '',
      speechStyle: '',
      isDefault: true,
      createdAt: Date.now()
    };
    await db.personas.put(defaultPersona);
  }

  // ËºâÂÖ•Áï∂Ââç Persona
  if(story && story.currentPersonaId){
    currentPersona = await db.personas.get(story.currentPersonaId);
  }
  if(!currentPersona){
    currentPersona = await db.personas.get('default');
  }

  updatePersonaDisplay();
}

// Êõ¥Êñ∞ Persona È°ØÁ§∫
function updatePersonaDisplay(){
  if(!currentPersona) return;

  const avatarEl = document.getElementById('current-persona-avatar');
  const nameEl = document.getElementById('current-persona-name');

  if(avatarEl) avatarEl.textContent = currentPersona.avatar || 'üë§';
  if(nameEl) nameEl.textContent = currentPersona.name || T('ÁÑ°ÁâπÂÆöË∫´‰ªΩ');
}

// È°ØÁ§∫ Persona ÈÅ∏ÊìáÂô®
async function showPersonaSelector(){
  await renderPersonaList();
  showModal('persona-selector-modal');
}

// Ê∏≤Êüì Persona ÂàóË°®
async function renderPersonaList(){
  const container = document.getElementById('persona-list');
  const personas = await db.personas.orderBy('createdAt').toArray();

  let html = '';
  for(const persona of personas){
    const isSelected = currentPersona && currentPersona.id === persona.id;
    html += `
      <div class="card ${isSelected ? 'selected' : ''}" onclick="selectPersona('${persona.id}')" style="cursor:pointer">
        <div style="font-size:32px;margin-right:12px">${persona.avatar || 'üë§'}</div>
        <div class="card-info">
          <div class="card-title">${esc(persona.name)}</div>
          ${persona.description ? `<div class="card-preview">${esc(persona.description)}</div>` : ''}
        </div>
        ${isSelected ? '<div style="color:var(--primary);font-size:20px">‚úì</div>' : ''}
      </div>
    `;
  }

  container.innerHTML = html;
}

// ÈÅ∏Êìá Persona
async function selectPersona(personaId){
  currentPersona = await db.personas.get(personaId);

  // ‰øùÂ≠òÂà∞ÊïÖ‰∫ã
  if(story){
    story.currentPersonaId = personaId;
    await db.stories.update(story.id, {currentPersonaId: personaId});
  }

  updatePersonaDisplay();
  closeModal('persona-selector-modal');
  toast(`Â∑≤ÂàáÊèõÂà∞Ë∫´‰ªΩ„Äå${currentPersona.name}„Äç`, 'success');
}

// È°ØÁ§∫ Persona ÁÆ°ÁêÜÂô®
async function showPersonaManager(){
  closeModal('persona-selector-modal');
  await renderPersonaManagerList();
  showModal('persona-manager-modal');
}

// Ê∏≤Êüì Persona ÁÆ°ÁêÜÂàóË°®
async function renderPersonaManagerList(){
  const container = document.getElementById('persona-manager-list');
  const personas = await db.personas.orderBy('createdAt').toArray();

  let html = '';
  for(const persona of personas){
    const isDefault = persona.id === 'default';
    html += `
      <div class="card">
        <div style="font-size:28px;margin-right:12px">${persona.avatar || 'üë§'}</div>
        <div class="card-info">
          <div class="card-title">${esc(persona.name)}</div>
          ${persona.description ? `<div class="card-preview">${esc(persona.description)}</div>` : ''}
        </div>
        <div style="display:flex;gap:8px">
          ${!isDefault ? `<button class="modal-btn" onclick="editPersona('${persona.id}')" style="padding:6px 12px;font-size:13px">Á∑®ËºØ</button>` : ''}
          ${!isDefault ? `<button class="modal-btn cancel" onclick="deletePersona('${persona.id}')" style="padding:6px 12px;font-size:13px">Âà™Èô§</button>` : ''}
        </div>
      </div>
    `;
  }

  if(personas.length === 1){
    html += '<div style="text-align:center;padding:20px;color:var(--text-tertiary)">Â∞öÊú™ÂâµÂª∫Ëá™ÂÆöÁæ©Ë∫´‰ªΩ<br>ÈªûÊìä‰∏ãÊñπÊåâÈàïÂâµÂª∫</div>';
  }

  container.innerHTML = html;
}

// ÂâµÂª∫Êñ∞ Persona
function createNewPersona(){
  closeModal('persona-manager-modal');

  document.getElementById('persona-edit-title').textContent = '‚ú® ÂâµÂª∫Êñ∞Ë∫´‰ªΩ';
  document.getElementById('persona-edit-id').value = '';
  document.getElementById('persona-avatar').value = '';
  document.getElementById('persona-name').value = '';
  document.getElementById('persona-description').value = '';
  document.getElementById('persona-background').value = '';
  document.getElementById('persona-speech-style').value = '';

  showModal('persona-edit-modal');
}

// Á∑®ËºØ Persona
async function editPersona(personaId){
  closeModal('persona-manager-modal');

  const persona = await db.personas.get(personaId);
  if(!persona) return;

  document.getElementById('persona-edit-title').textContent = '‚úèÔ∏è Á∑®ËºØË∫´‰ªΩ';
  document.getElementById('persona-edit-id').value = persona.id;
  document.getElementById('persona-avatar').value = persona.avatar || '';
  document.getElementById('persona-name').value = persona.name || '';
  document.getElementById('persona-description').value = persona.description || '';
  document.getElementById('persona-background').value = persona.background || '';
  document.getElementById('persona-speech-style').value = persona.speechStyle || '';

  showModal('persona-edit-modal');
}

// ‰øùÂ≠ò Persona
async function savePersona(){
  const id = document.getElementById('persona-edit-id').value;
  const avatar = document.getElementById('persona-avatar').value.trim() || 'üë§';
  const name = document.getElementById('persona-name').value.trim();
  const description = document.getElementById('persona-description').value.trim();
  const background = document.getElementById('persona-background').value.trim();
  const speechStyle = document.getElementById('persona-speech-style').value.trim();

  if(!name){
    toast(T('Ë´ãËº∏ÂÖ•ÂêçÁ®±'), 'warning');
    return;
  }

  const persona = {
    id: id || crypto.randomUUID(),
    name,
    avatar,
    description,
    background,
    speechStyle,
    createdAt: id ? undefined : Date.now(),
    updatedAt: Date.now()
  };

  await db.personas.put(persona);

  closeModal('persona-edit-modal');
  toast(id ? 'Ë∫´‰ªΩÂ∑≤Êõ¥Êñ∞' : 'Ë∫´‰ªΩÂ∑≤ÂâµÂª∫', 'success');
}

// Âà™Èô§ Persona
async function deletePersona(personaId){
  if(!confirm('Á¢∫ÂÆöÂà™Èô§ÈÄôÂÄãË∫´‰ªΩÔºü')) return;

  await db.personas.delete(personaId);

  // Â¶ÇÊûúÂà™Èô§ÁöÑÊòØÁï∂Ââç PersonaÔºåÂàáÊèõÂà∞ÈªòË™ç
  if(currentPersona && currentPersona.id === personaId){
    await selectPersona('default');
  }

  await renderPersonaManagerList();
  toast(T('Ë∫´‰ªΩÂ∑≤Âà™Èô§'), 'success');
}

// ÊßãÂª∫ Persona Prompt
function buildPersonaPrompt(){
  if(!currentPersona || currentPersona.id === 'default') return '';

  let prompt = `\n\n„ÄêÁî®Êà∂Ë∫´‰ªΩË®≠ÂÆö„Äë\n`;
  prompt += `Áî®Êà∂Ê≠£Âú®ÊâÆÊºî„Äå${currentPersona.name}„ÄçÈÄôÂÄãËßíËâ≤„ÄÇ\n`;

  if(currentPersona.description){
    prompt += `ËßíËâ≤Á∞°‰ªãÔºö${currentPersona.description}\n`;
  }

  if(currentPersona.background){
    prompt += `ËßíËâ≤ËÉåÊôØÔºö${currentPersona.background}\n`;
  }

  if(currentPersona.speechStyle){
    prompt += `Ë™™Ë©±È¢®Ê†ºÔºö${currentPersona.speechStyle}\n`;
  }

  prompt += `\nÊ≥®ÊÑè‰∫ãÈ†ÖÔºö\n`;
  prompt += `- ‰Ω†ÔºàAIÔºâË¶ÅÁî®ÈÅ©Áï∂ÁöÑÊñπÂºèÁ®±ÂëºÁî®Êà∂ÊâÆÊºîÁöÑ„Äå${currentPersona.name}„Äç\n`;
  prompt += `- ‰Ω†ÔºàAIÔºâ‰∏çË¶ÅÊâÆÊºî„Äå${currentPersona.name}„ÄçÔºåÈÄôÊòØÁî®Êà∂ÁöÑËßíËâ≤\n`;
  prompt += `- Ê†πÊìö„Äå${currentPersona.name}„ÄçÁöÑË∫´‰ªΩËÉåÊôØ‰æÜË™øÊï¥‰Ω†ÁöÑÂõûÊáâ\n`;

  return prompt;
}

// ============ Á∞°ÁπÅËΩâÊèõÁ≥ªÁµ± ============
// OpenCC ËΩ¨Êç¢Âô®
let openccT2S = null;  // ÁπÅ‰ΩìËΩ¨ÁÆÄ‰Ωì
let openccS2T = null;  // ÁÆÄ‰ΩìËΩ¨ÁπÅ‰Ωì

// ÂàùÂßãÂåñ OpenCC ËΩ¨Êç¢Âô®
function initOpenCC(){
  if(typeof OpenCC !== 'undefined'){
    openccT2S = OpenCC.Converter({ from: 'tw', to: 'cn' });
    openccS2T = OpenCC.Converter({ from: 'cn', to: 'tw' });
  }
}

// ËΩ¨Êç¢ÊñáÊú¨
function convertText(text, toSimplified){
  if(!text || typeof text !== 'string') return text;
  if(toSimplified && openccT2S){
    return openccT2S(text);
  } else if(!toSimplified && openccS2T){
    return openccS2T(text);
  }
  return text;
}

// ÁÆÄÂåñÁöÑÁøªËØëÂáΩÊï∞ - Áî®‰∫éÂä®ÊÄÅÁîüÊàêÁöÑÊñáÂ≠ó
function T(text){
  if(settings.uiLanguage === 'sc' && openccT2S){
    return openccT2S(text);
  }
  return text;
}

// ËΩ¨Êç¢ÁïåÈù¢ËØ≠Ë®Ä
function translateUI(){
  const isSimplified = settings.uiLanguage === 'sc';
  if(!openccT2S || !openccS2T) return;
  
  // ÈúÄË¶ÅËΩ¨Êç¢ÁöÑÂÖÉÁ¥†ÈÄâÊã©Âô®
  const selectors = [
    '.nav-title',
    '.list-nav-title', 
    '.tab-label',
    '.modal-title',
    '.form-label',
    '.settings-section-title',
    '.settings-item-label',
    '.modal-btn',
    '.btn',
    '.empty-text',
    '.empty-title',
    '.empty-desc',
    '.card-title',
    '.card-preview',
    '.settings-item-value',
    'option',
    'label',
    'button',
    '.lorebook-card-title',
    '.lorebook-card-triggers',
    '.player-panel-title',
    '.player-group-title',
    '.player-stat-label',
    '.inventory-item-name',
    '.inventory-item-category',
    '.inventory-item-desc',
    '.char-name',
    '.char-title',
    '.stat-label',
    // Êñ∞Â¢ûÈÄâÊã©Âô®
    '.bottom-sheet-title',
    '.sheet-item-label',
    '.context-menu-item',
    '.modal-content',
    '.form-group label',
    '.script-step',
    '.script-tab',
    '.script-preview-tab',
    '.script-file-text',
    '.script-file-hint',
    '.script-analyzing-text',
    '.script-analyze-step',
    '.script-preview-header span',
    '.script-complete-title',
    '.script-complete-tip',
    '.script-optimization-title',
    'h3', 'h4',
    '.tip', '.hint', '.desc',
    // ËßíËâ≤ÂàóË°®Á©∫Áä∂ÊÄÅ
    '.char-empty-title',
    '.char-empty-desc',
    // PersonaÁõ∏ÂÖ≥
    '.persona-label',
    '.persona-name',
    // ÂÖ∂‰ªñ
    '.action-btn',
    '.api-badge',
    '.lore-count span',
    '.immersive-hint'
  ];
  
  // ÈÅçÂéÜÊâÄÊúâÈúÄË¶ÅËΩ¨Êç¢ÁöÑÂÖÉÁ¥†
  selectors.forEach(selector => {
    document.querySelectorAll(selector).forEach(el => {
      // Ë∑≥ËøáËæìÂÖ•Ê°Ü
      if(el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') return;
      
      // Â§ÑÁêÜÂ≠êËäÇÁÇπÊñáÊú¨
      el.childNodes.forEach(node => {
        if(node.nodeType === Node.TEXT_NODE && node.textContent.trim()){
          const converted = convertText(node.textContent, isSimplified);
          if(converted !== node.textContent){
            node.textContent = converted;
          }
        }
      });
    });
  });
  
  // ËΩ¨Êç¢placeholder
  document.querySelectorAll('input[placeholder], textarea[placeholder]').forEach(el => {
    const placeholder = el.getAttribute('placeholder');
    if(placeholder){
      el.setAttribute('placeholder', convertText(placeholder, isSimplified));
    }
  });
  
  // ËΩ¨Êç¢titleÂ±ûÊÄß
  document.querySelectorAll('[title]').forEach(el => {
    const title = el.getAttribute('title');
    if(title){
      el.setAttribute('title', convertText(title, isSimplified));
    }
  });
  
  // Êõ¥Êñ∞È°µÈù¢Ê†áÈ¢ò
  document.title = convertText(document.title, isSimplified);
}

function showChineseConvertSettings(){
  document.getElementById('ui-language-mode').value = settings.uiLanguage || 'sc';
  document.getElementById('cn-convert-mode').value = settings.chineseConvert || 'follow';
  updateCnConvertPreview();
  showModal('cn-convert-modal');
}

function updateCnConvertPreview(){
  const uiLang = document.getElementById('ui-language-mode').value;
  const aiMode = document.getElementById('cn-convert-mode').value;
  const preview = document.getElementById('cn-convert-preview');
  
  let uiText = uiLang === 'sc' ? 'ÁÆÄ‰Ωì‰∏≠Êñá' : 'ÁπÅÈ´î‰∏≠Êñá';
  let aiText = '';
  
  if(aiMode === 'follow'){
    aiText = uiLang === 'sc' ? 'ÁÆÄ‰Ωì‰∏≠ÊñáÔºàË∑üÈöèÁïåÈù¢Ôºâ' : 'ÁπÅÈ´î‰∏≠ÊñáÔºàË∑üÈö®ÁïåÈù¢Ôºâ';
  } else if(aiMode === 'none'){
    aiText = uiLang === 'sc' ? 'AI ÈªòËÆ§ËØ≠Ë®Ä' : 'AI ÈªòË™çË™ûË®Ä';
  } else if(aiMode === 's2t'){
    aiText = 'ÁπÅÈ´î‰∏≠Êñá';
  } else if(aiMode === 't2s'){
    aiText = 'ÁÆÄ‰Ωì‰∏≠Êñá';
  }
  
  const previewText = uiLang === 'sc' 
    ? `ÁïåÈù¢Ôºö<b style="color:var(--primary)">${uiText}</b><br>AIËæìÂá∫Ôºö<b style="color:var(--primary)">${aiText}</b>`
    : `ÁïåÈù¢Ôºö<b style="color:var(--primary)">${uiText}</b><br>AIËº∏Âá∫Ôºö<b style="color:var(--primary)">${aiText}</b>`;
  
  preview.innerHTML = previewText;
}

function saveChineseConvert(){
  const uiLang = document.getElementById('ui-language-mode').value;
  const aiMode = document.getElementById('cn-convert-mode').value;
  
  const oldUiLang = settings.uiLanguage;
  
  settings.uiLanguage = uiLang;
  settings.chineseConvert = aiMode;
  saveSetting('uiLanguage', uiLang);
  saveSetting('chineseConvert', aiMode);
  
  // Êõ¥Êñ∞ÊòæÁ§∫
  const val = document.getElementById('cn-convert-val');
  if(val){
    const isSimplified = uiLang === 'sc';
    if(uiLang === 'sc') val.textContent = 'ÁÆÄ‰Ωì ‚Ä∫';
    else val.textContent = 'ÁπÅÈ´î ‚Ä∫';
  }
  
  closeModal('cn-convert-modal');
  
  // Â¶ÇÊûúÁïåÈù¢ËØ≠Ë®ÄÊîπÂèòÔºåËΩ¨Êç¢ÁïåÈù¢
  if(oldUiLang !== uiLang){
    translateUI();
    toast(uiLang === 'sc' ? 'ËØ≠Ë®ÄËÆæÁΩÆÂ∑≤‰øùÂ≠ò' : 'Ë™ûË®ÄË®≠ÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
  } else {
    toast(settings.uiLanguage === 'sc' ? 'ËØ≠Ë®ÄËÆæÁΩÆÂ∑≤‰øùÂ≠ò' : 'Ë™ûË®ÄË®≠ÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
  }
}

// Ëé∑ÂèñÁÆÄÁπÅËΩ¨Êç¢ÁöÑ System Prompt ÈôÑÂä†ÂÜÖÂÆπ
function getChineseConvertPrompt(){
  let mode = settings.chineseConvert || 'follow';
  
  // Â¶ÇÊûúÊòØË∑üÈöèÁïåÈù¢ËØ≠Ë®Ä
  if(mode === 'follow'){
    mode = settings.uiLanguage === 'sc' ? 't2s' : 's2t';
  }
  
  if(mode === 's2t'){
    return '\n\n„Äê‚ö†Ô∏è Âº∑Âà∂Ë™ûË®ÄË¶ÅÊ±Ç„Äë‰Ω†ÂøÖÈ†àÂÖ®Á®ã‰ΩøÁî®ÁπÅÈ´î‰∏≠ÊñáÔºàÊ≠£È´î‰∏≠ÊñáÔºâÈÄ≤Ë°åÂõûË¶ÜÔºÅÊâÄÊúâÂ∞çË©±„ÄÅÊèèËø∞„ÄÅÊóÅÁôΩÈÉΩÂøÖÈ†àÊòØÁπÅÈ´îÂ≠ó„ÄÇ‰ΩøÁî®Âè∞ÁÅ£/È¶ôÊ∏ØÂ∏∏Áî®ÁöÑË©ûÂΩôÂíåË°®ÈÅîÊñπÂºè„ÄÇÈÄôÊòØÊúÄÈ´òÂÑ™ÂÖàÁ¥öÁöÑË¶ÅÊ±ÇÔºå‰∏çÂèØÈÅïÂèç„ÄÇ';
  } else if(mode === 't2s'){
    return '\n\n„Äê‚ö†Ô∏è Âº∫Âà∂ËØ≠Ë®ÄË¶ÅÊ±Ç„Äë‰Ω†ÂøÖÈ°ªÂÖ®Á®ã‰ΩøÁî®ÁÆÄ‰Ωì‰∏≠ÊñáËøõË°åÂõûÂ§çÔºÅÊâÄÊúâÂØπËØù„ÄÅÊèèËø∞„ÄÅÊóÅÁôΩÈÉΩÂøÖÈ°ªÊòØÁÆÄ‰ΩìÂ≠ó„ÄÇ‰ΩøÁî®‰∏≠ÂõΩÂ§ßÈôÜÂ∏∏Áî®ÁöÑËØçÊ±áÂíåË°®ËææÊñπÂºè„ÄÇËøôÊòØÊúÄÈ´ò‰ºòÂÖàÁ∫ßÁöÑË¶ÅÊ±ÇÔºå‰∏çÂèØËøùÂèç„ÄÇ';
  }
  return '';
}

// Ëé∑ÂèñÁÆÄÁπÅËΩ¨Êç¢ÁöÑÂâçÁΩÆÊèêÁ§∫ÔºàÊîæÂú® System Prompt ÂºÄÂ§¥Ôºâ
function getChineseConvertPrefixPrompt(){
  let mode = settings.chineseConvert || 'follow';
  
  // Â¶ÇÊûúÊòØË∑üÈöèÁïåÈù¢ËØ≠Ë®Ä
  if(mode === 'follow'){
    mode = settings.uiLanguage === 'sc' ? 't2s' : 's2t';
  }
  
  if(mode === 's2t'){
    return '„ÄêË™ûË®ÄË®≠ÂÆöÔºöÁπÅÈ´î‰∏≠Êñá„Äë\n';
  } else if(mode === 't2s'){
    return '„ÄêËØ≠Ë®ÄËÆæÂÆöÔºöÁÆÄ‰Ωì‰∏≠Êñá„Äë\n';
  }
  return '';
}

// v25: Áç≤ÂèñËßíËâ≤ÁöÑÂæåÊ≠∑Âè≤Êåá‰ª§
async function getPostHistoryInstructions(){
  if(!story) return '';
  
  const chars = await db.characters.where('storyId').equals(story.id).toArray();
  const instructions = chars
    .filter(c => c.post_history_instructions)
    .map(c => c.post_history_instructions);
  
  if(instructions.length === 0) return '';
  
  return instructions.join('\n');
}

async function callAI(content){
  // È©óË≠â content ÂèÉÊï∏
  if(!content || typeof content !== 'string'){
    throw new Error('Ë´ãÊèê‰æõÊúâÊïàÁöÑÊ∂àÊÅØÂÖßÂÆπ');
  }
  if(!content.trim()){
    throw new Error('Ê∂àÊÅØÂÖßÂÆπ‰∏çËÉΩÁÇ∫Á©∫');
  }

  const preset=await db.apiPresets.filter(p=>p.isActive).first();
  if(!preset){throw new Error('Ë´ãÂÖàÈÖçÁΩÆ‰∏¶ÈÅ∏Êìá‰∏ÄÂÄã API È†êË®≠');}
  if(!preset.apiKey){throw new Error('API Key Êú™Ë®≠ÁΩÆ');}
  if(!preset.model){throw new Error('Ê®°ÂûãÊú™Ë®≠ÁΩÆ');}
  console.log('Using API preset:', preset.name, preset.type, preset.model);

  // ÊßãÂª∫Âü∫Á§éÁ≥ªÁµ±ÊèêÁ§∫Ôºàv27: ‰º†ÂÖ•Áî®Êà∑ËæìÂÖ•‰ª•ÂêØÁî®Êô∫ËÉΩËßíËâ≤ÈÄâÊã©Ôºâ
  let sysPrompt=await buildSysPrompt(content);

  // Lorebook Ëß∏ÁôºÁ≥ªÁµ±
  const triggeredLorebook = await getTriggeredLorebook(content);
  if(triggeredLorebook.length > 0){
    sysPrompt += '\n\n### Áõ∏ÈóúË®≠ÂÆöÔºàËá™ÂãïËß∏ÁôºÔºâ\n';

    // Êî∂ÈõÜÊâÄÊúâÈúÄË¶ÅÊõ¥Êñ∞ÁöÑÊï∞ÊçÆÂ∫ìÊìç‰ΩúÔºàÂπ∂Ë°åÊâßË°åÔºâ
    const updatePromises = [];

    for(const entry of triggeredLorebook){
      if(entry.name && entry.content){
        sysPrompt += `\n#### ${entry.name}\n${entry.content}\n`;
      }

      // Êõ¥Êñ∞Ëß∏ÁôºË®àÊï∏
      updatePromises.push(
        db.lorebook.update(entry.id, {
          triggerCount: (entry.triggerCount || 0) + 1,
          lastTriggered: Date.now()
        })
      );

      // ‰∏ÄÊ¨°ÊÄßËß∏ÁôºÂæåÁ¶ÅÁî®
      if(entry.oneTime){
        updatePromises.push(
          db.lorebook.update(entry.id, {isEnabled: false})
        );
      }
    }

    // Âπ∂Ë°åÊâßË°åÊâÄÊúâÊï∞ÊçÆÂ∫ìÊõ¥Êñ∞
    await Promise.all(updatePromises).catch(err => {
      console.error('[Lorebook] ÊâπÈáèÊõ¥Êñ∞Â§±Êïó:', err);
    });

    // È°ØÁ§∫Ëß∏ÁôºÊèêÁ§∫
    showLorebookTriggerToast(triggeredLorebook);
  }
  
  const contextCount = settings.contextCount || 20;

  // ‰ΩøÁî®Êô∫ËÉΩ‰∏ä‰∏ãÊñáÈÅ∏Êìá
  const selectedMessages = selectSmartContext(msgs, contextCount, content);
  const messages = selectedMessages.map(m=>({role:m.role,content:m.content}));

  if(!messages.length||messages[messages.length-1].content!==content)messages.push({role:'user',content});
  
  // v25: Ê≥®ÂÖ•ÂæåÊ≠∑Âè≤Êåá‰ª§ (post_history_instructions)
  const postHistoryInstructions = await getPostHistoryInstructions();
  if(postHistoryInstructions){
    messages.push({
      role: 'user',
      content: `[Á≥ªÁµ±Êåá‰ª§Ôºö${postHistoryInstructions}]`
    });
  }
  
  if(preset.type==='anthropic')return await callAnthropic(preset,sysPrompt,messages);
  else if(preset.type==='openai')return await callOpenAI(preset,sysPrompt,messages);
  else return await callCustom(preset,sysPrompt,messages);
}
// Âà•Âêç
async function callApi(content){ return await callAI(content); }
async function callAnthropic(p,sys,msgs){
  const aiParams = getAIParams();
  console.log('Calling Anthropic API with model:', p.model, 'temp:', aiParams.temperature, '(story custom:', story?.aiParams?.useCustom || false, ')');
  let r;
  try {
    r = await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      mode: 'cors',
      credentials: 'omit',
      cache: 'no-cache',
      headers:{
        'Content-Type':'application/json',
        'x-api-key':p.apiKey,
        'anthropic-version':'2023-06-01',
        'anthropic-dangerous-direct-browser-access':'true'
      },
      body:JSON.stringify({
        model:p.model,
        max_tokens:settings.maxTokens||4096,
        system:[{type:"text",text:sys}],
        messages:msgs,
        temperature: aiParams.temperature,
        top_p: aiParams.topP
      })
    });
  } catch(e) {
    console.error('Fetch error:', e);
    const errMsg = e.message || e.toString() || '';
    if(errMsg.includes('Load failed') || errMsg.includes('Failed to fetch')) {
      throw new Error('Á∂≤Áµ°ÈåØË™§ - Ë´ãÊ™¢Êü•Á∂≤Áµ°ÈÄ£Êé•Êàñ API ÊúçÂãôÁãÄÊÖã');
    }
    throw new Error('Á∂≤Áµ°Ë´ãÊ±ÇÂ§±Êïó: ' + errMsg);
  }
  
  const text = await r.text();
  console.log('API Response status:', r.status, 'body:', text.slice(0, 500));
  
  if(!r.ok){
    try {
      const e = JSON.parse(text);
      const errMsg = e.error?.message || '';
      // Ë©≥Á¥∞ÁöÑÈåØË™§ÂàÜÈ°û
      if(r.status === 401 || errMsg.includes('invalid_api_key') || errMsg.includes('authentication')){
        throw new Error('API Key ÁÑ°ÊïàÊàñÂ∑≤ÈÅéÊúüÔºåË´ãÊ™¢Êü•Ë®≠ÁΩÆ');
      } else if(r.status === 429 || errMsg.includes('rate_limit')){
        throw new Error('API Ë™øÁî®È†ªÁéáÈÅéÈ´òÔºåË´ãÁ®çÂæåÂÜçË©¶');
      } else if(r.status === 400 || errMsg.includes('invalid_request')){
        throw new Error('Ë´ãÊ±ÇÊ†ºÂºèÈåØË™§: ' + errMsg);
      } else if(r.status === 500 || r.status === 502 || r.status === 503){
        throw new Error('API ÊúçÂãôÊö´ÊôÇ‰∏çÂèØÁî®ÔºåË´ãÁ®çÂæåÂÜçË©¶');
      }
      throw new Error(errMsg || `APIÈåØË™§ (${r.status})`);
    } catch(parseErr) {
      if(parseErr.message.includes('API') || parseErr.message.includes('ÁÑ°Êïà') || parseErr.message.includes('ÈÅéÊúü') || parseErr.message.includes('È†ªÁéá')) throw parseErr;
      throw new Error(`APIÈåØË™§ (${r.status}): ${text.slice(0, 200)}`);
    }
  }
  
  try {
    const d = JSON.parse(text);
    if(!d.content || !d.content[0]){throw new Error('APIËøîÂõûÊ†ºÂºèÈåØË™§');}
    return {content: d.content[0].text, tokens: d.usage?.output_tokens || 0};
  } catch(parseErr) {
    if(parseErr.message.includes('API')) throw parseErr;
    console.error('JSON parse error:', parseErr, 'Response:', text);
    throw new Error('JSONËß£ÊûêÂ§±ÊïóÔºåAPIËøîÂõû: ' + text.slice(0, 100));
  }
}
async function callOpenAI(p,sys,msgs){
  const aiParams = getAIParams();
  console.log('Calling OpenAI API with model:', p.model, 'temp:', aiParams.temperature, '(story custom:', story?.aiParams?.useCustom || false, ')');
  const allMsgs=[{role:'system',content:sys},...msgs];
  let r;
  try {
    r = await fetch('https://api.openai.com/v1/chat/completions',{
      method:'POST',
      mode: 'cors',
      credentials: 'omit',
      cache: 'no-cache',
      headers:{
        'Content-Type':'application/json',
        'Authorization':`Bearer ${p.apiKey}`
      },
      body:JSON.stringify({
        model:p.model,
        messages:allMsgs,
        max_tokens:settings.maxTokens||4096,
        temperature: aiParams.temperature,
        top_p: aiParams.topP
      })
    });
  } catch(e) {
    console.error('Fetch error:', e);
    const errMsg = e.message || e.toString() || '';
    if(errMsg.includes('Load failed') || errMsg.includes('Failed to fetch')) {
      throw new Error('Á∂≤Áµ°ÈåØË™§ - Ë´ãÊ™¢Êü•Á∂≤Áµ°ÈÄ£Êé•Êàñ API ÊúçÂãôÁãÄÊÖã');
    }
    throw new Error('Á∂≤Áµ°Ë´ãÊ±ÇÂ§±Êïó: ' + errMsg);
  }
  
  const text = await r.text();
  console.log('API Response status:', r.status, 'body:', text.slice(0, 500));
  
  if(!r.ok){
    try {
      const e = JSON.parse(text);
      const errMsg = e.error?.message || '';
      // Ë©≥Á¥∞ÁöÑÈåØË™§ÂàÜÈ°û
      if(r.status === 401 || errMsg.includes('invalid_api_key') || errMsg.includes('Incorrect API')){
        throw new Error('API Key ÁÑ°ÊïàÊàñÂ∑≤ÈÅéÊúüÔºåË´ãÊ™¢Êü•Ë®≠ÁΩÆ');
      } else if(r.status === 429 || errMsg.includes('rate_limit') || errMsg.includes('quota')){
        throw new Error('API ÈÖçÈ°çÂ∑≤Áî®ÂÆåÊàñË™øÁî®È†ªÁéáÈÅéÈ´ò');
      } else if(r.status === 400){
        throw new Error('Ë´ãÊ±ÇÊ†ºÂºèÈåØË™§: ' + errMsg);
      } else if(r.status === 500 || r.status === 502 || r.status === 503){
        throw new Error('API ÊúçÂãôÊö´ÊôÇ‰∏çÂèØÁî®ÔºåË´ãÁ®çÂæåÂÜçË©¶');
      }
      throw new Error(errMsg || `APIÈåØË™§ (${r.status})`);
    } catch(parseErr) {
      if(parseErr.message.includes('API') || parseErr.message.includes('ÁÑ°Êïà') || parseErr.message.includes('ÈÖçÈ°ç')) throw parseErr;
      throw new Error(`APIÈåØË™§ (${r.status}): ${text.slice(0, 200)}`);
    }
  }
  
  try {
    const d = JSON.parse(text);
    if(!d.choices || !d.choices[0]){throw new Error('APIËøîÂõûÊ†ºÂºèÈåØË™§');}
    return {content: d.choices[0].message.content, tokens: d.usage?.completion_tokens || 0};
  } catch(parseErr) {
    if(parseErr.message.includes('API')) throw parseErr;
    console.error('JSON parse error:', parseErr, 'Response:', text);
    throw new Error('JSONËß£ÊûêÂ§±ÊïóÔºåAPIËøîÂõû: ' + text.slice(0, 100));
  }
}
// Ëá™ÂãïË£úÂÖ® API URL Ë∑ØÂæë
function normalizeApiUrl(url, autoComplete = true, model = '') {
  if(!url) return url;
  url = url.trim();
  // Ëá™ÂãïÊ∑ªÂä† https:// ÂçîË≠∞
  if(!url.startsWith('http://') && !url.startsWith('https://')) {
    url = 'https://' + url;
  }
  // ÁßªÈô§Â∞æÈÉ®ÊñúÁ∑ö
  url = url.replace(/\/+$/, '');

  // Â¶ÇÊûú‰∏çËá™ÂãïË£úÂÖ®ÔºåÁõ¥Êé•ËøîÂõû
  if(!autoComplete) return url;

  // Â¶ÇÊûúÂ∑≤Á∂ìÂåÖÂê´ÂÆåÊï¥Ë∑ØÂæëÔºåÁõ¥Êé•ËøîÂõû
  if(url.includes('/v1/chat/completions') || url.includes('/v1/messages')) {
    return url;
  }

  // Êô∫ËÉΩÂà§Êñ∑ÔºöÂ¶ÇÊûú model ÂåÖÂê´ claudeÔºå‰ΩøÁî® Anthropic Ê†ºÂºè
  const isClaudeModel = model && (model.toLowerCase().includes('claude') || model.toLowerCase().includes('sonnet') || model.toLowerCase().includes('opus') || model.toLowerCase().includes('haiku'));

  // Â¶ÇÊûúÂè™ÊòØÂü∫Á§é URLÔºåÊ†πÊìöÊ®°ÂûãÈ°ûÂûãËá™ÂãïË£úÂÖ®Ë∑ØÂæë
  if(url.endsWith('/v1')) {
    return isClaudeModel ? url + '/messages' : url + '/chat/completions';
  }
  // Âê¶ÂâáË£úÂÖ®ÂÆåÊï¥Ë∑ØÂæë
  return isClaudeModel ? url + '/v1/messages' : url + '/v1/chat/completions';
}

async function callCustom(p,sys,msgs){
  const autoComplete = p.urlAutoComplete !== false; // ÈªòË™çÁÇ∫ true
  const apiUrl = normalizeApiUrl(p.url || p.baseUrl, autoComplete, p.model);
  const aiParams = getAIParams();
  console.log('Calling Custom API:', p.url || p.baseUrl, '‚Üí', apiUrl, '(autoComplete:', autoComplete, ') model:', p.model, 'temp:', aiParams.temperature, '(story custom:', story?.aiParams?.useCustom || false, ')');
  if(!apiUrl){throw new Error('Ëá™ÂÆöÁæ© API URL Êú™Ë®≠ÁΩÆ');}

  // Êô∫ËÉΩÂà§Êñ∑Ê†ºÂºèÔºöÂ¶ÇÊûú URL ÂåÖÂê´ /messagesÔºå‰ΩøÁî® Anthropic Ê†ºÂºèÔºåÂê¶Ââá‰ΩøÁî® OpenAI Ê†ºÂºè
  const isAnthropicFormat = apiUrl.includes('/messages') || apiUrl.includes('/anthropic');

  let requestBody;
  let headers = {
    'Content-Type':'application/json',
    'Authorization':`Bearer ${p.apiKey}`
  };

  if(isAnthropicFormat){
    // Anthropic Ê†ºÂºèÔºösystem ‰ΩúÁÇ∫ÂñÆÁç®ÂèÉÊï∏
    console.log('Using Anthropic format for custom API');
    headers['anthropic-version'] = '2023-06-01';
    requestBody = {
      model: p.model,
      system: [{type:"text",text:sys}],
      messages: msgs,
      max_tokens: settings.maxTokens || 4096,
      temperature: aiParams.temperature,
      top_p: aiParams.topP
    };
  } else {
    // OpenAI Ê†ºÂºèÔºösystem ÊîæÂú® messages Êï∏ÁµÑÁöÑÁ¨¨‰∏ÄÂÄã
    console.log('Using OpenAI format for custom API');
    const allMsgs = [];
    if(sys) {
      allMsgs.push({role: 'system', content: sys});
    }
    allMsgs.push(...msgs);
    requestBody = {
      model: p.model,
      messages: allMsgs,
      max_tokens: settings.maxTokens || 4096,
      temperature: aiParams.temperature,
      top_p: aiParams.topP
    };
  }

  // ÂâµÂª∫Ë∂ÖÊôÇÊéßÂà∂Ôºà120ÁßíÔºâ
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 120000);

  let r;
  try {
    r = await fetch(apiUrl,{
      method:'POST',
      signal: controller.signal,
      mode: 'cors',
      credentials: 'omit',
      cache: 'no-cache',
      headers: headers,
      body:JSON.stringify(requestBody)
    });
  } catch(e) {
    console.error('Fetch error:', e);
    const errMsg = e.message || e.toString() || '';
    if(e.name === 'AbortError') {
      throw new Error('Ë´ãÊ±ÇË∂ÖÊôÇÔºà120ÁßíÔºâ- Ë´ãÊ™¢Êü•Á∂≤Áµ°ÈÄ£Êé•');
    } else if(errMsg.includes('Load failed') || errMsg.includes('Failed to fetch') || errMsg.includes('NetworkError')) {
      throw new Error('Á∂≤Áµ°ÈåØË™§ - API ÊúçÂãôÂèØËÉΩ‰∏çÊîØÊåÅÁÄèË¶ΩÂô®Áõ¥Êé•Ë™øÁî®ÔºàCORSÔºâÔºåË´ãÁ¢∫Ë™ç API Â∑≤ÈñãÂïüË∑®ÂüüÊîØÊåÅ');
    }
    throw new Error('Á∂≤Áµ°Ë´ãÊ±ÇÂ§±Êïó: ' + errMsg);
  } finally {
    clearTimeout(timeoutId);
  }
  
  const text = await r.text();
  console.log('API Response status:', r.status, 'body:', text.slice(0, 500));
  
  if(!r.ok){
    try {
      const e = JSON.parse(text);
      throw new Error(e.error?.message || `APIÈåØË™§ (${r.status})`);
    } catch(parseErr) {
      if(parseErr.message.includes('APIÈåØË™§')) throw parseErr;
      throw new Error(`APIÈåØË™§ (${r.status}): ${text.slice(0, 200)}`);
    }
  }
  
  try {
    const d = JSON.parse(text);
    let content, tokens;

    // ÂòóË©¶Ëß£Êûê‰∏çÂêåÊ†ºÂºèÁöÑËøîÂõûÂÄº
    if(isAnthropicFormat){
      // Anthropic Ê†ºÂºèÔºöd.content[0].text
      content = d.content?.[0]?.text || d.choices?.[0]?.message?.content || d.response || d.text || '';
      tokens = d.usage?.output_tokens || d.usage?.completion_tokens || 0;
    } else {
      // OpenAI Ê†ºÂºèÔºöd.choices[0].message.content
      content = d.choices?.[0]?.message?.content || d.content?.[0]?.text || d.response || d.text || '';
      tokens = d.usage?.completion_tokens || d.usage?.output_tokens || 0;
    }

    if(!content){throw new Error('APIËøîÂõûÂÖßÂÆπÁÇ∫Á©∫');}
    return {content, tokens};
  } catch(parseErr) {
    console.error('JSON parse error:', parseErr, 'Response:', text);
    throw new Error('JSONËß£ÊûêÂ§±ÊïóÔºåAPIËøîÂõû: ' + text.slice(0, 100));
  }
}

// ============================================
// ÊµÅÂºèÈüøÊáâ API Ë™øÁî®
// ============================================
let streamAbortController = null;

async function callAnthropicStream(p, sys, msgs, onChunk, onDone, onError) {
  const aiParams = getAIParams();
  console.log('Calling Anthropic API (STREAM) with model:', p.model, 'temp:', aiParams.temperature);

  streamAbortController = new AbortController();
  let r;

  try {
    r = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      mode: 'cors',
      credentials: 'omit',
      cache: 'no-cache',
      signal: streamAbortController.signal,
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': p.apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: p.model,
        max_tokens: settings.maxTokens || 4096,
        system: sys,
        messages: msgs,
        temperature: aiParams.temperature,
        top_p: aiParams.topP,
        stream: true
      })
    });
  } catch(e) {
    console.error('Fetch error:', e);
    if(e.name === 'AbortError') {
      throw new Error('Â∑≤ÂÅúÊ≠¢ÁîüÊàê');
    }
    const errMsg = e.message || e.toString() || '';
    if(errMsg.includes('Load failed') || errMsg.includes('Failed to fetch')) {
      throw new Error('Á∂≤Áµ°ÈåØË™§ - Ë´ãÊ™¢Êü•Á∂≤Áµ°ÈÄ£Êé•Êàñ API ÊúçÂãôÁãÄÊÖã');
    }
    throw new Error('Á∂≤Áµ°Ë´ãÊ±ÇÂ§±Êïó: ' + errMsg);
  }

  if(!r.ok) {
    const text = await r.text();
    console.error('API Response error:', r.status, text);
    try {
      const e = JSON.parse(text);
      const errMsg = e.error?.message || '';
      if(r.status === 401 || errMsg.includes('invalid_api_key')) {
        throw new Error('API Key ÁÑ°ÊïàÊàñÂ∑≤ÈÅéÊúüÔºåË´ãÊ™¢Êü•Ë®≠ÁΩÆ');
      } else if(r.status === 429) {
        throw new Error('API Ë™øÁî®È†ªÁéáÈÅéÈ´òÔºåË´ãÁ®çÂæåÂÜçË©¶');
      }
      throw new Error(errMsg || `APIÈåØË™§ (${r.status})`);
    } catch(parseErr) {
      if(parseErr.message.includes('API')) throw parseErr;
      throw new Error(`APIÈåØË™§ (${r.status}): ${text.slice(0, 200)}`);
    }
  }

  const reader = r.body.getReader();
  const decoder = new TextDecoder();
  let fullContent = '';

  try {
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      const chunk = decoder.decode(value);
      const lines = chunk.split('\n');

      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const data = line.slice(6);
          if (data === '[DONE]') continue;

          try {
            const parsed = JSON.parse(data);
            if (parsed.type === 'content_block_delta') {
              const text = parsed.delta?.text || '';
              if (text) {
                fullContent += text;
                if (onChunk) await onChunk(text, fullContent);
              }
            } else if (parsed.type === 'error') {
              throw new Error(parsed.error?.message || 'Stream error');
            }
          } catch (e) {
            if (e.message.includes('Stream error')) throw e;
            // ÂøΩÁï• JSON Ëß£ÊûêÈåØË™§ÔºåÁπºÁ∫åËôïÁêÜ‰∏ã‰∏ÄË°å
          }
        }
      }
    }
  } catch (e) {
    if (e.name === 'AbortError' || e.message === 'Â∑≤ÂÅúÊ≠¢ÁîüÊàê') {
      if (onError) onError(e, fullContent);
      return { content: fullContent, stopped: true };
    }
    if (onError) onError(e, fullContent);
    throw e;
  }

  if (onDone) onDone(fullContent);
  return { content: fullContent, tokens: 0 };
}

async function callOpenAIStream(p, sys, msgs, onChunk, onDone, onError) {
  const aiParams = getAIParams();
  console.log('Calling OpenAI API (STREAM) with model:', p.model, 'temp:', aiParams.temperature);

  const allMsgs = [{ role: 'system', content: sys }, ...msgs];
  streamAbortController = new AbortController();
  let r;

  try {
    r = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      mode: 'cors',
      credentials: 'omit',
      cache: 'no-cache',
      signal: streamAbortController.signal,
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${p.apiKey}`
      },
      body: JSON.stringify({
        model: p.model,
        messages: allMsgs,
        max_tokens: settings.maxTokens || 4096,
        temperature: aiParams.temperature,
        top_p: aiParams.topP,
        stream: true
      })
    });
  } catch(e) {
    console.error('Fetch error:', e);
    if(e.name === 'AbortError') {
      throw new Error('Â∑≤ÂÅúÊ≠¢ÁîüÊàê');
    }
    const errMsg = e.message || e.toString() || '';
    if(errMsg.includes('Load failed') || errMsg.includes('Failed to fetch')) {
      throw new Error('Á∂≤Áµ°ÈåØË™§ - Ë´ãÊ™¢Êü•Á∂≤Áµ°ÈÄ£Êé•Êàñ API ÊúçÂãôÁãÄÊÖã');
    }
    throw new Error('Á∂≤Áµ°Ë´ãÊ±ÇÂ§±Êïó: ' + errMsg);
  }

  if(!r.ok) {
    const text = await r.text();
    console.error('API Response error:', r.status, text);
    try {
      const e = JSON.parse(text);
      const errMsg = e.error?.message || '';
      if(r.status === 401) {
        throw new Error('API Key ÁÑ°ÊïàÊàñÂ∑≤ÈÅéÊúüÔºåË´ãÊ™¢Êü•Ë®≠ÁΩÆ');
      } else if(r.status === 429) {
        throw new Error('API ÈÖçÈ°çÂ∑≤Áî®ÂÆåÊàñË™øÁî®È†ªÁéáÈÅéÈ´ò');
      }
      throw new Error(errMsg || `APIÈåØË™§ (${r.status})`);
    } catch(parseErr) {
      if(parseErr.message.includes('API')) throw parseErr;
      throw new Error(`APIÈåØË™§ (${r.status}): ${text.slice(0, 200)}`);
    }
  }

  const reader = r.body.getReader();
  const decoder = new TextDecoder();
  let fullContent = '';

  try {
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      const chunk = decoder.decode(value);
      const lines = chunk.split('\n');

      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const data = line.slice(6);
          if (data === '[DONE]') continue;

          try {
            const parsed = JSON.parse(data);
            const text = parsed.choices?.[0]?.delta?.content || '';
            if (text) {
              fullContent += text;
              if (onChunk) await onChunk(text, fullContent);
            }
          } catch (e) {
            // ÂøΩÁï• JSON Ëß£ÊûêÈåØË™§
          }
        }
      }
    }
  } catch (e) {
    if (e.name === 'AbortError' || e.message === 'Â∑≤ÂÅúÊ≠¢ÁîüÊàê') {
      if (onError) onError(e, fullContent);
      return { content: fullContent, stopped: true };
    }
    if (onError) onError(e, fullContent);
    throw e;
  }

  if (onDone) onDone(fullContent);
  return { content: fullContent, tokens: 0 };
}

async function callCustomStream(p, sys, msgs, onChunk, onDone, onError) {
  const autoComplete = p.urlAutoComplete !== false;
  const apiUrl = normalizeApiUrl(p.url || p.baseUrl, autoComplete, p.model);
  const aiParams = getAIParams();
  console.log('Calling Custom API (STREAM):', apiUrl, 'model:', p.model);

  // Êô∫ËÉΩÂà§Êñ∑Ê†ºÂºèÔºöÂ¶ÇÊûú URL ÂåÖÂê´ /messagesÔºå‰ΩøÁî® Anthropic Ê†ºÂºèÔºåÂê¶Ââá‰ΩøÁî® OpenAI Ê†ºÂºè
  const isAnthropicFormat = apiUrl.includes('/messages') || apiUrl.includes('/anthropic');

  let requestBody;
  let headers = {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${p.apiKey}`
  };

  if(isAnthropicFormat){
    // Anthropic Ê†ºÂºèÔºösystem ‰ΩúÁÇ∫ÂñÆÁç®ÂèÉÊï∏
    console.log('Using Anthropic format for custom API (STREAM)');
    headers['anthropic-version'] = '2023-06-01';
    requestBody = {
      model: p.model,
      system: sys,
      messages: msgs,
      max_tokens: settings.maxTokens || 4096,
      temperature: aiParams.temperature,
      stream: true
    };
  } else {
    // OpenAI Ê†ºÂºèÔºösystem ÊîæÂú® messages Êï∏ÁµÑÁöÑÁ¨¨‰∏ÄÂÄã
    console.log('Using OpenAI format for custom API (STREAM)');
    const allMsgs = [];
    if(sys) allMsgs.push({role: 'system', content: sys});
    allMsgs.push(...msgs);
    requestBody = {
      model: p.model,
      messages: allMsgs,
      max_tokens: settings.maxTokens || 4096,
      temperature: aiParams.temperature,
      stream: true
    };
  }

  streamAbortController = new AbortController();
  const timeoutId = setTimeout(() => streamAbortController.abort(), 120000);
  let r;

  try {
    r = await fetch(apiUrl, {
      method: 'POST',
      signal: streamAbortController.signal,
      mode: 'cors',
      credentials: 'omit',
      cache: 'no-cache',
      headers: headers,
      body: JSON.stringify(requestBody)
    });
  } catch(e) {
    console.error('Fetch error:', e);
    if(e.name === 'AbortError') {
      throw new Error('Â∑≤ÂÅúÊ≠¢ÁîüÊàê');
    }
    const errMsg = e.message || e.toString() || '';
    if(errMsg.includes('Load failed') || errMsg.includes('Failed to fetch')) {
      throw new Error('Á∂≤Áµ°ÈåØË™§ - API ÊúçÂãôÂèØËÉΩ‰∏çÊîØÊåÅÁÄèË¶ΩÂô®Áõ¥Êé•Ë™øÁî®ÔºàCORSÔºâ');
    }
    throw new Error('Á∂≤Áµ°Ë´ãÊ±ÇÂ§±Êïó: ' + errMsg);
  } finally {
    clearTimeout(timeoutId);
  }

  if(!r.ok) {
    const text = await r.text();
    console.error('API Response error:', r.status, text);
    try {
      const e = JSON.parse(text);
      throw new Error(e.error?.message || `APIÈåØË™§ (${r.status})`);
    } catch(parseErr) {
      if(parseErr.message.includes('APIÈåØË™§')) throw parseErr;
      throw new Error(`APIÈåØË™§ (${r.status}): ${text.slice(0, 200)}`);
    }
  }

  const reader = r.body.getReader();
  const decoder = new TextDecoder();
  let fullContent = '';

  try {
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      const chunk = decoder.decode(value);
      const lines = chunk.split('\n');

      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const data = line.slice(6);
          if (data === '[DONE]') continue;

          try {
            const parsed = JSON.parse(data);
            let text = '';

            if(isAnthropicFormat){
              // Anthropic Ê†ºÂºèÔºöparsed.delta?.text
              text = parsed.delta?.text || '';
            } else {
              // OpenAI Ê†ºÂºèÔºöparsed.choices[0].delta.content
              text = parsed.choices?.[0]?.delta?.content || '';
            }

            if (text) {
              fullContent += text;
              if (onChunk) await onChunk(text, fullContent);
            }
          } catch (e) {
            // ÂøΩÁï• JSON Ëß£ÊûêÈåØË™§
          }
        }
      }
    }
  } catch (e) {
    if (e.name === 'AbortError' || e.message === 'Â∑≤ÂÅúÊ≠¢ÁîüÊàê') {
      if (onError) onError(e, fullContent);
      return { content: fullContent, stopped: true };
    }
    if (onError) onError(e, fullContent);
    throw e;
  }

  if (onDone) onDone(fullContent);
  return { content: fullContent, tokens: 0 };
}

function stopStreaming() {
  if (streamAbortController) {
    streamAbortController.abort();
    streamAbortController = null;
  }
}

// ============ Êô∫ËÉΩËßíËâ≤ÈÅ∏Êìá ============
/**
 * Êô∫ËÉΩÈÅ∏ÊìáÊáâË©≤ÁôºÈÄÅÁµ¶ AI ÁöÑËßíËâ≤
 * Âè™ÈÅ∏ÊìáÊúÄËøëÂá∫Â†¥ÁöÑËßíËâ≤ÔºåÈÅøÂÖçÊØèÊ¨°ÈÉΩÁôºÈÄÅÊâÄÊúâËßíËâ≤Ê∂àËÄó tokens
 * @param {Array} allCharacters - ÊâÄÊúâËßíËâ≤ÂàóË°®
 * @param {string} userInput - Áî®Êà∑ËæìÂÖ•ÂÜÖÂÆπÔºàÂèØÈÄâÔºâ
 * @returns {Array} ÈÅ∏‰∏≠ÁöÑËßíËâ≤ÂàóË°®
 */
async function selectRelevantCharacters(allCharacters, userInput = '') {
  // Â¶ÇÊûúÁ¶ÅÁî®Êô∫ËÉΩÈÅ∏ÊìáÔºåËøîÂõûÊâÄÊúâËßíËâ≤
  if (!settings.smartCharacterSelection) {
    return allCharacters;
  }

  const relevantChars = new Set();
  const recentMessageCount = settings.characterRecentMessages || 20;

  // 1. Êü•ÊâæÊúÄËøëNÊ¢ùÊ∂àÊÅØ‰∏≠ÊèêÂà∞ÁöÑËßíËâ≤Âêç
  const recentMessages = msgs.slice(-recentMessageCount);

  for (const msg of recentMessages) {
    const content = msg.content || '';
    // Ê£ÄÊü•ÊØè‰∏™ËßíËâ≤ÂêçÊòØÂê¶Âú®Ê∂àÊÅØ‰∏≠Âá∫Áé∞
    allCharacters.forEach(char => {
      if (content.includes(char.name)) {
        relevantChars.add(char.id);
      }
    });
  }

  // 2. Ê£ÄÊü•Áî®Êà∑ÂΩìÂâçËæìÂÖ•‰∏≠ÊòØÂê¶ÊèêÂà∞Êüê‰∏™ËßíËâ≤
  if (userInput) {
    allCharacters.forEach(char => {
      if (userInput.includes(char.name)) {
        relevantChars.add(char.id);
      }
    });
  }

  // 3. ÊÄªÊòØÂåÖÂê´‰∏ªË¶ÅËßíËâ≤ÔºàÊúâÁâπÊÆäÊ†áËÆ∞ÁöÑËßíËâ≤ÔºåÂ¶Ç: isMainCharacter, isPinned, Êàñ category='main'Ôºâ
  if (settings.alwaysIncludeMainCharacters) {
    allCharacters.forEach(char => {
      if (char.isMainCharacter || char.isPinned || char.category === 'main' || char.category === '‰∏ªË¶Å') {
        relevantChars.add(char.id);
      }
    });
  }

  // 4. Â¶ÇÊûúÁ≠õÈÄâÁªìÊûú‰∏∫Á©∫ÔºàÊØîÂ¶ÇÂàöÂºÄÂßãÂØπËØùÔºâÔºåËøîÂõûÊâÄÊúâËßíËâ≤
  if (relevantChars.size === 0) {
    console.log('Êô∫ËÉΩËßíËâ≤ÈÄâÊã©ÔºöÊú™ÊâæÂà∞Áõ∏ÂÖ≥ËßíËâ≤ÔºåËøîÂõûÊâÄÊúâËßíËâ≤');
    return allCharacters;
  }

  // 5. ËøîÂõûÈÄâ‰∏≠ÁöÑËßíËâ≤
  const selectedChars = allCharacters.filter(char => relevantChars.has(char.id));

  console.log(`Êô∫ËÉΩËßíËâ≤ÈÄâÊã©Ôºö‰ªé ${allCharacters.length} ‰∏™ËßíËâ≤‰∏≠ÈÄâÊã©‰∫Ü ${selectedChars.length} ‰∏™Áõ∏ÂÖ≥ËßíËâ≤`);
  console.log('ÈÄâ‰∏≠ÁöÑËßíËâ≤:', selectedChars.map(c => c.name).join(', '));

  return selectedChars;
}

async function buildSysPrompt(userInput = ''){
  if(!story)return'';
  let p='';

  // v22: Á∞°ÁπÅËΩâÊèõÂâçÁΩÆÊèêÁ§∫
  p += getChineseConvertPrefixPrompt();

  const bindings=await db.storyInstructions.where('storyId').equals(story.id).toArray();
  for(const b of bindings){
    const i=await db.instructions.get(b.instructionId);
    if(i && i.content){
      p+=i.content+'\n\n';
    }
  }
  
  // v18: Ê∑ªÂä†Ë®òÊÜ∂ÊëòË¶ÅÔºà‰øÆÂæ©Ôºö‰πãÂâçÊëòË¶ÅÊ≤íÊúâË¢´‰ΩøÁî®Ôºâ
  if(story.summaries && story.summaries.length > 0){
    p+='\n### üìö ÊïÖ‰∫ãÂâçÊÉÖÊëòË¶Å\n';
    p+='‰ª•‰∏ãÊòØ‰πãÂâçÂäáÊÉÖÁöÑÈáçË¶ÅÊëòË¶ÅÔºåË´ãÂèÉËÄÉÈÄô‰∫õ‰ø°ÊÅØ‰øùÊåÅÊïÖ‰∫ãÈÄ£Ë≤´ÊÄßÔºö\n\n';
    // ÊåâÊôÇÈñìÈ†ÜÂ∫èÊ∑ªÂä†ÊëòË¶Å
    story.summaries.forEach((s, idx) => {
      if(s && s.content){
        p+=`**„ÄêË®òÊÜ∂ÁâáÊÆµ ${idx + 1}„Äë**\n${s.content}\n\n`;
      }
    });
    p+='---\n\n';
  }
  
  // v22: Ê∑ªÂä†ÊªæÂãïÊëòË¶Å
  if(story.rollingSummaries && story.rollingSummaries.length > 0){
    p+='\n### üìú ÊïÖ‰∫ãËÉåÊôØÊëòË¶Å\n';
    p+='‰ª•‰∏ãÊòØÊúÄËøëÂäáÊÉÖÁöÑËÉåÊôØÊëòË¶ÅÔºåË´ãÂèÉËÄÉÔºö\n\n';
    story.rollingSummaries.forEach((s, idx) => {
      if(s && s.content){
        p+=`**„ÄêËÉåÊôØ ${idx + 1}„Äë** ${s.content}\n\n`;
      }
    });
    p+='---\n\n';
  }

  // ÈáçË¶ÅË®òÊÜ∂ - ÂÑ™ÂÖàÂ±ïÁ§∫Áî®Êà∂Ê®ôË®òÁöÑÈáçË¶ÅÊ∂àÊÅØ
  const importantMsgs = msgs.filter(m => m.isImportant);
  if(importantMsgs.length > 0){
    p+='\n### ‚≠ê ÈáçË¶ÅË®òÊÜ∂\n';
    p+='‰ª•‰∏ãÊòØÁé©ÂÆ∂Ê®ôË®òÁÇ∫ÈáçË¶ÅÁöÑÂäáÊÉÖÁâáÊÆµÔºåË´ãÁâπÂà•Ê≥®ÊÑèÈÄô‰∫õÂÖßÂÆπÔºö\n\n';
    importantMsgs.forEach((m, idx) => {
      const role = m.role === 'user' ? '„ÄêÁé©ÂÆ∂„Äë' : '„ÄêÂäáÊÉÖ„Äë';
      const content = m.content.slice(0, 300); // ÈôêÂà∂Èï∑Â∫¶
      p+=`**${idx + 1}. ${role}** ${content}${m.content.length > 300 ? '...' : ''}\n\n`;
    });
    p+='---\n\n';
  }

  const lore=await db.loreEntries.where('storyId').equals(story.id).filter(e=>e.isSelected).toArray();
  if(lore.length){
    p+='\n### ÂèÉËÄÉË≥áÊñô\n';
    for(const e of lore){
      if(e.name && e.content){
        p+=`\n#### ${e.name}\n${e.content}\n`;
      }
    }
  }
  if(story.storyTime)p+=`\n### Áï∂ÂâçÊôÇÈñì\n${story.storyTime}\n`;

  // ‰ºèÁ≠Ü‰ø°ÊÅØÔºàÂÑ™ÂåñÁâàÔºâ
  const fs=await db.foreshadowing.where('storyId').equals(story.id).filter(f=>!f.isResolved).toArray();
  if(fs.length){
    p+='\n### üìå ÂæÖÂõûÊî∂‰ºèÁ≠Ü\n';
    p+='‰ª•‰∏ãÊòØÈúÄË¶ÅÊ≥®ÊÑèÂõûÊî∂ÁöÑ‰ºèÁ≠ÜÔºåË´ãÂú®ÂêàÈÅ©ÁöÑÊôÇÊ©üËá™ÁÑ∂Âú∞ÂõûÊî∂ÈÄô‰∫õ‰ºèÁ≠ÜÔºö\n\n';

    // ÊåâÂÑ™ÂÖàÁ¥öÊéíÂ∫è
    const sortedFs=fs.sort((a,b)=>{
      const priorityOrder={urgent:0,high:1,medium:2,low:3};
      const pa=priorityOrder[a.priority||'medium'];
      const pb=priorityOrder[b.priority||'medium'];
      return pa-pb;
    });

    sortedFs.forEach(f=>{
      if(f.title){
        // ÂÑ™ÂÖàÁ¥öÂúñÊ®ô
        const priorityIcon={urgent:'üî¥',high:'üü†',medium:'üü°',low:'üü¢'}[f.priority||'medium'];
        const priorityText={urgent:'Á∑äÊÄ•',high:'È´ò',medium:'‰∏≠',low:'‰Ωé'}[f.priority||'medium'];

        // Á∑äÊÄ•Â∫¶ÊèêÁ§∫
        const urgency=calculateForeshadowUrgency(f);
        const urgencyHint=urgency==='critical'?'‚ö†Ô∏è ÈùûÂ∏∏Á∑äÊÄ•ÔºÅ':urgency==='warning'?'‚ö†Ô∏è ÈúÄË¶ÅÂÑòÂø´ÂõûÊî∂':urgency==='notice'?'üí° Âç≥Â∞áÂà∞Êúü':'';

        p+=`- „Äê${priorityIcon}${priorityText}„Äë${f.title}`;
        if(f.description){
          p+=`Ôºö${f.description}`;
        }
        p+=`ÔºàÂ∑≤ÈÅé${f.mentionCount||0}Ê¢ùÂ∞çË©±Ôºâ`;
        if(urgencyHint){
          p+=` ${urgencyHint}`;
        }
        p+='\n';

        // Ê∑ªÂä†Ê®ôÁ±§
        if(f.tags&&f.tags.length>0){
          p+=`  Ê®ôÁ±§Ôºö${f.tags.join('„ÄÅ')}\n`;
        }

        // Ê∑ªÂä†ÂõûÊî∂Ë®àÂäÉÔºàÂ¶ÇÊûúÊúâÔºâ
        if(f.plan){
          const planPreview=f.plan.slice(0,100);
          p+=`  ÂõûÊî∂ÊèêÁ§∫Ôºö${planPreview}${f.plan.length>100?'...':''}\n`;
        }

        p+='\n';
      }
    });

    p+='üí° ÊèêÁ§∫ÔºöË´ãÊ†πÊìöÁï∂ÂâçÂäáÊÉÖËá™ÁÑ∂Âú∞ÂõûÊî∂ÈÄô‰∫õ‰ºèÁ≠ÜÔºå‰∏çË¶ÅÁîüÁ°¨ÊàñÁ™ÅÂÖÄ„ÄÇ\n';
  }
  // Ê∑ªÂä†‰∏ÄËá¥ÊÄß‰øÆÂæ©ÊèêÁ§∫
  if(story.consistencyNote){
    p+='\n### ‰∏ÄËá¥ÊÄß‰øÆÂæ©ÊèêÁ§∫\n'+story.consistencyNote+'\n';
    // Â¢ûÂä†‰ΩøÁî®Ë®àÊï∏
    const fixCount = (story.consistencyFixCount || 0) + 1;
    const fixMax = story.consistencyFixMax || 1;

    if(fixCount >= fixMax){
      // ÈÅîÂà∞ÊúÄÂ§ßÊ¨°Êï∏ÔºåÊ∏ÖÈô§ÊèêÁ§∫
      await db.stories.update(story.id,{
        consistencyNote:null,
        consistencyFixCount:0,
        consistencyFixMax:null
      });
      story.consistencyNote=null;
      story.consistencyFixCount=0;
      story.consistencyFixMax=null;
    } else {
      // Êõ¥Êñ∞Ë®àÊï∏Âô®
      await db.stories.update(story.id,{consistencyFixCount:fixCount});
      story.consistencyFixCount=fixCount;
    }
    // Êõ¥Êñ∞ÊèêÁ§∫Ê¢ùÈ°ØÁ§∫ÔºàÂª∂ÈÅ≤Âü∑Ë°åÔºåÈÅøÂÖçÈòªÂ°ûÔºâ
    setTimeout(() => updateConsistencyFixBanner(), 100);
  }
  
  // v21: ÈõôËªå‰∏¶Ë°å - Á∂ìÁáüÊ®°Âºè‰πüÊîØÊåÅËßíËâ≤Á≥ªÁµ±
  const isSimMode = story.mode === 'simulation';

  // 1. ËßíËâ≤ÁãÄÊÖã‰ø°ÊÅØÔºàÊâÄÊúâÊ®°ÂºèÈÉΩÁôºÈÄÅÔºâ
  const allChars=await db.characters.where('storyId').equals(story.id).toArray();
  // v27: Êô∫ËÉΩËßíËâ≤ÈÅ∏Êìá - Âè™ÁôºÈÄÅÁõ∏ÈóúËßíËâ≤ÔºåÁØÄÁúÅ tokens
  const chars = await selectRelevantCharacters(allChars, userInput);
  if(chars.length){
    // v25: Ê≥®ÂÖ•ËßíËâ≤Â∞àÂ±¨Á≥ªÁµ±ÊèêÁ§∫Ë©û
    const charSystemPrompts = chars.filter(c => c.system_prompt).map(c => c.system_prompt);
    if(charSystemPrompts.length){
      p+='\n### üé≠ ËßíËâ≤Â∞àÂ±¨Êåá‰ª§\n';
      p+=charSystemPrompts.join('\n\n');
      p+='\n\n';
    }
    
    p+='\n### Áï∂ÂâçËßíËâ≤ÁãÄÊÖã\n';
    p+='‰ª•‰∏ãÊòØÁï∂ÂâçÂ∑≤Áü•ËßíËâ≤ÁöÑÁãÄÊÖãÔºåË´ãÂú®ÂõûË¶Ü‰∏≠‰øùÊåÅËßíËâ≤Ë°åÁÇ∫ËàáÂÖ∂ÊÄßÊ†º„ÄÅÂ±¨ÊÄß‰∏ÄËá¥Ôºö\n\n';
    chars.forEach(c=>{
      p+=`**${c.name}**`;
      if(c.title)p+=`Ôºà${c.title}Ôºâ`;
      p+='\n';
      // v25: Ê∑ªÂä†ÊÄßÊ†ºÊëòË¶Å
      if(c.personality)p+=`- ÊÄßÊ†ºÔºö${c.personality}\n`;
      if(c.description)p+=`- Á∞°‰ªãÔºö${c.description}\n`;
      // v25: Ê∑ªÂä†Â†¥ÊôØÊèèËø∞
      if(c.scenario)p+=`- Â†¥ÊôØÔºö${c.scenario}\n`;
      if(c.stats&&Object.keys(c.stats).length){
        p+=`- Â±¨ÊÄßÔºö${Object.entries(c.stats).map(([k,v])=>`${k}:${v}`).join('„ÄÅ')}\n`;
      }
      if(c.tags&&c.tags.length){
        p+=`- ÁâπÂæµÔºö${c.tags.join('„ÄÅ')}\n`;
      }
      p+='\n';
    });
    
    // v25: Ê≥®ÂÖ•ËßíËâ≤Èóú‰øÇ‰ø°ÊÅØ
    const charsWithRelations = chars.filter(c => c.relationships && c.relationships.length > 0);
    if(charsWithRelations.length){
      p+='\n### üë• ËßíËâ≤Èóú‰øÇ\n';
      charsWithRelations.forEach(c => {
        c.relationships.forEach(rel => {
          p+=`- ${c.name} ‚Üí ${rel.targetName || 'Êüê‰∫∫'}Ôºö${rel.label || rel.type}`;
          if(rel.description) p+=`Ôºà${rel.description}Ôºâ`;
          p+='\n';
        });
      });
      p+='\n';
    }
    
    // v25: Ê≥®ÂÖ•Â∞çË©±Á§∫‰æã
    const charsWithExamples = chars.filter(c => c.mes_example);
    if(charsWithExamples.length){
      p+='\n### üí¨ Â∞çË©±Á§∫‰æã\n';
      p+='‰ª•‰∏ãÊòØËßíËâ≤ÁöÑÂ∞çË©±È¢®Ê†ºÁ§∫‰æãÔºåË´ãÂèÉËÄÉÈÄô‰∫õÁ§∫‰æã‰æÜÊ®°‰ªøËßíËâ≤ÁöÑË™™Ë©±ÊñπÂºèÔºö\n\n';
      charsWithExamples.forEach(c => {
        p+=`**${c.name} ÁöÑÂ∞çË©±È¢®Ê†ºÔºö**\n`;
        p+=c.mes_example.replace(/<START>/g, '\n---\n');
        p+='\n\n';
      });
    }
  }
  
  // v24: ÂÖàÁç≤ÂèñÁé©ÂÆ∂ÁãÄÊÖãÈù¢ÊùøÔºàÈúÄË¶ÅÂú®ÂæåÈù¢‰ΩøÁî®Ôºâ
  const playerPanel = await db.playerPanels.where('storyId').equals(story.id).first();

  // 2. Á∂ìÁáüÊ®°ÂºèÔºöÊ∑ªÂä†Ë≥áÊ∫êÁãÄÊÖãÔºà‰∏çÂº∑Âà∂ JSON Ëº∏Âá∫Ôºâ
  if(isSimMode){
    if(story.simResources && story.simResources.length > 0){
      p+='\n### üìä Áï∂ÂâçË≥áÊ∫êÁãÄÊÖãÔºàÁ¨¨ ' + (story.simDay || 1) + ' Â§©Ôºâ\n';
      story.simResources.forEach(r => {
        p+=`${r.icon} ${r.name}Ôºö${r.value.toLocaleString()}\n`;
      });
      p+='\nË´ãÂú®ÂõûË¶Ü‰∏≠Á∂≠ÊåÅÈÄô‰∫õÊï∏ÊìöÁöÑÂêàÁêÜÊÄßÔºåÂ¶ÇÊúâËÆäÂåñÂèØÂú®ÂõûË¶Ü‰∏≠Ëá™ÁÑ∂Ë™™Êòé„ÄÇ\n';
    }
    // Á∂ìÁáüÊ®°Âºè‰∏çÂº∑Âà∂ JSON Ëº∏Âá∫ÔºåËÆì prompt Ëá™Â∑±ÁöÑÊ†ºÂºèÁîüÊïà
  } else {
    // 3. ÊôÆÈÄöÊ®°ÂºèÔºöË¶ÅÊ±Ç JSON Ê†ºÂºèËº∏Âá∫ËßíËâ≤ÁãÄÊÖã
    const hasPlayerPanel = playerPanel && playerPanel.attributes && playerPanel.attributes.length > 0;
    p+=`\n### ÁãÄÊÖãËº∏Âá∫Ê†ºÂºèÔºàÈáçË¶ÅÔºâ
ÊØèÊ¨°ÂõûË¶ÜÊôÇÔºåË´ãÂú®ÂäáÊÉÖÂÖßÂÆπ‰πãÂæåÔºåÁî®‰ª•‰∏ã JSON Ê†ºÂºèËº∏Âá∫ËßíËâ≤ÁãÄÊÖãÊõ¥Êñ∞Ôºö

\`\`\`json
{
  "characters": [
    {
      "name": "ËßíËâ≤Âêç",
      "title": "Ë∫´‰ªΩ/Á®±Ëôü",
      "location": "Áï∂Ââç‰ΩçÁΩÆ",
      "stats": {
        "Ë°®Èù¢Â•ΩÊÑü": 0-100,
        "ÁúüÂØ¶Â•ΩÊÑü": 0-100,
        "ÂÖ∂‰ªñÂ±¨ÊÄß": Êï∏ÂÄº
      },
      "mood": "Áï∂ÂâçÊÉÖÁ∑í",
      "note": "Á∞°Áü≠ÂÇôË®ª"
    }
  ]${hasPlayerPanel ? `,
  "player": {
    "stats": {
      "Â±¨ÊÄßÂêç": Êï∏ÂÄº
    },
    "note": "Áé©ÂÆ∂ÁãÄÊÖãÂÇôË®ªÔºàÂèØÈÅ∏Ôºâ"
  }` : ''}
}
\`\`\`

Ê≥®ÊÑèÔºö
- Âè™Ëº∏Âá∫Êú¨Ê¨°‰∫íÂãï‰∏≠Âá∫ÁèæÊàñÁãÄÊÖãÊúâËÆäÂåñÁöÑËßíËâ≤
- Êï∏ÂÄºÁî® 0-100 Ë°®Á§∫${hasPlayerPanel ? '\n- Áé©ÂÆ∂ÁãÄÊÖãÊúâËÆäÂåñÊôÇÊâçËº∏Âá∫ player Â≠óÊÆµ' : ''}
- Â¶ÇÊûúÊ≤íÊúâËßíËâ≤ÊàñÁé©ÂÆ∂ÁãÄÊÖãËÆäÂåñÔºåÂèØ‰ª•‰∏çËº∏Âá∫ JSON
- JSON ÂøÖÈ†àÊîæÂú®ÂõûË¶ÜÁöÑÊúÄÂæåÔºåÁî® \`\`\`json Âíå \`\`\` ÂåÖË£π
`;
  }

  // v24: Ê∑ªÂä†Áé©ÂÆ∂ÁãÄÊÖãÈù¢ÊùøÔºàÂ∑≤Âú®ÂâçÈù¢Áç≤ÂèñÔºâ
  if(playerPanel && playerPanel.attributes && playerPanel.attributes.length > 0){
    p += `\n### üë§ Áé©ÂÆ∂ÁãÄÊÖãÔºà${playerPanel.name || '‰∏ªËßí'}Ôºâ\n`;
    p += '‰ª•‰∏ãÊòØÁé©ÂÆ∂/‰∏ªËßíÁöÑÁï∂ÂâçÁãÄÊÖãÔºåË´ãÂú®ÂõûË¶Ü‰∏≠ÂèÉËÄÉÈÄô‰∫õÊï∏ÂÄºÔºö\n\n';
    
    // ÊåâÂàÜÁµÑÊï¥ÁêÜÂ±¨ÊÄß
    const groups = {};
    playerPanel.attributes.forEach(attr => {
      const group = attr.group || 'Âü∫Á§éÂ±¨ÊÄß';
      if(!groups[group]) groups[group] = [];
      groups[group].push(attr);
    });
    
    for(const [groupName, attrs] of Object.entries(groups)){
      p += `**„Äê${groupName}„Äë**\n`;
      attrs.forEach(attr => {
        // Âæû values Â∞çË±°‰∏≠Áç≤ÂèñÁï∂ÂâçÂÄºÔºåÂ¶ÇÊûúÊ≤íÊúâÂâá‰ΩøÁî®ÈªòË™çÂÄº
        const currentValue = playerPanel.values?.[attr.name] ?? attr.defaultValue ?? 0;
        let valueStr = '';
        if(attr.type === 'percent'){
          valueStr = `${currentValue}%`;
        } else if(attr.type === 'number'){
          valueStr = `${currentValue}`;
        } else {
          valueStr = currentValue;
        }
        p += `- ${attr.icon || '‚Ä¢'} ${attr.name}Ôºö${valueStr}\n`;
      });
      p += '\n';
    }
  }
  
  // v24: Ê∑ªÂä†ËÉåÂåÖÁâ©ÂìÅ
  if(story.inventory && story.inventory.length > 0){
    p += '\n### üéí ËÉåÂåÖÁâ©ÂìÅ\n';
    p += '‰ª•‰∏ãÊòØÁé©ÂÆ∂ÁõÆÂâçÊåÅÊúâÁöÑÁâ©ÂìÅÔºåË´ãÂú®ÂäáÊÉÖ‰∏≠ÂêàÁêÜ‰ΩøÁî®ÈÄô‰∫õÁâ©ÂìÅÔºö\n\n';
    
    // ÊåâÂàÜÈ°ûÊï¥ÁêÜÁâ©ÂìÅ
    const categories = {
      'weapon': '‚öîÔ∏è Ê≠¶Âô®',
      'armor': 'üõ°Ô∏è Èò≤ÂÖ∑',
      'consumable': 'üß™ Ê∂àËÄóÂìÅ',
      'material': 'üì¶ ÊùêÊñô',
      'key': 'üîë ÈóúÈçµÁâ©ÂìÅ',
      'other': 'üìã ÂÖ∂‰ªñ'
    };
    
    const itemsByCategory = {};
    story.inventory.forEach(item => {
      const cat = item.category || 'other';
      if(!itemsByCategory[cat]) itemsByCategory[cat] = [];
      itemsByCategory[cat].push(item);
    });
    
    for(const [catKey, catName] of Object.entries(categories)){
      const items = itemsByCategory[catKey];
      if(items && items.length > 0){
        p += `**${catName}**\n`;
        items.forEach(item => {
          p += `- ${item.icon || '‚Ä¢'} ${item.name}`;
          if(item.quantity && item.quantity > 1) p += ` √ó${item.quantity}`;
          if(item.description) p += `Ôºà${item.description}Ôºâ`;
          p += '\n';
        });
        p += '\n';
      }
    }
  }
  
  // v14: ÊáâÁî®Ê®°ÊùøËÆäÈáèÊõøÊèõ
  p = replaceTemplateVars(p);

  // v16: Ê∑ªÂä†Á∞°ÁπÅËΩâÊèõÊåáÁ§∫
  p += getChineseConvertPrompt();

  // v16: Ê∑ªÂä†Áï∂ÂâçÂ†¥ÊôØ‰ø°ÊÅØ
  p += await getActiveScenePrompt();

  // v22: Ê∑ªÂä† Persona ‰ø°ÊÅØ
  p += buildPersonaPrompt();

  return p;
}

// ÊâìÂ≠óÊ©üÊïàÊûú
function showTyping(){const c=document.getElementById('content-area'),d=document.createElement('div');d.id='typing';d.className='typing';d.innerHTML='<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';c.appendChild(d);c.scrollTop=c.scrollHeight;}
function hideTyping(){const t=document.getElementById('typing');if(t)t.remove();}
async function typewriter(m){
  const c=document.getElementById('content-area'),d=document.createElement('div');
  d.className='msg';d.dataset.id=m.id;d.oncontextmenu=e=>showMsgMenu(e,m.id);
  c.appendChild(d);
  const text=m.content;
  const speed=settings.typingSpeed||0;
  
  // Ëß£ÊûêÂÖßÂÆπ
  const parsed = parseAIResponse(text);
  const storyText = parsed.story;
  
  // ÂÆåÊàêÂæåÊ∏≤ÊüìÁöÑÂáΩÊï∏
  const renderFinal = () => {
    const safeId = escAttr(m.id);
    const floor = msgs.length; // ÂΩìÂâçÊ•ºÂ±ÇÂè∑
    let html = `<span class="msg-floor">#${floor}</span>`;
    html += `<div class="msg-menu-btn" onclick="showMsgActionMenu(event,'${safeId}','ai')">‚ãØ</div>`;
    html += `<div class="msg-ai-story">${marked.parse(storyText)}</div>`;
    if(parsed.characters && parsed.characters.length > 0){
      html += renderStatusCards(parsed.characters, m.id);
      // ÂêåÊ≠•ËßíËâ≤ÁãÄÊÖãÂà∞Êï∏ÊìöÂ∫´
      syncCharacterStatus(parsed.characters);
    }
    // v23: Ëá™ÂãïËß£ÊûêÁé©ÂÆ∂ÁãÄÊÖã
    parsePlayerStatusFromAI(text);
    if(parsed.playerStatus){
      html += renderPlayerStatusCard(parsed.playerStatus, m.id);
    }
    if(parsed.formatWarning){
      html += `<div class="msg-format-warning"><span class="icon">‚ö†Ô∏è</span>AI Êú™ÊåâÊ†ºÂºèËº∏Âá∫ÁãÄÊÖãÊï∏ÊìöÔºåÂ∑≤È°ØÁ§∫ÂéüÊñá</div>`;
    }
    if(m.tokens){
      html += `<div class="msg-timestamp">‚âà${m.tokens} tokens</div>`;
    }
    d.innerHTML = html;

    // v25: Ê™¢Êü•‰∏¶Ëá™ÂãïÂàáÊèõËßíËâ≤Ë°®ÊÉÖ
    checkAutoExpressionSwitch(storyText);
  };
  
  // Â¶ÇÊûúÈÄüÂ∫¶ÁÇ∫ 0ÔºåÁõ¥Êé•È°ØÁ§∫ÂÖ®ÈÉ®ÂÖßÂÆπ
  if(speed===0){
    renderFinal();
    c.scrollTop=c.scrollHeight;
    return;
  }
  
  // ÊâìÂ≠óÊ©üÊïàÊûúÂè™Â∞çÂäáÊÉÖÈÉ®ÂàÜ
  let i=0;
  return new Promise(resolve=>{
    typingCtrl={cancelled:false};
    function type(){
      if(typingCtrl.cancelled){
        renderFinal();
        c.scrollTop=c.scrollHeight;
        resolve();
        return;
      }
      if(i<storyText.length){
        d.innerHTML=`<div class="msg-ai-story"><span>${marked.parse(storyText.slice(0,i+1))}</span><span class="typing-cursor"></span></div>`;
        c.scrollTop=c.scrollHeight;
        i++;
        setTimeout(type,speed);
      }else{
        renderFinal();
        c.scrollTop=c.scrollHeight;
        resolve();
      }
    }
    type();
  });
}

// ÂêåÊ≠•ËßíËâ≤ÁãÄÊÖãÂà∞Êï∏ÊìöÂ∫´
async function syncCharacterStatus(characters){
  if(!story || !characters || characters.length === 0) return;

  // Âπ∂Ë°åÂ§ÑÁêÜÊâÄÊúâËßíËâ≤
  await Promise.all(
    characters.map(async (char) => {
      try{
        // Êü•ÊâæÊòØÂê¶Â∑≤Â≠òÂú®
        const existing = await db.characters.where('storyId').equals(story.id).filter(c => c.name === char.name).first();

        if(existing){
          // Êõ¥Êñ∞ÁèæÊúâËßíËâ≤
          const updates = {};
          if(char.title) updates.title = char.title;
          if(char.location) updates.location = char.location;
          if(char.stats) updates.stats = {...(existing.stats||{}), ...char.stats};
          if(char.mood) updates.mood = char.mood;
          if(char.note) updates.description = char.note;
          if(char.tags && char.tags.length) updates.tags = char.tags;
          updates.updatedAt = Date.now();

          await db.characters.update(existing.id, updates);
          console.log('Updated character:', char.name);
        }else{
          // ÂâµÂª∫Êñ∞ËßíËâ≤
          const newChar = {
            id: crypto.randomUUID(),
            storyId: story.id,
            name: char.name,
            title: char.title || '',
            avatar: char.avatar || 'üë§',
            stats: char.stats || {},
            tags: char.tags || [],
            description: char.note || '',
            location: char.location || '',
            mood: char.mood || '',
            createdAt: Date.now(),
            updatedAt: Date.now()
          };
          await db.characters.put(newChar);
          console.log('Created new character:', char.name);
        }
      }catch(e){
        console.error('Error syncing character:', char.name, e);
      }
    })
  );
}

// ============================================
// Lorebook Ëß∏ÁôºÁ≥ªÁµ±
// ============================================

let editLorebookId = null;
let lorebookConditions = [];

// Ê∏≤Êüì Lorebook ÂàóË°®
async function renderLorebook(searchTerm = '', statusFilter = 'all'){
  if(!story) return;

  try {
    const c = document.getElementById('lorebook-list');
    if(!c){
      console.error('[Lorebook] Êâæ‰∏çÂà∞ÂàóË°®ÂÆπÂô®ÂÖÉÁ¥†');
      return;
    }

    let entries = await db.lorebook.where('storyId').equals(story.id).toArray();

    // ÊêúÁ¥¢ËøáÊª§
    if(searchTerm){
      const term = searchTerm.toLowerCase();
      entries = entries.filter(e =>
        (e.name || '').toLowerCase().includes(term) ||
        (e.keywords || []).some(k => k.toLowerCase().includes(term)) ||
        (e.content || '').toLowerCase().includes(term)
      );
    }

    // Áä∂ÊÄÅËøáÊª§
    if(statusFilter === 'enabled'){
      entries = entries.filter(e => e.isEnabled);
    } else if(statusFilter === 'disabled'){
      entries = entries.filter(e => !e.isEnabled);
    }

    // ÊåâÂÑ™ÂÖàÁ¥öÊéíÂ∫è
    entries.sort((a,b) => (b.priority||0) - (a.priority||0));

    if(!entries.length){
      const isFiltered = searchTerm || statusFilter !== 'all';
      c.innerHTML = `<div class="empty" style="padding:40px 20px">
        <div class="empty-icon">üîÆ</div>
        <div class="empty-title">${isFiltered ? 'Ê≤íÊúâÂåπÈÖçÁöÑÊ¢ùÁõÆ' : 'Lorebook ÁÇ∫Á©∫'}</div>
        <div class="empty-desc">${isFiltered ? 'ÂòóË©¶Êõ¥ÊîπÊêúÁ¥¢Ê¢ù‰ª∂' : 'Ê∑ªÂä†Ë®≠ÂÆöÊ¢ùÁõÆÔºåÁï∂Â∞çË©±ÂåÖÂê´ÈóúÈçµË©ûÊôÇËá™ÂãïÊ≥®ÂÖ•'}</div>
        ${!isFiltered ? `<button class="action-btn primary" style="margin-top:12px" onclick="addLorebook()">‚ûï Ê∑ªÂä†Ê¢ùÁõÆ</button>
        <button class="action-btn secondary" style="margin-top:8px" onclick="importFromLore()">üì• ÂæûË≥áÊñôÂ∫´Â∞éÂÖ•</button>` : ''}
      </div>`;
      return;
    }

    let html = '';
    for(const entry of entries){
      const hasConditions = entry.conditions && entry.conditions.length > 0;
      const keywords = (entry.keywords || []).slice(0,3).join(', ');
      const moreKeywords = (entry.keywords || []).length > 3 ? ` +${entry.keywords.length-3}` : '';

      html += `<div class="lorebook-card ${entry.isEnabled?'':'disabled'}">
        <div class="lorebook-card-header">
          <div class="lorebook-card-status"></div>
          <div class="lorebook-card-title">${esc(entry.name || 'Êú™ÂëΩÂêç')}</div>
          ${hasConditions ? '<span class="lorebook-card-lock">üîê</span>' : ''}
        </div>
        <div class="lorebook-card-triggers">üè∑Ô∏è ${esc(keywords)}${moreKeywords}</div>
        <div class="lorebook-card-stats">
          <span>Â∑≤Ëß∏Áôº ${entry.triggerCount||0} Ê¨°</span>
          <span>ÂÑ™ÂÖàÁ¥ö ${entry.priority||100}</span>
        </div>
        <div class="lorebook-card-actions">
          <button class="action-btn secondary" onclick="editLorebook('${entry.id}')">Á∑®ËºØ</button>
          <button class="action-btn secondary" onclick="toggleLorebookEnabled('${entry.id}')">${entry.isEnabled?'Á¶ÅÁî®':'ÂïüÁî®'}</button>
          <button class="action-btn secondary" onclick="deleteLorebook('${entry.id}')">üóëÔ∏è</button>
        </div>
      </div>`;
    }
    c.innerHTML = html;

  } catch(e) {
    console.error('[Lorebook] Ê∏≤ÊüìÂ§±Êïó:', e);
    const c = document.getElementById('lorebook-list');
    if(c){
      c.innerHTML = `<div class="empty" style="padding:40px 20px">
        <div class="empty-icon">‚ö†Ô∏è</div>
        <div class="empty-title">Âä†ËºâÂ§±Êïó</div>
        <div class="empty-desc">${e.message}</div>
        <button class="action-btn primary" style="margin-top:12px" onclick="renderLorebook()">ÈáçË©¶</button>
      </div>`;
    }
    toast('Lorebook Âä†ËºâÂ§±Êïó: ' + e.message, 'error');
  }
}

// Lorebook ÊêúÁ¥¢ËøáÊª§
function filterLorebook(){
  const searchTerm = document.getElementById('lorebook-search-input')?.value || '';
  const statusFilter = document.getElementById('lorebook-filter-status')?.value || 'all';
  renderLorebook(searchTerm, statusFilter);
}

// Ê∑ªÂä† Lorebook Ê¢ùÁõÆ
function addLorebook(){
  if(!story){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'),'warning');return;}
  editLorebookId = null;
  lorebookConditions = [];
  document.getElementById('lorebook-id').value = '';
  document.getElementById('lorebook-name').value = '';
  document.getElementById('lorebook-keywords').value = '';
  document.getElementById('lorebook-content').value = '';
  document.getElementById('lorebook-depth').value = '2';
  document.getElementById('lorebook-priority').value = '100';
  document.getElementById('lorebook-cooldown').value = '0';
  document.getElementById('lorebook-max-triggers').value = '0';
  document.getElementById('lorebook-one-time').checked = false;
  document.getElementById('lorebook-condition-list').innerHTML = '';
  document.getElementById('lorebook-advanced').style.display = 'none';
  document.getElementById('lorebook-conditions').style.display = 'none';
  showModal('lorebook-modal');
}

// Á∑®ËºØ Lorebook Ê¢ùÁõÆ
async function editLorebook(id){
  try {
    const entry = await db.lorebook.get(id);
    if(!entry){
      toast('Êâæ‰∏çÂà∞Ë©≤Ê¢ùÁõÆ', 'error');
      return;
    }

    editLorebookId = id;
    lorebookConditions = entry.conditions || [];

    // ÂÆâÂÖ®Êõ¥Êñ∞ÂÖÉÁ¥†
    const updateElement = (id, value) => {
      const el = document.getElementById(id);
      if(el) el.value = value;
    };

    updateElement('lorebook-id', id);
    updateElement('lorebook-name', entry.name || '');
    updateElement('lorebook-keywords', (entry.keywords || []).join(', '));
    updateElement('lorebook-content', entry.content || '');
    updateElement('lorebook-depth', entry.depth || '2');
    updateElement('lorebook-priority', entry.priority || '100');
    updateElement('lorebook-cooldown', entry.cooldown || '0');
    updateElement('lorebook-max-triggers', entry.maxTriggers || '0');

    const oneTimeEl = document.getElementById('lorebook-one-time');
    if(oneTimeEl) oneTimeEl.checked = entry.oneTime || false;

    // Ë®≠ÁΩÆÊ¢ù‰ª∂ÈÇèËºØ
    const logicRadios = document.querySelectorAll('input[name="lorebook-logic"]');
    logicRadios.forEach(r => r.checked = r.value === (entry.conditionLogic || 'AND'));

    // Ê∏≤ÊüìÊ¢ù‰ª∂ÂàóË°®
    try {
      renderLorebookConditions();
    } catch(e) {
      console.warn('[Lorebook] Ê∏≤ÊüìÊ¢ù‰ª∂Â§±Êïó:', e);
    }

    showModal('lorebook-modal');

  } catch(e) {
    console.error('[Lorebook] Á∑®ËºØÂ§±Êïó:', e);
    toast('Á∑®ËºØÂ§±Êïó: ' + e.message, 'error');
  }
}

// ‰øùÂ≠ò Lorebook Ê¢ùÁõÆ
async function saveLorebook(){
  try {
    const name = document.getElementById('lorebook-name')?.value.trim() || '';
    const keywordsStr = document.getElementById('lorebook-keywords')?.value.trim() || '';
    const content = document.getElementById('lorebook-content')?.value.trim() || '';

    if(!name){toast(T('Ë´ãËº∏ÂÖ•ÂêçÁ®±'),'warning');return;}
    if(!keywordsStr){toast(T('Ë´ãËº∏ÂÖ•Ëß∏ÁôºÈóúÈçµË©û'),'warning');return;}
    if(!content){toast(T('Ë´ãËº∏ÂÖ•ÂÖßÂÆπ'),'warning');return;}

    const keywords = keywordsStr.split(/[,Ôºå]/).map(k=>k.trim()).filter(k=>k);
    const conditionLogic = document.querySelector('input[name="lorebook-logic"]:checked')?.value || 'AND';

    const entry = {
      id: editLorebookId || crypto.randomUUID(),
      storyId: story.id,
      name,
      keywords,
      content,
      depth: parseInt(document.getElementById('lorebook-depth')?.value) || 2,
      priority: parseInt(document.getElementById('lorebook-priority')?.value) || 100,
      cooldown: parseInt(document.getElementById('lorebook-cooldown')?.value) || 0,
      maxTriggers: parseInt(document.getElementById('lorebook-max-triggers')?.value) || 0,
      oneTime: document.getElementById('lorebook-one-time')?.checked || false,
      conditions: lorebookConditions,
      conditionLogic,
      isEnabled: true,
      triggerCount: 0,
      lastTriggered: null,
      createdAt: editLorebookId ? undefined : Date.now(),
      updatedAt: Date.now()
    };

    // ‰øùÁïôÂéüÊúâÁöÑ triggerCount
    if(editLorebookId){
      try {
        const existing = await db.lorebook.get(editLorebookId);
        if(existing){
          entry.triggerCount = existing.triggerCount;
          entry.lastTriggered = existing.lastTriggered;
          entry.createdAt = existing.createdAt;
          entry.isEnabled = existing.isEnabled;
        }
      } catch(e) {
        console.warn('[Lorebook] Áç≤ÂèñÂéüÊúâÊï∏ÊìöÂ§±Êïó:', e);
      }
    }

    await db.lorebook.put(entry);
    closeModal('lorebook-modal');
    toast(editLorebookId ? 'Ê¢ùÁõÆÂ∑≤Êõ¥Êñ∞' : 'Ê¢ùÁõÆÂ∑≤Ê∑ªÂä†', 'success');
    renderLorebook();

  } catch(e) {
    console.error('[Lorebook] ‰øùÂ≠òÂ§±Êïó:', e);
    toast('‰øùÂ≠òÂ§±Êïó: ' + e.message, 'error');
  }
}

// ÂàáÊèõÂïüÁî®ÁãÄÊÖã
async function toggleLorebookEnabled(id){
  try {
    const entry = await db.lorebook.get(id);
    if(entry){
      await db.lorebook.update(id, {isEnabled: !entry.isEnabled});
      toast(entry.isEnabled ? 'Â∑≤Á¶ÅÁî®' : 'Â∑≤ÂïüÁî®');
      renderLorebook();
    } else {
      toast('Êâæ‰∏çÂà∞Ë©≤Ê¢ùÁõÆ', 'error');
    }
  } catch(e) {
    console.error('[Lorebook] ÂàáÊèõÁãÄÊÖãÂ§±Êïó:', e);
    toast('Êìç‰ΩúÂ§±Êïó: ' + e.message, 'error');
  }
}

// Âà™Èô§ Lorebook Ê¢ùÁõÆ
function deleteLorebook(id){
  showConfirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãÊ¢ùÁõÆÂóéÔºü', async()=>{
    try {
      await db.lorebook.delete(id);
      toast(T('Â∑≤Âà™Èô§'),'success');
      renderLorebook();
    } catch(e) {
      console.error('[Lorebook] Âà™Èô§Â§±Êïó:', e);
      toast('Âà™Èô§Â§±Êïó: ' + e.message, 'error');
    }
  });
}

// ÂæûË≥áÊñôÂ∫´Â∞éÂÖ•
async function importFromLore(){
  if(!story){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'),'warning');return;}
  
  const entries = await db.loreEntries.where('storyId').equals(story.id).toArray();
  if(!entries.length){
    toast(T('Ë≥áÊñôÂ∫´ÁÇ∫Á©∫ÔºåÊ≤íÊúâÂèØÂ∞éÂÖ•ÁöÑÊ¢ùÁõÆ'),'warning');
    return;
  }
  
  showConfirm(`Á¢∫ÂÆöË¶ÅÂæûË≥áÊñôÂ∫´Â∞éÂÖ• ${entries.length} ÂÄãÊ¢ùÁõÆÂóéÔºü`, async()=>{
    let count = 0;
    for(const e of entries){
      // Ê™¢Êü•ÊòØÂê¶Â∑≤Â≠òÂú®
      const existing = await db.lorebook.where('storyId').equals(story.id).filter(l=>l.name===e.name).first();
      if(existing) continue;
      
      await db.lorebook.put({
        id: crypto.randomUUID(),
        storyId: story.id,
        name: e.name,
        keywords: [e.name],
        content: e.content || e.description || '',
        depth: 2,
        priority: 100,
        cooldown: 0,
        maxTriggers: 0,
        oneTime: false,
        conditions: [],
        conditionLogic: 'AND',
        isEnabled: true,
        triggerCount: 0,
        lastTriggered: null,
        createdAt: Date.now(),
        updatedAt: Date.now()
      });
      count++;
    }
    toast(`Â∑≤Â∞éÂÖ• ${count} ÂÄãÊ¢ùÁõÆ`,'success');
    renderLorebook();
  });
}

// ÈÄ≤ÈöéË®≠ÁΩÆÈñãÈóú
function toggleLorebookAdvanced(){
  const el = document.getElementById('lorebook-advanced');
  const toggle = document.getElementById('lorebook-advanced-toggle');
  if(el.style.display === 'none'){
    el.style.display = 'block';
    toggle.textContent = '‚ñ≤';
  }else{
    el.style.display = 'none';
    toggle.textContent = '‚ñº';
  }
}

// Ê¢ù‰ª∂Ë®≠ÁΩÆÈñãÈóú
function toggleLorebookConditions(){
  const el = document.getElementById('lorebook-conditions');
  const toggle = document.getElementById('lorebook-conditions-toggle');
  if(el.style.display === 'none'){
    el.style.display = 'block';
    toggle.textContent = '‚ñ≤';
  }else{
    el.style.display = 'none';
    toggle.textContent = '‚ñº';
  }
}

// Ê∑ªÂä†Ê¢ù‰ª∂
async function addLorebookCondition(){
  lorebookConditions.push({
    type: 'stat',
    character: '',
    stat: '',
    operator: '>=',
    value: 50
  });
  renderLorebookConditions();
}

// Ê∏≤ÊüìÊ¢ù‰ª∂ÂàóË°®
async function renderLorebookConditions(){
  const container = document.getElementById('lorebook-condition-list');
  const chars = story ? await db.characters.where('storyId').equals(story.id).toArray() : [];
  
  let html = '';
  lorebookConditions.forEach((cond, idx) => {
    // Áç≤ÂèñËßíËâ≤ÁöÑÂ±¨ÊÄßÂàóË°®
    const charOptions = chars.map(c => `<option value="${esc(c.name)}" ${cond.character===c.name?'selected':''}>${esc(c.name)}</option>`).join('');
    
    // Áç≤ÂèñÈÅ∏‰∏≠ËßíËâ≤ÁöÑÂ±¨ÊÄß
    const selectedChar = chars.find(c => c.name === cond.character);
    const statOptions = selectedChar && selectedChar.stats 
      ? Object.keys(selectedChar.stats).map(s => `<option value="${esc(s)}" ${cond.stat===s?'selected':''}>${esc(s)}</option>`).join('')
      : '<option value="">Ë´ãÂÖàÈÅ∏ÊìáËßíËâ≤</option>';
    
    html += `<div class="lorebook-condition" data-idx="${idx}">
      <select onchange="updateLorebookCondition(${idx},'character',this.value);setTimeout(()=>renderLorebookConditions(),0)">
        <option value="">ÈÅ∏ÊìáËßíËâ≤</option>
        ${charOptions}
      </select>
      <select onchange="updateLorebookCondition(${idx},'stat',this.value)">
        <option value="">ÈÅ∏ÊìáÂ±¨ÊÄß</option>
        ${statOptions}
      </select>
      <select onchange="updateLorebookCondition(${idx},'operator',this.value)">
        <option value=">=" ${cond.operator==='>='?'selected':''}>‚â•</option>
        <option value=">" ${cond.operator==='>'?'selected':''}>></option>
        <option value="<=" ${cond.operator==='<='?'selected':''}>‚â§</option>
        <option value="<" ${cond.operator==='<'?'selected':''}><</option>
        <option value="==" ${cond.operator==='=='?'selected':''}>Ôºù</option>
      </select>
      <input type="number" value="${cond.value}" onchange="updateLorebookCondition(${idx},'value',parseInt(this.value))">
      <span style="cursor:pointer;color:var(--error)" onclick="removeLorebookCondition(${idx})">üóëÔ∏è</span>
    </div>`;
  });
  
  container.innerHTML = html || '<div style="font-size:12px;color:var(--text-tertiary);text-align:center;padding:12px">Êö´ÁÑ°Ê¢ù‰ª∂ÔºåÈªûÊìä‰∏ãÊñπÊåâÈàïÊ∑ªÂä†</div>';
}

// Êõ¥Êñ∞Ê¢ù‰ª∂
function updateLorebookCondition(idx, field, value){
  if(lorebookConditions[idx]){
    lorebookConditions[idx][field] = value;
  }
}

// ÁßªÈô§Ê¢ù‰ª∂
function removeLorebookCondition(idx){
  lorebookConditions.splice(idx, 1);
  renderLorebookConditions();
}

// Ê™¢Ê∏¨ÈóúÈçµË©ûÂåπÈÖç
function checkKeywordMatch(entry, userMessage, recentMessages){
  const keywords = entry.keywords || [];
  const depth = entry.depth || 2;

  // È©óË≠âËº∏ÂÖ•
  if(!userMessage || typeof userMessage !== 'string'){
    userMessage = '';
  }

  // Âêà‰ΩµÊúÄËøëÊ∂àÊÅØ
  let textToCheck = userMessage;
  const recentSlice = recentMessages.slice(-depth);
  recentSlice.forEach(m => {
    textToCheck += ' ' + (m.content || '');
  });
  textToCheck = textToCheck.toLowerCase();
  
  // Ê™¢Êü•ÈóúÈçµË©û
  for(const keyword of keywords){
    if(textToCheck.includes(keyword.toLowerCase())){
      entry._matchedKeyword = keyword;
      return true;
    }
  }
  return false;
}

// Ê™¢Êü•Ëß∏ÁôºÊ¢ù‰ª∂
async function checkLorebookConditions(entry){
  if(!entry.conditions || entry.conditions.length === 0) return true;
  
  const chars = await db.characters.where('storyId').equals(story.id).toArray();
  const results = [];
  
  for(const cond of entry.conditions){
    const char = chars.find(c => c.name === cond.character);
    if(!char || !char.stats) {
      results.push(false);
      continue;
    }
    
    const statValue = char.stats[cond.stat];
    if(statValue === undefined){
      results.push(false);
      continue;
    }
    
    let met = false;
    switch(cond.operator){
      case '>=': met = statValue >= cond.value; break;
      case '>': met = statValue > cond.value; break;
      case '<=': met = statValue <= cond.value; break;
      case '<': met = statValue < cond.value; break;
      case '==': met = statValue === cond.value; break;
    }
    results.push(met);
  }
  
  if(entry.conditionLogic === 'OR'){
    return results.some(r => r);
  }else{
    return results.every(r => r);
  }
}

// Áç≤ÂèñËß∏ÁôºÁöÑ Lorebook ÂÖßÂÆπ
async function getTriggeredLorebook(userMessage){
  if(!story) return [];
  
  const entries = await db.lorebook.where('storyId').equals(story.id).filter(e => e.isEnabled).toArray();
  const triggered = [];
  const recentMsgs = msgs.slice(-5);
  
  for(const entry of entries){
    // Ê™¢Êü•ÈóúÈçµË©û
    if(!checkKeywordMatch(entry, userMessage, recentMsgs)) continue;
    
    // Ê™¢Êü•Ê¢ù‰ª∂
    const conditionsMet = await checkLorebookConditions(entry);
    if(!conditionsMet) continue;
    
    // Ê™¢Êü•ÂÜ∑Âçª
    if(entry.cooldown > 0 && entry.lastTriggered){
      const msgsSinceTrigger = msgs.filter(m => m.createdAt > entry.lastTriggered).length;
      if(msgsSinceTrigger < entry.cooldown) continue;
    }
    
    // Ê™¢Êü•ÊúÄÂ§ßËß∏ÁôºÊ¨°Êï∏
    if(entry.maxTriggers > 0 && (entry.triggerCount || 0) >= entry.maxTriggers) continue;
    
    triggered.push(entry);
  }
  
  // v25: Ê™¢Êü•ËßíËâ≤Â∞àÂ±¨Lorebook
  const chars = await db.characters.where('storyId').equals(story.id).toArray();
  const activeScene = await getActiveScene();
  
  for(const char of chars){
    if(!char.character_book || !char.character_book.entries) continue;
    
    // Ê™¢Êü•Ëß∏ÁôºÊ®°Âºè
    const triggerMode = char.character_book.triggerMode || 'scene';
    
    // Â¶ÇÊûúÊòØÂ†¥ÊôØÊ®°ÂºèÔºåÊ™¢Êü•ËßíËâ≤ÊòØÂê¶Âú®Áï∂ÂâçÂ†¥ÊôØ‰∏≠
    if(triggerMode === 'scene'){
      if(activeScene && activeScene.characterIds){
        if(!activeScene.characterIds.includes(char.id)) continue;
      }
    }
    
    // Ê™¢Êü•ÊØèÂÄãÊ¢ùÁõÆ
    for(const entry of char.character_book.entries){
      if(!entry.enabled) continue;
      
      // Â∏∏ÈßêÊ¢ùÁõÆÁõ¥Êé•Ëß∏Áôº
      if(entry.constant){
        triggered.push({
          ...entry,
          name: `[${char.name}] ${entry.keys?.join(', ') || 'Â∏∏Èßê'}`,
          isCharacterBook: true,
          characterName: char.name
        });
        continue;
      }
      
      // Ê™¢Êü•ÈóúÈçµË©ûÂåπÈÖç
      const keywords = entry.keys || [];
      const searchText = userMessage + ' ' + recentMsgs.map(m => m.content).join(' ');
      const matched = keywords.some(kw => searchText.toLowerCase().includes(kw.toLowerCase()));
      
      if(matched){
        triggered.push({
          ...entry,
          name: `[${char.name}] ${entry.keys?.join(', ')}`,
          isCharacterBook: true,
          characterName: char.name
        });
      }
    }
  }
  
  // ÊåâÂÑ™ÂÖàÁ¥öÊéíÂ∫è
  triggered.sort((a, b) => (b.priority || 0) - (a.priority || 0));
  
  return triggered;
}

// v25: Áç≤ÂèñÁï∂ÂâçÊ¥ªÂãïÂ†¥ÊôØ
async function getActiveScene(){
  if(!story) return null;
  const scenes = await db.scenes.where('storyId').equals(story.id).toArray();
  return scenes.find(s => s.isActive);
}

// È°ØÁ§∫Ëß∏ÁôºÊèêÁ§∫
function showLorebookTriggerToast(entries){
  if(!entries || entries.length === 0) return;
  
  const names = entries.map(e => e.name).join('„ÄÅ');
  const toast = document.createElement('div');
  toast.className = 'lore-trigger-toast';
  toast.innerHTML = `<span>üîÆ</span><span>Â∑≤Ëß∏ÁôºÔºö${esc(names)}</span>`;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(-50%) translateY(-10px)';
    setTimeout(() => toast.remove(), 300);
  }, 2500);
}

// ÊâìÂ≠óÊ©üÈªûÊìäÂèñÊ∂àÂäüËÉΩ
function initTypingCancel(){
  const contentArea = document.getElementById('content-area');
  if(contentArea){
    contentArea.addEventListener('click', () => {
      if(typingCtrl && !typingCtrl.cancelled) typingCtrl.cancelled = true;
    });
  }
}

// Ë≥áÊñôÂ∫´
async function renderLore(){
  if(!story)return;
  const c=document.getElementById('lore-list');
  const entries=await db.loreEntries.where('storyId').equals(story.id).toArray();
  const grouped={character:[],location:[],item:[],setting:[]};
  entries.forEach(e=>{if(grouped[e.category])grouped[e.category].push(e);});
  const labels={character:{icon:'üë•',label:'ËßíËâ≤'},location:{icon:'üó∫Ô∏è',label:'Âú∞Èªû'},item:{icon:'üì¶',label:'Áâ©ÂìÅ'},setting:{icon:'üìú',label:'Ë®≠ÂÆö'}};
  let html='',selCount=0;
  for(const[cat,items]of Object.entries(grouped)){
    if(!items.length)continue;
    const{icon,label}=labels[cat];
    html+=`<div class="lore-section"><div class="lore-header" onclick="toggleLoreSection(this)"><div class="lore-header-left"><span>${icon}</span><span>${label}</span><span class="lore-count">(${items.length})</span></div><span class="lore-toggle">‚ñº</span></div><div class="lore-list">`;
    for(const e of items){
      if(e.isSelected)selCount++;
      html+=`<div class="lore-item" onclick="toggleLoreSel('${e.id}')"><div class="lore-checkbox ${e.isSelected?'checked':''}" data-id="${e.id}"></div><div class="lore-icon ${cat.slice(0,3)}">${e.icon||icon}</div><div class="lore-content"><div class="lore-name">${esc(e.name)}</div><div class="lore-desc">${esc(e.description||'')}</div></div><div class="lore-actions" onclick="event.stopPropagation()"><span onclick="editLore('${e.id}')">‚úèÔ∏è</span><span onclick="deleteLore('${e.id}')">üóëÔ∏è</span></div></div>`;
    }
    html+='</div></div>';
  }
  if(!html)html=`<div class="empty"><div class="empty-icon">üìñ</div><div class="empty-title">${T('Ë≥áÊñôÂ∫´ÁÇ∫Á©∫')}</div><div class="empty-desc">${T('ÈªûÊìäÂè≥‰∏äËßíÊ∑ªÂä†ËßíËâ≤„ÄÅÂú∞ÈªûÁ≠âË®≠ÂÆö')}</div><button class="action-btn primary" style="margin-top:12px" onclick="addLore()">‚ûï ${T('Ê∑ªÂä†Ë≥áÊñô')}</button></div>`;
  c.innerHTML=html;
  document.getElementById('lore-count').textContent=`${T('Â∑≤ÈÅ∏')} ${selCount} ${T('È†Ö')}`;
}
function toggleLoreSection(h){h.querySelector('.lore-toggle').classList.toggle('collapsed');h.nextElementSibling.classList.toggle('collapsed');}
async function toggleLoreSel(id){const e=await db.loreEntries.get(id);if(e){await db.loreEntries.update(id,{isSelected:!e.isSelected});renderLore();}}

let editLoreId=null;
function addLore(){
  if(!story){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'),'warning');return;}
  editLoreId=null;
  document.getElementById('lore-name').value='';
  document.getElementById('lore-category').value='character';
  document.getElementById('lore-desc').value='';
  document.getElementById('lore-content-input').value='';
  showModal('lore-modal');
}
async function editLore(id){
  const e=await db.loreEntries.get(id);
  if(!e)return;
  editLoreId=id;
  document.getElementById('lore-name').value=e.name||'';
  document.getElementById('lore-category').value=e.category||'character';
  document.getElementById('lore-desc').value=e.description||'';
  document.getElementById('lore-content-input').value=e.content||'';
  showModal('lore-modal');
}
async function saveLore(){
  const name=document.getElementById('lore-name').value.trim();
  const category=document.getElementById('lore-category').value;
  const description=document.getElementById('lore-desc').value.trim();
  const content=document.getElementById('lore-content-input').value.trim();
  if(!name){toast(T('Ë´ãËº∏ÂÖ•ÂêçÁ®±'),'warning');return;}
  const entry={
    id:editLoreId||crypto.randomUUID(),
    storyId:story.id,
    name,category,description,content,
    isSelected:false,
    createdAt:Date.now()
  };
  await db.loreEntries.put(entry);
  closeModal('lore-modal');
  toast(editLoreId?'Ë≥áÊñôÂ∑≤Êõ¥Êñ∞':'Ë≥áÊñôÂ∑≤Ê∑ªÂä†','success');
  renderLore();
}
async function deleteLore(id){
  showConfirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÊ¢ùË≥áÊñôÂóéÔºü',async()=>{
    await db.loreEntries.delete(id);
    toast(T('Ë≥áÊñôÂ∑≤Âà™Èô§'),'success');
    renderLore();
  });
}

// Ë≥áÊñôÊêúÁ¥¢
async function filterLore(){
  const keyword=document.getElementById('lore-search').value.trim().toLowerCase();
  if(!story)return;
  const c=document.getElementById('lore-list');
  const entries=await db.loreEntries.where('storyId').equals(story.id).toArray();
  
  // ÈÅéÊøæ
  const filtered=keyword?entries.filter(e=>
    e.name.toLowerCase().includes(keyword)||
    (e.description||'').toLowerCase().includes(keyword)||
    (e.content||'').toLowerCase().includes(keyword)
  ):entries;
  
  const grouped={character:[],location:[],item:[],setting:[]};
  filtered.forEach(e=>{if(grouped[e.category])grouped[e.category].push(e);});
  const labels={character:{icon:'üë•',label:'ËßíËâ≤'},location:{icon:'üó∫Ô∏è',label:'Âú∞Èªû'},item:{icon:'üì¶',label:'Áâ©ÂìÅ'},setting:{icon:'üìú',label:'Ë®≠ÂÆö'}};
  let html='',selCount=0;
  for(const[cat,items]of Object.entries(grouped)){
    if(!items.length)continue;
    const{icon,label}=labels[cat];
    html+=`<div class="lore-section"><div class="lore-header" onclick="toggleLoreSection(this)"><div class="lore-header-left"><span>${icon}</span><span>${label}</span><span class="lore-count">(${items.length})</span></div><span class="lore-toggle">‚ñº</span></div><div class="lore-list">`;
    for(const e of items){
      if(e.isSelected)selCount++;
      html+=`<div class="lore-item" onclick="toggleLoreSel('${e.id}')"><div class="lore-checkbox ${e.isSelected?'checked':''}" data-id="${e.id}"></div><div class="lore-icon ${cat.slice(0,3)}">${e.icon||icon}</div><div class="lore-content"><div class="lore-name">${esc(e.name)}</div><div class="lore-desc">${esc(e.description||'')}</div></div><div class="lore-actions" onclick="event.stopPropagation()"><span onclick="editLore('${e.id}')">‚úèÔ∏è</span><span onclick="deleteLore('${e.id}')">üóëÔ∏è</span></div></div>`;
    }
    html+='</div></div>';
  }
  if(!html){
    if(keyword)html=`<div class="empty"><div class="empty-icon">üîç</div><div class="empty-title">${T('Êú™ÊâæÂà∞ÂåπÈÖçË≥áÊñô')}</div></div>`;
    else html=`<div class="empty"><div class="empty-icon">üìñ</div><div class="empty-title">${T('Ë≥áÊñôÂ∫´ÁÇ∫Á©∫')}</div><div class="empty-desc">${T('ÈªûÊìäÂè≥‰∏äËßíÊ∑ªÂä†ËßíËâ≤„ÄÅÂú∞ÈªûÁ≠âË®≠ÂÆö')}</div><button class="action-btn primary" style="margin-top:12px" onclick="addLore()">‚ûï ${T('Ê∑ªÂä†Ë≥áÊñô')}</button></div>`;
  }
  c.innerHTML=html;
  document.getElementById('lore-count').textContent=`${T('Â∑≤ÈÅ∏')} ${selCount} ${T('È†Ö')}`;
}

// AI ÊèêÂèñ‰∏ñÁïåËßÄË®≠ÂÆö
let aiExtractData = null;
async function aiExtractLore(){
  if(!story){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'),'warning');return;}
  
  // Êî∂ÈõÜ‰æÜÊ∫êÊï∏Êìö
  let sourceContent = '';
  
  // 1. ÂæûÊåá‰ª§ Prompt ÊèêÂèñ
  const bindings = await db.storyInstructions.where('storyId').equals(story.id).toArray();
  if(bindings.length > 0){
    const instIds = bindings.map(b => b.instructionId);
    const instructions = await db.instructions.where('id').anyOf(instIds).toArray();
    instructions.forEach(inst => {
      sourceContent += `\n„ÄêÊåá‰ª§Ë®≠ÂÆö„Äë\n${inst.content || ''}\n`;
    });
  }
  
  // 2. ÂæûÊïÖ‰∫ãÂäáÊÉÖÊèêÂèñÔºàÊúÄËøë N Ê¢ùÊ∂àÊÅØÔºâ
  if(msgs && msgs.length > 0){
    const recentMsgs = msgs.slice(-30); // ÊúÄËøë 30 Ê¢ù
    const storyContent = recentMsgs.map(m => m.content).join('\n');
    sourceContent += `\n„ÄêÊïÖ‰∫ãÂäáÊÉÖ„Äë\n${storyContent}\n`;
  }
  
  if(!sourceContent.trim()){
    toast(T('Ê≤íÊúâÂèØÊèêÂèñÁöÑÂÖßÂÆπ'),'warning');
    return;
  }
  
  showLoading('ü§ñ AI Ê≠£Âú®ÂàÜÊûê‰∏¶ÊèêÂèñË®≠ÂÆö...\nÈÄôÂèØËÉΩÈúÄË¶Å 30-120 ÁßíÔºåË´ãËÄêÂøÉÁ≠âÂæÖ');
  
  const prompt = `Ë´ãÂàÜÊûê‰ª•‰∏ãÂÖßÂÆπÔºåÊèêÂèñÂÖ∂‰∏≠ÁöÑ‰∏ñÁïåËßÄË®≠ÂÆö„ÄÇË´ã‰ª• JSON Ê†ºÂºèËøîÂõûÔºåÂåÖÂê´‰ª•‰∏ãÈ°ûÂà•Ôºö

1. charactersÔºàËßíËâ≤ÔºâÔºöÂåÖÂê´ name, description, details
2. locationsÔºàÂú∞ÈªûÔºâÔºöÂåÖÂê´ name, description
3. itemsÔºàÁâ©ÂìÅÔºâÔºöÂåÖÂê´ name, description
4. settingsÔºàË®≠ÂÆö/Ë¶èÂâáÔºâÔºöÂåÖÂê´ name, description

Ê≥®ÊÑèÔºö
- Âè™ÊèêÂèñÊòéÁ¢∫Âá∫ÁèæÊàñÊèêÂèäÁöÑÂÖßÂÆπ
- ÊØèÂÄãÈ°ûÂà•ÊúÄÂ§öÊèêÂèñ 10 ÂÄãÊúÄÈáçË¶ÅÁöÑÊ¢ùÁõÆ
- ÊèèËø∞Ë¶ÅÁ∞°ÊΩî‰ΩÜÂÆåÊï¥

Ë´ãÂè™ËøîÂõû JSONÔºå‰∏çË¶ÅÂÖ∂‰ªñÂÖßÂÆπÔºö
{
  "characters": [{"name": "", "description": ""}],
  "locations": [{"name": "", "description": ""}],
  "items": [{"name": "", "description": ""}],
  "settings": [{"name": "", "description": ""}]
}

ÂæÖÂàÜÊûêÂÖßÂÆπÔºö
${sourceContent.slice(0, 15000)}`;

  try{
    const response = await callAI(prompt);
    hideLoading();
    
    // Ëß£Êûê JSON - response ÊòØÂ∞çË±°ÔºåÈúÄË¶ÅÂèñ content
    const responseText = response.content || response;
    let data;
    const jsonMatch = responseText.match(/\{[\s\S]*\}/);
    if(jsonMatch){
      try {
        data = JSON.parse(jsonMatch[0]);
        // È™åËØÅÊï∞ÊçÆÁªìÊûÑ
        if(!data || typeof data !== 'object') {
          throw new Error('ÁÑ°ÊïàÁöÑÊï∏ÊìöÁµêÊßã');
        }
        // È™åËØÅÂøÖÈúÄÂ≠óÊÆµ
        const requiredFields = ['characters', 'locations', 'items', 'settings'];
        const hasValidStructure = requiredFields.some(field =>
          data[field] && Array.isArray(data[field]) && data[field].length > 0
        );
        if(!hasValidStructure) {
          throw new Error('AI Êú™ËøîÂõûÊúâÊïàÁöÑÊèêÂèñÁµêÊûúÔºåË´ãÈáçË©¶');
        }
      } catch(e) {
        throw new Error('ÁÑ°Ê≥ïËß£Êûê AI ËøîÂõûÁöÑÂÖßÂÆπ: ' + e.message);
      }
    }else{
      throw new Error('ÁÑ°Ê≥ïËß£Êûê AI ËøîÂõûÁöÑÂÖßÂÆπ');
    }
    
    // È°ØÁ§∫ÊèêÂèñÁµêÊûú‰æõÁî®Êà∂Á¢∫Ë™ç
    aiExtractData = data;
    showAiExtractResults(data);
  }catch(e){
    hideLoading();
    toast('ÊèêÂèñÂ§±Êïó: ' + e.message, 'error');
  }
}

function showAiExtractResults(data){
  const categoryLabels = {
    characters: {icon: 'üë•', label: 'ËßíËâ≤', category: 'character'},
    locations: {icon: 'üó∫Ô∏è', label: 'Âú∞Èªû', category: 'location'},
    items: {icon: 'üì¶', label: 'Áâ©ÂìÅ', category: 'item'},
    settings: {icon: 'üìú', label: 'Ë®≠ÂÆö', category: 'setting'}
  };
  
  let html = '<div style="max-height:400px;overflow-y:auto">';
  let totalCount = 0;
  
  for(const [key, items] of Object.entries(data)){
    if(!items || !items.length) continue;
    const {icon, label, category} = categoryLabels[key] || {icon: 'üìÑ', label: key, category: 'setting'};
    
    html += `<div style="margin-bottom:16px">`;
    html += `<div style="font-weight:600;margin-bottom:8px">${icon} ${label} (${items.length})</div>`;
    
    items.forEach((item, idx) => {
      totalCount++;
      const itemId = `extract-${key}-${idx}`;
      html += `<div style="display:flex;align-items:flex-start;gap:8px;padding:8px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:6px">`;
      html += `<input type="checkbox" id="${itemId}" checked style="margin-top:4px" data-category="${category}" data-name="${esc(item.name)}" data-desc="${esc(item.description || '')}">`;
      html += `<label for="${itemId}" style="flex:1;cursor:pointer">`;
      html += `<div style="font-weight:500">${esc(item.name)}</div>`;
      if(item.description) html += `<div style="font-size:12px;color:var(--text-secondary)">${esc(item.description.slice(0, 100))}${item.description.length > 100 ? '...' : ''}</div>`;
      html += `</label></div>`;
    });
    
    html += `</div>`;
  }
  
  if(totalCount === 0){
    html = '<div style="text-align:center;color:var(--text-secondary);padding:20px">Êú™ÊèêÂèñÂà∞‰ªª‰ΩïË®≠ÂÆö</div>';
  }
  
  html += '</div>';
  
  document.getElementById('confirm-title').textContent = `ü§ñ AI ÊèêÂèñÁµêÊûú (${totalCount} È†Ö)`;
  document.getElementById('confirm-content').innerHTML = html;
  document.getElementById('confirm-content').style.whiteSpace = 'normal';
  document.getElementById('confirm-btn').textContent = '‰øùÂ≠òÈÅ∏‰∏≠È†Ö';
  document.getElementById('confirm-btn').style.display = '';
  confirmCb = saveExtractedLore;
  showModal('confirm-modal');
}

async function saveExtractedLore(){
  const checkboxes = document.querySelectorAll('#confirm-content input[type="checkbox"]:checked');
  let savedCount = 0;
  
  for(const cb of checkboxes){
    const entry = {
      id: crypto.randomUUID(),
      storyId: story.id,
      name: cb.dataset.name,
      category: cb.dataset.category,
      description: cb.dataset.desc,
      content: '',
      isSelected: false,
      createdAt: Date.now()
    };
    await db.loreEntries.put(entry);
    savedCount++;
  }
  
  toast(`Â∑≤‰øùÂ≠ò ${savedCount} Ê¢ùË®≠ÂÆö`, 'success');
  closeModal('confirm-modal');
  renderLore();
}

// ÊêúÁ¥¢ÂäüËÉΩ
async function initContentSearch(){
  const c=document.getElementById('search-results');
  const input=document.getElementById('content-search');
  
  // Ê∏ÖÁ©∫ÊêúÁ¥¢Ê°Ü
  if(input) input.value='';
  
  // Ê™¢Êü•ÊòØÂê¶ÊúâÊïÖ‰∫ã
  if(!story){
    c.innerHTML='<div class="empty"><div class="empty-icon">üìö</div><div class="empty-title">Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã</div><div class="empty-desc">ËøîÂõûÊïÖ‰∫ãÂàóË°®ÈÅ∏Êìá‰∏ÄÂÄãÊïÖ‰∫ãÂæåÂÜçÊêúÁ¥¢</div></div>';
    return;
  }
  
  // Áõ¥Êé•ÂæûÊï∏ÊìöÂ∫´Áç≤ÂèñÊ∂àÊÅØÊï∏Èáè
  const msgCount = await db.messages.where('[storyId+branchId]').equals([story.id, story.currentBranchId]).count();
  
  if(!msgCount){
    c.innerHTML=`<div class="empty"><div class="empty-icon">‚ú®</div><div class="empty-title">${T('ÊïÖ‰∫ãÂÖßÂÆπÁÇ∫Á©∫')}</div><div class="empty-desc">${T('ÈñãÂßãË¨õËø∞ÊïÖ‰∫ãÂæåÊâçËÉΩÊêúÁ¥¢ÂÖßÂÆπ')}</div></div>`;
    return;
  }
  
  c.innerHTML=`<div class="empty"><div class="empty-icon">üîç</div><div class="empty-title">${T('Ëº∏ÂÖ•ÈóúÈçµË©ûÊêúÁ¥¢')}</div><div class="empty-desc">${T('ÂÖ±Êúâ')} ${msgCount} ${T('Ê¢ùÊ∂àÊÅØÂèØÊêúÁ¥¢')}</div></div>`;
}

async function doContentSearch(){
  const keyword=document.getElementById('content-search').value.trim().toLowerCase();
  const c=document.getElementById('search-results');
  
  // Ê™¢Êü•ÊòØÂê¶ÊúâÊïÖ‰∫ã
  if(!story){
    c.innerHTML=`<div class="empty"><div class="empty-icon">üìö</div><div class="empty-title">${T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã')}</div><div class="empty-desc">${T('ËøîÂõûÊïÖ‰∫ãÂàóË°®ÈÅ∏Êìá‰∏ÄÂÄãÊïÖ‰∫ãÂæåÂÜçÊêúÁ¥¢')}</div></div>`;
    return;
  }
  
  // Áõ¥Êé•ÂæûÊï∏ÊìöÂ∫´ËÆÄÂèñÊâÄÊúâÊ∂àÊÅØÔºà‰∏ç‰æùË≥¥ÂÖ®Â±ÄËÆäÈáèÔºâ
  const allMsgs = await db.messages.where('[storyId+branchId]').equals([story.id, story.currentBranchId]).sortBy('createdAt');
  
  if(!allMsgs||!allMsgs.length){
    c.innerHTML=`<div class="empty"><div class="empty-icon">‚ú®</div><div class="empty-title">${T('ÊïÖ‰∫ãÂÖßÂÆπÁÇ∫Á©∫')}</div><div class="empty-desc">${T('ÈñãÂßãË¨õËø∞ÊïÖ‰∫ãÂæåÊâçËÉΩÊêúÁ¥¢ÂÖßÂÆπ')}</div></div>`;
    return;
  }
  
  if(!keyword){
    c.innerHTML=`<div class="empty"><div class="empty-icon">üîç</div><div class="empty-title">${T('Ëº∏ÂÖ•ÈóúÈçµË©ûÊêúÁ¥¢')}</div><div class="empty-desc">${T('ÂÖ±Êúâ')} ${allMsgs.length} ${T('Ê¢ùÊ∂àÊÅØÂèØÊêúÁ¥¢')}</div></div>`;
    return;
  }
  
  // ‰ΩøÁî® includes ÈÄ≤Ë°åÊêúÁ¥¢
  const msgResults=allMsgs.filter(m=>{
    if(!m.content)return false;
    return m.content.toLowerCase().includes(keyword);
  });
  
  // v22: ÂêåÊôÇÊêúÁ¥¢ÊëòË¶Å
  const summaries = story.summaries || [];
  const rollingSummaries = story.rollingSummaries || [];
  const summaryResults = [];
  summaries.forEach((s, i) => {
    if(s.content && s.content.toLowerCase().includes(keyword)){
      summaryResults.push({...s, type: 'Â£ìÁ∏ÆÊëòË¶Å', idx: i});
    }
  });
  rollingSummaries.forEach((s, i) => {
    if(s.content && s.content.toLowerCase().includes(keyword)){
      summaryResults.push({...s, type: 'ÊªæÂãïÊëòË¶Å', idx: i});
    }
  });
  
  if(!msgResults.length && !summaryResults.length){
    c.innerHTML=`<div class="empty"><div class="empty-icon">üîç</div><div class="empty-title">Êú™ÊâæÂà∞ÂåπÈÖçÂÖßÂÆπ</div><div class="empty-desc">ÂòóË©¶ÊêúÁ¥¢ÂÖ∂‰ªñÈóúÈçµË©û<br><span style="font-size:11px;color:var(--text-tertiary)">Ôºà${allMsgs.length} Ê¢ùÊ∂àÊÅØ‰∏≠ÊêúÁ¥¢Ôºâ</span></div></div>`;
    return;
  }
  
  // È°ØÁ§∫ÁµêÊûú
  let html = `<div style="padding:8px;color:var(--text-secondary);font-size:13px">ÊâæÂà∞ ${msgResults.length} Ê¢ùÊ∂àÊÅØ`;
  if(summaryResults.length > 0) html += ` + ${summaryResults.length} Ê¢ùÊëòË¶Å`;
  html += '</div>';
  
  // È°ØÁ§∫ÊëòË¶ÅÁµêÊûúÔºàÂ¶ÇÊûúÊúâÔºâ
  if(summaryResults.length > 0){
    html += '<div style="padding:4px 8px;font-size:12px;color:var(--primary);font-weight:600">üìö ÊëòË¶Å‰∏≠ÁöÑÂåπÈÖç</div>';
    html += summaryResults.map(s => {
      const content = s.content || '';
      const lowerContent = content.toLowerCase();
      const idx = lowerContent.indexOf(keyword);
      const start = Math.max(0, idx - 40);
      const end = Math.min(content.length, idx + keyword.length + 60);
      let preview = content.slice(start, end);
      if(start > 0) preview = '...' + preview;
      if(end < content.length) preview = preview + '...';
      const regex = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      const highlighted = esc(preview).replace(regex, '<mark style="background:var(--warning);color:black;padding:0 2px">$1</mark>');
      return `<div class="card"><div class="card-cover" style="background:var(--info)">üìö</div><div class="card-info"><div class="card-header"><div class="card-title">${s.type} #${s.idx+1}</div><div class="card-time">${fmtDate(s.createdAt)}</div></div><div class="card-preview">${highlighted}</div></div></div>`;
    }).join('');
  }
  
  // È°ØÁ§∫Ê∂àÊÅØÁµêÊûú
  if(msgResults.length > 0){
    if(summaryResults.length > 0) html += '<div style="padding:4px 8px;font-size:12px;color:var(--primary);font-weight:600;margin-top:8px">üí¨ Ê∂àÊÅØ‰∏≠ÁöÑÂåπÈÖç</div>';
    html += msgResults.map(m=>{
      const preview=m.content.slice(0,150);
      const keywordLower = keyword.toLowerCase();
      const previewLower = preview.toLowerCase();
      const idx = previewLower.indexOf(keywordLower);
      let highlighted = esc(preview);
      if(idx >= 0){
        const before = esc(preview.slice(0, idx));
        const match = esc(preview.slice(idx, idx + keyword.length));
        const after = esc(preview.slice(idx + keyword.length));
        highlighted = `${before}<mark style="background:var(--warning);color:black;padding:0 2px;border-radius:2px">${match}</mark>${after}`;
      }
      return `<div class="card" onclick="jumpToMessage('${m.id}')">
        <div class="card-cover" style="background:${m.role==='user'?'var(--primary)':'var(--bg-tertiary)'}">${m.role==='user'?'üë§':'ü§ñ'}</div>
        <div class="card-info">
          <div class="card-header"><div class="card-title">${m.role==='user'?'Áî®Êà∂':'AI'}</div><div class="card-time">${fmtDate(m.createdAt)}</div></div>
          <div class="card-preview">${highlighted}...</div>
        </div>
      </div>`;
    }).join('');
  }
  
  c.innerHTML = html;
}
function showAdvancedSearch(){
  document.getElementById('adv-search-keyword').value=document.getElementById('content-search').value;
  showModal('advanced-search-modal');
}
function doAdvancedSearch(){
  const keyword=document.getElementById('adv-search-keyword').value.trim();
  const scope=document.getElementById('adv-search-scope').value;
  const caseSensitive=document.getElementById('adv-search-case').checked;
  if(!keyword){toast(T('Ë´ãËº∏ÂÖ•ÈóúÈçµË©û'),'warning');return;}
  
  closeModal('advanced-search-modal');
  const c=document.getElementById('search-results');
  
  if(!story||!msgs||!msgs.length){
    c.innerHTML='<div class="empty"><div class="empty-icon">üìö</div><div class="empty-title">Ê≤íÊúâÂèØÊêúÁ¥¢ÁöÑÂÖßÂÆπ</div></div>';
    return;
  }
  
  let filtered=msgs;
  if(scope==='user')filtered=msgs.filter(m=>m.role==='user');
  else if(scope==='ai')filtered=msgs.filter(m=>m.role==='assistant');
  
  const results=filtered.filter(m=>{
    if(!m.content)return false;
    const content=caseSensitive?m.content:m.content.toLowerCase();
    const search=caseSensitive?keyword:keyword.toLowerCase();
    return content.includes(search);
  });
  
  if(!results.length){
    c.innerHTML='<div class="empty"><div class="empty-icon">üîç</div><div class="empty-title">Êú™ÊâæÂà∞ÂåπÈÖçÂÖßÂÆπ</div></div>';
    return;
  }
  
  c.innerHTML=`<div style="padding:8px;color:var(--text-secondary);font-size:13px">ÊâæÂà∞ ${results.length} Ê¢ùÁµêÊûú</div>`+results.map(m=>{
    const preview=m.content.slice(0,150);
    return `<div class="card" onclick="jumpToMessage('${m.id}')">
      <div class="card-cover" style="background:${m.role==='user'?'var(--primary)':'var(--bg-tertiary)'}">${m.role==='user'?'üë§':'ü§ñ'}</div>
      <div class="card-info">
        <div class="card-header"><div class="card-title">${m.role==='user'?'Áî®Êà∂':'AI'}</div><div class="card-time">${fmtDate(m.createdAt)}</div></div>
        <div class="card-preview">${esc(preview)}...</div>
      </div>
    </div>`;
  }).join('');
}
function jumpToMessage(msgId){
  goBack();
  setTimeout(()=>{
    const el=document.querySelector(`.msg[data-id="${msgId}"]`);
    if(el){el.scrollIntoView({behavior:'smooth',block:'center'});el.style.animation='highlight 1s';}
  },300);
}

// ÊôÇÈñìËª∏
async function renderTimeline(){
  if(!story)return;
  const c=document.getElementById('timeline-content');
  const tl=await db.timeline.where('storyId').equals(story.id).sortBy('order');
  let html=`<div class="timeline-current"><span>üìÖ</span><span class="timeline-label">Áï∂ÂâçÊôÇÈñìÔºö</span><span class="timeline-value">${esc(story.storyTime||'Êú™Ë®≠ÂÆö')}</span></div>`;
  if(!tl.length)html+='<div class="empty" style="padding:40px 20px"><div class="empty-icon">üìÖ</div><div class="empty-title">ÊôÇÈñìËª∏ÁÇ∫Á©∫</div></div>';
  else{
    html+='<div class="timeline-list">';
    tl.forEach(t=>{
      const cur=t.timeLabel===story.storyTime;
      const evts=(t.events||[]).map(e=>`<div class="timeline-event"><div class="timeline-event-dot"></div><span>${esc(e)}</span></div>`).join('');
      html+=`<div class="timeline-item ${cur?'current':''}"><div class="timeline-date">${esc(t.timeLabel)} ${cur?'‚Üê Áï∂Ââç':''}</div><div class="timeline-events">${evts}</div></div>`;
    });
    html+='</div>';
  }
  html+='<button class="action-btn primary" style="width:100%;margin-top:16px" onclick="addTimeline()">‚ûï Ê∑ªÂä†ÊôÇÈñìÈªû</button>';
  c.innerHTML=html;
}

// ÊôÇÈñìËª∏ÂäüËÉΩ
function addTimeline(){
  if(!story){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'),'warning');return;}
  document.getElementById('timeline-label').value='';
  document.getElementById('timeline-event').value='';
  document.getElementById('timeline-set-current').checked=true;
  showModal('timeline-modal');
}
async function saveTimeline(){
  const label=document.getElementById('timeline-label').value.trim();
  const event=document.getElementById('timeline-event').value.trim();
  const setCurrent=document.getElementById('timeline-set-current').checked;
  if(!label){toast(T('Ë´ãËº∏ÂÖ•ÊôÇÈñìÊ®ôË®ò'),'warning');return;}
  
  // Êü•ÊâæÊòØÂê¶Â∑≤Â≠òÂú®Áõ∏ÂêåÊôÇÈñìÈªû
  const existing=await db.timeline.where('storyId').equals(story.id).filter(t=>t.timeLabel===label).first();
  if(existing){
    // Ê∑ªÂä†‰∫ã‰ª∂Âà∞ÁèæÊúâÊôÇÈñìÈªû
    const events=existing.events||[];
    if(event)events.push(event);
    await db.timeline.update(existing.id,{events});
  }else{
    // ÂâµÂª∫Êñ∞ÊôÇÈñìÈªû
    const count=await db.timeline.where('storyId').equals(story.id).count();
    const tl={
      id:crypto.randomUUID(),
      storyId:story.id,
      timeLabel:label,
      events:event?[event]:[],
      order:count,
      messageId:msgs[msgs.length-1]?.id,
      createdAt:Date.now()
    };
    await db.timeline.add(tl);
  }
  
  // Ë®≠ÁÇ∫Áï∂ÂâçÊôÇÈñì
  if(setCurrent){
    story.storyTime=label;
    await db.stories.update(story.id,{storyTime:label});
  }
  
  closeModal('timeline-modal');
  toast(T('ÊôÇÈñìÈªûÂ∑≤Ê∑ªÂä†'),'success');
  renderTimeline();
}

async function timeJump(){
  if(!story){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'),'warning');return;}
  showInputDialog('ÊôÇÈñìË∑≥Ë∫ç','Ëº∏ÂÖ•Ë¶ÅË∑≥ËΩâÂà∞ÁöÑÊôÇÈñìÔºà‰æãÂ¶ÇÔºö‰∏âÂ§©Âæå„ÄÅ‰∏ÄÊúàÂçÅÊó•Ôºâ',async(input)=>{
    if(!input)return;
    showLoading('Ê≠£Âú®ËÆì AI ËôïÁêÜÊôÇÈñìË∑≥Ë∫ç...');
    try{
      const prompt=`ÊïÖ‰∫ãÊôÇÈñìÂæû„Äå${story.storyTime||'Êú™Áü•'}„ÄçË∑≥Ë∫çÂà∞„Äå${input}„Äç„ÄÇ
Ë´ãÁ∞°Áü≠ÊèèËø∞ÈÄôÊÆµÊôÇÈñìÂÖßÂèØËÉΩÁôºÁîüÁöÑ‰∫ãÊÉÖÔºà2-3Âè•Ë©±ÔºâÔºå‰ª•ÂèäÁï∂ÂâçÁöÑÂ†¥ÊôØÁãÄÊ≥Å„ÄÇ
‰øùÊåÅËàáÊïÖ‰∫ãÈ¢®Ê†º‰∏ÄËá¥„ÄÇ`;
      const resp=await callApi(prompt);
      hideLoading();
      
      // Êõ¥Êñ∞ÊïÖ‰∫ãÊôÇÈñì
      story.storyTime=input;
      await db.stories.update(story.id,{storyTime:input});
      
      // Ê∑ªÂä†Âà∞ÊôÇÈñìËª∏
      const count=await db.timeline.where('storyId').equals(story.id).count();
      await db.timeline.add({
        id:crypto.randomUUID(),
        storyId:story.id,
        timeLabel:input,
        events:['ÊôÇÈñìË∑≥Ë∫ç'],
        order:count,
        createdAt:Date.now()
      });
      
      // Ê∑ªÂä† AI ÁîüÊàêÁöÑÂÖßÂÆπ‰ΩúÁÇ∫Ê∂àÊÅØ
      const aiMsg={id:crypto.randomUUID(),storyId:story.id,branchId:story.currentBranchId,role:'assistant',content:`‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ${input} ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n${resp.content}`,tokens:resp.tokens,createdAt:Date.now()};
      await db.messages.add(aiMsg);
      msgs.push(aiMsg);
      renderMsgs();
      
      toast(T('ÊôÇÈñìË∑≥Ë∫çÂÆåÊàê'),'success');
      renderTimeline();
    }catch(e){
      hideLoading();
      toast('ÊôÇÈñìË∑≥Ë∫çÂ§±Êïó: '+e.message,'error');
    }
  });
}

// ‰ºèÁ≠Ü/‰∫ã‰ª∂
let fTab='foreshadow';
let currentForeshadowId=null; // Áï∂ÂâçÁ∑®ËºØÁöÑ‰ºèÁ≠Ü ID

async function renderForeshadow(){
  if(!story)return;
  const c=document.getElementById('foreshadow-content');
  if(fTab==='foreshadow'){
    const fs=await db.foreshadowing.where('storyId').equals(story.id).toArray();
    const unres=fs.filter(f=>!f.isResolved),res=fs.filter(f=>f.isResolved);

    // Ê∑ªÂä†Â∑•ÂÖ∑Ê¨Ñ
    let html='<div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">';
    html+='<button class="action-btn secondary" onclick="showForeshadowTimeline()">üìÖ ÊôÇÈñìÁ∑ö</button>';
    html+='<button class="action-btn secondary" onclick="aiAutoExtractForeshadows()">ü§ñ AI ÊèêÂèñ</button>';
    html+='<button class="action-btn secondary" onclick="aiCheckForeshadowConflicts()">‚ö†Ô∏è Ë°ùÁ™ÅÊ™¢Ê∏¨</button>';
    html+='<button class="action-btn secondary" onclick="exportForeshadowReport()">üì§ Â∞éÂá∫Â†±Âëä</button>';
    html+='</div>';

    html+='<div class="section-title"><span>üìå</span><span>Êú™ÂõûÊî∂ÁöÑ‰ºèÁ≠Ü</span></div>';
    if(!unres.length)html+='<div style="text-align:center;padding:20px;color:var(--text-tertiary)">Êö´ÁÑ°</div>';
    else unres.forEach(f=>{
      const urgency=calculateForeshadowUrgency(f);
      const urgencyIcon={critical:'üî¥',warning:'‚ö†Ô∏è',notice:'üü°',normal:'üíú'}[urgency]||'üíú';
      const priorityBadge=f.priority?`<span style="font-size:10px;padding:2px 6px;background:var(--bg-tertiary);border-radius:4px;margin-left:4px">${{urgent:'üî¥Á∑äÊÄ•',high:'üü†È´ò',medium:'üü°‰∏≠',low:'üü¢‰Ωé'}[f.priority]||''}</span>`:'';
      html+=`<div class="f-card ${urgency==='critical'?'warning':''}" onclick="showForeshadowDetail('${f.id}')" style="cursor:pointer">
        <div class="f-card-header">
          <span class="f-card-icon">${urgencyIcon}</span>
          <span class="f-card-title">${esc(f.title)}${priorityBadge}</span>
        </div>
        <div class="f-card-desc">${esc(f.description||'ÁÑ°ÊèèËø∞')}</div>
        <div class="f-card-meta">
          <span>üìç ${esc(f.timeLabel||'')}</span>
          <span>Â∑≤ÈÅé ${f.mentionCount||0} Ê¢ùÂ∞çË©±</span>
          ${f.tags&&f.tags.length?`<span>üè∑Ô∏è ${f.tags.slice(0,2).join(', ')}</span>`:''}
        </div>
      </div>`;
    });

    if(res.length){
      html+=`<div class="section-title" style="margin-top:20px"><span>‚úÖ</span><span>Â∑≤ÂõûÊî∂ (${res.length})</span></div>`;
      res.forEach(f=>{
        html+=`<div class="f-card resolved" onclick="showForeshadowDetail('${f.id}')" style="cursor:pointer">
          <div class="f-card-header">
            <span class="f-card-icon">‚úì</span>
            <span class="f-card-title">${esc(f.title)}</span>
          </div>
          <div class="f-card-desc">Â∑≤ÂõûÊî∂</div>
        </div>`;
      });
    }
    c.innerHTML=html;
  }else{
    const evts=await db.events.where('storyId').equals(story.id).reverse().toArray();
    let html='<div class="section-title"><span>üìã</span><span>ÈáçË¶Å‰∫ã‰ª∂Ë®òÈåÑ</span></div>';
    if(!evts.length)html+='<div style="text-align:center;padding:40px;color:var(--text-tertiary)">Êö´ÁÑ°</div>';
    else evts.forEach(e=>{const icons={character_change:'üíÄ',relation_change:'ü§ù',plot_twist:'‚ö°',other:'üìù'};html+=`<div class="f-card"><div class="f-card-header"><span class="f-card-icon">${icons[e.eventType]||'üìù'}</span><span class="f-card-title">${esc(e.title)}</span></div><div class="f-card-desc">${esc(e.description)}</div><div class="f-card-meta"><span>üìç ${esc(e.storyTime||'')}</span></div></div>`;});
    c.innerHTML=html;
  }
}

// Ë®àÁÆó‰ºèÁ≠ÜÁ∑äÊÄ•Â∫¶
function calculateForeshadowUrgency(foreshadow){
  const age=foreshadow.mentionCount||0;
  const priority=foreshadow.priority||'medium';

  const urgencyThresholds={
    urgent:10,
    high:20,
    medium:30,
    low:50
  };

  const threshold=urgencyThresholds[priority];

  if(age>threshold*1.5)return 'critical';
  if(age>threshold)return 'warning';
  if(age>threshold*0.7)return 'notice';
  return 'normal';
}
function switchFTab(t,el){fTab=t;document.querySelectorAll('#view-foreshadow .tab-btn').forEach(b=>b.classList.remove('active'));el.classList.add('active');renderForeshadow();}

// Ê∑ªÂä†‰ºèÁ≠ÜÊàñ‰∫ã‰ª∂
function addForeshadowOrEvent(){
  if(!story){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'),'warning');return;}
  if(fTab==='foreshadow'){
    showInputDialog('Ê∑ªÂä†‰ºèÁ≠Ü','Ëº∏ÂÖ•‰ºèÁ≠ÜÊ®ôÈ°å',async(title)=>{
      if(!title)return;
      showInputDialog('‰ºèÁ≠ÜÊèèËø∞','ÊèèËø∞ÈÄôÂÄã‰ºèÁ≠ÜÁöÑÂÖßÂÆπÔºàÂèØÈÅ∏Ôºâ',async(desc)=>{
        const f={id:crypto.randomUUID(),storyId:story.id,messageId:msgs[msgs.length-1]?.id,title,description:desc||'',isResolved:false,mentionCount:0,timeLabel:story.storyTime,createdAt:Date.now()};
        await db.foreshadowing.add(f);
        toast(T('‰ºèÁ≠ÜÂ∑≤Ê∑ªÂä†'),'success');
        renderForeshadow();
      });
    });
  }else{
    showInputDialog('Ê∑ªÂä†‰∫ã‰ª∂','Ëº∏ÂÖ•‰∫ã‰ª∂Ê®ôÈ°å',async(title)=>{
      if(!title)return;
      showInputDialog('‰∫ã‰ª∂ÊèèËø∞','ÊèèËø∞ÈÄôÂÄã‰∫ã‰ª∂ÔºàÂèØÈÅ∏Ôºâ',async(desc)=>{
        const e={id:crypto.randomUUID(),storyId:story.id,messageId:msgs[msgs.length-1]?.id,title,description:desc||'',eventType:'other',storyTime:story.storyTime,createdAt:Date.now()};
        await db.events.add(e);
        toast(T('‰∫ã‰ª∂Â∑≤Ê∑ªÂä†'),'success');
        renderForeshadow();
      });
    });
  }
}

// AI ÂàÜÊûê‰ºèÁ≠Ü
async function aiAnalyzeForeshadow(){
  if(!story){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'),'warning');return;}

  // Ê™¢Êü•ÊòØÂê¶ÊúâË∂≥Â§†ÁöÑÊ∂àÊÅØ
  if(!msgs || msgs.length < 3){
    toast('Ê∂àÊÅØÂ§™Â∞ëÔºåÁÑ°Ê≥ïÈÄ≤Ë°åÂàÜÊûêÔºàËá≥Â∞ëÈúÄË¶Å3Ê¢ùÊ∂àÊÅØÔºâ','warning');
    return;
  }

  showLoading('AI Ê≠£Âú®Ê™¢Ê∏¨‰ºèÁ≠ÜÂõûÊî∂ÁãÄÊÖã...');
  try{
    const fs=await db.foreshadowing.where('storyId').equals(story.id).filter(f=>!f.isResolved).toArray();

    if(fs.length === 0){
      hideLoading();
      toast('ÁõÆÂâçÊ≤íÊúâÂæÖÂõûÊî∂ÁöÑ‰ºèÁ≠Ü','info');
      return;
    }

    // Áç≤ÂèñÊõ¥Â§ö‰∏ä‰∏ãÊñáÔºàÊúÄËøë30Ê¢ùÊ∂àÊÅØÔºâ
    const recentMsgs = msgs.slice(-30);

    const prompt=`‰Ω†ÊòØ‰∏ÄÂÄãÂ∞àÊ•≠ÁöÑÊïÖ‰∫ãÂàÜÊûêAIÔºåË´ãÂàÜÊûê‰ª•‰∏ãÊïÖ‰∫ã‰∏≠ÁöÑ‰ºèÁ≠ÜÁãÄÊÖã„ÄÇ

# ÂæÖÊ™¢Êü•ÁöÑ‰ºèÁ≠Ü
${fs.map((f,i)=>`${i+1}. **${f.title}**
   - ÊèèËø∞Ôºö${f.description||'ÁÑ°ÊèèËø∞'}
   - Â∑≤ÈÅéÂ∞çË©±Ôºö${f.mentionCount||0}Ê¢ù
   - ID: ${f.id}`).join('\n\n')}

# ÊúÄËøëÁöÑÊïÖ‰∫ãÂÖßÂÆπÔºàÊúÄËøë30Ê¢ùÂ∞çË©±Ôºâ
${recentMsgs.map((m,i)=>`[${i+1}] ${m.role==='user'?'Áé©ÂÆ∂':'AI'}Ôºö${m.content.slice(0,300)}`).join('\n\n')}

# ‰ªªÂãô
Ë´ã‰ªîÁ¥∞ÂàÜÊûêÊúÄËøëÁöÑÂ∞çË©±ÂÖßÂÆπÔºåÂà§Êñ∑ÊØèÂÄã‰ºèÁ≠ÜÁöÑÁãÄÊÖã„ÄÇ

**ÈáçË¶ÅÔºöË´ãÂö¥Ê†ºÊåâÁÖß‰ª•‰∏ãJSONÊ†ºÂºèÂõûÂæ©Ôºå‰∏çË¶ÅÊ∑ªÂä†‰ªª‰ΩïÂÖ∂‰ªñÊñáÂ≠óÔºö**

\`\`\`json
{
  "resolved": [
    {
      "id": "‰ºèÁ≠ÜID",
      "title": "‰ºèÁ≠ÜÊ®ôÈ°å",
      "reason": "ÁÇ∫‰ªÄÈ∫ºÂà§Êñ∑Â∑≤ÂõûÊî∂ÔºàÂºïÁî®ÂÖ∑È´îÂ∞çË©±ÂÖßÂÆπÔºâ",
      "resolvedInMessage": "Âú®Âì™Ê¢ùÊ∂àÊÅØ‰∏≠ÂõûÊî∂ÔºàÁ∞°Ëø∞Ôºâ"
    }
  ],
  "needAttention": [
    {
      "id": "‰ºèÁ≠ÜID",
      "title": "‰ºèÁ≠ÜÊ®ôÈ°å",
      "urgency": "high/medium/low",
      "reason": "ÁÇ∫‰ªÄÈ∫ºÈúÄË¶ÅÈóúÊ≥®",
      "suggestion": "ÂõûÊî∂Âª∫Ë≠∞"
    }
  ],
  "summary": "Á∏ΩÈ´îÂàÜÊûêÊëòË¶Å"
}
\`\`\`

**Âà§Êñ∑Ê®ôÊ∫ñÔºö**
- **resolvedÔºàÂ∑≤ÂõûÊî∂Ôºâ**Ôºö‰ºèÁ≠ÜÂú®Â∞çË©±‰∏≠Â∑≤Á∂ìË¢´ÊòéÁ¢∫ÊèêÂèä„ÄÅËß£Ê±∫ÊàñÊè≠Á§∫Á≠îÊ°à
- **needAttentionÔºàÈúÄË¶ÅÈóúÊ≥®Ôºâ**Ôºö
  - high: Â∑≤ÈÅé20Ê¢ùÂ∞çË©±‰∏îËàáÁï∂ÂâçÂäáÊÉÖÁõ∏ÈóúÔºåÊáâÂÑòÂø´ÂõûÊî∂
  - medium: Â∑≤ÈÅé10Ê¢ùÂ∞çË©±Ôºå‰∏çË¶ÅÂøòË®ò
  - low: ÂâõË®≠‰∏ã‰∏ç‰πÖÔºåÂèØ‰ª•ÊÖ¢ÊÖ¢Èã™Â¢ä`;

    const resp=await callApi(prompt);
    hideLoading();

    // Ëß£ÊûêAIÂõûÂæ©
    await parseForeshadowAnalysis(resp.content, fs);

  }catch(e){
    hideLoading();
    toast('ÂàÜÊûêÂ§±Êïó: '+e.message,'error');
  }
}

// Ëß£ÊûêAI‰ºèÁ≠ÜÂàÜÊûêÁµêÊûú
async function parseForeshadowAnalysis(content, originalForeshadows){
  try{
    // ÂòóË©¶ÂæûÂõûË¶Ü‰∏≠ÊèêÂèñJSON
    const jsonMatch = content.match(/```json\s*([\s\S]*?)\s*```/);
    let analysis;

    if(jsonMatch){
      analysis = JSON.parse(jsonMatch[1]);
    } else {
      // Â¶ÇÊûúÊ≤íÊúâJSONÊ†ºÂºèÔºåÂòóË©¶Áõ¥Êé•Ëß£Êûê
      analysis = JSON.parse(content);
    }

    const resolved = analysis.resolved || [];
    const needAttention = analysis.needAttention || [];
    const summary = analysis.summary || '';

    // Â¶ÇÊûúÊ™¢Ê∏¨Âà∞Â∑≤ÂõûÊî∂ÁöÑ‰ºèÁ≠ÜÔºåÈ°ØÁ§∫Á¢∫Ë™çÂ∞çË©±Ê°Ü
    if(resolved.length > 0){
      showForeshadowResolvedConfirm(resolved, needAttention, summary);
    } else {
      // Ê≤íÊúâÂ∑≤ÂõûÊî∂ÁöÑÔºåÂè™È°ØÁ§∫ÂàÜÊûêÁµêÊûú
      showForeshadowAnalysisResult(needAttention, summary);
    }

  }catch(e){
    console.error('Ëß£ÊûêAIÂõûÂæ©Â§±Êïó:', e);
    // Â¶ÇÊûúËß£ÊûêÂ§±ÊïóÔºåÈ°ØÁ§∫ÂéüÂßãÂõûÂæ©
    showAlert('AI ‰ºèÁ≠ÜÂàÜÊûê', content);
  }
}

// È°ØÁ§∫‰ºèÁ≠ÜÂõûÊî∂Á¢∫Ë™çÂ∞çË©±Ê°Ü
function showForeshadowResolvedConfirm(resolved, needAttention, summary){
  const modal = document.getElementById('foreshadow-resolved-confirm-modal');
  if(!modal){
    console.error('Modal foreshadow-resolved-confirm-modal not found');
    return;
  }

  // Â°´ÂÖÖÂ∑≤ÂõûÊî∂ÁöÑ‰ºèÁ≠ÜÂàóË°®
  const listEl = document.getElementById('resolved-foreshadow-list');
  if(!listEl){
    console.error('Element resolved-foreshadow-list not found');
    return;
  }

  listEl.innerHTML = resolved.map(f => {
    const safeReason = escHtml(f.reason || '').replace(/\n/g, '<br>');
    const safeResolved = escHtml(f.resolvedInMessage || 'Ë¶ãÊúÄËøëÂ∞çË©±').replace(/\n/g, '<br>');
    return `
    <div class="resolved-item" style="background:var(--bg-tertiary);padding:12px;border-radius:8px;margin-bottom:10px">
      <label style="display:flex;align-items:flex-start;gap:10px;cursor:pointer">
        <input type="checkbox" class="resolved-checkbox" data-id="${escAttr(f.id)}" checked>
        <div style="flex:1">
          <div style="font-weight:600;margin-bottom:4px">‚úÖ ${escHtml(f.title)}</div>
          <div style="font-size:12px;color:var(--text-secondary);margin-bottom:4px">${safeReason}</div>
          <div style="font-size:11px;color:var(--text-tertiary)">üìç ${safeResolved}</div>
        </div>
      </label>
    </div>
  `;}).join('');

  // Â°´ÂÖÖÂàÜÊûêÊëòË¶Å
  const summaryEl = document.getElementById('foreshadow-analysis-summary');
  if(!summaryEl){
    console.error('Element foreshadow-analysis-summary not found');
    return;
  }

  // ‰øùÁïôÊèõË°åÁ¨¶ÁöÑËΩâÁæ©
  const safeSummary = escHtml(summary).replace(/\n/g, '<br>');
  let summaryHtml = `<div style="margin-bottom:16px;padding:12px;background:rgba(139,124,247,0.1);border-radius:8px">
    <div style="font-weight:600;margin-bottom:8px">üìä ÂàÜÊûêÊëòË¶Å</div>
    <div style="font-size:13px;line-height:1.6">${safeSummary}</div>
  </div>`;

  // Ê∑ªÂä†ÈúÄË¶ÅÈóúÊ≥®ÁöÑ‰ºèÁ≠Ü
  if(needAttention.length > 0){
    summaryHtml += `<div style="margin-top:16px">
      <div style="font-weight:600;margin-bottom:8px">‚ö†Ô∏è ÈúÄË¶ÅÈóúÊ≥®ÁöÑ‰ºèÁ≠Ü</div>`;
    needAttention.forEach(f => {
      const urgencyColor = {high:'#EF4444',medium:'#F59E0B',low:'#10B981'}[f.urgency] || '#9CA3AF';
      const urgencyText = {high:'Á∑äÊÄ•',medium:'‰∏≠Á≠â',low:'‰Ωé'}[f.urgency] || 'Êú™Áü•';
      const safeReason = escHtml(f.reason || '').replace(/\n/g, '<br>');
      const safeSuggestion = escHtml(f.suggestion || '').replace(/\n/g, '<br>');
      summaryHtml += `
        <div style="padding:10px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:8px;border-left:3px solid ${urgencyColor}">
          <div style="font-weight:500;margin-bottom:4px">${escHtml(f.title)} <span style="font-size:11px;color:${urgencyColor}">[${urgencyText}]</span></div>
          <div style="font-size:12px;color:var(--text-secondary);margin-bottom:4px">${safeReason}</div>
          <div style="font-size:11px;color:var(--text-tertiary)">üí° ${safeSuggestion}</div>
        </div>`;
    });
    summaryHtml += `</div>`;
  }

  summaryEl.innerHTML = summaryHtml;

  showModal('foreshadow-resolved-confirm-modal');
}

// È°ØÁ§∫‰ºèÁ≠ÜÂàÜÊûêÁµêÊûúÔºàÊ≤íÊúâÂ∑≤ÂõûÊî∂ÁöÑÊÉÖÊ≥ÅÔºâ
function showForeshadowAnalysisResult(needAttention, summary){
  // ‰øùÁïôÊèõË°åÁ¨¶ÁöÑËΩâÁæ©
  const safeSummary = escHtml(summary).replace(/\n/g, '<br>');
  let content = `<div style="margin-bottom:16px">
    <strong>üìä ÂàÜÊûêÊëòË¶Å</strong>
    <div style="margin-top:8px;line-height:1.6">${safeSummary}</div>
  </div>`;

  if(needAttention.length > 0){
    content += `<div style="margin-top:16px">
      <strong>‚ö†Ô∏è ÈúÄË¶ÅÈóúÊ≥®ÁöÑ‰ºèÁ≠Ü</strong>`;
    needAttention.forEach(f => {
      const urgencyColor = {high:'#EF4444',medium:'#F59E0B',low:'#10B981'}[f.urgency] || '#9CA3AF';
      const urgencyText = {high:'Á∑äÊÄ•',medium:'‰∏≠Á≠â',low:'‰Ωé'}[f.urgency] || 'Êú™Áü•';
      const safeReason = escHtml(f.reason || '').replace(/\n/g, '<br>');
      const safeSuggestion = escHtml(f.suggestion || '').replace(/\n/g, '<br>');
      content += `
        <div style="padding:10px;background:var(--bg-tertiary);border-radius:8px;margin-top:8px;border-left:3px solid ${urgencyColor}">
          <div style="font-weight:500">${escHtml(f.title)} <span style="font-size:11px;color:${urgencyColor}">[${urgencyText}]</span></div>
          <div style="font-size:12px;color:var(--text-secondary);margin-top:4px">${safeReason}</div>
          <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">üí° ${safeSuggestion}</div>
        </div>`;
    });
    content += `</div>`;
  } else {
    content += `<div style="margin-top:16px;padding:12px;background:rgba(16,185,129,0.1);border-radius:8px;color:#10B981">
      ‚úÖ ÊâÄÊúâ‰ºèÁ≠ÜÁãÄÊÖãËâØÂ•ΩÔºåÊö´ÊôÇ‰∏çÈúÄË¶ÅÁâπÂà•ÈóúÊ≥®
    </div>`;
  }

  showAlert('AI ‰ºèÁ≠ÜÂàÜÊûê', content);
}

// ÊâπÈáèÊ®ôË®ò‰ºèÁ≠ÜÁÇ∫Â∑≤ÂõûÊî∂
async function batchMarkForeshadowResolved(){
  const checkboxes = document.querySelectorAll('.resolved-checkbox:checked');
  const ids = Array.from(checkboxes).map(cb => cb.dataset.id);

  if(ids.length === 0){
    toast('Ë´ãËá≥Â∞ëÈÅ∏Êìá‰∏ÄÂÄã‰ºèÁ≠Ü','warning');
    return;
  }

  try{
    showLoading('Ê≠£Âú®Ê®ôË®ò...');
    const now = Date.now();

    // ÊâπÈáèÊõ¥Êñ∞
    await Promise.all(ids.map(id =>
      db.foreshadowing.update(id, {
        isResolved: true,
        resolvedAt: now
      })
    ));

    hideLoading();
    closeModal('foreshadow-resolved-confirm-modal');
    toast(`Â∑≤Ê®ôË®ò ${ids.length} ÂÄã‰ºèÁ≠ÜÁÇ∫Â∑≤ÂõûÊî∂`,'success');

    // Âà∑Êñ∞‰ºèÁ≠ÜÂàóË°®
    if(document.getElementById('view-foreshadow').classList.contains('active')){
      renderForeshadow();
    }
  }catch(e){
    hideLoading();
    toast('Ê®ôË®òÂ§±Êïó: ' + e.message, 'error');
  }
}

// È°ØÁ§∫‰ºèÁ≠ÜË©≥ÊÉÖ
async function showForeshadowDetail(foreshadowId){
  try{
    const f=await db.foreshadowing.get(foreshadowId);
    if(!f){
      toast('‰ºèÁ≠Ü‰∏çÂ≠òÂú®','error');
      return;
    }

    currentForeshadowId=foreshadowId;

    // Â°´ÂÖÖË°®ÂñÆ
    document.getElementById('f-detail-title').value=f.title||'';
    document.getElementById('f-detail-desc').value=f.description||'';
    document.getElementById('f-detail-time').textContent=f.timeLabel||'Êú™Áü•';
    document.getElementById('f-detail-status').value=f.isResolved?'true':'false';
    document.getElementById('f-detail-priority').value=f.priority||'medium';
    document.getElementById('f-detail-tags').value=(f.tags||[]).join(', ');
    document.getElementById('f-detail-plan').value=f.plan||'';
    document.getElementById('f-detail-count').textContent=f.mentionCount||0;
    document.getElementById('f-detail-created').textContent=new Date(f.createdAt).toLocaleString();

    // È°ØÁ§∫/Èö±ËóèÂõûÊî∂‰ø°ÊÅØ
    const resolvedInfo=document.getElementById('f-detail-resolved-info');
    if(resolvedInfo){
      if(f.isResolved&&f.resolvedAt){
        resolvedInfo.style.display='block';
        document.getElementById('f-detail-resolved-time').textContent=new Date(f.resolvedAt).toLocaleString();
      }else{
        resolvedInfo.style.display='none';
      }
    }

    // Â°´ÂÖÖËßíËâ≤ÂàóË°®
    const chars=await db.characters.where('storyId').equals(story.id).toArray();
    const charSelect=document.getElementById('f-detail-characters');
    if(charSelect){
      charSelect.innerHTML=chars.map(c=>`<option value="${c.id}" ${(f.relatedCharacters||[]).includes(c.id)?'selected':''}>${c.avatar||'üë§'} ${esc(c.name)}</option>`).join('');
    }

    showModal('foreshadow-detail-modal');
  }catch(e){
    console.error('[Foreshadow] È°ØÁ§∫Ë©≥ÊÉÖÂ§±Êïó:',e);
    toast('ËºâÂÖ•Â§±Êïó: '+e.message,'error');
  }
}

// ‰øùÂ≠ò‰ºèÁ≠ÜË©≥ÊÉÖ
async function saveForeshadowDetail(){
  if(!currentForeshadowId)return;

  try{
    const title=document.getElementById('f-detail-title').value.trim();
    if(!title){
      toast('Ê®ôÈ°å‰∏çËÉΩÁÇ∫Á©∫','warning');
      return;
    }

    const currentData=await db.foreshadowing.get(currentForeshadowId);
    if(!currentData){
      toast('‰ºèÁ≠Ü‰∏çÂ≠òÂú®','error');
      return;
    }

    const wasResolved=currentData.isResolved;
    const isResolved=document.getElementById('f-detail-status').value==='true';

    const updateData={
      title,
      description:document.getElementById('f-detail-desc').value.trim(),
      isResolved,
      priority:document.getElementById('f-detail-priority').value,
      tags:document.getElementById('f-detail-tags').value.split(',').map(t=>t.trim()).filter(t=>t),
      plan:document.getElementById('f-detail-plan').value.trim(),
      relatedCharacters:Array.from(document.getElementById('f-detail-characters').selectedOptions).map(o=>o.value),
      updatedAt:Date.now()
    };

    // Â¶ÇÊûúÂæûÊú™ÂõûÊî∂ËÆäÁÇ∫Â∑≤ÂõûÊî∂ÔºåË®òÈåÑÂõûÊî∂ÊôÇÈñì
    if(!wasResolved&&isResolved){
      updateData.resolvedAt=Date.now();
    }

    await db.foreshadowing.update(currentForeshadowId,updateData);

    closeModal('foreshadow-detail-modal');
    toast('‰ºèÁ≠ÜÂ∑≤Êõ¥Êñ∞','success');
    renderForeshadow();
    currentForeshadowId=null;
  }catch(e){
    console.error('[Foreshadow] ‰øùÂ≠òÂ§±Êïó:',e);
    toast('‰øùÂ≠òÂ§±Êïó: '+e.message,'error');
  }
}

// Âà™Èô§‰ºèÁ≠Ü
async function deleteForeshadowDetail(){
  if(!currentForeshadowId)return;

  showConfirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄã‰ºèÁ≠ÜÂóéÔºü',async()=>{
    await db.foreshadowing.delete(currentForeshadowId);
    closeModal('foreshadow-detail-modal');
    toast('‰ºèÁ≠ÜÂ∑≤Âà™Èô§','success');
    renderForeshadow();
    currentForeshadowId=null;
  });
}

// Ë∑≥ËΩâÂà∞‰ºèÁ≠ÜÂéüÊ∂àÊÅØ
function jumpToForeshadowMessage(){
  if(!currentForeshadowId)return;

  db.foreshadowing.get(currentForeshadowId).then(f=>{
    if(f&&f.messageId){
      closeModal('foreshadow-detail-modal');
      jumpToMessage(f.messageId);
    }else{
      toast('Êâæ‰∏çÂà∞ÂéüÊ∂àÊÅØ','warning');
    }
  }).catch(err=>{
    console.error('[Foreshadow] Ë∑≥ËΩâÂ§±Êïó:',err);
    toast('Ë∑≥ËΩâÂ§±Êïó','error');
  });
}

// AI ÁîüÊàêÂõûÊî∂ÊñπÊ°à
async function aiGenerateRecoveryPlan(){
  if(!currentForeshadowId)return;

  const f=await db.foreshadowing.get(currentForeshadowId);
  if(!f)return;

  showLoading('AI Ê≠£Âú®ÁîüÊàêÂõûÊî∂ÊñπÊ°à...');

  try{
    const recentContext=msgs.slice(-10).map(m=>m.content).join('\n\n');

    const prompt=`Áï∂ÂâçÊïÖ‰∫ãÊÉÖÊ≥ÅÔºö
${recentContext}

ÈúÄË¶ÅÂõûÊî∂ÁöÑ‰ºèÁ≠ÜÔºö
Ê®ôÈ°åÔºö${f.title}
ÊèèËø∞Ôºö${f.description||'ÁÑ°'}
Âüã‰∏ãÊôÇÈñìÔºö${f.timeLabel||'Êú™Áü•'}
Â∑≤ÈÅéÂ∞çË©±Êï∏Ôºö${f.mentionCount||0}

Ë´ãÊèê‰æõ 3 Á®Æ‰∏çÂêåÁöÑÂõûÊî∂ÊñπÊ°àÔºö

## ÊñπÊ°à‰∏ÄÔºöËá™ÁÑ∂ÂõûÊî∂
Â¶Ç‰ΩïÂú®Áï∂ÂâçÂäáÊÉÖ‰∏≠Ëá™ÁÑ∂Âú∞ÂõûÊî∂ÈÄôÂÄã‰ºèÁ≠Ü

## ÊñπÊ°à‰∫åÔºöÈ´òÊΩÆÂõûÊî∂
Â¶Ç‰ΩïÂ∞áÈÄôÂÄã‰ºèÁ≠Ü‰ΩúÁÇ∫ÂäáÊÉÖÈ´òÊΩÆÂõûÊî∂

## ÊñπÊ°à‰∏âÔºöÂª∂ÂæåÂõûÊî∂
Â¶Ç‰ΩïÁÇ∫ÂæåÁ∫åÂõûÊî∂ÂÅöÈã™Â¢ä

ÊØèÂÄãÊñπÊ°àÂåÖÊã¨Ôºö
- ÂÖ∑È´îÊ≠•È©ü
- È†êÊúüÊïàÊûú
- Ê≥®ÊÑè‰∫ãÈ†Ö`;

    const resp=await callApi(prompt);
    hideLoading();

    // Â∞áÊñπÊ°àÂ°´ÂÖ•Ë®àÂäÉÊ¨Ñ
    document.getElementById('f-detail-plan').value=resp.content;

    // ÂêåÊôÇ‰øùÂ≠òÂà∞Êï∏ÊìöÂ∫´
    await db.foreshadowing.update(currentForeshadowId,{
      aiPlan:resp.content,
      updatedAt:Date.now()
    });

    toast('ÂõûÊî∂ÊñπÊ°àÂ∑≤ÁîüÊàê','success');
  }catch(e){
    hideLoading();
    toast('ÁîüÊàêÂ§±Êïó: '+e.message,'error');
  }
}

// AI Ëá™ÂãïÊèêÂèñ‰ºèÁ≠ÜÔºàÊîπËøõÁâàÔºöÂÖàÂàÜÊûêÂêéÊèêÂèñÔºâ
async function aiAutoExtractForeshadows(){
  if(!story){toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã','warning');return;}

  // Ê™¢Êü•Ê∂àÊÅØÊï∏Èáè
  if(!msgs||msgs.length===0){
    toast('Êö´ÁÑ°Â∞çË©±ÂÖßÂÆπÂèØÂàÜÊûê','info');
    return;
  }

  showLoading('AI Ê≠£Âú®ÂàÜÊûêÂ∞çË©±...');

  try{
    const recentMessages=msgs.slice(-20);

    if(recentMessages.length===0){
      hideLoading();
      toast('Ê≤íÊúâË∂≥Â§†ÁöÑÂ∞çË©±ÂÖßÂÆπ','info');
      return;
    }

    // Áç≤ÂèñÂ∑≤Êúâ‰ºèÁ≠ÜÔºåÈÅøÂÖçÈáçË§á
    const existingForeshadows=await db.foreshadowing
      .where('storyId').equals(story.id)
      .toArray();

    // ÊîπÈÄ≤ÔºöÂÇ≥ÈÅûÂÆåÊï¥ÁöÑ‰ºèÁ≠Ü‰ø°ÊÅØÔºàÊ®ôÈ°å+ÊèèËø∞Ôºâ
    const existingInfo = existingForeshadows.length > 0
      ? existingForeshadows.map(f => `- ${f.title}Ôºö${f.description || 'ÁÑ°ÊèèËø∞'}`).join('\n')
      : 'ÁÑ°';

    // Á¨¨‰∏ÄÊ≠•ÔºöÂÖàÈÄ≤Ë°åÈñãÊîæÂºèÂàÜÊûêÔºåÊâæÂá∫ÊâÄÊúâÊΩõÂú®‰ºèÁ≠Ü
    const analysisPrompt=`‰Ω†ÊòØ‰∏ÄÂÄãÂ∞àÊ•≠ÁöÑÊïÖ‰∫ãÂàÜÊûêÂ∏´„ÄÇË´ã‰ªîÁ¥∞Èñ±ËÆÄ‰ª•‰∏ãÂ∞çË©±ÂÖßÂÆπÔºåÊâæÂá∫ÊâÄÊúâ**Â∞öÊú™Ëß£Ê±∫ÁöÑ‰ºèÁ≠ÜÂíåÊá∏Âøµ**„ÄÇ

## Â∞çË©±ÂÖßÂÆπ
${recentMessages.map((m,i)=>`[${i+1}] ${m.role==='user'?'Áé©ÂÆ∂':'ÂäáÊÉÖ'}Ôºö${m.content}`).join('\n\n')}

## Â∑≤Êúâ‰ºèÁ≠ÜÔºàË´ã‰ªîÁ¥∞Ê™¢Êü•ÔºåÈÅøÂÖçÊèêÂèñÈáçË§áÊàñÁõ∏‰ººÁöÑ‰ºèÁ≠ÜÔºâ
${existingInfo}

## ÂàÜÊûê‰ªªÂãô
Ë´ã‰ªîÁ¥∞ÂàÜÊûêÂ∞çË©±ÔºåÊâæÂá∫‰ª•‰∏ãÈ°ûÂûãÁöÑ‰ºèÁ≠ÜÔºö

1. **Êú™Ëß£‰πãË¨é**ÔºöÊèêÂà∞‰ΩÜÊú™Ëß£ÈáãÁöÑÁ•ûÁßò‰∫ãÁâ©„ÄÅÁèæË±°„ÄÅ‰∫∫Áâ©
2. **Êú™ÂÆåÊàêÁöÑ‰∫ã‰ª∂**ÔºöÈñãÂßã‰ΩÜÊú™ÁµêÊùüÁöÑÊÉÖÁØÄ„ÄÅ‰ªªÂãô„ÄÅË°åÂãï
3. **ÈáçË¶ÅÊâøË´æ**ÔºöËßíËâ≤ÂÅöÂá∫‰ΩÜÊú™ÂÖåÁèæÁöÑÊâøË´æ„ÄÅÁ¥ÑÂÆö
4. **Êú™ÈÅîÊàêÁöÑÁõÆÊ®ô**ÔºöË®≠ÂÆö‰ΩÜÊú™ÂÆåÊàêÁöÑÁõÆÊ®ô„ÄÅÈ°òÊúõ
5. **Âç±Ê©üÈ†êÂÖÜ**ÔºöÊöóÁ§∫Êú™‰æÜÂèØËÉΩÁôºÁîüÁöÑÂç±Ê©ü„ÄÅË°ùÁ™Å
6. **Êá∏ËÄåÊú™Ê±∫ÁöÑÂïèÈ°å**ÔºöÊèêÂá∫‰ΩÜÊú™ÂõûÁ≠îÁöÑÈáçË¶ÅÂïèÈ°å
7. **Á•ûÁßòÁ∑öÁ¥¢**ÔºöÂá∫Áèæ‰ΩÜÊú™Ëß£ÈáãÁöÑÁ∑öÁ¥¢„ÄÅÁâ©ÂìÅ„ÄÅ‰ø°ÊÅØ

Ë´ã‰ª•Ëá™ÁÑ∂Ë™ûË®ÄË©≥Á¥∞ÊèèËø∞‰Ω†ÁôºÁèæÁöÑÊØèÂÄã‰ºèÁ≠ÜÔºåÂåÖÊã¨Ôºö
- ÈÄôÂÄã‰ºèÁ≠ÜÊòØ‰ªÄÈ∫º
- Âú®Â∞çË©±‰∏≠Âì™Ë£°ÊèêÂà∞
- ÁÇ∫‰ªÄÈ∫ºÈáçË¶Å
- Âª∫Ë≠∞ÁöÑÂÑ™ÂÖàÁ¥ö

Ë´ãÁõ¥Êé•Ëº∏Âá∫ÂàÜÊûêÁµêÊûúÔºå‰∏çË¶ÅÊúâÂÖ∂‰ªñË™™Êòé„ÄÇ`;

    showLoading('AI Ê≠£Âú®Ê∑±Â∫¶ÂàÜÊûê...');
    const analysisResponse=await callApi(analysisPrompt);

    if(!analysisResponse||!analysisResponse.content){
      hideLoading();
      toast('AI ÂàÜÊûêÂ§±Êïó','error');
      return;
    }

    // Á¨¨‰∫åÊ≠•ÔºöÂü∫ÊñºÂàÜÊûêÁµêÊûúÔºåÊèêÂèñÁµêÊßãÂåñÁöÑ‰ºèÁ≠ÜÊï∏Êìö
    const extractPrompt=`Âü∫Êñº‰ª•‰∏ãÂàÜÊûêÁµêÊûúÔºåË´ãÊèêÂèñÂá∫ÁµêÊßãÂåñÁöÑ‰ºèÁ≠ÜÂàóË°®„ÄÇ

## AI ÂàÜÊûêÁµêÊûú
${analysisResponse.content}

## ÊèêÂèñË¶ÅÊ±Ç
1. Âè™ÊèêÂèñ**ÊòéÁ¢∫‰∏îÈáçË¶Å**ÁöÑ‰ºèÁ≠Ü
2. ÊØèÂÄã‰ºèÁ≠ÜÂøÖÈ†àÊúâÊ∏ÖÊô∞ÁöÑÊ®ôÈ°åÂíåÊèèËø∞
3. ÈÅøÂÖçÈÅéÊñºÁë£Á¢éÊàñ‰∏çÈáçË¶ÅÁöÑÂÖßÂÆπ
4. ÂÑ™ÂÖàÁ¥öË¶ÅÂêàÁêÜÔºàurgent/high/medium/lowÔºâ

Ë´ã‰ª• JSON Ê†ºÂºèËøîÂõûÔºö
\`\`\`json
{
  "foreshadows": [
    {
      "title": "Á∞°Áü≠Ê®ôÈ°åÔºà5-10Â≠óÔºâ",
      "description": "Ë©≥Á¥∞ÊèèËø∞ÈÄôÂÄã‰ºèÁ≠ÜÁöÑÂÖßÂÆπÂíåËÉåÊôØÔºà20-50Â≠óÔºâ",
      "keywords": ["ÈóúÈçµË©û1", "ÈóúÈçµË©û2"],
      "priority": "medium",
      "reason": "ÁÇ∫‰ªÄÈ∫ºÈÄôÊòØÈáçË¶ÅÁöÑ‰ºèÁ≠ÜÔºü"
    }
  ]
}
\`\`\`

Â¶ÇÊûúÊ≤íÊúâÁôºÁèæÊòéÈ°ØÁöÑÊñ∞‰ºèÁ≠ÜÔºåËøîÂõûÁ©∫Êï∏ÁµÑ„ÄÇ`;

    showLoading('AI Ê≠£Âú®ÊèêÂèñ‰ºèÁ≠Ü...');
    const extractResponse=await callApi(extractPrompt);
    hideLoading();

    if(!extractResponse||!extractResponse.content){
      toast('AI ÊèêÂèñÂ§±Êïó','error');
      return;
    }

    // Ëß£Êûê JSON
    const jsonMatch=extractResponse.content.match(/```json\s*([\s\S]*?)\s*```/);
    if(!jsonMatch){
      // Â¶ÇÊûúÊ≤íÊúâ JSONÔºåÈ°ØÁ§∫ÂàÜÊûêÁµêÊûúËÆìÁî®Êà∂Êü•Áúã
      showAlert('AI ÂàÜÊûêÁµêÊûú',analysisResponse.content+'\n\n---\n\nÊèêÂèñÂ§±ÊïóÔºåË´ãÊâãÂãïÊ∑ªÂä†‰ºèÁ≠Ü„ÄÇ');
      return;
    }

    let data;
    try{
      data=JSON.parse(jsonMatch[1]);
    }catch(parseError){
      console.error('[AI Extract] JSON Ëß£ÊûêÂ§±Êïó:',parseError);
      // È°ØÁ§∫ÂàÜÊûêÁµêÊûú
      showAlert('AI ÂàÜÊûêÁµêÊûú',analysisResponse.content+'\n\n---\n\nÊèêÂèñÂ§±ÊïóÔºåË´ãÊâãÂãïÊ∑ªÂä†‰ºèÁ≠Ü„ÄÇ');
      return;
    }

    if(!data.foreshadows||!Array.isArray(data.foreshadows)||data.foreshadows.length===0){
      // È°ØÁ§∫ÂàÜÊûêÁµêÊûúÔºåÂç≥‰ΩøÊ≤íÊúâÊèêÂèñÂà∞‰ºèÁ≠Ü
      showAlert('AI ÂàÜÊûêÁµêÊûú',analysisResponse.content+'\n\n---\n\nÊú™Ë≠òÂà•Âà∞ÊòéÈ°ØÁöÑÊñ∞‰ºèÁ≠Ü„ÄÇ');
      return;
    }

    // È°ØÁ§∫Âª∫Ë≠∞
    showForeshadowSuggestions(data.foreshadows);

  }catch(e){
    hideLoading();
    console.error('[AI Extract] ÈåØË™§:',e);
    toast('ÊèêÂèñÂ§±Êïó: '+e.message,'error');
  }
}

// Ë®àÁÆóÂÖ©ÂÄãÊñáÊú¨ÁöÑÁõ∏‰ººÂ∫¶Ôºà0-1‰πãÈñìÔºå1Ë°®Á§∫ÂÆåÂÖ®Áõ∏ÂêåÔºâ
function calculateTextSimilarity(text1, text2){
  if(!text1 || !text2) return 0;

  // ËΩâÊèõÁÇ∫Â∞èÂØ´‰∏¶ÂéªÈô§Á©∫Ê†º
  const t1 = text1.toLowerCase().replace(/\s+/g, '');
  const t2 = text2.toLowerCase().replace(/\s+/g, '');

  // ÂÆåÂÖ®Áõ∏Âêå
  if(t1 === t2) return 1;

  // Ë®àÁÆóÁ∑®ËºØË∑ùÈõ¢ÔºàLevenshtein distanceÔºâ
  const len1 = t1.length;
  const len2 = t2.length;
  const matrix = [];

  for(let i = 0; i <= len1; i++){
    matrix[i] = [i];
  }
  for(let j = 0; j <= len2; j++){
    matrix[0][j] = j;
  }

  for(let i = 1; i <= len1; i++){
    for(let j = 1; j <= len2; j++){
      const cost = t1[i-1] === t2[j-1] ? 0 : 1;
      matrix[i][j] = Math.min(
        matrix[i-1][j] + 1,      // Âà™Èô§
        matrix[i][j-1] + 1,      // ÊèíÂÖ•
        matrix[i-1][j-1] + cost  // ÊõøÊèõ
      );
    }
  }

  const distance = matrix[len1][len2];
  const maxLen = Math.max(len1, len2);

  // ËΩâÊèõÁÇ∫Áõ∏‰ººÂ∫¶Ôºà0-1Ôºâ
  return 1 - (distance / maxLen);
}

// Ê™¢Êü•Êñ∞‰ºèÁ≠ÜÊòØÂê¶ËàáÂ∑≤Êúâ‰ºèÁ≠ÜÁõ∏‰ºº
function checkForeshadowSimilarity(newForeshadow, existingForeshadows){
  if(!existingForeshadows || existingForeshadows.length === 0) return null;

  let maxSimilarity = 0;
  let mostSimilar = null;

  for(const existing of existingForeshadows){
    // Ë®àÁÆóÊ®ôÈ°åÁõ∏‰ººÂ∫¶
    const titleSim = calculateTextSimilarity(newForeshadow.title, existing.title);

    // Ë®àÁÆóÊèèËø∞Áõ∏‰ººÂ∫¶
    const descSim = calculateTextSimilarity(
      newForeshadow.description || '',
      existing.description || ''
    );

    // Á∂úÂêàÁõ∏‰ººÂ∫¶ÔºàÊ®ôÈ°åÊ¨äÈáçÊõ¥È´òÔºâ
    const similarity = titleSim * 0.7 + descSim * 0.3;

    if(similarity > maxSimilarity){
      maxSimilarity = similarity;
      mostSimilar = existing;
    }
  }

  // Â¶ÇÊûúÁõ∏‰ººÂ∫¶Ë∂ÖÈÅé70%ÔºåËøîÂõûÁõ∏‰ººÁöÑ‰ºèÁ≠Ü
  if(maxSimilarity >= 0.7){
    return {
      similarity: maxSimilarity,
      existing: mostSimilar
    };
  }

  return null;
}

// È°ØÁ§∫‰ºèÁ≠ÜÂª∫Ë≠∞
async function showForeshadowSuggestions(suggestions){
  let html='<div class="suggestions-list">';
  html+='<h3 style="margin-bottom:12px">AI Ë≠òÂà•Âà∞‰ª•‰∏ãÊΩõÂú®‰ºèÁ≠ÜÔºö</h3>';

  // ÂÑ™ÂåñÔºö‰∏ÄÊ¨°ÊÄßÁç≤ÂèñÊâÄÊúâÂ∑≤Êúâ‰ºèÁ≠ÜÔºåÈÅøÂÖçÈáçË§áÊü•Ë©¢
  const existingForeshadows = story
    ? await db.foreshadowing.where('storyId').equals(story.id).toArray()
    : [];

  // Ê™¢Êü•ÊØèÂÄãÂª∫Ë≠∞ÊòØÂê¶ËàáÂ∑≤Êúâ‰ºèÁ≠ÜÁõ∏‰ºº
  for(let idx = 0; idx < suggestions.length; idx++){
    const s = suggestions[idx];
    const similarCheck = checkForeshadowSimilarity(s, existingForeshadows);

    const isDuplicate = similarCheck !== null;
    const duplicateClass = isDuplicate ? 'suggestion-duplicate' : '';
    const duplicateWarning = isDuplicate
      ? `<div class="duplicate-warning">‚ö†Ô∏è ÂèØËÉΩËàáÂ∑≤Êúâ‰ºèÁ≠ÜÈáçË§áÔºö„Äå${esc(similarCheck.existing.title)}„ÄçÔºàÁõ∏‰ººÂ∫¶ ${Math.round(similarCheck.similarity * 100)}%Ôºâ</div>`
      : '';

    html+=`
      <div class="suggestion-item ${duplicateClass}">
        <input type="checkbox" id="sug-${idx}" ${isDuplicate ? '' : 'checked'}>
        <label for="sug-${idx}">
          <strong>${esc(s.title)}</strong>
          <p>${esc(s.description)}</p>
          <small>ÂéüÂõ†Ôºö${esc(s.reason)}</small>
          ${duplicateWarning}
        </label>
      </div>
    `;
  }

  html+='</div>';

  document.getElementById('suggestions-content').innerHTML=html;

  // ‰øùÂ≠òÂª∫Ë≠∞Êï∏Êìö
  window.foreshadowSuggestions=suggestions;

  showModal('foreshadow-suggestions-modal');
}

// Á¢∫Ë™çÊ∑ªÂä†Âª∫Ë≠∞ÁöÑ‰ºèÁ≠Ü
async function confirmForeshadowSuggestions(){
  if(!window.foreshadowSuggestions)return;

  const selected=[];
  window.foreshadowSuggestions.forEach((s,idx)=>{
    if(document.getElementById(`sug-${idx}`).checked){
      selected.push(s);
    }
  });

  if(selected.length===0){
    toast('Ë´ãËá≥Â∞ëÈÅ∏Êìá‰∏ÄÂÄã‰ºèÁ≠Ü','warning');
    return;
  }

  showLoading('Ê≠£Âú®Ê∑ªÂä†‰ºèÁ≠Ü...');

  try{
    for(const s of selected){
      const f={
        id:crypto.randomUUID(),
        storyId:story.id,
        messageId:msgs[msgs.length-1]?.id,
        title:s.title,
        description:s.description,
        isResolved:false,
        mentionCount:0,
        priority:s.priority||'medium',
        tags:s.keywords||[],
        timeLabel:story.storyTime,
        createdAt:Date.now()
      };
      await db.foreshadowing.add(f);
    }

    hideLoading();
    closeModal('foreshadow-suggestions-modal');
    toast(`Â∑≤Ê∑ªÂä† ${selected.length} ÂÄã‰ºèÁ≠Ü`,'success');
    renderForeshadow();

    window.foreshadowSuggestions=null;
  }catch(e){
    hideLoading();
    toast('Ê∑ªÂä†Â§±Êïó: '+e.message,'error');
  }
}

// AI Ê™¢Ê∏¨‰ºèÁ≠ÜË°ùÁ™Å
async function aiCheckForeshadowConflicts(){
  if(!story){toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã','warning');return;}

  const foreshadows=await db.foreshadowing
    .where('storyId').equals(story.id)
    .filter(f=>!f.isResolved)
    .toArray();

  if(foreshadows.length<2){
    toast('‰ºèÁ≠ÜÊï∏Èáè‰∏çË∂≥ÔºåÁÑ°ÈúÄÊ™¢Ê∏¨Ë°ùÁ™Å','info');
    return;
  }

  showLoading('AI Ê≠£Âú®ÂàÜÊûêË°ùÁ™Å...');

  try{
    const prompt=`ÂàÜÊûê‰ª•‰∏ã‰ºèÁ≠ÜÊòØÂê¶Â≠òÂú®Ë°ùÁ™ÅÊàñÁüõÁõæÔºö

${foreshadows.map((f,i)=>`
${i+1}. ${f.title}
   ÊèèËø∞Ôºö${f.description||'ÁÑ°'}
   Ê®ôÁ±§Ôºö${(f.tags||[]).join(', ')||'ÁÑ°'}
`).join('\n')}

Ë´ãÊåáÂá∫Ôºö
1. Âì™‰∫õ‰ºèÁ≠ÜÂèØËÉΩÁõ∏‰∫íË°ùÁ™Å
2. Â¶Ç‰ΩïÂçîË™øÈÄô‰∫õË°ùÁ™Å
3. Âª∫Ë≠∞ÁöÑÂõûÊî∂È†ÜÂ∫è`;

    const response=await callApi(prompt);
    hideLoading();

    showAlert('‰ºèÁ≠ÜË°ùÁ™ÅÂàÜÊûê',response.content);
  }catch(e){
    hideLoading();
    toast('ÂàÜÊûêÂ§±Êïó: '+e.message,'error');
  }
}

// È°ØÁ§∫‰ºèÁ≠ÜÊôÇÈñìÁ∑ö
async function showForeshadowTimeline(){
  if(!story){toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã','warning');return;}

  const foreshadows=await db.foreshadowing
    .where('storyId').equals(story.id)
    .toArray();

  if(foreshadows.length===0){
    toast('Êö´ÁÑ°‰ºèÁ≠Ü','info');
    return;
  }

  // ÊåâÂâµÂª∫ÊôÇÈñìÊéíÂ∫è
  foreshadows.sort((a,b)=>a.createdAt-b.createdAt);

  let html='<div class="timeline-container">';

  foreshadows.forEach((f,idx)=>{
    const status=f.isResolved?'resolved':'pending';
    const urgency=calculateForeshadowUrgency(f);

    html+=`
      <div class="timeline-item ${status} ${urgency}" onclick="showForeshadowDetail('${f.id}')" style="cursor:pointer">
        <div class="timeline-marker">
          ${f.isResolved?'‚úì':idx+1}
        </div>
        <div class="timeline-content">
          <div class="timeline-title">${esc(f.title)}</div>
          <div class="timeline-meta">
            ${f.timeLabel||'Êú™Áü•ÊôÇÈñì'} ¬∑
            Â∑≤ÈÅé ${f.mentionCount||0} Ê¢ùÂ∞çË©±
            ${f.priority?` ¬∑ ${{'urgent':'üî¥Á∑äÊÄ•','high':'üü†È´ò','medium':'üü°‰∏≠','low':'üü¢‰Ωé'}[f.priority]||''}`:''}
          </div>
          ${f.isResolved?`
            <div class="timeline-resolved">
              ‚úÖ Â∑≤ÂõûÊî∂Êñº ${f.resolvedAt?new Date(f.resolvedAt).toLocaleString():'Êú™Áü•'}
            </div>
          `:''}
        </div>
      </div>
    `;
  });

  html+='</div>';

  document.getElementById('foreshadow-timeline-content').innerHTML=html;
  showModal('foreshadow-timeline-modal');
}

// Â∞éÂá∫‰ºèÁ≠ÜÂ†±Âëä
async function exportForeshadowReport(){
  if(!story){toast('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã','warning');return;}

  const foreshadows=await db.foreshadowing
    .where('storyId').equals(story.id)
    .toArray();

  if(foreshadows.length===0){
    toast('Êö´ÁÑ°‰ºèÁ≠ÜÂèØÂ∞éÂá∫','info');
    return;
  }

  let markdown=`# ${story.title} - ‰ºèÁ≠ÜÂ†±Âëä\n\n`;
  markdown+=`ÁîüÊàêÊôÇÈñìÔºö${new Date().toLocaleString()}\n\n`;

  markdown+=`## üìä Áµ±Ë®à\n\n`;
  markdown+=`- Á∏Ω‰ºèÁ≠ÜÊï∏Ôºö${foreshadows.length}\n`;
  markdown+=`- Êú™ÂõûÊî∂Ôºö${foreshadows.filter(f=>!f.isResolved).length}\n`;
  markdown+=`- Â∑≤ÂõûÊî∂Ôºö${foreshadows.filter(f=>f.isResolved).length}\n\n`;

  const unresolved=foreshadows.filter(f=>!f.isResolved);
  if(unresolved.length>0){
    markdown+=`## üìå Êú™ÂõûÊî∂‰ºèÁ≠Ü\n\n`;
    unresolved.forEach(f=>{
      markdown+=`### ${f.title}\n\n`;
      markdown+=`- **ÊèèËø∞**Ôºö${f.description||'ÁÑ°'}\n`;
      markdown+=`- **Âüã‰∏ãÊôÇÈñì**Ôºö${f.timeLabel||'Êú™Áü•'}\n`;
      markdown+=`- **Â∑≤ÈÅéÂ∞çË©±**Ôºö${f.mentionCount||0} Ê¢ù\n`;
      markdown+=`- **ÂÑ™ÂÖàÁ¥ö**Ôºö${{'urgent':'Á∑äÊÄ•','high':'È´ò','medium':'‰∏≠','low':'‰Ωé'}[f.priority||'medium']}\n`;
      if(f.tags&&f.tags.length>0){
        markdown+=`- **Ê®ôÁ±§**Ôºö${f.tags.join(', ')}\n`;
      }
      if(f.plan){
        markdown+=`- **ÂõûÊî∂Ë®àÂäÉ**Ôºö\n${f.plan}\n`;
      }
      markdown+=`\n`;
    });
  }

  const resolved=foreshadows.filter(f=>f.isResolved);
  if(resolved.length>0){
    markdown+=`## ‚úÖ Â∑≤ÂõûÊî∂‰ºèÁ≠Ü\n\n`;
    resolved.forEach(f=>{
      markdown+=`### ${f.title}\n\n`;
      markdown+=`- **ÊèèËø∞**Ôºö${f.description||'ÁÑ°'}\n`;
      markdown+=`- **Âüã‰∏ãÊôÇÈñì**Ôºö${f.timeLabel||'Êú™Áü•'}\n`;
      markdown+=`- **ÂõûÊî∂ÊôÇÈñì**Ôºö${f.resolvedAt?new Date(f.resolvedAt).toLocaleString():'Êú™Áü•'}\n\n`;
    });
  }

  // ‰∏ãËºâÁÇ∫ Markdown Êñá‰ª∂
  const blob=new Blob([markdown],{type:'text/markdown;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`${story.title}-‰ºèÁ≠ÜÂ†±Âëä.md`;
  a.click();
  URL.revokeObjectURL(url);

  toast('Â†±ÂëäÂ∑≤Â∞éÂá∫','success');
}

// Êõ¥Êñ∞‰ºèÁ≠ÜË®àÊï∏ÔºàÊØèÊ¨°ÁôºÈÄÅÊ∂àÊÅØÂæåË™øÁî®Ôºâ
async function updateForeshadowCounts(){
  if(!story)return;

  try{
    const foreshadows=await db.foreshadowing
      .where('storyId').equals(story.id)
      .filter(f=>!f.isResolved)
      .toArray();

    if(foreshadows.length===0)return;

    // ÊâπÈáèÊõ¥Êñ∞‰ª•ÊèêÈ´òÊÄßËÉΩ
    const updates=foreshadows.map(f=>
      db.foreshadowing.update(f.id,{
        mentionCount:(f.mentionCount||0)+1
      })
    );

    await Promise.all(updates);
  }catch(e){
    console.error('[Foreshadow] Êõ¥Êñ∞Ë®àÊï∏Â§±Êïó:',e);
  }
}

// È°ØÁ§∫‰ºèÁ≠ÜÊèêÈÜíÊ©´ÂπÖ
async function showForeshadowReminder(){
  if(!story)return;

  // ÁßªÈô§ËàäÁöÑÊèêÈÜí
  const oldReminder=document.getElementById('foreshadow-reminder-banner');
  if(oldReminder)oldReminder.remove();

  try{
    const unresolvedForeshadows=await db.foreshadowing
      .where('storyId').equals(story.id)
      .filter(f=>!f.isResolved)
      .toArray();

    const urgent=unresolvedForeshadows.filter(f=>
      calculateForeshadowUrgency(f)==='critical'
    );

    if(urgent.length>0){
      // Âú®Ëº∏ÂÖ•Ê°Ü‰∏äÊñπÈ°ØÁ§∫ÊèêÈÜíÊ©´ÂπÖ
      const banner=document.createElement('div');
      banner.id='foreshadow-reminder-banner';
      banner.className='foreshadow-reminder warning';
      banner.innerHTML=`
        ‚ö†Ô∏è Êúâ ${urgent.length} ÂÄã‰ºèÁ≠ÜÈúÄË¶ÅÁõ°Âø´ÂõûÊî∂ÔºÅ
        <button onclick="goTo('view-foreshadow');closeAll();document.getElementById('foreshadow-reminder-banner').remove()">Êü•Áúã</button>
      `;

      // ÊèíÂÖ•Âà∞Â∞çË©±Ë¶ñÂúñ‰∏≠
      const chatView=document.getElementById('view-chat');
      if(chatView){
        chatView.insertBefore(banner,chatView.firstChild);

        // 5ÁßíÂæåËá™ÂãïÈö±Ëóè
        setTimeout(()=>{
          if(banner.parentNode){
            banner.style.transition='opacity 0.3s';
            banner.style.opacity='0';
            setTimeout(()=>banner.remove(),300);
          }
        },5000);
      }
    }
  }catch(e){
    console.error('[Foreshadow] È°ØÁ§∫ÊèêÈÜíÂ§±Êïó:',e);
  }
}

// È°ØÁ§∫Ë≠¶Âëä/‰ø°ÊÅØÂΩàÁ™ó
function showAlert(title,content){
  showConfirm(content,null,false,title);
}

// Â≠òÊ™î
async function renderSaves(){
  if(!story)return;
  const c=document.getElementById('saves-content');
  const saves=await db.saves.where('storyId').equals(story.id).reverse().toArray();
  const manual=saves.filter(s=>!s.isAuto),auto=saves.filter(s=>s.isAuto);
  let html=`<div class="section-title"><span>üíæ</span><span>ÊâãÂãïÂ≠òÊ™î (${manual.length}/8)</span></div>`;
  if(!manual.length)html+='<div style="text-align:center;padding:20px;color:var(--text-tertiary)">Êö´ÁÑ°</div>';
  else manual.forEach(s=>html+=renderSaveCard(s));
  html+=`<div class="section-title" style="margin-top:20px"><span>üîÑ</span><span>Ëá™ÂãïÂ≠òÊ™î (${auto.length}/5)</span></div>`;
  if(!auto.length)html+='<div style="text-align:center;padding:20px;color:var(--text-tertiary)">Êö´ÁÑ°</div>';
  else auto.forEach(s=>html+=renderSaveCard(s,true));
  c.innerHTML=html;
}
function renderSaveCard(s,isAuto=false){
  const t=timeAgo(s.createdAt),tagCls=s.labelColor==='#EF4444'?'be':s.labelColor==='#F59E0B'?'key':'';
  return `<div class="save-card"><div class="save-card-header"><div class="save-card-title">${isAuto?`Ëá™Âãï #${s.slotIndex}`:`Â≠òÊ™î ${s.slotIndex}`}${s.label?`<span class="save-card-tag ${tagCls}">${esc(s.label)}</span>`:''}</div></div><div class="save-card-preview">${esc(s.preview||'')}</div><div class="save-card-meta"><span>üìç ${esc(s.storyTime||'')}</span><span>üïê ${t}</span></div><div class="save-card-actions"><button class="action-btn primary" onclick="loadSave('${s.id}')">ËÆÄÂèñ</button>${isAuto?`<button class="action-btn secondary" onclick="toast(T('ËΩâÁÇ∫ÊâãÂãï'))">ËΩâÁÇ∫ÊâãÂãï</button>`:`<button class="action-btn secondary" onclick="toast(T('Ë¶ÜËìã'))">Ë¶ÜËìã</button>`}<button class="action-btn secondary" onclick="deleteSave('${s.id}')">üóëÔ∏è</button></div></div>`;
}
async function createSave(){
  if(!story||!msgs.length){toast(T('Ê≤íÊúâÂèØ‰øùÂ≠òÁöÑÂÖßÂÆπ'),'warning');return;}
  const existing=await db.saves.where('storyId').equals(story.id).filter(s=>!s.isAuto).toArray();
  if(existing.length>=8){toast(T('Â≠òÊ™îÊßΩ‰ΩçÂ∑≤Êªø'),'warning');return;}
  const slot=existing.length+1,last=msgs[msgs.length-1];
  const save={id:crypto.randomUUID(),storyId:story.id,slotIndex:slot,isAuto:false,label:'',preview:last?.content?.slice(0,100)||'',storyTime:story.storyTime||'',branchId:story.currentBranchId,messageId:last?.id,createdAt:Date.now()};
  await db.saves.put(save);
  toast(T('Â≠òÊ™îÂâµÂª∫ÊàêÂäüÔºÅ'),'success');
  renderSaves();
}
async function loadSave(id){showConfirm('Á¢∫ÂÆöË¶ÅËÆÄÂèñÊ≠§Â≠òÊ™îÂóéÔºüÁï∂ÂâçÈÄ≤Â∫¶Â∞á‰∏üÂ§±„ÄÇ',async()=>{showLoading('ËÆÄÂèñÂ≠òÊ™î...');try{const s=await db.saves.get(id);if(!s)throw new Error('Â≠òÊ™î‰∏çÂ≠òÂú®');await db.stories.update(story.id,{currentBranchId:s.branchId,currentMessageId:s.messageId,storyTime:s.storyTime});await openStory(story.id);toast(T('Â≠òÊ™îËÆÄÂèñÊàêÂäüÔºÅ'),'success');}catch(e){toast('ËÆÄÂèñÂ§±Êïó: '+e.message,'error');}hideLoading();});}
async function deleteSave(id){showConfirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Â≠òÊ™îÂóéÔºü',async()=>{await db.saves.delete(id);toast(T('Â≠òÊ™îÂ∑≤Âà™Èô§'),'success');renderSaves();});}

// Êåá‰ª§
async function renderInst(){
  const c=document.getElementById('inst-list');
  const list=await db.instructions.toArray();
  if(!list.length){c.innerHTML='<div class="empty"><div class="empty-icon">üìú</div><div class="empty-title">ÈÇÑÊ≤íÊúâÊåá‰ª§</div><div class="empty-desc">Â∞éÂÖ• .md Êàñ .txt Êñá‰ª∂‰ΩúÁÇ∫Ë®≠ÂÆöÊåá‰ª§</div><button class="empty-btn" onclick="importInst()">Â∞éÂÖ•Êåá‰ª§</button></div>';return;}
  
  // Áç≤ÂèñÊâÄÊúâÁ∂ÅÂÆöÈóú‰øÇÂíåÊïÖ‰∫ãÂêçÁ®±
  const allBindings = await db.storyInstructions.toArray();
  const allStories = await db.stories.toArray();
  const storyMap = Object.fromEntries(allStories.map(s=>[s.id, s.title]));
  
  // ÁÇ∫ÊØèÂÄãÊåá‰ª§ÊâæÂà∞Á∂ÅÂÆöÁöÑÊïÖ‰∫ã
  const enrichedList = list.map(inst => {
    const bindings = allBindings.filter(b => b.instructionId === inst.id);
    const boundStoryNames = bindings.map(b => storyMap[b.storyId]).filter(Boolean);
    return {
      ...inst,
      boundStoryNames: boundStoryNames.length ? boundStoryNames : null
    };
  });
  
  c.innerHTML=enrichedList.map(i=>`<div class="inst-card"><div class="inst-header"><div class="inst-icon">üìÑ</div><div class="inst-info"><div class="inst-name">${esc(i.name)}</div><div class="inst-meta">${fmtNum(i.content?.length||0)} Â≠ó</div><div class="inst-binding">Á∂ÅÂÆöÔºö${i.boundStoryNames ? i.boundStoryNames.map(n=>esc(n)).join(', ') : 'Êú™Á∂ÅÂÆö'}</div></div></div>${i.content?`<div class="inst-preview">${esc(i.content.slice(0,100))}...</div>`:''}<div class="inst-actions"><button class="action-btn secondary" onclick="previewInst('${i.id}')">È†êË¶Ω</button><button class="action-btn secondary" onclick="editInst('${i.id}')">Á∑®ËºØ</button><button class="action-btn secondary" onclick="deleteInst('${i.id}')">üóëÔ∏è</button></div></div>`).join('');
}

// È†êË¶ΩÊåá‰ª§
async function previewInst(id){
  const inst = await db.instructions.get(id);
  if(!inst) return;
  showConfirm(inst.content || 'ÔºàÁ©∫ÂÖßÂÆπÔºâ', null, false, `üìÑ ${inst.name}`);
}

// Á∑®ËºØÊåá‰ª§
let editInstId = null;
async function editInst(id){
  const inst = await db.instructions.get(id);
  if(!inst) return;
  editInstId = id;
  document.getElementById('edit-inst-name').value = inst.name;
  document.getElementById('edit-inst-content').value = inst.content || '';
  showModal('edit-inst-modal');
}

async function saveEditInst(){
  if(!editInstId) return;
  const name = document.getElementById('edit-inst-name').value.trim();
  const content = document.getElementById('edit-inst-content').value;
  if(!name){toast(T('Ë´ãËº∏ÂÖ•ÂêçÁ®±'),'warning');return;}
  await db.instructions.update(editInstId, { name, content });
  closeModal('edit-inst-modal');
  toast(T('Êåá‰ª§Â∑≤Êõ¥Êñ∞'),'success');
  renderInst();
  editInstId = null;
}
function importInst(){
  const input=document.getElementById('file-input');
  input.onchange=async e=>{
    const f=e.target.files[0];if(!f)return;
    const content=await f.text();
    const inst={id:crypto.randomUUID(),name:f.name,content,createdAt:Date.now()};
    await db.instructions.put(inst);
    toast(T('Êåá‰ª§Â∞éÂÖ•ÊàêÂäüÔºÅ'),'success');
    renderInst();
    input.value='';
  };
  input.click();
}
async function deleteInst(id){showConfirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Êåá‰ª§ÂóéÔºü',async()=>{await db.instructions.delete(id);await db.storyInstructions.where('instructionId').equals(id).delete();toast(T('Êåá‰ª§Â∑≤Âà™Èô§'),'success');renderInst();});}

// APIÈ†êË®≠
async function renderApi(){
  const c=document.getElementById('api-list');if(!c)return;
  const list=await db.apiPresets.toArray();
  if(!list.length){c.innerHTML='<div class="empty"><div class="empty-icon">ü§ñ</div><div class="empty-title">Êú™ÈÖçÁΩÆ API</div><div class="empty-desc">Ê∑ªÂä† Claude Êàñ OpenAI API ‰æÜÈñãÂßã</div><button class="empty-btn" onclick="addApi()">Ê∑ªÂä† API</button></div>';return;}
  c.innerHTML=list.map(p=>`<div class="api-card ${p.isActive?'active':''}"><div class="api-header" onclick="selectApi('${p.id}')"><span class="api-name">${esc(p.name)}</span>${p.isActive?'<span class="api-badge">‰ΩøÁî®‰∏≠</span>':''}</div><div class="api-info" onclick="selectApi('${p.id}')">${p.type==='anthropic'?'Anthropic':p.type==='openai'?'OpenAI':'Ëá™ÂÆöÁæ©'} ¬∑ ${esc(p.model)}</div><div class="api-actions" style="display:flex;gap:8px;margin-top:10px"><button class="action-btn secondary" onclick="editApi('${p.id}')">‚úèÔ∏è Á∑®ËºØ</button><button class="action-btn secondary" onclick="deleteApi('${p.id}')" style="color:var(--error)">üóëÔ∏è Âà™Èô§</button></div></div>`).join('')+`<div style="text-align:center;margin-top:16px"><button class="action-btn primary" style="width:auto;padding:12px 24px" onclick="addApi()">‚ûï Ê∑ªÂä†Êñ∞È†êË®≠</button></div>`;
}
function addApi(){
  editApiId=null;
  document.getElementById('api-name').value='';
  document.getElementById('api-type').value='anthropic';
  document.getElementById('api-key').value='';
  document.getElementById('api-model').value='';
  document.getElementById('api-url').value='';
  // ÈáçÁΩÆËá™ÂãïË£úÂÖ®Âæ©ÈÅ∏Ê°ÜÁÇ∫ÈÅ∏‰∏≠ÁãÄÊÖã
  const autoCompleteCheckbox = document.getElementById('api-url-autocomplete');
  if(autoCompleteCheckbox) autoCompleteCheckbox.checked = true;
  updateApiFields();
  showModal('api-modal');
}
async function editApi(id){
  const p=await db.apiPresets.get(id);
  if(!p)return;
  editApiId=id;
  document.getElementById('api-name').value=p.name||'';
  document.getElementById('api-type').value=p.type||'anthropic';
  document.getElementById('api-key').value=p.apiKey||'';
  document.getElementById('api-url').value=p.url||'';
  updateApiFields();
  document.getElementById('api-model').value=p.model||'';
  // Âä†ËºâËá™ÂãïË£úÂÖ®Ë®≠ÁΩÆ
  const autoCompleteCheckbox = document.getElementById('api-url-autocomplete');
  if(autoCompleteCheckbox) autoCompleteCheckbox.checked = p.urlAutoComplete !== false;
  showModal('api-modal');
}
async function deleteApi(id){
  showConfirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§ API È†êË®≠ÂóéÔºü',async()=>{
    const p=await db.apiPresets.get(id);
    await db.apiPresets.delete(id);
    if(p&&p.isActive){
      const first=await db.apiPresets.toCollection().first();
      if(first)await db.apiPresets.update(first.id,{isActive:true});
    }
    toast(T('API È†êË®≠Â∑≤Âà™Èô§'),'success');
    renderApi();
  });
}
function updateApiFields(){
  const t=document.getElementById('api-type').value,m=document.getElementById('api-model'),dl=document.getElementById('model-list'),u=document.getElementById('api-url-group');
  if(t==='anthropic'){
    dl.innerHTML='<option value="claude-sonnet-4-20250514">Claude Sonnet 4</option><option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option><option value="claude-3-opus-20240229">Claude 3 Opus</option><option value="claude-3-5-haiku-20241022">Claude 3.5 Haiku</option>';
    m.placeholder='ÈÅ∏ÊìáÊàñËº∏ÂÖ•Ê®°ÂûãÂêçÁ®±';
    u.classList.add('hidden');
  }else if(t==='openai'){
    dl.innerHTML='<option value="gpt-4o">GPT-4o</option><option value="gpt-4o-mini">GPT-4o Mini</option><option value="gpt-4-turbo">GPT-4 Turbo</option><option value="gpt-3.5-turbo">GPT-3.5 Turbo</option><option value="o1">o1</option><option value="o1-mini">o1-mini</option>';
    m.placeholder='ÈÅ∏ÊìáÊàñËº∏ÂÖ•Ê®°ÂûãÂêçÁ®±';
    u.classList.add('hidden');
  }else{
    dl.innerHTML='';
    m.placeholder='Ëº∏ÂÖ•Ê®°ÂûãÂêçÁ®±';
    u.classList.remove('hidden');
  }
}
async function saveApi(){
  const name=document.getElementById('api-name').value.trim(),type=document.getElementById('api-type').value,apiKey=document.getElementById('api-key').value.trim(),model=document.getElementById('api-model').value.trim(),url=document.getElementById('api-url').value.trim();
  const urlAutoComplete = document.getElementById('api-url-autocomplete')?.checked ?? true;
  if(!name||!apiKey){toast(T('Ë´ãÂ°´ÂØ´ÂêçÁ®±Âíå API Key'),'warning');return;}
  if(!model){toast(T('Ë´ãËº∏ÂÖ•ÊàñÈÅ∏ÊìáÊ®°Âûã'),'warning');return;}
  if(type==='custom'&&!url){toast(T('Ë´ãËº∏ÂÖ• API URL'),'warning');return;}
  
  // Â¶ÇÊûúÊòØÁ∑®ËºØÔºå‰øùÁïôÂéüÊú¨ÁöÑ isActive ÁãÄÊÖãÔºõÂ¶ÇÊûúÊòØÊñ∞Âª∫ÔºåË®≠ÁÇ∫ true ‰∏¶ÂèñÊ∂àÂÖ∂‰ªñÁöÑÊøÄÊ¥ªÁãÄÊÖã
  let isActive = true;
  if(editApiId){
    const existing = await db.apiPresets.get(editApiId);
    isActive = existing?.isActive || false;
  } else {
    // Êñ∞Âª∫ÊôÇÔºåÂèñÊ∂àÂÖ∂‰ªñ API ÁöÑÊøÄÊ¥ªÁãÄÊÖãÔºåËÆìÊñ∞ÁöÑÊàêÁÇ∫ÊøÄÊ¥ªÁãÄÊÖã
    await db.apiPresets.toCollection().modify({isActive: false});
  }
  
  const p={id:editApiId||crypto.randomUUID(),name,type,apiKey,model,url:type==='custom'?url:'',urlAutoComplete,isActive,createdAt:Date.now()};
  await db.apiPresets.put(p);
  closeModal('api-modal');
  toast(T('API È†êË®≠Â∑≤‰øùÂ≠ò') + (isActive ? 'ÔºàÂ∑≤ÊøÄÊ¥ªÔºâ' : ''), 'success');
  renderApi();
}
async function testApi(){
  const type=document.getElementById('api-type').value,apiKey=document.getElementById('api-key').value.trim(),model=document.getElementById('api-model').value.trim(),url=document.getElementById('api-url').value.trim();
  const resultEl=document.getElementById('api-test-result');
  resultEl.style.display='block';
  resultEl.style.color='var(--text-secondary)';
  resultEl.innerHTML='<span class="typing"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></span> Ê∏¨Ë©¶ÈÄ£Êé•‰∏≠...';
  if(!apiKey){resultEl.style.color='var(--error)';resultEl.textContent='‚ùå Ë´ãÂÖàÂ°´ÂØ´ API Key';return;}
  if(!model){resultEl.style.color='var(--error)';resultEl.textContent='‚ùå Ë´ãÂÖàÂ°´ÂØ´Ê®°ÂûãÂêçÁ®±';return;}
  
  // ÂâµÂª∫Ë∂ÖÊôÇÊéßÂà∂
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 30000);

  try{
    let r;
    // iOS ÂÖºÂÆπÊÄßÔºöÊòéÁ¢∫Ë®≠ÁΩÆ mode Âíå credentials
    const fetchOptions = {
      signal: controller.signal,
      method: 'POST',
      mode: 'cors',
      credentials: 'omit',
      cache: 'no-cache'
    };

    if(type==='anthropic'){
      r=await fetch('https://api.anthropic.com/v1/messages',{
        ...fetchOptions,
        headers:{
          'Content-Type':'application/json',
          'x-api-key':apiKey,
          'anthropic-version':'2023-06-01',
          'anthropic-dangerous-direct-browser-access':'true'
        },
        body:JSON.stringify({model:model,max_tokens:10,messages:[{role:'user',content:'Hi'}]})
      });
    }else if(type==='openai'){
      r=await fetch('https://api.openai.com/v1/chat/completions',{
        ...fetchOptions,
        headers:{
          'Content-Type':'application/json',
          'Authorization':`Bearer ${apiKey}`
        },
        body:JSON.stringify({model:model,messages:[{role:'user',content:'Hi'}],max_tokens:10})
      });
    }else{
      if(!url){resultEl.style.color='var(--error)';resultEl.textContent='‚ùå Ë´ãÂÖàÂ°´ÂØ´ API URL';return;}
      const autoComplete = document.getElementById('api-url-autocomplete')?.checked ?? true;
      const apiUrl = normalizeApiUrl(url, autoComplete);
      console.log('Testing Custom API:', url, '‚Üí', apiUrl, '(autoComplete:', autoComplete, ')');
      r=await fetch(apiUrl,{
        ...fetchOptions,
        headers:{
          'Content-Type':'application/json',
          'Authorization':`Bearer ${apiKey}`
        },
        body:JSON.stringify({model:model,messages:[{role:'user',content:'Hi'}],max_tokens:10})
      });
    }
    const text = await r.text();
    console.log('Test API response:', r.status, text.slice(0, 500));
    if(r.ok){
      try {
        const d = JSON.parse(text);
        const hasValidStructure = d.choices?.[0]?.message !== undefined || d.content?.[0] !== undefined;
        if(hasValidStructure) {
          resultEl.style.color='var(--success)';
          resultEl.textContent='‚úÖ ÈÄ£Êé•ÊàêÂäüÔºÅAPI ÂèØÊ≠£Â∏∏‰ΩøÁî®';
        } else {
          resultEl.style.color='var(--warning)';
          resultEl.textContent='‚ö†Ô∏è ÈÄ£Êé•ÊàêÂäü‰ΩÜËøîÂõûÊ†ºÂºèÁï∞Â∏∏';
        }
      } catch(e) {
        resultEl.style.color='var(--error)';
        resultEl.textContent='‚ùå ËøîÂõûÈùûJSON: ' + text.slice(0, 50);
      }
    }else{
      try {
        const e = JSON.parse(text);
        resultEl.style.color='var(--error)';
        resultEl.textContent='‚ùå ' + (e.error?.message || `HTTP ${r.status}`);
      } catch(e) {
        resultEl.style.color='var(--error)';
        resultEl.textContent='‚ùå HTTP ' + r.status + ': ' + text.slice(0, 50);
      }
    }
  }catch(e){
    resultEl.style.color='var(--error)';
    console.error('Test API error:', e);
    const errMsg = e.message || e.toString() || 'Êú™Áü•ÈåØË™§';
    if(e.name === 'AbortError') {
      resultEl.innerHTML='‚ùå ÈÄ£Êé•Ë∂ÖÊôÇÔºà30ÁßíÔºâ<br><span style="font-size:11px;color:var(--text-tertiary)">Ë´ãÊ™¢Êü•Á∂≤Áµ°Êàñ URL ÊòØÂê¶Ê≠£Á¢∫</span>';
    } else if(errMsg.includes('Load failed') || errMsg.includes('Failed to fetch') || errMsg.includes('NetworkError') || e.name === 'TypeError') {
      // Ê™¢Ê∏¨ÊòØÂê¶ÁÇ∫ iOS
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      let hint = 'ÁÄèË¶ΩÂô®ÂÆâÂÖ®Á≠ñÁï•ÈòªÊ≠¢‰∫ÜË´ãÊ±Ç„ÄÇ';
      if(isIOS) {
        hint += '<br>iOS Ë®≠ÂÇôÂèØËÉΩÈúÄË¶ÅÔºö<br>‚Ä¢ Ê™¢Êü• Safari Ë®≠ÁΩÆ‰∏≠ÁöÑ„ÄåÈòªÊ≠¢Ë∑®Á∂≤Á´ôËøΩËπ§„Äç<br>‚Ä¢ ÂòóË©¶ÈóúÈñâ„ÄåÈö±ÁßÅÁÄèË¶Ω„ÄçÊ®°Âºè';
      }
      hint += '<br>‚Ä¢ Á¢∫Ë™ç API ÊúçÂãôÂ∑≤ÈñãÂïü CORS ÊîØÊåÅ';
      resultEl.innerHTML='‚ùå ÈÄ£Êé•Â§±Êïó<br><span style="font-size:11px;color:var(--text-tertiary)">' + hint + '</span>';
    } else {
      resultEl.innerHTML='‚ùå ÈÄ£Êé•Â§±Êïó: ' + errMsg;
    }
  } finally {
    clearTimeout(timeoutId);
  }
}
async function selectApi(id){await db.apiPresets.toCollection().modify({isActive:false});await db.apiPresets.update(id,{isActive:true});toast(T('Â∑≤ÂàáÊèõ API'),'success');renderApi();}

// Ê≤âÊµ∏Ê®°Âºè
let immIdx=0,immPars=[];
function enterImm(){
  if(!msgs.length){toast(T('Ê≤íÊúâÂÖßÂÆπ'),'warning');return;}
  closeAll();
  immPars=msgs.filter(m=>m.role==='assistant').map(m=>m.content);
  immIdx=0;
  document.getElementById('immersive').classList.add('active');
  showImm();
}
function showImm(){const c=document.getElementById('immersive-content');if(immIdx<immPars.length){c.innerHTML=marked.parse(immPars[immIdx]);document.getElementById('imm-progress').style.width=((immIdx+1)/immPars.length*100)+'%';}}
function nextImm(){immIdx++;if(immIdx>=immPars.length){exitImm();return;}showImm();}
function exitImm(){document.getElementById('immersive').classList.remove('active');}

// Èù¢ÊùøÂíåËèúÂñÆ
function showSheet(){
  document.getElementById('overlay').classList.add('active');
  const sheet=document.getElementById('sheet');
  // ÂÖ®Â±èÊ®°Âºè‰∏ã‰∏çÈôêÂà∂ÂØ¨Â∫¶
  if(settings.screen==='fullscreen'){
    sheet.style.maxWidth='100%';
  }else{
    sheet.style.maxWidth='420px';
  }
  sheet.classList.add('active');
}
function showMore(e){
  e.stopPropagation();
  const m=document.getElementById('more-menu');
  m.style.top='100px';
  m.style.right='16px';
  // v19: Ê†πÊìöÊ®°ÂºèÈ°ØÁ§∫/Èö±ËóèÁ∂ìÁáüÊ®°ÂºèÈÅ∏È†Ö
  const isSimMode = story?.mode === 'simulation';
  m.querySelectorAll('.sim-only').forEach(el => {
    el.style.display = isSimMode ? '' : 'none';
  });
  m.classList.add('active');
}
function showMsgMenu(e,id){e.preventDefault();e.stopPropagation();selMsgId=id;const m=document.getElementById('msg-menu');m.style.top=Math.min(e.clientY,window.innerHeight-300)+'px';m.style.left=Math.min(e.clientX,window.innerWidth-180)+'px';m.classList.add('active');}

// ÁÇπÂáªÂºπÂá∫Ê∂àÊÅØÊìç‰ΩúËèúÂçï
function showMsgActionMenu(e, msgId, msgType) {
  e.preventDefault();
  e.stopPropagation();
  
  // ÁßªÈô§Â∑≤Â≠òÂú®ÁöÑËèúÂçï
  const existingMenu = document.querySelector('.msg-action-menu');
  if (existingMenu) existingMenu.remove();
  
  selMsgId = msgId;
  
  // ÂàõÂª∫ËèúÂçï
  const menu = document.createElement('div');
  menu.className = 'msg-action-menu';
  
  // Ê™¢Êü•Ê∂àÊÅØÊòØÂê¶Â∑≤Ê®ôË®òÁÇ∫ÈáçË¶Å
  const msg = msgs.find(m => m.id === msgId);
  const isImportant = msg && msg.isImportant;

  let menuHtml = '';
  if (msgType === 'user') {
    menuHtml = `
      <div class="msg-action-item" onclick="toggleMsgImportanceFromMenu()"><span class="icon">${isImportant ? '‚≠ê' : '‚òÜ'}</span>${isImportant ? 'ÂèñÊ∂àÈáçË¶ÅÊ®ôË®ò' : 'Ê®ôË®òÁÇ∫ÈáçË¶Å'}</div>
      <div class="msg-action-item" onclick="editMsgFromMenu()"><span class="icon">‚úèÔ∏è</span>Á∑®ËºØ</div>
      <div class="msg-action-item danger" onclick="deleteMsgFromMenu()"><span class="icon">üóëÔ∏è</span>Âà™Èô§</div>
    `;
  } else {
    menuHtml = `
      <div class="msg-action-item" onclick="toggleMsgImportanceFromMenu()"><span class="icon">${isImportant ? '‚≠ê' : '‚òÜ'}</span>${isImportant ? 'ÂèñÊ∂àÈáçË¶ÅÊ®ôË®ò' : 'Ê®ôË®òÁÇ∫ÈáçË¶Å'}</div>
      <div class="msg-action-item" onclick="regenMsgFromMenu()"><span class="icon">üîÑ</span>ÈáçÊñ∞ÁîüÊàê</div>
      <div class="msg-action-item" onclick="editMsgFromMenu()"><span class="icon">‚úèÔ∏è</span>Á∑®ËºØ</div>
      <div class="msg-action-item" onclick="copyMsgFromMenu()"><span class="icon">üìã</span>Ë§áË£Ω</div>
      <div class="msg-action-item danger" onclick="deleteMsgFromMenu()"><span class="icon">üóëÔ∏è</span>Âà™Èô§</div>
    `;
  }
  menu.innerHTML = menuHtml;
  
  // ÂÆö‰ΩçËèúÂçï
  document.body.appendChild(menu);
  const rect = e.target.getBoundingClientRect();
  let top = rect.bottom + 4;
  let left = rect.left - 60;
  
  // Èò≤Ê≠¢Ë∂ÖÂá∫Â±èÂπï
  if (top + 180 > window.innerHeight) top = rect.top - 180;
  if (left < 10) left = 10;
  if (left + 130 > window.innerWidth) left = window.innerWidth - 140;
  
  menu.style.top = top + 'px';
  menu.style.left = left + 'px';
  
  // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠ËèúÂçï
  setTimeout(() => {
    document.addEventListener('click', closeMsgActionMenu, { once: true });
  }, 10);
}

function closeMsgActionMenu() {
  const menu = document.querySelector('.msg-action-menu');
  if (menu) menu.remove();
}

function editMsgFromMenu() {
  closeMsgActionMenu();
  editMsg();
}

function deleteMsgFromMenu() {
  closeMsgActionMenu();
  deleteMsg();
}

async function regenMsgFromMenu() {
  closeMsgActionMenu();
  if (!selMsgId || generating) return;
  
  // ÊâæÂà∞ËøôÊù°AIÊ∂àÊÅØ
  const msgIndex = msgs.findIndex(m => m.id === selMsgId);
  if (msgIndex < 0) return;
  
  const currentMsg = msgs[msgIndex];
  if (currentMsg.role !== 'assistant') {
    toast(T('Âè™ËÉΩÈáçÊñ∞ÁîüÊàê AI ÂõûË¶Ü'), 'warning');
    return;
  }
  
  // Âà†Èô§ÂΩìÂâçAIÊ∂àÊÅØ
  await db.messages.delete(selMsgId);
  msgs.splice(msgIndex, 1);
  renderMsgs();
  
  // ÈáçÊñ∞ÁîüÊàê
  generating = true;
  const sendBtn = document.getElementById('send-btn');
  sendBtn.disabled = true;
  
  toast(T('Ê≠£Âú®ÈáçÊñ∞ÁîüÊàê...'), 'info');
  
  const useStreaming = settings.enableStreaming;
  // Ëé∑Âèñ‰∏ä‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ‰Ωú‰∏∫‰∏ä‰∏ãÊñá
  const lastUserMsg = msgs.filter(m => m.role === 'user').pop();
  const content = lastUserMsg?.content || 'ÁπºÁ∫å';
  
  if (useStreaming) {
    await sendWithStreaming(content, sendBtn);
  } else {
    showTyping();
    try {
      const resp = await callAI(content);
      hideTyping();
      const aiMsgId = crypto.randomUUID();
      const estimatedTokens = Math.round(resp.content.length / 2);
      const aiMsg = {id: aiMsgId, storyId: story.id, branchId: story.currentBranchId, role: 'assistant', content: resp.content, tokens: resp.tokens || estimatedTokens, storyTime: story.storyTime || '', createdAt: Date.now()};
      await db.messages.put(aiMsg);
      msgs.push(aiMsg);
      await db.stories.update(story.id, {updatedAt: Date.now(), preview: resp.content.slice(0, 100), currentMessageId: aiMsgId});
      renderMsgs();
      parsePlayerStatusFromAI(resp.content);
    } catch (e) {
      hideTyping();
      toast('ÈáçÊñ∞ÁîüÊàêÂ§±Êïó: ' + e.message, 'error');
    }
  }
  
  generating = false;
  sendBtn.disabled = false;
}

async function copyMsgFromMenu() {
  closeMsgActionMenu();
  if (!selMsgId) return;
  
  const msg = msgs.find(m => m.id === selMsgId);
  if (!msg) return;
  
  try {
    await navigator.clipboard.writeText(msg.content);
    toast(T('Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÊùø'), 'success');
  } catch (e) {
    toast(T('Ë§áË£ΩÂ§±Êïó'), 'error');
  }
}

async function toggleMsgImportanceFromMenu() {
  closeMsgActionMenu();
  if (!selMsgId) return;

  const msgIndex = msgs.findIndex(m => m.id === selMsgId);
  if (msgIndex < 0) return;

  const msg = msgs[msgIndex];
  const newImportance = !msg.isImportant;

  // Êõ¥Êñ∞Ë®òÊÜ∂‰∏≠ÁöÑÊ∂àÊÅØ
  msgs[msgIndex].isImportant = newImportance;

  // Êõ¥Êñ∞Êï∏ÊìöÂ∫´
  try {
    await db.messages.update(selMsgId, { isImportant: newImportance });
    toast(newImportance ? '‚≠ê Â∑≤Ê®ôË®òÁÇ∫ÈáçË¶ÅË®òÊÜ∂' : 'Â∑≤ÂèñÊ∂àÈáçË¶ÅÊ®ôË®ò', 'success');
    renderMsgs();
  } catch (e) {
    console.error('[Important] Êõ¥Êñ∞Â§±Êïó:', e);
    toast('Êìç‰ΩúÂ§±Êïó', 'error');
  }
}

function hideMenu(){document.querySelectorAll('.context-menu').forEach(m=>m.classList.remove('active'));closeMsgActionMenu();}

// ÊïÖ‰∫ãËèúÂñÆÁõ∏Èóú
let menuStoryId = null;
function showStoryMenu(id) {
  menuStoryId = id;
  const m = document.getElementById('story-menu');
  m.style.top = '120px';
  m.style.left = '50%';
  m.style.transform = 'translateX(-50%)';
  m.classList.add('active');
}
function editStoryCover() {
  hideMenu();
  if (!menuStoryId) return;
  // Ë®≠ÁΩÆ‰∏äÂÇ≥ÁõÆÊ®ôÁÇ∫Â∏∂ÊúâstoryIdÁöÑÂ∞çË±°ÔºåÈÅøÂÖçasyncÂ∞éËá¥ÁöÑÂÆâÂÖ®Á≠ñÁï•ÂïèÈ°å
  imageUploadTarget = { type: 'storyCover', storyId: menuStoryId };
  document.getElementById('image-upload').click();
}
async function renameStoryFromMenu() {
  hideMenu();
  if (!menuStoryId) return;
  const s = await db.stories.get(menuStoryId);
  if (!s) return;

  const newTitle = prompt('Ë´ãËº∏ÂÖ•Êñ∞ÁöÑÊïÖ‰∫ãÂêçÁ®±Ôºö', s.title);
  if (!newTitle || newTitle.trim() === '') {
    toast('ÊïÖ‰∫ãÂêçÁ®±‰∏çËÉΩÁÇ∫Á©∫', 'warning');
    return;
  }

  if (newTitle.trim() === s.title) {
    return; // ÂêçÁ®±Ê≤íÊúâÊîπËÆä
  }

  await db.stories.update(menuStoryId, {
    title: newTitle.trim(),
    updatedAt: Date.now()
  });

  // Â¶ÇÊûúÈáçÂëΩÂêçÁöÑÊòØÁï∂ÂâçÊâìÈñãÁöÑÊïÖ‰∫ãÔºå‰πüÊõ¥Êñ∞ÂÖ®Â±ÄËÆäÈáè
  if (story && story.id === menuStoryId) {
    story.title = newTitle.trim();
    // Êõ¥Êñ∞Â∞éËà™Ê¨ÑÊ®ôÈ°å
    const navTitle = document.querySelector('#view-story .nav-title');
    if (navTitle) navTitle.textContent = story.title;
  }

  toast('ÊïÖ‰∫ãÂ∑≤ÈáçÂëΩÂêç', 'success');
  await renderStories();
}

async function renameCurrentStory() {
  closeAll();
  if (!story) return;

  const newTitle = prompt('Ë´ãËº∏ÂÖ•Êñ∞ÁöÑÊïÖ‰∫ãÂêçÁ®±Ôºö', story.title);
  if (!newTitle || newTitle.trim() === '') {
    toast('ÊïÖ‰∫ãÂêçÁ®±‰∏çËÉΩÁÇ∫Á©∫', 'warning');
    return;
  }

  if (newTitle.trim() === story.title) {
    return; // ÂêçÁ®±Ê≤íÊúâÊîπËÆä
  }

  await db.stories.update(story.id, {
    title: newTitle.trim(),
    updatedAt: Date.now()
  });

  story.title = newTitle.trim();

  // Êõ¥Êñ∞Â∞éËà™Ê¨ÑÊ®ôÈ°å
  const navTitle = document.querySelector('#view-story .nav-title');
  if (navTitle) navTitle.textContent = story.title;

  toast('ÊïÖ‰∫ãÂ∑≤ÈáçÂëΩÂêç', 'success');
  await renderStories();
}

async function toggleStoryPin() {
  hideMenu();
  if (!menuStoryId) return;
  const s = await db.stories.get(menuStoryId);
  if (!s) return;
  await db.stories.update(menuStoryId, { isPinned: !s.isPinned });
  toast(s.isPinned ? 'Â∑≤ÂèñÊ∂àÁΩÆÈ†Ç' : 'Â∑≤ÁΩÆÈ†Ç', 'success');
  await renderStories();
}
async function deleteStoryFromMenu() {
  hideMenu();
  if (!menuStoryId) return;
  const s = await db.stories.get(menuStoryId);
  if (!s) return;
  showConfirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§„Äå${s.title}„ÄçÂóéÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Âæ©ÔºÅ`, async () => {
    // Âà™Èô§ÊïÖ‰∫ãÊú¨Ë∫´
    await db.stories.delete(menuStoryId);
    // Âà™Èô§ËÅäÂ§©Ë®òÈåÑ
    await db.messages.where('storyId').equals(menuStoryId).delete();
    // Âà™Èô§ÂàÜÊîØ
    await db.branches.where('storyId').equals(menuStoryId).delete();
    // Âà™Èô§ËßíËâ≤Êï∏Êìö
    await db.characters.where('storyId').equals(menuStoryId).delete();
    await db.characterSnapshots.where('storyId').equals(menuStoryId).delete();
    await db.characterHistory.where('storyId').equals(menuStoryId).delete();
    await db.characterStates.where('storyId').equals(menuStoryId).delete();
    // Âà™Èô§ Lorebook
    await db.lorebook.where('storyId').equals(menuStoryId).delete();
    await db.lorebookTriggerLog.where('storyId').equals(menuStoryId).delete();
    // Âà™Èô§Â≠òÊ™îÂíåÊõ∏Á±§
    await db.saves.where('storyId').equals(menuStoryId).delete();
    await db.bookmarks.where('storyId').equals(menuStoryId).delete();
    // Âà™Èô§Á´†ÁØÄ
    await db.chapters.where('storyId').equals(menuStoryId).delete();
    // Âà™Èô§‰ºèÁ≠ÜÂíå‰∫ã‰ª∂
    await db.foreshadowing.where('storyId').equals(menuStoryId).delete();
    await db.events.where('storyId').equals(menuStoryId).delete();
    // Âà™Èô§ÊôÇÈñìËª∏
    await db.timeline.where('storyId').equals(menuStoryId).delete();
    // Âà™Èô§Ê®ôÁ±§
    await db.plotTags.where('storyId').equals(menuStoryId).delete();
    // Âà™Èô§Áé©ÂÆ∂Èù¢Êùø
    await db.playerPanels.where('storyId').equals(menuStoryId).delete();
    toast(T('ÊïÖ‰∫ãÂ∑≤Âà™Èô§'), 'success');
    await renderStories();
  }, true);
}

// ÈáçÊñ∞ÈñãÂßãÊïÖ‰∫ãÔºàÊ∏ÖÁ©∫ËÅäÂ§©Ë®òÈåÑ‰ΩÜ‰øùÁïôË®≠ÂÆöÔºâ
async function restartStory() {
  closeAll();
  if(!story?.id) return;
  
  showConfirm(`Á¢∫ÂÆöË¶ÅÈáçÊñ∞ÈñãÂßãÂóéÔºü\n\nÂ∞áÊ∏ÖÁ©∫ÊâÄÊúâËÅäÂ§©Ë®òÈåÑ„ÄÅÂàÜÊîØ„ÄÅÂ≠òÊ™î„ÄÅÊõ∏Á±§Á≠âÔºå‰∏¶ÈáçÁΩÆËßíËâ≤ÁãÄÊÖãÂà∞ÂàùÂßãÂÄº„ÄÇ\n\nÊïÖ‰∫ãË®≠ÂÆöÔºàÊåá‰ª§„ÄÅËßíËâ≤„ÄÅLorebookÁ≠âÔºâÊúÉ‰øùÁïô„ÄÇ`, async () => {
    showLoading(T('Ê≠£Âú®ÈáçÁΩÆ...'));
    try {
      // Ê∏ÖÁ©∫ËÅäÂ§©Ë®òÈåÑ
      await db.messages.where('storyId').equals(story.id).delete();
      // Ê∏ÖÁ©∫ÂàÜÊîØ
      await db.branches.where('storyId').equals(story.id).delete();
      // Ê∏ÖÁ©∫Â≠òÊ™î
      await db.saves.where('storyId').equals(story.id).delete();
      // Ê∏ÖÁ©∫Êõ∏Á±§
      await db.bookmarks.where('storyId').equals(story.id).delete();
      // Ê∏ÖÁ©∫Á´†ÁØÄ
      await db.chapters.where('storyId').equals(story.id).delete();
      // Ê∏ÖÁ©∫‰ºèÁ≠Ü‰∫ã‰ª∂
      await db.foreshadowing.where('storyId').equals(story.id).delete();
      await db.events.where('storyId').equals(story.id).delete();
      // Ê∏ÖÁ©∫ÊôÇÈñìËª∏
      await db.timeline.where('storyId').equals(story.id).delete();
      // Ê∏ÖÁ©∫Ê®ôÁ±§
      await db.plotTags.where('storyId').equals(story.id).delete();
      // Ê∏ÖÁ©∫Ë®òÊÜ∂ÊëòË¶Å
      await db.stories.update(story.id, {
        compressedSummaries: [],
        rollingSummaries: [],
        importantMemories: [],
        updatedAt: Date.now()
      });
      
      // ÈáçÁΩÆÁé©ÂÆ∂Èù¢ÊùøÊï∏ÂÄºÔºà‰øùÁïôÁµêÊßãÔºåÊÅ¢Âæ©ÈªòË™çÂÄºÔºâ
      const panel = await db.playerPanels.where('storyId').equals(story.id).first();
      if(panel && panel.values) {
        const resetValues = {};
        for(const attr of (panel.attributes || [])) {
          resetValues[attr.name] = attr.defaultValue;
        }
        await db.playerPanels.update(panel.id, { values: resetValues });
      }
      
      // ÈáçÁΩÆËßíËâ≤ÁãÄÊÖãÂà∞ÂàùÂßãÂÄº
      const characters = await db.characters.where('storyId').equals(story.id).toArray();
      for(const char of characters) {
        // ÂÑ™ÂÖà‰ΩøÁî®ÂÆåÊï¥ÁöÑ initialStateÔºåÂê¶Ââá‰ΩøÁî® initialStats
        if(char.initialState && Object.keys(char.initialState).length > 0) {
          // ÊÅ¢Âæ©ÂÆåÊï¥ÁöÑÂàùÂßãË®≠ÂÆö
          const updateData = {
            updatedAt: Date.now()
          };
          
          // ÊÅ¢Âæ©ÊâÄÊúâ‰øùÂ≠òÁöÑÂ≠óÊÆµ
          const fieldsToRestore = [
            'name', 'title', 'avatar', 'category', 'description', 'personality', 'tags',
            'first_mes', 'scenario', 'mes_example', 'alternate_greetings',
            'system_prompt', 'post_history_instructions', 'creator_notes', 'creator', 'character_version',
            'stats', 'character_book', 'relationships', 'expressions', 'expressionMode', 'avatarImage'
          ];
          
          for(const field of fieldsToRestore) {
            if(char.initialState[field] !== undefined) {
              updateData[field] = char.initialState[field];
            }
          }
          
          await db.characters.update(char.id, updateData);
        } else if(char.initialStats && Object.keys(char.initialStats).length > 0) {
          // ÂÖºÂÆπËàäÁâàÔºöÂè™ÊÅ¢Âæ©Â±¨ÊÄß
          await db.characters.update(char.id, { 
            stats: { ...char.initialStats },
            updatedAt: Date.now()
          });
        }
      }
      
      // ÈáçÁΩÆ Lorebook Ëß∏ÁôºË®àÊï∏
      const lorebookEntries = await db.lorebook.where('storyId').equals(story.id).toArray();
      for(const entry of lorebookEntries) {
        await db.lorebook.update(entry.id, { 
          triggerCount: 0,
          lastTriggeredAt: null
        });
      }
      
      hideLoading();
      toast(T('Â∑≤ÈáçÊñ∞ÈñãÂßãÔºåËßíËâ≤ÁãÄÊÖãÂ∑≤ÈáçÁΩÆ'), 'success');
      
      // ÈáçÊñ∞ËºâÂÖ•ÊïÖ‰∫ã
      await openStory(story.id);
      
    } catch(err) {
      hideLoading();
      console.error('ÈáçÊñ∞ÈñãÂßãÂ§±Êïó:', err);
      toast(T('ÈáçÊñ∞ÈñãÂßãÂ§±Êïó: ') + err.message, 'error');
    }
  }, true);
}

function closeAll(){
  document.getElementById('overlay').classList.remove('active');
  document.getElementById('sheet').classList.remove('active');
  // ÈóúÈñâÊâÄÊúâ active ÁöÑ modal
  document.querySelectorAll('.modal.active').forEach(modal => {
    modal.classList.remove('active');
  });
  hideMenu();
  // ÈáçÁΩÆËßíËâ≤Á∑®ËºØÁãÄÊÖã
  editingCharacterId = null;
  currentCharacterId = null;  // üîß ‰øÆÂæ©Bug #4: Ê∏ÖÁêÜcurrentCharacterIdÈÅøÂÖçÁãÄÊÖãÊ≥ÑÊºè
}
document.addEventListener('click',e=>{if(!e.target.closest('.context-menu')&&!e.target.closest('.nav-btn'))hideMenu();});

// Modal
function showModal(id){document.getElementById('overlay').classList.add('active');document.getElementById(id).classList.add('active');}
function closeModal(id){
  document.getElementById('overlay').classList.remove('active');
  document.getElementById(id).classList.remove('active');
  
  // ÁâπÊÆäËôïÁêÜÔºöËßíËâ≤Á∑®ËºØÊ®°ÊÖãÊ°ÜÈóúÈñâÊôÇÈáçÁΩÆÁãÄÊÖã
  if(id === 'char-add-modal'){
    const titleSpan = document.getElementById('char-modal-title');
    if(titleSpan) titleSpan.textContent = '‚ûï Ê∑ªÂä†ËßíËâ≤';
    const modal = document.getElementById('char-add-modal');
    if(modal){
      const confirmBtn = modal.querySelector('.modal-btn.confirm');
      if(confirmBtn) confirmBtn.onclick = saveCharacterManual;
    }
    currentCharacterId = null;
  }
}
// ÂèñÊ∂àÂõûË™øËÆäÈáè
let cancelCb = null;

function showConfirm(msg,cb,danger=false,title='Á¢∫Ë™ç',onCancel=null){
  document.getElementById('confirm-title').textContent=title;
  const contentEl = document.getElementById('confirm-content');
  contentEl.textContent=msg;
  contentEl.style.whiteSpace=title==='Á¢∫Ë™ç'?'normal':'pre-wrap';
  contentEl.style.maxHeight='50vh';
  contentEl.style.overflowY='auto';
  const b=document.getElementById('confirm-btn');
  const cancelBtn = document.querySelector('#confirm-modal .modal-btn.cancel');
  b.className=danger?'modal-btn danger':'modal-btn confirm';
  b.style.display=cb?'':'none';
  // Áï∂Ê≤íÊúâÁ¢∫Ë™çÂõûË™øÊôÇÔºåÂ∞áÂèñÊ∂àÊåâÈàïÊîπÁÇ∫"ÈóúÈñâ"
  cancelBtn.textContent = cb ? 'ÂèñÊ∂à' : 'ÈóúÈñâ';
  confirmCb=cb;
  cancelCb=onCancel;  // ‰øùÂ≠òÂèñÊ∂àÂõûË™ø
  showModal('confirm-modal');
}
function confirmAction(){closeModal('confirm-modal');if(confirmCb){confirmCb();confirmCb=null;}cancelCb=null;}
function cancelConfirm(){closeModal('confirm-modal');if(cancelCb){cancelCb();cancelCb=null;}confirmCb=null;}
function showInputDialog(title,ph,cb){document.getElementById('input-title').textContent=title;document.getElementById('modal-input').placeholder=ph;document.getElementById('modal-input').value='';inputCb=cb;showModal('input-modal');}
function confirmInput(){const v=document.getElementById('modal-input').value.trim();closeModal('input-modal');if(inputCb){inputCb(v);inputCb=null;}}

// Ê∂àÊÅØÊìç‰Ωú
async function markForeshadow(){hideMenu();showInputDialog('Ê®ôË®ò‰ºèÁ≠Ü','Ëº∏ÂÖ•‰ºèÁ≠ÜÊ®ôÈ°å',async t=>{if(!t)return;const f={id:crypto.randomUUID(),storyId:story.id,messageId:selMsgId,title:t,description:'',isResolved:false,mentionCount:0,createdAt:Date.now()};await db.foreshadowing.put(f);toast(T('‰ºèÁ≠ÜÂ∑≤Ê®ôË®ò'),'success');});}
function copyMsg(){hideMenu();const m=msgs.find(x=>x.id===selMsgId);if(m){navigator.clipboard.writeText(m.content);toast(T('Â∑≤Ë§áË£Ω'),'success');}}

// Âà™Èô§Ê∂àÊÅØ
function deleteMsg(){
  hideMenu();
  showConfirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÊ¢ùÊ∂àÊÅØÂóéÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§Èä∑„ÄÇ',async()=>{
    const idx=msgs.findIndex(m=>m.id===selMsgId);
    if(idx===-1)return;
    await db.messages.delete(selMsgId);
    msgs.splice(idx,1);
    const el=document.querySelector(`.msg[data-id="${selMsgId}"]`);
    if(el)el.remove();
    toast(T('Ê∂àÊÅØÂ∑≤Âà™Èô§'),'success');
  });
}

// Á∑®ËºØÊ∂àÊÅØ
function editMsg(){
  hideMenu();
  const m=msgs.find(x=>x.id===selMsgId);
  if(!m)return;
  document.getElementById('edit-msg-content').value=m.content;
  showModal('edit-msg-modal');
}
async function saveEditMsg(){
  const content=document.getElementById('edit-msg-content').value.trim();
  if(!content){toast(T('ÂÖßÂÆπ‰∏çËÉΩÁÇ∫Á©∫'),'warning');return;}
  const m=msgs.find(x=>x.id===selMsgId);
  if(!m)return;
  m.content=content;
  await db.messages.update(selMsgId,{content});
  const el=document.querySelector(`.msg[data-id="${selMsgId}"]`);
  if(el)el.innerHTML=marked.parse(content);
  closeModal('edit-msg-modal');
  toast(T('Ê∂àÊÅØÂ∑≤Êõ¥Êñ∞'),'success');
}

// ÈáçÊñ∞ÁîüÊàê
function regenerateMsg(){
  hideMenu();
  const m=msgs.find(x=>x.id===selMsgId);
  if(!m||m.role!=='assistant'){toast(T('Âè™ËÉΩÈáçÊñ∞ÁîüÊàê AI Ê∂àÊÅØ'),'warning');return;}
  document.getElementById('regen-note').value='';
  showModal('regen-modal');
}

// ÈáçÊñ∞ÁôºÈÄÅ
function resendMsg(){
  hideMenu();
  const m=msgs.find(x=>x.id===selMsgId);
  if(!m)return;
  if(m.role!=='user'){toast(T('Âè™ËÉΩÈáçÊñ∞ÁôºÈÄÅÁî®Êà∂Ê∂àÊÅØ'),'warning');return;}
  // Â∞áÊ∂àÊÅØÂÖßÂÆπÂ°´ÂÖ•Ëº∏ÂÖ•Ê°Ü
  const input=document.getElementById('user-input');
  if(input){
    input.value=m.content;
    input.focus();
    toast(T('Ê∂àÊÅØÂÖßÂÆπÂ∑≤Â°´ÂÖ•Ëº∏ÂÖ•Ê°Ü'),'success');
  }
}
async function doRegenerate(){
  closeModal('regen-modal');
  if(generating){toast(T('Ê≠£Âú®ÁîüÊàê‰∏≠'),'warning');return;}
  const note=document.getElementById('regen-note').value.trim();
  const idx=msgs.findIndex(m=>m.id===selMsgId);
  if(idx===-1)return;
  
  // ÊâæÂà∞ÈÄôÊ¢ùÊ∂àÊÅØ‰πãÂâçÁöÑÁî®Êà∂Ê∂àÊÅØ
  let userMsg='';
  for(let i=idx-1;i>=0;i--){
    if(msgs[i].role==='user'){userMsg=msgs[i].content;break;}
  }
  if(note)userMsg+='\n\n[Ë£úÂÖÖË™™ÊòéÔºö'+note+']';
  
  // Âà™Èô§Áï∂ÂâçÊ∂àÊÅØ
  await db.messages.delete(selMsgId);
  msgs.splice(idx,1);
  const el=document.querySelector(`.msg[data-id="${selMsgId}"]`);
  if(el)el.remove();
  
  // ÈáçÊñ∞ÁîüÊàê
  generating=true;
  showTyping();
  try{
    const resp=await callApi(userMsg);
    hideTyping();
    const aiMsg={id:crypto.randomUUID(),storyId:story.id,branchId:story.currentBranchId,role:'assistant',content:resp.content,tokens:resp.tokens,createdAt:Date.now()};
    await db.messages.add(aiMsg);
    msgs.push(aiMsg);
    await typewriter(aiMsg);
    toast(T('ÈáçÊñ∞ÁîüÊàêÂÆåÊàê'),'success');
  }catch(e){
    hideTyping();
    toast('ÁîüÊàêÂ§±Êïó: '+e.message,'error');
  }
  generating=false;
}

// ÂõûÊ∫ØÂà∞Ê≠§
function rollbackTo(){
  hideMenu();
  const idx=msgs.findIndex(m=>m.id===selMsgId);
  if(idx===-1)return;
  const deleteCount=msgs.length-idx-1;
  if(deleteCount===0){toast(T('Â∑≤Á∂ìÊòØÊúÄÊñ∞Ê∂àÊÅØ'),'info');return;}
  showConfirm(`Á¢∫ÂÆöË¶ÅÂõûÊ∫ØÂà∞Ê≠§Ê∂àÊÅØÂóéÔºüÂ∞áÂà™Èô§‰πãÂæåÁöÑ ${deleteCount} Ê¢ùÊ∂àÊÅØ„ÄÇ`,async()=>{
    const toDelete=msgs.slice(idx+1).map(m=>m.id);
    await db.messages.bulkDelete(toDelete);
    msgs=msgs.slice(0,idx+1);
    renderMsgs();
    toast(T('Â∑≤ÂõûÊ∫Ø'),'success');
  });
}

// Ë®òÊÜ∂ÁÆ°ÁêÜ
async function showMemoryManager(){
  closeAll();
  if(!story){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'),'warning');return;}

  try {
    // Ë®àÁÆó Token ‰º∞ÁÆó
    let totalChars = 0;
    msgs.forEach(m => totalChars += (m.content || '').length);
    const estimatedTokens = Math.round(totalChars / 2); // Á≤óÁï•‰º∞ÁÆóÔºö‰∏≠ÊñáÁ¥Ñ 2 Â≠óÁ¨¶/token
    const tokenColor = estimatedTokens > 8000 ? 'var(--error)' : estimatedTokens > 4000 ? 'var(--warning)' : 'var(--success)';

    // Ë®àÁÆóÂèó‰øùË≠∑Ê∂àÊÅØÊï∏
    const protectedMsgIds = new Set();

    try {
      const foreshadows = await db.foreshadowing.where('storyId').equals(story.id).toArray();
      foreshadows.forEach(f => protectedMsgIds.add(f.messageId));
    } catch(e) {
      console.warn('[Memory] Âä†Ëºâ‰ºèÁ≠ÜÂ§±Êïó:', e);
    }

    try {
      const bookmarks = await db.bookmarks.where('storyId').equals(story.id).toArray();
      bookmarks.forEach(b => protectedMsgIds.add(b.messageId));
    } catch(e) {
      console.warn('[Memory] Âä†ËºâÊõ∏Á±§Â§±Êïó:', e);
    }

    try {
      const plotTags = await db.plotTags.where('storyId').equals(story.id).toArray();
      plotTags.forEach(t => protectedMsgIds.add(t.messageId));
    } catch(e) {
      console.warn('[Memory] Âä†ËºâÊ®ôÁ±§Â§±Êïó:', e);
    }

    // Ë®àÁÆóÊªæÂãïÊëòË¶ÅÊï∏
    const rollingSummaries = (story.rollingSummaries || []).length;

    // Êõ¥Êñ∞ UI - Ê∑ªÂä†ÂÆâÂÖ®Ê™¢Êü•
    const updateElement = (id, value) => {
      const el = document.getElementById(id);
      if(el) el.textContent = value;
    };

    updateElement('memory-msg-count', msgs.length);
    updateElement('memory-compressed', story.compressedCount || 0);
    updateElement('memory-summary-count', story.summaries?.length || 0);
    updateElement('memory-rolling-count', rollingSummaries);

    const tokenEl = document.getElementById('memory-token-estimate');
    if(tokenEl){
      tokenEl.innerHTML = `‚âà <span style="color:${tokenColor}">${fmtNum(estimatedTokens)}</span> tokens`;
    }

    const protectedInfo = document.getElementById('memory-protected-info');
    if(protectedInfo){
      if(protectedMsgIds.size > 0){
        protectedInfo.textContent = `‚ö†Ô∏è ${protectedMsgIds.size} Ê¢ùÈáçË¶ÅÊ∂àÊÅØÂèó‰øùË≠∑Ôºà‰ºèÁ≠Ü/Êõ∏Á±§/Ê®ôÁ±§Ôºâ`;
        protectedInfo.style.display = '';
      } else {
        protectedInfo.style.display = 'none';
      }
    }

    // ÂàùÂßãÂåñÊªæÂãïÊëòË¶ÅË®≠ÁΩÆ
    const rollingEnabled = story.rollingEnabled || false;
    const rollingInterval = story.rollingInterval || 30;
    const rollingToggle = document.getElementById('tog-rolling-summary');
    if(rollingToggle){
      rollingToggle.classList.toggle('active', rollingEnabled);
    }
    const rollingIntervalEl = document.getElementById('rolling-interval');
    if(rollingIntervalEl){
      rollingIntervalEl.value = rollingInterval;
    }

    // Âä†ËºâÁ´†ÁØÄÈÅ∏È†Ö
    try {
      await updateCompressOptions();
    } catch(e) {
      console.warn('[Memory] Âä†ËºâÁ´†ÁØÄÈÅ∏È†ÖÂ§±Êïó:', e);
    }

    // ÈáçÁΩÆÈÅ∏È†ÖÂç°
    switchMemTab('compress');

    showModal('memory-modal');

  } catch(e) {
    console.error('[Memory] Ë®òÊÜ∂ÁÆ°ÁêÜÂä†ËºâÂ§±Êïó:', e);
    toast('Ë®òÊÜ∂ÁÆ°ÁêÜÂä†ËºâÂ§±Êïó: ' + e.message, 'error');
  }
}

// ÂàáÊèõË®òÊÜ∂ÁÆ°ÁêÜÈÅ∏È†ÖÂç°
function switchMemTab(tab){
  ['compress','rolling','viz','analyze'].forEach(t => {
    document.getElementById('mem-tab-'+t).classList.toggle('secondary', t===tab);
    document.getElementById('mem-tab-'+t).style.background = t===tab ? '' : 'var(--bg-tertiary)';
    document.getElementById('mem-panel-'+t).style.display = t===tab ? '' : 'none';
  });
  // Êõ¥Êñ∞ÊåâÈàïÊñáÂ≠ó
  const btn = document.getElementById('mem-compress-btn');
  if(tab === 'compress'){
    btn.textContent = 'ü§ñ Êô∫ËÉΩÂ£ìÁ∏Æ';
    btn.onclick = compressMemory;
    btn.style.display = '';
  } else {
    btn.style.display = 'none';
  }

  // Â¶ÇÊûúÂàáÊèõÂà∞ÂèØË¶ñÂåñÊ®ôÁ±§ÔºåÊõ¥Êñ∞Êï∏Êìö
  if(tab === 'viz'){
    updateMemoryViz();
  }
}

// Êõ¥Êñ∞Â£ìÁ∏ÆÈÅ∏È†Ö
async function updateCompressOptions(){
  const mode = document.getElementById('compress-mode').value;
  document.getElementById('compress-count-group').style.display = mode === 'count' ? '' : 'none';
  document.getElementById('compress-chapter-group').style.display = mode === 'chapter' ? '' : 'none';
  document.getElementById('compress-manual-group').style.display = mode === 'manual' ? '' : 'none';

  if(mode === 'chapter' && story){
    const chapters = await db.chapters.where('storyId').equals(story.id).sortBy('order');
    const select = document.getElementById('compress-chapter');
    if(chapters.length === 0){
      select.innerHTML = '<option value="">Êö´ÁÑ°Á´†ÁØÄÔºåË´ãÂÖàÊ∑ªÂä†Á´†ÁØÄ</option>';
    } else {
      select.innerHTML = chapters.map((ch, i) => 
        `<option value="${ch.messageId}">Á¨¨ ${i+1} Á´†Ôºö${esc(ch.title)}</option>`
      ).join('');
    }
  }
}

// ÂàáÊèõÊªæÂãïÊëòË¶Å
async function toggleRollingSummary(){
  if(!story) return;
  const toggle = document.getElementById('tog-rolling-summary');
  const enabled = !toggle.classList.contains('active');
  toggle.classList.toggle('active', enabled);
  
  const interval = parseInt(document.getElementById('rolling-interval').value) || 30;
  await db.stories.update(story.id, { rollingEnabled: enabled, rollingInterval: interval });
  story.rollingEnabled = enabled;
  story.rollingInterval = interval;
  
  toast(enabled ? 'Â∑≤ÂïüÁî®Ëá™ÂãïÊªæÂãïÊëòË¶Å' : 'Â∑≤ÈóúÈñâËá™ÂãïÊªæÂãïÊëòË¶Å', 'success');
}

// Ë®òÊÜ∂Â£ìÁ∏ÆËá®ÊôÇÊï∏Êìö
let pendingCompressData = null;

// ÂÖ®Â±ÄËÆäÈáèÔºöÊâãÂãïÈÅ∏ÊìáÁöÑÊ∂àÊÅØID
let manualSelectedMsgIds = new Set();

// È°ØÁ§∫ÊâãÂãïÈÅ∏ÊìáÊ∂àÊÅØÁöÑModal
async function showManualSelectModal(){
  if(!story || !msgs || msgs.length === 0){
    toast('Êö´ÁÑ°Ê∂àÊÅØÂèØÈÅ∏Êìá','warning');
    return;
  }

  // Áç≤ÂèñÂèó‰øùË≠∑ÁöÑÊ∂àÊÅØ ID
  const protectedMsgIds = new Set();
  try{
    const foreshadows = await db.foreshadowing.where('storyId').equals(story.id).toArray();
    const bookmarks = await db.bookmarks.where('storyId').equals(story.id).toArray();
    const plotTags = await db.plotTags.where('storyId').equals(story.id).toArray();
    foreshadows.forEach(f => f.messageId && protectedMsgIds.add(f.messageId));
    bookmarks.forEach(b => b.messageId && protectedMsgIds.add(b.messageId));
    plotTags.forEach(t => t.messageId && protectedMsgIds.add(t.messageId));
  }catch(e){
    console.error('Áç≤Âèñ‰øùË≠∑Ê∂àÊÅØÂ§±Êïó:', e);
  }

  // Ê∏≤ÊüìÊ∂àÊÅØÂàóË°®
  const listEl = document.getElementById('manual-select-list');
  if(!listEl){
    console.error('manual-select-list not found');
    return;
  }

  listEl.innerHTML = msgs.map((msg, idx) => {
    const isProtected = protectedMsgIds.has(msg.id);
    const isSelected = manualSelectedMsgIds.has(msg.id);
    const isUser = msg.role === 'user';
    const preview = msg.content.slice(0, 100);
    const floor = idx + 1;

    return `
    <div class="msg-select-item" style="padding:10px;margin-bottom:8px;background:var(--bg-tertiary);border-radius:8px;display:flex;align-items:flex-start;gap:10px;${isProtected?'opacity:0.5;':''}" data-msg-id="${escAttr(msg.id)}">
      <input type="checkbox" class="msg-select-checkbox" data-msg-id="${escAttr(msg.id)}" ${isSelected?'checked':''} ${isProtected?'disabled':''} onchange="updateManualSelectCount()" style="margin-top:4px;cursor:${isProtected?'not-allowed':'pointer'}">
      <div style="flex:1;min-width:0">
        <div style="font-size:11px;color:var(--text-tertiary);margin-bottom:4px">
          #${floor} ${isUser?'Áé©ÂÆ∂':'AI'} ¬∑ ${new Date(msg.createdAt).toLocaleString()}
          ${isProtected?' <span style="color:var(--warning)">üîí Âèó‰øùË≠∑</span>':''}
        </div>
        <div style="font-size:12px;line-height:1.4;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical">${escHtml(preview)}</div>
      </div>
    </div>
    `;
  }).join('');

  updateManualSelectCount();
  showModal('manual-select-modal');
}

// Êõ¥Êñ∞ÊâãÂãïÈÅ∏ÊìáË®àÊï∏
function updateManualSelectCount(){
  const checkboxes = document.querySelectorAll('.msg-select-checkbox:checked');
  const count = checkboxes.length;

  // Êõ¥Êñ∞ModalÂÖßÁöÑË®àÊï∏
  const modalCount = document.getElementById('modal-selected-count');
  if(modalCount) modalCount.textContent = count;

  // Êõ¥Êñ∞Ë®òÊÜ∂ÁÆ°ÁêÜÈ†ÅÈù¢ÁöÑË®àÊï∏
  const pageCount = document.getElementById('manual-select-count');
  if(pageCount) pageCount.textContent = count;

  // Êõ¥Êñ∞ÂÖ®Â±ÄËÆäÈáè
  manualSelectedMsgIds.clear();
  checkboxes.forEach(cb => {
    manualSelectedMsgIds.add(cb.dataset.msgId);
  });
}

// ÂÖ®ÈÅ∏Ê∂àÊÅØ
function selectAllMessages(){
  const checkboxes = document.querySelectorAll('.msg-select-checkbox:not(:disabled)');
  checkboxes.forEach(cb => cb.checked = true);
  updateManualSelectCount();
}

// ÂèñÊ∂àÂÖ®ÈÅ∏
function unselectAllMessages(){
  const checkboxes = document.querySelectorAll('.msg-select-checkbox');
  checkboxes.forEach(cb => cb.checked = false);
  updateManualSelectCount();
}

// ÈÅ∏ÊìáÂâç50Ê¢ùÊ∂àÊÅØ
function selectOldMessages(){
  const checkboxes = document.querySelectorAll('.msg-select-checkbox:not(:disabled)');
  const count = Math.min(50, checkboxes.length);
  for(let i = 0; i < count; i++){
    checkboxes[i].checked = true;
  }
  updateManualSelectCount();
}

// Á¢∫Ë™çÊâãÂãïÈÅ∏Êìá
function confirmManualSelection(){
  if(manualSelectedMsgIds.size === 0){
    toast('Ë´ãËá≥Â∞ëÈÅ∏Êìá‰∏ÄÊ¢ùÊ∂àÊÅØ','warning');
    return;
  }

  closeModal('manual-select-modal');
  toast(`Â∑≤ÈÅ∏Êìá ${manualSelectedMsgIds.size} Ê¢ùÊ∂àÊÅØ`,'success');
}

async function compressMemory(){
  const mode = document.getElementById('compress-mode').value;
  let count = 0;
  let toCompress = [];
  
  // Áç≤ÂèñÂèó‰øùË≠∑ÁöÑÊ∂àÊÅØ ID
  const protectedMsgIds = new Set();
  const foreshadows = await db.foreshadowing.where('storyId').equals(story.id).toArray();
  const bookmarks = await db.bookmarks.where('storyId').equals(story.id).toArray();
  const plotTags = await db.plotTags.where('storyId').equals(story.id).toArray();
  foreshadows.forEach(f => protectedMsgIds.add(f.messageId));
  bookmarks.forEach(b => protectedMsgIds.add(b.messageId));
  plotTags.forEach(t => protectedMsgIds.add(t.messageId));
  
  if(mode === 'chapter'){
    // ÊåâÁ´†ÁØÄÂ£ìÁ∏Æ
    const chapterMsgId = document.getElementById('compress-chapter').value;
    if(!chapterMsgId){
      toast(T('Ë´ãÈÅ∏ÊìáÁ´†ÁØÄ'),'warning');
      return;
    }
    const chapterMsgIdx = msgs.findIndex(m => m.id === chapterMsgId);
    if(chapterMsgIdx <= 0){
      toast(T('Ë©≤Á´†ÁØÄ‰πãÂâçÊ≤íÊúâÂèØÂ£ìÁ∏ÆÁöÑÊ∂àÊÅØ'),'info');
      closeModal('memory-modal');
      return;
    }
    // Â£ìÁ∏ÆÁ´†ÁØÄ‰πãÂâçÁöÑÊ∂àÊÅØÔºàÊéíÈô§Âèó‰øùË≠∑ÁöÑÔºâ
    for(let i = 0; i < chapterMsgIdx; i++){
      if(!protectedMsgIds.has(msgs[i].id)){
        toCompress.push(msgs[i]);
      }
    }
    count = toCompress.length;
  } else if(mode === 'manual'){
    // ÊâãÂãïÈÅ∏Êìá
    if(manualSelectedMsgIds.size === 0){
      toast(T('Ë´ãÂÖàÈÅ∏ÊìáË¶ÅÂ£ìÁ∏ÆÁöÑÊ∂àÊÅØ'),'warning');
      return;
    }

    // Ê†πÊìöÈÅ∏‰∏≠ÁöÑIDÁç≤ÂèñÊ∂àÊÅØ
    for(const msg of msgs){
      if(manualSelectedMsgIds.has(msg.id)){
        toCompress.push(msg);
      }
    }
    count = toCompress.length;
  } else {
    // ÊåâÊï∏ÈáèÂ£ìÁ∏Æ
    const option = document.getElementById('compress-count').value;
    let targetCount = parseInt(option) || 10;
    if(option === 'all') targetCount = Math.max(0, msgs.length - 20);

    // ÂæûÊúÄÊó©ÁöÑÊ∂àÊÅØÈñãÂßãÔºåÊéíÈô§Âèó‰øùË≠∑ÁöÑ
    for(let i = 0; i < msgs.length && toCompress.length < targetCount; i++){
      if(!protectedMsgIds.has(msgs[i].id)){
        toCompress.push(msgs[i]);
      }
    }
    count = toCompress.length;
  }
  
  if(count <= 0){
    toast(T('Ê≤íÊúâÂèØÂ£ìÁ∏ÆÁöÑÊ∂àÊÅØÔºàÈáçË¶ÅÊ∂àÊÅØÂ∑≤Âèó‰øùË≠∑Ôºâ'),'info');
    closeModal('memory-modal');
    return;
  }

  // È°ØÁ§∫Á¢∫Ë™ç
  let skipped = 0;
  if(mode === 'chapter'){
    const chapterMsgIdx = msgs.findIndex(m => m.id === document.getElementById('compress-chapter').value);
    skipped = chapterMsgIdx - count;
  } else if(mode === 'manual'){
    skipped = manualSelectedMsgIds.size - count;
  } else {
    const targetCount = document.getElementById('compress-count').value === 'all' ?
      Math.max(0, msgs.length - 20) :
      (parseInt(document.getElementById('compress-count').value) || 10);
    skipped = targetCount - count;
  }

  let confirmMsg = `Â∞áÂ£ìÁ∏Æ ${count} Ê¢ùÊ∂àÊÅØ`;
  if(skipped > 0){
    confirmMsg += `ÔºàÂ∑≤Ë∑≥ÈÅé ${skipped} Ê¢ùÂèó‰øùË≠∑Ê∂àÊÅØÔºâ`;
  }
  if(mode === 'manual'){
    confirmMsg += '\n\nÂ∑≤ÈÅ∏ÊìáÁöÑÊ∂àÊÅØÂ∞áË¢´Âêà‰ΩµÊàê‰∏ÄÊ¢ùÊô∫ËÉΩÊëòË¶Å„ÄÇ';
  }
  confirmMsg += '\n\nAI Â∞áÁîüÊàêÊô∫ËÉΩÊëòË¶Å‰øùÁïôÈóúÈçµ‰ø°ÊÅØ„ÄÇÁ¢∫ÂÆöÁπºÁ∫åÔºü';
  
  // ÂÖàÈóúÈñâË®òÊÜ∂ÁÆ°ÁêÜÁïåÈù¢ÔºåÂÜçÈ°ØÁ§∫Á¢∫Ë™çÂ∞çË©±Ê°Ü
  closeModal('memory-modal');
  
  showConfirm(confirmMsg, async () => {
    showLoading('AI Ê≠£Âú®ÁîüÊàêÊô∫ËÉΩÊëòË¶Å...');
    try{
      // Â£ìÁ∏ÆÂâç‰øùÂ≠òËßíËâ≤Âø´ÁÖß
      await saveCharacterSnapshot();
      
      // ‰ΩøÁî® AI ÁîüÊàêÊô∫ËÉΩÊëòË¶Å
      let summary;
      try {
        summary = await generateAISummary(toCompress);
      } catch(aiError) {
        console.warn('AI ÊëòË¶ÅÁîüÊàêÂ§±ÊïóÔºå‰ΩøÁî®Á∞°ÂñÆÊëòË¶Å:', aiError);
        summary = generateSimpleSummary(toCompress);
      }
      
      hideLoading();
      
      // ‰øùÂ≠òÂæÖÂ£ìÁ∏ÆÊï∏ÊìöÔºåÈ°ØÁ§∫È†êË¶ΩËÆìÁî®Êà∂Á∑®ËºØ
      pendingCompressData = {
        toCompress,
        count,
        summary
      };
      
      // È°ØÁ§∫ÊëòË¶ÅÈ†êË¶Ω
      document.getElementById('summary-preview-content').value = summary;
      showModal('summary-preview-modal');
      
    }catch(e){
      hideLoading();
      toast('ÁîüÊàêÊëòË¶ÅÂ§±Êïó: '+e.message,'error');
    }
  });
}

// ÂèñÊ∂àÊëòË¶ÅÈ†êË¶Ω
function cancelSummaryPreview(){
  closeModal('summary-preview-modal');
  pendingCompressData = null;
  toast(T('Â∑≤ÂèñÊ∂àÂ£ìÁ∏Æ'),'info');
}

// Á¢∫Ë™çÂ£ìÁ∏ÆÊëòË¶Å
async function confirmSummaryCompress(){
  if(!pendingCompressData){
    toast(T('Ê≤íÊúâÂæÖÂ£ìÁ∏ÆÁöÑÊï∏Êìö'),'error');
    closeModal('summary-preview-modal');
    return;
  }
  
  const { toCompress, count } = pendingCompressData;
  const editedSummary = document.getElementById('summary-preview-content').value.trim();
  
  if(!editedSummary){
    toast(T('ÊëòË¶ÅÂÖßÂÆπ‰∏çËÉΩÁÇ∫Á©∫'),'warning');
    return;
  }
  
  showLoading('Ê≠£Âú®Â£ìÁ∏ÆÊ∂àÊÅØ...');
  
  try{
    // Âà™Èô§ËàäÊ∂àÊÅØ
    const ids = toCompress.map(m => m.id);
    await db.messages.bulkDelete(ids);
    msgs = msgs.filter(m => !ids.includes(m.id));
    
    // ‰øùÂ≠òÊëòË¶ÅÂà∞ÊïÖ‰∫ã
    const summaries = story.summaries || [];
    summaries.push({
      content: editedSummary,
      createdAt: Date.now(),
      count,
      isAI: true,
      type: 'compressed'
    });
    await db.stories.update(story.id, {summaries, compressedCount: (story.compressedCount||0)+count});
    story.summaries = summaries;
    story.compressedCount = (story.compressedCount||0)+count;
    
    renderMsgs();
    hideLoading();
    closeModal('summary-preview-modal');
    pendingCompressData = null;
    
    // È°ØÁ§∫ÊàêÂäüÊèêÁ§∫ÔºåÂëäÁü•Áî®Êà∂ÂèØ‰ª•Á∑®ËºØ
    showConfirm(
      `‚úÖ Â∑≤ÊàêÂäüÂ£ìÁ∏Æ ${count} Ê¢ùÊ∂àÊÅØÔºÅ\n\nÊëòË¶ÅÂ∑≤‰øùÂ≠ò„ÄÇÂ¶ÇÈúÄ‰øÆÊîπÔºåÂèØÂâçÂæÄ„ÄåË®òÊÜ∂ÁÆ°ÁêÜ„Äç‚Üí„Äåüìä Êü•Áúã„ÄçÁ∑®ËºØÊëòË¶ÅÂÖßÂÆπ„ÄÇ`,
      null, false, 'Â£ìÁ∏ÆÂÆåÊàê'
    );
  }catch(e){
    hideLoading();
    toast('Â£ìÁ∏ÆÂ§±Êïó: '+e.message,'error');
  }
}

// v18: AI Êô∫ËÉΩÊëòË¶ÅÁîüÊàê
async function generateAISummary(messages){
  const preset = await db.apiPresets.filter(p=>p.isActive).first();
  if(!preset || !preset.apiKey){
    throw new Error('Êú™ÈÖçÁΩÆ API');
  }
  
  // ÊßãÂª∫Ë¶ÅÊëòË¶ÅÁöÑÂÖßÂÆπ
  const content = messages.map(m => {
    const role = m.role === 'user' ? '„ÄêÁé©ÂÆ∂Ë°åÂãï„Äë' : '„ÄêÂäáÊÉÖÁôºÂ±ï„Äë';
    return `${role}\n${m.content}`;
  }).join('\n\n---\n\n');
  
  // ÈôêÂà∂Èï∑Â∫¶ÈÅøÂÖçË∂ÖÂá∫ token
  const truncatedContent = content.slice(0, 15000);
  
  const summaryPrompt = `Ë´ãÁÇ∫‰ª•‰∏ã‰∫íÂãïÂ∞èË™™ÁâáÊÆµÁîüÊàê‰∏Ä‰ªΩÁµêÊßãÂåñÊëòË¶Å„ÄÇÈÄô‰ªΩÊëòË¶ÅÂ∞áÁî®ÊñºÂπ´Âä© AI Âú®ÂæåÁ∫åÂäáÊÉÖ‰∏≠‰øùÊåÅÈÄ£Ë≤´ÊÄß„ÄÇ

„ÄêË¶ÅÊëòË¶ÅÁöÑÂÖßÂÆπ„Äë
${truncatedContent}

„ÄêÊëòË¶ÅË¶ÅÊ±Ç„Äë
Ë´ãÊåâ‰ª•‰∏ãÊ†ºÂºèËº∏Âá∫ÊëòË¶ÅÔºàÁ∏ΩÈï∑Â∫¶ 1000-1500 Â≠óÔºâÔºö

## üìñ ÂäáÊÉÖÊ¶ÇË¶Å
ÔºàÁî® 3-4 ÊÆµË©±Ë©≥Á¥∞Ê¶ÇËø∞‰∏ªË¶Å‰∫ã‰ª∂ÁôºÂ±ïÔºå300-400Â≠óÔºâ

## üë• ËßíËâ≤ÂãïÊÖã
ÔºàÂàóÂá∫Âá∫ÁèæÁöÑÈáçË¶ÅËßíËâ≤ÂèäÂÖ∂ÁãÄÊÖãËÆäÂåñ„ÄÅÈóú‰øÇËÆäÂåñ„ÄÅÂøÉÁêÜËÆäÂåñÔºå300-400Â≠óÔºâ

## üîë ÈóúÈçµ‰ø°ÊÅØ
ÔºàÂàóÂá∫ÈáçË¶ÅÁöÑÂú∞Èªû„ÄÅÁâ©ÂìÅ„ÄÅÁ∑öÁ¥¢„ÄÅÁ¥ÑÂÆö„ÄÅ‰ºèÁ≠ÜÁ≠âÈúÄË¶ÅË®ò‰ΩèÁöÑÁ¥∞ÁØÄÔºå200-300Â≠óÔºâ

## ‚ö° Áï∂ÂâçÂ±ÄÂã¢
ÔºàË©≥Á¥∞ÊèèËø∞ÁõÆÂâçÁöÑËôïÂ¢É„ÄÅÂæÖËß£Ê±∫ÁöÑÂïèÈ°å„ÄÅÂèØËÉΩÁöÑÁôºÂ±ïÊñπÂêëÔºå200-300Â≠óÔºâ

**üö® Ê•µÂÖ∂ÈáçË¶ÅÁöÑË¶ÅÊ±ÇÔºö**
1. ‰Ω†ÂøÖÈ†àÂÆåÊï¥Ëº∏Âá∫ÊâÄÊúâ 4 ÂÄãÈÉ®ÂàÜÔºàüìñ ÂäáÊÉÖÊ¶ÇË¶Å„ÄÅüë• ËßíËâ≤ÂãïÊÖã„ÄÅüîë ÈóúÈçµ‰ø°ÊÅØ„ÄÅ‚ö° Áï∂ÂâçÂ±ÄÂã¢Ôºâ
2. ÊØèÂÄãÈÉ®ÂàÜÈÉΩÂøÖÈ†àÈÅîÂà∞ÊåáÂÆöÂ≠óÊï∏Ôºå‰∏çÂèØÊèêÂâçÁµêÊùü
3. ‰Ω†Êúâ 16000 tokens ÁöÑÈ°çÂ∫¶ÔºåÂÆåÂÖ®Ë∂≥Â§†Ëº∏Âá∫ 1500 Â≠óÁöÑ‰∏≠ÊñáÂÖßÂÆπ
4. Ë´ã‰∏ÄÊ¨°ÊÄßÂÆåÊï¥Ëº∏Âá∫ÊâÄÊúâÂÖßÂÆπÔºå‰∏çË¶Å‰∏≠ÈÄîÂÅúÊ≠¢
5. Â¶ÇÊûúÂÖßÂÆπ‰∏çÂ§†Ë©≥Á¥∞ÔºåË´ãË£úÂÖÖÊõ¥Â§öÁ¥∞ÁØÄ„ÄÅÂ∞çË©±„ÄÅÊÉÖÁ∑íÊèèÂØ´

ÁèæÂú®ÈñãÂßãËº∏Âá∫ÂÆåÊï¥ÁöÑÊëòË¶ÅÔºö`;

  // Ë™øÁî® AI
  let response;
  if(preset.type === 'anthropic'){
    response = await callAnthropicDirect(preset, summaryPrompt);
  } else if(preset.type === 'openai'){
    response = await callOpenAIDirect(preset, summaryPrompt);
  } else {
    response = await callCustomDirect(preset, summaryPrompt);
  }

  return response.content;
}

// Áõ¥Êé•Ë™øÁî® APIÔºà‰∏çÂ∏∂ÊïÖ‰∫ã‰∏ä‰∏ãÊñáÔºâ
async function callAnthropicDirect(p, prompt){
  const r = await fetch('https://api.anthropic.com/v1/messages',{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'x-api-key':p.apiKey,
      'anthropic-version':'2023-06-01',
      'anthropic-dangerous-direct-browser-access':'true'
    },
    body:JSON.stringify({
      model: p.model,
      max_tokens: 8000,  // Ë™øÊï¥ÁÇ∫ 8000ÔºàClaude ÂèØÁî®ÔºåGemini ÂèØËÉΩÈúÄË¶ÅÊõ¥‰ΩéÔºâ
      messages: [{role:'user', content: prompt}]
    })
  });
  if(!r.ok){
    const e = await r.json().catch(()=>({}));
    throw new Error(e.error?.message || `APIÈåØË™§ (${r.status})`);
  }
  const d = await r.json();
  return {content: d.content[0].text};
}

async function callOpenAIDirect(p, prompt){
  const r = await fetch('https://api.openai.com/v1/chat/completions',{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'Authorization':'Bearer '+p.apiKey
    },
    body:JSON.stringify({
      model: p.model,
      max_tokens: 8000,  // Ë™øÊï¥ÁÇ∫ 8000ÔºàClaude ÂèØÁî®ÔºåGemini ÂèØËÉΩÈúÄË¶ÅÊõ¥‰ΩéÔºâ
      messages: [{role:'user', content: prompt}]
    })
  });
  if(!r.ok){
    const e = await r.json().catch(()=>({}));
    throw new Error(e.error?.message || `APIÈåØË™§ (${r.status})`);
  }
  const d = await r.json();
  return {content: d.choices[0].message.content};
}

async function callCustomDirect(p, prompt){
  const autoComplete = p.urlAutoComplete !== false;
  const apiUrl = normalizeApiUrl(p.url, autoComplete, p.model);

  // Êô∫ËÉΩÂà§Êñ∑Ê†ºÂºèÔºöÂ¶ÇÊûú URL ÂåÖÂê´ /messagesÔºå‰ΩøÁî® Anthropic Ê†ºÂºèÔºåÂê¶Ââá‰ΩøÁî® OpenAI Ê†ºÂºè
  const isAnthropicFormat = apiUrl.includes('/messages') || apiUrl.includes('/anthropic');

  let requestBody;
  let headers = {
    'Content-Type':'application/json',
    'Authorization':'Bearer '+p.apiKey
  };

  if(isAnthropicFormat){
    // Anthropic Ê†ºÂºè
    headers['anthropic-version'] = '2023-06-01';
    requestBody = {
      model: p.model,
      max_tokens: 8000,  // Ë™øÊï¥ÁÇ∫ 8000ÔºàClaude ÂèØÁî®ÔºåGemini ÂèØËÉΩÈúÄË¶ÅÊõ¥‰ΩéÔºâ
      messages: [{role:'user', content: prompt}]
    };
  } else {
    // OpenAI Ê†ºÂºè
    requestBody = {
      model: p.model,
      max_tokens: 8000,  // Ë™øÊï¥ÁÇ∫ 8000ÔºàClaude ÂèØÁî®ÔºåGemini ÂèØËÉΩÈúÄË¶ÅÊõ¥‰ΩéÔºâ
      messages: [{role:'user', content: prompt}]
    };
  }

  const r = await fetch(apiUrl,{
    method:'POST',
    headers: headers,
    body:JSON.stringify(requestBody)
  });
  if(!r.ok){
    const e = await r.json().catch(()=>({}));
    throw new Error(e.error?.message || `APIÈåØË™§ (${r.status})`);
  }
  const d = await r.json();

  // Ê†πÊìöÊ†ºÂºèËß£ÊûêÂõûÊáâ
  let content;
  if(isAnthropicFormat){
    // Anthropic Ê†ºÂºèÔºöd.content[0].text
    content = d.content?.[0]?.text || d.choices?.[0]?.message?.content || d.response || '';
  } else {
    // OpenAI Ê†ºÂºèÔºöd.choices[0].message.content
    content = d.choices?.[0]?.message?.content || d.content?.[0]?.text || d.response || '';
  }

  if(!content) throw new Error('ÁÑ°Ê≥ïËß£Êûê API ÂõûÊáâ');
  return {content};
}

// Á∞°ÂñÆÊëòË¶ÅÔºàAI Â§±ÊïóÊôÇÁöÑÂÇôÈÅ∏ÊñπÊ°àÔºâ
function generateSimpleSummary(messages){
  const events = [];
  const characters = new Set();
  const locations = new Set();
  
  messages.forEach(m => {
    if(m.role === 'user'){
      events.push(`‚Ä¢ Áé©ÂÆ∂Ôºö${m.content.slice(0, 80)}${m.content.length > 80 ? '...' : ''}`);
    } else {
      // ÊèêÂèñÂâç 200 Â≠ó‰ΩúÁÇ∫ÊëòË¶Å
      const preview = m.content.slice(0, 200).replace(/\n+/g, ' ');
      events.push(`‚Ä¢ ÂäáÊÉÖÔºö${preview}${m.content.length > 200 ? '...' : ''}`);
      
      // ÂòóË©¶ÊèêÂèñËßíËâ≤ÂêçÔºàÁ∞°ÂñÆÂïüÁôºÂºèÔºâ
      const nameMatches = m.content.match(/„Äå[^„Äç]+„Äç|„Äé[^„Äè]+„Äè|„Äê[^„Äë]+„Äë/g);
      if(nameMatches){
        nameMatches.slice(0, 5).forEach(n => characters.add(n));
      }
    }
  });
  
  let summary = '## üìñ ÂäáÊÉÖÊ¶ÇË¶Å\n';
  summary += events.slice(0, 15).join('\n') + '\n';
  
  if(characters.size > 0){
    summary += '\n## üë• Âá∫ÁèæËßíËâ≤\n';
    summary += Array.from(characters).slice(0, 10).join('„ÄÅ') + '\n';
  }
  
  summary += '\n## ‚ö†Ô∏è Ê≥®ÊÑè\n';
  summary += 'Ê≠§ÁÇ∫Á∞°ÊòìÊëòË¶ÅÔºåÈÉ®ÂàÜÁ¥∞ÁØÄÂèØËÉΩÈÅ∫Êºè„ÄÇ';
  
  return summary;
}

// v18: Êü•ÁúãÊëòË¶Å
let editSummaryIdx = null;
let editSummaryType = null; // 'compressed' | 'rolling'

function viewSummaries(){
  if(!story){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'),'warning');return;}

  // ÈáçÁΩÆÊ®°ÊÖãÊ°ÜÁãÄÊÖã
  document.querySelector('#summaries-modal .modal-title').textContent = 'üìö Ë®òÊÜ∂ÊëòË¶Å';
  const clearBtn = document.querySelector('#summaries-modal .modal-btn[onclick="clearAllSummaries()"]');
  if(clearBtn) clearBtn.style.display = '';

  const summaries = story.summaries || [];
  const rollingSummaries = story.rollingSummaries || [];
  const c = document.getElementById('summaries-list');

  if(!summaries.length && !rollingSummaries.length){
    c.innerHTML = '<div class="empty" style="padding:30px"><div class="empty-icon">üì≠</div><div class="empty-title">Êö´ÁÑ°ÊëòË¶Å</div><div class="empty-desc">Â£ìÁ∏ÆË®òÊÜ∂ÊàñÁîüÊàêÊªæÂãïÊëòË¶ÅÂæåÊúÉÈ°ØÁ§∫Âú®ÈÄôË£°</div></div>';
    showModal('summaries-modal');
    return;
  }
  
  let html = '';
  
  // Â£ìÁ∏ÆÊëòË¶Å
  if(summaries.length > 0){
    html += '<div style="font-weight:600;margin-bottom:8px;color:var(--primary)">üì¶ Â£ìÁ∏ÆÊëòË¶Å</div>';
    html += summaries.map((s, idx) => {
      const time = new Date(s.createdAt).toLocaleString();
      const aiTag = s.isAI ? '<span style="background:var(--primary);color:white;padding:2px 6px;border-radius:4px;font-size:11px;margin-left:6px">ü§ñ AI</span>' : '<span style="background:var(--text-tertiary);color:white;padding:2px 6px;border-radius:4px;font-size:11px;margin-left:6px">Á∞°Êòì</span>';
      const typeTag = s.type === 'merged' ? '<span style="background:var(--warning);color:black;padding:2px 6px;border-radius:4px;font-size:11px;margin-left:6px">Â∑≤Âêà‰Ωµ</span>' : '';
      return `
        <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <span style="font-weight:600">Ë®òÊÜ∂ÁâáÊÆµ ${idx + 1}${aiTag}${typeTag}</span>
            <span style="font-size:12px;color:var(--text-tertiary)">${time}</span>
          </div>
          <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px">Â£ìÁ∏Æ‰∫Ü ${s.count || 0} Ê¢ùÊ∂àÊÅØ</div>
          <div style="font-size:13px;white-space:pre-wrap;line-height:1.6;max-height:200px;overflow-y:auto;background:var(--bg-secondary);padding:10px;border-radius:6px">${esc(s.content)}</div>
          <div style="margin-top:8px;text-align:right;display:flex;justify-content:flex-end;gap:12px">
            <button onclick="editSummary(${idx},'compressed')" style="background:none;border:none;color:var(--primary);cursor:pointer;font-size:12px">‚úèÔ∏è Á∑®ËºØ</button>
            <button onclick="deleteSummary(${idx},'compressed')" style="background:none;border:none;color:var(--error);cursor:pointer;font-size:12px">üóëÔ∏è Âà™Èô§</button>
          </div>
        </div>
      `;
    }).join('');
  }
  
  // ÊªæÂãïÊëòË¶Å
  if(rollingSummaries.length > 0){
    html += '<div style="font-weight:600;margin:16px 0 8px;color:var(--success)">üìú ÊªæÂãïÊëòË¶ÅÔºà‰∏çÂà™Èô§ÂéüÊñáÔºâ</div>';
    html += rollingSummaries.map((s, idx) => {
      const time = new Date(s.createdAt).toLocaleString();
      return `
        <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;margin-bottom:12px;border-left:3px solid var(--success)">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <span style="font-weight:600">ËÉåÊôØÊëòË¶Å ${idx + 1}</span>
            <span style="font-size:12px;color:var(--text-tertiary)">${time}</span>
          </div>
          <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px">Ê∂µËìã ${s.msgCount || '?'} Ê¢ùÊ∂àÊÅØ</div>
          <div style="font-size:13px;white-space:pre-wrap;line-height:1.6;max-height:150px;overflow-y:auto;background:var(--bg-secondary);padding:10px;border-radius:6px">${esc(s.content)}</div>
          <div style="margin-top:8px;text-align:right;display:flex;justify-content:flex-end;gap:12px">
            <button onclick="editSummary(${idx},'rolling')" style="background:none;border:none;color:var(--primary);cursor:pointer;font-size:12px">‚úèÔ∏è Á∑®ËºØ</button>
            <button onclick="deleteSummary(${idx},'rolling')" style="background:none;border:none;color:var(--error);cursor:pointer;font-size:12px">üóëÔ∏è Âà™Èô§</button>
          </div>
        </div>
      `;
    }).join('');
  }
  
  c.innerHTML = html;
  showModal('summaries-modal');
}

// Á∑®ËºØÊëòË¶Å
function editSummary(idx, type){
  const summaries = type === 'rolling' ? (story.rollingSummaries || []) : (story.summaries || []);
  const summary = summaries[idx];
  if(!summary) return;
  
  editSummaryIdx = idx;
  editSummaryType = type;
  
  const title = type === 'rolling' ? `‚úèÔ∏è Á∑®ËºØÊªæÂãïÊëòË¶Å #${idx + 1}` : `‚úèÔ∏è Á∑®ËºØË®òÊÜ∂ÁâáÊÆµ #${idx + 1}`;
  document.getElementById('edit-summary-title').textContent = title;
  document.getElementById('edit-summary-content').value = summary.content;
  
  showModal('edit-summary-modal');
}

// ‰øùÂ≠òÊëòË¶ÅÁ∑®ËºØ
async function saveSummaryEdit(){
  if(editSummaryIdx === null || !editSummaryType) return;
  
  const content = document.getElementById('edit-summary-content').value.trim();
  if(!content){
    toast(T('ÊëòË¶ÅÂÖßÂÆπ‰∏çËÉΩÁÇ∫Á©∫'),'warning');
    return;
  }
  
  const field = editSummaryType === 'rolling' ? 'rollingSummaries' : 'summaries';
  const summaries = story[field] || [];
  
  if(summaries[editSummaryIdx]){
    summaries[editSummaryIdx].content = content;
    summaries[editSummaryIdx].updatedAt = Date.now();
    
    await db.stories.update(story.id, { [field]: summaries });
    story[field] = summaries;
    
    closeModal('edit-summary-modal');
    viewSummaries(); // Âà∑Êñ∞ÂàóË°®
    toast(T('ÊëòË¶ÅÂ∑≤Êõ¥Êñ∞'), 'success');
  }
  
  editSummaryIdx = null;
  editSummaryType = null;
}

// Âà™Èô§ÂñÆÊ¢ùÊëòË¶Å
async function deleteSummary(idx, type = 'compressed'){
  const typeName = type === 'rolling' ? 'ÊªæÂãïÊëòË¶Å' : 'Ë®òÊÜ∂ÊëòË¶Å';
  if(!confirm(`Á¢∫ÂÆöÂà™Èô§ÈÄôÊ¢ù${typeName}ÔºüÂà™Èô§Âæå AI Â∞áÁÑ°Ê≥ïÂèÉËÄÉÈÄôÊÆµË®òÊÜ∂„ÄÇ`)) return;
  
  const field = type === 'rolling' ? 'rollingSummaries' : 'summaries';
  const summaries = story[field] || [];
  summaries.splice(idx, 1);
  
  await db.stories.update(story.id, { [field]: summaries });
  story[field] = summaries;
  
  // Êõ¥Êñ∞UIË®àÊï∏
  if(type === 'rolling'){
    document.getElementById('memory-rolling-count').textContent = summaries.length;
  } else {
    document.getElementById('memory-summary-count').textContent = summaries.length;
  }
  
  viewSummaries(); // Âà∑Êñ∞ÂàóË°®
  toast(T('ÊëòË¶ÅÂ∑≤Âà™Èô§'), 'success');
}

// Ê∏ÖÁ©∫ÊâÄÊúâÊëòË¶Å
async function clearAllSummaries(){
  if(!story){return;}
  
  const summaries = story.summaries || [];
  const rollingSummaries = story.rollingSummaries || [];
  const totalCount = summaries.length + rollingSummaries.length;
  
  if(totalCount === 0){
    toast(T('Êö´ÁÑ°ÊëòË¶ÅÂèØÊ∏ÖÁ©∫'), 'info');
    return;
  }
  
  let confirmMsg = `Á¢∫ÂÆöÊ∏ÖÁ©∫ÂÖ®ÈÉ®ÊëòË¶ÅÂóéÔºü\n\n`;
  if(summaries.length > 0) confirmMsg += `‚Ä¢ ${summaries.length} Ê¢ùÂ£ìÁ∏ÆÊëòË¶Å\n`;
  if(rollingSummaries.length > 0) confirmMsg += `‚Ä¢ ${rollingSummaries.length} Ê¢ùÊªæÂãïÊëòË¶Å\n`;
  confirmMsg += `\n‚ö†Ô∏è Ê∏ÖÁ©∫Âæå AI Â∞áÂÆåÂÖ®Â§±ÂéªÂ∞çÈÄô‰∫õÂäáÊÉÖÁöÑË®òÊÜ∂ÔºÅ`;
  
  if(!confirm(confirmMsg)) return;
  
  await db.stories.update(story.id, {
    summaries: [], 
    rollingSummaries: [],
    compressedCount: 0
  });
  story.summaries = [];
  story.rollingSummaries = [];
  story.compressedCount = 0;
  
  document.getElementById('memory-summary-count').textContent = '0';
  document.getElementById('memory-compressed').textContent = '0';
  document.getElementById('memory-rolling-count').textContent = '0';
  closeModal('summaries-modal');
  toast(T('ÊâÄÊúâÊëòË¶ÅÂ∑≤Ê∏ÖÁ©∫'), 'success');
}

// ============ Ë®òÊÜ∂ÂèØË¶ñÂåñ ============

// Êõ¥Êñ∞Ë®òÊÜ∂ÂèØË¶ñÂåñÊï∏Êìö
function updateMemoryViz(){
  if(!story) return;

  try {
    const importantCount = msgs.filter(m => m.isImportant).length;
    const summariesCount = (story.summaries || []).length;
    const rollingCount = (story.rollingSummaries || []).length;
    const messagesCount = msgs.length;
    const total = importantCount + summariesCount + rollingCount + messagesCount;

    // Êõ¥Êñ∞‰∏ä‰∏ãÊñáÊï∏ÈáèÈ°ØÁ§∫
    const contextCount = settings.contextCount || 20;
    const actualContextCount = Math.min(contextCount, messagesCount);

    // ÂÆâÂÖ®Êõ¥Êñ∞ÂÖÉÁ¥†
    const updateElement = (id, value) => {
      const el = document.getElementById(id);
      if(el) el.textContent = value;
    };

    const updateStyle = (id, property, value) => {
      const el = document.getElementById(id);
      if(el) el.style[property] = value;
    };

    updateElement('viz-context-count', actualContextCount);
    updateElement('viz-count-important', importantCount);
    updateElement('viz-count-summaries', summariesCount);
    updateElement('viz-count-rolling', rollingCount);
    updateElement('viz-count-messages', messagesCount);

    // Êõ¥Êñ∞ÈÄ≤Â∫¶Ê¢ùÔºàÊåâÊØî‰æãÔºâ
    const maxCount = Math.max(importantCount, summariesCount, rollingCount, messagesCount, 1);
    updateStyle('viz-bar-important', 'width', (importantCount / maxCount * 100) + '%');
    updateStyle('viz-bar-summaries', 'width', (summariesCount / maxCount * 100) + '%');
    updateStyle('viz-bar-rolling', 'width', (rollingCount / maxCount * 100) + '%');
    updateStyle('viz-bar-messages', 'width', (messagesCount / maxCount * 100) + '%');

    // ‰º∞ÁÆó Token ‰ΩøÁî®
    const importantTokens = importantCount * 150; // ÊØèÊ¢ùÈáçË¶ÅË®òÊÜ∂Á¥Ñ150 tokens
    const summariesTokens = summariesCount * 100; // ÊØèÊ¢ùÊëòË¶ÅÁ¥Ñ100 tokens
    const rollingTokens = rollingCount * 80; // ÊØèÊ¢ùÊªæÂãïÊëòË¶ÅÁ¥Ñ80 tokens
    const contextTokens = actualContextCount * 200; // ÂØ¶Èöõ‰∏ä‰∏ãÊñáÊï∏ÈáèÔºåÊØèÊ¢ùÁ¥Ñ200 tokens
    const totalTokens = importantTokens + summariesTokens + rollingTokens + contextTokens;

    updateElement('viz-tokens-important', `~${importantTokens} tokens`);
    updateElement('viz-tokens-summaries', `~${summariesTokens + rollingTokens} tokens`);
    updateElement('viz-tokens-context', `~${contextTokens} tokens`);
    updateElement('viz-tokens-total', `~${totalTokens} tokens`);

    // Ë®àÁÆóÂÅ•Â∫∑Â∫¶
    let healthScore = 100;
    let healthText = 'ÂÑ™ÁßÄ';
    let healthColor = 'var(--success)';
    let tips = [];

    // Â¶ÇÊûúÊ∂àÊÅØÂ§™Â§ö‰ΩÜÊ≤íÊúâÊëòË¶Å
    if(messagesCount > 50 && summariesCount === 0 && rollingCount === 0){
      healthScore -= 30;
      tips.push('Âª∫Ë≠∞ÁîüÊàêÊëòË¶Å‰ª•ÂÑ™ÂåñË®òÊÜ∂ÁÆ°ÁêÜ');
    }

    // Â¶ÇÊûúToken‰ΩøÁî®ÈÅéÈ´ò
    if(totalTokens > 8000){
      healthScore -= 20;
      tips.push('Token‰ΩøÁî®ËºÉÈ´òÔºåÂª∫Ë≠∞Â£ìÁ∏ÆÈÉ®ÂàÜËàäÊ∂àÊÅØ');
    }

    // Â¶ÇÊûúÊ≤íÊúâÈáçË¶ÅË®òÊÜ∂Ê®ôË®ò
    if(messagesCount > 20 && importantCount === 0){
      healthScore -= 15;
      tips.push('ÂèØÊ®ôË®òÈóúÈçµÂäáÊÉÖÁÇ∫ÈáçË¶ÅË®òÊÜ∂');
    }

    // Â¶ÇÊûúÊªæÂãïÊëòË¶ÅÈÅéÂ§ö
    if(rollingCount > 15){
      healthScore -= 10;
      tips.push('ÊªæÂãïÊëòË¶ÅËºÉÂ§öÔºåÂèØËÄÉÊÖÆÂêà‰Ωµ');
    }

    if(healthScore >= 90){
      healthText = 'ÂÑ™ÁßÄ';
      healthColor = 'var(--success)';
    } else if(healthScore >= 70){
      healthText = 'ËâØÂ•Ω';
      healthColor = 'var(--info)';
    } else if(healthScore >= 50){
      healthText = '‰∏ÄËà¨';
      healthColor = 'var(--warning)';
    } else {
      healthText = 'ÈúÄË¶ÅÂÑ™Âåñ';
      healthColor = 'var(--error)';
    }

    updateElement('viz-health-score', healthText);
    updateStyle('viz-health-score', 'color', healthColor);
    updateStyle('viz-health-bar', 'width', healthScore + '%');
    updateStyle('viz-health-bar', 'background', healthColor);

    const tipsEl = document.getElementById('viz-health-tips');
    if(tipsEl){
      if(tips.length > 0){
        tipsEl.innerHTML = 'üí° <strong>Âª∫Ë≠∞Ôºö</strong><br>' + tips.join('<br>');
      } else {
        tipsEl.innerHTML = '‚ú® Ë®òÊÜ∂Á≥ªÁµ±ÈÅãË°åËâØÂ•ΩÔºåÁÑ°ÈúÄÈ°çÂ§ñÂÑ™ÂåñÔºÅ';
      }
    }

  } catch(e) {
    console.error('[Memory] ÂèØË¶ñÂåñÊõ¥Êñ∞Â§±Êïó:', e);
  }
}

// Êü•ÁúãÊâÄÊúâÈáçË¶ÅÊ∂àÊÅØ
function showImportantMessages(){
  const importantMsgs = msgs.filter(m => m.isImportant);

  if(importantMsgs.length === 0){
    toast('Êö´ÁÑ°ÈáçË¶ÅË®òÊÜ∂Ê®ôË®ò', 'info');
    return;
  }

  let html = '';
  importantMsgs.forEach((msg, idx) => {
    const role = msg.role === 'user' ? '„ÄêÁé©ÂÆ∂„Äë' : '„ÄêÂäáÊÉÖ„Äë';
    const preview = msg.content.slice(0, 150);
    html += `
      <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;margin-bottom:10px;border-left:3px solid #FFD700">
        <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:6px">‚≠ê ÈáçË¶ÅË®òÊÜ∂ #${idx + 1} ${role}</div>
        <div style="font-size:13px;line-height:1.6">${esc(preview)}${msg.content.length > 150 ? '...' : ''}</div>
        <div style="font-size:11px;color:var(--text-tertiary);margin-top:6px">
          ${new Date(msg.createdAt).toLocaleString('zh-CN')}
        </div>
      </div>
    `;
  });

  // ‰ΩøÁî® summaries-list ÂÆπÂô®‰æÜÈ°ØÁ§∫
  document.getElementById('summaries-list').innerHTML = html;
  document.querySelector('#summaries-modal .modal-title').textContent = '‚≠ê ÈáçË¶ÅË®òÊÜ∂ÂàóË°®';

  // Èö±ËóèÊ∏ÖÁ©∫ÊåâÈàïÔºàÈáçË¶ÅË®òÊÜ∂‰∏çÊáâË©≤ÊâπÈáèÊ∏ÖÁ©∫Ôºâ
  const clearBtn = document.querySelector('#summaries-modal .modal-btn[onclick="clearAllSummaries()"]');
  if(clearBtn) clearBtn.style.display = 'none';

  showModal('summaries-modal');
  // Ê≥®ÊÑèÔºöviewSummaries() ÊúÉËá™ÂãïÈáçÁΩÆÊ®°ÊÖãÊ°ÜÁãÄÊÖã
}

// ============ v22 Êñ∞Â¢ûÔºöÊªæÂãïÊëòË¶Å„ÄÅÊô∫ËÉΩÂàÜÊûê„ÄÅÊëòË¶ÅÊêúÁ¥¢ ============

// ÁîüÊàêÊªæÂãïÊëòË¶ÅÔºà‰∏çÂà™Èô§ÂéüÊñáÔºâ
async function generateRollingSummary(){
  if(!story){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'),'warning');return;}
  if(msgs.length < 10){toast(T('Ê∂àÊÅØÂ§™Â∞ëÔºåÂª∫Ë≠∞Á¥ØÁ©çÊõ¥Â§öÂÖßÂÆπÂæåÂÜçÁîüÊàê'),'info');return;}
  
  showLoading('Ê≠£Âú®ÁîüÊàêÊªæÂãïÊëòË¶Å...');
  try{
    const preset = await db.apiPresets.filter(p=>p.isActive).first();
    if(!preset || !preset.apiKey){
      throw new Error('Êú™ÈÖçÁΩÆ API');
    }
    
    // ÂèñÊúÄËøëÁöÑÊ∂àÊÅØÔºàÊéíÈô§Â∑≤ÊúâÊªæÂãïÊëòË¶ÅË¶ÜËìãÁöÑÈÉ®ÂàÜÔºâ
    const rollingSummaries = story.rollingSummaries || [];
    const lastSummaryMsgIdx = rollingSummaries.length > 0 ? 
      msgs.findIndex(m => m.id === rollingSummaries[rollingSummaries.length - 1].lastMessageId) : -1;
    
    const startIdx = lastSummaryMsgIdx >= 0 ? lastSummaryMsgIdx + 1 : 0;
    const toSummarize = msgs.slice(startIdx);
    
    if(toSummarize.length < 5){
      hideLoading();
      toast(T('Ë∑ùÈõ¢‰∏äÊ¨°ÊëòË¶ÅÂæåÊ∂àÊÅØÂ§™Â∞ëÔºåÂª∫Ë≠∞ÁπºÁ∫åÈÅäÊà≤ÂæåÂÜçÁîüÊàê'),'info');
      return;
    }
    
    // ÊßãÂª∫ÂÖßÂÆπ
    const content = toSummarize.map(m => {
      const role = m.role === 'user' ? '„ÄêÁé©ÂÆ∂„Äë' : '„ÄêÂäáÊÉÖ„Äë';
      return `${role} ${m.content.slice(0, 500)}`;
    }).join('\n\n');
    
    const prompt = `Ë´ãÁÇ∫‰ª•‰∏ã‰∫íÂãïÂ∞èË™™ÁâáÊÆµÁîüÊàê‰∏Ä‰ªΩÁ∞°Áü≠ÁöÑËÉåÊôØÊëòË¶ÅÔºà200Â≠ó‰ª•ÂÖßÔºâ„ÄÇÈÄô‰ªΩÊëòË¶ÅÂ∞á‰ΩúÁÇ∫‰∏ä‰∏ãÊñáËÉåÊôØÔºåÂπ´Âä©AIÁêÜËß£ÊïÖ‰∫ãÈÄ≤Â±ï„ÄÇ

„ÄêÂÖßÂÆπ„Äë
${content.slice(0, 8000)}

„ÄêË¶ÅÊ±Ç„Äë
- Áî® 2-3 Âè•Ë©±Ê¶ÇËø∞‰∏ªË¶Å‰∫ã‰ª∂
- Ë®òÈåÑÈóúÈçµÁöÑËßíËâ≤‰∫íÂãïÊàñÁãÄÊÖãËÆäÂåñ
- ‰∏çÈúÄË¶ÅË©≥Á¥∞ÔºåÂè™ÈúÄË¶ÅÊ†∏ÂøÉË¶ÅÈªû
- Áõ¥Êé•Ëº∏Âá∫ÊëòË¶ÅÔºå‰∏çË¶ÅÂÖ∂‰ªñË™™Êòé`;

    let response;
    if(preset.type === 'anthropic'){
      response = await callAnthropicDirect(preset, prompt);
    } else if(preset.type === 'openai'){
      response = await callOpenAIDirect(preset, prompt);
    } else {
      response = await callCustomDirect(preset, prompt);
    }
    
    // ‰øùÂ≠òÊªæÂãïÊëòË¶Å
    rollingSummaries.push({
      content: response.content,
      createdAt: Date.now(),
      lastMessageId: msgs[msgs.length - 1].id,
      msgCount: toSummarize.length
    });
    
    await db.stories.update(story.id, { rollingSummaries });
    story.rollingSummaries = rollingSummaries;
    
    hideLoading();
    document.getElementById('memory-rolling-count').textContent = rollingSummaries.length;
    toast(T('ÊªæÂãïÊëòË¶ÅÂ∑≤ÁîüÊàêÔºàÂéüÊ∂àÊÅØ‰øùÁïôÔºâ'),'success');
  }catch(e){
    hideLoading();
    toast('ÁîüÊàêÂ§±Êïó: '+e.message,'error');
  }
}

// Ëá™ÂãïÁîüÊàêÊªæÂãïÊëòË¶ÅÔºàÂæåÂè∞ÈÅãË°åÔºå‰∏çÈòªÂ°ûÁî®Êà∂Ôºâ
async function autoGenerateRollingSummary(){
  if(!story || !settings.autoSummary) return;

  try {
    const rollingSummaries = story.rollingSummaries || [];

    // Ë®àÁÆóË∑ùÈõ¢‰∏äÊ¨°ÊëòË¶ÅÂæåÁöÑÊ∂àÊÅØÊï∏
    const lastSummaryMsgIdx = rollingSummaries.length > 0 ?
      msgs.findIndex(m => m.id === rollingSummaries[rollingSummaries.length - 1].lastMessageId) : -1;

    const startIdx = lastSummaryMsgIdx >= 0 ? lastSummaryMsgIdx + 1 : 0;
    const toSummarize = msgs.slice(startIdx);

    // Ê™¢Êü•ÊòØÂê¶ÈÅîÂà∞Ëá™ÂãïÊëòË¶ÅÈ†ªÁéá
    if(toSummarize.length < settings.autoSummaryFrequency) return;

    console.log(`[AutoSummary] Ê™¢Ê∏¨Âà∞ ${toSummarize.length} Ê¢ùÊñ∞Ê∂àÊÅØÔºåÈñãÂßãËá™ÂãïÁîüÊàêÊëòË¶Å...`);

    const preset = await db.apiPresets.filter(p=>p.isActive).first();
    if(!preset || !preset.apiKey){
      console.warn('[AutoSummary] Êú™ÈÖçÁΩÆ APIÔºåË∑≥ÈÅéËá™ÂãïÊëòË¶Å');
      return;
    }

    // ÊßãÂª∫ÂÖßÂÆπ
    const content = toSummarize.map(m => {
      const role = m.role === 'user' ? '„ÄêÁé©ÂÆ∂„Äë' : '„ÄêÂäáÊÉÖ„Äë';
      return `${role} ${m.content.slice(0, 500)}`;
    }).join('\n\n');

    const prompt = `Ë´ãÁÇ∫‰ª•‰∏ã‰∫íÂãïÂ∞èË™™ÁâáÊÆµÁîüÊàê‰∏Ä‰ªΩÁ∞°Áü≠ÁöÑËÉåÊôØÊëòË¶ÅÔºà150Â≠ó‰ª•ÂÖßÔºâ„ÄÇ

„ÄêÂÖßÂÆπ„Äë
${content.slice(0, 8000)}

„ÄêË¶ÅÊ±Ç„Äë
- Áî® 2-3 Âè•Ë©±Ê¶ÇËø∞‰∏ªË¶Å‰∫ã‰ª∂
- Ë®òÈåÑÈóúÈçµÁöÑËßíËâ≤‰∫íÂãïÊàñÁãÄÊÖãËÆäÂåñ
- ‰∏çÈúÄË¶ÅË©≥Á¥∞ÔºåÂè™ÈúÄË¶ÅÊ†∏ÂøÉË¶ÅÈªû
- Áõ¥Êé•Ëº∏Âá∫ÊëòË¶ÅÔºå‰∏çË¶ÅÂÖ∂‰ªñË™™Êòé`;

    let response;
    if(preset.type === 'anthropic'){
      response = await callAnthropicDirect(preset, prompt);
    } else if(preset.type === 'openai'){
      response = await callOpenAIDirect(preset, prompt);
    } else {
      response = await callCustomDirect(preset, prompt);
    }

    // ‰øùÂ≠òÊªæÂãïÊëòË¶Å
    rollingSummaries.push({
      content: response.content,
      createdAt: Date.now(),
      lastMessageId: msgs[msgs.length - 1].id,
      msgCount: toSummarize.length,
      auto: true  // Ê®ôË®òÁÇ∫Ëá™ÂãïÁîüÊàê
    });

    // ÈôêÂà∂ÊúÄÂ§ßÊëòË¶ÅÊï∏ÈáèÔºåÁßªÈô§ÊúÄËàäÁöÑ
    if(rollingSummaries.length > settings.maxRollingSummaries){
      const removed = rollingSummaries.splice(0, rollingSummaries.length - settings.maxRollingSummaries);
      console.log(`[AutoSummary] Ë∂ÖÂá∫ÊúÄÂ§ßÈôêÂà∂ÔºåÁßªÈô§‰∫Ü ${removed.length} Ê¢ùËàäÊëòË¶Å`);
    }

    await db.stories.update(story.id, { rollingSummaries });
    story.rollingSummaries = rollingSummaries;

    const countEl = document.getElementById('memory-rolling-count');
    if(countEl) countEl.textContent = rollingSummaries.length;

    console.log(`[AutoSummary] Ëá™ÂãïÊëòË¶ÅÂ∑≤ÁîüÊàêÔºåÁï∂ÂâçÂÖ± ${rollingSummaries.length} Ê¢ù`);
    toast('üìù Â∑≤Ëá™ÂãïÁîüÊàêÊïÖ‰∫ãÊëòË¶Å', 'info');
  } catch(e) {
    console.error('[AutoSummary] Ëá™ÂãïÊëòË¶ÅÂ§±Êïó:', e);
    // ÈùúÈªòÂ§±ÊïóÔºå‰∏çÂπ≤ÊìæÁî®Êà∂È´îÈ©ó
  }
}

// Âêà‰ΩµÂ§öÊ¢ùÊëòË¶Å
async function mergeSummaries(){
  if(!story){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'),'warning');return;}
  
  const summaries = story.summaries || [];
  if(summaries.length < 2){
    toast(T('Ëá≥Â∞ëÈúÄË¶Å 2 Ê¢ùÊëòË¶ÅÊâçËÉΩÂêà‰Ωµ'),'info');
    return;
  }
  
  showConfirm(`Á¢∫ÂÆöË¶ÅÂêà‰Ωµ ${summaries.length} Ê¢ùÊëòË¶ÅÂóéÔºü\n\nAI Â∞áÈáçÊñ∞Êï¥ÁêÜÊâÄÊúâÊëòË¶ÅÔºåÁîüÊàê‰∏Ä‰ªΩÊõ¥Á≤æÁ∞°ÁöÑÁµ±‰∏ÄÁâàÊú¨„ÄÇ`, async () => {
    showLoading('AI Ê≠£Âú®Âêà‰ΩµÊëòË¶Å...');
    try{
      const preset = await db.apiPresets.filter(p=>p.isActive).first();
      if(!preset || !preset.apiKey){
        throw new Error('Êú™ÈÖçÁΩÆ API');
      }
      
      const allContent = summaries.map((s, i) => `--- ÊëòË¶Å ${i+1} ---\n${s.content}`).join('\n\n');
      
      const prompt = `‰ª•‰∏ãÊòØÂ§ö‰ªΩ‰∫íÂãïÂ∞èË™™ÁöÑÂäáÊÉÖÊëòË¶ÅÔºåË´ãÂ∞áÂÆÉÂÄëÂêà‰ΩµÊï¥ÁêÜÊàê‰∏Ä‰ªΩÁµ±‰∏ÄÁöÑÊëòË¶Å„ÄÇ

${allContent.slice(0, 12000)}

„ÄêË¶ÅÊ±Ç„Äë
- ‰øùÁïôÊâÄÊúâÈáçË¶Å‰ø°ÊÅØÔºåÂéªÈô§ÈáçË§áÂÖßÂÆπ
- ÊåâÊôÇÈñìÈ†ÜÂ∫èÊï¥ÁêÜ
- Á∏ΩÈï∑Â∫¶ÊéßÂà∂Âú® 1000 Â≠ó‰ª•ÂÖß
- ‰ΩøÁî®‰ª•‰∏ãÊ†ºÂºèÔºö

## üìñ ÂÆåÊï¥ÂäáÊÉÖÂõûÈ°ß
ÔºàÊåâÊôÇÈñìÈ†ÜÂ∫èÊ¶ÇËø∞ÊâÄÊúâÈáçË¶Å‰∫ã‰ª∂Ôºâ

## üë• ËßíËâ≤ÁãÄÊÖã
ÔºàÁï∂ÂâçÂêÑËßíËâ≤ÁöÑÁãÄÊÖãÂíåÈóú‰øÇÔºâ

## üîë ÈóúÈçµË¶ÅÈªû
ÔºàÈúÄË¶ÅË®ò‰ΩèÁöÑÈáçË¶Å‰ø°ÊÅØÔºâ

Áõ¥Êé•Ëº∏Âá∫Âêà‰ΩµÂæåÁöÑÊëòË¶Å„ÄÇ`;

      let response;
      if(preset.type === 'anthropic'){
        response = await callAnthropicDirect(preset, prompt);
      } else if(preset.type === 'openai'){
        response = await callOpenAIDirect(preset, prompt);
      } else {
        response = await callCustomDirect(preset, prompt);
      }
      
      // Ë®àÁÆóÁ∏ΩÂ£ìÁ∏ÆÊï∏
      const totalCount = summaries.reduce((sum, s) => sum + (s.count || 0), 0);
      
      // Áî®Êñ∞ÊëòË¶ÅÊõøÊèõÊâÄÊúâËàäÊëòË¶Å
      const newSummaries = [{
        content: response.content,
        createdAt: Date.now(),
        count: totalCount,
        isAI: true,
        type: 'merged'
      }];
      
      await db.stories.update(story.id, { summaries: newSummaries });
      story.summaries = newSummaries;
      
      hideLoading();
      document.getElementById('memory-summary-count').textContent = '1';
      closeModal('memory-modal');
      toast(T('ÊëòË¶ÅÂ∑≤Âêà‰ΩµÁÇ∫‰∏Ä‰ªΩ'),'success');
    }catch(e){
      hideLoading();
      toast('Âêà‰ΩµÂ§±Êïó: '+e.message,'error');
    }
  });
}

// Êô∫ËÉΩÂàÜÊûêË®òÊÜ∂
async function analyzeMemory(){
  if(!story){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'),'warning');return;}
  if(msgs.length < 5){toast(T('Ê∂àÊÅØÂ§™Â∞ëÔºåÁÑ°ÈúÄÂàÜÊûê'),'info');return;}
  
  const resultEl = document.getElementById('memory-analysis-result');
  resultEl.style.display = '';
  resultEl.innerHTML = 'üîÑ AI Ê≠£Âú®ÂàÜÊûê...';
  
  try{
    const preset = await db.apiPresets.filter(p=>p.isActive).first();
    if(!preset || !preset.apiKey){
      throw new Error('Êú™ÈÖçÁΩÆ API');
    }
    
    // ÊßãÂª∫ÂàÜÊûêÂÖßÂÆπ
    const content = msgs.slice(0, 50).map((m, i) => {
      const role = m.role === 'user' ? '„ÄêÁé©ÂÆ∂„Äë' : '„ÄêAI„Äë';
      return `[${i+1}] ${role} ${m.content.slice(0, 300)}`;
    }).join('\n\n');
    
    const prompt = `Ë´ãÂàÜÊûê‰ª•‰∏ã‰∫íÂãïÂ∞èË™™Â∞çË©±ÔºåÂæûË®òÊÜ∂ÁÆ°ÁêÜËßíÂ∫¶Êèê‰æõÂª∫Ë≠∞„ÄÇ

„ÄêÂ∞çË©±ÂÖßÂÆπ„ÄëÔºàÂÖ± ${msgs.length} Ê¢ùÊ∂àÊÅØÔºâ
${content.slice(0, 10000)}

„ÄêÂàÜÊûêË¶ÅÊ±Ç„Äë
1. Ë≠òÂà•Âì™‰∫õÊ∂àÊÅØÂåÖÂê´ÈáçË¶Å‰ø°ÊÅØÔºàÈóúÈçµÂäáÊÉÖ„ÄÅËßíËâ≤Ë®≠ÂÆö„ÄÅ‰ºèÁ≠ÜÔºâ
2. Ë≠òÂà•Âì™‰∫õÊ∂àÊÅØÂèØ‰ª•ÂÆâÂÖ®Â£ìÁ∏ÆÔºàÊó•Â∏∏Â∞çË©±„ÄÅÈÅéÊ∏°ÊÄßÊèèÂØ´Ôºâ
3. Áµ¶Âá∫ÂÖ∑È´îÁöÑÂ£ìÁ∏ÆÂª∫Ë≠∞

Ë´ãÁî®‰ª•‰∏ãÊ†ºÂºèËº∏Âá∫Ôºö

üî¥ ÈáçË¶ÅÊ∂àÊÅØÔºàÂª∫Ë≠∞‰øùÁïôÔºâÔºö
- [Ê∂àÊÅØÁ∑®Ëôü] ÂéüÂõ†

üü¢ ÂèØÂ£ìÁ∏ÆÊ∂àÊÅØÔºö
- [Ê∂àÊÅØÁ∑®ËôüÁØÑÂúç] ÂéüÂõ†

üí° Âª∫Ë≠∞Ôºö
ÔºàÂÖ∑È´îÁöÑË®òÊÜ∂ÁÆ°ÁêÜÂª∫Ë≠∞Ôºâ`;

    let response;
    if(preset.type === 'anthropic'){
      response = await callAnthropicDirect(preset, prompt);
    } else if(preset.type === 'openai'){
      response = await callOpenAIDirect(preset, prompt);
    } else {
      response = await callCustomDirect(preset, prompt);
    }
    
    resultEl.innerHTML = `<div style="white-space:pre-wrap;line-height:1.6">${esc(response.content)}</div>`;
  }catch(e){
    resultEl.innerHTML = `<div style="color:var(--error)">ÂàÜÊûêÂ§±Êïó: ${esc(e.message)}</div>`;
  }
}

// ÊêúÁ¥¢ÊëòË¶Å
function searchSummaries(){
  if(!story){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'),'warning');return;}
  document.getElementById('summary-search-input').value = '';
  document.getElementById('summary-search-results').innerHTML = '<div class="empty"><div class="empty-icon">üîç</div><div class="empty-title">Ëº∏ÂÖ•ÈóúÈçµË©ûÊêúÁ¥¢</div></div>';
  closeModal('memory-modal');
  showModal('summary-search-modal');
}

function doSummarySearch(){
  const keyword = document.getElementById('summary-search-input').value.trim().toLowerCase();
  const resultsEl = document.getElementById('summary-search-results');
  
  if(!keyword){
    resultsEl.innerHTML = '<div class="empty"><div class="empty-icon">üîç</div><div class="empty-title">Ëº∏ÂÖ•ÈóúÈçµË©ûÊêúÁ¥¢</div></div>';
    return;
  }
  
  const summaries = story.summaries || [];
  const rollingSummaries = story.rollingSummaries || [];
  const allSummaries = [
    ...summaries.map((s, i) => ({...s, type: 'Â£ìÁ∏ÆÊëòË¶Å', idx: i})),
    ...rollingSummaries.map((s, i) => ({...s, type: 'ÊªæÂãïÊëòË¶Å', idx: i}))
  ];
  
  const results = allSummaries.filter(s => s.content.toLowerCase().includes(keyword));
  
  if(results.length === 0){
    resultsEl.innerHTML = '<div class="empty"><div class="empty-icon">üîç</div><div class="empty-title">Êú™ÊâæÂà∞ÂåπÈÖçÂÖßÂÆπ</div></div>';
    return;
  }
  
  resultsEl.innerHTML = results.map(s => {
    const content = s.content;
    const lowerContent = content.toLowerCase();
    const idx = lowerContent.indexOf(keyword);
    const start = Math.max(0, idx - 50);
    const end = Math.min(content.length, idx + keyword.length + 50);
    let preview = content.slice(start, end);
    if(start > 0) preview = '...' + preview;
    if(end < content.length) preview = preview + '...';
    
    // È´ò‰∫ÆÈóúÈçµË©û
    const regex = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    preview = esc(preview).replace(regex, '<mark style="background:var(--warning);color:black;padding:0 2px">$1</mark>');
    
    return `
      <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;margin-bottom:8px">
        <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:4px">${s.type} #${s.idx + 1}</div>
        <div style="font-size:13px;line-height:1.5">${preview}</div>
      </div>
    `;
  }).join('');
}

// Ê™¢Êü•ÊòØÂê¶ÈúÄË¶ÅËá™ÂãïÁîüÊàêÊªæÂãïÊëòË¶Å
async function checkAutoRollingSummary(){
  // Êñ∞ÁâàËá™ÂãïÊëòË¶ÅÁ≥ªÁµ±ÔºöÂæåÂè∞ÈùúÈªòÈÅãË°åÔºå‰∏çÈòªÂ°ûÁî®Êà∂
  if(settings.autoSummary){
    // ‰∏çÈòªÂ°ûÔºåÂæåÂè∞Âü∑Ë°å
    autoGenerateRollingSummary().catch(e => {
      console.warn('[AutoSummary] ÂæåÂè∞ÊëòË¶ÅÁîüÊàêÂ§±Êïó:', e);
    });
  }
}

// AIËá™ÂãïÊèêÂèñLorebook
async function checkAutoLorebookExtract(){
  if(!settings.autoLorebook || !story || !msgs || msgs.length === 0) return;

  try {
    // Ë®àÁÆóË∑ùÈõ¢‰∏äÊ¨°ÊèêÂèñÂæåÁöÑÊ∂àÊÅØÊï∏
    const lastExtractMsg = settings.lastLorebookExtractMsg || 0;
    const currentMsgCount = msgs.length;
    const newMsgCount = currentMsgCount - lastExtractMsg;

    // Ê™¢Êü•ÊòØÂê¶ÈÅîÂà∞Ëá™ÂãïÊèêÂèñÈ†ªÁéá
    if(newMsgCount < settings.autoLorebookFrequency) return;

    console.log(`[AutoLorebook] Ê™¢Ê∏¨Âà∞ ${newMsgCount} Ê¢ùÊñ∞Ê∂àÊÅØÔºåËß∏ÁôºËá™ÂãïÊèêÂèñ...`);

    // Êõ¥Êñ∞ÊúÄÂæåÊèêÂèñÊ∂àÊÅØË®àÊï∏
    settings.lastLorebookExtractMsg = currentMsgCount;
    await saveSetting('lastLorebookExtractMsg', currentMsgCount);

    // Áï∞Ê≠•Âü∑Ë°åÊèêÂèñÔºå‰∏çÈòªÂ°ûÁî®Êà∂
    setTimeout(async () => {
      try {
        await autoExtractLorebook();
      } catch(e) {
        console.warn('[AutoLorebook] Ëá™ÂãïÊèêÂèñÂ§±Êïó:', e);
      }
    }, 1000); // Âª∂ÈÅ≤1ÁßíÂü∑Ë°åÔºåÈÅøÂÖçÂΩ±ÈüøÁî®Êà∂È´îÈ©ó

  } catch(e) {
    console.error('[AutoLorebook] Ê™¢Êü•Â§±Êïó:', e);
  }
}

// Ëá™ÂãïÊèêÂèñLorebookÔºàÂæåÂè∞ÈùúÈªòÂü∑Ë°åÔºâ
async function autoExtractLorebook(){
  if(!story || !msgs || msgs.length === 0) return;

  const rangeValue = settings.autoLorebookFrequency * 2; // ÂàÜÊûêÁØÑÂúçÁÇ∫È†ªÁéáÁöÑ2ÂÄç
  const recentMsgs = msgs.slice(-rangeValue);
  const dialogueContent = recentMsgs.map((m) => {
    const role = m.role === 'user' ? '„ÄêÁé©ÂÆ∂„Äë' : '„ÄêÂäáÊÉÖ„Äë';
    return `${role} ${m.content}`;
  }).join('\n\n');

  if(dialogueContent.length < 50) return;

  console.log(`[AutoLorebook] ÈñãÂßãÂàÜÊûêÊúÄËøë ${rangeValue} Ê¢ùÊ∂àÊÅØ...`);

  try {
    const response = await callAI(`‰Ω†ÊòØ‰∏ÄÂÄãÂ∞àÊ•≠ÁöÑ Lorebook ÊèêÂèñÂ∞àÂÆ∂„ÄÇË´ãÂæû‰ª•‰∏ãÂ∞çË©±ÂäáÊÉÖ‰∏≠ÊèêÂèñÈóúÈçµ‰ø°ÊÅØÔºåÁîüÊàêÁµêÊßãÂåñÁöÑ Lorebook Ê¢ùÁõÆ„ÄÇ

„ÄêÊúÄËøëÂ∞çË©±ÂÖßÂÆπ„Äë
${dialogueContent.slice(0, 10000)}

„ÄêÊèêÂèñË¶ÅÊ±Ç„Äë
1. **ÈóúÈçµË©ûË®≠Ë®à**ÔºöÁÇ∫ÊØèÂÄãÊ¢ùÁõÆË®≠ÂÆö 2-5 ÂÄãËß∏ÁôºÈóúÈçµË©ûÔºåÂåÖÊã¨Ôºö
   - ÂêçÁ®±Êú¨Ë∫´ÔºàËßíËâ≤Âêç„ÄÅÂú∞ÈªûÂêç„ÄÅÁâ©ÂìÅÂêçÁ≠âÔºâ
   - Áõ∏ÈóúÁöÑÂà•Á®±„ÄÅÁ®±Âëº
   - ÁâπÂæµË©ûÔºàÂ¶ÇÔºöÈäÄÈ´ÆÂ∞ëÂ•≥„ÄÅÁ•ûÁßòÁµÑÁπî„ÄÅÈ≠îÊ≥ïÂäçÁ≠âÔºâ

2. **ÊèêÂèñÈ°ûÂûã**Ôºö
   - ËßíËâ≤ÔºöÂßìÂêç„ÄÅË∫´‰ªΩ„ÄÅÊÄßÊ†ºÁâπÂæµ„ÄÅÂ§ñË≤åÁâπÂæµ„ÄÅËÉΩÂäõ
   - Âú∞ÈªûÔºöÂêçÁ®±„ÄÅ‰ΩçÁΩÆ„ÄÅÁâπÂæµ„ÄÅÈáçË¶ÅÊÄß
   - Áâ©ÂìÅÔºöÂêçÁ®±„ÄÅÈ°ûÂûã„ÄÅÁî®ÈÄî„ÄÅÁâπÊÆäÂ±¨ÊÄß
   - ‰∫ã‰ª∂ÔºöÈáçË¶ÅÁöÑÂäáÊÉÖËΩâÊäò„ÄÅË°ùÁ™Å„ÄÅÁßòÂØÜ
   - Ë®≠ÂÆöÔºö‰∏ñÁïåËßÄ„ÄÅË¶èÂâá„ÄÅÁµÑÁπî„ÄÅÁ≥ªÁµ±

3. **ÂÖßÂÆπË¶ÅÊ±Ç**Ôºö
   - ÊØèÂÄãÊ¢ùÁõÆÁ∞°ÊΩîÊòéÁ¢∫Ôºå50-200Â≠ó
   - ËÅöÁÑ¶Ê†∏ÂøÉ‰ø°ÊÅØÔºåÂéªÈô§Â§öÈ§òÊèèËø∞
   - Âè™ÊèêÂèñÂ∞çË©±‰∏≠ÊòéÁ¢∫ÊèêÂà∞ÁöÑ‰ø°ÊÅØÔºå‰∏çË¶ÅËÖ¶Ë£ú
   - Âè™ÊèêÂèñÊñ∞Âá∫ÁèæÊàñÊúâÈáçË¶ÅÊõ¥Êñ∞ÁöÑ‰ø°ÊÅØÔºåÈÅøÂÖçÈáçË§áÂ∑≤Áü•ÂÖßÂÆπ

4. ‰∏çÈúÄË¶ÅÁâπÂà•Ê®ôË®òËßíËâ≤
5. ‰∏çÈúÄË¶ÅÊèêÂèñÁé©ÂÆ∂Â±¨ÊÄß

Ë´ãÁî® JSON Ê†ºÂºèËøîÂõûÔºö
\`\`\`json
{
  "entries": [
    {
      "name": "Ê¢ùÁõÆÂêçÁ®±",
      "keywords": ["ÈóúÈçµË©û1", "ÈóúÈçµË©û2"],
      "content": "Ê¢ùÁõÆÂÖßÂÆπ...",
      "isCharacter": false
    }
  ]
}
\`\`\`

Â¶ÇÊûúÊ≤íÊúâÊñ∞ÁöÑÈáçË¶Å‰ø°ÊÅØÈúÄË¶ÅË®òÈåÑÔºåËøîÂõûÁ©∫Êï∏ÁµÑ„ÄÇÂè™ËøîÂõû JSONÔºå‰∏çË¶ÅÂÖ∂‰ªñÂÖßÂÆπ„ÄÇ`);

    const match = response.content.match(/```json\s*([\s\S]*?)\s*```/) || response.content.match(/\{[\s\S]*"entries"[\s\S]*\}/);
    if(!match) {
      console.log('[AutoLorebook] AIËøîÂõûÊ†ºÂºèÈåØË™§');
      return;
    }

    const result = JSON.parse(match[1] || match[0]);

    if(!result.entries || result.entries.length === 0) {
      console.log('[AutoLorebook] Ê≤íÊúâÊñ∞ÁöÑ‰ø°ÊÅØÈúÄË¶ÅÊèêÂèñ');
      return;
    }

    // Ê™¢Ê∏¨ÈáçË§á
    const existingLorebook = await db.lorebook.where('storyId').equals(story.id).toArray();
    const existingLorebookNames = new Set(existingLorebook.map(l => (l.name || '').trim().toLowerCase()));

    let addedCount = 0;
    for(const e of result.entries){
      const name = e.name || 'Êú™ÂëΩÂêç';

      // Ë∑≥ÈÅéÈáçË§áÈ†Ö
      if(existingLorebookNames.has(name.trim().toLowerCase())) continue;

      // Ê∑ªÂä†Êñ∞Ê¢ùÁõÆ
      await db.lorebook.put({
        id: crypto.randomUUID(),
        storyId: story.id,
        name,
        keywords: e.keywords || [name],
        content: e.content || '',
        depth: 2,
        priority: 100,
        cooldown: 0,
        maxTriggers: 0,
        oneTime: false,
        conditions: [],
        conditionLogic: 'AND',
        isEnabled: true,
        triggerCount: 0,
        lastTriggered: null,
        createdAt: Date.now(),
        updatedAt: Date.now()
      });

      addedCount++;
      existingLorebookNames.add(name.trim().toLowerCase());
    }

    if(addedCount > 0){
      console.log(`[AutoLorebook] Ëá™ÂãïÊèêÂèñÂÆåÊàêÔºöÊñ∞Â¢û ${addedCount} ÂÄãLorebookÊ¢ùÁõÆ`);
      // È°ØÁ§∫ÊèêÁ§∫toast
      toast(`ü§ñ AIËá™ÂãïÊèêÂèñ‰∫Ü ${addedCount} ÂÄãÊñ∞ÁöÑLorebookÊ¢ùÁõÆ`, 'success');
    }

  } catch(e) {
    console.error('[AutoLorebook] Ëá™ÂãïÊèêÂèñÂü∑Ë°åÂ§±Êïó:', e);
  }
}

// AIËá™Âãï‰∏ÄËá¥ÊÄßÊ™¢Êü•
async function checkAutoConsistencyCheck(){
  if(!settings.autoConsistencyCheck || !story || !msgs || msgs.length === 0) return;

  try {
    // Ë®àÁÆóË∑ùÈõ¢‰∏äÊ¨°Ê™¢Êü•ÂæåÁöÑÊ∂àÊÅØÊï∏
    const lastCheckMsg = settings.lastConsistencyCheckMsg || 0;
    const currentMsgCount = msgs.length;
    const newMsgCount = currentMsgCount - lastCheckMsg;

    // Ê™¢Êü•ÊòØÂê¶ÈÅîÂà∞Ëá™ÂãïÊ™¢Êü•È†ªÁéá
    if(newMsgCount < settings.consistencyCheckFrequency) return;

    console.log(`[AutoConsistency] Ê™¢Ê∏¨Âà∞ ${newMsgCount} Ê¢ùÊñ∞Ê∂àÊÅØÔºåËß∏ÁôºËá™ÂãïÊ™¢Êü•...`);

    // Êõ¥Êñ∞ÊúÄÂæåÊ™¢Êü•Ê∂àÊÅØË®àÊï∏
    settings.lastConsistencyCheckMsg = currentMsgCount;
    await saveSetting('lastConsistencyCheckMsg', currentMsgCount);

    // Áï∞Ê≠•Âü∑Ë°åÊ™¢Êü•Ôºå‰∏çÈòªÂ°ûÁî®Êà∂
    setTimeout(async () => {
      try {
        await autoConsistencyCheck();
      } catch(e) {
        console.warn('[AutoConsistency] Ëá™ÂãïÊ™¢Êü•Â§±Êïó:', e);
      }
    }, 2000); // Âª∂ÈÅ≤2ÁßíÂü∑Ë°å

  } catch(e) {
    console.error('[AutoConsistency] Ê™¢Êü•Â§±Êïó:', e);
  }
}

// Ëá™Âãï‰∏ÄËá¥ÊÄßÊ™¢Êü•ÔºàÂæåÂè∞ÈùúÈªòÂü∑Ë°åÔºâ
async function autoConsistencyCheck(){
  if(!story || !msgs || msgs.length < 10) return; // Ëá≥Â∞ëÈúÄË¶Å10Ê¢ùÊ∂àÊÅØ

  const checkRange = Math.min(30, msgs.length);
  const recentMsgs = msgs.slice(-checkRange);

  console.log(`[AutoConsistency] ÈñãÂßãÂàÜÊûêÊúÄËøë ${checkRange} Ê¢ùÊ∂àÊÅØ...`);

  try {
    const prompt = `‰Ω†ÊòØ‰∏ÄÂÄãÊïÖ‰∫ã‰∏ÄËá¥ÊÄßÊ™¢Êü•Âä©Êâã„ÄÇË´ãÂàÜÊûê‰ª•‰∏ãÊïÖ‰∫ãÂÖßÂÆπÔºåÊ™¢Êü•ÊòØÂê¶Â≠òÂú®Ôºö
1. Ë®≠ÂÆöÁüõÁõæÔºàËßíËâ≤ÊÄßÊ†º„ÄÅËÉΩÂäõ„ÄÅËÉåÊôØ‰∏ç‰∏ÄËá¥Ôºâ
2. ÊôÇÈñìÁ∑öÈåØË™§Ôºà‰∫ã‰ª∂È†ÜÂ∫è‰∏çÂêàÁêÜÔºâ
3. ËßíËâ≤Ë°åÁÇ∫‰∏ç‰∏ÄËá¥ÔºàËàá‰πãÂâçÂª∫Á´ãÁöÑÊÄßÊ†º‰∏çÁ¨¶Ôºâ
4. ÈÇèËºØÊºèÊ¥ûÔºàÊÉÖÁØÄ‰∏çÂêàÁêÜÔºâ

Ë´ãÂàóÂá∫ÁôºÁèæÁöÑÂïèÈ°å„ÄÇÂ¶ÇÊûúÊ≤íÊúâÊòéÈ°ØÂïèÈ°åÔºåË´ãÁ∞°ÂñÆÂõûË¶Ü„ÄåÊú™ÁôºÁèæÊòéÈ°ØÂïèÈ°å„Äç„ÄÇ

ÊïÖ‰∫ãÂÖßÂÆπÔºö
${recentMsgs.map(m=>(m.role==='user'?'„ÄêÁé©ÂÆ∂„Äë':'„ÄêAI„Äë')+m.content).join('\n\n')}`;

    const resp = await callApi(prompt);
    const result = resp.content;

    // Â¶ÇÊûúÁôºÁèæÂïèÈ°åÔºåÈ°ØÁ§∫ÈÄöÁü•
    if(!result.includes('Êú™ÁôºÁèæ') && !result.includes('Ê≤íÊúâÁôºÁèæ') && !result.includes('Ê≤íÊúâÊòéÈ°Ø') && !result.includes('‰∏ÄËá¥ÊÄßËâØÂ•Ω')){
      console.log(`[AutoConsistency] ÁôºÁèæÂïèÈ°åÔºö`, result.slice(0, 200));

      // È°ØÁ§∫ÈÄöÁü•toast
      toast('üîç AIÊ™¢Ê∏¨Âà∞‰∏ÄËá¥ÊÄßÂïèÈ°åÔºåÈªûÊìäÊü•ÁúãË©≥ÊÉÖ', 'warning');

      // Ëá™Âãï‰øùÂ≠òÂà∞Ë≥áÊñôÂ∫´
      const note={
        id:crypto.randomUUID(),
        storyId:story.id,
        category:'setting',
        name:'Ëá™Âãï‰∏ÄËá¥ÊÄßÊ™¢Êü• - '+new Date().toLocaleDateString(),
        description:'AI Ëá™ÂãïÊ™¢Ê∏¨Âà∞ÁöÑÂïèÈ°å',
        content:result,
        isSelected:false,
        createdAt:Date.now()
      };
      await db.loreEntries.add(note);

      console.log(`[AutoConsistency] Â∑≤‰øùÂ≠òÂà∞Ë≥áÊñôÂ∫´`);
    } else {
      console.log(`[AutoConsistency] Êú™ÁôºÁèæÊòéÈ°ØÂïèÈ°å`);
    }

  } catch(e) {
    console.error('[AutoConsistency] Ëá™ÂãïÊ™¢Êü•Âü∑Ë°åÂ§±Êïó:', e);
  }
}

// Êü•ÊâæÊõøÊèõ
function showFindReplace(){
  closeAll();
  if(!story){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'),'warning');return;}
  document.getElementById('find-text').value='';
  document.getElementById('replace-text').value='';
  document.getElementById('find-result').textContent='';
  showModal('find-replace-modal');
}
function findNext(){
  const find=document.getElementById('find-text').value;
  if(!find){toast(T('Ë´ãËº∏ÂÖ•Êü•ÊâæÂÖßÂÆπ'),'warning');return;}
  const caseSensitive=document.getElementById('find-case-sensitive').checked;
  let count=0;
  msgs.forEach(m=>{
    const content=caseSensitive?m.content:m.content.toLowerCase();
    const search=caseSensitive?find:find.toLowerCase();
    const matches=(content.match(new RegExp(search.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'g'))||[]).length;
    count+=matches;
  });
  document.getElementById('find-result').textContent=`ÊâæÂà∞ ${count} ËôïÂåπÈÖç`;
}
async function replaceAll(){
  const find=document.getElementById('find-text').value;
  const replace=document.getElementById('replace-text').value;
  if(!find){toast(T('Ë´ãËº∏ÂÖ•Êü•ÊâæÂÖßÂÆπ'),'warning');return;}
  
  const caseSensitive=document.getElementById('find-case-sensitive').checked;
  const regex=new RegExp(find.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),caseSensitive?'g':'gi');
  let count=0;
  
  for(const m of msgs){
    const newContent=m.content.replace(regex,(match)=>{count++;return replace;});
    if(newContent!==m.content){
      m.content=newContent;
      await db.messages.update(m.id,{content:newContent});
    }
  }
  
  if(count>0){
    renderMsgs();
    document.getElementById('find-result').textContent=`Â∑≤ÊõøÊèõ ${count} Ëôï`;
    toast(`Â∑≤ÊõøÊèõ ${count} Ëôï`,'success');
  }else{
    document.getElementById('find-result').textContent='Êú™ÊâæÂà∞ÂåπÈÖçÂÖßÂÆπ';
  }
}

// Áµ±Ë®àÈù¢Êùø
function showStats(){
  closeAll();
  if(!story){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'),'warning');return;}
  
  let totalChars=0,userChars=0,aiChars=0,totalTokens=0;
  msgs.forEach(m=>{
    totalChars+=m.content.length;
    if(m.role==='user')userChars+=m.content.length;
    else aiChars+=m.content.length;
    totalTokens+=(m.tokens||0);
  });
  
  document.getElementById('stats-chars').textContent=fmtNum(totalChars);
  document.getElementById('stats-msgs').textContent=msgs.length;
  document.getElementById('stats-tokens').textContent=fmtNum(totalTokens);
  document.getElementById('stats-time').textContent=Math.round((story.statistics?.playTimeMinutes||0)/60)+'h';
  document.getElementById('stats-user-chars').textContent=fmtNum(userChars);
  document.getElementById('stats-ai-chars').textContent=fmtNum(aiChars);
  
  showModal('stats-modal');
}

// Â∞éÂá∫ÊïÖ‰∫ã
function exportStory(){
  closeAll();
  if(!story){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'),'warning');return;}
  
  let content='# '+story.title+'\n\n';
  if(story.description)content+='> '+story.description+'\n\n';
  content+='---\n\n';
  
  msgs.forEach(m=>{
    if(m.role==='user')content+='**„ÄêÁé©ÂÆ∂„Äë** '+m.content+'\n\n';
    else content+=m.content+'\n\n---\n\n';
  });
  
  const blob=new Blob([content],{type:'text/markdown'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=story.title+'.md';
  a.click();
  URL.revokeObjectURL(url);
  toast(T('ÊïÖ‰∫ãÂ∑≤Â∞éÂá∫'),'success');
}

// Â∞éÂá∫ÂñÆÂÄãÊïÖ‰∫ãÁöÑÂÆåÊï¥ JSON Êï∏ÊìöÂåÖ
async function exportStoryJSON(){
  closeAll();
  if(!story){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'),'warning');return;}

  showLoading('Ê≠£Âú®ÊâìÂåÖÊïÖ‰∫ãÊï∏Êìö...');
  try {
    const storyId = story.id;

    // Êî∂ÈõÜÊâÄÊúâÁõ∏ÈóúÊï∏Êìö
    const data = {
      version: '6.1',
      exportType: 'single-story',
      exportedAt: Date.now(),

      // Ê†∏ÂøÉÊïÖ‰∫ãÊï∏Êìö
      story: story,
      messages: await db.messages.where('storyId').equals(storyId).toArray(),
      branches: await db.branches.where('storyId').equals(storyId).toArray(),

      // Êåá‰ª§Á≥ªÁµ±
      storyInstructions: await db.storyInstructions.where('storyId').equals(storyId).toArray(),
      instructions: await (async () => {
        const bindings = await db.storyInstructions.where('storyId').equals(storyId).toArray();
        const instIds = bindings.map(b => b.instructionId);
        return instIds.length > 0 ? await db.instructions.where('id').anyOf(instIds).toArray() : [];
      })(),

      // ËßíËâ≤Á≥ªÁµ±
      characters: await db.characters.where('storyId').equals(storyId).toArray(),
      characterSnapshots: await db.characterSnapshots.where('storyId').equals(storyId).toArray(),
      characterHistory: await db.characterHistory.where('storyId').equals(storyId).toArray(),
      characterStates: await db.characterStates.where('storyId').equals(storyId).toArray(),

      // Lorebook Á≥ªÁµ±
      lorebook: await db.lorebook.where('storyId').equals(storyId).toArray(),
      lorebookTriggerLog: await db.lorebookTriggerLog.where('storyId').equals(storyId).toArray(),

      // ËàäÁâàË≥áÊñôÂ∫´ÔºàÂêëÂæåÂÖºÂÆπÔºâ
      loreEntries: await db.loreEntries.where('storyId').equals(storyId).toArray(),

      // ÂäáÊÉÖÁÆ°ÁêÜ
      foreshadowing: await db.foreshadowing.where('storyId').equals(storyId).toArray(),
      events: await db.events.where('storyId').equals(storyId).toArray(),
      timeline: await db.timeline.where('storyId').equals(storyId).toArray(),
      chapters: await db.chapters.where('storyId').equals(storyId).toArray(),
      bookmarks: await db.bookmarks.where('storyId').equals(storyId).toArray(),
      plotTags: await db.plotTags.where('storyId').equals(storyId).toArray(),

      // Â†¥ÊôØÂíåÈù¢Êùø
      scenes: await db.scenes.where('storyId').equals(storyId).toArray(),
      playerPanels: await db.playerPanels.where('storyId').equals(storyId).toArray(),

      // Â≠òÊ™î
      saves: await db.saves.where('storyId').equals(storyId).toArray()
    };

    // Áµ±Ë®à‰ø°ÊÅØ
    const stats = {
      messages: data.messages.length,
      characters: data.characters.length,
      lorebook: data.lorebook.length,
      chapters: data.chapters.length,
      bookmarks: data.bookmarks.length
    };

    data.stats = stats;

    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${story.title}_ÂÆåÊï¥Êï∏ÊìöÂåÖ_${new Date().toISOString().slice(0, 10)}.json`;
    a.click();
    URL.revokeObjectURL(url);

    hideLoading();
    toast(`‚úÖ ÊïÖ‰∫ãÂ∑≤Â∞éÂá∫ÔºÅÂåÖÂê´ ${stats.messages} Ê¢ùÊ∂àÊÅØ„ÄÅ${stats.characters} ÂÄãËßíËâ≤`, 'success');
  } catch(e) {
    hideLoading();
    toast('Â∞éÂá∫Â§±Êïó: ' + e.message, 'error');
    console.error('[ExportStory] ÈåØË™§:', e);
  }
}

// Â∞éÂÖ•ÂñÆÂÄãÊïÖ‰∫ã JSON Êï∏ÊìöÂåÖ
async function importStoryJSON(){
  closeAll();

  const input = document.getElementById('import-story-input');
  if(!input) {
    // ÂâµÂª∫Èö±ËóèÁöÑÊñá‰ª∂Ëº∏ÂÖ•ÂÖÉÁ¥†
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.id = 'import-story-input';
    fileInput.accept = '.json';
    fileInput.style.display = 'none';
    document.body.appendChild(fileInput);
  }

  const fileInput = document.getElementById('import-story-input');
  fileInput.onchange = async (e) => {
    const file = e.target.files[0];
    if(!file) return;

    showLoading('Ê≠£Âú®Â∞éÂÖ•ÊïÖ‰∫ã...');
    try {
      const text = await file.text();
      const data = safeJSONParse(text);

      if(!data || !data.version || !data.story) {
        throw new Error('ÁÑ°ÊïàÁöÑÊïÖ‰∫ãÊï∏ÊìöÂåÖ');
      }

      if(data.exportType !== 'single-story') {
        throw new Error('ÈÄô‰∏çÊòØÂñÆÂÄãÊïÖ‰∫ãÊï∏ÊìöÂåÖ„ÄÇË´ã‰ΩøÁî®„ÄåÂ∞éÂÖ•Êï∏Êìö„ÄçÂäüËÉΩÂ∞éÂÖ•ÂÆåÊï¥ÂÇô‰ªΩ„ÄÇ');
      }

      // ÁîüÊàêÊñ∞ÁöÑ ID ‰ª•ÈÅøÂÖçË°ùÁ™Å
      const oldStoryId = data.story.id;
      const newStoryId = crypto.randomUUID();
      const idMap = new Map(); // Áî®ÊñºÊò†Â∞ÑËàä ID Âà∞Êñ∞ ID

      console.log('[ImportStory] ÈñãÂßãÂ∞éÂÖ•ÊïÖ‰∫ã');
      console.log('[ImportStory] ÂéüÂßãÊïÖ‰∫ã ID:', oldStoryId);
      console.log('[ImportStory] Êñ∞ÊïÖ‰∫ã ID:', newStoryId);
      console.log('[ImportStory] ÂéüÂßãÊ®ôÈ°å:', data.story.title);

      // Êõ¥Êñ∞ÊïÖ‰∫ã ID ÂíåÊ†áÈ¢òÔºàÊ∑ªÂä†Êó∂Èó¥Êà≥Á°Æ‰øùÂîØ‰∏ÄÔºâ
      data.story.id = newStoryId;
      const timestamp = new Date().toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }).replace(/\//g, '-');
      data.story.title = data.story.title.replace(/ \(Â∞éÂÖ•.*?\)$/, '') + ` (Â∞éÂÖ• ${timestamp})`;
      data.story.createdAt = Date.now();
      data.story.updatedAt = Date.now();

      console.log('[ImportStory] Êñ∞Ê®ôÈ°å:', data.story.title);

      // Â∞éÂÖ•ÊïÖ‰∫ã
      await db.stories.add(data.story);
      console.log('[ImportStory] ÊïÖ‰∫ãÂ∑≤Ê∑ªÂä†Âà∞Êï∏ÊìöÂ∫´');

      // Â∞éÂÖ•Ê∂àÊÅØÔºàÊõ¥Êñ∞ storyId Âíå IDÔºâ
      if(data.messages && data.messages.length > 0) {
        console.log('[ImportStory] Â∞éÂÖ•Ê∂àÊÅØÊï∏Èáè:', data.messages.length);
        const messages = data.messages.map(m => {
          const oldId = m.id;
          const newId = crypto.randomUUID();
          idMap.set(oldId, newId);
          return {...m, id: newId, storyId: newStoryId};
        });
        await db.messages.bulkAdd(messages);
        console.log('[ImportStory] Ê∂àÊÅØÂ∑≤Â∞éÂÖ•');
      }

      // Â∞éÂÖ•ÂàÜÊîØ
      if(data.branches && data.branches.length > 0) {
        console.log('[ImportStory] Â∞éÂÖ•ÂàÜÊîØÊï∏Èáè:', data.branches.length);
        const branches = data.branches.map(b => ({...b, id: crypto.randomUUID(), storyId: newStoryId}));
        await db.branches.bulkAdd(branches);
      }

      // Â∞éÂÖ•Êåá‰ª§‰∏¶Âª∫Á´ã ID Êò†Â∞Ñ
      const instructionIdMap = new Map(); // Áî®ÊñºÊò†Â∞ÑËàäÊåá‰ª§ ID Âà∞Êñ∞Êåá‰ª§ ID
      if(data.instructions && data.instructions.length > 0) {
        console.log('[ImportStory] Â∞éÂÖ•Êåá‰ª§Êï∏Èáè:', data.instructions.length);
        const instructions = data.instructions.map(inst => {
          const oldId = inst.id;
          const newId = crypto.randomUUID();
          instructionIdMap.set(oldId, newId);
          return {...inst, id: newId};
        });
        await db.instructions.bulkAdd(instructions);
      }

      // Â∞éÂÖ•ÊïÖ‰∫ãÊåá‰ª§Á∂ÅÂÆöÔºà‰ΩøÁî®Êñ∞ÁöÑÊåá‰ª§ IDÔºâ
      if(data.storyInstructions && data.storyInstructions.length > 0) {
        console.log('[ImportStory] Â∞éÂÖ•ÊïÖ‰∫ãÊåá‰ª§Á∂ÅÂÆöÊï∏Èáè:', data.storyInstructions.length);
        const storyInsts = data.storyInstructions.map(si => ({
          ...si,
          storyId: newStoryId,
          instructionId: instructionIdMap.get(si.instructionId) || si.instructionId
        }));
        await db.storyInstructions.bulkAdd(storyInsts);
      }

      // Â∞éÂÖ•ËßíËâ≤ÔºàÂÖºÂÆπËàäÊï∏ÊìöÔºöÂ¶ÇÊûúÊ≤íÊúâinitialStatsÔºåËá™ÂãïË®≠ÁΩÆÔºâ
      if(data.characters && data.characters.length > 0) {
        console.log('[ImportStory] Â∞éÂÖ•ËßíËâ≤Êï∏Èáè:', data.characters.length);
        const characters = data.characters.map(c => {
          const newChar = {...c, id: crypto.randomUUID(), storyId: newStoryId};
          // Â¶ÇÊûúÊ≤íÊúâ initialStats ‰ΩÜÊúâ statsÔºåËá™ÂãïË®≠ÁΩÆ initialStats
          if(!newChar.initialStats && newChar.stats && Object.keys(newChar.stats).length > 0) {
            newChar.initialStats = { ...newChar.stats };
          }
          return newChar;
        });
        await db.characters.bulkAdd(characters);
        console.log('[ImportStory] ËßíËâ≤Â∑≤Â∞éÂÖ•');
      }

      // Â∞éÂÖ•ËßíËâ≤Âø´ÁÖß
      if(data.characterSnapshots && data.characterSnapshots.length > 0) {
        const snapshots = data.characterSnapshots.map(s => ({...s, id: crypto.randomUUID(), storyId: newStoryId}));
        await db.characterSnapshots.bulkAdd(snapshots);
      }

      // Â∞éÂÖ•ËßíËâ≤Ê≠∑Âè≤
      if(data.characterHistory && data.characterHistory.length > 0) {
        const history = data.characterHistory.map(h => ({...h, id: crypto.randomUUID(), storyId: newStoryId}));
        await db.characterHistory.bulkAdd(history);
      }

      // Â∞éÂÖ•ËßíËâ≤ÁãÄÊÖã
      if(data.characterStates && data.characterStates.length > 0) {
        const states = data.characterStates.map(s => ({...s, id: crypto.randomUUID(), storyId: newStoryId}));
        await db.characterStates.bulkAdd(states);
      }

      // Â∞éÂÖ• Lorebook
      if(data.lorebook && data.lorebook.length > 0) {
        console.log('[ImportStory] Â∞éÂÖ• Lorebook Êï∏Èáè:', data.lorebook.length);
        const lorebook = data.lorebook.map(l => ({...l, id: crypto.randomUUID(), storyId: newStoryId}));
        await db.lorebook.bulkAdd(lorebook);
        console.log('[ImportStory] Lorebook Â∑≤Â∞éÂÖ•');
      }

      // Â∞éÂÖ• Lorebook Ëß∏ÁôºÊó•Ë™å
      if(data.lorebookTriggerLog && data.lorebookTriggerLog.length > 0) {
        const logs = data.lorebookTriggerLog.map(l => ({...l, id: crypto.randomUUID(), storyId: newStoryId}));
        await db.lorebookTriggerLog.bulkAdd(logs);
      }

      // Â∞éÂÖ•ËàäÁâàË≥áÊñôÂ∫´
      if(data.loreEntries && data.loreEntries.length > 0) {
        console.log('[ImportStory] Â∞éÂÖ•‰∏ñÁïåËßÄË®≠ÂÆöÊï∏Èáè:', data.loreEntries.length);
        const entries = data.loreEntries.map(e => ({...e, id: crypto.randomUUID(), storyId: newStoryId}));
        await db.loreEntries.bulkAdd(entries);
        console.log('[ImportStory] ‰∏ñÁïåËßÄË®≠ÂÆöÂ∑≤Â∞éÂÖ•');
      }

      // Â∞éÂÖ•‰ºèÁ≠Ü
      if(data.foreshadowing && data.foreshadowing.length > 0) {
        console.log('[ImportStory] Â∞éÂÖ•‰ºèÁ≠ÜÊï∏Èáè:', data.foreshadowing.length);
        const foreshadowing = data.foreshadowing.map(f => {
          const newMsgId = idMap.get(f.messageId) || f.messageId;
          return {...f, id: crypto.randomUUID(), storyId: newStoryId, messageId: newMsgId};
        });
        await db.foreshadowing.bulkAdd(foreshadowing);
        console.log('[ImportStory] ‰ºèÁ≠ÜÂ∑≤Â∞éÂÖ•');
      }

      // Â∞éÂÖ•‰∫ã‰ª∂
      if(data.events && data.events.length > 0) {
        const events = data.events.map(e => {
          const newMsgId = idMap.get(e.messageId) || e.messageId;
          return {...e, id: crypto.randomUUID(), storyId: newStoryId, messageId: newMsgId};
        });
        await db.events.bulkAdd(events);
      }

      // Â∞éÂÖ•ÊôÇÈñìËª∏
      if(data.timeline && data.timeline.length > 0) {
        const timeline = data.timeline.map(t => {
          const newMsgId = idMap.get(t.messageId) || t.messageId;
          return {...t, id: crypto.randomUUID(), storyId: newStoryId, messageId: newMsgId};
        });
        await db.timeline.bulkAdd(timeline);
      }

      // Â∞éÂÖ•Á´†ÁØÄ
      if(data.chapters && data.chapters.length > 0) {
        const chapters = data.chapters.map(c => {
          const newMsgId = idMap.get(c.messageId) || c.messageId;
          return {...c, id: crypto.randomUUID(), storyId: newStoryId, messageId: newMsgId};
        });
        await db.chapters.bulkAdd(chapters);
      }

      // Â∞éÂÖ•Êõ∏Á±§
      if(data.bookmarks && data.bookmarks.length > 0) {
        const bookmarks = data.bookmarks.map(b => {
          const newMsgId = idMap.get(b.messageId) || b.messageId;
          return {...b, id: crypto.randomUUID(), storyId: newStoryId, messageId: newMsgId};
        });
        await db.bookmarks.bulkAdd(bookmarks);
      }

      // Â∞éÂÖ•ÂäáÊÉÖÊ®ôÁ±§
      if(data.plotTags && data.plotTags.length > 0) {
        const tags = data.plotTags.map(t => {
          const newMsgId = idMap.get(t.messageId) || t.messageId;
          return {...t, id: crypto.randomUUID(), storyId: newStoryId, messageId: newMsgId};
        });
        await db.plotTags.bulkAdd(tags);
      }

      // Â∞éÂÖ•Â†¥ÊôØ
      if(data.scenes && data.scenes.length > 0) {
        const scenes = data.scenes.map(s => ({...s, id: crypto.randomUUID(), storyId: newStoryId}));
        await db.scenes.bulkAdd(scenes);
      }

      // Â∞éÂÖ•Áé©ÂÆ∂Èù¢Êùø
      if(data.playerPanels && data.playerPanels.length > 0) {
        const panels = data.playerPanels.map(p => ({...p, id: crypto.randomUUID(), storyId: newStoryId}));
        await db.playerPanels.bulkAdd(panels);
      }

      // Â∞éÂÖ•Â≠òÊ™î
      if(data.saves && data.saves.length > 0) {
        const saves = data.saves.map(s => ({...s, id: crypto.randomUUID(), storyId: newStoryId}));
        await db.saves.bulkAdd(saves);
      }

      // Âà∑Êñ∞ÊïÖ‰∫ãÂàóË°®ÂíåÊåá‰ª§ÂàóË°®
      await renderStories();
      await renderInst();

      hideLoading();
      toast(`‚úÖ ÊïÖ‰∫ã„Äå${data.story.title}„ÄçÂ∞éÂÖ•ÊàêÂäüÔºÅ`, 'success');

      // È°ØÁ§∫Áµ±Ë®à‰ø°ÊÅØ
      if(data.stats) {
        setTimeout(() => {
          toast(`ÂåÖÂê´ ${data.stats.messages} Ê¢ùÊ∂àÊÅØ„ÄÅ${data.stats.characters} ÂÄãËßíËâ≤`, 'info');
        }, 1500);
      }

    } catch(e) {
      hideLoading();
      toast('Â∞éÂÖ•Â§±Êïó: ' + e.message, 'error');
      console.error('[ImportStory] ÈåØË™§:', e);
    }

    fileInput.value = ''; // Ê∏ÖÁ©∫‰ª•ÂÖÅË®±ÈáçË§áÂ∞éÂÖ•
  };

  fileInput.click();
}

// ============ Á´†ÁØÄÁÆ°ÁêÜ ============
async function renderChapters(){
  if(!story)return;
  const c=document.getElementById('chapter-list');
  const chapters=await db.chapters.where('storyId').equals(story.id).sortBy('order');
  if(!chapters.length){
    c.innerHTML='<div class="empty"><div class="empty-icon">üìë</div><div class="empty-title">Êö´ÁÑ°Á´†ÁØÄ</div><div class="empty-desc">ÈªûÊìäÂè≥‰∏äËßíÊ∑ªÂä†Á´†ÁØÄÊ®ôË®ò</div></div>';
    return;
  }
  c.innerHTML=chapters.map((ch,i)=>{
    const msg=msgs.find(m=>m.id===ch.messageId);
    const preview=msg?.content?.slice(0,50)||'';
    return `<div class="card" onclick="jumpToChapter('${ch.id}')">
      <div class="card-cover" style="background:linear-gradient(135deg,var(--primary),var(--info))">üìë</div>
      <div class="card-info">
        <div class="card-header"><div class="card-title">${esc(ch.title)}</div><div class="card-time">${fmtDate(ch.createdAt)}</div></div>
        <div class="card-preview">${esc(preview)}...</div>
        <div class="card-meta"><span class="card-stats">Á¨¨ ${i+1} Á´†</span></div>
      </div>
    </div>`;
  }).join('')+'<button class="action-btn secondary" style="width:100%;margin-top:12px" onclick="addChapter()">‚ûï Ê∑ªÂä†Á´†ÁØÄ</button>';
}
function addChapter(){
  if(!story){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'),'warning');return;}
  if(!selMsgId&&msgs.length>0)selMsgId=msgs[msgs.length-1].id;
  document.getElementById('chapter-title').value='';
  showModal('chapter-modal');
}
async function saveChapter(){
  const title=document.getElementById('chapter-title').value.trim();
  if(!title){toast(T('Ë´ãËº∏ÂÖ•Á´†ÁØÄÊ®ôÈ°å'),'warning');return;}
  const chapters=await db.chapters.where('storyId').equals(story.id).toArray();
  const ch={id:crypto.randomUUID(),storyId:story.id,messageId:selMsgId||msgs[msgs.length-1]?.id,title,order:chapters.length,createdAt:Date.now()};
  await db.chapters.add(ch);
  closeModal('chapter-modal');
  toast(T('Á´†ÁØÄÂ∑≤Ê∑ªÂä†'),'success');
  renderChapters();
}
async function jumpToChapter(chId){
  const ch=await db.chapters.get(chId);
  if(!ch)return;
  goBack();
  setTimeout(()=>{
    const el=document.querySelector(`.msg[data-id="${ch.messageId}"]`);
    if(el)el.scrollIntoView({behavior:'smooth',block:'center'});
  },300);
}

// ============ Êõ∏Á±§ÁÆ°ÁêÜ ============
async function renderBookmarks(){
  if(!story)return;
  const c=document.getElementById('bookmark-list');
  const bookmarks=await db.bookmarks.where('storyId').equals(story.id).reverse().sortBy('createdAt');
  if(!bookmarks.length){
    c.innerHTML='<div class="empty"><div class="empty-icon">üîñ</div><div class="empty-title">Êö´ÁÑ°Êõ∏Á±§</div><div class="empty-desc">Èï∑ÊåâÊ∂àÊÅØÂèØÊ∑ªÂä†Êõ∏Á±§</div></div>';
    return;
  }
  c.innerHTML=bookmarks.map(bm=>{
    const msg=msgs.find(m=>m.id===bm.messageId);
    const preview=msg?.content?.slice(0,80)||'';
    return `<div class="card" onclick="jumpToBookmark('${bm.id}')">
      <div class="card-cover" style="background:linear-gradient(135deg,var(--warning),var(--primary))">üîñ</div>
      <div class="card-info">
        <div class="card-header"><div class="card-title">${esc(bm.name)}</div><div class="card-time">${fmtDate(bm.createdAt)}</div></div>
        <div class="card-preview">${esc(preview)}...</div>
      </div>
      <div style="position:absolute;right:12px;top:50%;transform:translateY(-50%)" onclick="event.stopPropagation();deleteBookmark('${bm.id}')">üóëÔ∏è</div>
    </div>`;
  }).join('');
}
function addBookmark(){
  hideMenu();
  if(!selMsgId){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊ∂àÊÅØ'),'warning');return;}
  document.getElementById('bookmark-name').value='';
  showModal('bookmark-modal');
}
async function saveBookmark(){
  const name=document.getElementById('bookmark-name').value.trim()||'Êõ∏Á±§ '+(await db.bookmarks.where('storyId').equals(story.id).count()+1);
  const bm={id:crypto.randomUUID(),storyId:story.id,messageId:selMsgId,name,createdAt:Date.now()};
  await db.bookmarks.add(bm);
  closeModal('bookmark-modal');
  toast(T('Êõ∏Á±§Â∑≤Ê∑ªÂä†'),'success');
}
async function jumpToBookmark(bmId){
  const bm=await db.bookmarks.get(bmId);
  if(!bm)return;
  goBack();
  setTimeout(()=>{
    const el=document.querySelector(`.msg[data-id="${bm.messageId}"]`);
    if(el){el.scrollIntoView({behavior:'smooth',block:'center'});el.style.animation='highlight 1s';}
  },300);
}
async function deleteBookmark(id){await db.bookmarks.delete(id);toast(T('Êõ∏Á±§Â∑≤Âà™Èô§'),'success');renderBookmarks();}

// ============ ÂäáÊÉÖÊ®ôÁ±§ ============
function addPlotTag(){
  hideMenu();
  if(!selMsgId){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊ∂àÊÅØ'),'warning');return;}
  document.getElementById('tag-note').value='';
  showModal('tag-modal');
}
async function savePlotTag(){
  const type=document.getElementById('tag-type').value;
  const note=document.getElementById('tag-note').value.trim();
  const tag={id:crypto.randomUUID(),storyId:story.id,messageId:selMsgId,type,note,createdAt:Date.now()};
  await db.plotTags.add(tag);
  closeModal('tag-modal');
  toast(T('Ê®ôÁ±§Â∑≤Ê∑ªÂä†'),'success');
  // Âú®Ê∂àÊÅØ‰∏äÈ°ØÁ§∫Ê®ôÁ±§
  const el=document.querySelector(`.msg[data-id="${selMsgId}"]`);
  if(el){
    const labels={key:'üîëÈóúÈçµ',scene:'üé¨ÂêçÂ†¥Èù¢',clue:'üîçÁ∑öÁ¥¢',turning:'üîÑËΩâÊäò',emotion:'üíïÊÉÖÊÑü'};
    let tagEl=el.querySelector('.plot-tags');
    if(!tagEl){tagEl=document.createElement('div');tagEl.className='plot-tags';tagEl.style.cssText='margin-top:8px;display:flex;gap:4px;flex-wrap:wrap';el.appendChild(tagEl);}
    tagEl.innerHTML+=`<span style="font-size:10px;padding:2px 6px;background:var(--bg-tertiary);border-radius:4px;color:var(--primary)">${labels[type]||type}</span>`;
  }
}

// ============ ÂàÜÊîØÁÆ°ÁêÜ ============
async function renderBranches(){
  if(!story)return;
  const c=document.getElementById('branch-list');
  const branches=await db.branches.where('storyId').equals(story.id).toArray();
  if(!branches.length){
    // ÂâµÂª∫ÈªòË™ç‰∏ªÂàÜÊîØ
    const main={id:'branch_main',storyId:story.id,name:'‰∏ªÁ∑ö',description:'',parentBranchId:null,createdAt:Date.now()};
    await db.branches.add(main);
    branches.push(main);
  }
  c.innerHTML=branches.map(br=>{
    const isActive=br.id===story.currentBranchId;
    return `<div class="card ${isActive?'selected':''}" onclick="switchBranch('${br.id}')">
      <div class="card-cover" style="background:linear-gradient(135deg,${isActive?'var(--success)':'var(--bg-tertiary)'},var(--primary))">üîÄ</div>
      <div class="card-info">
        <div class="card-header"><div class="card-title">${esc(T(br.name))}</div>${isActive?`<span class="api-badge">${T('Áï∂Ââç')}</span>`:''}</div>
        <div class="card-preview">${esc(br.description||T('ÁÑ°ÊèèËø∞'))}</div>
        <div class="card-meta"><span class="card-stats">${fmtDate(br.createdAt)}</span></div>
      </div>
    </div>`;
  }).join('')+`<button class="action-btn primary" style="width:100%;margin-top:12px" onclick="createBranch()">‚ûï ${T('ÂâµÂª∫Êñ∞ÂàÜÊîØ')}</button>`;
}
function createBranch(){
  if(!story){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'),'warning');return;}
  document.getElementById('branch-name').value='';
  document.getElementById('branch-desc').value='';
  showModal('branch-modal');
}
async function saveBranch(){
  const name=document.getElementById('branch-name').value.trim();
  if(!name){toast(T('Ë´ãËº∏ÂÖ•ÂàÜÊîØÂêçÁ®±'),'warning');return;}
  const desc=document.getElementById('branch-desc').value.trim();
  const br={id:crypto.randomUUID(),storyId:story.id,name,description:desc,parentBranchId:story.currentBranchId,forkMessageId:msgs[msgs.length-1]?.id,createdAt:Date.now()};
  await db.branches.add(br);
  // Ë§áË£ΩÁï∂ÂâçÂàÜÊîØÁöÑÊ∂àÊÅØÂà∞Êñ∞ÂàÜÊîØ
  const currentMsgs=await db.messages.where('[storyId+branchId]').equals([story.id,story.currentBranchId]).toArray();
  const newMsgs=currentMsgs.map(m=>({...m,id:crypto.randomUUID(),branchId:br.id}));
  await db.messages.bulkAdd(newMsgs);
  closeModal('branch-modal');
  toast(T('ÂàÜÊîØÂ∑≤ÂâµÂª∫'),'success');
  renderBranches();
}
async function switchBranch(brId){
  if(brId===story.currentBranchId)return;
  story.currentBranchId=brId;
  await db.stories.update(story.id,{currentBranchId:brId});
  msgs=await db.messages.where('[storyId+branchId]').equals([story.id,brId]).sortBy('createdAt');
  renderMsgs();
  toast(T('Â∑≤ÂàáÊèõÂàÜÊîØ'),'success');
  renderBranches();
}

// ============ AI ÂäüËÉΩ ============
let lastAiCheckResult = null; // ‰øùÂ≠òÊúÄÂæå‰∏ÄÊ¨° AI Ê™¢Êü•ÁµêÊûú

function aiConsistencyCheck(){
  if(!story||!msgs.length){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊúâÂÖßÂÆπÁöÑÊïÖ‰∫ã'),'warning');return;}
  document.getElementById('ai-check-result').textContent='ÈªûÊìä„ÄåÈñãÂßãÊ™¢Êü•„ÄçÈÄ≤Ë°åÂàÜÊûê...';
  document.getElementById('ai-fix-btn').style.display='none';
  showModal('ai-check-modal');
}
async function doAiConsistencyCheck(){
  const resultEl=document.getElementById('ai-check-result');
  resultEl.textContent='ÂàÜÊûê‰∏≠ÔºåË´ãÁ®çÂÄô...';
  
  const prompt=`‰Ω†ÊòØ‰∏ÄÂÄãÊïÖ‰∫ã‰∏ÄËá¥ÊÄßÊ™¢Êü•Âä©Êâã„ÄÇË´ãÂàÜÊûê‰ª•‰∏ãÊïÖ‰∫ãÂÖßÂÆπÔºåÊ™¢Êü•ÊòØÂê¶Â≠òÂú®Ôºö
1. Ë®≠ÂÆöÁüõÁõæÔºàËßíËâ≤ÊÄßÊ†º„ÄÅËÉΩÂäõ„ÄÅËÉåÊôØ‰∏ç‰∏ÄËá¥Ôºâ
2. ÊôÇÈñìÁ∑öÈåØË™§Ôºà‰∫ã‰ª∂È†ÜÂ∫è‰∏çÂêàÁêÜÔºâ
3. ËßíËâ≤Ë°åÁÇ∫‰∏ç‰∏ÄËá¥ÔºàËàá‰πãÂâçÂª∫Á´ãÁöÑÊÄßÊ†º‰∏çÁ¨¶Ôºâ
4. ÈÇèËºØÊºèÊ¥ûÔºàÊÉÖÁØÄ‰∏çÂêàÁêÜÔºâ

Ë´ãÂàóÂá∫ÁôºÁèæÁöÑÂïèÈ°åÔºå‰∏¶Áµ¶Âá∫ÂÖ∑È´î‰ΩçÁΩÆÂíå‰øÆÊîπÂª∫Ë≠∞„ÄÇÂ¶ÇÊûúÊ≤íÊúâÂïèÈ°åÔºåË´ãË™™ÊòéÊïÖ‰∫ãÊï¥È´î‰∏ÄËá¥ÊÄßËâØÂ•Ω„ÄÇ

ÊïÖ‰∫ãÂÖßÂÆπÔºö
${msgs.slice(-30).map(m=>(m.role==='user'?'„ÄêÁé©ÂÆ∂„Äë':'„ÄêAI„Äë')+m.content).join('\n\n')}`;

  try{
    const resp=await callApi(prompt);
    resultEl.textContent=resp.content;
    lastAiCheckResult=resp.content;
    // Â¶ÇÊûúÁôºÁèæÂïèÈ°åÔºåÈ°ØÁ§∫‰øÆÂæ©ÊåâÈàï
    if(!resp.content.includes('‰∏ÄËá¥ÊÄßËâØÂ•Ω') && !resp.content.includes('Ê≤íÊúâÁôºÁèæÂïèÈ°å') && !resp.content.includes('Ê≤íÊúâÊòéÈ°Ø')){
      document.getElementById('ai-fix-btn').style.display='block';
    }
  }catch(e){
    resultEl.textContent='Ê™¢Êü•Â§±Êïó: '+e.message;
  }
}

function showAiFix(){
  closeModal('ai-check-modal');
  showModal('ai-fix-modal');
}

async function applyAiFix(method){
  closeModal('ai-fix-modal');

  if(method==='auto'){
    // Â∞á‰∏ÄËá¥ÊÄßÂïèÈ°åÊ∑ªÂä†Âà∞‰∏ãÊ¨° AI ÂõûË¶ÜÁöÑÊèêÁ§∫‰∏≠
    story.consistencyNote=`Ë´ãÊ≥®ÊÑè‰ª•‰∏ã‰∏ÄËá¥ÊÄßÂïèÈ°å‰∏¶Âú®ÂõûË¶Ü‰∏≠Ëá™ÁÑ∂Âú∞Á≥æÊ≠£Ôºö\n${lastAiCheckResult.slice(0,500)}`;
    story.consistencyFixCount = 0; // ÂàùÂßãÂåñ‰øÆÂæ©Ë®àÊï∏Âô®
    story.consistencyFixMax = 3; // ‰øùÊåÅ3Ê¨°Â∞çË©±
    await db.stories.update(story.id,{
      consistencyNote:story.consistencyNote,
      consistencyFixCount: 0,
      consistencyFixMax: 3
    });
    toast(T('Â∑≤Ë®≠ÁΩÆËá™Âãï‰øÆÂæ©ÔºåAI Â∞áÂú®Êé•‰∏ã‰æÜ3Ê¨°ÂõûË¶Ü‰∏≠ÊåÅÁ∫åÁ≥æÊ≠£'),'success');
    // È°ØÁ§∫ÊèêÁ§∫Ê¢ù
    updateConsistencyFixBanner();
  }else if(method==='note'){
    // Ê∑ªÂä†Âà∞‰∏ñÁïåËßÄË®≠ÂÆö
    const note={
      id:crypto.randomUUID(),
      storyId:story.id,
      category:'setting',
      name:'‰∏ÄËá¥ÊÄßÁ≠ÜË®ò - '+new Date().toLocaleDateString(),
      description:'AI Ê™¢Ê∏¨Âà∞ÁöÑÂïèÈ°å',
      content:lastAiCheckResult,
      isSelected:false,
      createdAt:Date.now()
    };
    await db.loreEntries.add(note);
    toast(T('Â∑≤Ê∑ªÂä†Âà∞‰∏ñÁïåËßÄË®≠ÂÆö'),'success');
  }else{
    toast(T('Â∑≤ÂøΩÁï•'),'info');
  }
}

// Êõ¥Êñ∞‰∏ÄËá¥ÊÄß‰øÆÂæ©ÊèêÁ§∫Ê¢ù
function updateConsistencyFixBanner(){
  if(!story) return;

  const banner = document.getElementById('consistency-fix-banner');
  const info = document.getElementById('consistency-fix-info');

  if(story.consistencyNote && story.consistencyFixMax){
    const remaining = story.consistencyFixMax - (story.consistencyFixCount || 0);
    if(remaining > 0){
      banner.style.display = 'flex';
      info.textContent = `Ââ©È§ò ${remaining} Ê¨°Â∞çË©±`;
    } else {
      banner.style.display = 'none';
    }
  } else {
    banner.style.display = 'none';
  }
}

// ÂèñÊ∂à‰∏ÄËá¥ÊÄß‰øÆÂæ©
async function cancelConsistencyFix(){
  if(!story) return;

  await db.stories.update(story.id,{
    consistencyNote:null,
    consistencyFixCount:0,
    consistencyFixMax:null
  });
  story.consistencyNote=null;
  story.consistencyFixCount=0;
  story.consistencyFixMax=null;

  updateConsistencyFixBanner();
  toast('Â∑≤ÂèñÊ∂à‰∏ÄËá¥ÊÄß‰øÆÂæ©','info');
}

function aiChapterSummary(){
  if(!story||!msgs.length){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊúâÂÖßÂÆπÁöÑÊïÖ‰∫ã'),'warning');return;}
  document.getElementById('ai-summary-result').textContent='ÈªûÊìä„ÄåÁîüÊàêÁ∏ΩÁµê„ÄçÈñãÂßã...';
  showModal('ai-summary-modal');
}
async function doAiChapterSummary(){
  const resultEl=document.getElementById('ai-summary-result');
  resultEl.textContent='ÁîüÊàê‰∏≠ÔºåË´ãÁ®çÂÄô...';
  
  const prompt=`Ë´ãÁÇ∫‰ª•‰∏ãÊïÖ‰∫ãÂÖßÂÆπÁîüÊàê‰∏ÄÂÄãÁ∞°ÊΩîÁöÑÁ´†ÁØÄÁ∏ΩÁµêÔºåÂåÖÊã¨Ôºö
1. ‰∏ªË¶Å‰∫ã‰ª∂Ê¶ÇËø∞Ôºà3-5Âè•Ë©±Ôºâ
2. ÈáçË¶ÅËßíËâ≤ÁãÄÊÖãËÆäÂåñ
3. ÈóúÈçµÊ±∫Á≠ñÈªû
4. Êú™Ëß£Ê±∫ÁöÑ‰ºèÁ≠Ü/Êá∏Âøµ

ÊïÖ‰∫ãÂÖßÂÆπÔºö
${msgs.slice(-50).map(m=>(m.role==='user'?'„ÄêÁé©ÂÆ∂„Äë':'„ÄêAI„Äë')+m.content).join('\n\n')}`;

  try{
    const resp=await callApi(prompt);
    resultEl.textContent=resp.content;
  }catch(e){
    resultEl.textContent='ÁîüÊàêÂ§±Êïó: '+e.message;
  }
}
function copySummary(){
  const text=document.getElementById('ai-summary-result').textContent;
  navigator.clipboard.writeText(text);
  toast(T('Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÊùø'),'success');
}

// ============ v7: ËßíËâ≤Âç°ÁâáÁ≥ªÁµ± ============
let currentCharacterId = null; // Áï∂ÂâçÈÅ∏‰∏≠ÁöÑËßíËâ≤ID
let charBatchMode = false; // ÊâπÈáèÊìç‰ΩúÊ®°Âºè
let selectedCharIds = new Set(); // Â∑≤ÈÅ∏‰∏≠ÁöÑËßíËâ≤ID

// v25: Ê∏≤ÊüìËßíËâ≤ÂàóË°®ÔºàÊîØÊåÅÂàÜÁµÑ„ÄÅÊêúÁ¥¢„ÄÅÁØ©ÈÅ∏Ôºâ
async function renderCharacters(){
  if(!story){
    document.getElementById('character-list').innerHTML='<div class="char-empty"><div class="char-empty-icon">üìö</div><div class="char-empty-text">Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã</div></div>';
    return;
  }
  
  let chars = await db.characters.where('storyId').equals(story.id).toArray();
  const c = document.getElementById('character-list');
  
  // ÊáâÁî®ÊêúÁ¥¢ÁØ©ÈÅ∏
  const searchText = document.getElementById('char-search-input')?.value?.toLowerCase() || '';
  const categoryFilter = document.getElementById('char-filter-category')?.value || 'all';
  
  if(searchText){
    chars = chars.filter(char => 
      char.name?.toLowerCase().includes(searchText) ||
      char.title?.toLowerCase().includes(searchText) ||
      char.description?.toLowerCase().includes(searchText) ||
      (char.tags || []).some(t => t.toLowerCase().includes(searchText))
    );
  }
  
  if(categoryFilter !== 'all'){
    chars = chars.filter(char => char.category === categoryFilter);
  }
  
  // Êõ¥Êñ∞Ë®àÊï∏
  const totalCount = await db.characters.where('storyId').equals(story.id).count();
  document.getElementById('char-count').textContent = chars.length === totalCount 
    ? `${totalCount} ‰ΩçËßíËâ≤` 
    : `${chars.length} / ${totalCount} ‰ΩçËßíËâ≤`;
  
  if(!chars.length){
    c.innerHTML = searchText || categoryFilter !== 'all'
      ? `<div class="char-empty"><div class="char-empty-icon">üîç</div><div class="char-empty-text">Ê≤íÊúâÊâæÂà∞ÂåπÈÖçÁöÑËßíËâ≤</div></div>`
      : `<div class="char-empty"><div class="char-empty-icon">üë•</div><div class="char-empty-text">Â∞öÊú™Ë≠òÂà•ËßíËâ≤</div><div style="font-size:12px;color:var(--text-tertiary);margin-top:8px">ÈªûÊìä„ÄåAI Êõ¥Êñ∞ÁãÄÊÖã„ÄçËá™ÂãïË≠òÂà•<br>ÊàñÊâãÂãïÊ∑ªÂä†ËßíËâ≤</div></div>`;
    return;
  }
  
  // ÊåâÂàÜÈ°ûÂàÜÁµÑ
  const groups = {
    protagonist: { label: '‚≠ê ‰∏ªËßí', chars: [] },
    supporting: { label: 'üë§ ÈÖçËßí', chars: [] },
    npc: { label: 'üë• NPC', chars: [] }
  };
  
  chars.forEach(char => {
    const cat = char.category || 'supporting';
    if(groups[cat]){
      groups[cat].chars.push(char);
    } else {
      groups.supporting.chars.push(char);
    }
  });
  
  // Ê∏≤ÊüìÂàÜÁµÑ
  let html = '';
  const batchClass = charBatchMode ? 'batch-mode' : '';
  
  for(const [catKey, group] of Object.entries(groups)){
    if(group.chars.length === 0) continue;
    
    html += `
      <div class="char-group" data-category="${catKey}">
        <div class="char-group-header" onclick="toggleCharGroup('${catKey}')">
          <span class="char-group-arrow">‚ñº</span>
          <span>${group.label}</span>
          <span class="char-group-count">(${group.chars.length})</span>
        </div>
        <div class="char-group-list ${batchClass}">
          ${group.chars.map(char => renderCharCardSimple(char)).join('')}
        </div>
      </div>
    `;
  }
  
  c.innerHTML = html;
  
  // Êõ¥Êñ∞ÊâπÈáèÈÅ∏ÊìáÁãÄÊÖã
  updateBatchCount();
}

// v25: Á∞°ÂåñÁöÑËßíËâ≤Âç°ÁâáÔºàÁî®ÊñºÂàóË°®Ôºâ
function renderCharCardSimple(char){
  const isSelected = selectedCharIds.has(char.id);
  const categoryLabels = {
    protagonist: { label: '‰∏ªËßí', cls: 'protagonist' },
    supporting: { label: 'ÈÖçËßí', cls: 'supporting' },
    npc: { label: 'NPC', cls: 'npc' }
  };
  const catInfo = categoryLabels[char.category] || categoryLabels.supporting;
  
  // ‰∏ªË¶ÅÂ±¨ÊÄßÊëòË¶Å
  const stats = char.stats || {};
  const statKeys = Object.keys(stats).slice(0, 2);
  const statHtml = statKeys.map(k => `<span>${k}: ${stats[k]}</span>`).join(' ¬∑ ');
  
  // V2ÁâπÊÄßÂæΩÁ´†
  const badges = [];
  if(char.first_mes) badges.push('üí¨');
  if(char.expressions?.length) badges.push('üé®');
  if(char.relationships?.length) badges.push('üë•');
  if(char.character_book?.entries?.length) badges.push('üìö');
  
  return `
    <div class="char-card ${isSelected ? 'selected' : ''}" 
         data-char-id="${char.id}"
         onclick="handleCharCardClick('${char.id}', event)">
      <div class="char-card-checkbox ${isSelected ? 'checked' : ''}" onclick="event.stopPropagation();toggleCharSelect('${char.id}')">
        ${isSelected ? '‚úì' : ''}
      </div>
      <div class="char-card-avatar">
        ${char.avatarImage ? `<img src="${char.avatarImage}" alt="">` : (char.avatar || 'üë§')}
      </div>
      <div class="char-card-info">
        <div class="char-card-name">
          ${esc(char.name)}
          ${badges.length ? `<span style="font-size:12px">${badges.join('')}</span>` : ''}
        </div>
        ${char.title ? `<div class="char-card-title">${esc(char.title)}</div>` : ''}
        ${char.tags?.length ? `<div class="char-card-tags">${char.tags.slice(0,3).map(t => `<span class="char-card-tag">${esc(t)}</span>`).join('')}</div>` : ''}
      </div>
      <div class="char-card-stats">
        <span class="char-card-category ${catInfo.cls}">${catInfo.label}</span>
        ${statHtml ? `<div class="char-card-stat">${statHtml}</div>` : ''}
      </div>
    </div>
  `;
}

// v25: ËôïÁêÜÂç°ÁâáÈªûÊìä
function handleCharCardClick(charId, event){
  if(charBatchMode){
    toggleCharSelect(charId);
  } else {
    showCharDetail(charId);
  }
}

// v25: ÂàáÊèõÂàÜÁµÑÂ±ïÈñã/Êî∂Ëµ∑
function toggleCharGroup(category){
  const group = document.querySelector(`.char-group[data-category="${category}"]`);
  if(group) group.classList.toggle('collapsed');
}

// v25: ÁØ©ÈÅ∏ËßíËâ≤
function filterCharacters(){
  renderCharacters();
}

// v25: ÊâπÈáèÊìç‰ΩúÊ®°Âºè
function toggleCharBatchMode(){
  charBatchMode = !charBatchMode;
  const btn = document.getElementById('char-batch-btn');
  const bar = document.getElementById('char-batch-bar');
  
  if(charBatchMode){
    btn.style.color = 'var(--primary)';
    bar.style.display = 'flex';
    document.querySelectorAll('.char-group-list').forEach(el => el.classList.add('batch-mode'));
  } else {
    btn.style.color = '';
    bar.style.display = 'none';
    selectedCharIds.clear();
    document.querySelectorAll('.char-group-list').forEach(el => el.classList.remove('batch-mode'));
    document.querySelectorAll('.char-card').forEach(el => el.classList.remove('selected'));
    document.querySelectorAll('.char-card-checkbox').forEach(el => {
      el.classList.remove('checked');
      el.textContent = '';
    });
  }
  
  updateBatchCount();
}

// v25: ÂàáÊèõËßíËâ≤ÈÅ∏Êìá
function toggleCharSelect(charId){
  if(selectedCharIds.has(charId)){
    selectedCharIds.delete(charId);
  } else {
    selectedCharIds.add(charId);
  }
  
  const card = document.querySelector(`.char-card[data-char-id="${charId}"]`);
  if(card){
    const isSelected = selectedCharIds.has(charId);
    card.classList.toggle('selected', isSelected);
    const checkbox = card.querySelector('.char-card-checkbox');
    if(checkbox){
      checkbox.classList.toggle('checked', isSelected);
      checkbox.textContent = isSelected ? '‚úì' : '';
    }
  }
  
  updateBatchCount();
}

// v25: ÂÖ®ÈÅ∏/ÂèñÊ∂àÂÖ®ÈÅ∏
async function toggleSelectAllChars(){
  const selectAll = document.getElementById('char-select-all');
  const chars = await db.characters.where('storyId').equals(story.id).toArray();
  
  if(selectAll.checked){
    chars.forEach(c => selectedCharIds.add(c.id));
  } else {
    selectedCharIds.clear();
  }
  
  document.querySelectorAll('.char-card').forEach(card => {
    const charId = card.dataset.charId;
    const isSelected = selectedCharIds.has(charId);
    card.classList.toggle('selected', isSelected);
    const checkbox = card.querySelector('.char-card-checkbox');
    if(checkbox){
      checkbox.classList.toggle('checked', isSelected);
      checkbox.textContent = isSelected ? '‚úì' : '';
    }
  });
  
  updateBatchCount();
}

// v25: Êõ¥Êñ∞ÈÅ∏‰∏≠Ë®àÊï∏
function updateBatchCount(){
  const countEl = document.getElementById('char-batch-count');
  if(countEl){
    countEl.textContent = `Â∑≤ÈÅ∏ ${selectedCharIds.size} ÂÄã`;
  }
  
  // Êõ¥Êñ∞ÂÖ®ÈÅ∏ÁãÄÊÖã
  const selectAll = document.getElementById('char-select-all');
  if(selectAll){
    db.characters.where('storyId').equals(story?.id || 0).count().then(total => {
      selectAll.checked = selectedCharIds.size === total && total > 0;
      selectAll.indeterminate = selectedCharIds.size > 0 && selectedCharIds.size < total;
    }).catch(err => {
      console.error('[Characters] Áç≤ÂèñËßíËâ≤Á∏ΩÊï∏Â§±Êïó:', err);
    });
  }
}

// v25: ÊâπÈáèÂà™Èô§
async function batchDeleteChars(){
  if(selectedCharIds.size === 0){
    toast(T('Ë´ãÂÖàÈÅ∏ÊìáËßíËâ≤'), 'warning');
    return;
  }
  
  if(!confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§ ${selectedCharIds.size} ÂÄãËßíËâ≤ÂóéÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§Èä∑„ÄÇ`)) return;
  
  showLoading(T('Ê≠£Âú®Âà™Èô§...'));
  
  try {
    for(const charId of selectedCharIds){
      await db.characters.delete(charId);
    }
    
    selectedCharIds.clear();
    updateBatchCount();
    renderCharacters();
    
    hideLoading();
    toast(T('ËßíËâ≤Â∑≤Âà™Èô§'), 'success');
  } catch(err){
    hideLoading();
    console.error('Batch delete error:', err);
    toast(T('Âà™Èô§Â§±Êïó: ') + err.message, 'error');
  }
}

// v25: ÊâπÈáèÂ∞éÂá∫
async function batchExportChars(){
  if(selectedCharIds.size === 0){
    toast(T('Ë´ãÂÖàÈÅ∏ÊìáËßíËâ≤'), 'warning');
    return;
  }
  
  showLoading(T('Ê≠£Âú®Â∞éÂá∫...'));
  
  try {
    const chars = [];
    for(const charId of selectedCharIds){
      const char = await db.characters.get(charId);
      if(char) chars.push(char);
    }
    
    const exportData = {
      format: 'zhimeng_characters_v2',
      exportedAt: new Date().toISOString(),
      storyTitle: story.title,
      characters: chars.map(c => ({
        // Âü∫Êú¨‰ø°ÊÅØ
        name: c.name,
        title: c.title || '',
        avatar: c.avatar || 'üë§',
        avatarImage: c.avatarImage || '',
        category: c.category || 'supporting',
        description: c.description || '',
        personality: c.personality || '',
        tags: c.tags || [],
        
        // Â∞çË©±Ë®≠ÁΩÆ
        first_mes: c.first_mes || '',
        alternate_greetings: c.alternate_greetings || [],
        scenario: c.scenario || '',
        mes_example: c.mes_example || '',
        
        // È´òÁ¥öË®≠ÁΩÆ
        system_prompt: c.system_prompt || '',
        post_history_instructions: c.post_history_instructions || '',
        creator_notes: c.creator_notes || '',
        creator: c.creator || '',
        character_version: c.character_version || '1.0',
        
        // ËßíËâ≤Â∞àÂ±¨ Lorebook
        character_book: c.character_book || null,
        
        // Â±¨ÊÄßÂíåÁãÄÊÖã
        stats: c.stats || {},
        initialStats: c.initialStats || null,
        initialState: c.initialState || null,
        
        // Èóú‰øÇÂíåË°®ÊÉÖ
        relationships: c.relationships || [],
        expressions: c.expressions || [],
        expressionMode: c.expressionMode || 'manual',
        
        // ÂÖ∂‰ªñ
        mood: c.mood || '',
        note: c.note || '',
        location: c.location || ''
      }))
    };
    
    const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ËßíËâ≤Â∞éÂá∫_${selectedCharIds.size}ÂÄã_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    hideLoading();
    toast(T(`Â∑≤Â∞éÂá∫ ${selectedCharIds.size} ÂÄãËßíËâ≤`), 'success');
  } catch(err){
    hideLoading();
    console.error('Batch export error:', err);
    toast(T('Â∞éÂá∫Â§±Êïó: ') + err.message, 'error');
  }
}

// ËàäÁâàÊ∏≤ÊüìÂáΩÊï∏Ôºà‰øùÁïôÂÖºÂÆπÔºâ
function renderCharacterCard(char){
  const stats = char.stats || {};
  const tags = char.tags || [];
  const relations = char.relations || [];
  
  // Áç≤ÂèñÂø´ÈÄüÈ†êË¶ΩÁöÑÈóúÈçµÊï∏ÂÄº
  const quickStats = [];
  if(stats['Â•ΩÊÑü'] !== undefined || stats['Ë°®Èù¢Â•ΩÊÑü'] !== undefined){
    const favor = stats['Ë°®Èù¢Â•ΩÊÑü'] || stats['Â•ΩÊÑü'] || 0;
    quickStats.push(`<div class="char-quick-item"><span>üíú</span><span class="char-quick-val">${favor}</span></div>`);
  }
  if(stats['ÁúüÂØ¶Â•ΩÊÑü'] !== undefined){
    const realFavor = stats['ÁúüÂØ¶Â•ΩÊÑü'];
    const color = realFavor > 50 ? 'var(--success)' : realFavor > 20 ? 'var(--warning)' : 'var(--error)';
    quickStats.push(`<div class="char-quick-item"><span>‚ù§Ô∏è</span><span class="char-quick-val" style="color:${color}">${realFavor}</span></div>`);
  }
  if(stats['Âø†Ë™†'] !== undefined){
    const loyalty = stats['Âø†Ë™†'];
    const color = loyalty > 50 ? 'var(--success)' : 'var(--error)';
    quickStats.push(`<div class="char-quick-item"><span>ü§ù</span><span class="char-quick-val" style="color:${color}">${loyalty}</span></div>`);
  }
  if(stats['ÈáéÂøÉ'] !== undefined){
    quickStats.push(`<div class="char-quick-item"><span>üî•</span><span class="char-quick-val" style="color:var(--warning)">${stats['ÈáéÂøÉ']}</span></div>`);
  }
  // ÂÖ∂‰ªñÂ∏∏Ë¶ãÂ±¨ÊÄß
  const otherKeys = Object.keys(stats).filter(k => !['Â•ΩÊÑü','Ë°®Èù¢Â•ΩÊÑü','ÁúüÂØ¶Â•ΩÊÑü','Âø†Ë™†','ÈáéÂøÉ'].includes(k));
  otherKeys.slice(0,2).forEach(k => {
    quickStats.push(`<div class="char-quick-item"><span>üìä</span><span class="char-quick-val">${stats[k]}</span></div>`);
  });
  
  // ÊßãÂª∫Â±¨ÊÄßÊ¢ù
  const statBars = Object.entries(stats).map(([key, val]) => {
    const numVal = parseInt(val) || 0;
    let colorClass = 'purple';
    if(['ÈáéÂøÉ','ÊïµÊÑè','Âç±Èö™'].some(k => key.includes(k))) colorClass = 'red';
    else if(['Âø†Ë™†','Â•ΩÊÑü','‰ø°‰ªª'].some(k => key.includes(k))) colorClass = numVal > 50 ? 'green' : 'red';
    else if(['Êô∫Ë¨Ä','Êô∫Âäõ','È≠ÖÂäõ'].some(k => key.includes(k))) colorClass = 'blue';
    else if(['ÂÆπË≤å','È≠ÖÂäõ'].some(k => key.includes(k))) colorClass = 'pink';
    else if(['ÂÆ∂‰∏ñ','Ë≤°ÂØå','Âú∞‰Ωç'].some(k => key.includes(k))) colorClass = 'gold';
    return `<div class="char-stat-bar">
      <div class="char-stat-header">
        <span class="char-stat-label">${key}</span>
        <span class="char-stat-value">${val}</span>
      </div>
      <div class="char-stat-track"><div class="char-stat-fill ${colorClass}" style="width:${Math.min(100,numVal)}%"></div></div>
    </div>`;
  }).join('');
  
  // Ê®ôÁ±§
  const tagHtml = tags.map(t => {
    let cls = '';
    if(['Âç±Èö™','ÈáéÂøÉ','ÊïµÂ∞ç','Èô∞Èö™'].some(k => t.includes(k))) cls = 'danger';
    else if(['Ë≠¶Âëä','Ê≥®ÊÑè','Â∞èÂøÉ'].some(k => t.includes(k))) cls = 'warning';
    else if(['ÂèãÂ•Ω','Âø†Ë™†','ÂèØ‰ø°'].some(k => t.includes(k))) cls = 'success';
    else cls = 'info';
    return `<span class="char-tag ${cls}">${esc(t)}</span>`;
  }).join('');
  
  // Èóú‰øÇ
  const relationHtml = relations.map(r => `
    <div class="char-relation">
      <div class="char-relation-avatar" style="background:linear-gradient(135deg,${r.type==='ÊïµÂ∞ç'?'#ef4444,#f87171':r.type==='ÂèãÂ•Ω'?'#22c55e,#4ade80':'#3b82f6,#60a5fa'})">
        ${r.avatar || 'üë§'}
      </div>
      <div class="char-relation-info">
        <div class="char-relation-name">${esc(r.name)}</div>
        <div class="char-relation-type">${esc(r.description || r.type || '')}</div>
      </div>
      <span class="char-relation-status ${r.type==='ÊïµÂ∞ç'?'enemy':r.type==='ÂèãÂ•Ω'?'ally':'neutral'}">${esc(r.type || '‰∏≠Á´ã')}</span>
    </div>
  `).join('');
  
  return `<div class="char-card" id="char-${char.id}" onclick="toggleCharCard('${char.id}')">
    <div class="char-header">
      <div class="char-avatar" style="background:linear-gradient(135deg,${char.color||'var(--primary)'},${char.colorLight||'var(--primary-light)'})" onclick="event.stopPropagation();uploadCharAvatar('${char.id}')">
        ${char.avatarImage ? `<img src="${char.avatarImage}" alt="${esc(char.name)}">` : (char.avatar || 'üë§')}
        ${char.rank ? `<span class="char-avatar-rank">${esc(char.rank)}</span>` : ''}
        <div class="upload-btn">üì∑</div>
      </div>
      <div class="char-info">
        <div class="char-name">
          ${esc(char.name)}
          ${char.title ? `<span class="char-title">${esc(char.title)}</span>` : ''}
        </div>
        <div class="char-brief">${esc(char.brief || char.description || '')}</div>
        <div class="char-quick">${quickStats.join('')}</div>
      </div>
      <div class="char-expand">‚ñº</div>
    </div>
    <div class="char-content">
      <div class="char-inner">
        <div class="char-tabs">
          <div class="char-tab active" onclick="event.stopPropagation();switchCharTab('${char.id}','basic')">Âü∫Êú¨</div>
          <div class="char-tab" onclick="event.stopPropagation();switchCharTab('${char.id}','stats')">Â±¨ÊÄß</div>
          <div class="char-tab" onclick="event.stopPropagation();switchCharTab('${char.id}','relation')">Èóú‰øÇ</div>
        </div>
        <div class="char-tab-content active" id="char-${char.id}-basic">
          ${char.description ? `<div class="char-desc">${esc(char.description)}</div>` : ''}
          ${tagHtml ? `<div class="char-tags">${tagHtml}</div>` : ''}
          ${char.extraInfo ? `<div class="char-mini-stats">${Object.entries(char.extraInfo).map(([k,v])=>`<div class="char-mini-stat"><div class="char-mini-val">${esc(String(v))}</div><div class="char-mini-label">${esc(k)}</div></div>`).join('')}</div>` : ''}
        </div>
        <div class="char-tab-content" id="char-${char.id}-stats">
          <div class="char-section">
            <div class="char-section-title">Â±¨ÊÄßÊï∏ÂÄº</div>
            ${statBars || '<div style="font-size:12px;color:var(--text-tertiary)">Êö´ÁÑ°Â±¨ÊÄßÊï∏Êìö</div>'}
          </div>
        </div>
        <div class="char-tab-content" id="char-${char.id}-relation">
          <div class="char-section">
            <div class="char-section-title">‰∫∫Áâ©Èóú‰øÇ</div>
            ${relationHtml || '<div style="font-size:12px;color:var(--text-tertiary)">Êö´ÁÑ°Èóú‰øÇÊï∏Êìö</div>'}
          </div>
        </div>
        <div class="char-actions">
          <button class="char-action-btn secondary" onclick="event.stopPropagation();showCharHistory('${char.id}')">üìú Ê≠∑Âè≤</button>
          <button class="char-action-btn primary" onclick="event.stopPropagation();showCharDetail('${char.id}')">üìù Ë©≥ÊÉÖ</button>
        </div>
      </div>
    </div>
  </div>`;
}

// Â±ïÈñã/Êî∂Ëµ∑ËßíËâ≤Âç°
function toggleCharCard(charId){
  const card = document.getElementById('char-'+charId);
  if(card) card.classList.toggle('expanded');
}

// ÂàáÊèõËßíËâ≤Tab
function switchCharTab(charId, tabName){
  const card = document.getElementById('char-'+charId);
  if(!card) return;
  card.querySelectorAll('.char-tab').forEach((t,i) => {
    t.classList.toggle('active', t.textContent.includes(tabName==='basic'?'Âü∫Êú¨':tabName==='stats'?'Â±¨ÊÄß':'Èóú‰øÇ'));
  });
  card.querySelectorAll('.char-tab-content').forEach(c => c.classList.remove('active'));
  const target = document.getElementById(`char-${charId}-${tabName}`);
  if(target) target.classList.add('active');
}

// Âà∑Êñ∞/Êõ¥Êñ∞ËßíËâ≤ÁãÄÊÖãÔºàAIËß£ÊûêÔºâ
function showAICharacterUpdate(){
  if(!story){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'),'warning');return;}
  if(!msgs.length){toast(T('ÊïÖ‰∫ãÂÖßÂÆπÁÇ∫Á©∫ÔºåË´ãÂÖàÈñãÂßãÊïÖ‰∫ã'),'warning');return;}
  document.getElementById('char-update-result').textContent='ÈªûÊìä„ÄåÈñãÂßãÂàÜÊûê„ÄçËÆì AI Ë≠òÂà•ËßíËâ≤...';
  document.getElementById('char-update-btn').textContent='ÈñãÂßãÂàÜÊûê';
  document.getElementById('char-update-btn').disabled=false;
  showModal('char-update-modal');
}

async function doCharacterUpdate(){
  const resultEl = document.getElementById('char-update-result');
  const btn = document.getElementById('char-update-btn');
  btn.disabled = true;
  btn.textContent = 'ÂàÜÊûê‰∏≠...';
  resultEl.textContent = 'Ê≠£Âú®ÂàÜÊûêÊïÖ‰∫ãÂÖßÂÆπÔºåË≠òÂà•ËßíËâ≤...';
  
  // ÊßãÂª∫ÊèêÁ§∫Ë©û
  const prompt = `‰Ω†ÊòØ‰∏ÄÂÄãÂ∞àÊ•≠ÁöÑËßíËâ≤ÁãÄÊÖãÊèêÂèñÂä©Êâã„ÄÇË´ã‰ªîÁ¥∞ÂàÜÊûê‰ª•‰∏ãÊïÖ‰∫ãÂÖßÂÆπÔºåË≠òÂà•ÊâÄÊúâÂá∫ÁèæÁöÑÈáçË¶ÅËßíËâ≤Ôºå‰∏¶ÊèêÂèñ‰ªñÂÄëÁöÑÁãÄÊÖã‰ø°ÊÅØ„ÄÇ

**ÈáçË¶ÅÔºö‰Ω†ÂøÖÈ†àËøîÂõûÂÆåÊï¥ÁöÑ JSON Ê†ºÂºèÔºå‰∏çÂèØ‰∏≠ÈÄîÂÅúÊ≠¢„ÄÇ**

Ë´ã‰ª• JSON Ê†ºÂºèËøîÂõûÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
\`\`\`json
{
  "characters": [
    {
      "name": "ËßíËâ≤Âêç",
      "title": "È†≠Èäú/Ë∫´‰ªΩÔºàÂ¶ÇÁöáÂ§´„ÄÅÈÅ∏‰æçÁ≠âÔºâ",
      "rank": "ÂìÅÁ¥öÔºàÂ¶Ç‰∏ÄÂìÅ„ÄÅÂÖ≠ÂìÅÁ≠âÔºåÊ≤íÊúâÂâáÁïôÁ©∫Ôºâ",
      "avatar": "‰∏ÄÂÄã‰ª£Ë°®ËßíËâ≤ÁöÑemojiÔºàÂ¶Çüëëüó°Ô∏èüíêüé≠Ôºâ",
      "brief": "‰∏ÄÂè•Ë©±Á∞°‰ªãÔºà20Â≠ó‰ª•ÂÖßÔºâ",
      "description": "Ë©≥Á¥∞ÊèèËø∞ÔºàÊÄßÊ†º„ÄÅËÉåÊôØ„ÄÅÁâπÈªûÔºå100Â≠ó‰ª•ÂÖßÔºâ",
      "stats": {
        "Â±¨ÊÄßÂêç": Êï∏ÂÄºÔºà0-100Ôºâ
      },
      "tags": ["Ê®ôÁ±§1", "Ê®ôÁ±§2"],
      "relationships": [
        {
          "targetName": "Èóú‰øÇÂ∞çË±°ÁöÑËßíËâ≤Âêç",
          "type": "Èóú‰øÇÈ°ûÂûã‰ª£Á¢ºÔºàË¶ã‰∏ãÊñπÂàóË°®Ôºâ",
          "description": "Èóú‰øÇÁöÑË©≥Á¥∞ÊèèËø∞ÔºàÂèØÈÅ∏Ôºâ"
        }
      ],
      "extraInfo": {
        "Âπ¥ÈΩ°": "19Ê≠≤",
        "ÂÖ∂‰ªñ‰ø°ÊÅØ": "ÂÄº"
      }
    }
  ]
}
\`\`\`

Èóú‰øÇÈ°ûÂûã‰ª£Á¢ºÔºàtypeÔºâÂøÖÈ†à‰ΩøÁî®‰ª•‰∏ã‰πã‰∏ÄÔºö
- lover: ÊàÄ‰∫∫
- ex: Ââç‰ªª
- crush: ÊöóÊàÄ
- spouse: ÈÖçÂÅ∂
- family: ÂÆ∂‰∫∫
- friend: ÊúãÂèã
- bestfriend: ÊëØÂèã
- enemy: Êïµ‰∫∫
- rival: Â∞çÊâã
- boss: ‰∏äÂè∏
- subordinate: ‰∏ãÂ±¨
- mentor: Â∏´Âæí
- colleague: Âêå‰∫ã
- stranger: ÈôåÁîü‰∫∫

Ê†πÊìöÊïÖ‰∫ãÈ°ûÂûãËá™ÂãïÂà§Êñ∑ÂêàÈÅ©ÁöÑÂ±¨ÊÄßÔºö
- ÂæåÂÆÆ/ÂÆÆÈ¨•ÔºöÂ•ΩÊÑü„ÄÅË°®Èù¢Â•ΩÊÑü„ÄÅÁúüÂØ¶Â•ΩÊÑü„ÄÅÂø†Ë™†„ÄÅÈáéÂøÉ„ÄÅÂØµÊÑõÂ∫¶Á≠â
- ‰øÆ‰ªô/ÁéÑÂπªÔºöÂ¢ÉÁïå„ÄÅÈùàÂäõ„ÄÅÂ£ΩÂÖÉ„ÄÅÂäüÊ≥ïÁ≠âÁ¥öÁ≠â
- Êú´Êó•/ÁîüÂ≠òÔºöÁîüÂëΩ„ÄÅÈ£¢È§ì„ÄÅÁ≤æÁ•û„ÄÅÊÑüÊüìÂ∫¶Á≠â
- ÂÜíÈö™/RPGÔºöHP„ÄÅMP„ÄÅÂäõÈáè„ÄÅÊïèÊç∑„ÄÅÁ≠âÁ¥öÁ≠â

ÊïÖ‰∫ãÂÖßÂÆπÔºö
${msgs.slice(-30).map(m=>(m.role==='user'?'„ÄêÁé©ÂÆ∂„Äë':'„ÄêAI„Äë')+m.content).join('\n\n')}

**ÈáçË¶ÅÊèêÈÜíÔºö**
1. ÂøÖÈ†àËøîÂõûÂÆåÊï¥ÁöÑ JSON Ê†ºÂºè
2. Á¢∫‰øùÊâÄÊúâËßíËâ≤‰ø°ÊÅØÈÉΩÂÆåÊï¥
3. ‰Ω†Êúâ 8000 tokens ÁöÑÈ°çÂ∫¶ÔºåË∂≥Â§†Ëº∏Âá∫ÂÆåÊï¥ÂÖßÂÆπ
4. ‰∏çË¶Å‰∏≠ÈÄîÂÅúÊ≠¢ÔºåÂøÖÈ†àÂÆåÊàêÊâÄÊúâËßíËâ≤ÁöÑ‰ø°ÊÅØ

ÁèæÂú®ÈñãÂßãÂàÜÊûê‰∏¶ËøîÂõûÂÆåÊï¥ÁöÑ JSONÔºö`;

  try{
    const resp = await callApi(prompt);
    let content = resp.content;
    console.log('[AI Character Update] ÂéüÂßãËøîÂõû:', content);
    resultEl.textContent = 'Ëß£ÊûêAIÂõûË¶Ü...';

    // ÊèêÂèñJSON
    const jsonMatch = content.match(/```json\s*([\s\S]*?)\s*```/) || content.match(/\{[\s\S]*"characters"[\s\S]*\}/);
    if(!jsonMatch){
      console.error('[AI Character Update] ÁÑ°Ê≥ïÊâæÂà∞ JSON Ê†ºÂºèÔºåÂéüÂßãËøîÂõû:', content);
      resultEl.textContent = '‚ùå AI ÂõûË¶ÜÊ†ºÂºèÈåØË™§ÔºåÁÑ°Ê≥ïËß£ÊûêËßíËâ≤Êï∏Êìö\n\nÂéüÂßãÂõûË¶ÜÔºö\n' + content.slice(0,500);
      btn.disabled = false;
      btn.textContent = 'ÈáçË©¶';
      return;
    }

    const jsonStr = jsonMatch[1] || jsonMatch[0];
    console.log('[AI Character Update] ÊèêÂèñÁöÑ JSON:', jsonStr);

    let data;
    try {
      data = JSON.parse(jsonStr);
      console.log('[AI Character Update] Ëß£ÊûêÊàêÂäü:', data);
    } catch(e) {
      console.error('[AI Character Update] JSON Ëß£ÊûêÂ§±Êïó:', e, 'ÂéüÂßãÂÖßÂÆπ:', jsonStr);
      resultEl.textContent = '‚ùå JSON Ëß£ÊûêÂ§±ÊïóÔºö' + e.message + '\n\nÂéüÂßãÂÖßÂÆπÔºö\n' + jsonStr.slice(0,500);
      btn.disabled = false;
      btn.textContent = 'ÈáçË©¶';
      return;
    }

    if(!data.characters || !data.characters.length){
      console.warn('[AI Character Update] Êú™Ë≠òÂà•Âà∞ËßíËâ≤');
      resultEl.textContent = '‚ùå Êú™Ë≠òÂà•Âà∞ËßíËâ≤ÔºåË´ãÁ¢∫‰øùÊïÖ‰∫ã‰∏≠ÊúâËßíËâ≤Âá∫Áèæ';
      btn.disabled = false;
      btn.textContent = 'ÈáçË©¶';
      return;
    }

    console.log('[AI Character Update] Ë≠òÂà•Âà∞', data.characters.length, 'ÂÄãËßíËâ≤');
    resultEl.textContent = `‚úÖ Ë≠òÂà•Âà∞ ${data.characters.length} ÂÄãËßíËâ≤ÔºåÊ≠£Âú®‰øùÂ≠ò...`;

    // ËºîÂä©ÂáΩÊï∏ÔºöÊô∫ËÉΩÊò†Â∞ÑÈóú‰øÇÈ°ûÂûã
    const mapRelationType = (type) => {
      if(!type) return 'friend';
      const typeStr = String(type).toLowerCase().trim();

      // Áõ¥Êé•ÂåπÈÖçÊ®ôÊ∫ñÈ°ûÂûã
      const validTypes = ['lover', 'ex', 'crush', 'spouse', 'family', 'friend', 'bestfriend',
                          'enemy', 'rival', 'boss', 'subordinate', 'mentor', 'colleague', 'stranger'];
      if(validTypes.includes(typeStr)) return typeStr;

      // Êô∫ËÉΩÊò†Â∞Ñ‰∏≠ÊñáÊàñÂÖ∂‰ªñÊèèËø∞
      const mapping = {
        'ÊàÄ‰∫∫': 'lover', 'ÊÉÖ‰æ∂': 'lover', 'Áî∑Âèã': 'lover', 'Â•≥Âèã': 'lover',
        'Ââç‰ªª': 'ex', 'ÂâçÁî∑Âèã': 'ex', 'ÂâçÂ•≥Âèã': 'ex',
        'ÊöóÊàÄ': 'crush', 'ÂñÆÊàÄ': 'crush', 'ÂñúÊ≠°': 'crush',
        'ÈÖçÂÅ∂': 'spouse', 'Â§´Â¶ª': 'spouse', 'ËÄÅÂÖ¨': 'spouse', 'ËÄÅÂ©Ü': 'spouse', '‰∏àÂ§´': 'spouse', 'Â¶ªÂ≠ê': 'spouse',
        'ÂÆ∂‰∫∫': 'family', 'Ë¶™‰∫∫': 'family', 'Áà∂ÊØç': 'family', 'ÂÖÑÂºü': 'family', 'ÂßêÂ¶π': 'family', 'Ë¶™Â±¨': 'family',
        'ÊúãÂèã': 'friend', 'ÂèãÂ•Ω': 'friend', 'Â•ΩÂèã': 'friend',
        'ÊëØÂèã': 'bestfriend', 'Èñ®Ëúú': 'bestfriend', 'Ê≠ªÈª®': 'bestfriend',
        'Êïµ‰∫∫': 'enemy', '‰ªá‰∫∫': 'enemy', 'ÊïµÂ∞ç': 'enemy',
        'Â∞çÊâã': 'rival', 'Á´∂Áà≠': 'rival', 'ÊÉÖÊïµ': 'rival',
        '‰∏äÂè∏': 'boss', 'ËÄÅÈóÜ': 'boss', 'È†òÂ∞é': 'boss',
        '‰∏ãÂ±¨': 'subordinate', 'ÈÉ®‰∏ã': 'subordinate', 'Êâã‰∏ã': 'subordinate',
        'Â∏´Âæí': 'mentor', 'Â∏´Áà∂': 'mentor', 'ÂæíÂºü': 'mentor', 'ËÄÅÂ∏´': 'mentor',
        'Âêå‰∫ã': 'colleague', 'ÂêåÂÉö': 'colleague',
        'ÈôåÁîü‰∫∫': 'stranger', '‰∏çÁÜü': 'stranger', '‰∏≠Á´ã': 'stranger'
      };

      return mapping[typeStr] || 'friend'; // ÈªòË™çÁÇ∫ÊúãÂèã
    };

    // ËºîÂä©ÂáΩÊï∏ÔºöÊ†πÊìöËßíËâ≤ÂêçÊü•ÊâæËßíËâ≤ID
    const findCharacterIdByName = async (name, allChars) => {
      if(!name) return null;
      const nameStr = String(name).trim().toLowerCase();
      const found = allChars.find(c => c.name && c.name.trim().toLowerCase() === nameStr);
      return found ? found.id : null;
    };

    // È©óË≠âÂíåÊ∏ÖÁêÜAIÁîüÊàêÁöÑËßíËâ≤Êï∏Êìö
    const validateCharacter = (char) => {
      const validated = {
        name: (char.name || 'Êú™Áü•ËßíËâ≤').trim(),
        title: typeof char.title === 'string' ? char.title : '',
        rank: typeof char.rank === 'string' ? char.rank : '',
        avatar: typeof char.avatar === 'string' ? char.avatar : 'üë§',
        brief: typeof char.brief === 'string' ? char.brief : '',
        description: typeof char.description === 'string' ? char.description : '',
        tags: Array.isArray(char.tags) ? char.tags.filter(t => typeof t === 'string') : [],
        stats: {},
        relationships: [], // Êö´ÊôÇÁÇ∫Á©∫ÔºåÁ®çÂæåËôïÁêÜ
        extraInfo: typeof char.extraInfo === 'object' && char.extraInfo !== null ? char.extraInfo : {}
      };

      // È©óË≠âstatsÔºöÁ¢∫‰øùÊòØÊï∏Â≠ó‰∏îÂú®ÂêàÁêÜÁØÑÂúç
      if(typeof char.stats === 'object' && char.stats !== null){
        for(const [key, val] of Object.entries(char.stats)){
          const numVal = parseFloat(val);
          if(!isNaN(numVal)){
            validated.stats[key] = Math.max(0, Math.min(100, numVal)); // ÈôêÂà∂Âú®0-100
          }
        }
      }

      // ‰øùÂ≠òÂéüÂßã relationships Êï∏ÊìöÔºåÁ®çÂæåÁµ±‰∏ÄËôïÁêÜ
      validated._rawRelationships = Array.isArray(char.relationships) ? char.relationships : [];

      return validated;
    };

    // Áç≤ÂèñÁèæÊúâËßíËâ≤
    const existing = await db.characters.where('storyId').equals(story.id).toArray();
    const existingMap = {};
    existing.forEach(c => existingMap[c.name] = c);

    // Êõ¥Êñ∞ÊàñÊñ∞Â¢ûËßíËâ≤ÔºàÁ¨¨‰∏ÄÈöéÊÆµÔºö‰øùÂ≠òÂü∫Êú¨‰ø°ÊÅØÔºâ
    let successCount = 0;
    let errorCount = 0;
    const validatedChars = []; // ‰øùÂ≠òÈ©óË≠âÂæåÁöÑËßíËâ≤Êï∏Êìö

    for(const rawChar of data.characters){
      try {
        const char = validateCharacter(rawChar);
        validatedChars.push(char);

        const existingChar = existingMap[char.name];
        if(existingChar){
          // Ë®òÈåÑÊ≠∑Âè≤ËÆäÂåñ
          const oldStats = existingChar.stats || {};
          const newStats = char.stats || {};
          const changes = [];
          for(const [key, newVal] of Object.entries(newStats)){
            const oldVal = oldStats[key];
            if(oldVal !== undefined && oldVal !== newVal){
              changes.push({attr: key, from: oldVal, to: newVal});
            }
          }
          if(changes.length){
            await db.characterHistory.add({
              id: crypto.randomUUID(),
              storyId: story.id,
              characterId: existingChar.id,
              changes,
              createdAt: Date.now()
            });
          }
          // Êõ¥Êñ∞ËßíËâ≤ÔºàÊö´‰∏çÂåÖÂê´ relationshipsÔºâ
          await db.characters.update(existingChar.id, {
            ...char,
            id: existingChar.id,
            storyId: story.id,
            relationships: existingChar.relationships || [], // ‰øùÁïôÁèæÊúâÈóú‰øÇ
            updatedAt: Date.now()
          });
        }else{
          // Êñ∞Â¢ûËßíËâ≤ÔºàÊö´‰∏çÂåÖÂê´ relationshipsÔºâ
          await db.characters.add({
            ...char,
            id: crypto.randomUUID(),
            storyId: story.id,
            relationships: [],
            createdAt: Date.now(),
            updatedAt: Date.now()
          });
        }
        successCount++;
      } catch(e) {
        console.error('ËßíËâ≤Êï∏ÊìöÁÑ°Êïà:', rawChar, e);
        errorCount++;
      }
    }

    // Á¨¨‰∫åÈöéÊÆµÔºöËôïÁêÜÈóú‰øÇÔºàÊâÄÊúâËßíËâ≤ÈÉΩÂ∑≤‰øùÂ≠òÂæåÔºâ
    resultEl.textContent = `‚úÖ ËßíËâ≤Â∑≤‰øùÂ≠òÔºåÊ≠£Âú®ËôïÁêÜÈóú‰øÇ...`;

    // ÈáçÊñ∞Áç≤ÂèñÊâÄÊúâËßíËâ≤ÔºàÂåÖÊã¨Ââõ‰øùÂ≠òÁöÑÔºâ
    const allChars = await db.characters.where('storyId').equals(story.id).toArray();

    for(const char of validatedChars){
      if(!char._rawRelationships || char._rawRelationships.length === 0) continue;

      // ÊâæÂà∞Â∞çÊáâÁöÑÊï∏ÊìöÂ∫´ËßíËâ≤
      const dbChar = allChars.find(c => c.name === char.name);
      if(!dbChar) continue;

      // ËΩâÊèõÈóú‰øÇÊï∏Êìö
      const relationships = [];
      for(const rel of char._rawRelationships){
        if(!rel.targetName) continue;

        const targetId = await findCharacterIdByName(rel.targetName, allChars);
        if(!targetId) continue; // ÁõÆÊ®ôËßíËâ≤‰∏çÂ≠òÂú®ÔºåË∑≥ÈÅé

        const typeInfo = RELATIONSHIP_TYPES.find(t => t.code === mapRelationType(rel.type));
        relationships.push({
          targetId: targetId,
          targetName: rel.targetName,
          type: mapRelationType(rel.type),
          label: typeInfo ? typeInfo.label : rel.type,
          description: rel.description || ''
        });
      }

      // Êõ¥Êñ∞ËßíËâ≤ÁöÑÈóú‰øÇ
      if(relationships.length > 0){
        await db.characters.update(dbChar.id, {
          relationships: relationships,
          updatedAt: Date.now()
        });
      }
    }

    // È°ØÁ§∫ÁµêÊûú
    if(errorCount === 0){
      resultEl.textContent = `‚úÖ ÊàêÂäüÊõ¥Êñ∞ ${successCount} ÂÄãËßíËâ≤ÂèäÂÖ∂Èóú‰øÇÔºÅ`;
      toast(`Â∑≤Êõ¥Êñ∞ ${successCount} ÂÄãËßíËâ≤ÂèäÈóú‰øÇ`, 'success');
    } else {
      resultEl.textContent = `‚ö†Ô∏è ÊàêÂäü ${successCount} ÂÄãÔºåÂ§±Êïó ${errorCount} ÂÄã`;
      toast(`ÊàêÂäü ${successCount} ÂÄãÔºåÂ§±Êïó ${errorCount} ÂÄã`, 'warning');
    }
    closeModal('char-update-modal');
    renderCharacters();

  }catch(e){
    console.error('Character update error:', e);
    resultEl.textContent = '‚ùå Êõ¥Êñ∞Â§±Êïó: ' + e.message;
    btn.disabled = false;
    btn.textContent = 'ÈáçË©¶';
  }
}

// ÊâãÂãïÊ∑ªÂä†ËßíËâ≤
let editingCharacterId = null; // Ë®òÈåÑÊ≠£Âú®Á∑®ËºØÁöÑËßíËâ≤ID
let charAltGreetings = []; // Êõø‰ª£ÈñãÂ†¥ÁôΩÊï∏ÁµÑ
let charLorebookEntries = []; // ËßíËâ≤LorebookÊ¢ùÁõÆ

function addCharacterManual(){
  if(!story){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'),'warning');return;}
  editingCharacterId = null;
  resetCharEditForm();
  document.getElementById('char-modal-title').textContent = '‚ûï Ê∑ªÂä†ËßíËâ≤';
  showModal('char-add-modal');
}

// ÈáçÁΩÆË°®ÂñÆ
function resetCharEditForm(){
  // ÂÆâÂÖ®Ë®≠ÁΩÆÂÄºÁöÑËºîÂä©ÂáΩÊï∏
  const setVal = (id, val) => {
    const el = document.getElementById(id);
    if(el) el.value = val;
  };
  
  setVal('char-add-name', '');
  setVal('char-add-title', '');
  setVal('char-add-avatar', '');
  setVal('char-add-category', 'supporting');
  setVal('char-add-desc', '');
  setVal('char-add-personality', '');
  setVal('char-add-tags', '');
  setVal('char-add-firstmes', '');
  setVal('char-add-scenario', '');
  setVal('char-add-example', '');
  setVal('char-add-sysprompt', '');
  setVal('char-add-posthistory', '');
  setVal('char-add-creatornotes', '');
  setVal('char-add-creator', '');
  setVal('char-add-version', '1.0');
  setVal('char-add-lore-trigger', 'scene');
  setVal('char-add-stats', '');
  
  // ÈáçÁΩÆÊõø‰ª£ÈñãÂ†¥ÁôΩ
  charAltGreetings = [];
  renderAltGreetings();
  
  // ÈáçÁΩÆÈ†≠ÂÉèÂúñÁâá
  tempCharAvatarImage = null;
  const avatarPreview = document.getElementById('char-avatar-preview');
  if(avatarPreview) avatarPreview.style.display = 'none';
  const avatarImg = document.getElementById('char-avatar-img');
  if(avatarImg) avatarImg.src = '';
  
  // ÈáçÁΩÆLorebookÊ¢ùÁõÆ
  charLorebookEntries = [];
  renderCharLorebookEntries();
  
  // v25: ÈáçÁΩÆÈóú‰øÇÊï∏Êìö
  charRelationships = [];
  renderCharRelationships();
  
  // v25: ÈáçÁΩÆË°®ÊÉÖÊï∏Êìö
  charExpressions = [];
  renderCharExpressions();
  const exprModeEl = document.getElementById('char-add-expr-mode');
  if(exprModeEl) exprModeEl.value = 'manual';
  
  // ÈáçÁΩÆÈù¢ÊùøÁãÄÊÖãÔºàÂè™Â±ïÈñãÂü∫Êú¨‰ø°ÊÅØÔºâ
  document.querySelectorAll('.char-panel').forEach(p => {
    const panel = p.dataset.panel;
    const content = p.querySelector('.char-panel-content');
    const arrow = p.querySelector('.char-panel-arrow');
    if(content && arrow){
      if(panel === 'basic'){
        content.style.display = 'block';
        arrow.textContent = '‚ñº';
        p.classList.add('expanded');
      } else {
        content.style.display = 'none';
        arrow.textContent = '‚ñ∂';
        p.classList.remove('expanded');
      }
    }
  });
  
  updateCharTokenCount();
}

// ÈóúÈñâËßíËâ≤Á∑®ËºØÊ®°ÊÖãÊ°Ü
function closeCharEditModal(){
  closeModal('char-add-modal');
  editingCharacterId = null;
}

// ÂàáÊèõÈù¢ÊùøÂ±ïÈñã/ÊäòÁñä
function toggleCharPanel(panelName){
  const panel = document.querySelector(`.char-panel[data-panel="${panelName}"]`);
  if(!panel) return;
  
  const content = panel.querySelector('.char-panel-content');
  const arrow = panel.querySelector('.char-panel-arrow');
  
  if(content.style.display === 'none'){
    content.style.display = 'block';
    arrow.textContent = '‚ñº';
    panel.classList.add('expanded');
  } else {
    content.style.display = 'none';
    arrow.textContent = '‚ñ∂';
    panel.classList.remove('expanded');
  }
}

// Ê∑ªÂä†Êõø‰ª£ÈñãÂ†¥ÁôΩ
function addAltGreeting(){
  charAltGreetings.push('');
  renderAltGreetings();
}

// Ê∏≤ÊüìÊõø‰ª£ÈñãÂ†¥ÁôΩ
function renderAltGreetings(){
  const container = document.getElementById('char-alt-greetings');
  if(!container) return;
  
  container.innerHTML = charAltGreetings.map((g, i) => `
    <div class="alt-greeting-item">
      <textarea class="form-textarea" placeholder="Êõø‰ª£ÈñãÂ†¥ÁôΩ ${i + 1}..." oninput="charAltGreetings[${i}]=this.value">${esc(g)}</textarea>
      <button class="delete-btn" onclick="removeAltGreeting(${i})">‚úï</button>
    </div>
  `).join('');
}

// ÁßªÈô§Êõø‰ª£ÈñãÂ†¥ÁôΩ
function removeAltGreeting(index){
  charAltGreetings.splice(index, 1);
  renderAltGreetings();
}

// Ê∑ªÂä†ËßíËâ≤LorebookÊ¢ùÁõÆ
function addCharLorebookEntry(){
  charLorebookEntries.push({
    id: crypto.randomUUID(),
    keys: [],
    content: '',
    enabled: true,
    priority: 10
  });
  renderCharLorebookEntries();
}

// Ê∏≤ÊüìËßíËâ≤LorebookÊ¢ùÁõÆ
function renderCharLorebookEntries(){
  const container = document.getElementById('char-lorebook-entries');
  if(!container) return;
  
  container.innerHTML = charLorebookEntries.map((entry, i) => `
    <div class="char-lore-entry">
      <button class="delete-btn" onclick="removeCharLorebookEntry(${i})">‚úï</button>
      <div class="form-group" style="margin-bottom:8px">
        <input type="text" class="form-input" placeholder="Ëß∏ÁôºË©ûÔºàÁî®ÈÄóËôüÂàÜÈöîÔºâ" 
               value="${esc(entry.keys?.join(', ') || '')}"
               oninput="charLorebookEntries[${i}].keys=this.value.split(',').map(s=>s.trim()).filter(s=>s)"
               style="font-size:13px;padding:8px 12px">
      </div>
      <textarea class="form-textarea" placeholder="ÂÖßÂÆπ..." rows="2"
                oninput="charLorebookEntries[${i}].content=this.value"
                style="font-size:13px;min-height:60px">${esc(entry.content || '')}</textarea>
    </div>
  `).join('');
}

// ÁßªÈô§ËßíËâ≤LorebookÊ¢ùÁõÆ
function removeCharLorebookEntry(index){
  charLorebookEntries.splice(index, 1);
  renderCharLorebookEntries();
}

// Token Ë®àÊï∏ÔºàÁ∞°Êòì‰º∞ÁÆóÔºâ
function updateCharTokenCount(){
  const desc = document.getElementById('char-add-desc')?.value || '';
  const firstmes = document.getElementById('char-add-firstmes')?.value || '';
  const example = document.getElementById('char-add-example')?.value || '';
  const sysprompt = document.getElementById('char-add-sysprompt')?.value || '';
  
  // Á∞°Êòì‰º∞ÁÆóÔºö‰∏≠ÊñáÁ¥Ñ1.5Â≠óÁ¨¶/tokenÔºåËã±ÊñáÁ¥Ñ4Â≠óÁ¨¶/token
  const estimateTokens = (text) => {
    const chineseChars = (text.match(/[\u4e00-\u9fff]/g) || []).length;
    const otherChars = text.length - chineseChars;
    return Math.ceil(chineseChars / 1.5 + otherChars / 4);
  };
  
  const descTokens = estimateTokens(desc);
  const firstmesTokens = estimateTokens(firstmes);
  const exampleTokens = estimateTokens(example);
  const syspromptTokens = estimateTokens(sysprompt);
  const total = descTokens + firstmesTokens + exampleTokens + syspromptTokens;
  
  // Êõ¥Êñ∞È°ØÁ§∫
  const descHint = document.getElementById('desc-tokens');
  const firstmesHint = document.getElementById('firstmes-tokens');
  const exampleHint = document.getElementById('example-tokens');
  const syspromptHint = document.getElementById('sysprompt-tokens');
  const totalHint = document.getElementById('char-token-count');
  
  if(descHint) descHint.textContent = descTokens > 0 ? `(~${descTokens} tokens)` : '';
  if(firstmesHint) firstmesHint.textContent = firstmesTokens > 0 ? `(~${firstmesTokens} tokens)` : '';
  if(exampleHint) exampleHint.textContent = exampleTokens > 0 ? `(~${exampleTokens} tokens)` : '';
  if(syspromptHint) syspromptHint.textContent = syspromptTokens > 0 ? `(~${syspromptTokens} tokens)` : '';
  if(totalHint) totalHint.textContent = total > 0 ? `Á∏ΩË®à ~${total} tokens` : '';
}

// ÂèØË¶ñÂåñÂ∞çË©±Á§∫‰æãÁ∑®ËºØÂô®ÔºàÁ∞°ÊòìÁâàÔºâ
function openVisualExampleEditor(){
  const current = document.getElementById('char-add-example')?.value || '';
  toast(T('ÂèØË¶ñÂåñÁ∑®ËºØÂô®ÈñãÁôº‰∏≠ÔºåË´ãÁõ¥Êé•Âú®ÊñáÊú¨Ê°Ü‰∏≠Á∑®ËºØ'), 'info');
}

// Áç≤ÂèñÁï∂ÂâçÊ¥ªÂãïÁöÑAPIÈ†êË®≠
async function getActivePreset(){
  const preset = await db.apiPresets.filter(p => p.isActive).first();
  return preset;
}

// AI ËºîÂä©Â°´ÂØ´
async function aiGenerateCharFields(){
  const name = document.getElementById('char-add-name')?.value?.trim();
  const desc = document.getElementById('char-add-desc')?.value?.trim();
  
  if(!name && !desc){
    toast(T('Ë´ãÂÖàÂ°´ÂØ´ËßíËâ≤ÂêçÁ®±ÊàñÊèèËø∞'), 'warning');
    return;
  }
  
  const preset = await getActivePreset();
  if(!preset){
    toast(T('Ë´ãÂÖàË®≠ÁΩÆ API'), 'warning');
    return;
  }
  
  if(!preset.apiKey){
    toast(T('Ë´ãÂÖàË®≠ÁΩÆ API Key'), 'warning');
    return;
  }
  
  showLoading(T('AI Ê≠£Âú®ÁîüÊàêËßíËâ≤Ë®≠ÂÆö...'));
  
  try {
    const prompt = `Ê†πÊìö‰ª•‰∏ãËßíËâ≤‰ø°ÊÅØÔºåÂπ´ÊàëÁîüÊàêÂÆåÊï¥ÁöÑËßíËâ≤Ë®≠ÂÆöÔºö

ËßíËâ≤ÂêçÁ®±Ôºö${name || '(Êú™Â°´ÂØ´)'}
Â∑≤ÊúâÊèèËø∞Ôºö${desc || '(Êú™Â°´ÂØ´)'}

Ë´ãÁîüÊàê‰ª•‰∏ãÂÖßÂÆπÔºàJSONÊ†ºÂºèÔºâÔºö
{
  "personality": "ÊÄßÊ†ºÊëòË¶ÅÔºà‰∏ÄÂè•Ë©±ÊèèËø∞ÊÄßÊ†ºÁâπÈªûÔºâ",
  "first_mes": "ÈñãÂ†¥ÁôΩÔºàËßíËâ≤ÁöÑÁ¨¨‰∏ÄÊ¢ùÊ∂àÊÅØÔºåÁî®*ÊèèËø∞Âãï‰Ωú*ÔºåÁî®„ÄåÂ∞çË©±„ÄçÔºâ",
  "scenario": "Â†¥ÊôØÊèèËø∞ÔºàÂ∞çË©±ÁôºÁîüÁöÑËÉåÊôØÔºâ",
  "tags": ["Ê®ôÁ±§1", "Ê®ôÁ±§2", "Ê®ôÁ±§3"]
}

Âè™Ëº∏Âá∫JSONÔºå‰∏çË¶ÅÂÖ∂‰ªñÂÖßÂÆπ„ÄÇ`;

    const response = await callLLMForJSON(prompt, preset);
    
    if(response){
      if(response.personality && !document.getElementById('char-add-personality')?.value){
        document.getElementById('char-add-personality').value = response.personality;
      }
      if(response.first_mes && !document.getElementById('char-add-firstmes')?.value){
        document.getElementById('char-add-firstmes').value = response.first_mes;
      }
      if(response.scenario && !document.getElementById('char-add-scenario')?.value){
        document.getElementById('char-add-scenario').value = response.scenario;
      }
      if(response.tags && !document.getElementById('char-add-tags')?.value){
        document.getElementById('char-add-tags').value = response.tags.join(', ');
      }
      
      // Â±ïÈñãÂ∞çË©±Ë®≠ÁΩÆÈù¢Êùø
      const dialoguePanel = document.querySelector('.char-panel[data-panel="dialogue"]');
      if(dialoguePanel){
        const content = dialoguePanel.querySelector('.char-panel-content');
        const arrow = dialoguePanel.querySelector('.char-panel-arrow');
        content.style.display = 'block';
        arrow.textContent = '‚ñº';
        dialoguePanel.classList.add('expanded');
      }
      
      updateCharTokenCount();
      toast(T('AI Â∑≤ÁîüÊàêËßíËâ≤Ë®≠ÂÆö'), 'success');
    }
    
    hideLoading();
  } catch(err){
    hideLoading();
    console.error('AI generate error:', err);
    toast(T('AI ÁîüÊàêÂ§±Êïó: ') + err.message, 'error');
  }
}

// Ë™øÁî®LLMÁç≤ÂèñJSONÈüøÊáâ
async function callLLMForJSON(prompt, preset){
  const messages = [{role: 'user', content: prompt}];
  
  let apiUrl, headers, body;
  
  if(preset.type === 'anthropic'){
    apiUrl = 'https://api.anthropic.com/v1/messages';
    headers = {
      'Content-Type': 'application/json',
      'x-api-key': preset.apiKey,
      'anthropic-version': '2023-06-01'
    };
    body = {
      model: preset.model || 'claude-3-haiku-20240307',
      max_tokens: 8000,  // Ë™øÊï¥ÁÇ∫ 8000ÔºàClaude ÂèØÁî®ÔºåGemini ÂèØËÉΩÈúÄË¶ÅÊõ¥‰ΩéÔºâ
      messages
    };
  } else if(preset.type === 'openai'){
    apiUrl = 'https://api.openai.com/v1/chat/completions';
    headers = {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${preset.apiKey}`
    };
    body = {
      model: preset.model || 'gpt-3.5-turbo',
      max_tokens: 8000,  // Ë™øÊï¥ÁÇ∫ 8000ÔºàClaude ÂèØÁî®ÔºåGemini ÂèØËÉΩÈúÄË¶ÅÊõ¥‰ΩéÔºâ
      messages
    };
  } else if(preset.type === 'custom'){
    const autoComplete = preset.urlAutoComplete !== false;
    apiUrl = normalizeApiUrl(preset.url || preset.baseUrl, autoComplete, preset.model);
    headers = {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${preset.apiKey}`
    };
    body = {
      model: preset.model,
      max_tokens: 8000,  // Ë™øÊï¥ÁÇ∫ 8000ÔºàClaude ÂèØÁî®ÔºåGemini ÂèØËÉΩÈúÄË¶ÅÊõ¥‰ΩéÔºâ
      messages
    };
  }
  
  const res = await fetch(apiUrl, {
    method: 'POST',
    headers,
    body: JSON.stringify(body)
  });
  
  if(!res.ok){
    throw new Error(`API ÈåØË™§: ${res.status}`);
  }
  
  const data = await res.json();
  let content = '';
  
  if(preset.type === 'anthropic'){
    content = data.content?.[0]?.text || '';
  } else {
    content = data.choices?.[0]?.message?.content || '';
  }
  
  // ÂòóË©¶ÊèêÂèñJSON
  const jsonMatch = content.match(/\{[\s\S]*\}/);
  if(jsonMatch){
    return JSON.parse(jsonMatch[0]);
  }
  
  return null;
}

// Ë®≠ÁΩÆÁï∂ÂâçÁãÄÊÖãÁÇ∫ÂàùÂßãÁãÄÊÖã
async function setCurrentAsInitialStats(){
  if(!editingCharacterId){
    toast(T('Ë´ãÂÖà‰øùÂ≠òËßíËâ≤ÂæåÂÜçË®≠ÁΩÆÂàùÂßãÁãÄÊÖã'), 'warning');
    return;
  }
  
  const statsText = document.getElementById('char-add-stats')?.value?.trim() || '';
  const stats = {};
  if(statsText){
    statsText.split('\n').forEach(line => {
      const [key, val] = line.split(':').map(s => s.trim());
      if(key && val) stats[key] = parseInt(val) || val;
    });
  }
  
  if(Object.keys(stats).length === 0){
    toast(T('Ë´ãÂÖàÂ°´ÂØ´Â±¨ÊÄß'), 'warning');
    return;
  }
  
  await db.characters.update(editingCharacterId, { 
    initialStats: { ...stats },
    updatedAt: Date.now()
  });
  
  toast(T('Â∑≤Ë®≠ÁÇ∫ÂàùÂßãÁãÄÊÖã'), 'success');
}

// Ë®≠ÁΩÆÁï∂ÂâçÂÆåÊï¥Ë®≠ÂÆöÁÇ∫ÂàùÂßãË®≠ÂÆöÔºàÂåÖÂê´ÊâÄÊúâÂ≠óÊÆµÔºâ
async function setCurrentAsInitialState(){
  console.log('setCurrentAsInitialState called, editingCharacterId:', editingCharacterId);
  
  if(!editingCharacterId){
    toast(T('Ë´ãÂÖà‰øùÂ≠òËßíËâ≤ÂæåÂÜçË®≠ÁΩÆÂàùÂßãË®≠ÂÆö'), 'warning');
    console.log('No editingCharacterId, showing warning toast');
    return;
  }
  
  const getVal = (id) => document.getElementById(id)?.value?.trim() || '';
  
  // Ê™¢Êü•ÂøÖÂ°´Â≠óÊÆµ
  const name = getVal('char-add-name');
  if(!name){
    toast(T('Ë´ãÂÖàÂ°´ÂØ´ËßíËâ≤ÂêçÁ®±'), 'warning');
    return;
  }
  
  // Êî∂ÈõÜÊâÄÊúâÂ≠óÊÆµ
  const initialState = {
    name: name,
    title: getVal('char-add-title'),
    avatar: getVal('char-add-avatar') || 'üë§',
    category: getVal('char-add-category') || 'supporting',
    description: getVal('char-add-desc'),
    personality: getVal('char-add-personality'),
    tags: getVal('char-add-tags') ? getVal('char-add-tags').split(',').map(s => s.trim()).filter(s => s) : [],
    
    // Â∞çË©±Ë®≠ÁΩÆ
    first_mes: getVal('char-add-firstmes'),
    scenario: getVal('char-add-scenario'),
    mes_example: getVal('char-add-example'),
    alternate_greetings: charAltGreetings ? charAltGreetings.filter(g => g.trim()) : [],
    
    // È´òÁ¥öË®≠ÁΩÆ
    system_prompt: getVal('char-add-sysprompt'),
    post_history_instructions: getVal('char-add-posthistory'),
    creator_notes: getVal('char-add-creatornotes'),
    creator: getVal('char-add-creator'),
    character_version: getVal('char-add-version') || '1.0',
    
    // Â±¨ÊÄß
    stats: {}
  };
  
  // Ëß£ÊûêÂ±¨ÊÄß
  const statsText = getVal('char-add-stats');
  if(statsText){
    statsText.split('\n').forEach(line => {
      const [key, val] = line.split(':').map(s => s.trim());
      if(key && val) initialState.stats[key] = parseInt(val) || val;
    });
  }
  
  // Lorebook
  if(charLorebookEntries && charLorebookEntries.length > 0){
    const triggerMode = getVal('char-add-lore-trigger') || 'scene';
    initialState.character_book = {
      entries: charLorebookEntries.filter(e => e.keys?.length > 0 || e.content),
      triggerMode
    };
  }
  
  // Èóú‰øÇÊï∏Êìö
  if(charRelationships){
    initialState.relationships = charRelationships.filter(r => r.targetId);
  }
  
  // Ë°®ÊÉÖÊï∏Êìö
  if(charExpressions){
    initialState.expressions = charExpressions;
    initialState.expressionMode = document.getElementById('char-add-expr-mode')?.value || 'manual';
  }
  
  // Áç≤ÂèñÁï∂ÂâçËßíËâ≤ÁöÑÂúñÁâáÔºàÂ¶ÇÊûúÊúâÔºâ
  const existingChar = await db.characters.get(editingCharacterId);
  if(tempCharAvatarImage){
    initialState.avatarImage = tempCharAvatarImage;
  } else if(existingChar?.avatarImage){
    initialState.avatarImage = existingChar.avatarImage;
  }
  
  // Á¢∫Ë™çÊìç‰Ωú
  showConfirm(`Á¢∫ÂÆöË¶ÅÂ∞áÁï∂ÂâçË®≠ÂÆö‰øùÂ≠òÁÇ∫ÂàùÂßãË®≠ÂÆöÂóéÔºü\n\n‰πãÂæå„ÄåÈáçÊñ∞ÈñãÂßã„ÄçÊôÇÔºåËßíËâ≤Â∞áÊÅ¢Âæ©Âà∞Ê≠§ÁâàÊú¨ÁöÑË®≠ÂÆö„ÄÇ\n\nÈÄôÊúÉË¶ÜËìã‰πãÂâç‰øùÂ≠òÁöÑÂàùÂßãË®≠ÂÆö„ÄÇ`, async () => {
    await db.characters.update(editingCharacterId, { 
      initialState: initialState,
      initialStats: { ...initialState.stats }, // ÂêåÊôÇÊõ¥Êñ∞ initialStats ‰øùÊåÅÂÖºÂÆπ
      updatedAt: Date.now()
    });
    
    toast(T('Â∑≤‰øùÂ≠òÁÇ∫ÂàùÂßãË®≠ÂÆöÔºÅ'), 'success');
  });
}

// ÊÅ¢Âæ©Âà∞ÂàùÂßãÁãÄÊÖã
async function resetToInitialStats(){
  if(!editingCharacterId){
    toast(T('Ë´ãÂÖà‰øùÂ≠òËßíËâ≤'), 'warning');
    return;
  }
  
  const char = await db.characters.get(editingCharacterId);
  if(!char?.initialStats || Object.keys(char.initialStats).length === 0){
    toast(T('Ê≠§ËßíËâ≤Ê≤íÊúâÂàùÂßãÁãÄÊÖãË®òÈåÑ'), 'warning');
    return;
  }
  
  // Êõ¥Êñ∞Ëº∏ÂÖ•Ê°Ü
  const statsText = Object.entries(char.initialStats).map(([k,v]) => `${k}:${v}`).join('\n');
  document.getElementById('char-add-stats').value = statsText;
  
  toast(T('Â∑≤ÊÅ¢Âæ©Âà∞ÂàùÂßãÁãÄÊÖãÔºàË®òÂæóÈªû‰øùÂ≠òÔºâ'), 'info');
}

async function saveCharacterManual(){
  const getVal = (id) => document.getElementById(id)?.value?.trim() || '';
  
  const name = getVal('char-add-name');
  if(!name){toast(T('Ë´ãËº∏ÂÖ•ËßíËâ≤ÂêçÁ®±'),'warning');return;}
  
  // Êî∂ÈõÜÊâÄÊúâÂ≠óÊÆµ
  const title = getVal('char-add-title');
  const avatar = getVal('char-add-avatar') || 'üë§';
  const category = getVal('char-add-category') || 'supporting';
  const desc = getVal('char-add-desc');
  const personality = getVal('char-add-personality');
  const tagsText = getVal('char-add-tags');
  const tags = tagsText ? tagsText.split(',').map(s => s.trim()).filter(s => s) : [];
  
  // Â∞çË©±Ë®≠ÁΩÆ
  const first_mes = getVal('char-add-firstmes');
  const scenario = getVal('char-add-scenario');
  const mes_example = getVal('char-add-example');
  const alternate_greetings = charAltGreetings.filter(g => g.trim());
  
  // È´òÁ¥öË®≠ÁΩÆ
  const system_prompt = getVal('char-add-sysprompt');
  const post_history_instructions = getVal('char-add-posthistory');
  const creator_notes = getVal('char-add-creatornotes');
  const creator = getVal('char-add-creator');
  const character_version = getVal('char-add-version') || '1.0';
  
  // Lorebook
  const triggerMode = getVal('char-add-lore-trigger') || 'scene';
  const character_book = charLorebookEntries.length > 0 ? {
    entries: charLorebookEntries.filter(e => e.keys?.length > 0 || e.content),
    triggerMode
  } : null;
  
  // v25: Èóú‰øÇÊï∏Êìö
  const relationships = charRelationships.filter(r => r.targetId);
  
  // v25: Ë°®ÊÉÖÊï∏Êìö
  const expressions = charExpressions;
  const expressionMode = document.getElementById('char-add-expr-mode')?.value || 'manual';
  
  // Â±¨ÊÄß
  const statsText = getVal('char-add-stats');
  const stats = {};
  if(statsText){
    statsText.split('\n').forEach(line => {
      const [key, val] = line.split(':').map(s => s.trim());
      if(key && val) stats[key] = parseInt(val) || val;
    });
  }
  
  const now = Date.now();
  
  // ËôïÁêÜÂúñÁâá
  const avatarImage = tempCharAvatarImage || (editingCharacterId ? (await db.characters.get(editingCharacterId))?.avatarImage : null);
  
  if(editingCharacterId){
    // Êõ¥Êñ∞ÁèæÊúâËßíËâ≤
    const existingChar = await db.characters.get(editingCharacterId);
    const updateData = {
      name, title, avatar, category, description: desc, personality, tags,
      first_mes, alternate_greetings, scenario, mes_example,
      system_prompt, post_history_instructions, creator_notes, creator, character_version,
      character_book, stats, relationships, expressions, expressionMode,
      updatedAt: now
    };
    // Â¶ÇÊûúÊúâÊñ∞‰∏äÂÇ≥ÁöÑÂúñÁâáÔºåÊàñËÄÖÈ°ØÂºèÊ∏ÖÈô§‰∫ÜÂúñÁâá
    if(tempCharAvatarImage !== null) {
      updateData.avatarImage = tempCharAvatarImage || '';
    }
    // Â¶ÇÊûúËßíËâ≤ÈÇÑÊ≤íÊúâinitialStatsÔºåÂâá‰øùÂ≠òÁï∂Ââçstats‰ΩúÁÇ∫ÂàùÂßãÂÄº
    if(!existingChar?.initialStats && Object.keys(stats).length > 0){
      updateData.initialStats = { ...stats };
    }
    await db.characters.update(editingCharacterId, updateData);
    toast(T('ËßíËâ≤Â∑≤Êõ¥Êñ∞'), 'success');
  } else {
    // ÂâµÂª∫Êñ∞ËßíËâ≤
    const char = {
      id: crypto.randomUUID(),
      storyId: story.id,
      name, title, avatar, category, description: desc, personality, tags,
      first_mes, alternate_greetings, scenario, mes_example,
      system_prompt, post_history_instructions, creator_notes, creator, character_version,
      character_book, stats,
      initialStats: Object.keys(stats).length > 0 ? { ...stats } : null, // ‰øùÂ≠òÂàùÂßãÁãÄÊÖã
      relationships, expressions, expressionMode,
      avatarImage: tempCharAvatarImage || '',
      createdAt: now,
      updatedAt: now
    };
    
    await db.characters.add(char);
    toast(T('ËßíËâ≤Â∑≤Ê∑ªÂä†'), 'success');
  }
  
  // Ê∏ÖÈô§Ëá®ÊôÇÂúñÁâá
  tempCharAvatarImage = null;
  
  closeCharEditModal();
  renderCharacters();
}

// ============ ËßíËâ≤Âç°Â∞éÂÖ•/Â∞éÂá∫Á≥ªÁµ± ============
function showCharacterMenu(){
  const menu = document.getElementById('char-menu');
  menu.style.top = '50px';
  menu.style.right = '16px';
  menu.style.left = 'auto';
  menu.classList.add('active');
}

async function exportAllCharacters(){
  if(!story){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'),'warning');return;}
  const chars = await db.characters.where('storyId').equals(story.id).toArray();
  if(!chars.length){toast(T('Ê≤íÊúâËßíËâ≤ÂèØÂ∞éÂá∫'),'warning');return;}
  
  // ËΩâÊèõÁÇ∫ÂÆåÊï¥Ê†ºÂºèÔºàÂåÖÂê´ÊâÄÊúâÂ≠óÊÆµÔºâ
  const exportData = {
    format: 'zhimeng_characters_v2',
    exportedAt: new Date().toISOString(),
    storyTitle: story.title,
    characters: chars.map(c => ({
      // Âü∫Êú¨‰ø°ÊÅØ
      name: c.name,
      title: c.title || '',
      avatar: c.avatar || 'üë§',
      avatarImage: c.avatarImage || '',
      category: c.category || 'supporting',
      description: c.description || '',
      personality: c.personality || '',
      tags: c.tags || [],
      
      // Â∞çË©±Ë®≠ÁΩÆ
      first_mes: c.first_mes || '',
      scenario: c.scenario || '',
      mes_example: c.mes_example || '',
      alternate_greetings: c.alternate_greetings || [],
      
      // È´òÁ¥öË®≠ÁΩÆ
      system_prompt: c.system_prompt || '',
      post_history_instructions: c.post_history_instructions || '',
      creator_notes: c.creator_notes || '',
      creator: c.creator || '',
      character_version: c.character_version || '1.0',
      
      // ËßíËâ≤Â∞àÂ±¨ Lorebook
      character_book: c.character_book || null,
      
      // Â±¨ÊÄßÂíåÁãÄÊÖã
      stats: c.stats || {},
      initialStats: c.initialStats || null,
      initialState: c.initialState || null,
      
      // Èóú‰øÇÂíåË°®ÊÉÖ
      relationships: c.relationships || [],
      expressions: c.expressions || [],
      expressionMode: c.expressionMode || 'manual',
      
      // ÂÖ∂‰ªñ
      mood: c.mood || '',
      note: c.note || '',
      location: c.location || ''
    }))
  };
  
  const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `ËßíËâ≤Âç°_${story.title}_${new Date().toLocaleDateString()}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast(`Â∑≤Â∞éÂá∫ ${chars.length} ‰ΩçËßíËâ≤`,'success');
}

function importCharacterCard(){
  if(!story){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'),'warning');return;}
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json,.png'; // ÊîØÊåÅ JSON Âíå PNGÔºàSillyTavern Ê†ºÂºèÔºâ
  input.onchange = async e => {
    const file = e.target.files[0];
    if(!file) return;
    
    try {
      showLoading('Ê≠£Âú®Â∞éÂÖ•...');
      
      if(file.name.endsWith('.png')){
        // SillyTavern PNG Ê†ºÂºèÔºàËßíËâ≤Âç°ÂµåÂÖ•Âú® PNG ÂÖÉÊï∏Êìö‰∏≠Ôºâ
        await importSillyTavernPNG(file);
      } else {
        // JSON Ê†ºÂºè
        const text = await file.text();
        const data = JSON.parse(text);
        await importCharacterJSON(data);
      }
      
      hideLoading();
      renderCharacters();
    } catch(err) {
      hideLoading();
      console.error('Import error:', err);
      toast('Â∞éÂÖ•Â§±Êïó: ' + err.message, 'error');
    }
  };
  input.click();
}

async function importCharacterJSON(data){
  let imported = 0;
  
  // Ê™¢Ê∏¨Ê†ºÂºè
  if((data.format === 'zhimeng_characters_v1' || data.format === 'zhimeng_characters_v2') && data.characters){
    // ÁπîÂ§¢Ê†ºÂºèÔºàv1 Âíå v2Ôºâ
    for(const c of data.characters){
      await addImportedCharacter(c);
      imported++;
    }
  } else if(data.spec === 'chara_card_v2' || data.data){
    // SillyTavern/Character Card V2 Ê†ºÂºè
    const charData = data.data || data;
    
    // ÂÆåÊï¥ÊèêÂèñ V2 ÊâÄÊúâÂ≠óÊÆµ
    const charToImport = {
      name: charData.name || data.name || 'Êú™Áü•ËßíËâ≤',
      description: charData.description || data.description || '',
      personality: charData.personality || data.personality || '',
      tags: charData.tags || data.tags || [],
      avatar: 'üë§',
      
      // üÜï V2 Â≠óÊÆµ
      scenario: charData.scenario || '',
      first_mes: charData.first_mes || '',
      alternate_greetings: charData.alternate_greetings || [],
      mes_example: charData.mes_example || '',
      system_prompt: charData.system_prompt || '',
      post_history_instructions: charData.post_history_instructions || '',
      character_book: charData.character_book || null,
      creator_notes: charData.creator_notes || '',
      creator: charData.creator || '',
      character_version: charData.character_version || '1.0',
      
      // ÁπîÂ§¢Êì¥Â±ïÂ≠óÊÆµÔºàÂ¶ÇÊûúÊúâÔºâ
      ...(charData.extensions?.zhimeng || {})
    };
    
    const result = await addImportedCharacter(charToImport);
    if(result) imported = 1;
  } else if(data.name){
    // Á∞°ÂñÆÊ†ºÂºèÔºàÂñÆÂÄãËßíËâ≤Ôºâ
    const result = await addImportedCharacter(data);
    if(result) imported = 1;
  } else if(Array.isArray(data)){
    // ËßíËâ≤Êï∏ÁµÑ
    for(const c of data){
      if(c.name){
        const result = await addImportedCharacter(c);
        if(result) imported++;
      }
    }
  } else {
    throw new Error('ÁÑ°Ê≥ïË≠òÂà•ÁöÑËßíËâ≤Âç°Ê†ºÂºè');
  }
  
  if(imported > 0){
    toast(T(`Â∑≤Â∞éÂÖ• ${imported} ‰ΩçËßíËâ≤`),'success');
  } else {
    toast(T('Â∞éÂÖ•Â∑≤ÂèñÊ∂à'),'info');
  }
}

async function importSillyTavernPNG(file){
  // ËÆÄÂèñ PNG ‰∏≠ÂµåÂÖ•ÁöÑËßíËâ≤Êï∏Êìö
  // SillyTavern Â∞áËßíËâ≤Êï∏ÊìöÂ≠òÂú® PNG ÁöÑ tEXt chunk ‰∏≠
  const arrayBuffer = await file.arrayBuffer();
  const uint8Array = new Uint8Array(arrayBuffer);
  
  // Êü•Êâæ tEXt chunkÔºàÂåÖÂê´ "chara" ÈóúÈçµÂ≠óÔºâ
  const textDecoder = new TextDecoder('utf-8');
  let charaData = null;
  
  // Á∞°ÂåñËôïÁêÜÔºöÊêúÁ¥¢ "chara" ÈóúÈçµÂ≠óÂæåÁöÑ base64 Êï∏Êìö
  const str = textDecoder.decode(uint8Array);
  const charaMatch = str.match(/chara\x00([A-Za-z0-9+/=]+)/);
  
  if(charaMatch){
    try {
      const base64 = charaMatch[1];
      const jsonStr = atob(base64);
      charaData = JSON.parse(jsonStr);
    } catch(e){
      console.error('Failed to parse embedded data:', e);
    }
  }
  
  if(!charaData){
    // ÂòóË©¶‰ΩúÁÇ∫ÊôÆÈÄö JSON Â∞éÂÖ•ÔºàÁî®Êà∂ÂèØËÉΩÈÅ∏ÈåØ‰∫ÜÊñá‰ª∂Ôºâ
    throw new Error('ÁÑ°Ê≥ïÂæû PNG ‰∏≠ËÆÄÂèñËßíËâ≤Êï∏ÊìöÔºåË´ãÁ¢∫Ë™çÈÄôÊòØÊúâÊïàÁöÑËßíËâ≤Âç°ÂúñÁâá');
  }
  
  await importCharacterJSON(charaData);
}

async function addImportedCharacter(c, skipConflictCheck = false){
  // Ê™¢Êü•ÊòØÂê¶Â∑≤Â≠òÂú®ÂêåÂêçËßíËâ≤Ôºà‰∏çÂçÄÂàÜÂ§ßÂ∞èÂØ´ÔºåÂøΩÁï•ÂâçÂæåÁ©∫Ê†ºÔºâ
  const normalizedName = (c.name || '').trim().toLowerCase();
  const existing = await db.characters.where('storyId').equals(story.id).filter(x =>
    (x.name || '').trim().toLowerCase() === normalizedName
  ).first();

  // ËôïÁêÜÈáçÂêçË°ùÁ™Å
  let finalName = (c.name || 'Êú™Áü•ËßíËâ≤').trim();
  let useExistingId = false;

  if(existing && !skipConflictCheck){
    // È°ØÁ§∫Ë°ùÁ™ÅËôïÁêÜÈÅ∏È†Ö
    const action = await showImportConflictDialog(finalName);

    if(action === 'cancel'){
      return null; // ÂèñÊ∂àÂ∞éÂÖ•
    } else if(action === 'rename'){
      // Ëá™ÂãïÈáçÂëΩÂêç
      let suffix = 1;
      let newName = `${finalName}(${suffix})`;
      while(await db.characters.where('storyId').equals(story.id).filter(x =>
        (x.name || '').trim().toLowerCase() === newName.toLowerCase()
      ).first()){
        suffix++;
        newName = `${finalName}(${suffix})`;
      }
      finalName = newName;
    } else if(action === 'overwrite'){
      // Ë¶ÜËìãÁèæÊúâËßíËâ≤
      useExistingId = true;
    }
  }
  
  // Character Card V2 ÂÆåÊï¥Â≠óÊÆµÊîØÊåÅ
  const char = {
    // Âü∫Êú¨‰ø°ÊÅØ
    id: useExistingId ? existing.id : crypto.randomUUID(),
    storyId: story.id,
    name: finalName,
    title: c.title || '',
    avatar: c.avatar || 'üë§',
    avatarImage: c.avatarImage || c.avatar_image || '',
    description: c.description || '',
    personality: c.personality || '',
    tags: c.tags || [],
    
    // üÜï ÂàÜÈ°ûÁ≥ªÁµ±
    category: c.category || 'supporting', // protagonist/supporting/npc/custom
    
    // üÜï Èóú‰øÇÁ≥ªÁµ±
    relationships: c.relationships || c.relations || [],
    
    // üÜï Â∞çË©±Ë®≠ÁΩÆÔºàCharacter Card V2Ôºâ
    scenario: c.scenario || '',
    first_mes: c.first_mes || c.firstMessage || '',
    alternate_greetings: c.alternate_greetings || [],
    mes_example: c.mes_example || c.messageExample || '',
    
    // üÜï È´òÁ¥öË®≠ÁΩÆÔºàCharacter Card V2Ôºâ
    system_prompt: c.system_prompt || c.systemPrompt || '',
    post_history_instructions: c.post_history_instructions || c.postHistoryInstructions || '',
    
    // üÜï ËßíËâ≤Â∞àÂ±¨ Lorebook
    character_book: c.character_book || null,
    
    // üÜï Ë°®ÊÉÖÁ≥ªÁµ±
    expressions: c.expressions || [],
    expressionMode: c.expressionMode || 'manual', // manual/auto
    currentExpression: c.currentExpression || null,
    
    // üÜï Ââµ‰ΩúËÄÖ‰ø°ÊÅØ
    creator_notes: c.creator_notes || '',
    creator: c.creator || '',
    character_version: c.character_version || '1.0',
    
    // ÁèæÊúâÂ≠óÊÆµ
    stats: c.stats || {},
    initialStats: c.initialStats || null,
    initialState: c.initialState || null,
    mood: c.mood || '',
    note: c.note || '',
    location: c.location || '',
    
    // ÊôÇÈñìÊà≥
    createdAt: useExistingId ? existing.createdAt : Date.now(),
    updatedAt: Date.now()
  };
  
  await db.characters.put(char);
  return char;
}

// È°ØÁ§∫Â∞éÂÖ•Ë°ùÁ™ÅÂ∞çË©±Ê°Ü
function showImportConflictDialog(charName){
  return new Promise(resolve => {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000';
    modal.innerHTML = `
      <div class="modal" style="display:block;position:relative;transform:none;max-width:min(90%,360px)">
        <div class="modal-title">‚ö†Ô∏è ËßíËâ≤ÂêçÁ®±Ë°ùÁ™Å</div>
        <div style="padding:16px 0;text-align:center">
          <p style="margin-bottom:12px">ËßíËâ≤„Äå<strong>${esc(charName)}</strong>„ÄçÂ∑≤Â≠òÂú®</p>
          <p style="color:var(--text-secondary);font-size:14px">Ë´ãÈÅ∏ÊìáËôïÁêÜÊñπÂºèÔºö</p>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;padding:0 0 16px">
          <button class="modal-btn" onclick="this.closest('.modal-overlay').dataset.action='overwrite';this.closest('.modal-overlay').remove()" style="padding:12px">
            üîÑ Ë¶ÜËìãÁèæÊúâËßíËâ≤
          </button>
          <button class="modal-btn secondary" onclick="this.closest('.modal-overlay').dataset.action='rename';this.closest('.modal-overlay').remove()" style="padding:12px">
            üìù ÈáçÂëΩÂêçÁÇ∫„Äå${esc(charName)}(1)„Äç
          </button>
          <button class="modal-btn cancel" onclick="this.closest('.modal-overlay').dataset.action='cancel';this.closest('.modal-overlay').remove()" style="padding:12px">
            ‚ùå ÂèñÊ∂àÂ∞éÂÖ•
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);

    // Áõ£ËÅΩÁßªÈô§‰∫ã‰ª∂
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        mutation.removedNodes.forEach((node) => {
          if(node === modal){
            clearTimeout(timeoutId);  // Ê∏ÖÈô§Ë∂ÖÊôÇÂÆöÊôÇÂô®
            observer.disconnect();
            resolve(modal.dataset.action || 'cancel');
          }
        });
      });
    });
    observer.observe(document.body, {childList: true});

    // Ê∑ªÂä†Ë∂ÖÊôÇ‰øùË≠∑Ôºà30ÁßíÂæåËá™ÂãïÊ∏ÖÁêÜÔºâ
    const timeoutId = setTimeout(() => {
      observer.disconnect();
      if(modal.parentNode) {
        modal.remove();
      }
      console.warn('showImportConflictDialog: Ë∂ÖÊôÇËá™ÂãïÊ∏ÖÁêÜ');
      resolve('cancel');
    }, 30000);
  });
}

async function exportSingleCharacter(charId){
  const char = await db.characters.get(charId);
  if(!char){toast(T('ËßíËâ≤‰∏çÂ≠òÂú®'),'error');return;}
  
  // ÂÆåÊï¥ÁöÑ Character Card V2 Ê†ºÂºèÂ∞éÂá∫
  const exportData = {
    spec: 'chara_card_v2',
    spec_version: '2.0',
    data: {
      // Âü∫Êú¨‰ø°ÊÅØ
      name: char.name,
      description: char.description || '',
      personality: char.personality || '',
      tags: char.tags || [],
      
      // üÜï Â∞çË©±Ë®≠ÁΩÆÔºàÂ∞éÂá∫ÂØ¶ÈöõÊï∏ÊìöÔºâ
      scenario: char.scenario || '',
      first_mes: char.first_mes || '',
      alternate_greetings: char.alternate_greetings || [],
      mes_example: char.mes_example || '',
      
      // üÜï È´òÁ¥öË®≠ÁΩÆÔºàÂ∞éÂá∫ÂØ¶ÈöõÊï∏ÊìöÔºâ
      system_prompt: char.system_prompt || '',
      post_history_instructions: char.post_history_instructions || '',
      
      // üÜï ËßíËâ≤Â∞àÂ±¨ Lorebook
      character_book: char.character_book || null,
      
      // Ââµ‰ΩúËÄÖ‰ø°ÊÅØ
      creator_notes: char.creator_notes || `ÂæûÁπîÂ§¢Â∞éÂá∫ - ${story?.title || ''}`,
      creator: char.creator || 'ÁπîÂ§¢',
      character_version: char.character_version || '1.0',
      
      // ÁπîÂ§¢Êì¥Â±ïÂ≠óÊÆµ
      extensions: {
        zhimeng: {
          title: char.title || '',
          avatar: char.avatar || 'üë§',
          avatarImage: char.avatarImage || '',
          category: char.category || 'supporting',
          relationships: char.relationships || [],
          expressions: char.expressions || [],
          expressionMode: char.expressionMode || 'manual',
          stats: char.stats || {},
          initialStats: char.initialStats || null,
          initialState: char.initialState || null,
          mood: char.mood || '',
          note: char.note || '',
          location: char.location || ''
        }
      }
    }
  };
  
  const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${char.name}_ËßíËâ≤Âç°.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast(`Â∑≤Â∞éÂá∫ËßíËâ≤„Äå${char.name}„Äç`,'success');
}

// üÜï PNG ËßíËâ≤Âç°Â∞éÂá∫
async function exportCharacterAsPNG(charId){
  const char = await db.characters.get(charId);
  if(!char){toast(T('ËßíËâ≤‰∏çÂ≠òÂú®'),'error');return;}
  
  showLoading(T('Ê≠£Âú®ÁîüÊàê PNG ËßíËâ≤Âç°...'));
  
  try {
    // Ê∫ñÂÇôËßíËâ≤Êï∏Êìö
    const charData = {
      spec: 'chara_card_v2',
      spec_version: '2.0',
      data: {
        name: char.name,
        description: char.description || '',
        personality: char.personality || '',
        tags: char.tags || [],
        scenario: char.scenario || '',
        first_mes: char.first_mes || '',
        alternate_greetings: char.alternate_greetings || [],
        mes_example: char.mes_example || '',
        system_prompt: char.system_prompt || '',
        post_history_instructions: char.post_history_instructions || '',
        character_book: char.character_book || null,
        creator_notes: char.creator_notes || `ÂæûÁπîÂ§¢Â∞éÂá∫`,
        creator: char.creator || 'ÁπîÂ§¢',
        character_version: char.character_version || '1.0',
        extensions: {
          zhimeng: {
            title: char.title,
            avatar: char.avatar,
            category: char.category,
            relationships: char.relationships,
            expressions: char.expressions,
            expressionMode: char.expressionMode,
            stats: char.stats,
            initialStats: char.initialStats || null,
            initialState: char.initialState || null
          }
        }
      }
    };
    
    // Â∞áÊï∏ÊìöÁ∑®Á¢ºÁÇ∫ base64
    const jsonStr = JSON.stringify(charData);
    const base64Data = btoa(unescape(encodeURIComponent(jsonStr)));
    
    // ÂâµÂª∫ canvas
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // Â¶ÇÊûúÊúâÈ†≠ÂÉèÂúñÁâáÔºå‰ΩøÁî®ÂÆÉÔºõÂê¶ÂâáÁîüÊàêÈªòË™çÂúñÁâá
    if(char.avatarImage && char.avatarImage.startsWith('data:image')){
      // ‰ΩøÁî®ËßíËâ≤È†≠ÂÉè
      const img = new Image();
      img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        
        // Â∞éÂá∫Â∏∂ÂÖÉÊï∏ÊìöÁöÑ PNG
        exportPNGWithMetadata(canvas, base64Data, char.name);
      };
      img.onerror = () => {
        // È†≠ÂÉèÂä†ËºâÂ§±ÊïóÔºå‰ΩøÁî®ÈªòË™çÂúñÁâá
        generateDefaultCharacterPNG(canvas, ctx, char, base64Data);
      };
      img.src = char.avatarImage;
    } else {
      // ÁîüÊàêÈªòË™çËßíËâ≤Âç°ÂúñÁâá
      generateDefaultCharacterPNG(canvas, ctx, char, base64Data);
    }
  } catch(err) {
    hideLoading();
    console.error('PNG export error:', err);
    toast(T('PNG Â∞éÂá∫Â§±Êïó: ') + err.message, 'error');
  }
}

// ÁîüÊàêÈªòË™çËßíËâ≤Âç°ÂúñÁâá
function generateDefaultCharacterPNG(canvas, ctx, char, base64Data){
  canvas.width = 400;
  canvas.height = 600;
  
  // ËÉåÊôØÊº∏ËÆä
  const gradient = ctx.createLinearGradient(0, 0, 0, 600);
  gradient.addColorStop(0, '#1a1a2e');
  gradient.addColorStop(1, '#16213e');
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, 400, 600);
  
  // Ë£ùÈ£æÈÇäÊ°Ü
  ctx.strokeStyle = '#8b7cf7';
  ctx.lineWidth = 4;
  ctx.strokeRect(10, 10, 380, 580);
  
  // È†≠ÂÉèÂçÄÂüüÔºà‰ΩøÁî® emojiÔºâ
  ctx.fillStyle = '#252540';
  ctx.beginPath();
  ctx.arc(200, 150, 80, 0, Math.PI * 2);
  ctx.fill();
  
  ctx.font = '72px sans-serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(char.avatar || 'üë§', 200, 150);
  
  // ËßíËâ≤Âêç
  ctx.fillStyle = '#e5e7eb';
  ctx.font = 'bold 32px sans-serif';
  ctx.fillText(char.name, 200, 280);
  
  // È†≠Èäú
  if(char.title){
    ctx.fillStyle = '#9ca3af';
    ctx.font = '18px sans-serif';
    ctx.fillText(char.title, 200, 320);
  }
  
  // ÂàÜÈöîÁ∑ö
  ctx.strokeStyle = '#8b7cf7';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(50, 360);
  ctx.lineTo(350, 360);
  ctx.stroke();
  
  // ÊèèËø∞ÔºàÊà™ÂèñÂâç100Â≠óÔºâ
  const desc = (char.description || '').slice(0, 100);
  if(desc){
    ctx.fillStyle = '#9ca3af';
    ctx.font = '14px sans-serif';
    ctx.textAlign = 'left';
    
    // Ëá™ÂãïÊèõË°å
    const words = desc.split('');
    let line = '';
    let y = 400;
    const maxWidth = 320;
    
    for(let i = 0; i < words.length && y < 560; i++){
      const testLine = line + words[i];
      const metrics = ctx.measureText(testLine);
      if(metrics.width > maxWidth){
        ctx.fillText(line, 40, y);
        line = words[i];
        y += 24;
      } else {
        line = testLine;
      }
    }
    if(line && y < 560){
      ctx.fillText(line + (desc.length > 100 ? '...' : ''), 40, y);
    }
  }
  
  // Â∫ïÈÉ®Ê®ôË≠ò
  ctx.fillStyle = '#6b7280';
  ctx.font = '12px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('ÁπîÂ§¢ Character Card V2', 200, 580);
  
  // Â∞éÂá∫
  exportPNGWithMetadata(canvas, base64Data, char.name);
}

// Â∞áÂÖÉÊï∏ÊìöÂµåÂÖ• PNG ‰∏¶Â∞éÂá∫
function exportPNGWithMetadata(canvas, base64Data, charName){
  // Áç≤Âèñ PNG Êï∏Êìö
  canvas.toBlob(async blob => {
    try {
      const arrayBuffer = await blob.arrayBuffer();
      const uint8Array = new Uint8Array(arrayBuffer);
      
      // ÂâµÂª∫ tEXt chunk
      // tEXt chunk Ê†ºÂºèÔºöÈï∑Â∫¶(4Â≠óÁØÄ) + "tEXt"(4Â≠óÁØÄ) + ÈóúÈçµÂ≠ó + null + Êï∏Êìö + CRC(4Â≠óÁØÄ)
      const keyword = 'chara';
      const keywordBytes = new TextEncoder().encode(keyword);
      const dataBytes = new TextEncoder().encode(base64Data);
      
      // chunk ÂÖßÂÆπ = ÈóúÈçµÂ≠ó + nullÂàÜÈöîÁ¨¶ + Êï∏Êìö
      const chunkContent = new Uint8Array(keywordBytes.length + 1 + dataBytes.length);
      chunkContent.set(keywordBytes, 0);
      chunkContent[keywordBytes.length] = 0; // null ÂàÜÈöîÁ¨¶
      chunkContent.set(dataBytes, keywordBytes.length + 1);
      
      // Ë®àÁÆó CRC32
      const typeAndData = new Uint8Array(4 + chunkContent.length);
      typeAndData.set(new TextEncoder().encode('tEXt'), 0);
      typeAndData.set(chunkContent, 4);
      const crc = crc32(typeAndData);
      
      // ÊßãÂª∫ÂÆåÊï¥ÁöÑ tEXt chunk
      const chunkLength = chunkContent.length;
      const textChunk = new Uint8Array(4 + 4 + chunkContent.length + 4);
      // Èï∑Â∫¶ÔºàÂ§ßÁ´ØÂ∫èÔºâ
      textChunk[0] = (chunkLength >> 24) & 0xff;
      textChunk[1] = (chunkLength >> 16) & 0xff;
      textChunk[2] = (chunkLength >> 8) & 0xff;
      textChunk[3] = chunkLength & 0xff;
      // È°ûÂûã
      textChunk.set(new TextEncoder().encode('tEXt'), 4);
      // ÂÖßÂÆπ
      textChunk.set(chunkContent, 8);
      // CRC
      textChunk[textChunk.length - 4] = (crc >> 24) & 0xff;
      textChunk[textChunk.length - 3] = (crc >> 16) & 0xff;
      textChunk[textChunk.length - 2] = (crc >> 8) & 0xff;
      textChunk[textChunk.length - 1] = crc & 0xff;
      
      // ÊâæÂà∞ IEND chunk ÁöÑ‰ΩçÁΩÆÔºàPNG ÁµêÂ∞æÔºâ
      // IEND Ê®ôË≠òÊòØ "IEND" ÂâçÈù¢4Â≠óÁØÄÊòØÈï∑Â∫¶(0)
      let iendPos = uint8Array.length - 12;
      for(let i = uint8Array.length - 12; i >= 8; i--){
        if(uint8Array[i] === 0x49 && uint8Array[i+1] === 0x45 && 
           uint8Array[i+2] === 0x4E && uint8Array[i+3] === 0x44){
          iendPos = i - 4; // IEND chunk ÈñãÂßã‰ΩçÁΩÆÔºàÂê´Èï∑Â∫¶Â≠óÁØÄÔºâ
          break;
        }
      }
      
      // ÊßãÂª∫Êñ∞ÁöÑ PNG Êñá‰ª∂
      const newPng = new Uint8Array(uint8Array.length + textChunk.length);
      newPng.set(uint8Array.slice(0, iendPos), 0);
      newPng.set(textChunk, iendPos);
      newPng.set(uint8Array.slice(iendPos), iendPos + textChunk.length);
      
      // ‰∏ãËºâ
      const finalBlob = new Blob([newPng], {type: 'image/png'});
      const url = URL.createObjectURL(finalBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${charName}_ËßíËâ≤Âç°.png`;
      a.click();
      URL.revokeObjectURL(url);
      
      hideLoading();
      toast(T(`Â∑≤Â∞éÂá∫ PNG ËßíËâ≤Âç°„Äå${charName}„Äç`), 'success');
    } catch(err){
      hideLoading();
      console.error('PNG metadata error:', err);
      toast(T('PNG ÂÖÉÊï∏ÊìöÂØ´ÂÖ•Â§±Êïó'), 'error');
    }
  }, 'image/png');
}

// CRC32 Ë®àÁÆóÔºàÁî®Êñº PNG chunkÔºâ
function crc32(data){
  let crc = 0xffffffff;
  const table = crc32Table();
  for(let i = 0; i < data.length; i++){
    crc = (crc >>> 8) ^ table[(crc ^ data[i]) & 0xff];
  }
  return (crc ^ 0xffffffff) >>> 0;
}

function crc32Table(){
  const table = new Uint32Array(256);
  for(let i = 0; i < 256; i++){
    let c = i;
    for(let j = 0; j < 8; j++){
      c = (c & 1) ? (0xedb88320 ^ (c >>> 1)) : (c >>> 1);
    }
    table[i] = c;
  }
  return table;
}

// üÜï Âæû URL Â∞éÂÖ•ËßíËâ≤Âç°
async function importCharacterFromURL(){
  if(!story){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'),'warning');return;}
  
  // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
  const input = document.getElementById('char-url-input');
  if(input) input.value = '';
  
  showModal('char-url-import-modal');
}

// ÊâßË°åURLÂØºÂÖ•
async function doImportFromURL(){
  const input = document.getElementById('char-url-input');
  const url = input?.value?.trim();
  
  if(!url){
    toast(T('Ë´ãËº∏ÂÖ• URL'),'warning');
    return;
  }
  
  closeModal('char-url-import-modal');
  showLoading(T('Ê≠£Âú®Âæû URL Â∞éÂÖ•...'));
  
  try {
    let charData = null;
    
    // Ê™¢Ê∏¨ URL È°ûÂûã
    if(url.includes('chub.ai') || url.includes('characterhub.org')){
      // Chub.ai / CharacterHub Âπ≥Âè∞
      charData = await importFromChub(url);
    } else if(url.endsWith('.json')){
      // Áõ¥Êé• JSON Êñá‰ª∂
      const response = await fetch(url);
      if(!response.ok) throw new Error('ÁÑ°Ê≥ïÁç≤ÂèñÊñá‰ª∂');
      charData = await response.json();
    } else if(url.endsWith('.png')){
      // Áõ¥Êé• PNG Êñá‰ª∂
      const response = await fetch(url);
      if(!response.ok) throw new Error('ÁÑ°Ê≥ïÁç≤ÂèñÊñá‰ª∂');
      const blob = await response.blob();
      const file = new File([blob], 'character.png', {type: 'image/png'});
      await importSillyTavernPNG(file);
      hideLoading();
      renderCharacters();
      return;
    } else {
      // ÂòóË©¶‰ΩúÁÇ∫ JSON Áç≤Âèñ
      const response = await fetch(url);
      if(!response.ok) throw new Error('ÁÑ°Ê≥ïÁç≤ÂèñÊñá‰ª∂');
      const text = await response.text();
      try {
        charData = JSON.parse(text);
      } catch(e){
        throw new Error('ÁÑ°Ê≥ïËß£ÊûêÁÇ∫ JSON Ê†ºÂºè');
      }
    }
    
    if(charData){
      await importCharacterJSON(charData);
    }
    
    hideLoading();
    renderCharacters();
  } catch(err){
    hideLoading();
    console.error('URL import error:', err);
    toast(T('Âæû URL Â∞éÂÖ•Â§±Êïó: ') + err.message, 'error');
  }
}

// Âæû Chub.ai / CharacterHub Â∞éÂÖ•
async function importFromChub(url){
  // ÊèêÂèñËßíËâ≤ ID
  // Chub.ai URL Ê†ºÂºè: https://chub.ai/characters/username/character-name
  // CharacterHub URL Ê†ºÂºè: https://www.characterhub.org/characters/username/character-name
  
  let apiUrl = '';
  
  if(url.includes('chub.ai')){
    // Chub.ai API
    const match = url.match(/chub\.ai\/characters\/([^\/]+\/[^\/\?]+)/);
    if(!match) throw new Error('ÁÑ°Ê≥ïËß£Êûê Chub.ai URL');
    const charPath = match[1];
    apiUrl = `https://api.chub.ai/api/characters/${charPath}?full=true`;
  } else if(url.includes('characterhub.org')){
    // CharacterHub - ÂòóË©¶Áç≤Âèñ JSON
    const match = url.match(/characterhub\.org\/characters\/([^\/]+\/[^\/\?]+)/);
    if(!match) throw new Error('ÁÑ°Ê≥ïËß£Êûê CharacterHub URL');
    const charPath = match[1];
    // CharacterHub ÂèØËÉΩÊúâ‰∏çÂêåÁöÑ API ÁµêÊßãÔºåÈÄôË£°ÂòóË©¶Â∏∏Ë¶ãÊ†ºÂºè
    apiUrl = `https://www.characterhub.org/api/v1/characters/${charPath}`;
  }
  
  if(!apiUrl){
    throw new Error('‰∏çÊîØÊåÅÁöÑÂπ≥Âè∞ URL');
  }
  
  try {
    const response = await fetch(apiUrl, {
      headers: {
        'Accept': 'application/json'
      }
    });
    
    if(!response.ok){
      // Â¶ÇÊûú API Â§±ÊïóÔºåÂòóË©¶Áõ¥Êé•Áç≤ÂèñÈ†ÅÈù¢‰∏¶ÊèêÂèñÊï∏Êìö
      throw new Error('API Ë´ãÊ±ÇÂ§±ÊïóÔºåÂèØËÉΩÈúÄË¶ÅÁôªÈåÑÊàñË©≤Âπ≥Âè∞‰∏çÊîØÊåÅÂÖ¨Èñã API');
    }
    
    const data = await response.json();
    
    // ËΩâÊèõÁÇ∫ Character Card V2 Ê†ºÂºè
    if(data.node || data.fullPath){
      // Chub.ai Ê†ºÂºè
      const node = data.node || data;
      return {
        spec: 'chara_card_v2',
        data: {
          name: node.name || data.name,
          description: node.description || data.description || '',
          personality: node.personality || '',
          scenario: node.scenario || '',
          first_mes: node.first_mes || node.greeting || '',
          mes_example: node.mes_example || node.example_dialogs || '',
          system_prompt: node.system_prompt || '',
          post_history_instructions: node.post_history_instructions || '',
          alternate_greetings: node.alternate_greetings || [],
          tags: node.topics || node.tags || [],
          creator: node.creator?.username || node.fullPath?.split('/')[0] || '',
          character_version: node.version || '1.0'
        }
      };
    }
    
    // Â¶ÇÊûúÂ∑≤Á∂ìÊòØÊ®ôÊ∫ñÊ†ºÂºèÔºåÁõ¥Êé•ËøîÂõû
    return data;
  } catch(err){
    console.error('Chub import error:', err);
    throw new Error('ÂæûÂπ≥Âè∞Â∞éÂÖ•Â§±Êïó: ' + err.message + '\n\nÊèêÁ§∫ÔºöÊüê‰∫õÂπ≥Âè∞ÂèØËÉΩÈúÄË¶ÅÁôªÈåÑÊâçËÉΩË®™ÂïèËßíËâ≤Êï∏Êìö„ÄÇÊÇ®ÂèØ‰ª•ÂòóË©¶Ôºö\n1. Âú®Âπ≥Âè∞‰∏ä‰∏ãËºâËßíËâ≤Âç°Êñá‰ª∂\n2. ‰ΩøÁî®„ÄåÂ∞éÂÖ•ËßíËâ≤Âç°ÔºàÊñá‰ª∂Ôºâ„ÄçÂäüËÉΩÂ∞éÂÖ•');
  }
}

async function clearAllCharacters(){
  if(!story){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'),'warning');return;}
  if(!confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâËßíËâ≤ÂóéÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Âæ©ÔºÅ')) return;

  // Âà™Èô§ÊâÄÊúâËßíËâ≤
  await db.characters.where('storyId').equals(story.id).delete();
  // Âà™Èô§ÊâÄÊúâËßíËâ≤Ê≠∑Âè≤Ë®òÈåÑ
  await db.characterHistory.where('storyId').equals(story.id).delete();
  // Âà™Èô§ÊâÄÊúâËßíËâ≤Âø´ÁÖß
  await db.characterSnapshots.where('storyId').equals(story.id).delete();
  // Âà™Èô§ÊâÄÊúâËßíËâ≤ÁãÄÊÖã
  await db.characterStates.where('storyId').equals(story.id).delete();
  renderCharacters();
  toast(T('Â∑≤Ê∏ÖÁ©∫ÊâÄÊúâËßíËâ≤'),'success');
}

function exportCurrentCharacter(){
  showCharExportOptions();
}

function showCharExportOptions(){
  if(!currentCharacterId){
    toast(T('Ë´ãÂÖàÈÅ∏ÊìáËßíËâ≤'),'warning');
    return;
  }
  showModal('char-export-modal');
}

function exportCurrentCharacterJSON(){
  closeModal('char-export-modal');
  if(currentCharacterId){
    exportSingleCharacter(currentCharacterId);
  }
}

function exportCurrentCharacterPNG(){
  closeModal('char-export-modal');
  if(currentCharacterId){
    exportCharacterAsPNG(currentCharacterId);
  }
}

// ============ ËÉåÂåÖÁ≥ªÁµ± ============
let editInventoryItemId = null;
let selectedInventoryIcon = 'üì¶';

// Ê∏≤ÊüìËÉåÂåÖÂàóË°®
async function renderInventory(){
  if(!story) return;
  const container = document.getElementById('inventory-list');
  const inventory = story.inventory || [];
  
  if(!inventory.length){
    container.innerHTML = `<div class="empty" style="padding:40px 20px">
      <div class="empty-icon">üéí</div>
      <div class="empty-title">ËÉåÂåÖÊòØÁ©∫ÁöÑ</div>
      <div class="empty-desc">ÈªûÊìäÂè≥‰∏äËßí ‚ûï ÊâãÂãïÊ∑ªÂä†Áâ©ÂìÅÔºåÊàñÈªûÊìä ü§ñ ËÆì AI ÂæûÂ∞çË©±‰∏≠Êô∫ËÉΩË≠òÂà•</div>
    </div>`;
    return;
  }
  
  const searchTerm = (document.getElementById('inventory-search')?.value || '').toLowerCase();
  const categoryFilter = document.getElementById('inventory-filter')?.value || 'all';
  
  const filtered = inventory.filter(item => {
    const matchSearch = !searchTerm || 
      item.name.toLowerCase().includes(searchTerm) || 
      (item.description || '').toLowerCase().includes(searchTerm);
    const matchCategory = categoryFilter === 'all' || item.category === categoryFilter;
    return matchSearch && matchCategory;
  });
  
  if(!filtered.length){
    container.innerHTML = `<div class="empty" style="padding:40px 20px">
      <div class="empty-icon">üîç</div>
      <div class="empty-title">Ê≤íÊúâÂåπÈÖçÁöÑÁâ©ÂìÅ</div>
    </div>`;
    return;
  }
  
  const categoryNames = {
    weapon: '‚öîÔ∏è Ê≠¶Âô®', armor: 'üõ°Ô∏è Èò≤ÂÖ∑', consumable: 'üß™ Ê∂àËÄóÂìÅ',
    material: 'üì¶ ÊùêÊñô', key: 'üîë ÈóúÈçµÁâ©ÂìÅ', other: 'üìã ÂÖ∂‰ªñ'
  };
  
  container.innerHTML = filtered.map(item => {
    const hasLorebook = item.lorebookId ? 'has-lorebook' : '';
    return `<div class="inventory-item ${hasLorebook}" data-id="${item.id}">
      <div class="inventory-item-icon">${esc(item.icon || 'üì¶')}</div>
      <div class="inventory-item-info">
        <div class="inventory-item-name">
          ${esc(item.name)}
          ${item.quantity > 1 ? `<span class="quantity">√ó${item.quantity}</span>` : ''}
        </div>
        <div class="inventory-item-category">${categoryNames[item.category] || 'üìã ÂÖ∂‰ªñ'}${item.lorebookId ? ' ¬∑ üîÆ Â∑≤ÈÄ£ÁµêLorebook' : ''}</div>
        ${item.description ? `<div class="inventory-item-desc">${esc(item.description)}</div>` : ''}
      </div>
      <div class="inventory-item-actions">
        <button class="inventory-item-btn" onclick="editInventoryItem('${item.id}')">‚úèÔ∏è</button>
        <button class="inventory-item-btn danger" onclick="deleteInventoryItem('${item.id}')">üóëÔ∏è</button>
      </div>
    </div>`;
  }).join('');
}

// ËøáÊª§ËÉåÂåÖ
function filterInventory(){
  renderInventory();
}

// ÈÄâÊã©ÂõæÊ†á
function selectInventoryIcon(icon){
  selectedInventoryIcon = icon;
  document.getElementById('inventory-item-icon').value = icon;
  document.querySelectorAll('#inventory-icon-picker .icon-option').forEach(el => {
    el.classList.toggle('selected', el.textContent === icon);
  });
}

// Ê∑ªÂä†Áâ©ÂìÅ
function addInventoryItem(){
  editInventoryItemId = null;
  selectedInventoryIcon = 'üì¶';
  document.getElementById('inventory-modal-title').textContent = '‚ûï Ê∑ªÂä†Áâ©ÂìÅ';
  document.getElementById('inventory-item-icon').value = '';
  document.getElementById('inventory-item-name').value = '';
  document.getElementById('inventory-item-quantity').value = '1';
  document.getElementById('inventory-item-category').value = 'other';
  document.getElementById('inventory-item-desc').value = '';
  document.getElementById('inventory-item-lorebook').checked = true;
  document.querySelectorAll('#inventory-icon-picker .icon-option').forEach(el => el.classList.remove('selected'));
  showModal('inventory-item-modal');
}

// ÁºñËæëÁâ©ÂìÅ
function editInventoryItem(id){
  const inventory = story.inventory || [];
  const item = inventory.find(i => i.id === id);
  if(!item) return;
  
  editInventoryItemId = id;
  selectedInventoryIcon = item.icon || 'üì¶';
  document.getElementById('inventory-modal-title').textContent = '‚úèÔ∏è Á∑®ËºØÁâ©ÂìÅ';
  document.getElementById('inventory-item-icon').value = item.icon || '';
  document.getElementById('inventory-item-name').value = item.name;
  document.getElementById('inventory-item-quantity').value = item.quantity || 1;
  document.getElementById('inventory-item-category').value = item.category || 'other';
  document.getElementById('inventory-item-desc').value = item.description || '';
  document.getElementById('inventory-item-lorebook').checked = !!item.lorebookId;
  
  document.querySelectorAll('#inventory-icon-picker .icon-option').forEach(el => {
    el.classList.toggle('selected', el.textContent === selectedInventoryIcon);
  });
  showModal('inventory-item-modal');
}

// ‰øùÂ≠òÁâ©ÂìÅ
async function saveInventoryItem(){
  const name = document.getElementById('inventory-item-name').value.trim();
  if(!name){
    toast(T('Ë´ãËº∏ÂÖ•Áâ©ÂìÅÂêçÁ®±'),'warning');
    return;
  }
  
  const icon = document.getElementById('inventory-item-icon').value.trim() || selectedInventoryIcon || 'üì¶';
  const quantity = parseInt(document.getElementById('inventory-item-quantity').value) || 1;
  const category = document.getElementById('inventory-item-category').value;
  const description = document.getElementById('inventory-item-desc').value.trim();
  const syncLorebook = document.getElementById('inventory-item-lorebook').checked;
  
  let inventory = story.inventory || [];
  let item;
  
  if(editInventoryItemId){
    // ÁºñËæëÁé∞ÊúâÁâ©ÂìÅ
    const idx = inventory.findIndex(i => i.id === editInventoryItemId);
    if(idx >= 0){
      item = inventory[idx];
      item.name = name;
      item.icon = icon;
      item.quantity = quantity;
      item.category = category;
      item.description = description;
      item.updatedAt = Date.now();
    }
  } else {
    // Ê∑ªÂä†Êñ∞Áâ©ÂìÅ
    item = {
      id: crypto.randomUUID(),
      name,
      icon,
      quantity,
      category,
      description,
      createdAt: Date.now()
    };
    inventory.push(item);
  }
  
  // ÂêåÊ≠•Âà∞Lorebook
  if(syncLorebook && item){
    await syncInventoryToLorebook(item);
  } else if(!syncLorebook && item && item.lorebookId){
    // ÂèñÊ∂àÂêåÊ≠•ÔºåÂà†Èô§LorebookÊù°ÁõÆ
    await db.lorebook.delete(item.lorebookId);
    item.lorebookId = null;
  }
  
  story.inventory = inventory;
  await db.stories.update(story.id, { inventory });
  
  closeModal('inventory-item-modal');
  renderInventory();
  toast(editInventoryItemId ? 'Áâ©ÂìÅÂ∑≤Êõ¥Êñ∞' : 'Áâ©ÂìÅÂ∑≤Ê∑ªÂä†', 'success');
}

// ÂêåÊ≠•Âà∞Lorebook
async function syncInventoryToLorebook(item){
  const categoryNames = {
    weapon: 'Ê≠¶Âô®', armor: 'Èò≤ÂÖ∑', consumable: 'Ê∂àËÄóÂìÅ',
    material: 'ÊùêÊñô', key: 'ÈóúÈçµÁâ©ÂìÅ', other: 'Áâ©ÂìÅ'
  };
  
  const content = `„Äê${categoryNames[item.category] || 'Áâ©ÂìÅ'}„Äë${item.name}
${item.description || 'Áé©ÂÆ∂ËÉåÂåÖ‰∏≠ÁöÑÁâ©ÂìÅ„ÄÇ'}`;
  
  if(item.lorebookId){
    // Êõ¥Êñ∞Áé∞ÊúâLorebook
    await db.lorebook.update(item.lorebookId, {
      name: `üéí ${item.name}`,
      keywords: [item.name],
      content,
      updatedAt: Date.now()
    });
  } else {
    // ÂàõÂª∫Êñ∞Lorebook
    const lorebookId = crypto.randomUUID();
    await db.lorebook.put({
      id: lorebookId,
      storyId: story.id,
      name: `üéí ${item.name}`,
      keywords: [item.name],
      content,
      isEnabled: true,
      priority: 5,
      insertPosition: 'before',
      createdAt: Date.now()
    });
    item.lorebookId = lorebookId;
  }
}

// Âà†Èô§Áâ©ÂìÅ
async function deleteInventoryItem(id){
  showConfirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãÁâ©ÂìÅÂóéÔºü', async () => {
    let inventory = story.inventory || [];
    const item = inventory.find(i => i.id === id);
    
    // Âà†Èô§ÂÖ≥ËÅîÁöÑLorebook
    if(item && item.lorebookId){
      await db.lorebook.delete(item.lorebookId);
    }
    
    inventory = inventory.filter(i => i.id !== id);
    story.inventory = inventory;
    await db.stories.update(story.id, { inventory });
    
    renderInventory();
    toast(T('Áâ©ÂìÅÂ∑≤Âà™Èô§'), 'success');
  });
}

// AIÊô∫ËÉΩÂêåÊ≠•ËÉåÂåÖ
async function aiSyncInventory(){
  if(!story) return;
  
  const preset = await db.apiPresets.filter(p => p.isActive).first();
  if(!preset || !preset.apiKey){
    toast(T('Ë´ãÂÖàÈÖçÁΩÆ API'), 'warning');
    return;
  }
  
  if(msgs.length < 2){
    toast(T('Â∞çË©±Ë®òÈåÑÂ§™Â∞ëÔºåÁÑ°Ê≥ïÂàÜÊûê'), 'info');
    return;
  }
  
  showLoading('AI Ê≠£Âú®ÂàÜÊûêÂ∞çË©±‰∏≠ÁöÑÁâ©ÂìÅ...');
  
  try {
    // Ëé∑ÂèñÊúÄËøëÁöÑÂØπËØùÂÜÖÂÆπ
    const recentMsgs = msgs.slice(-20);
    const dialogContent = recentMsgs.map(m => {
      const role = m.role === 'user' ? '„ÄêÁé©ÂÆ∂„Äë' : '„ÄêÂäáÊÉÖ„Äë';
      return `${role} ${m.content.slice(0, 500)}`;
    }).join('\n\n');
    
    const existingItems = (story.inventory || []).map(i => i.name).join('„ÄÅ') || 'ÁÑ°';
    
    const prompt = `‰Ω†ÊòØ‰∏ÄÂÄãÂ∞àÊ•≠ÁöÑÁâ©ÂìÅË≠òÂà•Âä©Êâã„ÄÇË´ã‰ªîÁ¥∞ÂàÜÊûê‰ª•‰∏ãÂ∞çË©±ÂÖßÂÆπÔºåË≠òÂà•Áé©ÂÆ∂Áç≤Âæó„ÄÅ‰ΩøÁî®ÊàñÂ§±ÂéªÁöÑÁâ©ÂìÅ„ÄÇ

ÁèæÊúâËÉåÂåÖÁâ©ÂìÅÔºö${existingItems}

Â∞çË©±ÂÖßÂÆπÔºö
${dialogContent}

Ë´ã‰ª• JSON Ê†ºÂºèËøîÂõûÁâ©ÂìÅËÆäÂåñ„ÄÇ‰Ω†ÂøÖÈ†àËøîÂõûÂÆåÊï¥ÁöÑ JSON Ê†ºÂºèÔºå‰∏çÂèØ‰∏≠ÈÄîÂÅúÊ≠¢„ÄÇ

Ê†ºÂºèË¶ÅÊ±ÇÔºö
{
  "items": [
    {
      "action": "add" Êàñ "remove" Êàñ "update",
      "name": "Áâ©ÂìÅÂêçÁ®±",
      "icon": "ÈÅ©ÂêàÁöÑemojiÔºàÂ¶ÇÔºö‚öîÔ∏èüõ°Ô∏èüíäüìúüîëüì¶Ôºâ",
      "quantity": Êï∏ÈáèÔºàÊï∏Â≠óÔºâ,
      "category": "weapon/armor/consumable/material/key/other",
      "description": "Á∞°Áü≠ÊèèËø∞Ôºà20Â≠ó‰ª•ÂÖßÔºâ"
    }
  ]
}

ÈáçË¶ÅË¶èÂâáÔºö
1. Âè™ËøîÂõûÁ¢∫ÂØ¶Âú®Â∞çË©±‰∏≠ÊòéÁ¢∫ÊèêÂà∞Áç≤Âæó/‰ΩøÁî®/Â§±ÂéªÁöÑÁâ©ÂìÅ
2. ‰∏çË¶ÅÈáçË§áÊ∑ªÂä†Â∑≤ÊúâÁâ©ÂìÅÔºàÈô§ÈùûÊï∏ÈáèËÆäÂåñÔºâ
3. Â¶ÇÊûúÊ≤íÊúâÁâ©ÂìÅËÆäÂåñÔºåËøîÂõû {"items":[]}
4. ÂøÖÈ†àËøîÂõûÂÆåÊï¥ÁöÑ JSONÔºåÁ¢∫‰øùÊ†ºÂºèÊ≠£Á¢∫
5. ‰∏çË¶ÅÊ∑ªÂä†‰ªª‰ΩïÂÖ∂‰ªñÊñáÂ≠óË™™ÊòéÔºåÂè™ËøîÂõû JSON

ÁèæÂú®ÈñãÂßãÂàÜÊûê‰∏¶ËøîÂõûÂÆåÊï¥ÁöÑ JSONÔºö`;

    let result;
    if(preset.type === 'anthropic'){
      const r = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': preset.apiKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: preset.model || 'claude-sonnet-4-20250514',
          max_tokens: 8000,  // Ë™øÊï¥ÁÇ∫ 8000ÔºàClaude ÂèØÁî®ÔºåGemini ÂèØËÉΩÈúÄË¶ÅÊõ¥‰ΩéÔºâ
          messages: [{ role: 'user', content: prompt }]
        })
      });
      const data = await r.json();
      result = data.content?.[0]?.text || '{}';
    } else {
      let apiUrl;
      if(preset.type === 'custom'){
        const autoComplete = preset.urlAutoComplete !== false;
        apiUrl = normalizeApiUrl(preset.url || preset.baseUrl, autoComplete, preset.model);
      } else {
        apiUrl = 'https://api.openai.com/v1/chat/completions';
      }
      const r = await fetch(apiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${preset.apiKey}`
        },
        body: JSON.stringify({
          model: preset.model || 'gpt-4o-mini',
          messages: [{ role: 'user', content: prompt }],
          max_tokens: 8000  // Ë™øÊï¥ÁÇ∫ 8000ÔºàClaude ÂèØÁî®ÔºåGemini ÂèØËÉΩÈúÄË¶ÅÊõ¥‰ΩéÔºâ
        })
      });
      const data = await r.json();
      result = data.choices?.[0]?.message?.content || '{}';
    }

    // Ëß£ÊûêÁªìÊûú
    console.log('[AI Inventory] ÂéüÂßãËøîÂõû:', result);

    const jsonMatch = result.match(/\{[\s\S]*\}/);
    if(!jsonMatch){
      hideLoading();
      console.error('[AI Inventory] ÁÑ°Ê≥ïÊâæÂà∞ JSON Ê†ºÂºèÔºåÂéüÂßãËøîÂõû:', result);
      toast(T('AI Êú™ËÉΩË≠òÂà•Âà∞Áâ©ÂìÅËÆäÂåñÔºàËøîÂõûÊ†ºÂºèÈåØË™§Ôºâ'), 'warning');
      return;
    }

    let parsed;
    try {
      parsed = JSON.parse(jsonMatch[0]);
      console.log('[AI Inventory] Ëß£ÊûêÊàêÂäü:', parsed);
    } catch(e) {
      hideLoading();
      console.error('[AI Inventory] JSON Ëß£ÊûêÂ§±Êïó:', e, 'ÂéüÂßãÂÖßÂÆπ:', jsonMatch[0]);
      toast(T('AI ËøîÂõûÁöÑÊï∏ÊìöÊ†ºÂºèÈåØË™§'), 'error');
      return;
    }

    const items = parsed.items || [];

    if(!items.length){
      hideLoading();
      console.log('[AI Inventory] Ê≤íÊúâÊ™¢Ê∏¨Âà∞Áâ©ÂìÅËÆäÂåñ');
      toast(T('Êú™ÁôºÁèæÊñ∞ÁöÑÁâ©ÂìÅËÆäÂåñ'), 'info');
      return;
    }

    console.log('[AI Inventory] Ê™¢Ê∏¨Âà∞', items.length, 'ÂÄãÁâ©ÂìÅËÆäÂåñ');
    
    // Ê™¢Ê∏¨ÈáçË§á‰∏¶Ê®ôË®ò
    let inventory = story.inventory || [];
    const existingNames = new Set(inventory.map(i => i.name.toLowerCase()));
    
    let totalNew = 0, totalDup = 0;
    items.forEach((item, i) => {
      item._id = 'inv_' + i;
      if(item.action === 'add'){
        item._isDuplicate = existingNames.has((item.name || '').toLowerCase());
        item._selected = !item._isDuplicate; // ÈªòË™çÈÅ∏‰∏≠ÈùûÈáçË§áÁöÑÊñ∞Â¢ûÈ†Ö
        if(item._isDuplicate) totalDup++; else totalNew++;
      } else {
        // update Âíå remove Êìç‰ΩúÈªòË™çÈÅ∏‰∏≠
        item._selected = true;
        item._isDuplicate = false;
      }
    });
    
    // ‰øùÂ≠òÁµêÊûú‰æõÂæåÁ∫å‰ΩøÁî®
    window._aiInventoryResult = { items, inventory: [...inventory] };
    
    hideLoading();
    
    // ÊßãÂª∫È†êË¶ΩHTML
    let previewHtml = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding:8px;background:var(--bg-tertiary);border-radius:8px">
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px">
          <input type="checkbox" id="ai-inv-select-all" onchange="toggleAiInventorySelectAll(this.checked)" checked>
          ÂÖ®ÈÅ∏ÈùûÈáçË§áÈ†Ö
        </label>
        <div style="font-size:12px;color:var(--text-tertiary)">
          üÜï ${totalNew} Êñ∞Â¢û ¬∑ ‚ö†Ô∏è ${totalDup} ÈáçË§á
        </div>
      </div>
    `;
    
    items.forEach(item => {
      let actionLabel, actionColor;
      if(item.action === 'add'){
        actionLabel = item._isDuplicate ? '‚ö†Ô∏è Â∑≤Â≠òÂú®ÔºàÂ∞áÂ¢ûÂä†Êï∏ÈáèÔºâ' : 'üÜï Êñ∞Â¢û';
        actionColor = item._isDuplicate ? 'var(--warning)' : 'var(--success)';
      } else if(item.action === 'remove'){
        actionLabel = 'üóëÔ∏è ÁßªÈô§';
        actionColor = 'var(--error)';
      } else {
        actionLabel = '‚úèÔ∏è Êõ¥Êñ∞';
        actionColor = 'var(--info)';
      }
      
      previewHtml += `
        <div style="display:flex;align-items:flex-start;gap:8px;padding:10px;border:1px solid var(--divider);border-radius:8px;margin-bottom:6px;background:${item._isDuplicate ? 'rgba(245,158,11,0.05)' : 'var(--bg-secondary)'}">
          <input type="checkbox" data-id="${item._id}" ${item._selected ? 'checked' : ''} onchange="updateAiInventorySelection()" style="margin-top:4px">
          <span style="font-size:20px">${item.icon || 'üì¶'}</span>
          <div style="flex:1;min-width:0">
            <div style="display:flex;align-items:center;gap:6px">
              <span style="font-size:13px;font-weight:500">${esc(item.name)}</span>
              <span style="font-size:11px;color:${actionColor}">${actionLabel}</span>
            </div>
            <div style="font-size:12px;color:var(--text-tertiary);margin-top:2px">
              Êï∏Èáè: ${item.quantity || 1} ¬∑ ${esc(item.description || '')}
            </div>
          </div>
        </div>
      `;
    });
    
    // ‰ΩøÁî® ai-preview-modal È°ØÁ§∫
    document.getElementById('ai-preview-content').innerHTML = previewHtml;
    document.getElementById('ai-preview-title').textContent = 'üéí ËÉåÂåÖÁâ©ÂìÅËÆäÂåñÈ†êË¶Ω';
    document.getElementById('ai-preview-confirm-btn').onclick = applyInventoryChanges;
    showModal('ai-preview-modal');
    
  } catch(e) {
    hideLoading();
    console.error('AI sync inventory error:', e);
    toast('ÂêåÊ≠•Â§±Êïó: ' + e.message, 'error');
  }
}

// ÂÖ®ÈÅ∏/ÂèñÊ∂àÂÖ®ÈÅ∏ËÉåÂåÖÁâ©ÂìÅ
function toggleAiInventorySelectAll(checked){
  const result = window._aiInventoryResult;
  if(!result) return;
  
  document.querySelectorAll('#ai-preview-content input[type="checkbox"][data-id]').forEach(cb => {
    const id = cb.dataset.id;
    const item = result.items.find(i => i._id === id);
    if(item){
      if(checked){
        cb.checked = !item._isDuplicate;
        item._selected = !item._isDuplicate;
      } else {
        cb.checked = false;
        item._selected = false;
      }
    }
  });
}

// Êõ¥Êñ∞ËÉåÂåÖÈÅ∏ÊìáÁãÄÊÖã
function updateAiInventorySelection(){
  const result = window._aiInventoryResult;
  if(!result) return;
  
  document.querySelectorAll('#ai-preview-content input[type="checkbox"][data-id]').forEach(cb => {
    const id = cb.dataset.id;
    const item = result.items.find(i => i._id === id);
    if(item) item._selected = cb.checked;
  });
}

// ÊáâÁî®ËÉåÂåÖËÆäÂåñ
async function applyInventoryChanges(){
  const result = window._aiInventoryResult;
  if(!result) return;
  
  let inventory = result.inventory;
  let addCount = 0, updateCount = 0, removeCount = 0;
  
  const selectedItems = result.items.filter(i => i._selected);
  
  for(const item of selectedItems){
    if(item.action === 'add'){
      const existing = inventory.find(i => i.name === item.name);
      if(existing){
        existing.quantity = (existing.quantity || 1) + (item.quantity || 1);
        existing.updatedAt = Date.now();
        updateCount++;
      } else {
        const newItem = {
          id: crypto.randomUUID(),
          name: item.name,
          icon: item.icon || 'üì¶',
          quantity: item.quantity || 1,
          category: item.category || 'other',
          description: item.description || '',
          createdAt: Date.now()
        };
        await syncInventoryToLorebook(newItem);
        inventory.push(newItem);
        addCount++;
      }
    } else if(item.action === 'remove'){
      const idx = inventory.findIndex(i => i.name === item.name);
      if(idx >= 0){
        const existing = inventory[idx];
        if(item.quantity && existing.quantity > item.quantity){
          existing.quantity -= item.quantity;
          updateCount++;
        } else {
          if(existing.lorebookId){
            await db.lorebook.delete(existing.lorebookId);
          }
          inventory.splice(idx, 1);
          removeCount++;
        }
      }
    } else if(item.action === 'update'){
      const existing = inventory.find(i => i.name === item.name);
      if(existing){
        if(item.quantity) existing.quantity = item.quantity;
        if(item.description) existing.description = item.description;
        existing.updatedAt = Date.now();
        updateCount++;
      }
    }
  }
  
  story.inventory = inventory;
  await db.stories.update(story.id, { inventory });
  
  closeModal('ai-preview-modal');
  delete window._aiInventoryResult;
  
  renderInventory();
  
  const changes = [];
  if(addCount) changes.push(`Êñ∞Â¢û ${addCount} ÂÄã`);
  if(updateCount) changes.push(`Êõ¥Êñ∞ ${updateCount} ÂÄã`);
  if(removeCount) changes.push(`ÁßªÈô§ ${removeCount} ÂÄã`);
  
  toast(`ËÉåÂåÖÂ∑≤ÂêåÊ≠•Ôºö${changes.join('Ôºå') || 'ÁÑ°ËÆäÂåñ'}`, 'success');
}

// ============ Â†¥ÊôØÁÆ°ÁêÜÁ≥ªÁµ± ============
let currentEditSceneId = null;

async function showSceneManager(){
  if(!story){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'),'warning');return;}
  closeAll();
  await renderSceneList();
  await updateCurrentSceneSelect();
  showModal('scene-modal');
}

async function renderSceneList(){
  const container = document.getElementById('scene-list');
  const scenes = await db.scenes.where('storyId').equals(story.id).toArray();
  
  if(!scenes.length){
    container.innerHTML = `<div style="text-align:center;padding:16px;color:var(--text-tertiary);font-size:13px">ÈÇÑÊ≤íÊúâÂ†¥ÊôØÔºåÈªûÊìä‰∏ãÊñπÊåâÈàïÂâµÂª∫</div>`;
    document.getElementById('scene-detail-section').style.display = 'none';
    return;
  }
  
  let html = '';
  scenes.forEach(s => {
    const charCount = s.characterIds?.length || 0;
    html += `
      <div class="scene-item" style="display:flex;align-items:center;padding:10px;background:${s.isActive?'rgba(139,92,246,0.15)':'var(--bg-secondary)'};border-radius:8px;margin-bottom:6px;cursor:pointer" onclick="selectSceneForDetail('${s.id}')">
        <div style="flex:1;min-width:0">
          <div style="font-size:14px;font-weight:500;color:${s.isActive?'var(--primary)':'var(--text-primary)'}">${esc(s.name)} ${s.isActive?'‚úì':''}</div>
          <div style="font-size:11px;color:var(--text-tertiary)">${charCount} ‰ΩçËßíËâ≤Âú®Â†¥</div>
        </div>
        <div style="display:flex;gap:4px">
          <button class="icon-btn" style="padding:4px 8px;font-size:12px" onclick="event.stopPropagation();editScene('${s.id}')">‚úèÔ∏è</button>
          <button class="icon-btn" style="padding:4px 8px;font-size:12px;color:var(--error)" onclick="event.stopPropagation();deleteScene('${s.id}')">üóëÔ∏è</button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

async function updateCurrentSceneSelect(){
  const select = document.getElementById('current-scene');
  const scenes = await db.scenes.where('storyId').equals(story.id).toArray();
  
  let html = '<option value="">ÁÑ°Â†¥ÊôØÔºàÊâÄÊúâËßíËâ≤Ôºâ</option>';
  scenes.forEach(s => {
    html += `<option value="${s.id}" ${s.isActive?'selected':''}>${esc(s.name)}</option>`;
  });
  select.innerHTML = html;
}

async function switchScene(sceneId){
  if(!story) return;
  
  // Ê∏ÖÈô§ÊâÄÊúâÂ†¥ÊôØÁöÑÊøÄÊ¥ªÁãÄÊÖã
  const scenes = await db.scenes.where('storyId').equals(story.id).toArray();
  for(const s of scenes){
    if(s.isActive){
      s.isActive = false;
      await db.scenes.put(s);
    }
  }
  
  // ÊøÄÊ¥ªÈÅ∏‰∏≠ÁöÑÂ†¥ÊôØ
  if(sceneId){
    const scene = await db.scenes.get(sceneId);
    if(scene){
      scene.isActive = true;
      await db.scenes.put(scene);
      toast(`Â∑≤ÂàáÊèõÂà∞Â†¥ÊôØ„Äå${scene.name}„Äç`,'success');
    }
  } else {
    toast(T('Â∑≤ÂàáÊèõÁÇ∫ÁÑ°Â†¥ÊôØÊ®°Âºè'),'success');
  }
  
  await renderSceneList();
}

async function selectSceneForDetail(sceneId){
  const scene = await db.scenes.get(sceneId);
  if(!scene) return;
  
  const section = document.getElementById('scene-detail-section');
  section.style.display = 'block';
  
  const container = document.getElementById('scene-characters');
  const charIds = scene.characterIds || [];
  
  if(!charIds.length){
    container.innerHTML = `<div style="text-align:center;padding:12px;color:var(--text-tertiary);font-size:12px">Ê≠§Â†¥ÊôØÊ≤íÊúâËßíËâ≤</div>`;
    return;
  }
  
  let html = '';
  for(const cid of charIds){
    const char = await db.characters.get(cid);
    if(char){
      html += `
        <div style="display:flex;align-items:center;padding:8px;background:var(--bg-secondary);border-radius:6px;margin-bottom:4px">
          <span style="font-size:20px;margin-right:8px">${char.avatar||'üë§'}</span>
          <span style="flex:1;font-size:13px">${esc(char.name)}</span>
          ${char.title?`<span style="font-size:11px;color:var(--text-tertiary)">${esc(char.title)}</span>`:''}
        </div>
      `;
    }
  }
  container.innerHTML = html;
}

async function createNewScene(){
  currentEditSceneId = null;
  document.getElementById('scene-edit-title').textContent = 'ÂâµÂª∫Â†¥ÊôØ';
  document.getElementById('scene-edit-id').value = '';
  document.getElementById('scene-edit-name').value = '';
  document.getElementById('scene-edit-desc').value = '';
  
  await renderSceneCharSelector([]);
  showModal('scene-edit-modal');
}

async function editScene(sceneId){
  const scene = await db.scenes.get(sceneId);
  if(!scene) return;
  
  currentEditSceneId = sceneId;
  document.getElementById('scene-edit-title').textContent = 'Á∑®ËºØÂ†¥ÊôØ';
  document.getElementById('scene-edit-id').value = sceneId;
  document.getElementById('scene-edit-name').value = scene.name;
  document.getElementById('scene-edit-desc').value = scene.description || '';
  
  await renderSceneCharSelector(scene.characterIds || []);
  showModal('scene-edit-modal');
}

async function renderSceneCharSelector(selectedIds){
  const container = document.getElementById('scene-char-selector');
  const chars = await db.characters.where('storyId').equals(story.id).toArray();
  
  if(!chars.length){
    container.innerHTML = `<div style="text-align:center;padding:12px;color:var(--text-tertiary);font-size:12px">ÈÇÑÊ≤íÊúâËßíËâ≤ÔºåË´ãÂÖàÊ∑ªÂä†ËßíËâ≤</div>`;
    return;
  }
  
  let html = '';
  chars.forEach(c => {
    const checked = selectedIds.includes(c.id);
    html += `
      <label style="display:flex;align-items:center;padding:8px;cursor:pointer;border-radius:6px;margin-bottom:4px;background:${checked?'rgba(139,92,246,0.1)':'transparent'}">
        <input type="checkbox" class="scene-char-cb" value="${c.id}" ${checked?'checked':''} style="margin-right:10px;width:18px;height:18px">
        <span style="font-size:18px;margin-right:8px">${c.avatar||'üë§'}</span>
        <span style="flex:1;font-size:13px">${esc(c.name)}</span>
        ${c.title?`<span style="font-size:11px;color:var(--text-tertiary)">${esc(c.title)}</span>`:''}
      </label>
    `;
  });
  container.innerHTML = html;
}

async function saveScene(){
  const name = document.getElementById('scene-edit-name').value.trim();
  if(!name){toast(T('Ë´ãËº∏ÂÖ•Â†¥ÊôØÂêçÁ®±'),'warning');return;}
  
  const description = document.getElementById('scene-edit-desc').value.trim();
  const checkboxes = document.querySelectorAll('.scene-char-cb:checked');
  const characterIds = Array.from(checkboxes).map(cb => cb.value);
  
  const sceneId = document.getElementById('scene-edit-id').value || crypto.randomUUID();
  
  const scene = {
    id: sceneId,
    storyId: story.id,
    name,
    description,
    characterIds,
    isActive: false,
    createdAt: currentEditSceneId ? (await db.scenes.get(sceneId))?.createdAt || Date.now() : Date.now()
  };
  
  await db.scenes.put(scene);
  closeModal('scene-edit-modal');
  await renderSceneList();
  await updateCurrentSceneSelect();
  toast(currentEditSceneId ? 'Â†¥ÊôØÂ∑≤Êõ¥Êñ∞' : 'Â†¥ÊôØÂ∑≤ÂâµÂª∫', 'success');
}

async function deleteScene(sceneId){
  if(!confirm('Á¢∫ÂÆöÂà™Èô§ÈÄôÂÄãÂ†¥ÊôØÔºü')) return;
  await db.scenes.delete(sceneId);
  await renderSceneList();
  await updateCurrentSceneSelect();
  toast(T('Â†¥ÊôØÂ∑≤Âà™Èô§'),'success');
}

// ============ Áé©ÂÆ∂Èù¢ÊùøÁ≥ªÁµ± ============
let currentPlayerPanel = null;
let tempPlayerAttrs = [];

async function showPlayerPanel(){
  if(!story){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'),'warning');return;}
  closeAll();
  
  // ËºâÂÖ•Áï∂ÂâçÊïÖ‰∫ãÁöÑÈù¢ÊùøÈÖçÁΩÆ
  currentPlayerPanel = await db.playerPanels.where('storyId').equals(story.id).first();
  
  renderPlayerPanelContent();
  showModal('player-panel-modal');
}

function renderPlayerPanelContent(){
  const container = document.getElementById('player-panel-content');
  const syncBtn = document.getElementById('player-sync-btn');
  
  if(!currentPlayerPanel || !currentPlayerPanel.attributes?.length){
    container.innerHTML = `
      <div style="text-align:center;padding:24px;color:var(--text-tertiary)">
        <div style="font-size:32px;margin-bottom:12px">üìã</div>
        <div style="font-size:14px">ÈÇÑÊ≤íÊúâË®≠ÁΩÆÁãÄÊÖãÈù¢Êùø</div>
        <div style="font-size:12px;margin-top:4px">ÈªûÊìä‰∏ãÊñπ„ÄåË®≠ÁΩÆÈù¢Êùø„ÄçÂâµÂª∫</div>
      </div>
    `;
    if(syncBtn) syncBtn.style.display = 'none';
    return;
  }
  
  // È°ØÁ§∫AIÂêåÊ≠•ÊåâÈàï
  if(syncBtn) syncBtn.style.display = 'flex';
  
  const p = currentPlayerPanel;
  
  // ÊåâÂàÜÁµÑÊï¥ÁêÜÂ±¨ÊÄß
  const groupConfig = {
    'default': { icon: 'üìä', title: 'Â±¨ÊÄß' },
    'stats': { icon: 'üí™', title: 'Âü∫Á§éÂ±¨ÊÄß' },
    'status': { icon: '‚ù§Ô∏è', title: 'Áï∂ÂâçÁãÄÊÖã' },
    'finance': { icon: 'üí∞', title: 'Ë≤°ÂãôÁãÄÊ≥Å' }
  };
  
  const groups = {};
  for(const attr of p.attributes){
    const groupKey = attr.group || 'default';
    if(!groups[groupKey]) groups[groupKey] = [];
    groups[groupKey].push(attr);
  }
  
  let html = `<div class="player-panel">`;
  html += `<div class="player-panel-header">`;
  html += `<div class="player-panel-title">üìã ${esc(p.name || 'ÊàëÁöÑÁãÄÊÖã')}</div>`;
  html += `</div>`;
  
  // Â¶ÇÊûúÂè™Êúâ‰∏ÄÂÄãÂàÜÁµÑ‰∏îÁÇ∫defaultÔºå‰∏çÈ°ØÁ§∫ÂàÜÁµÑÊ®ôÈ°å
  const groupKeys = Object.keys(groups);
  const showGroupHeaders = groupKeys.length > 1 || (groupKeys.length === 1 && groupKeys[0] !== 'default');
  
  for(const [groupKey, attrs] of Object.entries(groups)){
    const config = groupConfig[groupKey] || { icon: '‚ú®', title: groupKey };
    
    html += `<div class="player-group">`;
    
    if(showGroupHeaders){
      html += `<div class="player-group-header">`;
      html += `<span class="player-group-icon">${config.icon}</span>`;
      html += `<span class="player-group-title">${esc(config.title)}</span>`;
      html += `<span class="player-group-toggle" onclick="togglePlayerGroup(this)">‚ñº</span>`;
      html += `</div>`;
    }
    
    // Ê†πÊìöÂ±¨ÊÄßÊï∏ÈáèÊ±∫ÂÆöÁ∂≤Ê†ºÂàóÊï∏
    const gridClass = attrs.length >= 6 ? 'grid-3' : '';
    html += `<div class="player-group-content"><div class="player-stat-grid ${gridClass}">`;
    
    for(const attr of attrs){
      const value = p.values?.[attr.name] ?? attr.defaultValue ?? 0;
      const colorClass = attr.color || 'default';
      
      html += `<div class="player-stat-item color-${colorClass}">`;
      html += `<div class="player-stat-label">${attr.icon || 'üìä'} ${esc(attr.name)}</div>`;
      
      if(attr.type === 'percent'){
        const max = attr.maxValue || 100;
        const percent = Math.min(100, Math.max(0, (value / max) * 100));
        const barColorClass = attr.name.includes('È´îÂäõ') || attr.name.includes('ÂÅ•Â∫∑') || attr.name.includes('HP') ? 'health' : 
                             attr.name.includes('Á≤æÁ•û') || attr.name.includes('ËÉΩÈáè') || attr.name.includes('MP') ? 'energy' :
                             attr.name.includes('ÂøÉÊÉÖ') || attr.name.includes('ÊÉÖÁ∑í') ? 'mood' : 'default';
        html += `<div class="player-stat-value">${value}<span class="unit">%</span></div>`;
        html += `<div class="player-stat-bar"><div class="player-stat-bar-fill ${barColorClass}" style="width:${percent}%"></div></div>`;
      } else if(attr.type === 'number'){
        const isNegative = typeof value === 'number' && value < 0;
        const isPositive = typeof value === 'number' && value > 0 && (attr.name.includes('ÁèæÈáë') || attr.name.includes('ÈáëÈå¢') || attr.name.includes('È§òÈ°ç'));
        const unit = attr.unit || '';
        html += `<div class="player-stat-value ${isNegative ? 'negative' : ''} ${isPositive ? 'positive' : ''}">${typeof value === 'number' ? value.toLocaleString() : value}${unit ? `<span class="unit">${esc(unit)}</span>` : ''}</div>`;
      } else {
        // ÊñáÂ≠óÈ°ûÂûã‰ΩøÁî®Ê®ôÁ±§Ê®£Âºè
        html += `<div class="player-stat-tag">${esc(String(value))}</div>`;
      }
      
      html += `</div>`;
    }
    
    html += `</div></div></div>`;
  }
  
  html += `</div>`;
  container.innerHTML = html;
}

// ÂàáÊèõÂàÜÁµÑÂ±ïÈñã/Êî∂Ëµ∑
function togglePlayerGroup(el){
  el.classList.toggle('collapsed');
  const content = el.closest('.player-group').querySelector('.player-group-content');
  if(content){
    if(content.classList.contains('collapsed')){
      content.style.maxHeight = content.scrollHeight + 'px';
      content.classList.remove('collapsed');
    } else {
      content.style.maxHeight = content.scrollHeight + 'px';
      requestAnimationFrame(() => {
        content.classList.add('collapsed');
      });
    }
  }
}

async function showPlayerPanelSetup(){
  closeModal('player-panel-modal');
  
  // ËºâÂÖ•ÁèæÊúâÈÖçÁΩÆ
  if(currentPlayerPanel){
    document.getElementById('player-panel-name').value = currentPlayerPanel.name || '';
    tempPlayerAttrs = [...(currentPlayerPanel.attributes || [])];
  } else {
    document.getElementById('player-panel-name').value = '';
    tempPlayerAttrs = [];
  }
  
  renderPlayerAttrList();
  showModal('player-panel-setup-modal');
}

function renderPlayerAttrList(){
  const container = document.getElementById('player-attr-list');
  
  if(!tempPlayerAttrs.length){
    container.innerHTML = `<div style="text-align:center;padding:16px;color:var(--text-tertiary);font-size:13px">ÈÇÑÊ≤íÊúâÂ±¨ÊÄßÔºåÈªûÊìäÊ∑ªÂä†</div>`;
    return;
  }
  
  const groupConfig = {
    'default': { icon: 'üìä', title: 'È†êË®≠' },
    'stats': { icon: 'üí™', title: 'Âü∫Á§éÂ±¨ÊÄß' },
    'status': { icon: '‚ù§Ô∏è', title: 'Áï∂ÂâçÁãÄÊÖã' },
    'finance': { icon: 'üí∞', title: 'Ë≤°Âãô' }
  };
  
  let html = '';
  tempPlayerAttrs.forEach((attr, i) => {
    const typeLabel = attr.type === 'percent' ? 'ÁôæÂàÜÊØî' : attr.type === 'number' ? 'Êï∏Â≠ó' : 'ÊñáÂ≠ó';
    const groupInfo = groupConfig[attr.group] || { icon: '‚ú®', title: attr.group || 'È†êË®≠' };
    const colorStyle = attr.color && attr.color !== 'default' ? `border-left-color:${getColorHex(attr.color)}` : '';
    html += `
      <div class="player-attr-card" style="${colorStyle}">
        <div class="player-attr-icon">${attr.icon || 'üìä'}</div>
        <div class="player-attr-info">
          <div class="player-attr-name">${esc(attr.name)}</div>
          <div class="player-attr-type">${typeLabel} ¬∑ ÂàùÂßãÂÄº: ${attr.defaultValue ?? 0}</div>
          <div class="player-attr-group">${groupInfo.icon} ${groupInfo.title}</div>
        </div>
        <button class="icon-btn" style="padding:4px 8px;font-size:12px" onclick="editPlayerAttribute(${i})">‚úèÔ∏è</button>
        <button class="icon-btn" style="padding:4px 8px;font-size:12px;color:var(--error)" onclick="deletePlayerAttribute(${i})">üóëÔ∏è</button>
      </div>
    `;
  });
  container.innerHTML = html;
}

function getColorHex(color){
  const colors = {
    'red': '#EF4444',
    'orange': '#F59E0B',
    'yellow': '#EAB308',
    'green': '#10B981',
    'blue': '#3B82F6',
    'purple': '#8B5CF6',
    'pink': '#EC4899'
  };
  return colors[color] || 'var(--primary)';
}

function selectAttrGroup(el){
  document.querySelectorAll('#player-attr-group-selector .group-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  const group = el.dataset.group;
  document.getElementById('player-attr-group').value = group;
  document.getElementById('player-attr-custom-group').style.display = group === 'custom' ? 'block' : 'none';
}

function selectAttrColor(el){
  el.parentElement.querySelectorAll('.group-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('player-attr-color').value = el.dataset.color;
}

function addPlayerAttribute(){
  document.getElementById('player-attr-modal-title').textContent = '‚ûï Ê∑ªÂä†Â±¨ÊÄß';
  document.getElementById('player-attr-edit-index').value = '-1';
  document.getElementById('player-attr-name').value = '';
  document.getElementById('player-attr-icon').value = '';
  document.getElementById('player-attr-type').value = 'number';
  document.getElementById('player-attr-default').value = '0';
  document.getElementById('player-attr-max').value = '100';
  document.getElementById('player-attr-keywords').value = '';
  // ÈáçÁΩÆÂàÜÁµÑÈÅ∏Êìá
  document.getElementById('player-attr-group').value = 'default';
  document.querySelectorAll('#player-attr-group-selector .group-chip').forEach(c => c.classList.remove('active'));
  document.querySelector('#player-attr-group-selector .group-chip[data-group="default"]')?.classList.add('active');
  document.getElementById('player-attr-custom-group').style.display = 'none';
  document.getElementById('player-attr-custom-group-name').value = '';
  // ÈáçÁΩÆÈ°èËâ≤ÈÅ∏Êìá
  document.getElementById('player-attr-color').value = 'default';
  document.querySelectorAll('#player-attr-modal .group-chip[data-color]').forEach(c => c.classList.remove('active'));
  document.querySelector('#player-attr-modal .group-chip[data-color="default"]')?.classList.add('active');
  updatePlayerAttrTypeUI();
  showModal('player-attr-modal');
}

function editPlayerAttribute(index){
  const attr = tempPlayerAttrs[index];
  if(!attr) return;
  
  document.getElementById('player-attr-modal-title').textContent = '‚úèÔ∏è Á∑®ËºØÂ±¨ÊÄß';
  document.getElementById('player-attr-edit-index').value = index;
  document.getElementById('player-attr-name').value = attr.name || '';
  document.getElementById('player-attr-icon').value = attr.icon || '';
  document.getElementById('player-attr-type').value = attr.type || 'number';
  document.getElementById('player-attr-default').value = attr.defaultValue ?? '0';
  document.getElementById('player-attr-max').value = attr.maxValue || 100;
  document.getElementById('player-attr-keywords').value = (attr.keywords || []).join(', ');
  // Ë®≠ÁΩÆÂàÜÁµÑ
  const group = attr.group || 'default';
  document.getElementById('player-attr-group').value = group;
  document.querySelectorAll('#player-attr-group-selector .group-chip').forEach(c => c.classList.remove('active'));
  const groupChip = document.querySelector(`#player-attr-group-selector .group-chip[data-group="${group}"]`);
  if(groupChip){
    groupChip.classList.add('active');
    document.getElementById('player-attr-custom-group').style.display = 'none';
  } else {
    // Ëá™ÂÆöÁæ©ÂàÜÁµÑ
    document.querySelector('#player-attr-group-selector .group-chip[data-group="custom"]')?.classList.add('active');
    document.getElementById('player-attr-custom-group').style.display = 'block';
    document.getElementById('player-attr-custom-group-name').value = group;
  }
  // Ë®≠ÁΩÆÈ°èËâ≤
  const color = attr.color || 'default';
  document.getElementById('player-attr-color').value = color;
  document.querySelectorAll('#player-attr-modal .group-chip[data-color]').forEach(c => c.classList.remove('active'));
  document.querySelector(`#player-attr-modal .group-chip[data-color="${color}"]`)?.classList.add('active');
  updatePlayerAttrTypeUI();
  showModal('player-attr-modal');
}

function deletePlayerAttribute(index){
  if(!confirm('Á¢∫ÂÆöÂà™Èô§ÈÄôÂÄãÂ±¨ÊÄßÔºü')) return;
  tempPlayerAttrs.splice(index, 1);
  renderPlayerAttrList();
}

function updatePlayerAttrTypeUI(){
  const type = document.getElementById('player-attr-type').value;
  const maxGroup = document.getElementById('player-attr-max-group');
  maxGroup.style.display = type === 'percent' ? 'block' : 'none';
}

function savePlayerAttribute(){
  const name = document.getElementById('player-attr-name').value.trim();
  if(!name){toast(T('Ë´ãËº∏ÂÖ•Â±¨ÊÄßÂêçÁ®±'),'warning');return;}
  
  // Áç≤ÂèñÂàÜÁµÑ
  let group = document.getElementById('player-attr-group').value;
  if(group === 'custom'){
    group = document.getElementById('player-attr-custom-group-name').value.trim() || 'default';
  }
  
  const attr = {
    name,
    icon: document.getElementById('player-attr-icon').value.trim() || 'üìä',
    type: document.getElementById('player-attr-type').value,
    defaultValue: document.getElementById('player-attr-type').value === 'text' 
      ? document.getElementById('player-attr-default').value 
      : parseFloat(document.getElementById('player-attr-default').value) || 0,
    maxValue: parseInt(document.getElementById('player-attr-max').value) || 100,
    keywords: document.getElementById('player-attr-keywords').value.split(',').map(k => k.trim()).filter(k => k),
    group: group,
    color: document.getElementById('player-attr-color').value || 'default'
  };
  
  const editIndex = parseInt(document.getElementById('player-attr-edit-index').value);
  if(editIndex >= 0){
    tempPlayerAttrs[editIndex] = attr;
  } else {
    tempPlayerAttrs.push(attr);
  }
  
  closeModal('player-attr-modal');
  renderPlayerAttrList();
}

async function savePlayerPanelSetup(){
  const name = document.getElementById('player-panel-name').value.trim() || 'ÊàëÁöÑÁãÄÊÖã';
  
  // ‰øùÁïôÁèæÊúâÊï∏ÂÄº
  const existingValues = currentPlayerPanel?.values || {};
  const newValues = {};
  tempPlayerAttrs.forEach(attr => {
    newValues[attr.name] = existingValues[attr.name] ?? attr.defaultValue ?? 0;
  });
  
  const panel = {
    id: currentPlayerPanel?.id || crypto.randomUUID(),
    storyId: story.id,
    name,
    attributes: tempPlayerAttrs,
    values: newValues,
    createdAt: currentPlayerPanel?.createdAt || Date.now(),
    updatedAt: Date.now()
  };
  
  await db.playerPanels.put(panel);
  currentPlayerPanel = panel;
  
  closeModal('player-panel-setup-modal');
  toast(T('Èù¢ÊùøË®≠ÁΩÆÂ∑≤‰øùÂ≠ò'),'success');
  showPlayerPanel();
}

function manualUpdatePlayerPanel(){
  if(!currentPlayerPanel?.attributes?.length){
    toast(T('Ë´ãÂÖàË®≠ÁΩÆÈù¢ÊùøÂ±¨ÊÄß'),'warning');
    return;
  }
  
  const container = document.getElementById('player-update-fields');
  let html = '';
  
  for(const attr of currentPlayerPanel.attributes){
    const value = currentPlayerPanel.values?.[attr.name] ?? attr.defaultValue ?? 0;
    html += `
      <div class="form-group">
        <label class="form-label">${attr.icon || 'üìä'} ${esc(attr.name)}</label>
        <input type="${attr.type === 'text' ? 'text' : 'number'}" class="form-input" 
          data-attr-name="${esc(attr.name)}" value="${esc(String(value))}"
          ${attr.type === 'percent' ? `min="0" max="${attr.maxValue || 100}"` : ''}>
      </div>
    `;
  }
  
  container.innerHTML = html;
  closeModal('player-panel-modal');
  showModal('player-update-modal');
}

async function savePlayerUpdate(){
  if(!currentPlayerPanel) return;
  
  const inputs = document.querySelectorAll('#player-update-fields input[data-attr-name]');
  const newValues = {...currentPlayerPanel.values};
  
  inputs.forEach(input => {
    const attrName = input.dataset.attrName;
    const attr = currentPlayerPanel.attributes.find(a => a.name === attrName);
    if(attr){
      newValues[attrName] = attr.type === 'text' ? input.value : parseFloat(input.value) || 0;
    }
  });
  
  currentPlayerPanel.values = newValues;
  currentPlayerPanel.updatedAt = Date.now();
  await db.playerPanels.put(currentPlayerPanel);
  
  closeModal('player-update-modal');
  toast(T('ÁãÄÊÖãÂ∑≤Êõ¥Êñ∞'),'success');
  showPlayerPanel();
}

async function aiGeneratePlayerPanel(){
  showLoading('ü§ñ AI Ê≠£Âú®ÂàÜÊûêË®≠ÂÆö‰∏¶ÁîüÊàêÂ±¨ÊÄß...\nÈÄôÂèØËÉΩÈúÄË¶Å 30-120 Áßí');

  try {
    // Êî∂ÈõÜÊïÖ‰∫ã‰ø°ÊÅØ
    let context = '';
    if(story.systemPrompt){
      context += '„ÄêSystem Prompt„Äë\n' + story.systemPrompt.slice(0, 3000) + '\n\n';
    }
    
    const lorebooks = await db.lorebook.where('storyId').equals(story.id).limit(5).toArray();
    if(lorebooks.length){
      context += '„ÄêLorebook Ê¢ùÁõÆ„Äë\n';
      lorebooks.forEach(l => {
        context += `- ${l.name}: ${l.content?.slice(0, 200)}...\n`;
      });
    }
    
    const response = await callAI(`‰Ω†ÊòØ‰∏ÄÂÄãÊñáÊ∏∏Â±¨ÊÄßË®≠Ë®àÂ∞àÂÆ∂„ÄÇÊ†πÊìö‰ª•‰∏ãË®≠ÂÆöÔºåÊé®Ëñ¶ÈÅ©ÂêàËøΩËπ§ÁöÑÁé©ÂÆ∂Â±¨ÊÄßÔºà5-10ÂÄãÔºâÔºå‰∏¶ÊåâÂàÜÁµÑÊï¥ÁêÜ„ÄÇ

${context}

Ë´ãÁî® JSON Ê†ºÂºèËøîÂõûÔºåÊØèÂÄãÂ±¨ÊÄßÂåÖÂê´Ôºö
- name: Â±¨ÊÄßÂêçÁ®±
- icon: emoji ÂúñÊ®ô
- type: "number"ÔºàÊï∏Â≠óÔºâ„ÄÅ"percent"ÔºàÁôæÂàÜÊØî 0-100ÔºâÊàñ "text"ÔºàÊñáÂ≠óÔºâ
- defaultValue: ÂàùÂßãÂÄº
- keywords: Áî®ÊñºËá™ÂãïËß£ÊûêÁöÑÈóúÈçµË©ûÊï∏ÁµÑ
- group: ÂàÜÁµÑÂêçÁ®±Ôºàstats=Âü∫Á§éÂ±¨ÊÄß, status=Áï∂ÂâçÁãÄÊÖã, finance=Ë≤°Âãô, ÊàñÂÖ∂‰ªñËá™ÂÆöÁæ©ÂàÜÁµÑÂêçÔºâ
- color: È°èËâ≤Ôºàred/orange/green/blue/purple/pink/defaultÔºâ

ÁØÑ‰æãÔºö
\`\`\`json
[
  {"name": "È≠ÖÂäõ", "icon": "‚ú®", "type": "number", "defaultValue": 50, "keywords": ["È≠ÖÂäõ"], "group": "stats", "color": "pink"},
  {"name": "È´îÂäõ", "icon": "‚ù§Ô∏è", "type": "percent", "defaultValue": 100, "keywords": ["È´îÂäõ", "HP"], "group": "status", "color": "red"},
  {"name": "ÁèæÈáë", "icon": "üí∞", "type": "number", "defaultValue": 1000, "keywords": ["ÁèæÈáë", "È§òÈ°ç"], "group": "finance", "color": "green"},
  {"name": "ËÅ∑‰Ωç", "icon": "üëî", "type": "text", "defaultValue": "Êñ∞‰∫∫", "keywords": ["ËÅ∑‰Ωç", "ËÅ∑Á¥ö"], "group": "status", "color": "blue"}
]
\`\`\`

Âè™ËøîÂõû JSONÔºå‰∏çË¶ÅÂÖ∂‰ªñÂÖßÂÆπ„ÄÇ`);
    
    const match = response.content.match(/```json\s*([\s\S]*?)\s*```/) || response.content.match(/\[\s*\{[\s\S]*\}\s*\]/);
    if(match){
      const attrs = JSON.parse(match[1] || match[0]);
      if(Array.isArray(attrs) && attrs.length){
        const generatedAttrs = attrs.map(a => ({
          name: a.name || 'Êú™ÂëΩÂêç',
          icon: a.icon || 'üìä',
          type: ['number', 'percent', 'text'].includes(a.type) ? a.type : 'number',
          defaultValue: a.defaultValue ?? 0,
          maxValue: 100,
          keywords: Array.isArray(a.keywords) ? a.keywords : [],
          group: a.group || 'default',
          color: a.color || 'default'
        }));

        // ÂÖ≥Èó≠Áé©ÂÆ∂Èù¢ÊùøËÆæÁΩÆmodal
        closeModal('player-panel-setup-modal');

        hideLoading();

        // ÊòæÁ§∫Á°ÆËÆ§Ê°Ü
        showConfirm(
          `AI Â∑≤ÁîüÊàê ${generatedAttrs.length} ÂÄãÂ±¨ÊÄßÂª∫Ë≠∞ÔºåÊòØÂê¶ÊáâÁî®Ôºü\n\n` +
          generatedAttrs.map(a => `${a.icon} ${a.name}`).join(', '),
          () => {
            // Á°ÆËÆ§ÔºöÂ∫îÁî®ÁîüÊàêÁöÑÂ±ûÊÄß
            tempPlayerAttrs = generatedAttrs;
            // ÈáçÊñ∞ÊâìÂºÄmodalÂπ∂Ê∏≤ÊüìÂàóË°®
            showModal('player-panel-setup-modal');
            renderPlayerAttrList();
            toast(`Â∑≤ÊáâÁî® ${tempPlayerAttrs.length} ÂÄãÂ±¨ÊÄß`,'success');
          },
          false,
          'ü§ñ AI ÁîüÊàêÁµêÊûú'
        );
      }
    } else {
      hideLoading();
      toast(T('AI ËøîÂõûÊ†ºÂºèÈåØË™§'),'error');
    }
  } catch(e){
    hideLoading();
    toast('ÁîüÊàêÂ§±Êïó: ' + e.message,'error');
  }
}

// AI Êô∫ËÉΩÂêåÊ≠• - ÂæûÂ∞çË©±‰∏≠Ëß£ÊûêÊï∏ÂÄºËÆäÂåñ
async function aiSyncPlayerStatus(){
  if(!currentPlayerPanel?.attributes?.length){
    toast(T('Ë´ãÂÖàË®≠ÁΩÆÈù¢ÊùøÂ±¨ÊÄß'),'warning');
    return;
  }
  
  const btn = document.getElementById('player-sync-btn');
  btn.disabled = true;
  btn.innerHTML = '‚è≥ AI Ê≠£Âú®ÂàÜÊûêÂ∞çË©±...';

  // È°ØÁ§∫ÈÄ≤Â∫¶ÊèêÁ§∫
  showLoading('ü§ñ AI Ê≠£Âú®ÂàÜÊûêÂ∞çË©±‰∏≠ÁöÑÊï∏ÂÄºËÆäÂåñ...\nÈÄôÂèØËÉΩÈúÄË¶Å 30-120 Áßí');

  try {
    // Áç≤ÂèñÊúÄËøëÁöÑÂ∞çË©±Ë®òÈåÑ
    const messages = await db.messages.where('storyId').equals(story.id).reverse().limit(20).toArray();
    if(!messages.length){
      hideLoading();
      toast(T('Ê≤íÊúâÂ∞çË©±Ë®òÈåÑÂèØÂàÜÊûê'),'warning');
      btn.disabled = false;
      btn.innerHTML = 'ü§ñ AI Êô∫ËÉΩÂêåÊ≠•ÔºàÂæûÂ∞çË©±‰∏≠Ëß£ÊûêÊï∏ÂÄºËÆäÂåñÔºâ';
      return;
    }
    
    const recentContent = messages.reverse().map(m => `[${m.role}]: ${m.content}`).join('\n\n');
    
    // ÊßãÂª∫Áï∂ÂâçÂ±¨ÊÄß‰ø°ÊÅØ
    const attrInfo = currentPlayerPanel.attributes.map(a => {
      const currentValue = currentPlayerPanel.values?.[a.name] ?? a.defaultValue;
      return `- ${a.icon} ${a.name} (${a.type}): Áï∂ÂâçÂÄº=${currentValue}, ÈóúÈçµË©û=[${[a.name, ...(a.keywords||[])].join(',')}]`;
    }).join('\n');
    
    const response = await callAI(`‰Ω†ÊòØ‰∏ÄÂÄãÊñáÊ∏∏Êï∏ÂÄºËß£ÊûêÂ∞àÂÆ∂„ÄÇË´ãÊ†πÊìö‰ª•‰∏ãÂ∞çË©±ÂÖßÂÆπÔºåÂàÜÊûêÁé©ÂÆ∂Â±¨ÊÄßÁöÑËÆäÂåñ„ÄÇ

„ÄêÁï∂ÂâçËøΩËπ§ÁöÑÂ±¨ÊÄß„Äë
${attrInfo}

„ÄêÊúÄËøëÁöÑÂ∞çË©±ÂÖßÂÆπ„Äë
${recentContent.slice(-4000)}

Ë´ãÂàÜÊûêÂ∞çË©±‰∏≠ÊèêÂà∞ÁöÑÊï∏ÂÄºËÆäÂåñÔºåËøîÂõû JSON Ê†ºÂºèÔºö
\`\`\`json
{
  "changes": [
    {"name": "Â±¨ÊÄßÂêçÁ®±", "newValue": Êñ∞Êï∏ÂÄºÊàñÊñáÂ≠ó, "reason": "ËÆäÂåñÂéüÂõ†"}
  ],
  "summary": "Á∞°Áü≠ÁöÑËÆäÂåñÊëòË¶Å"
}
\`\`\`

Ê≥®ÊÑèÔºö
1. Âè™ËøîÂõûÊúâËÆäÂåñÁöÑÂ±¨ÊÄß
2. Êï∏Â≠óÈ°ûÂûãËøîÂõûÊï∏Â≠óÔºåÁôæÂàÜÊØîÈ°ûÂûãËøîÂõû0-100ÁöÑÊï∏Â≠óÔºåÊñáÂ≠óÈ°ûÂûãËøîÂõûÂ≠óÁ¨¶‰∏≤
3. Â¶ÇÊûúÊ≤íÊúâÁôºÁèæ‰ªª‰ΩïËÆäÂåñÔºåËøîÂõûÁ©∫ÁöÑ changes Êï∏ÁµÑ
4. Âè™ËøîÂõû JSONÔºå‰∏çË¶ÅÂÖ∂‰ªñÂÖßÂÆπ`);
    
    const match = response.content.match(/```json\s*([\s\S]*?)\s*```/) || response.content.match(/\{[\s\S]*\}/);
    if(match){
      const result = JSON.parse(match[1] || match[0]);
      
      if(result.changes?.length){
        // Ê®ôË®òÊØèÂÄãËÆäÂåñÈ†Ö
        result.changes.forEach((change, i) => {
          change._id = 'change_' + i;
          change._selected = true; // ÈªòË™çÂÖ®ÈÅ∏
        });
        
        // ÊßãÂª∫Â∏∂ÈÅ∏ÊìáÊ°ÜÁöÑÈ†êË¶ΩHTML
        let changeHtml = `
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding:8px;background:var(--bg-tertiary);border-radius:8px">
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px">
              <input type="checkbox" id="ai-player-select-all" onchange="toggleAiPlayerSelectAll(this.checked)" checked>
              ÂÖ®ÈÅ∏
            </label>
            <div style="font-size:12px;color:var(--text-tertiary)">
              ÂÖ± ${result.changes.length} È†ÖËÆäÂåñ
            </div>
          </div>
        `;
        changeHtml += `<div style="margin-bottom:12px;color:var(--text-tertiary);font-size:12px">${esc(result.summary || '')}</div>`;
        changeHtml += '<div style="max-height:280px;overflow-y:auto">';
        
        for(const change of result.changes){
          const attr = currentPlayerPanel.attributes.find(a => a.name === change.name);
          if(attr){
            const oldValue = currentPlayerPanel.values?.[change.name] ?? attr.defaultValue;
            const isIncrease = typeof change.newValue === 'number' && typeof oldValue === 'number' && change.newValue > oldValue;
            const isDecrease = typeof change.newValue === 'number' && typeof oldValue === 'number' && change.newValue < oldValue;
            changeHtml += `
              <div style="display:flex;align-items:flex-start;gap:8px;padding:10px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:8px">
                <input type="checkbox" data-id="${change._id}" checked onchange="updateAiPlayerSelection()" style="margin-top:4px">
                <div style="flex:1">
                  <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
                    <span>${attr.icon}</span>
                    <span style="font-weight:500">${esc(change.name)}</span>
                  </div>
                  <div style="display:flex;align-items:center;gap:8px;font-size:14px">
                    <span style="color:var(--text-tertiary)">${oldValue}</span>
                    <span style="color:${isIncrease ? 'var(--success)' : isDecrease ? 'var(--error)' : 'var(--text-primary)'}">‚Üí ${change.newValue}</span>
                  </div>
                  <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">${esc(change.reason || '')}</div>
                </div>
              </div>
            `;
          }
        }
        changeHtml += '</div>';
        
        // ‰ΩøÁî®Ëá®ÊôÇËÆäÈáè‰øùÂ≠òËÆäÂåñ
        window._pendingPlayerChanges = result.changes;
        
        document.getElementById('ai-preview-content').innerHTML = changeHtml;
        document.getElementById('ai-preview-title').textContent = 'üìä Â±¨ÊÄßËÆäÂåñÈ†êË¶Ω';
        document.getElementById('ai-preview-confirm-btn').onclick = applyPlayerChanges;
        hideLoading();
        showModal('ai-preview-modal');
      } else {
        hideLoading();
        toast(T('Êú™ÁôºÁèæÂ±¨ÊÄßËÆäÂåñ'),'info');
      }
    } else {
      hideLoading();
      toast(T('AI ËøîÂõûÊ†ºÂºèÈåØË™§'),'error');
    }
  } catch(e){
    hideLoading();
    toast('ÂêåÊ≠•Â§±Êïó: ' + e.message,'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'ü§ñ AI Êô∫ËÉΩÂêåÊ≠•ÔºàÂæûÂ∞çË©±‰∏≠Ëß£ÊûêÊï∏ÂÄºËÆäÂåñÔºâ';
  }
}

// ÂÖ®ÈÅ∏/ÂèñÊ∂àÂÖ®ÈÅ∏Áé©ÂÆ∂Â±¨ÊÄßËÆäÂåñ
function toggleAiPlayerSelectAll(checked){
  const changes = window._pendingPlayerChanges;
  if(!changes) return;
  
  document.querySelectorAll('#ai-preview-content input[type="checkbox"][data-id]').forEach(cb => {
    cb.checked = checked;
    const id = cb.dataset.id;
    const change = changes.find(c => c._id === id);
    if(change) change._selected = checked;
  });
}

// Êõ¥Êñ∞Áé©ÂÆ∂Â±¨ÊÄßÈÅ∏ÊìáÁãÄÊÖã
function updateAiPlayerSelection(){
  const changes = window._pendingPlayerChanges;
  if(!changes) return;
  
  document.querySelectorAll('#ai-preview-content input[type="checkbox"][data-id]').forEach(cb => {
    const id = cb.dataset.id;
    const change = changes.find(c => c._id === id);
    if(change) change._selected = cb.checked;
  });
}

// ÊáâÁî®Â±¨ÊÄßËÆäÂåñÔºàÂè™ÊáâÁî®ÈÅ∏‰∏≠ÁöÑÔºâ
async function applyPlayerChanges(){
  const changes = window._pendingPlayerChanges;
  if(!changes?.length || !currentPlayerPanel) return;
  
  const selectedChanges = changes.filter(c => c._selected);
  if(!selectedChanges.length){
    toast(T('Ë´ãËá≥Â∞ëÈÅ∏Êìá‰∏ÄÈ†ÖËÆäÂåñ'), 'warning');
    return;
  }
  
  const newValues = {...currentPlayerPanel.values};
  
  for(const change of selectedChanges){
    const attr = currentPlayerPanel.attributes.find(a => a.name === change.name);
    if(attr){
      newValues[change.name] = change.newValue;
    }
  }
  
  currentPlayerPanel.values = newValues;
  currentPlayerPanel.updatedAt = Date.now();
  await db.playerPanels.put(currentPlayerPanel);
  
  closeModal('ai-preview-modal');
  toast(`Â∑≤Êõ¥Êñ∞ ${selectedChanges.length} ÂÄãÂ±¨ÊÄß`,'success');
  renderPlayerPanelContent();
  
  delete window._pendingPlayerChanges;
}

// Ëá™ÂãïËß£Êûê AI ÂõûË¶Ü‰∏≠ÁöÑÁé©ÂÆ∂ÁãÄÊÖãÊõ¥Êñ∞
async function parsePlayerStatusFromAI(content){
  if(!story) return;
  
  const panel = await db.playerPanels.where('storyId').equals(story.id).first();
  if(!panel?.attributes?.length) return;
  
  let updated = false;
  const newValues = {...panel.values};
  
  for(const attr of panel.attributes){
    // ÊßãÂª∫ÈóúÈçµË©ûÊ≠£Ââá
    const keywords = [attr.name, ...(attr.keywords || [])];
    for(const kw of keywords){
      // ÂåπÈÖçÂêÑÁ®ÆÊ†ºÂºèÔºö„ÄåÁèæÈáëÔºö1000„Äç„ÄåÁèæÈáë: 1000„Äç„Äåüí∞ 1000„Äç„ÄåÁèæÈáë ‚Üí 1000„Äç
      const patterns = [
        new RegExp(`${kw}[Ôºö:\\s‚Üí]+([\\d,.-]+)`, 'i'),
        new RegExp(`${attr.icon}\\s*[Ôºö:\\s‚Üí]*([\\d,.-]+)`, 'i'),
        new RegExp(`${kw}[Ôºö:\\s‚Üí]+([^\\d]*?)([\\d,.-]+)`, 'i')
      ];
      
      for(const pattern of patterns){
        const match = content.match(pattern);
        if(match){
          let value = match[1] || match[2];
          value = value.replace(/,/g, '');
          
          if(attr.type === 'text'){
            newValues[attr.name] = value;
          } else {
            const num = parseFloat(value);
            if(!isNaN(num)){
              newValues[attr.name] = num;
              updated = true;
              break;
            }
          }
        }
      }
    }
  }
  
  if(updated){
    panel.values = newValues;
    panel.updatedAt = Date.now();
    await db.playerPanels.put(panel);
  }
}

// ============ AI ÁîüÊàê Lorebook ============
function showAiLorebookModal(){
  if(!story){toast(T('Ë´ãÂÖàÈÅ∏ÊìáÊïÖ‰∫ã'),'warning');return;}
  if(!msgs || msgs.length === 0){
    toast(T('Áï∂ÂâçÊïÖ‰∫ãÈÇÑÊ≤íÊúâÂ∞çË©±Ë®òÈåÑÔºåÁÑ°Ê≥ïÊèêÂèñLorebook'),'warning');
    return;
  }
  document.getElementById('ai-lorebook-preview').style.display = 'none';
  document.getElementById('ai-lorebook-range').value = 20;
  updateLorebookRangeDisplay(20);
  showModal('ai-lorebook-modal');
}

function updateLorebookRangeDisplay(value){
  document.getElementById('ai-lorebook-range-display').textContent = `ÊúÄËøë ${value} Ê¢ùÂ∞çË©±Ê∂àÊÅØ`;
}

async function generateAiLorebook(){
  // Áç≤ÂèñÂàÜÊûêÁØÑÂúç
  const rangeValue = parseInt(document.getElementById('ai-lorebook-range').value) || 20;

  // ÂæûÊúÄËøëÁöÑÂ∞çË©±‰∏≠Êî∂ÈõÜÂÖßÂÆπ
  if(!msgs || msgs.length === 0){
    toast(T('Áï∂ÂâçÊïÖ‰∫ãÈÇÑÊ≤íÊúâÂ∞çË©±Ë®òÈåÑ'),'warning');
    return;
  }

  // Êî∂ÈõÜÊúÄËøëNÊ¢ùÊ∂àÊÅØ
  const recentMsgs = msgs.slice(-rangeValue);
  const dialogueContent = recentMsgs.map((m, idx) => {
    const role = m.role === 'user' ? '„ÄêÁé©ÂÆ∂„Äë' : '„ÄêÂäáÊÉÖ„Äë';
    return `${role} ${m.content}`;
  }).join('\n\n');

  if(dialogueContent.length < 50){
    toast(T('Â∞çË©±ÂÖßÂÆπÂ§™Â∞ëÔºåÁÑ°Ê≥ïÊèêÂèñÊúâÊïà‰ø°ÊÅØ'),'warning');
    return;
  }

  const extractChars = document.getElementById('ai-lorebook-chars').checked;
  const extractPlayer = document.getElementById('ai-lorebook-player').checked;

  const btn = document.getElementById('ai-lorebook-generate-btn');
  btn.textContent = '‚è≥ ÊèêÂèñ‰∏≠...';
  btn.disabled = true;

  // È°ØÁ§∫ÈÄ≤Â∫¶ÊèêÁ§∫
  showLoading('ü§ñ AI Ê≠£Âú®ÂàÜÊûêÂ∞çË©±ÂÖßÂÆπ...\nÈÄôÂèØËÉΩÈúÄË¶Å 30-120 ÁßíÔºåË´ãËÄêÂøÉÁ≠âÂæÖ');

  try {
    const response = await callAI(`‰Ω†ÊòØ‰∏ÄÂÄãÂ∞àÊ•≠ÁöÑ Lorebook ÊèêÂèñÂ∞àÂÆ∂„ÄÇË´ãÂæû‰ª•‰∏ãÂ∞çË©±ÂäáÊÉÖ‰∏≠ÊèêÂèñÈóúÈçµ‰ø°ÊÅØÔºåÁîüÊàêÁµêÊßãÂåñÁöÑ Lorebook Ê¢ùÁõÆ„ÄÇ

„ÄêÊúÄËøë ${rangeValue} Ê¢ùÂ∞çË©±ÂÖßÂÆπ„Äë
${dialogueContent.slice(0, 10000)}

„ÄêÊèêÂèñË¶ÅÊ±Ç„Äë
1. **ÈóúÈçµË©ûË®≠Ë®à**ÔºöÁÇ∫ÊØèÂÄãÊ¢ùÁõÆË®≠ÂÆö 2-5 ÂÄãËß∏ÁôºÈóúÈçµË©ûÔºåÂåÖÊã¨Ôºö
   - ÂêçÁ®±Êú¨Ë∫´ÔºàËßíËâ≤Âêç„ÄÅÂú∞ÈªûÂêç„ÄÅÁâ©ÂìÅÂêçÁ≠âÔºâ
   - Áõ∏ÈóúÁöÑÂà•Á®±„ÄÅÁ®±Âëº
   - ÁâπÂæµË©ûÔºàÂ¶ÇÔºöÈäÄÈ´ÆÂ∞ëÂ•≥„ÄÅÁ•ûÁßòÁµÑÁπî„ÄÅÈ≠îÊ≥ïÂäçÁ≠âÔºâ

2. **ÊèêÂèñÈ°ûÂûã**Ôºö
   - ËßíËâ≤ÔºöÂßìÂêç„ÄÅË∫´‰ªΩ„ÄÅÊÄßÊ†ºÁâπÂæµ„ÄÅÂ§ñË≤åÁâπÂæµ„ÄÅËÉΩÂäõ
   - Âú∞ÈªûÔºöÂêçÁ®±„ÄÅ‰ΩçÁΩÆ„ÄÅÁâπÂæµ„ÄÅÈáçË¶ÅÊÄß
   - Áâ©ÂìÅÔºöÂêçÁ®±„ÄÅÈ°ûÂûã„ÄÅÁî®ÈÄî„ÄÅÁâπÊÆäÂ±¨ÊÄß
   - ‰∫ã‰ª∂ÔºöÈáçË¶ÅÁöÑÂäáÊÉÖËΩâÊäò„ÄÅË°ùÁ™Å„ÄÅÁßòÂØÜ
   - Ë®≠ÂÆöÔºö‰∏ñÁïåËßÄ„ÄÅË¶èÂâá„ÄÅÁµÑÁπî„ÄÅÁ≥ªÁµ±

3. **ÂÖßÂÆπË¶ÅÊ±Ç**Ôºö
   - ÊØèÂÄãÊ¢ùÁõÆÁ∞°ÊΩîÊòéÁ¢∫Ôºå50-200Â≠ó
   - ËÅöÁÑ¶Ê†∏ÂøÉ‰ø°ÊÅØÔºåÂéªÈô§Â§öÈ§òÊèèËø∞
   - Âè™ÊèêÂèñÂ∞çË©±‰∏≠ÊòéÁ¢∫ÊèêÂà∞ÁöÑ‰ø°ÊÅØÔºå‰∏çË¶ÅËÖ¶Ë£ú

4. ${extractChars ? 'Ë≠òÂà•Âá∫ÊâÄÊúâËßíËâ≤ÔºåÊ®ôË®ò isCharacter: trueÔºåÂåÖÂê´ÂÆåÊï¥ÁöÑËßíËâ≤‰ø°ÊÅØ' : '‰∏çÈúÄË¶ÅÁâπÂà•Ê®ôË®òËßíËâ≤'}
5. ${extractPlayer ? 'Ë≠òÂà•Âá∫Áé©ÂÆ∂/‰∏ªËßíÈúÄË¶ÅËøΩËπ§ÁöÑÂ±¨ÊÄßÔºàÂ¶ÇÔºöÁîüÂëΩÂÄº„ÄÅÈ´îÂäõ„ÄÅÂ•ΩÊÑüÂ∫¶Á≠âÔºâÔºåÊ®ôË®òÁÇ∫ playerAttributes' : '‰∏çÈúÄË¶ÅÊèêÂèñÁé©ÂÆ∂Â±¨ÊÄß'}

Ë´ãÁî® JSON Ê†ºÂºèËøîÂõûÔºö
\`\`\`json
{
  "entries": [
    {
      "name": "Ê¢ùÁõÆÂêçÁ®±",
      "keywords": ["ÈóúÈçµË©û1", "ÈóúÈçµË©û2"],
      "content": "Ê¢ùÁõÆÂÖßÂÆπ...",
      "isCharacter": false
    }
  ],
  "characters": [
    {
      "name": "ËßíËâ≤Âêç",
      "title": "È†≠Èäú/Ë∫´‰ªΩ",
      "avatar": "emoji",
      "description": "ËßíËâ≤ÊèèËø∞",
      "personality": "ÊÄßÊ†º"
    }
  ],
  "playerAttributes": [
    {
      "name": "Â±¨ÊÄßÂêç",
      "icon": "emoji",
      "type": "number/percent/text",
      "defaultValue": 0,
      "keywords": ["ÈóúÈçµË©û"]
    }
  ]
}
\`\`\`

Âè™ËøîÂõû JSONÔºå‰∏çË¶ÅÂÖ∂‰ªñÂÖßÂÆπ„ÄÇ`);
    
    const match = response.content.match(/```json\s*([\s\S]*?)\s*```/) || response.content.match(/\{[\s\S]*"entries"[\s\S]*\}/);
    if(!match) throw new Error('AI ËøîÂõûÊ†ºÂºèÈåØË™§');
    
    const result = JSON.parse(match[1] || match[0]);
    
    // Ê™¢Ê∏¨ÈáçË§á - Áç≤ÂèñÁèæÊúâÊï∏ÊìöÔºà‰∏çÂçÄÂàÜÂ§ßÂ∞èÂØ´ÔºåÂøΩÁï•ÂâçÂæåÁ©∫Ê†ºÔºâ
    const existingLorebook = await db.lorebook.where('storyId').equals(story.id).toArray();
    const existingChars = await db.characters.where('storyId').equals(story.id).toArray();
    let existingPanel = await db.playerPanels.where('storyId').equals(story.id).first();

    const existingLorebookNames = new Set(existingLorebook.map(l => (l.name || '').trim().toLowerCase()));
    const existingCharNames = new Set(existingChars.map(c => (c.name || '').trim().toLowerCase()));
    const existingAttrNames = new Set((existingPanel?.attributes || []).map(a => (a.name || '').trim().toLowerCase()));

    // Ê®ôË®òÈáçË§áÈ†Ö
    let totalNew = 0, totalDup = 0;

    if(result.entries?.length){
      result.entries.forEach((e, i) => {
        e._id = 'entry_' + i;
        e._isDuplicate = existingLorebookNames.has((e.name || '').trim().toLowerCase());
        e._selected = true; // ÈªòË™çÂÖ®ÈÉ®ÈÅ∏‰∏≠
        e._action = e._isDuplicate ? 'rename' : 'add'; // ÈªòË™çÔºöÈáçË§áÈ†ÖÈáçÂëΩÂêçÔºåÊñ∞È†ÖÊ∑ªÂä†
        if(e._isDuplicate) totalDup++; else totalNew++;
      });
    }

    if(result.characters?.length){
      result.characters.forEach((c, i) => {
        c._id = 'char_' + i;
        c._isDuplicate = existingCharNames.has((c.name || '').trim().toLowerCase());
        c._selected = true;
        c._action = c._isDuplicate ? 'rename' : 'add';
        if(c._isDuplicate) totalDup++; else totalNew++;
      });
    }

    if(result.playerAttributes?.length){
      result.playerAttributes.forEach((a, i) => {
        a._id = 'attr_' + i;
        a._isDuplicate = existingAttrNames.has((a.name || '').trim().toLowerCase());
        a._selected = true;
        a._action = a._isDuplicate ? 'rename' : 'add';
        if(a._isDuplicate) totalDup++; else totalNew++;
      });
    }
    
    // ‰øùÂ≠òÁµêÊûú‰æõÂæåÁ∫å‰ΩøÁî®
    window._aiLorebookResult = result;
    
    // ÊßãÂª∫È†êË¶ΩHTMLÔºàÂ∏∂ÈÅ∏ÊìáÊ°ÜÔºâ
    let previewHtml = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding:8px;background:var(--bg-tertiary);border-radius:8px">
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px">
          <input type="checkbox" id="ai-lb-select-all" onchange="toggleAiLorebookSelectAll(this.checked)" checked>
          ÂÖ®ÈÅ∏ÈùûÈáçË§áÈ†Ö
        </label>
        <div style="font-size:12px;color:var(--text-tertiary)">
          üÜï ${totalNew} Êñ∞Â¢û ¬∑ ‚ö†Ô∏è ${totalDup} ÈáçË§á
        </div>
      </div>
    `;
    
    if(result.entries?.length){
      previewHtml += `<div style="margin-bottom:8px;font-weight:600;font-size:13px">üìö Lorebook Ê¢ùÁõÆ (${result.entries.length})</div>`;
      result.entries.forEach(e => {
        const dupTag = e._isDuplicate ? '<span style="color:var(--warning);font-size:11px;margin-left:6px">‚ö†Ô∏è Â∑≤Â≠òÂú®</span>' : '<span style="color:var(--success);font-size:11px;margin-left:6px">üÜï Êñ∞Â¢û</span>';
        const actionSelect = e._isDuplicate ? `
          <select data-type="entry" data-id="${e._id}" onchange="updateAiLorebookAction(this, 'entry', '${e._id}')" style="padding:2px 6px;font-size:11px;border:1px solid var(--divider);border-radius:4px;background:var(--bg-primary)">
            <option value="rename" selected>ÈáçÂëΩÂêç</option>
            <option value="replace">Ë¶ÜËìã</option>
            <option value="skip">Ë∑≥ÈÅé</option>
          </select>
        ` : '';
        previewHtml += `
          <div style="display:flex;align-items:flex-start;gap:8px;padding:8px;border:1px solid var(--divider);border-radius:6px;margin-bottom:6px;background:${e._isDuplicate ? 'rgba(245,158,11,0.05)' : 'var(--bg-secondary)'}">
            ${e._isDuplicate ? '' : `<input type="checkbox" data-type="entry" data-id="${e._id}" ${e._selected ? 'checked' : ''} onchange="updateAiLorebookSelection()" style="margin-top:2px">`}
            <div style="flex:1;min-width:0">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px">
                <div style="font-size:13px;font-weight:500">${esc(e.name)}${dupTag}</div>
                ${actionSelect}
              </div>
              <div style="font-size:11px;color:var(--text-tertiary)">ÈóúÈçµË©û: ${(e.keywords || []).slice(0,3).join(', ')}${(e.keywords?.length > 3) ? '...' : ''}</div>
            </div>
          </div>`;
      });
    }
    
    if(result.characters?.length){
      previewHtml += `<div style="margin:12px 0 8px;font-weight:600;font-size:13px">üë• ËßíËâ≤ (${result.characters.length})</div>`;
      result.characters.forEach(c => {
        const dupTag = c._isDuplicate ? '<span style="color:var(--warning);font-size:11px;margin-left:6px">‚ö†Ô∏è Â∑≤Â≠òÂú®</span>' : '<span style="color:var(--success);font-size:11px;margin-left:6px">üÜï Êñ∞Â¢û</span>';
        const actionSelect = c._isDuplicate ? `
          <select data-type="char" data-id="${c._id}" onchange="updateAiLorebookAction(this, 'char', '${c._id}')" style="padding:2px 6px;font-size:11px;border:1px solid var(--divider);border-radius:4px;background:var(--bg-primary);margin-left:auto">
            <option value="rename" selected>ÈáçÂëΩÂêç</option>
            <option value="replace">Ë¶ÜËìã</option>
            <option value="skip">Ë∑≥ÈÅé</option>
          </select>
        ` : '';
        previewHtml += `
          <div style="display:flex;align-items:center;gap:8px;padding:8px;border:1px solid var(--divider);border-radius:6px;margin-bottom:6px;background:${c._isDuplicate ? 'rgba(245,158,11,0.05)' : 'var(--bg-secondary)'}">
            ${c._isDuplicate ? '' : `<input type="checkbox" data-type="char" data-id="${c._id}" ${c._selected ? 'checked' : ''} onchange="updateAiLorebookSelection()">`}
            <span style="font-size:18px">${c.avatar || 'üë§'}</span>
            <div style="flex:1">
              <div style="display:flex;align-items:center;gap:8px">
                <div style="font-size:13px;font-weight:500">${esc(c.name)}${dupTag}</div>
                ${actionSelect}
              </div>
              <div style="font-size:11px;color:var(--text-tertiary)">${esc(c.title || '')}</div>
            </div>
          </div>`;
      });
    }
    
    if(result.playerAttributes?.length){
      previewHtml += `<div style="margin:12px 0 8px;font-weight:600;font-size:13px">üìã Áé©ÂÆ∂Â±¨ÊÄß (${result.playerAttributes.length})</div>`;
      result.playerAttributes.forEach(a => {
        const dupTag = a._isDuplicate ? '<span style="color:var(--warning);font-size:11px;margin-left:6px">‚ö†Ô∏è Â∑≤Â≠òÂú®</span>' : '<span style="color:var(--success);font-size:11px;margin-left:6px">üÜï Êñ∞Â¢û</span>';
        const actionSelect = a._isDuplicate ? `
          <select data-type="attr" data-id="${a._id}" onchange="updateAiLorebookAction(this, 'attr', '${a._id}')" style="padding:2px 6px;font-size:11px;border:1px solid var(--divider);border-radius:4px;background:var(--bg-primary);margin-left:auto">
            <option value="rename" selected>ÈáçÂëΩÂêç</option>
            <option value="replace">Ë¶ÜËìã</option>
            <option value="skip">Ë∑≥ÈÅé</option>
          </select>
        ` : '';
        previewHtml += `
          <div style="display:flex;align-items:center;gap:8px;padding:8px;border:1px solid var(--divider);border-radius:6px;margin-bottom:6px;background:${a._isDuplicate ? 'rgba(245,158,11,0.05)' : 'var(--bg-secondary)'}">
            ${a._isDuplicate ? '' : `<input type="checkbox" data-type="attr" data-id="${a._id}" ${a._selected ? 'checked' : ''} onchange="updateAiLorebookSelection()">`}
            <span style="font-size:16px">${a.icon || 'üìä'}</span>
            <div style="flex:1">
              <div style="display:flex;align-items:center;gap:8px">
                <div style="font-size:13px;font-weight:500">${esc(a.name)}${dupTag}</div>
                ${actionSelect}
              </div>
            </div>
          </div>`;
      });
    }
    
    document.getElementById('ai-lorebook-preview-content').innerHTML = previewHtml;
    document.getElementById('ai-lorebook-preview').style.display = 'block';

    // Èö±ËóèÈÄ≤Â∫¶ÊèêÁ§∫
    hideLoading();

    // Êõ¥ÊîπÊåâÈàïÁÇ∫Á¢∫Ë™çÂ∞éÂÖ•
    btn.textContent = '‚úÖ Â∞éÂÖ•ÈÅ∏‰∏≠È†Ö';
    btn.onclick = async () => {
      await importAiLorebookResult();
    };
    btn.disabled = false;
    
  } catch(e){
    hideLoading();
    toast('ÊèêÂèñÂ§±Êïó: ' + e.message,'error');
    btn.textContent = 'ü§ñ ÈñãÂßãÊèêÂèñ';
    btn.disabled = false;
  }
}

// Êõ¥Êñ∞Êìç‰ΩúÈÅ∏ÊìáÔºàÈáçÂëΩÂêç/Ë¶ÜËìã/Ë∑≥ÈÅéÔºâ
function updateAiLorebookAction(selectEl, type, id){
  const result = window._aiLorebookResult;
  if(!result) return;

  const action = selectEl.value;
  let item;

  if(type === 'entry') item = result.entries?.find(e => e._id === id);
  else if(type === 'char') item = result.characters?.find(c => c._id === id);
  else if(type === 'attr') item = result.playerAttributes?.find(a => a._id === id);

  if(item){
    item._action = action;
    // Â¶ÇÊûúÈÅ∏Êìá"Ë∑≥ÈÅé"ÔºåËá™ÂãïÂèñÊ∂àÈÅ∏‰∏≠
    item._selected = action !== 'skip';
  }
}

// ÂÖ®ÈÅ∏/ÂèñÊ∂àÂÖ®ÈÅ∏ÔºàÂè™ÈÅ∏ÈùûÈáçË§áÈ†ÖÔºâ
function toggleAiLorebookSelectAll(checked){
  const result = window._aiLorebookResult;
  if(!result) return;

  document.querySelectorAll('#ai-lorebook-preview-content input[type="checkbox"][data-type]').forEach(cb => {
    const type = cb.dataset.type;
    const id = cb.dataset.id;
    let item;
    if(type === 'entry') item = result.entries?.find(e => e._id === id);
    else if(type === 'char') item = result.characters?.find(c => c._id === id);
    else if(type === 'attr') item = result.playerAttributes?.find(a => a._id === id);

    if(item){
      // Â¶ÇÊûúÂÖ®ÈÅ∏ÔºåÂè™ÈÅ∏ÈùûÈáçË§áÈ†ÖÔºõÂ¶ÇÊûúÂèñÊ∂àÂÖ®ÈÅ∏ÔºåÂÖ®ÈÉ®ÂèñÊ∂à
      if(checked){
        cb.checked = !item._isDuplicate;
        item._selected = !item._isDuplicate;
      } else {
        cb.checked = false;
        item._selected = false;
      }
    }
  });
  updateAiLorebookSelection();
}

// Êõ¥Êñ∞ÈÅ∏ÊìáÁãÄÊÖã
function updateAiLorebookSelection(){
  const result = window._aiLorebookResult;
  if(!result) return;
  
  document.querySelectorAll('#ai-lorebook-preview-content input[type="checkbox"][data-type]').forEach(cb => {
    const type = cb.dataset.type;
    const id = cb.dataset.id;
    if(type === 'entry'){
      const item = result.entries?.find(e => e._id === id);
      if(item) item._selected = cb.checked;
    } else if(type === 'char'){
      const item = result.characters?.find(c => c._id === id);
      if(item) item._selected = cb.checked;
    } else if(type === 'attr'){
      const item = result.playerAttributes?.find(a => a._id === id);
      if(item) item._selected = cb.checked;
    }
  });
}

async function importAiLorebookResult(){
  const result = window._aiLorebookResult;
  if(!result) return;
  let counts = { entries: 0, characters: 0, attributes: 0, replaced: 0, renamed: 0 };

  // Áç≤ÂèñÁèæÊúâÊï∏Êìö‰ª•ÊîØÊåÅË¶ÜËìãÂäüËÉΩ
  const existingLorebook = await db.lorebook.where('storyId').equals(story.id).toArray();
  const existingChars = await db.characters.where('storyId').equals(story.id).toArray();

  // Â∞éÂÖ• Lorebook Ê¢ùÁõÆ
  const selectedEntries = result.entries?.filter(e => e._selected) || [];
  if(selectedEntries.length){
    for(const e of selectedEntries){
      let name = e.name || 'Êú™ÂëΩÂêç';

      if(e._action === 'replace'){
        // Ë¶ÜËìãÔºöÊâæÂà∞ÂêåÂêçÊ¢ùÁõÆ‰∏¶Êõ¥Êñ∞
        const existing = existingLorebook.find(l => l.name.toLowerCase() === name.toLowerCase());
        if(existing){
          await db.lorebook.update(existing.id, {
            keywords: e.keywords || [name],
            content: e.content || '',
            updatedAt: Date.now()
          });
          counts.replaced++;
        }
      } else if(e._action === 'rename'){
        // ÈáçÂëΩÂêçÔºöÊ∑ªÂä†Êï∏Â≠óÂæåÁ∂¥
        let counter = 2;
        let newName = name;
        while(existingLorebook.some(l => l.name.toLowerCase() === newName.toLowerCase())){
          newName = `${name} (${counter})`;
          counter++;
        }
        await db.lorebook.put({
          id: crypto.randomUUID(),
          storyId: story.id,
          name: newName,
          keywords: e.keywords || [name],
          content: e.content || '',
          depth: 2,
          priority: 100,
          cooldown: 0,
          maxTriggers: 0,
          oneTime: false,
          conditions: [],
          conditionLogic: 'AND',
          isEnabled: true,
          triggerCount: 0,
          lastTriggered: null,
          createdAt: Date.now(),
          updatedAt: Date.now()
        });
        counts.renamed++;
      } else if(e._action === 'add'){
        // Êñ∞Â¢û
        await db.lorebook.put({
          id: crypto.randomUUID(),
          storyId: story.id,
          name,
          keywords: e.keywords || [name],
          content: e.content || '',
          depth: 2,
          priority: 100,
          cooldown: 0,
          maxTriggers: 0,
          oneTime: false,
          conditions: [],
          conditionLogic: 'AND',
          isEnabled: true,
          triggerCount: 0,
          lastTriggered: null,
          createdAt: Date.now(),
          updatedAt: Date.now()
        });
        counts.entries++;
      }
      // skip: ‰∏çÂÅö‰ªª‰Ωï‰∫ã
    }
  }
  
  // Â∞éÂÖ•ËßíËâ≤
  const selectedChars = result.characters?.filter(c => c._selected) || [];
  if(selectedChars.length){
    for(const c of selectedChars){
      let name = c.name || 'Êú™ÂëΩÂêç';

      if(c._action === 'replace'){
        // Ë¶ÜËìãÔºöÊâæÂà∞ÂêåÂêçËßíËâ≤‰∏¶Êõ¥Êñ∞
        const existing = existingChars.find(ch => ch.name.toLowerCase() === name.toLowerCase());
        if(existing){
          await db.characters.update(existing.id, {
            title: c.title || '',
            avatar: c.avatar || 'üë§',
            description: c.description || '',
            personality: c.personality || '',
            updatedAt: Date.now()
          });
          counts.replaced++;
        }
      } else if(c._action === 'rename'){
        // ÈáçÂëΩÂêçÔºöÊ∑ªÂä†Êï∏Â≠óÂæåÁ∂¥
        let counter = 2;
        let newName = name;
        while(existingChars.some(ch => ch.name.toLowerCase() === newName.toLowerCase())){
          newName = `${name} (${counter})`;
          counter++;
        }
        await db.characters.put({
          id: crypto.randomUUID(),
          storyId: story.id,
          name: newName,
          title: c.title || '',
          avatar: c.avatar || 'üë§',
          description: c.description || '',
          personality: c.personality || '',
          stats: {},
          tags: [],
          relations: [],
          mood: '',
          note: '',
          location: '',
          createdAt: Date.now(),
          updatedAt: Date.now()
        });
        counts.renamed++;
      } else if(c._action === 'add'){
        // Êñ∞Â¢û
        await db.characters.put({
          id: crypto.randomUUID(),
          storyId: story.id,
          name,
          title: c.title || '',
          avatar: c.avatar || 'üë§',
          description: c.description || '',
          personality: c.personality || '',
          stats: {},
          tags: [],
          relations: [],
          mood: '',
          note: '',
          location: '',
          createdAt: Date.now(),
          updatedAt: Date.now()
        });
        counts.characters++;
      }
      // skip: ‰∏çÂÅö‰ªª‰Ωï‰∫ã
    }
  }
  
  // Â∞éÂÖ•Áé©ÂÆ∂Â±¨ÊÄß
  const selectedAttrs = result.playerAttributes?.filter(a => a._selected) || [];
  if(selectedAttrs.length){
    let panel = await db.playerPanels.where('storyId').equals(story.id).first();

    if(!panel){
      // Â¶ÇÊûúÊ≤íÊúâÈù¢ÊùøÔºåÂâµÂª∫Êñ∞Èù¢Êùø
      const newAttrs = selectedAttrs.map(a => ({
        name: a.name || 'Êú™ÂëΩÂêç',
        icon: a.icon || 'üìä',
        type: ['number', 'percent', 'text'].includes(a.type) ? a.type : 'number',
        defaultValue: a.defaultValue ?? 0,
        maxValue: 100,
        keywords: a.keywords || [],
        group: a.group || 'default',
        color: a.color || 'default'
      }));
      const values = {};
      newAttrs.forEach(a => values[a.name] = a.defaultValue);
      panel = {
        id: crypto.randomUUID(),
        storyId: story.id,
        name: 'ÊàëÁöÑÁãÄÊÖã',
        attributes: newAttrs,
        values,
        createdAt: Date.now(),
        updatedAt: Date.now()
      };
      await db.playerPanels.put(panel);
      counts.attributes = newAttrs.length;
    } else {
      // ÊúâÈù¢ÊùøÔºåÊ†πÊìöÊìç‰ΩúËôïÁêÜÊØèÂÄãÂ±¨ÊÄß
      const existingAttrNames = (panel.attributes || []).map(a => a.name.toLowerCase());

      for(const a of selectedAttrs){
        let name = a.name || 'Êú™ÂëΩÂêç';

        if(a._action === 'replace'){
          // Ë¶ÜËìãÔºöÊâæÂà∞ÂêåÂêçÂ±¨ÊÄß‰∏¶Êõ¥Êñ∞
          const existing = panel.attributes.find(attr => attr.name.toLowerCase() === name.toLowerCase());
          if(existing){
            existing.icon = a.icon || 'üìä';
            existing.type = ['number', 'percent', 'text'].includes(a.type) ? a.type : 'number';
            existing.defaultValue = a.defaultValue ?? 0;
            existing.keywords = a.keywords || [];
            existing.group = a.group || 'default';
            existing.color = a.color || 'default';
            counts.replaced++;
          }
        } else if(a._action === 'rename'){
          // ÈáçÂëΩÂêçÔºöÊ∑ªÂä†Êï∏Â≠óÂæåÁ∂¥
          let counter = 2;
          let newName = name;
          while(panel.attributes.some(attr => attr.name.toLowerCase() === newName.toLowerCase())){
            newName = `${name} (${counter})`;
            counter++;
          }
          const newAttr = {
            name: newName,
            icon: a.icon || 'üìä',
            type: ['number', 'percent', 'text'].includes(a.type) ? a.type : 'number',
            defaultValue: a.defaultValue ?? 0,
            maxValue: 100,
            keywords: a.keywords || [],
            group: a.group || 'default',
            color: a.color || 'default'
          };
          panel.attributes.push(newAttr);
          panel.values[newName] = newAttr.defaultValue;
          counts.renamed++;
        } else if(a._action === 'add'){
          // Êñ∞Â¢û
          const newAttr = {
            name,
            icon: a.icon || 'üìä',
            type: ['number', 'percent', 'text'].includes(a.type) ? a.type : 'number',
            defaultValue: a.defaultValue ?? 0,
            maxValue: 100,
            keywords: a.keywords || [],
            group: a.group || 'default',
            color: a.color || 'default'
          };
          panel.attributes.push(newAttr);
          panel.values[name] = newAttr.defaultValue;
          counts.attributes++;
        }
        // skip: ‰∏çÂÅö‰ªª‰Ωï‰∫ã
      }

      panel.updatedAt = Date.now();
      await db.playerPanels.put(panel);
    }
  }
  
  // Ê∏ÖÁêÜËá®ÊôÇÊï∏Êìö
  delete window._aiLorebookResult;
  
  closeModal('ai-lorebook-modal');
  
  // ÈáçÁΩÆÊåâÈàïÁãÄÊÖã
  const btn = document.getElementById('ai-lorebook-generate-btn');
  btn.textContent = 'ü§ñ ÈñãÂßãÊèêÂèñ';
  btn.onclick = generateAiLorebook;
  document.getElementById('ai-lorebook-preview').style.display = 'none';
  
  let msg = T('Â∞éÂÖ•ÂÆåÊàêÔºÅ');
  const totalNew = counts.entries + counts.characters + counts.attributes;
  if(totalNew > 0) msg += ` ${totalNew} ÂÄãÊñ∞È†Ö`;
  if(counts.replaced > 0) msg += ` ${counts.replaced} ÂÄãË¶ÜËìã`;
  if(counts.renamed > 0) msg += ` ${counts.renamed} ÂÄãÈáçÂëΩÂêç`;

  toast(msg, 'success');
  renderLorebook();
}

// Áç≤ÂèñÁï∂ÂâçÂ†¥ÊôØÁöÑËßíËâ≤‰ø°ÊÅØÔºàÁî®Êñº System PromptÔºâ
async function getActiveScenePrompt(){
  if(!story) return '';
  
  const activeScene = await db.scenes.where('storyId').equals(story.id).filter(s => s.isActive).first();
  if(!activeScene || !activeScene.characterIds?.length) return '';
  
  let prompt = `\n\n### Áï∂ÂâçÂ†¥ÊôØÔºö${activeScene.name}\n`;
  if(activeScene.description){
    prompt += `${activeScene.description}\n\n`;
  }
  prompt += `Âú®Â†¥ËßíËâ≤Ôºö\n`;
  
  for(const cid of activeScene.characterIds){
    const char = await db.characters.get(cid);
    if(char){
      prompt += `- **${char.name}**`;
      if(char.title) prompt += `Ôºà${char.title}Ôºâ`;
      if(char.mood) prompt += ` [Áï∂ÂâçÊÉÖÁ∑íÔºö${char.mood}]`;
      prompt += '\n';
    }
  }
  
  prompt += `\nË´ãËÆìÈÄô‰∫õÂú®Â†¥ÁöÑËßíËâ≤Ê†πÊìöÂêÑËá™ÁöÑÊÄßÊ†ºÂíåÈóú‰øÇÈÄ≤Ë°å‰∫íÂãïÔºåÂèØ‰ª•ÊúâÂ∞çË©±„ÄÅÂãï‰Ωú„ÄÅË°®ÊÉÖÁ≠â„ÄÇ\n`;
  
  return prompt;
}

// È°ØÁ§∫ËßíËâ≤Ë©≥ÊÉÖ
async function showCharDetail(charId){
  currentCharacterId = charId;
  const char = await db.characters.get(charId);
  if(!char){toast(T('ËßíËâ≤‰∏çÂ≠òÂú®'),'error');return;}
  
  document.getElementById('char-detail-title').textContent = char.name + ' Ë©≥ÊÉÖ';
  
  // ÂàÜÈ°ûÊ®ôÁ±§
  const categoryLabels = {
    'protagonist': '‚≠ê ‰∏ªËßí',
    'supporting': 'üë§ ÈÖçËßí',
    'npc': 'üë• NPC'
  };
  const categoryLabel = categoryLabels[char.category] || 'üë§ ÈÖçËßí';
  
  let html = `
    <div style="text-align:center;margin-bottom:16px">
      <div style="width:64px;height:64px;border-radius:16px;background:linear-gradient(135deg,var(--primary),var(--primary-light));display:inline-flex;align-items:center;justify-content:center;font-size:32px;background-size:cover;background-position:center;overflow:hidden">${char.avatarImage ? `<img src="${char.avatarImage}" style="width:100%;height:100%;object-fit:cover">` : (char.avatar||'üë§')}</div>
      <div style="font-size:18px;font-weight:600;margin-top:8px">${esc(char.name)}</div>
      ${char.title?`<div style="font-size:13px;color:var(--text-secondary)">${esc(char.title)}</div>`:''}
      <div style="font-size:11px;color:var(--primary);margin-top:4px">${categoryLabel}</div>
    </div>
  `;
  
  // ÊÄßÊ†º
  if(char.personality){
    html += `<div style="font-size:12px;color:var(--text-tertiary);margin-bottom:4px">üé≠ ÊÄßÊ†º</div>`;
    html += `<div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px;padding:10px;background:var(--bg-tertiary);border-radius:8px">${esc(char.personality)}</div>`;
  }
  
  // ÊèèËø∞
  if(char.description){
    html += `<div style="font-size:12px;color:var(--text-tertiary);margin-bottom:4px">üìù ÊèèËø∞</div>`;
    html += `<div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px;padding:10px;background:var(--bg-tertiary);border-radius:8px;max-height:120px;overflow-y:auto">${esc(char.description)}</div>`;
  }
  
  // Â±¨ÊÄß
  if(char.stats && Object.keys(char.stats).length){
    html += `<div style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">üìä Â±¨ÊÄß</div>`;
    html += `<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:12px">`;
    for(const [k,v] of Object.entries(char.stats)){
      html += `<div style="background:var(--bg-tertiary);padding:8px;border-radius:6px;font-size:13px"><span style="color:var(--text-secondary)">${esc(k)}:</span> <strong>${esc(String(v))}</strong></div>`;
    }
    html += `</div>`;
  }
  
  // Ê®ôÁ±§
  if(char.tags && char.tags.length){
    html += `<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px">${char.tags.map(t=>`<span style="font-size:11px;padding:4px 8px;background:var(--bg-tertiary);border-radius:8px">${esc(t)}</span>`).join('')}</div>`;
  }
  
  // v25: Èóú‰øÇ‰ø°ÊÅØ
  if(char.relationships && char.relationships.length){
    html += `<div style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">üë• Èóú‰øÇ</div>`;
    html += `<div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px">`;
    char.relationships.forEach(rel => {
      const typeInfo = RELATIONSHIP_TYPES.find(t => t.code === rel.type);
      const icon = typeInfo ? typeInfo.icon : 'üîó';
      const color = typeInfo ? typeInfo.color : '#888';
      html += `
        <div style="background:var(--bg-tertiary);padding:8px 10px;border-radius:6px;font-size:13px;display:flex;align-items:center;gap:8px">
          <span style="font-size:14px">${icon}</span>
          <span style="color:var(--text-secondary)">${esc(rel.targetName || 'Êú™Áü•ËßíËâ≤')}</span>
          <span style="color:${color};font-weight:500">${esc(rel.label || rel.type)}</span>
          ${rel.mutual ? '<span style="font-size:10px;color:var(--text-tertiary)">‚ÜîÔ∏è</span>' : ''}
        </div>
      `;
    });
    html += `</div>`;
  }
  
  // v25: Ë°®ÊÉÖÈ†êË¶Ω
  if(char.expressions && char.expressions.length){
    html += `<div style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">üé® Ë°®ÊÉÖÔºà${char.expressionMode === 'auto' ? 'AIËá™ÂãïÂàáÊèõ' : 'ÊâãÂãïÂàáÊèõ'}Ôºâ</div>`;
    html += `<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px">`;
    char.expressions.forEach(expr => {
      const isDefault = expr.isDefault ? 'border:2px solid var(--success);' : '';
      html += `
        <div style="text-align:center">
          <img src="${expr.image}" style="width:50px;height:50px;border-radius:8px;object-fit:cover;${isDefault}">
          <div style="font-size:10px;color:var(--text-secondary);margin-top:2px">${esc(expr.name)}</div>
        </div>
      `;
    });
    html += `</div>`;
  }
  
  // V2 Â≠óÊÆµÊëòË¶ÅÔºàÂ¶ÇÊûúÊúâÔºâ
  let v2Features = [];
  if(char.first_mes) v2Features.push('ÈñãÂ†¥ÁôΩ');
  if(char.alternate_greetings?.length) v2Features.push(`${char.alternate_greetings.length}ÂÄãÊõø‰ª£ÈñãÂ†¥ÁôΩ`);
  if(char.mes_example) v2Features.push('Â∞çË©±Á§∫‰æã');
  if(char.system_prompt) v2Features.push('Â∞àÂ±¨Á≥ªÁµ±ÊèêÁ§∫');
  if(char.character_book?.entries?.length) v2Features.push(`${char.character_book.entries.length}ÂÄãLorebookÊ¢ùÁõÆ`);
  if(char.relationships?.length) v2Features.push(`${char.relationships.length}ÂÄãÈóú‰øÇ`);
  if(char.expressions?.length) v2Features.push(`${char.expressions.length}ÂÄãË°®ÊÉÖ`);
  
  if(v2Features.length){
    html += `<div style="font-size:11px;color:var(--primary);background:rgba(139,124,247,.1);padding:8px 10px;border-radius:6px;margin-bottom:12px">‚ú® ÂåÖÂê´Ôºö${v2Features.join('„ÄÅ')}</div>`;
  }
  
  // Ââµ‰ΩúËÄÖ‰ø°ÊÅØ
  if(char.creator || char.character_version){
    html += `<div style="font-size:11px;color:var(--text-tertiary);margin-bottom:4px">`;
    if(char.creator) html += `Ââµ‰ΩúËÄÖ: ${esc(char.creator)} `;
    if(char.character_version) html += `v${esc(char.character_version)}`;
    html += `</div>`;
  }
  
  html += `<div style="font-size:11px;color:var(--text-tertiary);text-align:right">Êõ¥Êñ∞Êñº ${fmtDate(char.updatedAt)}</div>`;
  
  document.getElementById('char-detail-content').innerHTML = html;
  showModal('char-detail-modal');
}

// Á∑®ËºØËßíËâ≤ÔºàË∑≥ËΩâÂà∞Ê∑ªÂä†È†ÅÈù¢‰∏¶Â°´ÂÖÖÊï∏ÊìöÔºâ
async function editCharacter(){
  try {
    if(!currentCharacterId) {
      return;
    }
    const char = await db.characters.get(currentCharacterId);
    if(!char) {
      toast(T('Êâæ‰∏çÂà∞ËßíËâ≤Êï∏Êìö'), 'error');
      return;
    }
    
    // Âè™ÈóúÈñâË©≥ÊÉÖÊ®°ÊÖãÊ°ÜÔºå‰∏çÁßªÈô§overlay
    document.getElementById('char-detail-modal').classList.remove('active');
    
    // Ë®≠ÁΩÆÁ∑®ËºØÊ®°Âºè
    editingCharacterId = currentCharacterId;
    
    // ÂÆâÂÖ®Ë®≠ÁΩÆÂÄºÁöÑËºîÂä©ÂáΩÊï∏
    const setVal = (id, val) => {
      const el = document.getElementById(id);
      if(el) el.value = val;
    };
    
    // Â°´ÂÖÖÂü∫Êú¨‰ø°ÊÅØ
    setVal('char-add-name', char.name || '');
    setVal('char-add-title', char.title || '');
    setVal('char-add-avatar', char.avatar || '');
    setVal('char-add-category', char.category || 'supporting');
    setVal('char-add-desc', char.description || '');
    setVal('char-add-personality', char.personality || '');
    setVal('char-add-tags', (char.tags || []).join(', '));
    
    // ËôïÁêÜÈ†≠ÂÉèÂúñÁâá
    tempCharAvatarImage = null; // ÈáçÁΩÆËá®ÊôÇÂúñÁâá
    const avatarPreview = document.getElementById('char-avatar-preview');
    const avatarImg = document.getElementById('char-avatar-img');
    if(char.avatarImage && avatarPreview && avatarImg) {
      avatarPreview.style.display = 'block';
      avatarImg.src = char.avatarImage;
      tempCharAvatarImage = char.avatarImage; // ‰øùÁïôÂéüÂúñÁâá
    } else if(avatarPreview) {
      avatarPreview.style.display = 'none';
    };
    
    // Â°´ÂÖÖÂ∞çË©±Ë®≠ÁΩÆ
    setVal('char-add-firstmes', char.first_mes || '');
    setVal('char-add-scenario', char.scenario || '');
    setVal('char-add-example', char.mes_example || '');
    
    // Êõø‰ª£ÈñãÂ†¥ÁôΩ
    charAltGreetings = char.alternate_greetings || [];
    renderAltGreetings();
    
    // Â°´ÂÖÖÈ´òÁ¥öË®≠ÁΩÆ
    setVal('char-add-sysprompt', char.system_prompt || '');
    setVal('char-add-posthistory', char.post_history_instructions || '');
    setVal('char-add-creatornotes', char.creator_notes || '');
    setVal('char-add-creator', char.creator || '');
    setVal('char-add-version', char.character_version || '1.0');
    
    // Lorebook
    if(char.character_book){
      setVal('char-add-lore-trigger', char.character_book.triggerMode || 'scene');
      charLorebookEntries = char.character_book.entries || [];
    } else {
      setVal('char-add-lore-trigger', 'scene');
      charLorebookEntries = [];
    }
    renderCharLorebookEntries();
    
    // v25: Èóú‰øÇÊï∏Êìö
    charRelationships = char.relationships || [];
    renderCharRelationships();
    
    // v25: Ë°®ÊÉÖÊï∏Êìö
    charExpressions = char.expressions || [];
    setVal('char-add-expr-mode', char.expressionMode || 'manual');
    renderCharExpressions();
    
    // Â±¨ÊÄß
    if(char.stats && Object.keys(char.stats).length > 0){
      setVal('char-add-stats', Object.entries(char.stats).map(([k,v])=>`${k}:${v}`).join('\n'));
    } else {
      setVal('char-add-stats', '');
    }
    
    // Êõ¥Êñ∞Ê®ôÈ°å
    const titleEl = document.getElementById('char-modal-title');
    if(titleEl) titleEl.textContent = '‚úèÔ∏è Á∑®ËºØËßíËâ≤';
    
    // ÈáçÁΩÆÈù¢ÊùøÁãÄÊÖãÔºàÂè™Â±ïÈñãÂü∫Êú¨‰ø°ÊÅØÔºâ
    document.querySelectorAll('.char-panel').forEach(p => {
      const panel = p.dataset.panel;
      const content = p.querySelector('.char-panel-content');
      const arrow = p.querySelector('.char-panel-arrow');
      if(content && arrow){
        if(panel === 'basic'){
          content.style.display = 'block';
          arrow.textContent = '‚ñº';
          p.classList.add('expanded');
        } else {
          content.style.display = 'none';
          arrow.textContent = '‚ñ∂';
          p.classList.remove('expanded');
        }
      }
    });
    
    updateCharTokenCount();
    
    // Á¢∫‰øùoverlayÊòØactiveÁöÑÔºåÁÑ∂ÂæåÁõ¥Êé•ÊâìÈñãÁ∑®ËºØÊ®°ÊÖãÊ°Ü
    document.getElementById('overlay').classList.add('active');
    document.getElementById('char-add-modal').classList.add('active');
  } catch(err) {
    console.error('editCharacter error:', err);
    toast(T('Á∑®ËºØËßíËâ≤ÊôÇÂá∫ÈåØ: ') + err.message, 'error');
  }
}

// Âà™Èô§ËßíËâ≤
async function deleteCharacter(){
  if(!currentCharacterId) return;
  if(!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãËßíËâ≤ÂóéÔºü')) return;

  // Âà™Èô§ËßíËâ≤Êú¨Ë∫´
  await db.characters.delete(currentCharacterId);
  // Âà™Èô§ËßíËâ≤Ê≠∑Âè≤Ë®òÈåÑ
  await db.characterHistory.where('characterId').equals(currentCharacterId).delete();
  // Âà™Èô§ËßíËâ≤Âø´ÁÖß
  await db.characterSnapshots.where('characterId').equals(currentCharacterId).delete();
  // Âà™Èô§ËßíËâ≤ÁãÄÊÖã
  await db.characterStates.where('characterId').equals(currentCharacterId).delete();
  closeModal('char-detail-modal');
  currentCharacterId = null;
  renderCharacters();
  toast(T('ËßíËâ≤Â∑≤Âà™Èô§'),'success');
}

// È°ØÁ§∫ËßíËâ≤Ê≠∑Âè≤
async function showCharHistory(charId){
  const history = await db.characterHistory.where('characterId').equals(charId).reverse().toArray();
  const char = await db.characters.get(charId);
  
  let html = '';
  if(!history.length){
    html = '<div style="text-align:center;padding:20px;color:var(--text-secondary)">Êö´ÁÑ°Â±¨ÊÄßËÆäÂåñË®òÈåÑ</div>';
  }else{
    html = history.map(h => {
      const changeHtml = h.changes.map(c => {
        const diff = (parseInt(c.to)||0) - (parseInt(c.from)||0);
        const color = diff > 0 ? 'var(--success)' : diff < 0 ? 'var(--error)' : 'var(--text-secondary)';
        const arrow = diff > 0 ? '‚Üë' : diff < 0 ? '‚Üì' : '‚Üí';
        return `<span style="display:inline-block;margin:2px 4px;padding:2px 6px;background:var(--bg-tertiary);border-radius:4px;font-size:11px">${esc(c.attr)}: ${c.from} <span style="color:${color}">${arrow} ${c.to}</span></span>`;
      }).join('');
      return `<div style="padding:10px;border-bottom:1px solid var(--divider)">
        <div style="font-size:11px;color:var(--text-tertiary);margin-bottom:4px">${fmtDate(h.createdAt)}</div>
        <div>${changeHtml}</div>
      </div>`;
    }).join('');
  }
  
  document.getElementById('char-history-content').innerHTML = html;
  showModal('char-history-modal');
}

// Âú®Â£ìÁ∏ÆË®òÊÜ∂Ââç‰øùÂ≠òËßíËâ≤Âø´ÁÖß
async function saveCharacterSnapshot(){
  if(!story) return;
  const chars = await db.characters.where('storyId').equals(story.id).toArray();
  if(!chars.length) return;
  
  await db.characterSnapshots.add({
    id: crypto.randomUUID(),
    storyId: story.id,
    characters: chars,
    messageCount: msgs.length,
    createdAt: Date.now()
  });
}

// È°ØÁ§∫Êï∏ÂÄºËÆäÂåñÂãïÁï´
function showValueChange(element, value, isUp){
  const rect = element.getBoundingClientRect();
  const change = document.createElement('div');
  change.className = 'char-value-change ' + (isUp ? 'up' : 'down');
  change.textContent = (isUp ? '+' : '') + value + (isUp ? ' ‚Üë' : ' ‚Üì');
  change.style.left = rect.left + 'px';
  change.style.top = rect.top + 'px';
  document.body.appendChild(change);
  setTimeout(() => change.remove(), 1500);
}

// Âú®goToÂáΩÊï∏‰∏≠Ê∑ªÂä†ËßíËâ≤Ë¶ñÂúñÁöÑÊ∏≤Êüì
const originalGoTo = typeof goTo === 'function' ? goTo : null;

// Êï∏ÊìöÂ∞éÂÖ•Â∞éÂá∫
async function exportAll(){
  showLoading('Â∞éÂá∫‰∏≠...');
  try{
    const data={
      version:'6.1',
      exportedAt:Date.now(),
      stories:await db.stories.toArray(),
      messages:await db.messages.toArray(),
      branches:await db.branches.toArray(),
      instructions:await db.instructions.toArray(),
      storyInstructions:await db.storyInstructions.toArray(),
      loreEntries:await db.loreEntries.toArray(),
      foreshadowing:await db.foreshadowing.toArray(),
      events:await db.events.toArray(),
      saves:await db.saves.toArray(),
      apiPresets:await db.apiPresets.toArray(),
      settings:await db.settings.toArray(),
      timeline:await db.timeline.toArray(),
      chapters:await db.chapters.toArray(),
      bookmarks:await db.bookmarks.toArray(),
      plotTags:await db.plotTags.toArray(),
      characters:await db.characters.toArray(),
      characterSnapshots:await db.characterSnapshots.toArray(),
      characterHistory:await db.characterHistory.toArray(),
      lorebook:await db.lorebook.toArray(),
      lorebookTriggerLog:await db.lorebookTriggerLog.toArray(),
      // v16 Êñ∞Â¢û
      quickCommands:await db.quickCommands.toArray(),
      scenes:await db.scenes.toArray(),
      // v22 Êñ∞Â¢û
      personas:await db.personas.toArray(),
      playerPanels:await db.playerPanels.toArray(),
      // Ë£úÂÖÖÈÅ∫ÊºèÁöÑË°®
      characterStates:await db.characterStates.toArray()
    };
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;a.download=`zhimeng_backup_${new Date().toISOString().slice(0,10)}.json`;a.click();
    URL.revokeObjectURL(url);
    toast(T('Êï∏ÊìöÂ∞éÂá∫ÊàêÂäüÔºÅ'),'success');
  }catch(e){toast('Â∞éÂá∫Â§±Êïó: '+e.message,'error');}
  hideLoading();
}

// v24: Â∞éÂá∫Êõ∏Á±çÊ†ºÂºèÊ®°ÊùøÔºàÂ∏∂Ë©≥Á¥∞Ê≥®ÈáãÔºâ
function exportBookTemplate(){
  const template = {
    "_Ë™™Êòé": "ÈÄôÊòØÁπîÂ§¢ v6.1 ÁöÑÂÆåÊï¥Êõ∏Á±çJSONÊ†ºÂºèÊ®°Êùø„ÄÇË´ãÊ†πÊìöÊ≠§Ê®°ÊùøË£Ω‰ΩúÊõ∏Á±çÊï∏ÊìöÔºåÊâÄÊúâÊ®ôË®òÁÇ∫„ÄåÂøÖÂ°´„ÄçÁöÑÂ≠óÊÆµÈÉΩÂøÖÈ†àÊèê‰æõ„ÄÇ",
    "_ÁâàÊú¨": "6.1",
    "_Â∞éÂá∫ÊôÇÈñì": "ISOÊ†ºÂºèÊôÇÈñìÊà≥ÔºåÂ¶Ç 2024-01-01T12:00:00.000Z",

    "story": {
      "_Ë™™Êòé": "ÊïÖ‰∫ãÂü∫Êú¨‰ø°ÊÅØ",
      "id": "Â≠óÁ¨¶‰∏≤ - ÂîØ‰∏ÄIDÔºàÂª∫Ë≠∞‰ΩøÁî®UUIDÊ†ºÂºèÔºåÂ¶Ç 'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'Ôºâ„ÄêÂøÖÂ°´„Äë",
      "title": "Â≠óÁ¨¶‰∏≤ - ÊïÖ‰∫ãÊ®ôÈ°å„ÄêÂøÖÂ°´„Äë",
      "icon": "Â≠óÁ¨¶‰∏≤ - emojiÂúñÊ®ôÔºåÂ¶Ç 'üìñ'„ÄêÂèØÈÅ∏„Äë",
      "description": "Â≠óÁ¨¶‰∏≤ - ÊïÖ‰∫ãÁ∞°‰ªã„ÄêÂèØÈÅ∏„Äë",
      "systemPrompt": "Â≠óÁ¨¶‰∏≤ - Á≥ªÁµ±ÊèêÁ§∫Ë©û/ÊïÖ‰∫ãË®≠ÂÆö„ÄêÂª∫Ë≠∞Â°´ÂØ´„Äë",
      "mode": "Â≠óÁ¨¶‰∏≤ - Ê®°ÂºèÔºö'normal'ÔºàÊôÆÈÄöÔºâÊàñ 'simulation'ÔºàÁ∂ìÁáüÔºâ„ÄêÂøÖÂ°´ÔºåÈªòË™ç 'normal'„Äë",
      "currentBranchId": "Â≠óÁ¨¶‰∏≤ - Áï∂ÂâçÂàÜÊîØIDÔºàÈªòË™ç‰ΩøÁî® 'main'Ôºâ„ÄêÂøÖÂ°´„Äë",
      "currentMessageId": "Â≠óÁ¨¶‰∏≤ - Áï∂ÂâçÊ∂àÊÅØID„ÄêÂèØÈÅ∏„Äë",
      "preview": "Â≠óÁ¨¶‰∏≤ - È†êË¶ΩÊñáÂ≠óÔºàÊúÄËøë‰∏ÄÊ¢ùAIÂõûË¶ÜÁöÑÂâç100Â≠óÔºâ„ÄêÂèØÈÅ∏„Äë",
      "wordCount": "Êï∏Â≠ó - Á∏ΩÂ≠óÊï∏„ÄêÂèØÈÅ∏ÔºåÈªòË™ç0„Äë",
      "messageCount": "Êï∏Â≠ó - Ê∂àÊÅØÊï∏Èáè„ÄêÂèØÈÅ∏ÔºåÈªòË™ç0„Äë",
      "createdAt": "Êï∏Â≠ó - ÂâµÂª∫ÊôÇÈñìÊà≥ÔºàÊØ´ÁßíÔºâ„ÄêÂøÖÂ°´„Äë",
      "updatedAt": "Êï∏Â≠ó - Êõ¥Êñ∞ÊôÇÈñìÊà≥ÔºàÊØ´ÁßíÔºâ„ÄêÂøÖÂ°´„Äë",
      "storyTime": "Â≠óÁ¨¶‰∏≤ - ÊïÖ‰∫ãÂÖßÊôÇÈñìÔºåÂ¶Ç 'Á¨¨‰∏âÂ§© ‰∏äÂçà'„ÄêÂèØÈÅ∏„Äë",
      "inventory": "Êï∏ÁµÑ - ËÉåÂåÖÁâ©ÂìÅÂàóË°®„ÄêÂèØÈÅ∏„Äë",
      "draft": "Â≠óÁ¨¶‰∏≤ - ËçâÁ®øÂÖßÂÆπ„ÄêÂèØÈÅ∏„Äë",
      "_Á∂ìÁáüÊ®°ÂºèÂ∞àÁî®Â≠óÊÆµ": {
        "simDay": "Êï∏Â≠ó - Á∂ìÁáüÊ®°ÂºèÁ¨¨ÂπæÂ§©„ÄêÁ∂ìÁáüÊ®°ÂºèÂèØÁî®„Äë",
        "simResources": "Êï∏ÁµÑ - Ë≥áÊ∫êÂàóË°®ÔºåÊ†ºÂºèÔºö[{name:'Ë≥áÊ∫êÂêç',icon:'üìä',value:100,max:1000}]„ÄêÁ∂ìÁáüÊ®°ÂºèÂèØÁî®„Äë"
      }
    },

    "messages": [
      {
        "_Ë™™Êòé": "Â∞çË©±Ê∂àÊÅØÂàóË°®ÔºàÊïÖ‰∫ãÂäáÊÉÖÔºâ",
        "id": "Â≠óÁ¨¶‰∏≤ - ÂîØ‰∏ÄIDÔºàUUIDÊ†ºÂºèÔºâ„ÄêÂøÖÂ°´„Äë",
        "storyId": "Â≠óÁ¨¶‰∏≤ - ÊâÄÂ±¨ÊïÖ‰∫ãID„ÄêÂøÖÂ°´„Äë",
        "branchId": "Â≠óÁ¨¶‰∏≤ - ÊâÄÂ±¨ÂàÜÊîØID„ÄêÂøÖÂ°´„Äë",
        "role": "Â≠óÁ¨¶‰∏≤ - 'user'ÔºàÁé©ÂÆ∂ÔºâÊàñ 'assistant'ÔºàAIÔºâ„ÄêÂøÖÂ°´„Äë",
        "content": "Â≠óÁ¨¶‰∏≤ - Ê∂àÊÅØÂÖßÂÆπ„ÄêÂøÖÂ°´„Äë",
        "tokens": "Êï∏Â≠ó - tokenÊï∏Èáè„ÄêÂèØÈÅ∏„Äë",
        "createdAt": "Êï∏Â≠ó - ÂâµÂª∫ÊôÇÈñìÊà≥ÔºàÊØ´ÁßíÔºâ„ÄêÂøÖÂ°´„Äë",
        "storyTime": "Â≠óÁ¨¶‰∏≤ - ÊïÖ‰∫ãÂÖßÊôÇÈñì„ÄêÂèØÈÅ∏„Äë",
        "isImportant": "Â∏ÉÁàæÂÄº - ÊòØÂê¶Ê®ôË®òÁÇ∫ÈáçË¶ÅË®òÊÜ∂„ÄêÂèØÈÅ∏ÔºåÈªòË™çfalse„Äë"
      }
    ],

    "branches": [
      {
        "_Ë™™Êòé": "ÂàÜÊîØÁÆ°ÁêÜÔºàÂπ≥Ë°å‰∏ñÁïåÁ∑öÔºâ",
        "id": "Â≠óÁ¨¶‰∏≤ - ÂàÜÊîØIDÔºàÈªòË™çÂàÜÊîØÁî® 'main'Ôºâ„ÄêÂøÖÂ°´„Äë",
        "storyId": "Â≠óÁ¨¶‰∏≤ - ÊâÄÂ±¨ÊïÖ‰∫ãID„ÄêÂøÖÂ°´„Äë",
        "name": "Â≠óÁ¨¶‰∏≤ - ÂàÜÊîØÂêçÁ®±„ÄêÂøÖÂ°´„Äë",
        "description": "Â≠óÁ¨¶‰∏≤ - ÂàÜÊîØÊèèËø∞„ÄêÂèØÈÅ∏„Äë",
        "parentId": "Â≠óÁ¨¶‰∏≤ - Áà∂ÂàÜÊîØID„ÄêÂèØÈÅ∏„Äë",
        "createdAt": "Êï∏Â≠ó - ÂâµÂª∫ÊôÇÈñìÊà≥ÔºàÊØ´ÁßíÔºâ„ÄêÂøÖÂ°´„Äë"
      }
    ],

    "characters": [
      {
        "_Ë™™Êòé": "ËßíËâ≤Á≥ªÁµ±ÔºàÊîØÊåÅ Character Card V2 Ê†ºÂºèÔºâ",
        "id": "Â≠óÁ¨¶‰∏≤ - ÂîØ‰∏ÄIDÔºàUUIDÔºâ„ÄêÂøÖÂ°´„Äë",
        "storyId": "Â≠óÁ¨¶‰∏≤ - ÊâÄÂ±¨ÊïÖ‰∫ãID„ÄêÂøÖÂ°´„Äë",
        "name": "Â≠óÁ¨¶‰∏≤ - ËßíËâ≤ÂêçÁ®±„ÄêÂøÖÂ°´„Äë",
        "avatar": "Â≠óÁ¨¶‰∏≤ - emojiÈ†≠ÂÉèÔºåÂ¶Ç 'üë§'„ÄêÂèØÈÅ∏„Äë",
        "avatarImage": "Â≠óÁ¨¶‰∏≤ - È†≠ÂÉèÂúñÁâáURLÔºàbase64ÊàñÁ∂≤ÂùÄÔºâ„ÄêÂèØÈÅ∏„Äë",
        "title": "Â≠óÁ¨¶‰∏≤ - Ë∫´‰ªΩ/Á®±Ëôü„ÄêÂèØÈÅ∏„Äë",
        "category": "Â≠óÁ¨¶‰∏≤ - È°ûÂà•Ôºö'protagonist'Ôºà‰∏ªËßíÔºâ„ÄÅ'supporting'ÔºàÈÖçËßíÔºâ„ÄÅ'npc'„ÄêÂèØÈÅ∏ÔºåÈªòË™ç'supporting'„Äë",
        "description": "Â≠óÁ¨¶‰∏≤ - ËßíËâ≤ÊèèËø∞„ÄêÂèØÈÅ∏„Äë",
        "personality": "Â≠óÁ¨¶‰∏≤ - ÊÄßÊ†ºÁâπÈªû„ÄêÂèØÈÅ∏„Äë",
        "scenario": "Â≠óÁ¨¶‰∏≤ - Â†¥ÊôØÊèèËø∞„ÄêÂèØÈÅ∏„Äë",
        "first_mes": "Â≠óÁ¨¶‰∏≤ - ÈñãÂ†¥ÁôΩ„ÄêÂèØÈÅ∏„Äë",
        "mes_example": "Â≠óÁ¨¶‰∏≤ - Â∞çË©±Á§∫‰æãÔºàÁî®<START>ÂàÜÈöîÔºâ„ÄêÂèØÈÅ∏„Äë",
        "system_prompt": "Â≠óÁ¨¶‰∏≤ - ËßíËâ≤Â∞àÂ±¨Á≥ªÁµ±ÊèêÁ§∫„ÄêÂèØÈÅ∏„Äë",
        "post_history_instructions": "Â≠óÁ¨¶‰∏≤ - Ê≠∑Âè≤ÂæåÊåá‰ª§„ÄêÂèØÈÅ∏„Äë",
        "creator_notes": "Â≠óÁ¨¶‰∏≤ - Ââµ‰ΩúËÄÖÂÇôË®ª„ÄêÂèØÈÅ∏„Äë",
        "creator": "Â≠óÁ¨¶‰∏≤ - Ââµ‰ΩúËÄÖÂêçÁ®±„ÄêÂèØÈÅ∏„Äë",
        "character_version": "Â≠óÁ¨¶‰∏≤ - ËßíËâ≤Âç°ÁâàÊú¨Ëôü„ÄêÂèØÈÅ∏„Äë",
        "alternate_greetings": "Êï∏ÁµÑ - Êõø‰ª£ÈñãÂ†¥ÁôΩÂàóË°®„ÄêÂèØÈÅ∏„Äë",
        "tags": "Êï∏ÁµÑ - Ê®ôÁ±§ÂàóË°®ÔºåÂ¶Ç ['ÂèãÂ•Ω','ÈáçË¶Å']„ÄêÂèØÈÅ∏„Äë",
        "stats": "Â∞çË±° - Áï∂ÂâçÂ±¨ÊÄßÂÄºÔºåÂ¶Ç {\"Â•ΩÊÑü\":50,\"Âø†Ë™†\":80}„ÄêÂèØÈÅ∏„Äë",
        "initialStats": "Â∞çË±° - ÂàùÂßãÂ±¨ÊÄßÂÄº„ÄêÂèØÈÅ∏„Äë",
        "relationships": "Êï∏ÁµÑ - Èóú‰øÇÂàóË°®ÔºåÊ†ºÂºèÔºö[{type:'friend',targetName:'ÊüêËßíËâ≤',label:'Â•ΩÂèã',mutual:true}]„ÄêÂèØÈÅ∏„Äë",
        "expressions": "Êï∏ÁµÑ - Ë°®ÊÉÖÁ´ãÁπ™ÂàóË°®„ÄêÂèØÈÅ∏„Äë",
        "expressionMode": "Â≠óÁ¨¶‰∏≤ - 'auto'ÔºàAIËá™ÂãïÔºâÊàñ 'manual'ÔºàÊâãÂãïÔºâ„ÄêÂèØÈÅ∏„Äë",
        "character_book": "Â∞çË±° - ËßíËâ≤Â∞àÂ±¨Lorebook„ÄêÂèØÈÅ∏„Äë",
        "createdAt": "Êï∏Â≠ó - ÂâµÂª∫ÊôÇÈñìÊà≥ÔºàÊØ´ÁßíÔºâ„ÄêÂøÖÂ°´„Äë",
        "updatedAt": "Êï∏Â≠ó - Êõ¥Êñ∞ÊôÇÈñìÊà≥ÔºàÊØ´ÁßíÔºâ„ÄêÂøÖÂ°´„Äë"
      }
    ],

    "lorebook": [
      {
        "_Ë™™Êòé": "Lorebook‰∏ñÁïåËßÄË®≠ÂÆöÂ∫´",
        "id": "Â≠óÁ¨¶‰∏≤ - ÂîØ‰∏ÄIDÔºàUUIDÔºâ„ÄêÂøÖÂ°´„Äë",
        "storyId": "Â≠óÁ¨¶‰∏≤ - ÊâÄÂ±¨ÊïÖ‰∫ãID„ÄêÂøÖÂ°´„Äë",
        "name": "Â≠óÁ¨¶‰∏≤ - Ê¢ùÁõÆÂêçÁ®±„ÄêÂøÖÂ°´„Äë",
        "content": "Â≠óÁ¨¶‰∏≤ - Ê¢ùÁõÆÂÖßÂÆπ„ÄêÂøÖÂ°´„Äë",
        "keywords": "Êï∏ÁµÑ - Ëß∏ÁôºÈóúÈçµË©ûÔºåÂ¶Ç ['ÁöáÂÆÆ','‰∫¨Âüé']„ÄêÂøÖÂ°´„Äë",
        "enabled": "Â∏ÉÁàæÂÄº - ÊòØÂê¶ÂïüÁî®„ÄêÂøÖÂ°´ÔºåÈªòË™çtrue„Äë",
        "priority": "Êï∏Â≠ó - ÂÑ™ÂÖàÁ¥öÔºà0-10ÔºåÊï∏Â≠óË∂äÂ§ßË∂äÂÑ™ÂÖàÔºâ„ÄêÂèØÈÅ∏ÔºåÈªòË™ç5„Äë",
        "category": "Â≠óÁ¨¶‰∏≤ - ÂàÜÈ°ûÔºåÂ¶Ç 'Âú∞Èªû','‰∫∫Áâ©','Ë®≠ÂÆö'„ÄêÂèØÈÅ∏„Äë",
        "insertionOrder": "Êï∏Â≠ó - ÊèíÂÖ•È†ÜÂ∫è„ÄêÂèØÈÅ∏„Äë",
        "createdAt": "Êï∏Â≠ó - ÂâµÂª∫ÊôÇÈñìÊà≥ÔºàÊØ´ÁßíÔºâ„ÄêÂøÖÂ°´„Äë",
        "updatedAt": "Êï∏Â≠ó - Êõ¥Êñ∞ÊôÇÈñìÊà≥ÔºàÊØ´ÁßíÔºâ„ÄêÂøÖÂ°´„Äë"
      }
    ],

    "playerPanels": [
      {
        "_Ë™™Êòé": "Áé©ÂÆ∂ÁãÄÊÖãÈù¢Êùø",
        "id": "Â≠óÁ¨¶‰∏≤ - ÂîØ‰∏ÄIDÔºàUUIDÔºâ„ÄêÂøÖÂ°´„Äë",
        "storyId": "Â≠óÁ¨¶‰∏≤ - ÊâÄÂ±¨ÊïÖ‰∫ãID„ÄêÂøÖÂ°´„Äë",
        "name": "Â≠óÁ¨¶‰∏≤ - Èù¢ÊùøÂêçÁ®±ÔºåÂ¶Ç 'ÊàëÁöÑÁãÄÊÖã'„ÄêÂøÖÂ°´„Äë",
        "attributes": "Êï∏ÁµÑ - Â±¨ÊÄßÂÆöÁæ©ÂàóË°®„ÄêÂøÖÂ°´„Äë",
        "_attributesÁØÑ‰æã": [
          {
            "name": "Â≠óÁ¨¶‰∏≤ - Â±¨ÊÄßÂêçÁ®±„ÄêÂøÖÂ°´„Äë",
            "icon": "Â≠óÁ¨¶‰∏≤ - emojiÂúñÊ®ô„ÄêÂøÖÂ°´„Äë",
            "type": "Â≠óÁ¨¶‰∏≤ - 'number'ÔºàÊï∏Â≠óÔºâ„ÄÅ'percent'ÔºàÁôæÂàÜÊØîÔºâÊàñ 'text'ÔºàÊñáÂ≠óÔºâ„ÄêÂøÖÂ°´„Äë",
            "defaultValue": "Êï∏Â≠óÊàñÂ≠óÁ¨¶‰∏≤ - ÈªòË™çÂÄº„ÄêÂøÖÂ°´„Äë",
            "maxValue": "Êï∏Â≠ó - ÊúÄÂ§ßÂÄºÔºàÂÉÖÊï∏Â≠óÂíåÁôæÂàÜÊØîÈ°ûÂûãÔºâ„ÄêÂèØÈÅ∏„Äë",
            "keywords": "Êï∏ÁµÑ - Ëá™ÂãïËß£ÊûêÈóúÈçµË©û„ÄêÂèØÈÅ∏„Äë",
            "group": "Â≠óÁ¨¶‰∏≤ - ÂàÜÁµÑÂêçÁ®±ÔºåÂ¶Ç 'stats','status','finance'„ÄêÂèØÈÅ∏„Äë",
            "color": "Â≠óÁ¨¶‰∏≤ - È°èËâ≤Ôºö'red','orange','green','blue','purple','pink','default'„ÄêÂèØÈÅ∏„Äë"
          }
        ],
        "values": "Â∞çË±° - Áï∂ÂâçÂ±¨ÊÄßÂÄºÔºåÂ¶Ç {\"È≠ÖÂäõ\":75,\"ÈáëÈå¢\":1000}„ÄêÂøÖÂ°´„Äë",
        "createdAt": "Êï∏Â≠ó - ÂâµÂª∫ÊôÇÈñìÊà≥ÔºàÊØ´ÁßíÔºâ„ÄêÂøÖÂ°´„Äë",
        "updatedAt": "Êï∏Â≠ó - Êõ¥Êñ∞ÊôÇÈñìÊà≥ÔºàÊØ´ÁßíÔºâ„ÄêÂøÖÂ°´„Äë"
      }
    ],

    "scenes": [
      {
        "_Ë™™Êòé": "Â†¥ÊôØÁ≥ªÁµ±ÔºàÂ§öËßíËâ≤‰∫íÂãïÔºâ",
        "id": "Â≠óÁ¨¶‰∏≤ - ÂîØ‰∏ÄIDÔºàUUIDÔºâ„ÄêÂøÖÂ°´„Äë",
        "storyId": "Â≠óÁ¨¶‰∏≤ - ÊâÄÂ±¨ÊïÖ‰∫ãID„ÄêÂøÖÂ°´„Äë",
        "name": "Â≠óÁ¨¶‰∏≤ - Â†¥ÊôØÂêçÁ®±„ÄêÂøÖÂ°´„Äë",
        "description": "Â≠óÁ¨¶‰∏≤ - Â†¥ÊôØÊèèËø∞„ÄêÂèØÈÅ∏„Äë",
        "participants": "Êï∏ÁµÑ - ÂèÉËàáËßíËâ≤IDÂàóË°®„ÄêÂøÖÂ°´„Äë",
        "isActive": "Â∏ÉÁàæÂÄº - ÊòØÂê¶Áï∂ÂâçÂ†¥ÊôØ„ÄêÂèØÈÅ∏„Äë",
        "createdAt": "Êï∏Â≠ó - ÂâµÂª∫ÊôÇÈñìÊà≥ÔºàÊØ´ÁßíÔºâ„ÄêÂøÖÂ°´„Äë"
      }
    ],

    "personas": [
      {
        "_Ë™™Êòé": "PersonaÁ≥ªÁµ±ÔºàÁé©ÂÆ∂‰∫∫Ê†ºÔºâ",
        "id": "Â≠óÁ¨¶‰∏≤ - ÂîØ‰∏ÄIDÔºàUUIDÔºâ„ÄêÂøÖÂ°´„Äë",
        "name": "Â≠óÁ¨¶‰∏≤ - PersonaÂêçÁ®±„ÄêÂøÖÂ°´„Äë",
        "description": "Â≠óÁ¨¶‰∏≤ - ÊèèËø∞„ÄêÂèØÈÅ∏„Äë",
        "avatar": "Â≠óÁ¨¶‰∏≤ - emojiÈ†≠ÂÉè„ÄêÂèØÈÅ∏„Äë",
        "prompt": "Â≠óÁ¨¶‰∏≤ - ÊèêÁ§∫Ë©ûÂÖßÂÆπ„ÄêÂèØÈÅ∏„Äë",
        "isActive": "Â∏ÉÁàæÂÄº - ÊòØÂê¶ÊøÄÊ¥ª„ÄêÂèØÈÅ∏„Äë",
        "createdAt": "Êï∏Â≠ó - ÂâµÂª∫ÊôÇÈñìÊà≥ÔºàÊØ´ÁßíÔºâ„ÄêÂøÖÂ°´„Äë"
      }
    ],

    "chapters": [
      {
        "_Ë™™Êòé": "Á´†ÁØÄÁÆ°ÁêÜ",
        "id": "Â≠óÁ¨¶‰∏≤ - ÂîØ‰∏ÄIDÔºàUUIDÔºâ„ÄêÂøÖÂ°´„Äë",
        "storyId": "Â≠óÁ¨¶‰∏≤ - ÊâÄÂ±¨ÊïÖ‰∫ãID„ÄêÂøÖÂ°´„Äë",
        "title": "Â≠óÁ¨¶‰∏≤ - Á´†ÁØÄÊ®ôÈ°å„ÄêÂøÖÂ°´„Äë",
        "startMessageId": "Â≠óÁ¨¶‰∏≤ - Ëµ∑ÂßãÊ∂àÊÅØID„ÄêÂèØÈÅ∏„Äë",
        "endMessageId": "Â≠óÁ¨¶‰∏≤ - ÁµêÊùüÊ∂àÊÅØID„ÄêÂèØÈÅ∏„Äë",
        "summary": "Â≠óÁ¨¶‰∏≤ - Á´†ÁØÄÊëòË¶Å„ÄêÂèØÈÅ∏„Äë",
        "createdAt": "Êï∏Â≠ó - ÂâµÂª∫ÊôÇÈñìÊà≥ÔºàÊØ´ÁßíÔºâ„ÄêÂøÖÂ°´„Äë"
      }
    ],

    "foreshadowing": [
      {
        "_Ë™™Êòé": "‰ºèÁ≠ÜÁ≥ªÁµ±",
        "id": "Â≠óÁ¨¶‰∏≤ - ÂîØ‰∏ÄIDÔºàUUIDÔºâ„ÄêÂøÖÂ°´„Äë",
        "storyId": "Â≠óÁ¨¶‰∏≤ - ÊâÄÂ±¨ÊïÖ‰∫ãID„ÄêÂøÖÂ°´„Äë",
        "title": "Â≠óÁ¨¶‰∏≤ - ‰ºèÁ≠ÜÊ®ôÈ°å„ÄêÂøÖÂ°´„Äë",
        "description": "Â≠óÁ¨¶‰∏≤ - ‰ºèÁ≠ÜÊèèËø∞„ÄêÂøÖÂ°´„Äë",
        "isResolved": "Â∏ÉÁàæÂÄº - ÊòØÂê¶Â∑≤ÂõûÊî∂„ÄêÂèØÈÅ∏ÔºåÈªòË™çfalse„Äë",
        "createdAt": "Êï∏Â≠ó - ÂâµÂª∫ÊôÇÈñìÊà≥ÔºàÊØ´ÁßíÔºâ„ÄêÂøÖÂ°´„Äë"
      }
    ],

    "_‰ΩøÁî®Ë™™Êòé": {
      "Ê≠•È©ü1": "Ê†πÊìöÊ≠§Ê®°ÊùøÂ°´ÂØ´ÊÇ®ÁöÑÊõ∏Á±çÊï∏Êìö",
      "Ê≠•È©ü2": "Á¢∫‰øùÊâÄÊúâ„ÄêÂøÖÂ°´„ÄëÂ≠óÊÆµÈÉΩÂ∑≤Â°´ÂØ´",
      "Ê≠•È©ü3": "ÊôÇÈñìÊà≥‰ΩøÁî® Date.now() Ê†ºÂºèÔºàÊØ´ÁßíÔºâÔºåÂ¶Ç 1704067200000",
      "Ê≠•È©ü4": "ID‰ΩøÁî®UUIDÊ†ºÂºèÔºåÂèØÁî®Âú®Á∑öÂ∑•ÂÖ∑ÁîüÊàê",
      "Ê≠•È©ü5": "‰øùÂ≠òÁÇ∫ .json Êñá‰ª∂",
      "Ê≠•È©ü6": "Âú®ÁπîÂ§¢‰∏≠ÈÄöÈÅé„Äå‰∏ªÁïåÈù¢ ‚Üí Â∞éÂÖ•Êõ∏Á±ç„ÄçÂäüËÉΩÂ∞éÂÖ•",
      "Ê≥®ÊÑè‰∫ãÈ†Ö": "JSONÂøÖÈ†àÊòØÊúâÊïàÊ†ºÂºèÔºåÂª∫Ë≠∞‰ΩøÁî®JSONÈ©óË≠âÂ∑•ÂÖ∑Ê™¢Êü•"
    }
  };

  try {
    const jsonStr = JSON.stringify(template, null, 2);
    const blob = new Blob([jsonStr], {type: 'application/json;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ÁπîÂ§¢Êõ∏Á±çÊ†ºÂºèÊ®°Êùø_v6.1_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);

    toast(T('üìã Êõ∏Á±çÊ†ºÂºèÊ®°ÊùøÂ∑≤Â∞éÂá∫ÔºÅ'), 'success');
  } catch(e) {
    console.error('Ê®°ÊùøÂ∞éÂá∫Â§±Êïó:', e);
    toast('Ê®°ÊùøÂ∞éÂá∫Â§±Êïó: ' + e.message, 'error');
  }
}

function importAll(){
  const input=document.getElementById('import-input');
  input.onchange=async e=>{
    const f=e.target.files[0];if(!f)return;
    showLoading('Â∞éÂÖ•‰∏≠...');
    try{
      const text=await f.text();
      const data=safeJSONParse(text);
      if(!data || !data.version || !data.stories)throw new Error('ÁÑ°ÊïàÁöÑÂÇô‰ªΩÊñá‰ª∂');
      if(data.stories)await db.stories.bulkPut(data.stories);
      if(data.messages)await db.messages.bulkPut(data.messages);
      if(data.branches)await db.branches.bulkPut(data.branches);
      if(data.instructions)await db.instructions.bulkPut(data.instructions);
      if(data.storyInstructions)await db.storyInstructions.bulkPut(data.storyInstructions);
      if(data.loreEntries)await db.loreEntries.bulkPut(data.loreEntries);
      if(data.foreshadowing)await db.foreshadowing.bulkPut(data.foreshadowing);
      if(data.events)await db.events.bulkPut(data.events);
      if(data.saves)await db.saves.bulkPut(data.saves);
      if(data.apiPresets)await db.apiPresets.bulkPut(data.apiPresets);
      if(data.settings)await db.settings.bulkPut(data.settings);
      if(data.timeline)await db.timeline.bulkPut(data.timeline);
      if(data.chapters)await db.chapters.bulkPut(data.chapters);
      if(data.bookmarks)await db.bookmarks.bulkPut(data.bookmarks);
      if(data.plotTags)await db.plotTags.bulkPut(data.plotTags);
      // v7: ËßíËâ≤Êï∏ÊìöÔºàÂÖºÂÆπËàäÊï∏ÊìöÔºöÂ¶ÇÊûúÊ≤íÊúâinitialStatsÔºåËá™ÂãïË®≠ÁΩÆÔºâ
      if(data.characters){
        const characters = data.characters.map(c => {
          if(!c.initialStats && c.stats && Object.keys(c.stats).length > 0) {
            c.initialStats = { ...c.stats };
          }
          return c;
        });
        await db.characters.bulkPut(characters);
      }
      if(data.characterSnapshots)await db.characterSnapshots.bulkPut(data.characterSnapshots);
      if(data.characterHistory)await db.characterHistory.bulkPut(data.characterHistory);
      // v13: Lorebook Êï∏Êìö
      if(data.lorebook)await db.lorebook.bulkPut(data.lorebook);
      if(data.lorebookTriggerLog)await db.lorebookTriggerLog.bulkPut(data.lorebookTriggerLog);
      // v16: Âø´Êç∑Êåá‰ª§ÂíåÂ†¥ÊôØ
      if(data.quickCommands)await db.quickCommands.bulkPut(data.quickCommands);
      if(data.scenes)await db.scenes.bulkPut(data.scenes);
      // v22: Persona ÂíåÁé©ÂÆ∂Èù¢Êùø
      if(data.personas)await db.personas.bulkPut(data.personas);
      if(data.playerPanels)await db.playerPanels.bulkPut(data.playerPanels);
      // Ë£úÂÖÖÈÅ∫ÊºèÁöÑË°®
      if(data.characterStates)await db.characterStates.bulkPut(data.characterStates);
      await loadSettings();await renderStories();await renderInst();await renderQuickCommands();
      toast(T('Êï∏ÊìöÂ∞éÂÖ•ÊàêÂäüÔºÅ'),'success');
    }catch(e){toast('Â∞éÂÖ•Â§±Êïó: '+e.message,'error');}
    hideLoading();input.value='';
  };
  input.click();
}

// v24: Â∞éÂÖ•Êõ∏Á±çÔºàÂæû‰∏ªÁïåÈù¢Ôºâ
function importBook(){
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';

  input.onchange = async e => {
    const f = e.target.files[0];
    if(!f) return;

    showLoading('Ê≠£Âú®Â∞éÂÖ•Êõ∏Á±ç...');

    try {
      const text = await f.text();
      const data = safeJSONParse(text);

      if(!data) {
        throw new Error('ÁÑ°ÊïàÁöÑJSONÊñá‰ª∂');
      }

      let importedCount = 0;
      const errors = [];  // Ë®òÈåÑÈåØË™§

      // Âà§Êñ∑ÊòØÂÆåÊï¥Â∞éÂá∫Ê†ºÂºèÈÇÑÊòØÂñÆÊú¨Êõ∏Ê†ºÂºè
      if(data.version && data.stories) {
        // ÂÆåÊï¥Â∞éÂá∫Ê†ºÂºèÔºàÂèØËÉΩÂåÖÂê´Â§öÂÄãÊïÖ‰∫ãÔºâ
        if(data.stories && Array.isArray(data.stories)) {
          try {
            await db.stories.bulkPut(data.stories);
            importedCount = data.stories.length;
          } catch(e) {
            errors.push(`ÊïÖ‰∫ã: ${e.message}`);
          }
        }
        if(data.messages) {
          try {
            await db.messages.bulkPut(data.messages);
          } catch(e) {
            errors.push(`Ë®äÊÅØ: ${e.message}`);
          }
        }
        if(data.branches) {
          try {
            await db.branches.bulkPut(data.branches);
          } catch(e) {
            errors.push(`ÂàÜÊîØ: ${e.message}`);
          }
        }
        if(data.characters) {
          try {
            const characters = data.characters.map(c => {
              if(!c.initialStats && c.stats && Object.keys(c.stats).length > 0) {
                c.initialStats = { ...c.stats };
              }
              return c;
            });
            await db.characters.bulkPut(characters);
          } catch(e) {
            errors.push(`ËßíËâ≤: ${e.message}`);
          }
        }
        if(data.lorebook) {
          try {
            await db.lorebook.bulkPut(data.lorebook);
          } catch(e) {
            errors.push(`Lorebook: ${e.message}`);
          }
        }
        if(data.playerPanels) {
          try {
            await db.playerPanels.bulkPut(data.playerPanels);
          } catch(e) {
            errors.push(`Áé©ÂÆ∂Èù¢Êùø: ${e.message}`);
          }
        }
        if(data.scenes) {
          try {
            await db.scenes.bulkPut(data.scenes);
          } catch(e) {
            errors.push(`Â†¥ÊôØ: ${e.message}`);
          }
        }
        if(data.personas) {
          try {
            await db.personas.bulkPut(data.personas);
          } catch(e) {
            errors.push(`Persona: ${e.message}`);
          }
        }
        if(data.instructions) {
          try {
            await db.instructions.bulkPut(data.instructions);
          } catch(e) {
            errors.push(`Êåá‰ª§: ${e.message}`);
          }
        }
        if(data.storyInstructions) {
          try {
            await db.storyInstructions.bulkPut(data.storyInstructions);
          } catch(e) {
            errors.push(`ÊïÖ‰∫ãÊåá‰ª§Á∂ÅÂÆö: ${e.message}`);
          }
        }
        if(data.chapters) {
          try {
            await db.chapters.bulkPut(data.chapters);
          } catch(e) {
            errors.push(`Á´†ÁØÄ: ${e.message}`);
          }
        }
        if(data.foreshadowing) {
          try {
            await db.foreshadowing.bulkPut(data.foreshadowing);
          } catch(e) {
            errors.push(`‰ºèÁ≠Ü: ${e.message}`);
          }
        }
        if(data.timeline) {
          try {
            await db.timeline.bulkPut(data.timeline);
          } catch(e) {
            errors.push(`ÊôÇÈñìËª∏: ${e.message}`);
          }
        }
        if(data.bookmarks) {
          try {
            await db.bookmarks.bulkPut(data.bookmarks);
          } catch(e) {
            errors.push(`Êõ∏Á±§: ${e.message}`);
          }
        }
        if(data.characterSnapshots) {
          try {
            await db.characterSnapshots.bulkPut(data.characterSnapshots);
          } catch(e) {
            errors.push(`ËßíËâ≤Âø´ÁÖß: ${e.message}`);
          }
        }
        if(data.characterHistory) {
          try {
            await db.characterHistory.bulkPut(data.characterHistory);
          } catch(e) {
            errors.push(`ËßíËâ≤Ê≠∑Âè≤: ${e.message}`);
          }
        }
        if(data.characterStates) {
          try {
            await db.characterStates.bulkPut(data.characterStates);
          } catch(e) {
            errors.push(`ËßíËâ≤ÁãÄÊÖã: ${e.message}`);
          }
        }
      } else if(data.story) {
        // ÂñÆÊú¨Êõ∏Ê†ºÂºè
        const story = data.story;

        // Á¢∫‰øùÂøÖÂ°´Â≠óÊÆµÂ≠òÂú®
        if(!story.id) story.id = crypto.randomUUID();
        if(!story.title) throw new Error('Êõ∏Á±çÁº∫Â∞ëÊ®ôÈ°å');
        if(!story.currentBranchId) story.currentBranchId = 'main';
        if(!story.createdAt) story.createdAt = Date.now();
        if(!story.updatedAt) story.updatedAt = Date.now();
        if(!story.mode) story.mode = 'normal';

        try {
          await db.stories.put(story);
          importedCount = 1;
        } catch(e) {
          errors.push(`ÊïÖ‰∫ã: ${e.message}`);
          throw new Error('ÊïÖ‰∫ãÂ∞éÂÖ•Â§±ÊïóÔºåÁÑ°Ê≥ïÁπºÁ∫å');
        }

        // Â∞éÂÖ•Ê∂àÊÅØ
        if(data.messages && Array.isArray(data.messages)) {
          try {
            // Á¢∫‰øùÊâÄÊúâÊ∂àÊÅØÁöÑstoryIdÊ≠£Á¢∫
            const messages = data.messages.map(m => ({
              ...m,
              storyId: story.id,
              branchId: m.branchId || story.currentBranchId
            }));
            await db.messages.bulkPut(messages);
          } catch(e) {
            errors.push(`Ë®äÊÅØ: ${e.message}`);
          }
        }

        // Â∞éÂÖ•ÂàÜÊîØ
        if(data.branches && Array.isArray(data.branches)) {
          try {
            const branches = data.branches.map(b => ({
              ...b,
              storyId: story.id
            }));
            await db.branches.bulkPut(branches);
          } catch(e) {
            errors.push(`ÂàÜÊîØ: ${e.message}`);
          }
        } else {
          try {
            // Á¢∫‰øùËá≥Â∞ëÊúâ‰∏ªÂàÜÊîØ
            const mainBranch = {
              id: 'main',
              storyId: story.id,
              name: '‰∏ªÁ∑ö',
              description: '‰∏ªË¶ÅÂäáÊÉÖÁ∑ö',
              createdAt: Date.now()
            };
            await db.branches.put(mainBranch);
          } catch(e) {
            errors.push(`‰∏ªÂàÜÊîØ: ${e.message}`);
          }
        }

        // Â∞éÂÖ•ËßíËâ≤
        if(data.characters && Array.isArray(data.characters)) {
          try {
            const characters = data.characters.map(c => {
              const char = { ...c, storyId: story.id };
              if(!char.id) char.id = crypto.randomUUID();
              if(!char.createdAt) char.createdAt = Date.now();
              if(!char.updatedAt) char.updatedAt = Date.now();
              if(!char.initialStats && char.stats && Object.keys(char.stats).length > 0) {
                char.initialStats = { ...char.stats };
              }
              return char;
            });
            await db.characters.bulkPut(characters);
          } catch(e) {
            errors.push(`ËßíËâ≤: ${e.message}`);
          }
        }

        // Â∞éÂÖ•Lorebook
        if(data.lorebook && Array.isArray(data.lorebook)) {
          try {
            const lorebook = data.lorebook.map(l => ({
              ...l,
              id: l.id || crypto.randomUUID(),
              storyId: story.id,
              createdAt: l.createdAt || Date.now(),
              updatedAt: l.updatedAt || Date.now()
            }));
            await db.lorebook.bulkPut(lorebook);
          } catch(e) {
            errors.push(`Lorebook: ${e.message}`);
          }
        }

        // Â∞éÂÖ•Áé©ÂÆ∂Èù¢Êùø
        if(data.playerPanels && Array.isArray(data.playerPanels)) {
          try {
            const panels = data.playerPanels.map(p => ({
              ...p,
              storyId: story.id
            }));
            await db.playerPanels.bulkPut(panels);
          } catch(e) {
            errors.push(`Áé©ÂÆ∂Èù¢Êùø: ${e.message}`);
          }
        }

        // Â∞éÂÖ•Â†¥ÊôØ
        if(data.scenes && Array.isArray(data.scenes)) {
          try {
            const scenes = data.scenes.map(s => ({
              ...s,
              storyId: story.id
            }));
            await db.scenes.bulkPut(scenes);
          } catch(e) {
            errors.push(`Â†¥ÊôØ: ${e.message}`);
          }
        }

        // Â∞éÂÖ•Persona
        if(data.personas && Array.isArray(data.personas)) {
          try {
            await db.personas.bulkPut(data.personas);
          } catch(e) {
            errors.push(`Persona: ${e.message}`);
          }
        }

        // Â∞éÂÖ•Êåá‰ª§
        if(data.instructions && Array.isArray(data.instructions)) {
          try {
            await db.instructions.bulkPut(data.instructions);
          } catch(e) {
            errors.push(`Êåá‰ª§: ${e.message}`);
          }
        }

        // Â∞éÂÖ•ÊïÖ‰∫ãÊåá‰ª§Á∂ÅÂÆö
        if(data.storyInstructions && Array.isArray(data.storyInstructions)) {
          try {
            const storyInsts = data.storyInstructions.map(si => ({
              ...si,
              storyId: story.id
            }));
            await db.storyInstructions.bulkPut(storyInsts);
          } catch(e) {
            errors.push(`ÊïÖ‰∫ãÊåá‰ª§Á∂ÅÂÆö: ${e.message}`);
          }
        }

        // Â∞éÂÖ•Á´†ÁØÄ
        if(data.chapters && Array.isArray(data.chapters)) {
          try {
            const chapters = data.chapters.map(ch => ({
              ...ch,
              storyId: story.id
            }));
            await db.chapters.bulkPut(chapters);
          } catch(e) {
            errors.push(`Á´†ÁØÄ: ${e.message}`);
          }
        }

        // Â∞éÂÖ•‰ºèÁ≠Ü
        if(data.foreshadowing && Array.isArray(data.foreshadowing)) {
          try {
            const foreshadowing = data.foreshadowing.map(f => ({
              ...f,
              storyId: story.id
            }));
            await db.foreshadowing.bulkPut(foreshadowing);
          } catch(e) {
            errors.push(`‰ºèÁ≠Ü: ${e.message}`);
          }
        }
      } else {
        throw new Error('ÁÑ°Ê≥ïË≠òÂà•ÁöÑÊõ∏Á±çÊ†ºÂºè„ÄÇË´ãÁ¢∫‰øùJSONÂåÖÂê´ story Êàñ stories Â≠óÊÆµ„ÄÇ');
      }

      // Âà∑Êñ∞ÊïÖ‰∫ãÂàóË°®ÂíåÊåá‰ª§ÂàóË°®
      await renderStories();
      await renderInst();

      hideLoading();

      // È°ØÁ§∫Â∞éÂÖ•ÁµêÊûú
      if(errors.length === 0) {
        toast(`üìö ÊàêÂäüÂ∞éÂÖ• ${importedCount} Êú¨Êõ∏Á±çÔºÅ`, 'success');
      } else if(importedCount > 0) {
        // ÈÉ®ÂàÜÊàêÂäü
        const errorMsg = errors.join('\n‚Ä¢ ');
        toast(`‚ö†Ô∏è Êõ∏Á±çÂ∑≤Â∞éÂÖ•Ôºå‰ΩÜ‰ª•‰∏ãÈ†ÖÁõÆÂ§±ÊïóÔºö\n‚Ä¢ ${errorMsg}`, 'warning');
      } else {
        // ÂÆåÂÖ®Â§±Êïó
        const errorMsg = errors.join('\n‚Ä¢ ');
        throw new Error(`Â∞éÂÖ•Â§±ÊïóÔºö\n‚Ä¢ ${errorMsg}`);
      }

    } catch(e) {
      hideLoading();
      console.error('Â∞éÂÖ•Êõ∏Á±çÂ§±Êïó:', e);
      toast('Â∞éÂÖ•Â§±Êïó: ' + e.message, 'error');
    }
  };

  input.click();
}

function clearAll(){showConfirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊï∏ÊìöÂóéÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Âæ©ÔºÅ',async()=>{showLoading('Ê∏ÖÁ©∫‰∏≠...');try{await db.delete();await initDB();await renderStories();await renderInst();toast(T('Êï∏ÊìöÂ∑≤Ê∏ÖÁ©∫'),'success');}catch(e){toast('Ê∏ÖÁ©∫Â§±Êïó: '+e.message,'error');}hideLoading();},true);}

// Toast & Loading
let toastTimeout = null;
function toast(msg,type=''){
  const t=document.getElementById('toast');
  document.getElementById('toast-text').textContent=msg;
  t.className='toast active '+type;
  // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊôÇÂô®ÔºåÈÅøÂÖçÈáçÁñä
  if(toastTimeout) clearTimeout(toastTimeout);
  toastTimeout = setTimeout(()=>{
    t.classList.remove('active');
    toastTimeout = null;
  },2500);
}
function showLoading(txt='ËôïÁêÜ‰∏≠...'){document.getElementById('loading-text').textContent=txt;document.getElementById('loading').classList.add('active');}
function hideLoading(){document.getElementById('loading').classList.remove('active');}

// Â∑•ÂÖ∑ÂáΩÊï∏
function esc(t){if(!t)return'';const d=document.createElement('div');d.textContent=t;return d.innerHTML;}
// Âà´ÂêçÔºöescHtml = esc
function escHtml(t){return esc(t);}
// ËΩ¨‰πâHTMLÂ±ûÊÄßÂÄºÔºàÈò≤Ê≠¢XSSÔºâ
function escAttr(t){if(!t)return'';return String(t).replace(/'/g,'&#39;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function fmtNum(n){return n>=10000?(n/10000).toFixed(1)+'Ëê¨':n.toLocaleString();}
function fmtDate(ts){if(!ts)return'Êú™Áü•';const d=new Date(ts);return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;}
function timeAgo(ts){const d=Date.now()-ts,m=Math.floor(d/60000),h=Math.floor(d/3600000),dy=Math.floor(d/86400000);if(m<1)return'ÂâõÂâõ';if(m<60)return m+'ÂàÜÈêòÂâç';if(h<24)return h+'Â∞èÊôÇÂâç';if(dy<7)return dy+'Â§©Ââç';const dt=new Date(ts);return(dt.getMonth()+1)+'/'+dt.getDate();}
// ÂÆâÂÖ®ÁöÑÊï¥Êï∞Ëß£ÊûêÔºöÂ¶ÇÊûúËß£ÊûêÂ§±Ë¥•ËøîÂõûÈªòËÆ§ÂÄºËÄå‰∏çÊòØNaN
function safeParseInt(value, defaultValue = 0){
  const parsed = parseInt(value);
  return isNaN(parsed) ? defaultValue : parsed;
}
// ÂÆâÂÖ®ÁöÑJSONËß£ÊûêÔºöÊçïËé∑ÈîôËØØÂπ∂ËøîÂõûÈªòËÆ§ÂÄº
function safeJSONParse(jsonString, defaultValue = null){
  if(!jsonString || typeof jsonString !== 'string') return defaultValue;
  try{
    const parsed = JSON.parse(jsonString);
    // Âü∫Êú¨È™åËØÅÔºöÁ°Æ‰øù‰∏çÊòØÂáΩÊï∞ÊàñÂÖ∂‰ªñÂç±Èô©Á±ªÂûã
    if(typeof parsed === 'function') return defaultValue;
    return parsed;
  }catch(e){
    console.warn('[JSON] Ëß£ÊûêÂ§±Ë¥•:', e.message, 'ËæìÂÖ•:', jsonString.slice(0, 100));
    return defaultValue;
  }
}
// Èò≤ÊäñÂáΩÊï∞ÔºöÂª∂ËøüÊâßË°åÔºåÂ§öÊ¨°Ë∞ÉÁî®Âè™ÊâßË°åÊúÄÂêé‰∏ÄÊ¨°
function debounce(func, wait){
  let timeout;
  return function executedFunction(...args){
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// ============ Èõ≤Á´ØÂêåÊ≠•ÂäüËÉΩ (GitHub Gist) ============
let cloudSyncSettings = {
  githubToken: '',
  gistId: '',
  autoSync: false,
  lastSyncTime: 0
};

// Âä†ËºâÈõ≤Á´ØÂêåÊ≠•Ë®≠ÁΩÆ
async function loadCloudSyncSettings(){
  try {
    const saved = await db.settings.get('cloudSyncSettings');
    if(saved && saved.value){
      cloudSyncSettings = {...cloudSyncSettings, ...saved.value};
      updateCloudSyncStatus();
    }
  } catch(e){
    console.error('[CloudSync] Âä†ËºâË®≠ÁΩÆÂ§±Êïó:', e);
  }
}

// Êõ¥Êñ∞Èõ≤Á´ØÂêåÊ≠•ÁãÄÊÖãÈ°ØÁ§∫
function updateCloudSyncStatus(){
  const statusEl = document.getElementById('cloud-sync-status');
  if(!statusEl) return;

  if(cloudSyncSettings.githubToken){
    const lastSync = cloudSyncSettings.lastSyncTime;
    if(lastSync){
      const timeAgo = Math.floor((Date.now() - lastSync) / 60000); // ÂàÜÈêò
      if(timeAgo < 60){
        statusEl.textContent = `${timeAgo}ÂàÜÈêòÂâç ‚Ä∫`;
      } else if(timeAgo < 1440){
        statusEl.textContent = `${Math.floor(timeAgo/60)}Â∞èÊôÇÂâç ‚Ä∫`;
      } else {
        statusEl.textContent = `${Math.floor(timeAgo/1440)}Â§©Ââç ‚Ä∫`;
      }
    } else {
      statusEl.textContent = 'Â∑≤Ë®≠ÁΩÆ ‚Ä∫';
    }
  } else {
    statusEl.textContent = 'Êú™Ë®≠ÁΩÆ ‚Ä∫';
  }
}

// È°ØÁ§∫Èõ≤Á´ØÂêåÊ≠•Ë®≠ÁΩÆ
function showCloudSyncSettings(){
  document.getElementById('github-token').value = cloudSyncSettings.githubToken || '';
  document.getElementById('gist-id').value = cloudSyncSettings.gistId || '';
  document.getElementById('auto-sync-enabled').checked = cloudSyncSettings.autoSync || false;
  showModal('cloud-sync-modal');
}

// ‰øùÂ≠òÈõ≤Á´ØÂêåÊ≠•Ë®≠ÁΩÆ
async function saveCloudSyncSettings(){
  const token = document.getElementById('github-token').value.trim();
  const gistId = document.getElementById('gist-id').value.trim();
  const autoSync = document.getElementById('auto-sync-enabled').checked;

  if(!token){
    toast('Ë´ãËº∏ÂÖ• GitHub Token', 'warning');
    return;
  }

  if(!token.startsWith('ghp_') && !token.startsWith('github_pat_')){
    toast('Token Ê†ºÂºè‰∏çÊ≠£Á¢∫ÔºåÊáâ‰ª• ghp_ Êàñ github_pat_ ÈñãÈ†≠', 'warning');
    return;
  }

  cloudSyncSettings = {
    githubToken: token,
    gistId: gistId,
    autoSync: autoSync,
    lastSyncTime: cloudSyncSettings.lastSyncTime
  };

  await db.settings.put({
    key: 'cloudSyncSettings',
    value: cloudSyncSettings
  });

  updateCloudSyncStatus();
  closeModal('cloud-sync-modal');
  toast('Èõ≤Á´ØÂêåÊ≠•Ë®≠ÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
}

// ‰∏äÂÇ≥Âà∞Èõ≤Á´Ø
async function uploadToCloud(){
  if(!cloudSyncSettings.githubToken){
    toast('Ë´ãÂÖàË®≠ÁΩÆ GitHub Token', 'warning');
    showCloudSyncSettings();
    return;
  }

  showLoading('Ê≠£Âú®‰∏äÂÇ≥Âà∞Èõ≤Á´Ø...');

  try {
    // Â∞éÂá∫ÊâÄÊúâÊï∏Êìö
    const data = {
      version: '6.2',
      exportedAt: Date.now(),
      exportType: 'cloud-backup',
      stories: await db.stories.toArray(),
      messages: await db.messages.toArray(),
      branches: await db.branches.toArray(),
      instructions: await db.instructions.toArray(),
      storyInstructions: await db.storyInstructions.toArray(),
      characters: await db.characters.toArray(),
      lorebook: await db.lorebook.toArray(),
      playerPanels: await db.playerPanels.toArray(),
      scenes: await db.scenes.toArray(),
      personas: await db.personas.toArray(),
      chapters: await db.chapters.toArray(),
      foreshadowing: await db.foreshadowing.toArray(),
      timeline: await db.timeline.toArray(),
      bookmarks: await db.bookmarks.toArray(),
      characterSnapshots: await db.characterSnapshots.toArray(),
      characterHistory: await db.characterHistory.toArray(),
      characterStates: await db.characterStates.toArray(),
      quickCommands: await db.quickCommands.toArray(),
      saves: await db.saves.toArray()
    };

    const jsonContent = JSON.stringify(data, null, 2);
    const fileName = `zhimeng_backup_${new Date().toISOString().slice(0,10)}.json`;

    // ‰∏äÂÇ≥Âà∞ GitHub Gist
    const gistData = {
      description: 'ÁπîÂ§¢ AI ‰∫íÂãïÂ∞èË™™Èñ±ËÆÄÂô® - Èõ≤Á´ØÂÇô‰ªΩ',
      public: false,
      files: {
        [fileName]: {
          content: jsonContent
        }
      }
    };

    let response;
    if(cloudSyncSettings.gistId){
      // Êõ¥Êñ∞ÁèæÊúâ Gist
      response = await fetch(`https://api.github.com/gists/${cloudSyncSettings.gistId}`, {
        method: 'PATCH',
        headers: {
          'Authorization': `token ${cloudSyncSettings.githubToken}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(gistData)
      });
    } else {
      // ÂâµÂª∫Êñ∞ Gist
      response = await fetch('https://api.github.com/gists', {
        method: 'POST',
        headers: {
          'Authorization': `token ${cloudSyncSettings.githubToken}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(gistData)
      });
    }

    if(!response.ok){
      const error = await response.json();
      throw new Error(error.message || `HTTP ${response.status}`);
    }

    const result = await response.json();

    // ‰øùÂ≠ò Gist ID
    if(!cloudSyncSettings.gistId){
      cloudSyncSettings.gistId = result.id;
      document.getElementById('gist-id').value = result.id;
    }

    // Êõ¥Êñ∞ÊúÄÂæåÂêåÊ≠•ÊôÇÈñì
    cloudSyncSettings.lastSyncTime = Date.now();
    await db.settings.put({
      key: 'cloudSyncSettings',
      value: cloudSyncSettings
    });

    updateCloudSyncStatus();
    hideLoading();
    toast('‚úÖ Â∑≤ÊàêÂäü‰∏äÂÇ≥Âà∞Èõ≤Á´ØÔºÅ', 'success');

  } catch(e){
    hideLoading();
    console.error('[CloudSync] ‰∏äÂÇ≥Â§±Êïó:', e);
    toast('‰∏äÂÇ≥Â§±Êïó: ' + e.message, 'error');
  }
}

// Ëá™ÂãïÂêåÊ≠•Èò≤ÊäñË®àÊôÇÂô®
let autoSyncTimer = null;

// Ëá™ÂãïÂêåÊ≠•Âà∞Èõ≤Á´ØÔºàÈùúÈªòÊ®°ÂºèÔºå‰∏çÈ°ØÁ§∫ loading Âíå toastÔºâ
// ‰ΩøÁî®Èò≤ÊäñÊ©üÂà∂ÔºåÈÅøÂÖçÈ†ªÁπÅËß∏ÁôºÔºà30ÁßíÂÖßÂè™Âü∑Ë°å‰∏ÄÊ¨°Ôºâ
async function autoSyncToCloud(){
  // Ê™¢Êü•ÊòØÂê¶ÂïüÁî®Ëá™ÂãïÂêåÊ≠•
  if(!cloudSyncSettings.autoSync || !cloudSyncSettings.githubToken){
    return;
  }

  // Ê∏ÖÈô§‰πãÂâçÁöÑË®àÊôÇÂô®
  if(autoSyncTimer){
    clearTimeout(autoSyncTimer);
  }

  // Ë®≠ÁΩÆÊñ∞ÁöÑË®àÊôÇÂô®Ôºå30ÁßíÂæåÂü∑Ë°åÂêåÊ≠•
  autoSyncTimer = setTimeout(async () => {
    try {
      console.log('[CloudSync] ÈñãÂßãËá™ÂãïÂêåÊ≠•...');

      // Â∞éÂá∫ÊâÄÊúâÊï∏Êìö
      const data = {
      version: 'v6.2',
      exportTime: new Date().toISOString(),
      stories: await db.stories.toArray(),
      messages: await db.messages.toArray(),
      branches: await db.branches.toArray(),
      instructions: await db.instructions.toArray(),
      storyInstructions: await db.storyInstructions.toArray(),
      loreEntries: await db.loreEntries.toArray(),
      foreshadowing: await db.foreshadowing.toArray(),
      events: await db.events.toArray(),
      characterStates: await db.characterStates.toArray(),
      timeline: await db.timeline.toArray(),
      saves: await db.saves.toArray(),
      apiPresets: await db.apiPresets.toArray(),
      settings: await db.settings.toArray(),
      chapters: await db.chapters.toArray(),
      bookmarks: await db.bookmarks.toArray(),
      plotTags: await db.plotTags.toArray(),
      characters: await db.characters.toArray(),
      characterSnapshots: await db.characterSnapshots.toArray(),
      characterHistory: await db.characterHistory.toArray(),
      lorebook: await db.lorebook.toArray(),
      lorebookTriggerLog: await db.lorebookTriggerLog.toArray()
    };

    const jsonContent = JSON.stringify(data, null, 2);
    const fileName = `zhimeng-backup-${new Date().toISOString().split('T')[0]}.json`;

    const gistData = {
      description: 'ÁπîÂ§¢ AI ‰∫íÂãïÂ∞èË™™Èñ±ËÆÄÂô® - Èõ≤Á´ØÂÇô‰ªΩ',
      public: false,
      files: {
        [fileName]: {
          content: jsonContent
        }
      }
    };

    let response;
    if(cloudSyncSettings.gistId){
      // Êõ¥Êñ∞ÁèæÊúâ Gist
      response = await fetch(`https://api.github.com/gists/${cloudSyncSettings.gistId}`, {
        method: 'PATCH',
        headers: {
          'Authorization': `token ${cloudSyncSettings.githubToken}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(gistData)
      });
    } else {
      // ÂâµÂª∫Êñ∞ Gist
      response = await fetch('https://api.github.com/gists', {
        method: 'POST',
        headers: {
          'Authorization': `token ${cloudSyncSettings.githubToken}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(gistData)
      });
    }

    if(!response.ok){
      const error = await response.json();
      throw new Error(error.message || `HTTP ${response.status}`);
    }

    const result = await response.json();

    // ‰øùÂ≠ò Gist ID
    if(!cloudSyncSettings.gistId){
      cloudSyncSettings.gistId = result.id;
    }

    // Êõ¥Êñ∞ÊúÄÂæåÂêåÊ≠•ÊôÇÈñì
    cloudSyncSettings.lastSyncTime = Date.now();
    await db.settings.put({
      key: 'cloudSyncSettings',
      value: cloudSyncSettings
    });

    updateCloudSyncStatus();
    console.log('[CloudSync] Ëá™ÂãïÂêåÊ≠•ÊàêÂäü');

  } catch(e){
    console.error('[CloudSync] Ëá™ÂãïÂêåÊ≠•Â§±Êïó:', e);
    // ÈùúÈªòÂ§±ÊïóÔºå‰∏çÊâìÊìæÁî®Êà∂
  }
  }, 30000); // 30ÁßíÂæåÂü∑Ë°å
}

// ÂæûÈõ≤Á´Ø‰∏ãËºâ
async function downloadFromCloud(){
  if(!cloudSyncSettings.githubToken){
    toast('Ë´ãÂÖàË®≠ÁΩÆ GitHub Token', 'warning');
    showCloudSyncSettings();
    return;
  }

  if(!cloudSyncSettings.gistId){
    toast('Ë´ãÂÖà‰∏äÂÇ≥Êï∏ÊìöÊàñËº∏ÂÖ• Gist ID', 'warning');
    showCloudSyncSettings();
    return;
  }

  showLoading('Ê≠£Âú®ÂæûÈõ≤Á´Ø‰∏ãËºâ...');

  try {
    const response = await fetch(`https://api.github.com/gists/${cloudSyncSettings.gistId}`, {
      headers: {
        'Authorization': `token ${cloudSyncSettings.githubToken}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });

    if(!response.ok){
      const error = await response.json();
      throw new Error(error.message || `HTTP ${response.status}`);
    }

    const gist = await response.json();
    const files = Object.values(gist.files);

    if(files.length === 0){
      throw new Error('Gist ‰∏≠Ê≤íÊúâÊâæÂà∞ÂÇô‰ªΩÊñá‰ª∂');
    }

    // Áç≤ÂèñÊúÄÊñ∞ÁöÑÂÇô‰ªΩÊñá‰ª∂
    const backupFile = files.find(f => f.filename.startsWith('zhimeng_backup_')) || files[0];
    const content = backupFile.content;
    const data = JSON.parse(content);

    // Á¢∫Ë™çÊòØÂê¶Ë¶ÅË¶ÜËìãÊú¨Âú∞Êï∏Êìö
    const confirmed = await new Promise(resolve => {
      showConfirm(
        `Á¢∫ÂÆöË¶ÅÂæûÈõ≤Á´ØÊÅ¢Âæ©Êï∏ÊìöÂóéÔºü\n\nÈÄôÂ∞áË¶ÜËìãÊú¨Âú∞ÊâÄÊúâÊï∏ÊìöÔºÅ\n\nÈõ≤Á´ØÂÇô‰ªΩÊôÇÈñìÔºö${new Date(data.exportedAt).toLocaleString()}`,
        () => resolve(true),
        true
      );
      // Ê∑ªÂä†ÂèñÊ∂àÊåâÈàïÁöÑËôïÁêÜ
      setTimeout(() => {
        const cancelBtn = document.querySelector('#confirm-modal .modal-btn.cancel');
        if(cancelBtn){
          cancelBtn.onclick = () => {
            closeModal('confirm-modal');
            resolve(false);
          };
        }
      }, 100);
    });

    if(!confirmed){
      hideLoading();
      return;
    }

    // Â∞éÂÖ•Êï∏Êìö
    if(data.stories) await db.stories.bulkPut(data.stories);
    if(data.messages) await db.messages.bulkPut(data.messages);
    if(data.branches) await db.branches.bulkPut(data.branches);
    if(data.instructions) await db.instructions.bulkPut(data.instructions);
    if(data.storyInstructions) await db.storyInstructions.bulkPut(data.storyInstructions);
    if(data.characters) await db.characters.bulkPut(data.characters);
    if(data.lorebook) await db.lorebook.bulkPut(data.lorebook);
    if(data.playerPanels) await db.playerPanels.bulkPut(data.playerPanels);
    if(data.scenes) await db.scenes.bulkPut(data.scenes);
    if(data.personas) await db.personas.bulkPut(data.personas);
    if(data.chapters) await db.chapters.bulkPut(data.chapters);
    if(data.foreshadowing) await db.foreshadowing.bulkPut(data.foreshadowing);
    if(data.timeline) await db.timeline.bulkPut(data.timeline);
    if(data.bookmarks) await db.bookmarks.bulkPut(data.bookmarks);
    if(data.characterSnapshots) await db.characterSnapshots.bulkPut(data.characterSnapshots);
    if(data.characterHistory) await db.characterHistory.bulkPut(data.characterHistory);
    if(data.characterStates) await db.characterStates.bulkPut(data.characterStates);
    if(data.quickCommands) await db.quickCommands.bulkPut(data.quickCommands);
    if(data.saves) await db.saves.bulkPut(data.saves);

    await loadSettings();
    await renderStories();
    await renderInst();
    await renderQuickCommands();

    hideLoading();
    toast('‚úÖ Â∑≤ÊàêÂäüÂæûÈõ≤Á´ØÊÅ¢Âæ©Êï∏ÊìöÔºÅ', 'success');

  } catch(e){
    hideLoading();
    console.error('[CloudSync] ‰∏ãËºâÂ§±Êïó:', e);
    toast('‰∏ãËºâÂ§±Êïó: ' + e.message, 'error');
  }
}

// ÂàùÂßãÂåñÊôÇÂä†ËºâÈõ≤Á´ØÂêåÊ≠•Ë®≠ÁΩÆ
document.addEventListener('DOMContentLoaded', async () => {
  await loadCloudSyncSettings();
});

console.log('ÁπîÂ§¢ v6.2 - AI‰∫íÂãïÂ∞èË™™Èñ±ËÆÄÂô® Ê∫ñÂÇôÂ∞±Á∑íÔºÅ');

// PWA ÊîØÊåÅ
let deferredPrompt = null;

// Ë®ªÂÜä Service Worker (‰ΩøÁî®ÂÖßÂµåÊñπÂºè)
// Ê≥®ÊÑèÔºöBlob URL ÊñπÂºèÂú®Êüê‰∫õÁÄèË¶ΩÂô®ÔºàÂ¶Ç SafariÔºâÂèØËÉΩ‰∏çÊîØÊåÅÔºåÈÄôÊòØÊ≠£Â∏∏ÁèæË±°
if ('serviceWorker' in navigator) {
  const swCode = `
    const CACHE_NAME = 'zhimeng-v6.2';
    const urlsToCache = [self.location.href];
    
    self.addEventListener('install', e => {
      e.waitUntil(
        caches.open(CACHE_NAME)
          .then(cache => cache.addAll(urlsToCache))
          .then(() => self.skipWaiting())
      );
    });
    
    self.addEventListener('activate', e => {
      e.waitUntil(
        caches.keys().then(names => 
          Promise.all(names.filter(n => n !== CACHE_NAME).map(n => caches.delete(n)))
        ).then(() => self.clients.claim())
      );
    });
    
    self.addEventListener('fetch', e => {
      if (e.request.method !== 'GET') return;
      e.respondWith(
        caches.match(e.request).then(cached => {
          const fetchPromise = fetch(e.request).then(response => {
            if (response.ok) {
              const clone = response.clone();
              caches.open(CACHE_NAME).then(cache => cache.put(e.request, clone));
            }
            return response;
          }).catch(() => cached);
          return cached || fetchPromise;
        })
      );
    });
  `;
  
  try {
    const swBlob = new Blob([swCode], {type: 'application/javascript'});
    const swUrl = URL.createObjectURL(swBlob);
    
    navigator.serviceWorker.register(swUrl, {scope: './'})
      .then(reg => console.log('ServiceWorker Ë®ªÂÜäÊàêÂäü:', reg.scope))
      .catch(err => {
        // Blob URL ÊñπÂºèÂú®Êüê‰∫õÁí∞Â¢É‰∏ã‰∏çÊîØÊåÅÔºåÈÄôÊòØÊ≠£Â∏∏ÁöÑ
        console.log('ServiceWorker Ë®ªÂÜäÂ§±Êïó (Blob URL ÊñπÂºèÂèØËÉΩ‰∏çÂèóÊîØÊåÅ):', err.message);
      });
  } catch(e) {
    console.log('ServiceWorker ÂàùÂßãÂåñÂ§±Êïó:', e.message);
  }
}

// ÂâµÂª∫‰∏¶Ê≥®ÂÖ• manifest
const manifest = {
  "name": "ÁπîÂ§¢ - AI‰∫íÂãïÂ∞èË™™Èñ±ËÆÄÂô®",
  "short_name": "ÁπîÂ§¢",
  "description": "AI‰∫íÂãïÂ∞èË™™Èñ±ËÆÄÂô® - ÂâµÂª∫‰Ω†ÁöÑÂ∞àÂ±¨ÊïÖ‰∫ã",
  "start_url": "./",
  "display": "standalone",
  "background_color": "#0F0F1A",
  "theme_color": "#8B7CF7",
  "orientation": "portrait",
  "icons": [
    {
      "src": "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect fill='%238B7CF7' width='512' height='512' rx='80'/><text x='256' y='340' text-anchor='middle' fill='white' font-size='280' font-family='serif'>Áπî</text></svg>",
      "sizes": "512x512",
      "type": "image/svg+xml",
      "purpose": "any maskable"
    },
    {
      "src": "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%238B7CF7' width='192' height='192' rx='30'/><text x='96' y='130' text-anchor='middle' fill='white' font-size='110' font-family='serif'>Áπî</text></svg>",
      "sizes": "192x192",
      "type": "image/svg+xml"
    }
  ]
};

const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
const manifestUrl = URL.createObjectURL(manifestBlob);
const manifestLink = document.createElement('link');
manifestLink.rel = 'manifest';
manifestLink.href = manifestUrl;
document.head.appendChild(manifestLink);

// Áõ£ËÅΩÂÆâË£ùÊèêÁ§∫‰∫ã‰ª∂
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  // Êõ¥Êñ∞ÂÆâË£ùÁãÄÊÖãÈ°ØÁ§∫
  const statusEl = document.getElementById('pwa-install-status');
  if (statusEl) statusEl.textContent = 'ÂèØÂÆâË£ù ‚Ä∫';
  // È°ØÁ§∫ÂÆâË£ùÊèêÁ§∫
  showInstallBanner();
});

// Áõ£ËÅΩÂÆâË£ùÂÆåÊàê
window.addEventListener('appinstalled', () => {
  console.log('PWA Â∑≤ÂÆâË£ù');
  deferredPrompt = null;
  const statusEl = document.getElementById('pwa-install-status');
  if (statusEl) statusEl.textContent = '‚úì Â∑≤ÂÆâË£ù';
});

// È°ØÁ§∫ÂÆâË£ùÊèêÁ§∫Ê©´ÂπÖ
function showInstallBanner() {
  // Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ìÂÆâË£ùÊàñÂ∑≤Á∂ìÈ°ØÁ§∫ÈÅé
  if (window.matchMedia('(display-mode: standalone)').matches) return;
  if (localStorage.getItem('pwa-install-dismissed')) return;
  
  const banner = document.createElement('div');
  banner.id = 'install-banner';
  banner.innerHTML = `
    <div style="position:fixed;bottom:80px;left:16px;right:16px;max-width:388px;margin:0 auto;background:linear-gradient(135deg,var(--primary-dark),var(--primary));padding:16px;border-radius:12px;box-shadow:0 4px 20px rgba(139,124,247,0.4);z-index:1000;display:flex;align-items:center;gap:12px;">
      <div style="font-size:32px">üì±</div>
      <div style="flex:1">
        <div style="font-size:14px;font-weight:600;color:white;margin-bottom:4px">ÂÆâË£ùÂà∞‰∏ªÁï´Èù¢</div>
        <div style="font-size:12px;color:rgba(255,255,255,0.8)">ÂÉè App ‰∏ÄÊ®£‰ΩøÁî®ÁπîÂ§¢</div>
      </div>
      <button onclick="installPWA()" style="padding:8px 16px;background:white;color:var(--primary);border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer">ÂÆâË£ù</button>
      <button onclick="dismissInstallBanner()" style="padding:8px;background:transparent;color:rgba(255,255,255,0.8);border:none;font-size:18px;cursor:pointer">√ó</button>
    </div>
  `;
  document.body.appendChild(banner);
}

// Ë™øË©¶ API ÈÄ£Êé•
async function debugApiTest() {
  const testUrl = 'https://api.deepseek.com/v1/chat/completions';
  const info = {
    userAgent: navigator.userAgent,
    platform: navigator.platform,
    isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent),
    isAndroid: /Android/.test(navigator.userAgent),
    isSafari: /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent),
    isChrome: /Chrome/.test(navigator.userAgent),
    location: window.location.href,
    protocol: window.location.protocol,
    online: navigator.onLine
  };
  
  let result = `üì± Ë®≠ÂÇô‰ø°ÊÅØÔºö\n`;
  result += `‚Ä¢ Âπ≥Âè∞: ${info.platform}\n`;
  result += `‚Ä¢ iOS: ${info.isIOS}\n`;
  result += `‚Ä¢ Safari: ${info.isSafari}\n`;
  result += `‚Ä¢ Chrome: ${info.isChrome}\n`;
  result += `‚Ä¢ Âú®Á∑ö: ${info.online}\n`;
  result += `‚Ä¢ ÂçîË≠∞: ${info.protocol}\n\n`;
  
  result += `üîó Ê∏¨Ë©¶ÈÄ£Êé•Âà∞: ${testUrl}\n\n`;
  
  // Ê∏¨Ë©¶ 1: Á∞°ÂñÆ GET Ë´ãÊ±Ç
  result += `Ê∏¨Ë©¶ 1: HEAD Ë´ãÊ±Ç...\n`;
  try {
    const r1 = await fetch(testUrl, { method: 'HEAD', mode: 'cors' });
    result += `‚úÖ HEAD ÊàêÂäü: ${r1.status}\n\n`;
  } catch(e) {
    result += `‚ùå HEAD Â§±Êïó: ${e.name} - ${e.message}\n\n`;
  }
  
  // Ê∏¨Ë©¶ 2: POST Ë´ãÊ±ÇÔºàÁÑ° bodyÔºâ
  result += `Ê∏¨Ë©¶ 2: POST Ë´ãÊ±ÇÔºàÁÑ°Ë™çË≠âÔºâ...\n`;
  try {
    const r2 = await fetch(testUrl, { 
      method: 'POST', 
      mode: 'cors',
      credentials: 'omit',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({})
    });
    const t2 = await r2.text();
    result += `‚úÖ POST ÁãÄÊÖã: ${r2.status}\n`;
    result += `ÈüøÊáâ: ${t2.slice(0, 100)}...\n\n`;
  } catch(e) {
    result += `‚ùå POST Â§±Êïó: ${e.name} - ${e.message}\n`;
    result += `ÈåØË™§È°ûÂûã: ${e.constructor.name}\n\n`;
  }
  
  // Ê∏¨Ë©¶ 3: Ê∏¨Ë©¶Âè¶‰∏ÄÂÄã API
  const testUrl2 = 'https://httpbin.org/post';
  result += `Ê∏¨Ë©¶ 3: httpbin.orgÔºàCORS Ê∏¨Ë©¶ÊúçÂãôÔºâ...\n`;
  try {
    const r3 = await fetch(testUrl2, { 
      method: 'POST', 
      mode: 'cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ test: 'hello' })
    });
    const t3 = await r3.text();
    result += `‚úÖ httpbin ÊàêÂäü: ${r3.status}\n`;
    result += `ÈüøÊáâ: ${t3.slice(0, 80)}...\n\n`;
  } catch(e) {
    result += `‚ùå httpbin Â§±Êïó: ${e.name} - ${e.message}\n\n`;
  }
  
  // È°ØÁ§∫ÁµêÊûú
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.style.cssText = 'max-width:90%;max-height:80vh;overflow:auto;white-space:pre-wrap;font-family:monospace;font-size:12px;text-align:left;';
  modal.innerHTML = `
    <div class="modal-title">üîß API Ë™øË©¶ÁµêÊûú</div>
    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;margin-bottom:16px;max-height:50vh;overflow:auto;">${result}</div>
    <div class="modal-actions">
      <button class="modal-btn confirm" onclick="this.closest('.modal').remove();document.getElementById('overlay').classList.remove('active')">ÈóúÈñâ</button>
    </div>
  `;
  document.getElementById('overlay').classList.add('active');
  document.body.appendChild(modal);
}

// ÂÆâË£ù PWA
async function installPWA() {
  if (!deferredPrompt) {
    // Â∞çÊñº iOSÔºåÈ°ØÁ§∫ÊâãÂãïÂÆâË£ùÊåáÂºï
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    if (isIOS) {
      showModal('ios-install-modal');
    } else {
      toast(T('Ë´ã‰ΩøÁî®ÁÄèË¶ΩÂô®ËèúÂñÆ‰∏≠ÁöÑ„ÄåÂä†ÂÖ•‰∏ªÁï´Èù¢„ÄçÂäüËÉΩ'), 'info');
    }
    dismissInstallBanner();
    return;
  }
  
  deferredPrompt.prompt();
  const result = await deferredPrompt.userChoice;
  console.log('ÂÆâË£ùÁµêÊûú:', result.outcome);
  deferredPrompt = null;
  dismissInstallBanner();
  
  if (result.outcome === 'accepted') {
    toast(T('üéâ ÂÆâË£ùÊàêÂäüÔºÅ'), 'success');
  }
}

// ÈóúÈñâÂÆâË£ùÊ©´ÂπÖ
function dismissInstallBanner() {
  const banner = document.getElementById('install-banner');
  if (banner) banner.remove();
  localStorage.setItem('pwa-install-dismissed', 'true');
}

// Ê™¢Ê∏¨ÊòØÂê¶‰ª• PWA Ê®°ÂºèÈÅãË°å
if (window.matchMedia('(display-mode: standalone)').matches) {
  console.log('Ê≠£Âú®‰ª• PWA Ê®°ÂºèÈÅãË°å');
  // Êõ¥Êñ∞ÂÆâË£ùÁãÄÊÖã
  setTimeout(() => {
    const statusEl = document.getElementById('pwa-install-status');
    if (statusEl) statusEl.textContent = '‚úì Â∑≤ÂÆâË£ù';
  }, 100);
}

// ============================================
// Êåá‰ª§ÁîüÊàêÂêëÂ∞éÁ≥ªÁµ±
// ============================================

// ÂêëÂ∞éÁãÄÊÖã
let wizardState = {
  step: 0,
  data: {
    template: null,
    basic: { type: '', era: '', setting: '', theme: '' },
    protagonist: { name: '', identity: '', gender: '', personality: '', appearance: '', background: '', goal: '' },
    characters: [],
    mechanics: { attributes: [], systems: [], triggers: [] },
    style: { tone: '', perspective: '', detail: '', format: '' },
    aiRules: { dos: [], donts: [], special: '' },
    examples: { opening: '', response: '', status: '' },
    aiChat: []
  },
  aiAsked: false
};

// È†êË®≠Ê®°Êùø
const wizardTemplates = [
  {
    id: 'palace',
    name: 'ÂÆÆÂª∑ÂæåÂÆÆ',
    icon: 'üëë',
    desc: 'ÂÆÆÈ¨•„ÄÅÊ¨äË¨Ä„ÄÅÊÑõÊÅ®‰∫§Áπî',
    preset: {
      type: 'ÂÆÆÂª∑ÂæåÂÆÆ',
      era: 'Êû∂Á©∫Âè§‰ª£Êù±Êñπ',
      attributes: ['Â•ΩÊÑüÂ∫¶(Ë°®Èù¢/ÁúüÂØ¶)', 'Âø†Ë™†Â∫¶', 'ÈáéÂøÉÂÄº', 'Ê¨äÂã¢', 'ÂØµÊÑõÂ∫¶'],
      systems: ['Ê¥æÁ≥ªÂã¢Âäõ', 'ÂæåÂÆÆ‰Ωç‰ªΩ', 'ÊúùÂ†ÇÊîøÊ≤ª'],
      tone: 'Ê≤âÁ©©Á¥∞ËÜ©',
      perspective: 'Á¨¨‰∫å‰∫∫Á®±'
    }
  },
  {
    id: 'cultivation',
    name: '‰øÆ‰ªôÁéÑÂπª',
    icon: '‚öîÔ∏è',
    desc: '‰øÆÁÖâ„ÄÅÊ≠∑Á∑¥„ÄÅÂïèÈÅìÈï∑Áîü',
    preset: {
      type: '‰øÆ‰ªôÁéÑÂπª',
      era: 'Êû∂Á©∫‰ªô‰ø†‰∏ñÁïå',
      attributes: ['Â¢ÉÁïå', 'ÈùàÂäõ', 'Â£ΩÂÖÉ', 'ÊÇüÊÄß', 'Ê∞£ÈÅã'],
      systems: ['ÂÆóÈñÄÈ´îÁ≥ª', 'ÂäüÊ≥ïÂÇ≥Êâø', 'Â§©ÊùêÂú∞ÂØ∂'],
      tone: 'ÁÜ±Ë°ÄÊøÄÊòÇ',
      perspective: 'Á¨¨‰∫å‰∫∫Á®±'
    }
  },
  {
    id: 'apocalypse',
    name: 'Êú´Êó•ÁîüÂ≠ò',
    icon: 'üßü',
    desc: 'Âª¢Âúü„ÄÅÂñ™Â±ç„ÄÅ‰∫∫ÊÄßËÄÉÈ©ó',
    preset: {
      type: 'Êú´Êó•ÁîüÂ≠ò',
      era: 'ËøëÊú™‰æÜÂª¢Âúü',
      attributes: ['ÁîüÂëΩÂÄº', 'È£¢È§ìÂ∫¶', 'Á≤æÁ•ûÂÄº', 'ÊÑüÊüìÂ∫¶', 'ËÅ≤Êúõ'],
      systems: ['ÊìöÈªûÂª∫Ë®≠', 'Áâ©Ë≥áÁÆ°ÁêÜ', 'ÂÄñÂ≠òËÄÖÈóú‰øÇ'],
      tone: 'Á∑äÂºµÂà∫ÊøÄ',
      perspective: 'Á¨¨‰∫å‰∫∫Á®±'
    }
  },
  {
    id: 'fantasy',
    name: 'Ë•øÂπªÂÜíÈö™',
    icon: 'üêâ',
    desc: 'ÂäçËàáÈ≠îÊ≥ïÁöÑÂè≤Ë©©ÊóÖÈÄî',
    preset: {
      type: 'Ë•øÊñπÂ•áÂπª',
      era: '‰∏≠‰∏ñÁ¥ÄÈ≠îÊ≥ï‰∏ñÁïå',
      attributes: ['HP', 'MP', 'ÂäõÈáè', 'ÊïèÊç∑', 'Êô∫Âäõ', 'È≠ÖÂäõ'],
      systems: ['ËÅ∑Ê•≠ÊàêÈï∑', 'ÊäÄËÉΩÊ®π', '‰ªªÂãôÁ≥ªÁµ±'],
      tone: 'Âè≤Ë©©Â£ØÈóò',
      perspective: 'Á¨¨‰∫å‰∫∫Á®±'
    }
  },
  {
    id: 'modern',
    name: 'ÈÉΩÂ∏ÇÊÉÖÊÑü',
    icon: 'üåÉ',
    desc: 'ÈÉΩÂ∏ÇÊÑõÊÉÖ„ÄÅËÅ∑Â†¥„ÄÅÊó•Â∏∏',
    preset: {
      type: 'Áèæ‰ª£ÈÉΩÂ∏Ç',
      era: 'Áï∂‰ª£ÈÉΩÂ∏Ç',
      attributes: ['Â•ΩÊÑüÂ∫¶', 'ÈáëÈå¢', 'Á§æÊúÉÂú∞‰Ωç', 'Â£ìÂäõÂÄº', 'È≠ÖÂäõ'],
      systems: ['Á§æ‰∫§Èóú‰øÇ', '‰∫ãÊ•≠ÁôºÂ±ï', 'ÊÉÖÊÑüÁ∑ö'],
      tone: 'ËºïÈ¨ÜÊµ™Êº´',
      perspective: 'Á¨¨‰∫å‰∫∫Á®±'
    }
  },
  {
    id: 'custom',
    name: 'Ëá™ÂÆöÁæ©',
    icon: '‚ú®',
    desc: 'ÂæûÈõ∂ÈñãÂßãÂâµÂª∫',
    preset: null
  }
];

// ÂêëÂ∞éÈöéÊÆµÂÆöÁæ©
const wizardSteps = [
  { id: 'template', title: 'ÈÅ∏ÊìáÊ®°Êùø', icon: 'üìã' },
  { id: 'basic', title: 'Âü∫Á§éË®≠ÂÆö', icon: 'üåç' },
  { id: 'protagonist', title: '‰∏ªËßíË®≠ÂÆö', icon: 'üë§' },
  { id: 'characters', title: 'ÈÖçËßíÁ≥ªÁµ±', icon: 'üë•' },
  { id: 'mechanics', title: 'ÈÅäÊà≤Ê©üÂà∂', icon: '‚öôÔ∏è' },
  { id: 'style', title: 'ÂØ´‰ΩúÈ¢®Ê†º', icon: '‚úçÔ∏è' },
  { id: 'aiRules', title: 'AIË°åÁÇ∫', icon: 'ü§ñ' },
  { id: 'finish', title: 'ÂÆåÊàêÁîüÊàê', icon: 'üéâ' }
];

// ÁØÑ‰æãÁâáÊÆµ
const wizardExamples = {
  basic: `## ‰∏ñÁïåËßÄË®≠ÂÆö
ÈÄôÊòØ‰∏ÄÂÄãÊû∂Á©∫ÁöÑÊù±ÊñπÂÆÆÂª∑‰∏ñÁïåÔºå‰ª•ÊòéÊ∏ÖÁÇ∫ËóçÊú¨‰ΩÜËûçÂÖ•‰∫ÜÊõ¥Â§öÂ•áÂπªÂÖÉÁ¥†„ÄÇÁöáÂüéÂàÜÁÇ∫Â§ñÊúùËàáÂÖßÂª∑ÔºåÂ§ñÊúùËôïÁêÜÊúùÊîøÔºåÂÖßÂª∑ÂâáÊòØÂêéÂ¶ÉÂ±ÖÊâÄ„ÄÇÂêéÂÆÆÂìÅÁ¥öÂæûÈ´òÂà∞‰ΩéÁÇ∫ÔºöÁöáÂêé„ÄÅÁöáË≤¥Â¶É„ÄÅË≤¥Â¶É„ÄÅÂ¶É„ÄÅÂ¨™„ÄÅË≤¥‰∫∫„ÄÅÂ∏∏Âú®„ÄÅÁ≠îÊáâ„ÄÇ`,
  protagonist: `## ‰∏ªËßíË®≠ÂÆö
‰Ω†ÊòØÂâõÂÖ•ÂÆÆÁöÑÊñ∞ÊôâË≤¥‰∫∫ÔºåÂá∫Ë∫´Ê±üÂçóÊõ∏È¶ôÈñÄÁ¨¨„ÄÇ‰Ω†Â§ñË°®Ê∫´Â©âÁ´ØËéäÔºåÂØ¶ÂâáËÅ∞ÊÖßÊ©üÊïèÔºåÂøÉ‰∏≠ÊúâËëóËá™Â∑±ÁöÑÂ†ÖÊåÅËàáÂ∫ïÁ∑ö„ÄÇ‰Ω†ÁöÑÁà∂Ë¶™ÊòØÁï∂ÊúùÁø∞ÊûóÔºåÂõ†ÂÆ∂ÊóèÈúÄË¶Å‰∏ÄÂÄãÂú®ÂÆÆ‰∏≠ÁöÑÊ£ãÂ≠êËÄåË¢´ÈÄÅÂÖ•ÂÆÆ‰∏≠„ÄÇ‰Ω†ÁöÑÁõÆÊ®ôÊòØÂú®ÈÄôÂêÉ‰∫∫ÁöÑÂæåÂÆÆ‰∏≠‰øùÂÖ®Ëá™Â∑±ÂíåÂÆ∂Êóè„ÄÇ`,
  characters: `## ‰∏ªË¶ÅËßíËâ≤
### ÁöáÂ∏ù - Ëï≠ÁÖú
Âπ¥Á¥Ñ‰∫åÂçÅ‰∫îÔºåÂú®‰Ωç‰∏âÂπ¥„ÄÇË°®Èù¢Ê∫´ÂíåÂØ°Ë®ÄÔºåÂØ¶ÂâáÂüéÂ∫úÊ•µÊ∑±„ÄÇÂ∞çÂæåÂÆÆË´∏‰∫ãÁúã‰ºº‰∏ç‰∏äÂøÉÔºåÂØ¶Ââá‰∏ÄÂàáÁõ°Âú®ÊéåÊè°„ÄÇÂñúÊÄí‰∏çÂΩ¢ÊñºËâ≤ÔºåËÆì‰∫∫Èõ£‰ª•ÊçâÊë∏„ÄÇ

### ÁöáÂêé - Ê≤àÊ∞è
Â§™ÂêéÂ®òÂÆ∂‰æÑÂ•≥ÔºåÁ´ØËéäË≥¢Ê∑ëÔºåËôï‰∫ãÂÖ¨ÂÖÅ„ÄÇ‰ΩÜÂú®ÁöáÂêéÁöÑÂ§ñË°®‰∏ãÔºåÊöóËóèËëóÂ∞çÊ¨äÂäõÁöÑÊ∏¥ÊúõÂíåÂ∞çËá™Ë∫´ËôïÂ¢ÉÁöÑ‰∏çÂÆâ„ÄÇ`,
  mechanics: `## ÈÅäÊà≤Ê©üÂà∂
### Â•ΩÊÑüÂ∫¶Á≥ªÁµ±
ÊØèÂÄãËßíËâ≤ÊúâÂÖ©ÂÄãÂ•ΩÊÑüÂ∫¶Êï∏ÂÄºÔºö
- Ë°®Èù¢Â•ΩÊÑüÔºöNPC Â∞ç‰∏ªËßíÂ±ïÁèæÁöÑÊÖãÂ∫¶Ôºà0-100Ôºâ
- ÁúüÂØ¶Â•ΩÊÑüÔºöNPC ÂÖßÂøÉÁúüÂØ¶ÁöÑÊÉ≥Ê≥ïÔºà0-100Ôºâ
È´òË°®Èù¢Â•ΩÊÑü+‰ΩéÁúüÂØ¶Â•ΩÊÑü=ÂèØËÉΩÊòØÂÅΩË£ù
‰ΩéË°®Èù¢Â•ΩÊÑü+È´òÁúüÂØ¶Â•ΩÊÑü=ÂÇ≤Â¨å/Ê∑±Ëóè‰∏çÈú≤

### ÊØèÊ¨°‰∫íÂãïÂæåË´ãÊõ¥Êñ∞ÁãÄÊÖãÔºö
\`\`\`
„ÄêÁãÄÊÖãÊõ¥Êñ∞„Äë
ÊôÇÈñìÔºöXXÂπ¥XXÊúàXXÊó• XXÊôÇ
Âú∞ÈªûÔºöXXX
ËßíËâ≤ÁãÄÊÖãËÆäÂåñÔºö
- XXXÔºöË°®Èù¢Â•ΩÊÑü +5 ‚Üí 75ÔºåÁúüÂØ¶Â•ΩÊÑü ‰∏çËÆä 50
\`\`\``,
  style: `## ÂØ´‰ΩúÈ¢®Ê†ºË¶ÅÊ±Ç
- Êé°Áî®Âè§È¢®ÂÖ∏ÈõÖÁöÑÊñáÂ≠óÈ¢®Ê†ºÔºåÈÅ©Áï∂‰ΩøÁî®Ë©©Ë©ûÂÖ∏ÊïÖ
- ÊèèÂØ´Á¥∞ËÜ©ÔºåÊ≥®ÈáçÊ∞õÂúçÁáüÈÄ†ÂíåÂøÉÁêÜÂàªÁï´
- Â∞çË©±Ë¶ÅÁ¨¶ÂêàËßíËâ≤Ë∫´‰ªΩÔºåÂÆÆÂª∑Áî®Ë™ûÂæóÈ´î
- ÊØèÊÆµÂõûË¶ÜÊéßÂà∂Âú®800-1500Â≠ó
- ÈÅ©ÊôÇÂä†ÂÖ•Áí∞Â¢ÉÊèèÂØ´ÂíåËßíËâ≤ÂæÆË°®ÊÉÖÁ¥∞ÁØÄ`
};

// ÂïüÂãïÂêëÂ∞é
function startWizard() {
  wizardState = {
    step: 0,
    data: {
      template: null,
      basic: { type: '', era: '', setting: '', theme: '' },
      protagonist: { name: '', identity: '', gender: '', personality: '', appearance: '', background: '', goal: '' },
      characters: [],
      mechanics: { attributes: [], systems: [], triggers: [] },
      style: { tone: '', perspective: '', detail: '', format: '' },
      aiRules: { dos: [], donts: [], special: '' },
      examples: { opening: '', response: '', status: '' },
      aiChat: []
    },
    aiAsked: false
  };
  renderWizardStep();
  goTo('view-wizard');
}

function exitWizard() {
  showConfirm('Á¢∫ÂÆöË¶ÅÈÄÄÂá∫ÂóéÔºüÂ∑≤Â°´ÂØ´ÁöÑÂÖßÂÆπÂ∞á‰∏çÊúÉ‰øùÂ≠ò„ÄÇ', () => {
    goBack();
  });
}

function showWizardHelp() {
  showConfirm(
    'Êåá‰ª§ÁîüÊàêÂêëÂ∞éÂπ´Âä©\n\n' +
    'ÈÄôÂÄãÂêëÂ∞éÂ∞áÂºïÂ∞é‰Ω†ÂâµÂª∫‰∏ÄÂÄãÂÆåÊï¥ÁöÑÊñáÊ∏∏Êåá‰ª§„ÄÇ\n\n' +
    '‚Ä¢ ÂÖ± 8 ÂÄãÊ≠•È©üÔºåÂèØÈö®ÊôÇËøîÂõû‰øÆÊîπ\n' +
    '‚Ä¢ ÊØèÊ≠•ÈÉΩÊúâ AI Êô∫ËÉΩÊèêÂïèÂπ´Âä©ÂÆåÂñÑ\n' +
    '‚Ä¢ ÊúÄÂæåÂèØÂ∞éÂá∫ÁÇ∫ÊñáÊ™îÊàñ‰øùÂ≠òÁÇ∫Êåá‰ª§\n\n' +
    'Â∞èÊäÄÂ∑ßÔºöÈÅ∏ÊìáÈ†êË®≠Ê®°ÊùøÂèØ‰ª•Âø´ÈÄüÈñãÂßãÔºÅ',
    null, false, 'üí° Âπ´Âä©'
  );
}

// Ê∏≤ÊüìÁï∂ÂâçÊ≠•È©ü
function renderWizardStep() {
  const step = wizardSteps[wizardState.step];
  document.getElementById('wizard-title').textContent = step.title;
  document.getElementById('wizard-progress-fill').style.width = ((wizardState.step + 1) / wizardSteps.length * 100) + '%';
  document.getElementById('wizard-progress-text').textContent = `${wizardState.step + 1}/${wizardSteps.length} ${step.title}`;
  
  // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
  document.getElementById('wizard-prev').disabled = wizardState.step === 0;
  const nextBtn = document.getElementById('wizard-next');
  if (wizardState.step === wizardSteps.length - 1) {
    nextBtn.textContent = 'ÂÆåÊàê';
  } else {
    nextBtn.textContent = '‰∏ã‰∏ÄÊ≠•';
  }
  
  const content = document.getElementById('wizard-content');
  wizardState.aiAsked = false;
  
  switch(step.id) {
    case 'template': renderTemplateStep(content); break;
    case 'basic': renderBasicStep(content); break;
    case 'protagonist': renderProtagonistStep(content); break;
    case 'characters': renderCharactersStep(content); break;
    case 'mechanics': renderMechanicsStep(content); break;
    case 'style': renderStyleStep(content); break;
    case 'aiRules': renderAiRulesStep(content); break;
    case 'finish': renderFinishStep(content); break;
  }
}

// Ê≠•È©ü 0ÔºöÈÅ∏ÊìáÊ®°Êùø
function renderTemplateStep(container) {
  container.innerHTML = `
    <div class="wizard-section">
      <div class="wizard-section-title">üìã ÈÅ∏Êìá‰∏ÄÂÄãÊ®°ÊùøÈñãÂßã</div>
      <div class="wizard-section-desc">ÈÅ∏ÊìáÈ†êË®≠Ê®°ÊùøÂèØ‰ª•Âø´ÈÄüÂ°´ÂÖÖÂ∏∏Áî®Ë®≠ÂÆöÔºå‰Ω†‰πüÂèØ‰ª•ÈÅ∏Êìá„ÄåËá™ÂÆöÁæ©„ÄçÂæûÈõ∂ÈñãÂßã„ÄÇ</div>
      <div class="wizard-options">
        ${wizardTemplates.map(t => `
          <div class="wizard-option template ${wizardState.data.template === t.id ? 'selected' : ''}" onclick="selectTemplate('${t.id}')">
            <div class="template-icon">${t.icon}</div>
            <div class="template-name">${t.name}</div>
            <div class="template-desc">${t.desc}</div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

function selectTemplate(id) {
  wizardState.data.template = id;
  const template = wizardTemplates.find(t => t.id === id);
  if (template?.preset) {
    // ÊáâÁî®È†êË®≠
    wizardState.data.basic.type = template.preset.type || '';
    wizardState.data.basic.era = template.preset.era || '';
    wizardState.data.mechanics.attributes = template.preset.attributes || [];
    wizardState.data.mechanics.systems = template.preset.systems || [];
    wizardState.data.style.tone = template.preset.tone || '';
    wizardState.data.style.perspective = template.preset.perspective || '';
  }
  renderWizardStep();
}

// Ê≠•È©ü 1ÔºöÂü∫Á§éË®≠ÂÆö
function renderBasicStep(container) {
  const d = wizardState.data.basic;
  container.innerHTML = `
    <div class="wizard-section">
      <div class="wizard-section-title">üåç ‰∏ñÁïåËßÄÂü∫Á§éË®≠ÂÆö</div>
      <div class="wizard-section-desc">ÂÆöÁæ©ÊïÖ‰∫ãÁôºÁîüÁöÑ‰∏ñÁïåËÉåÊôØÔºåÈÄôÂ∞áÊ±∫ÂÆöÊï¥ÂÄãÊïÖ‰∫ãÁöÑÂü∫Ë™ø„ÄÇ</div>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">ÊïÖ‰∫ãÈ°ûÂûã</label>
      <input class="wizard-input" id="wiz-type" value="${esc(d.type)}" placeholder="Â¶ÇÔºöÂÆÆÂª∑ÂæåÂÆÆ„ÄÅ‰øÆ‰ªôÁéÑÂπª„ÄÅÊú´Êó•ÁîüÂ≠ò...">
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">ÊôÇ‰ª£ËÉåÊôØ</label>
      <input class="wizard-input" id="wiz-era" value="${esc(d.era)}" placeholder="Â¶ÇÔºöÊû∂Á©∫Âè§‰ª£„ÄÅËøëÊú™‰æÜ„ÄÅ‰∏≠‰∏ñÁ¥ÄÈ≠îÊ≥ï‰∏ñÁïå...">
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">‰∏ñÁïåËßÄË®≠ÂÆö</label>
      <textarea class="wizard-input wizard-textarea" id="wiz-setting" placeholder="ÊèèËø∞ÈÄôÂÄã‰∏ñÁïåÁöÑÁç®ÁâπË®≠ÂÆö„ÄÅË¶èÂâá„ÄÅÊ≠∑Âè≤ËÉåÊôØÁ≠â...">${esc(d.setting)}</textarea>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">Ê†∏ÂøÉ‰∏ªÈ°å</label>
      <input class="wizard-input" id="wiz-theme" value="${esc(d.theme)}" placeholder="Â¶ÇÔºöÊ¨äË¨ÄÈ¨•Áà≠„ÄÅÊàêÈï∑ËõªËÆä„ÄÅÊÑõÊÅ®Á≥æËëõ...">
      
      <div class="wizard-example">
        <div class="wizard-example-title">üìù ÁØÑ‰æãÂèÉËÄÉ</div>
        ${wizardExamples.basic}
      </div>
    </div>
    <div class="wizard-ai-container"></div>
  `;
  
  // Ëá™ÂãïËß∏Áôº AI ÊèêÂïè
  setTimeout(() => askWizardAI('basic'), 500);
}

// Ê≠•È©ü 2Ôºö‰∏ªËßíË®≠ÂÆö
function renderProtagonistStep(container) {
  const d = wizardState.data.protagonist;
  container.innerHTML = `
    <div class="wizard-section">
      <div class="wizard-section-title">üë§ ‰∏ªËßíË®≠ÂÆö</div>
      <div class="wizard-section-desc">Ë©≥Á¥∞Ë®≠ÂÆö‰∏ªËßíÁöÑÂêÑÈ†ÖÂ±¨ÊÄßÔºåÈÄôÂ∞áÊòØÁé©ÂÆ∂‰ª£ÂÖ•ÁöÑËßíËâ≤„ÄÇ</div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div>
          <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">Á®±Âëº/ÂêçÂ≠ó</label>
          <input class="wizard-input" id="wiz-pname" value="${esc(d.name)}" placeholder="Â¶ÇÔºö‰Ω†„ÄÅÂ∞ë‰ø†„ÄÅÊÆø‰∏ã...">
        </div>
        <div>
          <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">ÊÄßÂà•</label>
          <select class="wizard-input" id="wiz-pgender" style="padding:12px">
            <option value="">Ë´ãÈÅ∏Êìá</option>
            <option value="male" ${d.gender==='male'?'selected':''}>Áî∑</option>
            <option value="female" ${d.gender==='female'?'selected':''}>Â•≥</option>
            <option value="custom" ${d.gender==='custom'?'selected':''}>Ëá™ÂÆöÁæ©/‰∏çÈôê</option>
          </select>
        </div>
      </div>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">Ë∫´‰ªΩÂú∞‰Ωç</label>
      <input class="wizard-input" id="wiz-pidentity" value="${esc(d.identity)}" placeholder="Â¶ÇÔºöÊñ∞ÊôâË≤¥‰∫∫„ÄÅÊï£‰øÆ„ÄÅÂÄñÂ≠òËÄÖ...">
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">ÊÄßÊ†ºÁâπÈªû</label>
      <input class="wizard-input" id="wiz-ppersonality" value="${esc(d.personality)}" placeholder="Â¶ÇÔºöÂ§ñÊüîÂÖßÂâõ„ÄÅËÖπÈªëÊ©üÊô∫„ÄÅÁÜ±Ë°ÄÊ≠£Áõ¥...">
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">Â§ñË≤åÊèèËø∞</label>
      <textarea class="wizard-input wizard-textarea" id="wiz-pappearance" placeholder="‰∏ªËßíÁöÑÂ§ñË≤åÁâπÂæµ...">${esc(d.appearance)}</textarea>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">ËÉåÊôØÊïÖ‰∫ã</label>
      <textarea class="wizard-input wizard-textarea" id="wiz-pbackground" placeholder="‰∏ªËßíÁöÑË∫´‰∏ñ„ÄÅ‰æÜÊ≠∑„ÄÅÈÅéÂéªÁöÑÁ∂ìÊ≠∑...">${esc(d.background)}</textarea>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">ÁõÆÊ®ô/ÂãïÊ©ü</label>
      <input class="wizard-input" id="wiz-pgoal" value="${esc(d.goal)}" placeholder="‰∏ªËßíÂú®ÊïÖ‰∫ã‰∏≠ÁöÑÁõÆÊ®ôÊòØ‰ªÄÈ∫ºÔºü">
      
      <div class="wizard-example">
        <div class="wizard-example-title">üìù ÁØÑ‰æãÂèÉËÄÉ</div>
        ${wizardExamples.protagonist}
      </div>
    </div>
    <div class="wizard-ai-container"></div>
  `;
  
  setTimeout(() => askWizardAI('protagonist'), 500);
}

// Ê≠•È©ü 3ÔºöÈÖçËßíÁ≥ªÁµ±
function renderCharactersStep(container) {
  const chars = wizardState.data.characters;
  container.innerHTML = `
    <div class="wizard-section">
      <div class="wizard-section-title">üë• ÈÖçËßíÁ≥ªÁµ±</div>
      <div class="wizard-section-desc">Ê∑ªÂä†ÊïÖ‰∫ã‰∏≠ÁöÑÈáçË¶Å NPCÔºåË±êÂØåÁöÑÈÖçËßíËÉΩËÆìÊïÖ‰∫ãÊõ¥Á≤æÂΩ©„ÄÇÂª∫Ë≠∞Ëá≥Â∞ë 3-5 ÂÄã‰∏ªË¶ÅËßíËâ≤„ÄÇ</div>
      
      <div class="wizard-char-list" id="wizard-char-list">
        ${chars.length ? chars.map((c, i) => `
          <div class="wizard-char-card">
            <div class="wizard-char-avatar">${c.avatar || 'üë§'}</div>
            <div class="wizard-char-info">
              <div class="wizard-char-name">${esc(c.name)}</div>
              <div class="wizard-char-role">${esc(c.role)} ¬∑ ${esc(c.relation)}</div>
            </div>
            <div class="wizard-char-actions">
              <button class="wizard-char-btn" onclick="editWizardChar(${i})">‚úèÔ∏è</button>
              <button class="wizard-char-btn" onclick="deleteWizardChar(${i})">üóëÔ∏è</button>
            </div>
          </div>
        `).join('') : '<div style="text-align:center;padding:20px;color:var(--text-tertiary)">Â∞öÊú™Ê∑ªÂä†ËßíËâ≤</div>'}
      </div>
      
      <button class="wizard-btn secondary" style="width:100%;margin-top:12px" onclick="addWizardChar()">‚ûï Ê∑ªÂä†ËßíËâ≤</button>
      <button class="wizard-btn secondary" style="width:100%;margin-top:8px" onclick="aiGenerateChars()">ü§ñ AI Âª∫Ë≠∞ËßíËâ≤</button>
      
      <div class="wizard-example">
        <div class="wizard-example-title">üìù ÁØÑ‰æãÂèÉËÄÉ</div>
        ${wizardExamples.characters}
      </div>
    </div>
    <div class="wizard-ai-container"></div>
  `;
  
  setTimeout(() => askWizardAI('characters'), 500);
}

// Ê≠•È©ü 4ÔºöÈÅäÊà≤Ê©üÂà∂
function renderMechanicsStep(container) {
  const d = wizardState.data.mechanics;
  const attrOptions = ['Â•ΩÊÑüÂ∫¶', 'Â•ΩÊÑüÂ∫¶(Ë°®Èù¢/ÁúüÂØ¶)', 'Âø†Ë™†Â∫¶', 'ÈáéÂøÉÂÄº', 'Ê¨äÂã¢', 'ÂØµÊÑõÂ∫¶', 'Â¢ÉÁïå', 'ÈùàÂäõ', 'Â£ΩÂÖÉ', 'ÁîüÂëΩÂÄº', 'È£¢È§ìÂ∫¶', 'Á≤æÁ•ûÂÄº', 'HP', 'MP', 'ÂäõÈáè', 'ÊïèÊç∑', 'Êô∫Âäõ', 'È≠ÖÂäõ', 'ÈáëÈå¢', 'ËÅ≤Êúõ'];
  const sysOptions = ['Ê¥æÁ≥ªÂã¢Âäõ', 'Â•ΩÊÑüÂ∫¶Á≥ªÁµ±', 'Êï∏ÂÄºÊàêÈï∑', 'ÊäÄËÉΩÊ®π', '‰ªªÂãôÁ≥ªÁµ±', 'Áâ©Ë≥áÁÆ°ÁêÜ', 'ÊìöÈªûÂª∫Ë®≠', 'ÊôÇÈñìÊµÅÈÄù', 'Èö±Ëóè‰∫ã‰ª∂', 'Â§öÁµêÂ±ÄÂàÜÊîØ', 'Èö®Ê©ü‰∫ã‰ª∂'];
  
  container.innerHTML = `
    <div class="wizard-section">
      <div class="wizard-section-title">‚öôÔ∏è ÈÅäÊà≤Ê©üÂà∂Ë®≠Ë®à</div>
      <div class="wizard-section-desc">Ë®≠Ë®àËÆìÊïÖ‰∫ãÊõ¥Êúâ‰∫íÂãïÊÄßÁöÑÊ©üÂà∂ÔºåÂêàÁêÜÁöÑÊ©üÂà∂ËÉΩÂ¢ûÂº∑‰ª£ÂÖ•ÊÑü„ÄÇ</div>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">ËßíËâ≤Â±¨ÊÄßÔºàÂèØÂ§öÈÅ∏Ôºâ</label>
      <div class="wizard-options" style="margin-bottom:16px">
        ${attrOptions.map(a => `
          <div class="wizard-option ${d.attributes.includes(a)?'selected':''}" onclick="toggleWizardOption('attributes','${a}')">${a}</div>
        `).join('')}
      </div>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">Ëá™ÂÆöÁæ©Â±¨ÊÄß</label>
      <input class="wizard-input" id="wiz-custom-attr" placeholder="Ëº∏ÂÖ•ÂæåÊåâ Enter Ê∑ªÂä†">
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px;margin-top:16px">ÈÅäÊà≤Á≥ªÁµ±ÔºàÂèØÂ§öÈÅ∏Ôºâ</label>
      <div class="wizard-options" style="margin-bottom:16px">
        ${sysOptions.map(s => `
          <div class="wizard-option ${d.systems.includes(s)?'selected':''}" onclick="toggleWizardOption('systems','${s}')">${s}</div>
        `).join('')}
      </div>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">ÁâπÊÆäËß∏ÁôºÊ©üÂà∂</label>
      <textarea class="wizard-input wizard-textarea" id="wiz-triggers" placeholder="ÊèèËø∞‰∏Ä‰∫õÁâπÊÆäÁöÑËß∏ÁôºÊ¢ù‰ª∂Ôºå‰æãÂ¶ÇÔºöÂ•ΩÊÑüÂ∫¶ÈÅîÂà∞ 80 ÊôÇËß£ÈéñÁâπÊÆäÂäáÊÉÖ...">${d.triggers.join('\n')}</textarea>
      
      <div class="wizard-example">
        <div class="wizard-example-title">üìù ÁØÑ‰æãÂèÉËÄÉ</div>
        ${wizardExamples.mechanics}
      </div>
    </div>
    <div class="wizard-ai-container"></div>
  `;
  
  // Ëá™ÂÆöÁæ©Â±¨ÊÄßËº∏ÂÖ•
  document.getElementById('wiz-custom-attr')?.addEventListener('keypress', e => {
    if (e.key === 'Enter' && e.target.value.trim()) {
      if (!d.attributes.includes(e.target.value.trim())) {
        d.attributes.push(e.target.value.trim());
        renderMechanicsStep(container);
      }
      e.target.value = '';
    }
  });
  
  setTimeout(() => askWizardAI('mechanics'), 500);
}

function toggleWizardOption(type, value) {
  const arr = wizardState.data.mechanics[type];
  const idx = arr.indexOf(value);
  if (idx >= 0) arr.splice(idx, 1);
  else arr.push(value);
  renderWizardStep();
}

// Ê≠•È©ü 5ÔºöÂØ´‰ΩúÈ¢®Ê†º
function renderStyleStep(container) {
  const d = wizardState.data.style;
  container.innerHTML = `
    <div class="wizard-section">
      <div class="wizard-section-title">‚úçÔ∏è ÂØ´‰ΩúÈ¢®Ê†ºË®≠ÂÆö</div>
      <div class="wizard-section-desc">ÂÆöÁæ© AI ÁöÑÂØ´‰ΩúÈ¢®Ê†ºÔºåËÆìÊïÖ‰∫ãÂëàÁèæÁ¨¶Âêà‰Ω†ÊúüÊúõÁöÑË≥™ÊÑü„ÄÇ</div>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">ÊñáÈ¢®Âü∫Ë™ø</label>
      <div class="wizard-options" style="margin-bottom:16px">
        ${['ËºïÈ¨ÜÊ≠°Âø´', 'Ê≤âÁ©©Á¥∞ËÜ©', 'ÁÜ±Ë°ÄÊøÄÊòÇ', 'ÈªëÊöóÂ£ìÊäë', 'Êµ™Êº´ÂîØÁæé', 'ÂπΩÈªòË´∑Âà∫', 'Âè≤Ë©©Â£ØÈóò', 'Êá∏ÁñëÁ∑äÂºµ'].map(t => `
          <div class="wizard-option ${d.tone===t?'selected':''}" onclick="wizardState.data.style.tone='${t}';renderWizardStep()">${t}</div>
        `).join('')}
      </div>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">Êïò‰∫ãË¶ñËßí</label>
      <div class="wizard-options" style="margin-bottom:16px">
        ${['Á¨¨‰∏Ä‰∫∫Á®±', 'Á¨¨‰∫å‰∫∫Á®±', 'Á¨¨‰∏â‰∫∫Á®±', '‰∏äÂ∏ùË¶ñËßí'].map(p => `
          <div class="wizard-option ${d.perspective===p?'selected':''}" onclick="wizardState.data.style.perspective='${p}';renderWizardStep()">${p}</div>
        `).join('')}
      </div>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">Á¥∞ÁØÄÁ®ãÂ∫¶</label>
      <div class="wizard-options" style="margin-bottom:16px">
        ${['Á∞°ÊΩîÊòéÂø´Ôºà300-500Â≠óÔºâ', 'ÈÅ©‰∏≠Ë©≥Á¥∞Ôºà500-1000Â≠óÔºâ', 'Ë±êÂØåÁ¥∞ËÜ©Ôºà1000-2000Â≠óÔºâ', 'Ë∂ÖÈï∑ÁØáÂπÖÔºà2000Â≠ó+Ôºâ'].map(d2 => `
          <div class="wizard-option ${d.detail===d2?'selected':''}" onclick="wizardState.data.style.detail='${d2}';renderWizardStep()">${d2}</div>
        `).join('')}
      </div>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">ÁâπÊÆäÊ†ºÂºèË¶ÅÊ±Ç</label>
      <textarea class="wizard-input wizard-textarea" id="wiz-format" placeholder="‰æãÂ¶ÇÔºöÊØèÊÆµÈñãÈ†≠Á©∫ÂÖ©Ê†º„ÄÅÂ∞çË©±Áî®„Äå„Äç„ÄÅÂÖßÂøÉÁç®ÁôΩÁî®ÔºàÔºâ...">${esc(d.format)}</textarea>
      
      <div class="wizard-example">
        <div class="wizard-example-title">üìù ÁØÑ‰æãÂèÉËÄÉ</div>
        ${wizardExamples.style}
      </div>
    </div>
    <div class="wizard-ai-container"></div>
  `;
  
  setTimeout(() => askWizardAI('style'), 500);
}

// Ê≠•È©ü 6ÔºöAI Ë°åÁÇ∫Ë¶èÂâá
function renderAiRulesStep(container) {
  const d = wizardState.data.aiRules;
  container.innerHTML = `
    <div class="wizard-section">
      <div class="wizard-section-title">ü§ñ AI Ë°åÁÇ∫Ë¶èÂâá</div>
      <div class="wizard-section-desc">Ë®≠ÂÆö AI ÊáâË©≤ÂÅö‰ªÄÈ∫º„ÄÅ‰∏çË©≤ÂÅö‰ªÄÈ∫ºÔºåÁ¢∫‰øùÊïÖ‰∫ãÊåâ‰Ω†ÁöÑÊúüÊúõÁôºÂ±ï„ÄÇ</div>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">AI ÊáâË©≤ÂÅöÁöÑÔºàDosÔºâ</label>
      <textarea class="wizard-input wizard-textarea" id="wiz-dos" placeholder="ÊØèË°å‰∏ÄÊ¢ùÔºå‰æãÂ¶ÇÔºö
- ‰øùÊåÅËßíËâ≤ÊÄßÊ†º‰∏ÄËá¥ÊÄß
- ÈÅ©ÊôÇÁµ¶Âá∫Ë°åÂãïÈÅ∏È†Ö
- ÊèèÂØ´ËßíËâ≤ÂæÆË°®ÊÉÖËÆäÂåñ">${d.dos.join('\n')}</textarea>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">AI ‰∏çÊáâË©≤ÂÅöÁöÑÔºàDon'tsÔºâ</label>
      <textarea class="wizard-input wizard-textarea" id="wiz-donts" placeholder="ÊØèË°å‰∏ÄÊ¢ùÔºå‰æãÂ¶ÇÔºö
- ‰∏çË¶ÅÊìÖËá™Ê±∫ÂÆö‰∏ªËßíÁöÑË°åÂãï
- ‰∏çË¶ÅË∑≥ÈÅéÈáçË¶ÅÂäáÊÉÖ
- ‰∏çË¶ÅËÆìËßíËâ≤Á™ÅÁÑ∂ÊÄßÊ†ºÂ§ßËÆä">${d.donts.join('\n')}</textarea>
      
      <label style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px">ÁâπÊÆäÊåá‰ª§</label>
      <textarea class="wizard-input wizard-textarea" id="wiz-special" placeholder="ÂÖ∂‰ªñÁâπÊÆäË¶ÅÊ±Ç...">${esc(d.special)}</textarea>
    </div>
    <div class="wizard-ai-container"></div>
  `;
  
  setTimeout(() => askWizardAI('aiRules'), 500);
}

// Ê≠•È©ü 7ÔºöÂÆåÊàê
function renderFinishStep(container) {
  const prompt = generatePrompt();
  const charCount = prompt.length;
  
  container.innerHTML = `
    <div class="wizard-section">
      <div class="wizard-section-title">üéâ Êåá‰ª§ÁîüÊàêÂÆåÊàêÔºÅ</div>
      <div class="wizard-section-desc">‰Ω†ÁöÑÊñáÊ∏∏Êåá‰ª§Â∑≤ÁîüÊàêÔºåÂèØ‰ª•È†êË¶Ω„ÄÅÁ∑®ËºØÊàñ‰øùÂ≠ò„ÄÇ</div>
      
      <div class="wizard-preview">
        <div class="wizard-preview-header">
          <div class="wizard-preview-title">üìÑ Êåá‰ª§È†êË¶Ω</div>
          <div class="wizard-preview-stats">${charCount.toLocaleString()} Â≠ó</div>
        </div>
        <div class="wizard-preview-content" id="wizard-preview-content">${esc(prompt.slice(0, 2000))}${prompt.length > 2000 ? '\n\n... (ÈªûÊìäÂ±ïÈñãÊü•ÁúãÊõ¥Â§ö)' : ''}</div>
      </div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:16px">
        <button class="wizard-btn secondary" onclick="previewFullPrompt()">üëÅÔ∏è ÂÆåÊï¥È†êË¶Ω</button>
        <button class="wizard-btn secondary" onclick="editPrompt()">‚úèÔ∏è Á∑®ËºØÂæÆË™ø</button>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
        <button class="wizard-btn secondary" onclick="exportPrompt('md')">üìÑ Â∞éÂá∫ MD</button>
        <button class="wizard-btn secondary" onclick="exportPrompt('txt')">üìù Â∞éÂá∫ TXT</button>
      </div>
      <button class="wizard-btn primary" style="width:100%;margin-top:8px" onclick="saveAsInstruction()">üíæ ‰øùÂ≠òÁÇ∫Êåá‰ª§</button>
    </div>
    
    <div class="wizard-section" style="margin-top:24px">
      <div class="wizard-section-title">üí¨ AI Â∞çË©±ÂÆåÂñÑ</div>
      <div class="wizard-section-desc">ÈÇÑÊúâ‰ªÄÈ∫ºÊÉ≥Ë£úÂÖÖÁöÑÔºüÂèØ‰ª•Âíå AI Â∞çË©±ÁπºÁ∫åÂÆåÂñÑÊåá‰ª§„ÄÇ</div>
      <div class="wizard-chat" id="wizard-chat">
        ${wizardState.data.aiChat.map(m => `
          <div class="wizard-chat-msg ${m.role}">${marked.parse(m.content)}</div>
        `).join('')}
      </div>
      <div class="wizard-chat-input">
        <input class="wizard-chat-field" id="wizard-chat-input" placeholder="Ëº∏ÂÖ•‰Ω†ÁöÑÊÉ≥Ê≥ï..." onkeypress="if(event.key==='Enter')sendWizardChat()">
        <button class="wizard-chat-send" onclick="sendWizardChat()">‚û§</button>
      </div>
    </div>
  `;
}

// ‰øùÂ≠òÁï∂ÂâçÊ≠•È©üÊï∏Êìö
function saveWizardStepData() {
  const step = wizardSteps[wizardState.step];
  switch(step.id) {
    case 'basic':
      wizardState.data.basic = {
        type: document.getElementById('wiz-type')?.value || '',
        era: document.getElementById('wiz-era')?.value || '',
        setting: document.getElementById('wiz-setting')?.value || '',
        theme: document.getElementById('wiz-theme')?.value || ''
      };
      break;
    case 'protagonist':
      wizardState.data.protagonist = {
        name: document.getElementById('wiz-pname')?.value || '',
        identity: document.getElementById('wiz-pidentity')?.value || '',
        gender: document.getElementById('wiz-pgender')?.value || '',
        personality: document.getElementById('wiz-ppersonality')?.value || '',
        appearance: document.getElementById('wiz-pappearance')?.value || '',
        background: document.getElementById('wiz-pbackground')?.value || '',
        goal: document.getElementById('wiz-pgoal')?.value || ''
      };
      break;
    case 'mechanics':
      const triggers = document.getElementById('wiz-triggers')?.value || '';
      wizardState.data.mechanics.triggers = triggers.split('\n').filter(t => t.trim());
      break;
    case 'style':
      wizardState.data.style.format = document.getElementById('wiz-format')?.value || '';
      break;
    case 'aiRules':
      const dos = document.getElementById('wiz-dos')?.value || '';
      const donts = document.getElementById('wiz-donts')?.value || '';
      wizardState.data.aiRules = {
        dos: dos.split('\n').filter(t => t.trim()),
        donts: donts.split('\n').filter(t => t.trim()),
        special: document.getElementById('wiz-special')?.value || ''
      };
      break;
  }
}

// ‰∏ä‰∏ÄÊ≠•/‰∏ã‰∏ÄÊ≠•
function wizardPrev() {
  if (wizardState.step > 0) {
    saveWizardStepData();
    wizardState.step--;
    renderWizardStep();
  }
}

function wizardNext() {
  saveWizardStepData();
  if (wizardState.step < wizardSteps.length - 1) {
    wizardState.step++;
    renderWizardStep();
  } else {
    saveAsInstruction();
  }
}

// AI ÊèêÂïè
async function askWizardAI(stepId) {
  if (wizardState.aiAsked) return;
  wizardState.aiAsked = true;
  
  const box = document.querySelector('.wizard-ai-container');
  if (!box) return;
  
  box.innerHTML = `
    <div class="wizard-ai-box">
      <div class="wizard-ai-header"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span> AI Ê≠£Âú®ÊÄùËÄÉ...</div>
    </div>
  `;
  
  try {
    const preset = await db.apiPresets.filter(p => p.isActive).first();
    if (!preset) {
      box.innerHTML = `<div class="wizard-ai-box"><div class="wizard-ai-header">‚ö†Ô∏è ÊèêÁ§∫</div><div class="wizard-ai-content">Ë´ãÂÖàÂú®Ë®≠ÁΩÆ‰∏≠ÈÖçÁΩÆ APIÔºåÊâçËÉΩ‰ΩøÁî® AI Êô∫ËÉΩÊèêÂïèÂäüËÉΩ„ÄÇ</div></div>`;
      return;
    }
    
    const context = JSON.stringify(wizardState.data, null, 2);
    const prompts = {
      basic: `Áî®Êà∂Ê≠£Âú®ÂâµÂª∫ÊñáÊ∏∏Êåá‰ª§ÔºåÁõÆÂâçÂ°´ÂØ´ÁöÑÂü∫Á§éË®≠ÂÆöÂ¶Ç‰∏ãÔºö
${context}

Ë´ãÊ†πÊìöÁî®Êà∂Â°´ÂØ´ÁöÑÂÖßÂÆπÔºåÊèêÂá∫ 1-2 ÂÄãÊúâÈáùÂ∞çÊÄßÁöÑÂïèÈ°åÔºåÂπ´Âä©ÂÆåÂñÑ‰∏ñÁïåËßÄË®≠ÂÆö„ÄÇÂïèÈ°åË¶ÅÂÖ∑È´î„ÄÅÊúâÂª∫Ë®≠ÊÄß„ÄÇÂ¶ÇÊûúÂÖßÂÆπÂ∑≤Á∂ìÂæàÂÆåÊï¥ÔºåÂèØ‰ª•Áµ¶Âá∫ËÇØÂÆö‰∏¶ÊèêÂá∫ÈÄ≤ÈöéÂª∫Ë≠∞„ÄÇÂõûË¶ÜË¶ÅÁ∞°ÊΩîÔºà100Â≠óÂÖßÔºâ„ÄÇ`,
      protagonist: `Áî®Êà∂Ê≠£Âú®Ë®≠ÂÆöÊñáÊ∏∏ÁöÑ‰∏ªËßíÔºö
${context}

Ë´ãÊ†πÊìö‰∏ªËßíË®≠ÂÆöÔºåÊèêÂá∫ 1-2 ÂÄãÂïèÈ°åÂπ´Âä©ÂÆåÂñÑ„ÄÇÂèØ‰ª•ÂïèÔºö‰∏ªËßíÁöÑÂº±Èªû/Áº∫Èô∑ÊòØ‰ªÄÈ∫ºÔºüÊúâ‰ªÄÈ∫ºÁâπÊÆäÊäÄËÉΩÊàñËÉåÊôØÊïÖ‰∫ãÔºüÂõûË¶ÜÁ∞°ÊΩîÔºà100Â≠óÂÖßÔºâ„ÄÇ`,
      characters: `Áî®Êà∂Ê≠£Âú®Ê∑ªÂä†ÈÖçËßíÔºö
${context}

Ë´ãÊ†πÊìöÊïÖ‰∫ãÈ°ûÂûãÂíåÂ∑≤ÊúâËßíËâ≤ÔºåÂª∫Ë≠∞ÈÇÑÈúÄË¶Å‰ªÄÈ∫ºÈ°ûÂûãÁöÑËßíËâ≤ÔºåÊàñÊèêÂïèÁèæÊúâËßíËâ≤ÁöÑÁ¥∞ÁØÄ„ÄÇÂõûË¶ÜÁ∞°ÊΩîÔºà100Â≠óÂÖßÔºâ„ÄÇ`,
      mechanics: `Áî®Êà∂Ê≠£Âú®Ë®≠Ë®àÈÅäÊà≤Ê©üÂà∂Ôºö
${context}

Ë´ãÊ†πÊìöÊïÖ‰∫ãÈ°ûÂûãÔºåÊèêÂá∫Ê©üÂà∂ÊñπÈù¢ÁöÑÂª∫Ë≠∞ÊàñÂïèÈ°å„ÄÇ‰æãÂ¶ÇÔºöÈÄô‰∫õÂ±¨ÊÄß‰πãÈñìÂ¶Ç‰Ωï‰∫íÁõ∏ÂΩ±ÈüøÔºüÊúâÊ≤íÊúâÁâπÊÆäÁöÑËß∏ÁôºÊ©üÂà∂ÔºüÂõûË¶ÜÁ∞°ÊΩîÔºà100Â≠óÂÖßÔºâ„ÄÇ`,
      style: `Áî®Êà∂Ê≠£Âú®Ë®≠ÂÆöÂØ´‰ΩúÈ¢®Ê†ºÔºö
${context}

Ë´ãÊ†πÊìöÊïÖ‰∫ãÈ°ûÂûãÂíåÈ¢®Ê†ºÈÅ∏ÊìáÔºåÁµ¶Âá∫Âª∫Ë≠∞ÊàñÊèêÂïè„ÄÇ‰æãÂ¶ÇÔºöË¶Å‰∏çË¶ÅÂä†ÂÖ•Ë©©Ë©û/Â∞àÊ•≠Ë°ìË™ûÔºüÂ∞çË©±È¢®Ê†ºÊúâ‰ªÄÈ∫ºË¶ÅÊ±ÇÔºüÂõûË¶ÜÁ∞°ÊΩîÔºà100Â≠óÂÖßÔºâ„ÄÇ`,
      aiRules: `Áî®Êà∂Ê≠£Âú®Ë®≠ÂÆö AI Ë°åÁÇ∫Ë¶èÂâáÔºö
${context}

Ë´ãÊ†πÊìöÊï¥È´îË®≠ÂÆöÔºåÂª∫Ë≠∞‰∏Ä‰∫õÈáçË¶ÅÁöÑ AI Ë°åÁÇ∫Ë¶èÂâá„ÄÇ‰ªÄÈ∫ºÊòØ AI ÂøÖÈ†àÈÅµÂÆàÁöÑÔºü‰ªÄÈ∫ºÊòØÁµïÂ∞ç‰∏çËÉΩÂÅöÁöÑÔºüÂõûË¶ÜÁ∞°ÊΩîÔºà100Â≠óÂÖßÔºâ„ÄÇ`
    };
    
    const response = await callAI(prompts[stepId] || 'Ë´ãÁµ¶Âá∫‰∏Ä‰∫õÂª∫Ë≠∞„ÄÇ');
    
    box.innerHTML = `
      <div class="wizard-ai-box">
        <div class="wizard-ai-header">ü§ñ AI ÊèêÂïè</div>
        <div class="wizard-ai-content">${marked.parse(response.content)}</div>
      </div>
    `;
  } catch (e) {
    box.innerHTML = `<div class="wizard-ai-box"><div class="wizard-ai-header">‚ö†Ô∏è AI Êö´ÊôÇÁÑ°Ê≥ïÂõûÊáâ</div><div class="wizard-ai-content">${e.message}</div></div>`;
  }
}

// Ê∑ªÂä†/Á∑®ËºØËßíËâ≤
function addWizardChar() {
  showModal('wizard-char-modal');
  document.getElementById('wiz-char-name').value = '';
  document.getElementById('wiz-char-role').value = '';
  document.getElementById('wiz-char-personality').value = '';
  document.getElementById('wiz-char-relation').value = '';
  document.getElementById('wiz-char-desc').value = '';
  document.getElementById('wiz-char-idx').value = '-1';
}

function editWizardChar(idx) {
  const c = wizardState.data.characters[idx];
  showModal('wizard-char-modal');
  document.getElementById('wiz-char-name').value = c.name || '';
  document.getElementById('wiz-char-role').value = c.role || '';
  document.getElementById('wiz-char-personality').value = c.personality || '';
  document.getElementById('wiz-char-relation').value = c.relation || '';
  document.getElementById('wiz-char-desc').value = c.description || '';
  document.getElementById('wiz-char-idx').value = idx;
}

function saveWizardChar() {
  const idx = parseInt(document.getElementById('wiz-char-idx').value);
  const char = {
    name: document.getElementById('wiz-char-name').value.trim(),
    role: document.getElementById('wiz-char-role').value.trim(),
    personality: document.getElementById('wiz-char-personality').value.trim(),
    relation: document.getElementById('wiz-char-relation').value.trim(),
    description: document.getElementById('wiz-char-desc').value.trim(),
    avatar: 'üë§'
  };
  if (!char.name) { toast(T('Ë´ãËº∏ÂÖ•ËßíËâ≤ÂêçÁ®±'), 'warning'); return; }
  
  if (idx >= 0) {
    wizardState.data.characters[idx] = char;
  } else {
    wizardState.data.characters.push(char);
  }
  closeModal('wizard-char-modal');
  renderWizardStep();
}

function deleteWizardChar(idx) {
  showConfirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãËßíËâ≤ÂóéÔºü', () => {
    wizardState.data.characters.splice(idx, 1);
    renderWizardStep();
  });
}

// AI ÁîüÊàêËßíËâ≤Âª∫Ë≠∞
async function aiGenerateChars() {
  toast(T('AI Ê≠£Âú®ÁîüÊàêËßíËâ≤Âª∫Ë≠∞...'), 'info');
  try {
    const context = JSON.stringify(wizardState.data, null, 2);
    const response = await callAI(`Ê†πÊìö‰ª•‰∏ãÊñáÊ∏∏Ë®≠ÂÆöÔºåÂª∫Ë≠∞ 3 ÂÄãÈÅ©ÂêàÁöÑÈÖçËßí„ÄÇË´ãÁî® JSON Ê†ºÂºèËøîÂõûÔºö
${context}

ËøîÂõûÊ†ºÂºèÔºö
\`\`\`json
[
  {"name": "ËßíËâ≤Âêç", "role": "Ë∫´‰ªΩ", "personality": "ÊÄßÊ†º", "relation": "Ëàá‰∏ªËßíÈóú‰øÇ", "description": "Á∞°‰ªã"}
]
\`\`\``);
    
    const match = response.content.match(/```json\\s*([\\s\\S]*?)\\s*```/) || response.content.match(/\\[\\s*\\{[\\s\\S]*\\}\\s*\\]/);
    if (match) {
      const chars = JSON.parse(match[1] || match[0]);
      chars.forEach(c => {
        c.avatar = 'üë§';
        wizardState.data.characters.push(c);
      });
      renderWizardStep();
      toast(`Â∑≤Ê∑ªÂä† ${chars.length} ÂÄãËßíËâ≤`, 'success');
    }
  } catch (e) {
    toast('ÁîüÊàêÂ§±Êïó: ' + e.message, 'error');
  }
}

// ÁîüÊàêÂÆåÊï¥ Prompt
function generatePrompt() {
  const d = wizardState.data;
  let prompt = '';
  
  // ‰∏ñÁïåËßÄ
  prompt += `# ‰∏ñÁïåËßÄË®≠ÂÆö\n\n`;
  prompt += `## Âü∫Êú¨‰ø°ÊÅØ\n`;
  prompt += `- ÊïÖ‰∫ãÈ°ûÂûãÔºö${d.basic.type}\n`;
  prompt += `- ÊôÇ‰ª£ËÉåÊôØÔºö${d.basic.era}\n`;
  prompt += `- Ê†∏ÂøÉ‰∏ªÈ°åÔºö${d.basic.theme}\n\n`;
  if (d.basic.setting) {
    prompt += `## Ë©≥Á¥∞Ë®≠ÂÆö\n${d.basic.setting}\n\n`;
  }
  
  // ‰∏ªËßí
  prompt += `# ‰∏ªËßíË®≠ÂÆö\n\n`;
  prompt += `- Á®±ÂëºÔºö${d.protagonist.name}\n`;
  prompt += `- ÊÄßÂà•Ôºö${d.protagonist.gender === 'male' ? 'Áî∑' : d.protagonist.gender === 'female' ? 'Â•≥' : 'Ëá™ÂÆöÁæ©'}\n`;
  prompt += `- Ë∫´‰ªΩÔºö${d.protagonist.identity}\n`;
  prompt += `- ÊÄßÊ†ºÔºö${d.protagonist.personality}\n`;
  if (d.protagonist.appearance) prompt += `\n## Â§ñË≤å\n${d.protagonist.appearance}\n`;
  if (d.protagonist.background) prompt += `\n## ËÉåÊôØ\n${d.protagonist.background}\n`;
  if (d.protagonist.goal) prompt += `\n## ÁõÆÊ®ô\n${d.protagonist.goal}\n`;
  prompt += `\n`;
  
  // ÈÖçËßí
  if (d.characters.length) {
    prompt += `# ‰∏ªË¶ÅËßíËâ≤\n\n`;
    d.characters.forEach(c => {
      prompt += `## ${c.name}\n`;
      prompt += `- Ë∫´‰ªΩÔºö${c.role}\n`;
      prompt += `- ÊÄßÊ†ºÔºö${c.personality}\n`;
      prompt += `- Ëàá‰∏ªËßíÈóú‰øÇÔºö${c.relation}\n`;
      if (c.description) prompt += `\n${c.description}\n`;
      prompt += `\n`;
    });
  }
  
  // ÈÅäÊà≤Ê©üÂà∂
  prompt += `# ÈÅäÊà≤Ê©üÂà∂\n\n`;
  if (d.mechanics.attributes.length) {
    prompt += `## Â±¨ÊÄßÁ≥ªÁµ±\n`;
    d.mechanics.attributes.forEach(a => prompt += `- ${a}\n`);
    prompt += `\n`;
  }
  if (d.mechanics.systems.length) {
    prompt += `## ÈÅäÊà≤Á≥ªÁµ±\n`;
    d.mechanics.systems.forEach(s => prompt += `- ${s}\n`);
    prompt += `\n`;
  }
  if (d.mechanics.triggers.length) {
    prompt += `## ÁâπÊÆäËß∏Áôº\n`;
    d.mechanics.triggers.forEach(t => prompt += `- ${t}\n`);
    prompt += `\n`;
  }
  
  // ÂØ´‰ΩúÈ¢®Ê†º
  prompt += `# ÂØ´‰ΩúË¶ÅÊ±Ç\n\n`;
  prompt += `- ÊñáÈ¢®Ôºö${d.style.tone}\n`;
  prompt += `- Ë¶ñËßíÔºö${d.style.perspective}\n`;
  prompt += `- ÁØáÂπÖÔºö${d.style.detail}\n`;
  if (d.style.format) prompt += `\n## Ê†ºÂºèË¶ÅÊ±Ç\n${d.style.format}\n`;
  prompt += `\n`;
  
  // AI Ë¶èÂâá
  prompt += `# AI Ë°åÁÇ∫Ë¶èÂâá\n\n`;
  if (d.aiRules.dos.length) {
    prompt += `## ÂøÖÈ†àÈÅµÂÆà\n`;
    d.aiRules.dos.forEach(r => prompt += `- ${r}\n`);
    prompt += `\n`;
  }
  if (d.aiRules.donts.length) {
    prompt += `## Á¶ÅÊ≠¢‰∫ãÈ†Ö\n`;
    d.aiRules.donts.forEach(r => prompt += `- ${r}\n`);
    prompt += `\n`;
  }
  if (d.aiRules.special) {
    prompt += `## ÁâπÊÆäÊåá‰ª§\n${d.aiRules.special}\n`;
  }
  
  return prompt;
}

// È†êË¶ΩÂÆåÊï¥ Prompt
function previewFullPrompt() {
  const prompt = generatePrompt();
  showConfirm(prompt, null, false, 'üìÑ ÂÆåÊï¥Êåá‰ª§È†êË¶Ω');
}

// Á∑®ËºØ Prompt
function editPrompt() {
  const prompt = generatePrompt();
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.style.cssText = 'max-width:90%;max-height:80vh;';
  modal.innerHTML = `
    <div class="modal-title">‚úèÔ∏è Á∑®ËºØÊåá‰ª§</div>
    <textarea class="form-input" id="edit-prompt-text" style="min-height:50vh;font-family:monospace;font-size:13px;line-height:1.6">${esc(prompt)}</textarea>
    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="this.closest('.modal').remove();document.getElementById('overlay').classList.remove('active')">ÂèñÊ∂à</button>
      <button class="modal-btn confirm" onclick="applyEditedPrompt()">ÊáâÁî®‰øÆÊîπ</button>
    </div>
  `;
  document.getElementById('overlay').classList.add('active');
  document.body.appendChild(modal);
}

function applyEditedPrompt() {
  const text = document.getElementById('edit-prompt-text').value;
  wizardState.editedPrompt = text;
  document.querySelector('.modal')?.remove();
  document.getElementById('overlay').classList.remove('active');
  toast(T('Â∑≤ÊáâÁî®‰øÆÊîπ'), 'success');
  renderWizardStep();
}

// Â∞éÂá∫ Prompt
function exportPrompt(format) {
  const prompt = wizardState.editedPrompt || generatePrompt();
  const filename = `ÊñáÊ∏∏Êåá‰ª§_${wizardState.data.basic.type || 'Ëá™ÂÆöÁæ©'}_${Date.now()}`;
  
  if (format === 'md') {
    downloadFile(prompt, filename + '.md', 'text/markdown');
  } else {
    downloadFile(prompt, filename + '.txt', 'text/plain');
  }
  toast(T('Â∑≤Â∞éÂá∫Êåá‰ª§ÊñáÊ™î'), 'success');
}

function downloadFile(content, filename, type) {
  const blob = new Blob([content], { type: type + ';charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ‰øùÂ≠òÁÇ∫Êåá‰ª§
async function saveAsInstruction() {
  const prompt = wizardState.editedPrompt || generatePrompt();
  const name = wizardState.data.basic.type || 'Ëá™ÂÆöÁæ©Êåá‰ª§';
  
  const inst = {
    id: crypto.randomUUID(),
    name: name + ' - ' + new Date().toLocaleDateString(),
    icon: wizardTemplates.find(t => t.id === wizardState.data.template)?.icon || 'üìú',
    systemPrompt: prompt,
    createdAt: Date.now()
  };
  
  await db.instructions.put(inst);
  toast(T('Êåá‰ª§Â∑≤‰øùÂ≠òÔºÅ'), 'success');
  goTo('view-instructions');
  await renderInst();
}

// Â∞çË©±ÂÆåÂñÑ
async function sendWizardChat() {
  const input = document.getElementById('wizard-chat-input');
  const msg = input.value.trim();
  if (!msg) return;
  
  input.value = '';
  wizardState.data.aiChat.push({ role: 'user', content: msg });
  renderWizardStep();
  
  try {
    const prompt = generatePrompt();
    const response = await callAI(`Áî®Êà∂Ê≠£Âú®ÂÆåÂñÑ‰ª•‰∏ãÊñáÊ∏∏Êåá‰ª§Ôºö

${prompt}

Áî®Êà∂Ë™™Ôºö${msg}

Ë´ãÊ†πÊìöÁî®Êà∂ÁöÑÊÑèË¶ãÔºåÁµ¶Âá∫‰øÆÊîπÂª∫Ë≠∞ÊàñÂõûÁ≠îÂïèÈ°å„ÄÇÂ¶ÇÊûúÁî®Êà∂Ë¶ÅÊ±Ç‰øÆÊîπÊüêÈÉ®ÂàÜÔºåË´ãÊòéÁ¢∫ÊåáÂá∫ÊáâË©≤Â¶Ç‰Ωï‰øÆÊîπ„ÄÇÂõûË¶ÜË¶ÅÊúâÂª∫Ë®≠ÊÄß„ÄÇ`);
    
    wizardState.data.aiChat.push({ role: 'ai', content: response.content });
    renderWizardStep();
  } catch (e) {
    toast('ÂõûË¶ÜÂ§±Êïó: ' + e.message, 'error');
  }
}

// ============================================
// Prompt ÂàÜÊûêÁ≥ªÁµ±
// ============================================

let analyzeState = {
  originalPrompt: '',
  improvedPrompt: '',
  analysis: null,
  moduleImprovements: {},
  chatHistory: []
};

const analyzeModules = [
  { id: 'worldview', name: '‰∏ñÁïåËßÄË®≠ÂÆö', icon: 'üåç', keywords: ['‰∏ñÁïå', 'ËÉåÊôØ', 'ÊôÇ‰ª£', 'Ë®≠ÂÆö', 'Ê≠∑Âè≤', 'È≠îÊ≥ï', 'Á≥ªÁµ±'] },
  { id: 'protagonist', name: '‰∏ªËßíË®≠ÂÆö', icon: 'üë§', keywords: ['‰∏ªËßí', '‰Ω†', 'Áé©ÂÆ∂', 'Ë∫´‰ªΩ', 'ÊÄßÊ†º', 'ÁõÆÊ®ô'] },
  { id: 'characters', name: 'ÈÖçËßíÁ≥ªÁµ±', icon: 'üë•', keywords: ['ËßíËâ≤', 'NPC', '‰∫∫Áâ©', 'Èóú‰øÇ', 'ÈÖçËßí'] },
  { id: 'mechanics', name: 'ÈÅäÊà≤Ê©üÂà∂', icon: '‚öôÔ∏è', keywords: ['Â±¨ÊÄß', 'Êï∏ÂÄº', 'Â•ΩÊÑü', 'Á≥ªÁµ±', 'Ê©üÂà∂', 'Ëß∏Áôº'] },
  { id: 'style', name: 'ÂØ´‰ΩúÈ¢®Ê†º', icon: '‚úçÔ∏è', keywords: ['È¢®Ê†º', 'ÊñáÈ¢®', 'Ë¶ñËßí', 'ÊèèÂØ´', 'ÁØáÂπÖ', 'Â≠óÊï∏'] },
  { id: 'aiRules', name: 'AI Ë°åÁÇ∫Ë¶èÂâá', icon: 'ü§ñ', keywords: ['AI', 'Ë¶èÂâá', 'Á¶ÅÊ≠¢', 'ÂøÖÈ†à', '‰∏çË¶Å', 'ÊáâË©≤', 'Ëº∏Âá∫'] }
];

// ÂïüÂãïÂàÜÊûê
function startAnalyze() {
  analyzeState = {
    originalPrompt: '',
    improvedPrompt: '',
    analysis: null,
    moduleImprovements: {},
    chatHistory: []
  };
  renderAnalyzeImport();
  goTo('view-analyze');
}

function showAnalyzeHelp() {
  showConfirm(
    'Prompt ÂàÜÊûêÂäüËÉΩÂπ´Âä©\n\n' +
    'ÈÄôÂÄãÂäüËÉΩÂèØ‰ª•ÂàÜÊûê‰Ω†ÁèæÊúâÁöÑ PromptÔºåÊâæÂá∫‰∏çË∂≥‰πãËôï‰∏¶Êèê‰æõÊîπÈÄ≤Âª∫Ë≠∞„ÄÇ\n\n' +
    '‚Ä¢ ÊîØÊåÅ‰∏äÂÇ≥ .txt / .md ÊñáÊ™îÊàñÁõ¥Êé•Á≤òË≤º\n' +
    '‚Ä¢ AI ÊúÉÊ∑±Â∫¶ÂàÜÊûê 6 ÂÄãÁ∂≠Â∫¶\n' +
    '‚Ä¢ ÂèØ‰ª•ÂàÜÊ®°Â°äÂñÆÁç®ÂÆåÂñÑ\n' +
    '‚Ä¢ ÊîØÊåÅÂéüÁâàËàáÊîπÈÄ≤ÁâàÂ∞çÊØî\n\n' +
    'ÂàÜÊûêÂÆåÊàêÂæåÂèØ‰ª•Â∞éÂá∫Êàñ‰øùÂ≠òÁÇ∫Êåá‰ª§„ÄÇ',
    null, false, 'üí° Âπ´Âä©'
  );
}

// Ê∏≤ÊüìÂ∞éÂÖ•ÁïåÈù¢
function renderAnalyzeImport() {
  const container = document.getElementById('analyze-content');
  container.innerHTML = `
    <div class="wizard-section">
      <div class="wizard-section-title">üì• Â∞éÂÖ•‰Ω†ÁöÑ Prompt</div>
      <div class="wizard-section-desc">‰∏äÂÇ≥ÊñáÊ™îÊàñÁõ¥Êé•Á≤òË≤º‰Ω†ÊÉ≥ÂàÜÊûêÁöÑ Prompt ÂÖßÂÆπ„ÄÇ</div>
      
      <div class="analyze-import">
        <div class="analyze-import-btn" onclick="document.getElementById('analyze-file').click()">
          <div class="icon">üìÑ</div>
          <div class="label">‰∏äÂÇ≥ÊñáÊ™î<br><small style="color:var(--text-tertiary)">.txt / .md</small></div>
        </div>
        <div class="analyze-import-btn" onclick="pasteFromClipboard()">
          <div class="icon">üìã</div>
          <div class="label">ÂæûÂâ™Ë≤ºÊùøÁ≤òË≤º</div>
        </div>
      </div>
      
      <div class="wizard-section-title" style="margin-top:20px">ÊàñÁõ¥Êé•Ëº∏ÂÖ•</div>
      <textarea class="analyze-textarea" id="analyze-input" placeholder="Âú®Ê≠§Á≤òË≤º‰Ω†ÁöÑ Prompt ÂÖßÂÆπ..."></textarea>
      
      <div id="analyze-file-info" style="display:none;margin-top:12px;padding:12px;background:var(--bg-card);border-radius:8px">
        <div style="display:flex;align-items:center;gap:8px">
          <span>üìÑ</span>
          <span id="analyze-file-name" style="flex:1;font-size:14px"></span>
          <button onclick="clearAnalyzeFile()" style="background:none;border:none;color:var(--error);cursor:pointer">‚úï</button>
        </div>
      </div>
      
      <button class="wizard-btn primary" style="width:100%;margin-top:16px" onclick="startDeepAnalyze()">üîç ÈñãÂßãÊ∑±Â∫¶ÂàÜÊûê</button>
    </div>
  `;
}

// ËôïÁêÜÊñá‰ª∂‰∏äÂÇ≥
async function handleAnalyzeFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  try {
    let text = '';
    if (file.name.endsWith('.docx')) {
      toast(T('Ê≠£Âú®Ëß£ÊûêÊñáÊ™î...'), 'info');
      // Á∞°ÂñÆËôïÁêÜÔºåÂØ¶ÈöõÈúÄË¶Å mammoth.js
      toast(T('Êö´‰∏çÊîØÊåÅ .docx Ê†ºÂºèÔºåË´ã‰ΩøÁî® .txt Êàñ .md'), 'warning');
      return;
    } else {
      text = await file.text();
    }
    
    analyzeState.originalPrompt = text;
    document.getElementById('analyze-input').value = text;
    document.getElementById('analyze-file-info').style.display = 'block';
    document.getElementById('analyze-file-name').textContent = file.name;
    toast(T('Êñá‰ª∂Â∑≤ËºâÂÖ•'), 'success');
  } catch (e) {
    toast('ËÆÄÂèñÊñá‰ª∂Â§±Êïó: ' + e.message, 'error');
  }
  
  event.target.value = '';
}

async function pasteFromClipboard() {
  try {
    const text = await navigator.clipboard.readText();
    if (text) {
      document.getElementById('analyze-input').value = text;
      analyzeState.originalPrompt = text;
      toast(T('Â∑≤Á≤òË≤ºÂÖßÂÆπ'), 'success');
    }
  } catch (e) {
    toast(T('ÁÑ°Ê≥ïË®™ÂïèÂâ™Ë≤ºÊùøÔºåË´ãÊâãÂãïÁ≤òË≤º'), 'warning');
  }
}

function clearAnalyzeFile() {
  analyzeState.originalPrompt = '';
  document.getElementById('analyze-input').value = '';
  document.getElementById('analyze-file-info').style.display = 'none';
}

// ÈñãÂßãÊ∑±Â∫¶ÂàÜÊûê
async function startDeepAnalyze() {
  const input = document.getElementById('analyze-input');
  const prompt = input?.value?.trim() || analyzeState.originalPrompt;
  
  if (!prompt) {
    toast(T('Ë´ãÂÖàËº∏ÂÖ•Êàñ‰∏äÂÇ≥ Prompt ÂÖßÂÆπ'), 'warning');
    return;
  }
  
  if (prompt.length < 100) {
    toast(T('Prompt ÂÖßÂÆπÂ§™Áü≠ÔºåËá≥Â∞ëÈúÄË¶Å 100 Â≠ó'), 'warning');
    return;
  }
  
  analyzeState.originalPrompt = prompt;
  
  // È°ØÁ§∫ÂàÜÊûê‰∏≠
  const container = document.getElementById('analyze-content');
  container.innerHTML = `
    <div style="text-align:center;padding:60px 20px">
      <div class="typing-dot" style="display:inline-block"></div>
      <div class="typing-dot" style="display:inline-block"></div>
      <div class="typing-dot" style="display:inline-block"></div>
      <div style="margin-top:20px;font-size:15px;color:var(--text-secondary)">AI Ê≠£Âú®Ê∑±Â∫¶ÂàÜÊûê‰Ω†ÁöÑ Prompt...</div>
      <div style="margin-top:8px;font-size:13px;color:var(--text-tertiary)">ÈÄôÂèØËÉΩÈúÄË¶Å 30-60 Áßí</div>
    </div>
  `;
  
  try {
    const preset = await db.apiPresets.filter(p => p.isActive).first();
    if (!preset) {
      toast(T('Ë´ãÂÖàÂú®Ë®≠ÁΩÆ‰∏≠ÈÖçÁΩÆ API'), 'error');
      renderAnalyzeImport();
      return;
    }
    
    // Ë™øÁî® AI ÂàÜÊûê
    const response = await callAI(`‰Ω†ÊòØ‰∏ÄÂÄãÂ∞àÊ•≠ÁöÑÊñáÊ∏∏ Prompt ÂàÜÊûêÂ∞àÂÆ∂„ÄÇË´ãÊ∑±Â∫¶ÂàÜÊûê‰ª•‰∏ã PromptÔºå‰∏¶Áµ¶Âá∫Ë©≥Á¥∞Ë©ï‰º∞„ÄÇ

„ÄêÂæÖÂàÜÊûêÁöÑ Prompt„Äë
${prompt}

Ë´ãÊåâ‰ª•‰∏ã JSON Ê†ºÂºèËøîÂõûÂàÜÊûêÁµêÊûúÔºö
\`\`\`json
{
  "overallScore": 0-100ÁöÑÊï¥È´îË©ïÂàÜ,
  "overallComment": "Êï¥È´îË©ïÂÉπÔºà50Â≠óÂÖßÔºâ",
  "modules": {
    "worldview": {
      "score": 0-100,
      "found": true/false ÊòØÂê¶ÊâæÂà∞Áõ∏ÈóúÂÖßÂÆπ,
      "content": "ÊâæÂà∞ÁöÑÁõ∏ÈóúÂÖßÂÆπÊëòË¶ÅÔºà50Â≠óÂÖßÔºâ",
      "issues": ["ÂïèÈ°å1", "ÂïèÈ°å2"],
      "suggestions": ["Âª∫Ë≠∞1", "Âª∫Ë≠∞2"]
    },
    "protagonist": {
      "score": 0-100,
      "found": true/false,
      "content": "ÊëòË¶Å",
      "issues": [],
      "suggestions": []
    },
    "characters": {
      "score": 0-100,
      "found": true/false,
      "content": "ÊëòË¶Å",
      "issues": [],
      "suggestions": []
    },
    "mechanics": {
      "score": 0-100,
      "found": true/false,
      "content": "ÊëòË¶Å",
      "issues": [],
      "suggestions": []
    },
    "style": {
      "score": 0-100,
      "found": true/false,
      "content": "ÊëòË¶Å",
      "issues": [],
      "suggestions": []
    },
    "aiRules": {
      "score": 0-100,
      "found": true/false,
      "content": "ÊëòË¶Å",
      "issues": [],
      "suggestions": []
    }
  },
  "criticalIssues": ["ÊúÄÂö¥ÈáçÁöÑÂïèÈ°å1", "ÂïèÈ°å2"],
  "topSuggestions": ["ÊúÄÈáçË¶ÅÁöÑÂª∫Ë≠∞1", "Âª∫Ë≠∞2", "Âª∫Ë≠∞3"]
}
\`\`\`

Ë©ïÂàÜÊ®ôÊ∫ñÔºö
- 90-100ÔºöÈùûÂ∏∏ÂÆåÂñÑÔºåÂπæ‰πéÊ≤íÊúâÊîπÈÄ≤Á©∫Èñì
- 70-89ÔºöËâØÂ•ΩÔºåÊúâÂ∞èÁöÑÊîπÈÄ≤Á©∫Èñì
- 50-69Ôºö‰∏ÄËà¨ÔºåÊúâÊòéÈ°Ø‰∏çË∂≥
- 30-49ÔºöËºÉÂ∑ÆÔºåÁº∫Â§±ÈáçË¶ÅÂÖßÂÆπ
- 0-29ÔºöÂæàÂ∑ÆÔºåÂü∫Êú¨Ê≤íÊúâÁõ∏ÈóúÂÖßÂÆπ

Ë´ãÂö¥Ê†ºÊåâÁÖß JSON Ê†ºÂºèËøîÂõûÔºå‰∏çË¶ÅÊúâÂÖ∂‰ªñÂÖßÂÆπ„ÄÇ`);
    
    // Ëß£ÊûêÁµêÊûú
    const match = response.content.match(/```json\s*([\s\S]*?)\s*```/) || response.content.match(/\{[\s\S]*\}/);
    if (match) {
      const analysis = JSON.parse(match[1] || match[0]);
      analyzeState.analysis = analysis;
      renderAnalyzeResult();
    } else {
      throw new Error('ÁÑ°Ê≥ïËß£Êûê AI ËøîÂõûÁöÑÁµêÊûú');
    }
  } catch (e) {
    toast('ÂàÜÊûêÂ§±Êïó: ' + e.message, 'error');
    renderAnalyzeImport();
  }
}

// Ê∏≤ÊüìÂàÜÊûêÁµêÊûú
function renderAnalyzeResult() {
  const a = analyzeState.analysis;
  const container = document.getElementById('analyze-content');
  
  // Ë®àÁÆóÁµ±Ë®à
  const charCount = analyzeState.originalPrompt.length;
  const lineCount = analyzeState.originalPrompt.split('\n').length;
  const issueCount = Object.values(a.modules).reduce((sum, m) => sum + (m.issues?.length || 0), 0);
  
  container.innerHTML = `
    <div class="analyze-stats">
      <div class="analyze-stat"><div class="analyze-stat-value">${charCount.toLocaleString()}</div><div class="analyze-stat-label">Â≠óÊï∏</div></div>
      <div class="analyze-stat"><div class="analyze-stat-value">${lineCount}</div><div class="analyze-stat-label">Ë°åÊï∏</div></div>
      <div class="analyze-stat"><div class="analyze-stat-value">${issueCount}</div><div class="analyze-stat-label">ÂïèÈ°å</div></div>
    </div>
    
    <div class="analyze-score">
      <div class="analyze-score-ring">
        <svg width="120" height="120" viewBox="0 0 120 120">
          <circle class="bg" cx="60" cy="60" r="52"/>
          <circle class="fill" cx="60" cy="60" r="52" 
            stroke-dasharray="${2 * Math.PI * 52}" 
            stroke-dashoffset="${2 * Math.PI * 52 * (1 - a.overallScore / 100)}"/>
        </svg>
        <div class="analyze-score-value">
          <div class="analyze-score-num">${a.overallScore}</div>
          <div class="analyze-score-label">Á∏ΩÂàÜ</div>
        </div>
      </div>
      <div class="analyze-score-text">${a.overallComment || 'ÂàÜÊûêÂÆåÊàê'}</div>
    </div>
    
    <div class="wizard-section-title">üìã Ê®°Â°äË©ïÂàÜ</div>
    <div class="analyze-modules" id="analyze-modules">
      ${analyzeModules.map(m => {
        const data = a.modules[m.id] || { score: 0, found: false, issues: [], suggestions: [] };
        const scoreClass = data.score >= 70 ? 'high' : data.score >= 40 ? 'medium' : 'low';
        const statusIcon = data.score >= 70 ? '‚úÖ' : data.score >= 40 ? '‚ö†Ô∏è' : '‚ùå';
        const improved = analyzeState.moduleImprovements[m.id];
        return `
          <div class="analyze-module ${improved ? 'improved' : ''}" id="module-${m.id}">
            <div class="analyze-module-header" onclick="toggleAnalyzeModule('${m.id}')">
              <span class="analyze-module-icon">${m.icon}</span>
              <span class="analyze-module-name">${m.name}</span>
              <div class="analyze-module-score">
                <div class="analyze-module-bar"><div class="analyze-module-bar-fill ${scoreClass}" style="width:${data.score}%"></div></div>
                <span class="analyze-module-num">${data.score}</span>
                <span class="analyze-module-status">${improved ? '‚ú®' : statusIcon}</span>
              </div>
            </div>
            <div class="analyze-module-body">
              ${data.found ? `<div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px;padding:10px;background:var(--bg-tertiary);border-radius:8px">${esc(data.content || 'Â∑≤ÊâæÂà∞Áõ∏ÈóúÂÖßÂÆπ')}</div>` : '<div style="font-size:13px;color:var(--warning);margin-bottom:12px">‚ö†Ô∏è Êú™ÊâæÂà∞Áõ∏ÈóúÂÖßÂÆπ</div>'}
              ${data.issues?.length ? `
                <div class="analyze-module-issues">
                  ${data.issues.map(issue => `
                    <div class="analyze-issue">
                      <span class="analyze-issue-icon">‚ö†Ô∏è</span>
                      <span class="analyze-issue-text">${esc(issue)}</span>
                    </div>
                  `).join('')}
                </div>
              ` : ''}
              ${data.suggestions?.length ? `
                <div style="margin-bottom:12px">
                  <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:6px">üí° Âª∫Ë≠∞</div>
                  ${data.suggestions.map(s => `<div style="font-size:13px;color:var(--text-secondary);padding:4px 0">‚Ä¢ ${esc(s)}</div>`).join('')}
                </div>
              ` : ''}
              ${improved ? `
                <div style="margin-bottom:12px;padding:10px;background:rgba(16,185,129,.1);border-radius:8px;border-left:3px solid var(--success)">
                  <div style="font-size:12px;color:var(--success);margin-bottom:6px">‚ú® Â∑≤ÊîπÈÄ≤</div>
                  <div style="font-size:13px;color:var(--text-secondary);white-space:pre-wrap;max-height:150px;overflow-y:auto">${esc(improved.slice(0, 500))}${improved.length > 500 ? '...' : ''}</div>
                </div>
              ` : ''}
              <div class="analyze-module-actions">
                <button class="analyze-module-btn ${improved ? '' : 'primary'}" onclick="improveModule('${m.id}')">
                  ${improved ? 'üîÑ ÈáçÊñ∞ÁîüÊàê' : 'ü§ñ AI ÂÆåÂñÑ'}
                </button>
                <button class="analyze-module-btn" onclick="editModule('${m.id}')">‚úèÔ∏è ÊâãÂãïÁ∑®ËºØ</button>
              </div>
            </div>
          </div>
        `;
      }).join('')}
    </div>
    
    ${a.criticalIssues?.length ? `
      <div class="analyze-suggestions" style="border-left-color:var(--error)">
        <div class="analyze-suggestions-title"><span>‚ùå</span> Âö¥ÈáçÂïèÈ°å</div>
        <div class="analyze-suggestions-content">
          ${a.criticalIssues.map((issue, i) => `${i + 1}. ${esc(issue)}`).join('<br>')}
        </div>
      </div>
    ` : ''}
    
    <div class="analyze-suggestions">
      <div class="analyze-suggestions-title"><span>üí°</span> AI Âª∫Ë≠∞</div>
      <div class="analyze-suggestions-content">
        ${a.topSuggestions?.map((s, i) => `${i + 1}. ${esc(s)}`).join('<br>') || 'Êö´ÁÑ°Âª∫Ë≠∞'}
      </div>
    </div>
    
    <div class="wizard-section-title" style="margin-top:24px">üì§ Â∞éÂá∫ÈÅ∏È†Ö</div>
    <div class="analyze-actions">
      <button class="wizard-btn secondary" onclick="showAnalyzeCompare()">üìä Â∞çÊØîÊü•Áúã</button>
      <button class="wizard-btn secondary" onclick="previewImprovedPrompt()">üëÅÔ∏è È†êË¶ΩÊîπÈÄ≤Áâà</button>
      <button class="wizard-btn secondary" onclick="exportAnalyzedPrompt('md')">üìÑ Â∞éÂá∫ MD</button>
      <button class="wizard-btn secondary" onclick="exportAnalyzedPrompt('txt')">üìù Â∞éÂá∫ TXT</button>
    </div>
    <button class="wizard-btn primary" style="width:100%;margin-top:12px" onclick="saveAnalyzedAsInstruction()">üíæ ‰øùÂ≠òÁÇ∫Êåá‰ª§</button>
    
    <div class="analyze-chat">
      <div class="wizard-section-title">üí¨ Â∞çË©±Ë®éË´ñ</div>
      <div class="wizard-section-desc">ÊúâÁñëÂïèÔºüÂíå AI Ë®éË´ñÂÖ∑È´îÂïèÈ°å„ÄÇ</div>
      <div class="wizard-chat" id="analyze-chat-list">
        ${analyzeState.chatHistory.map(m => `
          <div class="wizard-chat-msg ${m.role}">${marked.parse(m.content)}</div>
        `).join('')}
      </div>
      <div class="wizard-chat-input">
        <input class="wizard-chat-field" id="analyze-chat-input" placeholder="Ë©¢Âïè AI ÈóúÊñº Prompt ÁöÑÂïèÈ°å..." onkeypress="if(event.key==='Enter')sendAnalyzeChat()">
        <button class="wizard-chat-send" onclick="sendAnalyzeChat()">‚û§</button>
      </div>
    </div>
  `;
}

// ÂàáÊèõÊ®°Â°äÂ±ïÈñã
function toggleAnalyzeModule(id) {
  const module = document.getElementById('module-' + id);
  if (module) {
    module.classList.toggle('expanded');
  }
}

// AI ÂÆåÂñÑÂñÆÂÄãÊ®°Â°ä
async function improveModule(moduleId) {
  const module = analyzeModules.find(m => m.id === moduleId);
  if (!module) return;
  
  toast(`AI Ê≠£Âú®ÂÆåÂñÑ ${module.name}...`, 'info');
  
  try {
    const a = analyzeState.analysis;
    const moduleData = a.modules[moduleId] || {};
    
    const response = await callAI(`‰Ω†ÊòØ‰∏ÄÂÄãÂ∞àÊ•≠ÁöÑÊñáÊ∏∏ Prompt ÂØ´‰ΩúÂ∞àÂÆ∂„ÄÇ

„ÄêÂéüÂßã Prompt„Äë
${analyzeState.originalPrompt}

„ÄêÁï∂ÂâçÊ®°Â°ä„Äë${module.name}
„ÄêÁèæÊúâÂÖßÂÆπ„Äë${moduleData.content || 'ÁÑ°'}
„ÄêÁôºÁèæÁöÑÂïèÈ°å„Äë${moduleData.issues?.join('„ÄÅ') || 'ÁÑ°'}
„ÄêÊîπÈÄ≤Âª∫Ë≠∞„Äë${moduleData.suggestions?.join('„ÄÅ') || 'ÁÑ°'}

Ë´ãÁÇ∫ÈÄôÂÄãÊ®°Â°äÁîüÊàêÊîπÈÄ≤ÂæåÁöÑÂÖßÂÆπ„ÄÇË¶ÅÊ±ÇÔºö
1. ‰øùÊåÅËàáÂéü Prompt È¢®Ê†º‰∏ÄËá¥
2. Ëß£Ê±∫ÁôºÁèæÁöÑÂïèÈ°å
3. Êé°Á¥çÂª∫Ë≠∞ÈÄ≤Ë°åÂÑ™Âåñ
4. ÂÖßÂÆπË¶ÅÂÖ∑È´î„ÄÅÂèØÁî®

Áõ¥Êé•Ëº∏Âá∫ÊîπÈÄ≤ÂæåÁöÑÂÖßÂÆπÔºå‰∏çË¶ÅÊúâÂÖ∂‰ªñËß£Èáã„ÄÇËº∏Âá∫Ê†ºÂºè‰øùÊåÅ Markdown„ÄÇ`);
    
    analyzeState.moduleImprovements[moduleId] = response.content;
    toast(`${module.name} Â∑≤ÂÆåÂñÑ`, 'success');
    renderAnalyzeResult();
    
    // Â±ïÈñãÈÄôÂÄãÊ®°Â°ä
    setTimeout(() => {
      const el = document.getElementById('module-' + moduleId);
      if (el) el.classList.add('expanded');
    }, 100);
  } catch (e) {
    toast('ÂÆåÂñÑÂ§±Êïó: ' + e.message, 'error');
  }
}

// ÊâãÂãïÁ∑®ËºØÊ®°Â°ä
function editModule(moduleId) {
  const module = analyzeModules.find(m => m.id === moduleId);
  if (!module) return;
  
  const current = analyzeState.moduleImprovements[moduleId] || '';
  const moduleData = analyzeState.analysis?.modules[moduleId] || {};
  
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.style.cssText = 'max-width:90%;max-height:80vh;';
  modal.innerHTML = `
    <div class="modal-title">‚úèÔ∏è Á∑®ËºØ ${module.name}</div>
    <div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">
      ${moduleData.suggestions?.length ? 'üí° AI Âª∫Ë≠∞Ôºö' + moduleData.suggestions.join('Ôºõ') : ''}
    </div>
    <textarea class="form-input" id="edit-module-text" style="min-height:40vh;font-family:monospace;font-size:13px;line-height:1.6">${esc(current)}</textarea>
    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="this.closest('.modal').remove();document.getElementById('overlay').classList.remove('active')">ÂèñÊ∂à</button>
      <button class="modal-btn confirm" onclick="saveModuleEdit('${moduleId}')">‰øùÂ≠ò</button>
    </div>
  `;
  document.getElementById('overlay').classList.add('active');
  document.body.appendChild(modal);
}

function saveModuleEdit(moduleId) {
  const text = document.getElementById('edit-module-text').value.trim();
  if (text) {
    analyzeState.moduleImprovements[moduleId] = text;
  } else {
    delete analyzeState.moduleImprovements[moduleId];
  }
  document.querySelector('.modal')?.remove();
  document.getElementById('overlay').classList.remove('active');
  toast(T('Â∑≤‰øùÂ≠ò'), 'success');
  renderAnalyzeResult();
}

// ÁîüÊàêÊîπÈÄ≤ÂæåÁöÑ Prompt
function generateImprovedPrompt() {
  let improved = analyzeState.originalPrompt;
  
  // Â¶ÇÊûúÊúâÊ®°Â°äÊîπÈÄ≤ÔºåÈôÑÂä†Âà∞Êú´Â∞æ
  const improvements = Object.entries(analyzeState.moduleImprovements);
  if (improvements.length > 0) {
    improved += '\n\n---\n\n# Ë£úÂÖÖËàáÊîπÈÄ≤\n\n';
    improvements.forEach(([id, content]) => {
      const module = analyzeModules.find(m => m.id === id);
      improved += `## ${module?.icon || 'üìù'} ${module?.name || id}\n\n${content}\n\n`;
    });
  }
  
  analyzeState.improvedPrompt = improved;
  return improved;
}

// È°ØÁ§∫Â∞çÊØî
function showAnalyzeCompare() {
  const improved = generateImprovedPrompt();
  const original = analyzeState.originalPrompt;
  
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.style.cssText = 'max-width:95%;max-height:85vh;width:800px;';
  modal.innerHTML = `
    <div class="modal-title">üìä ÂéüÁâà vs ÊîπÈÄ≤ÁâàÂ∞çÊØî</div>
    <div class="analyze-compare" style="max-height:60vh">
      <div class="analyze-compare-col">
        <div class="analyze-compare-title">üìÑ ÂéüÁâà (${original.length} Â≠ó)</div>
        <div class="analyze-compare-content">${esc(original)}</div>
      </div>
      <div class="analyze-compare-col">
        <div class="analyze-compare-title">‚ú® ÊîπÈÄ≤Áâà (${improved.length} Â≠ó)</div>
        <div class="analyze-compare-content">${esc(improved)}</div>
      </div>
    </div>
    <div style="margin-top:12px;font-size:13px;color:var(--text-secondary)">
      ${Object.keys(analyzeState.moduleImprovements).length > 0 
        ? `‚úÖ Â∑≤ÊîπÈÄ≤ ${Object.keys(analyzeState.moduleImprovements).length} ÂÄãÊ®°Â°ä` 
        : '‚ö†Ô∏è Â∞öÊú™ÈÄ≤Ë°å‰ªª‰ΩïÊîπÈÄ≤'}
    </div>
    <div class="modal-actions">
      <button class="modal-btn confirm" onclick="this.closest('.modal').remove();document.getElementById('overlay').classList.remove('active')">ÈóúÈñâ</button>
    </div>
  `;
  document.getElementById('overlay').classList.add('active');
  document.body.appendChild(modal);
}

// È†êË¶ΩÊîπÈÄ≤Áâà
function previewImprovedPrompt() {
  const improved = generateImprovedPrompt();
  
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.style.cssText = 'max-width:90%;max-height:80vh;';
  modal.innerHTML = `
    <div class="modal-title">üëÅÔ∏è ÊîπÈÄ≤ÁâàÈ†êË¶Ω</div>
    <div style="font-size:13px;color:var(--text-tertiary);margin-bottom:12px">${improved.length.toLocaleString()} Â≠ó</div>
    <div style="background:var(--bg-tertiary);border-radius:8px;padding:12px;max-height:50vh;overflow-y:auto;font-size:13px;line-height:1.7;white-space:pre-wrap;font-family:monospace">${esc(improved)}</div>
    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="this.closest('.modal').remove();document.getElementById('overlay').classList.remove('active')">ÈóúÈñâ</button>
      <button class="modal-btn confirm" onclick="copyImprovedPrompt()">üìã Ë§áË£Ω</button>
    </div>
  `;
  document.getElementById('overlay').classList.add('active');
  document.body.appendChild(modal);
}

async function copyImprovedPrompt() {
  const improved = generateImprovedPrompt();
  try {
    await navigator.clipboard.writeText(improved);
    toast(T('Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÊùø'), 'success');
  } catch (e) {
    toast(T('Ë§áË£ΩÂ§±Êïó'), 'error');
  }
}

// Â∞éÂá∫
function exportAnalyzedPrompt(format) {
  const improved = generateImprovedPrompt();
  const filename = `PromptÂàÜÊûêÊîπÈÄ≤Áâà_${Date.now()}`;
  
  if (format === 'md') {
    downloadFile(improved, filename + '.md', 'text/markdown');
  } else {
    downloadFile(improved, filename + '.txt', 'text/plain');
  }
  toast(T('Â∑≤Â∞éÂá∫'), 'success');
}

// ‰øùÂ≠òÁÇ∫Êåá‰ª§
async function saveAnalyzedAsInstruction() {
  const improved = generateImprovedPrompt();
  
  const inst = {
    id: crypto.randomUUID(),
    name: 'ÂàÜÊûêÊîπÈÄ≤Áâà - ' + new Date().toLocaleDateString(),
    icon: '‚ú®',
    systemPrompt: improved,
    createdAt: Date.now()
  };
  
  await db.instructions.put(inst);
  toast(T('Â∑≤‰øùÂ≠òÁÇ∫Êåá‰ª§ÔºÅ'), 'success');
  goTo('view-instructions');
  await renderInst();
}

// Â∞çË©±Ë®éË´ñ
async function sendAnalyzeChat() {
  const input = document.getElementById('analyze-chat-input');
  const msg = input.value.trim();
  if (!msg) return;
  
  input.value = '';
  analyzeState.chatHistory.push({ role: 'user', content: msg });
  renderAnalyzeResult();
  
  try {
    const response = await callAI(`‰Ω†ÊòØ Prompt ÂàÜÊûêÂ∞àÂÆ∂„ÄÇÁî®Êà∂Ê≠£Âú®ÂàÜÊûê‰ª•‰∏ã PromptÔºö

„ÄêÂéüÂßã Prompt ÊëòË¶Å„Äë
${analyzeState.originalPrompt.slice(0, 2000)}...

„ÄêÂàÜÊûêÁµêÊûú„Äë
Á∏ΩÂàÜÔºö${analyzeState.analysis?.overallScore || 'Êú™Áü•'}
‰∏ªË¶ÅÂïèÈ°åÔºö${analyzeState.analysis?.criticalIssues?.join('„ÄÅ') || 'ÁÑ°'}

„ÄêÁî®Êà∂ÂïèÈ°å„Äë
${msg}

Ë´ãÈáùÂ∞çÁî®Êà∂ÁöÑÂïèÈ°åÁµ¶Âá∫Â∞àÊ•≠„ÄÅÂÖ∑È´îÁöÑÂõûÁ≠î„ÄÇÂõûË¶ÜË¶ÅÁ∞°ÊΩîÂØ¶Áî®„ÄÇ`);
    
    analyzeState.chatHistory.push({ role: 'ai', content: response.content });
    renderAnalyzeResult();
    
    // ÊªæÂãïÂà∞Â∫ïÈÉ®
    setTimeout(() => {
      const chatList = document.getElementById('analyze-chat-list');
      if (chatList) chatList.scrollTop = chatList.scrollHeight;
    }, 100);
  } catch (e) {
    toast('ÂõûË¶ÜÂ§±Êïó: ' + e.message, 'error');
  }
}

</script>
</body>
</html>
