<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#8B7CF7">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="織夢">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="description" content="AI互動小說閱讀器 - 創建你的專屬故事">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%238B7CF7' width='100' height='100' rx='20'/><text x='50' y='65' text-anchor='middle' fill='white' font-size='50'>織</text></svg>">
  <title>織夢 - AI互動小說閱讀器 v3</title>
  <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
:root{--primary:#8B7CF7;--primary-light:#A89CFF;--primary-dark:#6B5CE7;--bg-primary:#0F0F1A;--bg-secondary:#1A1A2E;--bg-tertiary:#252540;--bg-card:#1E1E32;--text-primary:#E5E7EB;--text-secondary:#9CA3AF;--text-tertiary:#6B7280;--divider:#2D2D44;--success:#10B981;--warning:#F59E0B;--error:#EF4444;--info:#3B82F6}
[data-theme="light"]{--primary:#6B5CE7;--primary-light:#8B7CF7;--bg-primary:#FFFFFF;--bg-secondary:#F5F5F7;--bg-tertiary:#E8E8ED;--bg-card:#FFFFFF;--text-primary:#1A1A2E;--text-secondary:#6B7280;--text-tertiary:#9CA3AF;--divider:#E5E7EB}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,BlinkMacSystemFont,"PingFang SC",sans-serif;font-size:16px;background:#000;color:var(--text-primary);height:100vh;height:100dvh;overflow:hidden;user-select:none}
.app{width:100%;max-width:420px;height:100vh;height:100dvh;margin:0 auto;display:flex;flex-direction:column;background:var(--bg-primary);position:relative;box-shadow:0 0 50px rgba(139,124,247,0.2);overflow:hidden}
@media(min-width:421px) and (min-height:901px){.app{max-height:900px;margin-top:calc((100vh - 900px)/2);border-radius:40px}}
.app.fullscreen{max-width:100%;max-height:100%;border-radius:0;margin:0}
.status-bar{height:44px;background:var(--bg-secondary);display:flex;justify-content:space-between;align-items:center;padding:0 20px;font-size:14px;font-weight:500;flex-shrink:0}
.views{flex:1;position:relative;overflow:hidden}
.view{position:absolute;inset:0;display:flex;flex-direction:column;overflow:hidden;opacity:0;transform:translateX(100%);transition:all .3s ease;pointer-events:none;background:var(--bg-primary)}
.view.active{opacity:1;transform:translateX(0);pointer-events:auto;z-index:1}
.view.out{transform:translateX(-30%);opacity:.5;z-index:0}
.nav{height:52px;background:var(--bg-secondary);display:flex;justify-content:space-between;align-items:center;padding:0 16px;border-bottom:1px solid var(--divider);flex-shrink:0}
.nav-back{color:var(--primary);font-size:24px;cursor:pointer;padding:8px;margin:-8px}
.nav-title{font-size:17px;font-weight:600;flex:1;text-align:center}
.nav-right{display:flex;gap:4px}
.nav-btn{width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;color:var(--text-secondary);border-radius:8px;transition:all .2s}
.nav-btn:hover{color:var(--primary);background:rgba(139,124,247,.1)}
.list-nav{height:52px;background:var(--bg-secondary);display:flex;justify-content:space-between;align-items:center;padding:0 16px;border-bottom:1px solid var(--divider);flex-shrink:0}
.list-nav-title{font-size:22px;font-weight:700;background:linear-gradient(135deg,var(--primary),var(--primary-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.search-bar{padding:12px 16px;background:var(--bg-secondary);flex-shrink:0}
.search-wrap{background:var(--bg-tertiary);border-radius:10px;padding:10px 14px;display:flex;align-items:center;gap:10px}
.search-wrap:focus-within{box-shadow:0 0 0 2px var(--primary)}
.search-input{flex:1;border:none;background:transparent;font-size:15px;outline:none;color:var(--text-primary)}
.search-input::placeholder{color:var(--text-tertiary)}
.progress-wrap{padding:0 16px 8px;background:var(--bg-secondary);display:flex;align-items:center;gap:8px;flex-shrink:0}
.progress-bar{flex:1;height:4px;background:var(--bg-tertiary);border-radius:2px;overflow:hidden;cursor:pointer}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--primary-dark),var(--primary));border-radius:2px;transition:width .3s}
.progress-text{font-size:11px;color:var(--text-tertiary);min-width:32px}
.scroll{flex:1;overflow-y:auto;padding:12px 16px}
.scroll::-webkit-scrollbar{display:none}
.card{display:flex;padding:14px;background:var(--bg-card);border-radius:12px;margin-bottom:12px;cursor:pointer;transition:all .2s;position:relative;border:1px solid transparent}
.card:hover{transform:translateY(-2px);box-shadow:0 4px 20px rgba(139,124,247,.15)}
.card:active{transform:scale(.98)}
.card.pinned::before{content:'📌';position:absolute;top:-6px;left:-6px;font-size:16px}
.card.selected{border-color:var(--primary)}
.card-cover{width:56px;height:70px;border-radius:8px;margin-right:12px;flex-shrink:0;background:linear-gradient(135deg,var(--primary-dark),var(--primary));display:flex;align-items:center;justify-content:center;font-size:24px}
.card-info{flex:1;min-width:0}
.card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px}
.card-title{font-size:15px;font-weight:600}
.card-time{font-size:11px;color:var(--text-tertiary)}
.card-preview{font-size:12px;color:var(--text-secondary);margin-bottom:6px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;line-height:1.4}
.card-meta{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.card-instruction{font-size:10px;color:var(--primary);background:rgba(139,124,247,.15);padding:2px 6px;border-radius:4px}
.card-stats{font-size:10px;color:var(--text-tertiary)}
.card-tags{display:flex;gap:4px;margin-top:4px}
.tag{font-size:9px;padding:2px 5px;border-radius:3px;background:var(--bg-tertiary);color:var(--text-secondary)}
.tab-bar{display:flex;background:var(--bg-secondary);border-top:1px solid var(--divider);padding:6px 0;padding-bottom:calc(6px + env(safe-area-inset-bottom, 0px));flex-shrink:0}
.tab-item{flex:1;display:flex;flex-direction:column;align-items:center;padding:4px 0;cursor:pointer}
.tab-item .tab-icon{font-size:20px;margin-bottom:2px;transition:transform .2s}
.tab-item .tab-label{font-size:10px;color:var(--text-tertiary)}
.tab-item.active .tab-icon{transform:scale(1.1)}
.tab-item.active .tab-label{color:var(--primary)}
.content{flex:1;overflow-y:auto;padding:16px;font-family:"Noto Serif SC",Georgia,serif;font-size:17px;line-height:1.9;word-break:break-word;overflow-wrap:break-word}
.content::-webkit-scrollbar{display:none}
.content.sys{font-family:-apple-system,sans-serif;font-size:15px;line-height:1.5}
.content p{margin-bottom:16px;word-break:break-word;overflow-wrap:break-word}
.content strong{color:var(--primary-light)}
.content blockquote{border-left:3px solid var(--primary);padding-left:12px;margin:12px 0;color:var(--text-secondary);word-break:break-word;overflow-wrap:break-word}
.content pre{white-space:pre-wrap;word-break:break-word;overflow-wrap:break-word;background:var(--bg-tertiary);padding:12px;border-radius:8px;overflow-x:auto;max-width:100%}
.content code{word-break:break-all}
.msg{margin-bottom:16px;padding:8px;border-radius:8px;transition:background .2s;word-break:break-word;overflow-wrap:break-word;max-width:100%}
.msg:hover{background:rgba(139,124,247,.05)}
.msg.user{background:rgba(139,124,247,.1);border-left:3px solid var(--primary)}
.time-div{display:flex;align-items:center;justify-content:center;margin:20px 0;color:var(--text-tertiary);font-size:13px;cursor:pointer}
.time-div::before,.time-div::after{content:'';flex:1;height:1px;background:var(--divider);margin:0 12px}
.typing{display:flex;align-items:center;gap:4px;padding:12px 0}
.typing-dot{width:8px;height:8px;background:var(--primary);border-radius:50%;animation:typing 1.4s infinite ease-in-out}
.typing-dot:nth-child(1){animation-delay:0s}
.typing-dot:nth-child(2){animation-delay:.2s}
.typing-dot:nth-child(3){animation-delay:.4s}
@keyframes typing{0%,60%,100%{transform:translateY(0);opacity:.4}30%{transform:translateY(-6px);opacity:1}}
@keyframes highlight{0%,100%{background:transparent}50%{background:rgba(139,124,247,0.3)}}
.typing-cursor{display:inline-block;width:2px;height:1em;background:var(--primary);margin-left:2px;animation:blink 1s infinite}
@keyframes blink{0%,50%{opacity:1}51%,100%{opacity:0}}
.quick-cmds{display:flex;gap:8px;padding:10px 16px;background:var(--bg-secondary);overflow-x:auto;border-top:1px solid var(--divider);flex-shrink:0}
.quick-cmds::-webkit-scrollbar{display:none}
.quick-cmd{padding:6px 14px;background:var(--bg-tertiary);border-radius:16px;font-size:13px;color:var(--text-secondary);white-space:nowrap;cursor:pointer;border:none;transition:all .2s}
.quick-cmd:hover{background:var(--primary);color:white}
.quick-cmd.add{background:transparent;border:1px dashed var(--text-tertiary);color:var(--text-tertiary)}
.input-bar{background:var(--bg-secondary);padding:10px 16px;display:flex;align-items:flex-end;gap:10px;border-top:1px solid var(--divider);flex-shrink:0}
.input-wrap{flex:1;background:var(--bg-tertiary);border-radius:20px;min-height:40px;max-height:120px;display:flex;align-items:center;padding:0 16px}
.input-field{flex:1;border:none;background:transparent;padding:10px 0;font-size:15px;outline:none;color:var(--text-primary)}
.input-field::placeholder{color:var(--text-tertiary)}
.send-btn{width:40px;height:40px;background:var(--primary);border:none;border-radius:50%;color:white;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.send-btn:hover{background:var(--primary-light);transform:scale(1.05)}
.send-btn:disabled{background:var(--bg-tertiary);opacity:.5;cursor:not-allowed}
.lore-section{margin-bottom:16px}
.lore-header{display:flex;justify-content:space-between;align-items:center;padding:10px 0;cursor:pointer}
.lore-header-left{display:flex;align-items:center;gap:8px;font-size:15px;font-weight:600}
.lore-count{font-size:12px;color:var(--text-tertiary);font-weight:normal}
.lore-toggle{color:var(--text-tertiary);transition:transform .3s;font-size:12px}
.lore-toggle.collapsed{transform:rotate(-90deg)}
.lore-list{max-height:1000px;overflow:hidden;transition:all .3s ease}
.lore-list.collapsed{max-height:0;opacity:0}
.lore-item{display:flex;align-items:flex-start;padding:12px;background:var(--bg-card);border-radius:10px;margin-bottom:8px;cursor:pointer;position:relative}
.lore-actions{position:absolute;right:8px;top:50%;transform:translateY(-50%);display:flex;gap:8px;font-size:14px;opacity:0.6}
.lore-actions:hover{opacity:1}
.lore-item:hover{background:var(--bg-tertiary)}
.lore-checkbox{width:20px;height:20px;border:2px solid var(--text-tertiary);border-radius:4px;margin-right:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer}
.lore-checkbox.checked{background:var(--primary);border-color:var(--primary)}
.lore-checkbox.checked::after{content:'✓';color:white;font-size:12px}
.lore-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;margin-right:12px;font-size:18px;flex-shrink:0}
.lore-icon.char{background:rgba(59,130,246,.2)}
.lore-icon.loc{background:rgba(16,185,129,.2)}
.lore-icon.item{background:rgba(249,115,22,.2)}
.lore-icon.set{background:rgba(168,85,247,.2)}
.lore-content{flex:1;min-width:0}
.lore-name{font-size:14px;font-weight:600;margin-bottom:2px;display:flex;align-items:center;gap:8px}
.lore-affection{font-size:11px}
.lore-affection.pos{color:var(--success)}
.lore-affection.neg{color:var(--error)}
.lore-desc{font-size:12px;color:var(--text-secondary);margin-bottom:4px}
.lore-status{font-size:11px;color:var(--text-tertiary)}
.timeline-current{background:var(--bg-card);padding:12px 16px;border-radius:10px;margin-bottom:20px;display:flex;align-items:center;gap:8px}
.timeline-label{font-size:13px;color:var(--text-secondary)}
.timeline-value{font-size:15px;font-weight:600;color:var(--primary)}
.timeline-list{position:relative;padding-left:24px}
.timeline-list::before{content:'';position:absolute;left:8px;top:0;bottom:0;width:2px;background:var(--divider)}
.timeline-item{position:relative;margin-bottom:20px;cursor:pointer}
.timeline-item::before{content:'';position:absolute;left:-24px;top:6px;width:12px;height:12px;border-radius:50%;background:var(--bg-tertiary);border:2px solid var(--text-tertiary)}
.timeline-item.current::before{background:var(--primary);border-color:var(--primary);box-shadow:0 0 0 4px rgba(139,124,247,.2)}
.timeline-date{font-size:14px;font-weight:600;margin-bottom:6px}
.timeline-events{font-size:13px;color:var(--text-secondary)}
.timeline-event{display:flex;align-items:center;gap:6px;margin-bottom:4px}
.timeline-event-dot{width:4px;height:4px;background:var(--text-tertiary);border-radius:50%}
.tabs-bar{display:flex;background:var(--bg-secondary);padding:0 16px;flex-shrink:0;border-bottom:1px solid var(--divider)}
.tab-btn{padding:12px 20px;font-size:14px;color:var(--text-secondary);cursor:pointer;border:none;border-bottom:2px solid transparent;background:none}
.tab-btn.active{color:var(--primary);border-bottom-color:var(--primary)}
.section-title{font-size:13px;color:var(--text-tertiary);padding:12px 0;display:flex;align-items:center;gap:8px}
.f-card{background:var(--bg-card);border-radius:10px;padding:14px;margin-bottom:10px;cursor:pointer;transition:transform .2s}
.f-card:hover{transform:translateX(4px)}
.f-card.warning{border-left:3px solid var(--warning)}
.f-card.resolved{opacity:.6}
.f-card-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.f-card-icon{font-size:14px}
.f-card-title{font-size:14px;font-weight:600;flex:1}
.f-card-desc{font-size:13px;color:var(--text-secondary);margin-bottom:8px;word-break:break-word;overflow-wrap:break-word}
.f-card-meta{display:flex;align-items:center;gap:12px;font-size:11px;color:var(--text-tertiary);flex-wrap:wrap}
.save-card{background:var(--bg-card);border-radius:10px;padding:14px;margin-bottom:10px}
.save-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.save-card-title{font-size:14px;font-weight:600;display:flex;align-items:center;gap:8px}
.save-card-tag{font-size:10px;padding:2px 8px;border-radius:4px;background:var(--success);color:white}
.save-card-tag.be{background:var(--error)}
.save-card-tag.key{background:var(--warning)}
.save-card-preview{font-size:12px;color:var(--text-secondary);margin-bottom:8px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.save-card-meta{font-size:11px;color:var(--text-tertiary);display:flex;gap:12px;flex-wrap:wrap}
.save-card-actions{display:flex;gap:8px;margin-top:10px}
.action-btn{flex:1;padding:8px;border:none;border-radius:6px;font-size:12px;cursor:pointer}
.action-btn.primary{background:var(--primary);color:white}
.action-btn.secondary{background:var(--bg-tertiary);color:var(--text-secondary)}
.action-btn.danger{background:var(--error);color:white}
.inst-card{background:var(--bg-card);border-radius:12px;padding:16px;margin-bottom:12px}
.inst-header{display:flex;align-items:flex-start;margin-bottom:12px}
.inst-icon{font-size:28px;margin-right:12px}
.inst-info{flex:1}
.inst-name{font-size:15px;font-weight:600;margin-bottom:4px}
.inst-meta{font-size:12px;color:var(--text-secondary)}
.inst-binding{font-size:12px;color:var(--text-tertiary);margin-top:4px}
.inst-preview{font-size:12px;color:var(--text-secondary);padding:8px;background:var(--bg-tertiary);border-radius:6px;margin-bottom:12px;max-height:60px;overflow:hidden}
.inst-actions{display:flex;gap:8px}
.settings-section{margin-bottom:24px}
.settings-section-title{font-size:13px;color:var(--text-tertiary);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.settings-card{background:var(--bg-card);border-radius:12px;overflow:hidden}
.settings-item{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--divider);cursor:pointer}
.settings-item:last-child{border-bottom:none}
.settings-item:hover{background:var(--bg-tertiary)}
.settings-item-label{font-size:15px}
.settings-item-value{font-size:14px;color:var(--text-secondary);display:flex;align-items:center;gap:4px}
.settings-item.danger .settings-item-label{color:var(--error)}
.toggle{width:44px;height:24px;background:var(--bg-tertiary);border-radius:12px;position:relative;cursor:pointer}
.toggle.active{background:var(--primary)}
.toggle::after{content:'';width:20px;height:20px;background:white;border-radius:50%;position:absolute;top:2px;left:2px;transition:left .2s}
.toggle.active::after{left:22px}
.immersive{position:fixed;inset:0;background:#0A0A12;z-index:1000;display:none;flex-direction:column}
.immersive.active{display:flex}
.immersive-content{flex:1;display:flex;align-items:center;justify-content:center;padding:40px 32px;font-family:"Noto Serif SC",serif;font-size:20px;line-height:2;color:#E5E7EB;text-align:justify;overflow-y:auto;word-break:break-word;overflow-wrap:break-word}
.immersive-footer{padding:16px 20px;display:flex;align-items:center;gap:16px;background:rgba(0,0,0,.5)}
.immersive-progress{flex:1;height:4px;background:rgba(255,255,255,.1);border-radius:2px}
.immersive-progress-fill{height:100%;background:var(--primary);border-radius:2px}
.immersive-hint{font-size:12px;color:rgba(255,255,255,.4)}
.immersive-close{width:36px;height:36px;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,.6);cursor:pointer;font-size:20px;border-radius:50%}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;opacity:0;visibility:hidden;transition:all .3s}
.overlay.active{opacity:1;visibility:visible}
.bottom-sheet{position:fixed;bottom:0;left:50%;transform:translateX(-50%) translateY(100%);width:100%;max-width:420px;background:var(--bg-secondary);border-radius:20px 20px 0 0;padding:20px;transition:transform .3s ease;z-index:101;max-height:70vh;overflow-y:auto;box-sizing:border-box}
.bottom-sheet.active{transform:translateX(-50%) translateY(0)}
.bottom-sheet-handle{width:40px;height:4px;background:var(--bg-tertiary);border-radius:2px;margin:0 auto 16px}
.bottom-sheet-title{font-size:17px;font-weight:600;margin-bottom:16px}
.sheet-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.sheet-item{text-align:center;padding:16px 8px;background:var(--bg-tertiary);border-radius:12px;cursor:pointer}
.sheet-item:hover{background:var(--primary);color:white}
.sheet-item-icon{font-size:24px;margin-bottom:6px}
.sheet-item-label{font-size:12px}
.modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(.9);background:var(--bg-secondary);border-radius:16px;padding:20px;width:calc(100% - 32px);max-width:360px;max-height:calc(100vh - 100px);overflow-y:auto;z-index:102;opacity:0;visibility:hidden;transition:all .3s;box-sizing:border-box}
.modal.active{opacity:1;visibility:visible;transform:translate(-50%,-50%) scale(1)}
.modal-title{font-size:18px;font-weight:600;margin-bottom:12px}
.modal-content{font-size:14px;color:var(--text-secondary);margin-bottom:20px;line-height:1.6;max-height:40vh;overflow-y:auto;word-break:break-word;overflow-wrap:break-word}
.modal-input{width:100%;padding:12px 16px;background:var(--bg-tertiary);border:1px solid var(--divider);border-radius:8px;font-size:15px;color:var(--text-primary);outline:none;margin-bottom:16px}
.modal-input:focus{border-color:var(--primary)}
.modal-actions{display:flex;gap:12px}
.modal-btn{flex:1;padding:12px;border:none;border-radius:8px;font-size:15px;cursor:pointer}
.modal-btn.cancel{background:var(--bg-tertiary);color:var(--text-secondary)}
.modal-btn.confirm{background:var(--primary);color:white}
.modal-btn.danger{background:var(--error);color:white}
.context-menu{position:fixed;background:var(--bg-card);border-radius:12px;padding:8px 0;box-shadow:0 4px 20px rgba(0,0,0,.4);z-index:200;min-width:160px;opacity:0;visibility:hidden;transform:scale(.95);transition:all .2s}
.context-menu.active{opacity:1;visibility:visible;transform:scale(1)}
.context-menu-item{padding:12px 16px;font-size:14px;cursor:pointer;display:flex;align-items:center;gap:10px}
.context-menu-item:hover{background:var(--bg-tertiary)}
.context-menu-item.danger{color:var(--error)}
.context-menu-divider{height:1px;background:var(--divider);margin:4px 0}
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--bg-card);color:var(--text-primary);padding:12px 20px;border-radius:8px;font-size:14px;box-shadow:0 4px 20px rgba(0,0,0,.3);opacity:0;transition:all .3s;z-index:300;display:flex;align-items:center;gap:8px}
.toast.active{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.success{border-left:3px solid var(--success)}
.toast.error{border-left:3px solid var(--error)}
.toast.warning{border-left:3px solid var(--warning)}
.loading{position:fixed;inset:0;background:rgba(15,15,26,.8);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:500;opacity:0;visibility:hidden;transition:all .3s}
.loading.active{opacity:1;visibility:visible}
.loading-spinner{width:40px;height:40px;border:3px solid var(--bg-tertiary);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{margin-top:16px;font-size:14px;color:var(--text-secondary)}
.empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;text-align:center}
.empty-icon{font-size:64px;opacity:.5;margin-bottom:16px}
.empty-title{font-size:18px;font-weight:600;margin-bottom:8px}
.empty-desc{font-size:14px;color:var(--text-secondary);margin-bottom:24px;max-width:260px}
.empty-btn{padding:12px 24px;background:var(--primary);color:white;border:none;border-radius:8px;font-size:15px;cursor:pointer}
.api-card{background:var(--bg-card);border-radius:12px;padding:16px;margin-bottom:12px;border:2px solid transparent;cursor:pointer}
.api-card:hover{background:var(--bg-tertiary)}
.api-card.active{border-color:var(--primary)}
.api-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.api-name{font-size:15px;font-weight:600}
.api-badge{font-size:10px;padding:2px 8px;background:var(--primary);color:white;border-radius:4px}
.api-info{font-size:12px;color:var(--text-secondary)}
.form-group{margin-bottom:16px}
.form-label{display:block;font-size:13px;color:var(--text-secondary);margin-bottom:6px}
.form-input{width:100%;padding:12px 16px;background:var(--bg-tertiary);border:1px solid var(--divider);border-radius:8px;font-size:15px;color:var(--text-primary);outline:none}
.form-input:focus{border-color:var(--primary)}
.form-select{width:100%;padding:12px 16px;background:var(--bg-tertiary);border:1px solid var(--divider);border-radius:8px;font-size:15px;color:var(--text-primary);outline:none;cursor:pointer;appearance:none}
.form-textarea{width:100%;padding:12px 16px;background:var(--bg-tertiary);border:1px solid var(--divider);border-radius:8px;font-size:14px;color:var(--text-primary);outline:none;resize:vertical;min-height:80px;font-family:inherit;line-height:1.5}
.form-textarea:focus{border-color:var(--primary)}
.hidden{display:none!important}
/* PWA 安裝橫幅動畫 */
#install-banner>div{animation:slideUp .3s ease}
@keyframes slideUp{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}
/* 文字溢出修復 */
.scroll{word-break:break-word;overflow-wrap:break-word}
.lore-desc,.lore-name,.inst-preview,.card-preview,.save-card-preview{word-break:break-word;overflow-wrap:break-word}
  </style>
</head>
<body>
<div class="app" id="app">
  <div class="status-bar">
    <span id="status-time">09:41</span>
    <div style="display:flex;gap:4px;font-size:12px"><span>📶</span><span>🔋</span></div>
  </div>
  <div class="views">
    <!-- 故事列表 -->
    <div class="view active" id="view-stories">
      <div class="list-nav">
        <span class="list-nav-title">織夢</span>
        <div style="display:flex;gap:4px">
          <div class="nav-btn" onclick="toggleScreen()" title="切換模式">🖥️</div>
          <div class="nav-btn" onclick="createStory()" title="新建">➕</div>
        </div>
      </div>
      <div class="search-bar">
        <div class="search-wrap">
          <span style="color:var(--text-tertiary)">🔍</span>
          <input type="text" class="search-input" placeholder="搜索故事" id="story-search" oninput="filterStories()">
        </div>
      </div>
      <div class="scroll" id="story-list"></div>
      <div class="tab-bar">
        <div class="tab-item active" onclick="switchTab('stories')"><span class="tab-icon">📚</span><span class="tab-label">故事</span></div>
        <div class="tab-item" onclick="switchTab('instructions')"><span class="tab-icon">📜</span><span class="tab-label">指令</span></div>
        <div class="tab-item" onclick="switchTab('settings')"><span class="tab-icon">⚙️</span><span class="tab-label">設置</span></div>
      </div>
    </div>
    <!-- 閱讀頁 -->
    <div class="view" id="view-reading">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">‹</div>
        <span class="nav-title" id="reading-title">故事</span>
        <div class="nav-right">
          <div class="nav-btn" onclick="goTo('view-lore')" title="資料庫">📖</div>
          <div class="nav-btn" onclick="goTo('view-search')" title="搜索">🔍</div>
          <div class="nav-btn" onclick="showSheet()" title="設置">⚙️</div>
          <div class="nav-btn" onclick="showMore(event)" title="更多">⋯</div>
        </div>
      </div>
      <div class="progress-wrap">
        <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
        <span class="progress-text" id="progress-text">0%</span>
      </div>
      <div class="content" id="content-area"></div>
      <div class="quick-cmds" id="quick-cmds">
        <button class="quick-cmd" onclick="sendCmd('繼續')">繼續</button>
        <button class="quick-cmd" onclick="sendCmd('查看狀態')">狀態</button>
        <button class="quick-cmd" onclick="sendCmd('描述環境')">環境</button>
        <button class="quick-cmd add" onclick="toast('管理快捷指令')">＋</button>
      </div>
      <div class="input-bar">
        <div class="input-wrap"><input type="text" class="input-field" id="user-input" placeholder="輸入你的行動或對話..." onkeydown="handleInputKey(event)"></div>
        <button class="send-btn" id="send-btn" onclick="send()">↑</button>
      </div>
    </div>
    <!-- 資料庫 -->
    <div class="view" id="view-lore">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">‹</div>
        <span class="nav-title">世界觀資料庫</span>
        <div class="nav-right">
          <div class="nav-btn" onclick="toast('AI提取資料')">🤖</div>
          <div class="nav-btn" onclick="addLore()">➕</div>
        </div>
      </div>
      <div class="search-bar">
        <div class="search-wrap">
          <span style="color:var(--text-tertiary)">🔍</span>
          <input type="text" class="search-input" placeholder="搜索資料" id="lore-search" oninput="filterLore()">
        </div>
      </div>
      <div class="scroll sys" id="lore-list"></div>
      <div class="input-bar" style="justify-content:center">
        <span style="font-size:12px;color:var(--text-tertiary)" id="lore-count">已選 0 項</span>
      </div>
    </div>
    <!-- 時間軸 -->
    <div class="view" id="view-timeline">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">‹</div>
        <span class="nav-title">故事時間軸</span>
        <div class="nav-right">
          <div class="nav-btn" onclick="addTimeline()">➕</div>
          <div class="nav-btn" onclick="timeJump()">⏭️</div>
        </div>
      </div>
      <div class="scroll sys" id="timeline-content"></div>
    </div>
    <!-- 伏筆/事件 -->
    <div class="view" id="view-foreshadow">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">‹</div>
        <span class="nav-title">伏筆與事件</span>
        <div class="nav-right">
          <div class="nav-btn" onclick="aiAnalyzeForeshadow()">🤖</div>
          <div class="nav-btn" onclick="addForeshadowOrEvent()">➕</div>
        </div>
      </div>
      <div class="tabs-bar">
        <button class="tab-btn active" onclick="switchFTab('foreshadow',this)">伏筆</button>
        <button class="tab-btn" onclick="switchFTab('events',this)">事件</button>
      </div>
      <div class="scroll sys" id="foreshadow-content"></div>
    </div>
    <!-- 存檔 -->
    <div class="view" id="view-saves">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">‹</div>
        <span class="nav-title">存檔管理</span>
        <div class="nav-right"><div class="nav-btn" onclick="toast('存檔設置')">⚙️</div></div>
      </div>
      <div class="scroll sys" id="saves-content"></div>
      <div class="input-bar"><button class="action-btn primary" style="flex:1" onclick="createSave()">💾 創建新存檔</button></div>
    </div>
    <!-- 搜索 -->
    <div class="view" id="view-search">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">‹</div>
        <span class="nav-title">搜索</span>
        <div class="nav-right"><div class="nav-btn" style="font-size:13px;width:auto;padding:0 8px" onclick="showAdvancedSearch()">高級</div></div>
      </div>
      <div class="search-bar">
        <div class="search-wrap">
          <span style="color:var(--text-tertiary)">🔍</span>
          <input type="text" class="search-input" placeholder="搜索故事內容" id="content-search" oninput="doContentSearch()">
        </div>
      </div>
      <div class="scroll sys" id="search-results"><div class="empty"><div class="empty-icon">🔍</div><div class="empty-title">輸入關鍵詞搜索</div></div></div>
    </div>
    <!-- 指令管理 -->
    <div class="view" id="view-instructions">
      <div class="list-nav">
        <span class="list-nav-title" style="background:none;-webkit-text-fill-color:var(--text-primary)">指令管理</span>
        <div style="display:flex;gap:4px"><div class="nav-btn" onclick="importInst()">➕</div></div>
      </div>
      <div class="scroll sys" id="inst-list"></div>
      <div class="tab-bar">
        <div class="tab-item" onclick="switchTab('stories')"><span class="tab-icon">📚</span><span class="tab-label">故事</span></div>
        <div class="tab-item active" onclick="switchTab('instructions')"><span class="tab-icon">📜</span><span class="tab-label">指令</span></div>
        <div class="tab-item" onclick="switchTab('settings')"><span class="tab-icon">⚙️</span><span class="tab-label">設置</span></div>
      </div>
    </div>
    <!-- 設置 -->
    <div class="view" id="view-settings">
      <div class="list-nav">
        <span class="list-nav-title" style="background:none;-webkit-text-fill-color:var(--text-primary)">設置</span>
      </div>
      <div class="scroll sys" style="padding-bottom:80px">
        <div class="settings-section">
          <div class="settings-section-title">🎨 外觀</div>
          <div class="settings-card">
            <div class="settings-item" onclick="toggleTheme()"><span class="settings-item-label">主題</span><span class="settings-item-value" id="theme-val">深色模式 ›</span></div>
            <div class="settings-item" onclick="toggleScreen()"><span class="settings-item-label">屏幕模式</span><span class="settings-item-value" id="screen-val">手機模擬器 ›</span></div>
            <div class="settings-item" onclick="toast('字體設置')"><span class="settings-item-label">字體設置</span><span class="settings-item-value">16px ›</span></div>
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">🤖 AI設置</div>
          <div class="settings-card">
            <div class="settings-item" onclick="goTo('view-api')"><span class="settings-item-label">API 預設管理</span><span class="settings-item-value">›</span></div>
            <div class="settings-item" onclick="showContextSettings()"><span class="settings-item-label">上下文設置</span><span class="settings-item-value" id="context-val">20條消息 ›</span></div>
            <div class="settings-item" onclick="showMaxTokensSettings()"><span class="settings-item-label">最大生成長度</span><span class="settings-item-value" id="max-tokens-val">4096 ›</span></div>
            <div class="settings-item"><span class="settings-item-label">一致性檢查</span><div class="toggle active" id="tog-consist" onclick="toggleSet('consist')"></div></div>
            <div class="settings-item"><span class="settings-item-label">自動章節總結</span><div class="toggle active" id="tog-summary" onclick="toggleSet('summary')"></div></div>
            <div class="settings-item"><span class="settings-item-label">行動建議</span><div class="toggle active" id="tog-suggest" onclick="toggleSet('suggest')"></div></div>
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">⌨️ 輸入</div>
          <div class="settings-card">
            <div class="settings-item" onclick="showTypingSpeedSettings()"><span class="settings-item-label">打字機效果</span><span class="settings-item-value" id="typing-speed-val">30ms ›</span></div>
            <div class="settings-item" onclick="toggleSendKey()"><span class="settings-item-label">發送快捷鍵</span><span class="settings-item-value" id="send-key-val">Enter ›</span></div>
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">💾 數據</div>
          <div class="settings-card">
            <div class="settings-item" onclick="exportAll()"><span class="settings-item-label">導出所有數據</span><span class="settings-item-value">›</span></div>
            <div class="settings-item" onclick="importAll()"><span class="settings-item-label">導入數據</span><span class="settings-item-value">›</span></div>
            <div class="settings-item danger" onclick="clearAll()"><span class="settings-item-label">清空所有數據</span><span class="settings-item-value">›</span></div>
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">📱 應用</div>
          <div class="settings-card">
            <div class="settings-item" onclick="installPWA()"><span class="settings-item-label">安裝到桌面</span><span class="settings-item-value" id="pwa-install-status">›</span></div>
            <div class="settings-item" onclick="debugApiTest()"><span class="settings-item-label">🔧 API 連接調試</span><span class="settings-item-value">›</span></div>
            <div class="settings-item"><span class="settings-item-label">關於織夢</span><span class="settings-item-value">v3.0 ›</span></div>
          </div>
        </div>
      </div>
      <div class="tab-bar">
        <div class="tab-item" onclick="switchTab('stories')"><span class="tab-icon">📚</span><span class="tab-label">故事</span></div>
        <div class="tab-item" onclick="switchTab('instructions')"><span class="tab-icon">📜</span><span class="tab-label">指令</span></div>
        <div class="tab-item active" onclick="switchTab('settings')"><span class="tab-icon">⚙️</span><span class="tab-label">設置</span></div>
      </div>
    </div>
    <!-- API設置 -->
    <div class="view" id="view-api">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">‹</div>
        <span class="nav-title">API 預設管理</span>
        <div class="nav-right"><div class="nav-btn" onclick="addApi()">➕</div></div>
      </div>
      <div class="scroll sys" id="api-list"></div>
    </div>
    <!-- 章節管理 -->
    <div class="view" id="view-chapters">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">‹</div>
        <span class="nav-title">章節管理</span>
        <div class="nav-right"><div class="nav-btn" onclick="addChapter()">➕</div></div>
      </div>
      <div class="scroll sys" id="chapter-list"></div>
    </div>
    <!-- 書籤列表 -->
    <div class="view" id="view-bookmarks">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">‹</div>
        <span class="nav-title">書籤列表</span>
        <div class="nav-right"></div>
      </div>
      <div class="scroll sys" id="bookmark-list"></div>
    </div>
    <!-- 分支管理 -->
    <div class="view" id="view-branches">
      <div class="nav">
        <div class="nav-back" onclick="goBack()">‹</div>
        <span class="nav-title">分支管理</span>
        <div class="nav-right"><div class="nav-btn" onclick="createBranch()">➕</div></div>
      </div>
      <div class="scroll sys" id="branch-list"></div>
    </div>
  </div>
</div>
<!-- 沉浸模式 -->
<div class="immersive" id="immersive">
  <div class="immersive-content" id="immersive-content" onclick="nextImm()"></div>
  <div class="immersive-footer">
    <div class="immersive-progress"><div class="immersive-progress-fill" id="imm-progress"></div></div>
    <span class="immersive-hint">輕觸繼續 ▶</span>
    <div class="immersive-close" onclick="exitImm()">✕</div>
  </div>
</div>
<!-- 遮罩 -->
<div class="overlay" id="overlay" onclick="closeAll()"></div>
<!-- 底部面板 -->
<div class="bottom-sheet" id="sheet">
  <div class="bottom-sheet-handle"></div>
  <div class="bottom-sheet-title">故事設置</div>
  <div class="sheet-grid">
    <div class="sheet-item" onclick="goTo('view-timeline');closeAll()"><div class="sheet-item-icon">📅</div><div class="sheet-item-label">時間軸</div></div>
    <div class="sheet-item" onclick="goTo('view-foreshadow');closeAll()"><div class="sheet-item-icon">📌</div><div class="sheet-item-label">伏筆事件</div></div>
    <div class="sheet-item" onclick="goTo('view-chapters');closeAll()"><div class="sheet-item-icon">📑</div><div class="sheet-item-label">章節管理</div></div>
    <div class="sheet-item" onclick="goTo('view-saves');closeAll()"><div class="sheet-item-icon">💾</div><div class="sheet-item-label">存檔管理</div></div>
    <div class="sheet-item" onclick="goTo('view-branches');closeAll()"><div class="sheet-item-icon">🔀</div><div class="sheet-item-label">分支管理</div></div>
    <div class="sheet-item" onclick="showMemoryManager()"><div class="sheet-item-icon">🧠</div><div class="sheet-item-label">記憶管理</div></div>
    <div class="sheet-item" onclick="showFindReplace()"><div class="sheet-item-icon">🔍</div><div class="sheet-item-label">查找替換</div></div>
    <div class="sheet-item" onclick="showStats()"><div class="sheet-item-icon">📊</div><div class="sheet-item-label">統計面板</div></div>
    <div class="sheet-item" onclick="enterImm()"><div class="sheet-item-icon">🎭</div><div class="sheet-item-label">沉浸模式</div></div>
    <div class="sheet-item" onclick="exportStory()"><div class="sheet-item-icon">📤</div><div class="sheet-item-label">導出故事</div></div>
  </div>
</div>
<!-- 更多菜單 -->
<div class="context-menu" id="more-menu">
  <div class="context-menu-item" onclick="goTo('view-timeline');hideMenu()">📅 時間軸</div>
  <div class="context-menu-item" onclick="goTo('view-foreshadow');hideMenu()">📌 伏筆/事件</div>
  <div class="context-menu-item" onclick="goTo('view-chapters');hideMenu()">📑 章節列表</div>
  <div class="context-menu-item" onclick="goTo('view-bookmarks');hideMenu()">🔖 書籤列表</div>
  <div class="context-menu-divider"></div>
  <div class="context-menu-item" onclick="aiConsistencyCheck();hideMenu()">🔍 AI一致性檢查</div>
  <div class="context-menu-item" onclick="aiChapterSummary();hideMenu()">📝 AI章節總結</div>
  <div class="context-menu-item" onclick="aiSuggestions();hideMenu()">💡 AI行動建議</div>
  <div class="context-menu-divider"></div>
  <div class="context-menu-item" onclick="exportStory();hideMenu()">📤 導出故事</div>
  <div class="context-menu-item" onclick="enterImm();hideMenu()">🎭 沉浸模式</div>
</div>
<!-- 消息菜單 -->
<div class="context-menu" id="msg-menu">
  <div class="context-menu-item" onclick="editMsg()">✏️ 編輯</div>
  <div class="context-menu-item" onclick="regenerateMsg()">🔄 重新生成</div>
  <div class="context-menu-item" onclick="markForeshadow()">📌 標記伏筆</div>
  <div class="context-menu-item" onclick="addPlotTag()">🏷️ 添加標籤</div>
  <div class="context-menu-divider"></div>
  <div class="context-menu-item" onclick="rollbackTo()">↩️ 回溯到此</div>
  <div class="context-menu-item" onclick="copyMsg()">📋 複製</div>
  <div class="context-menu-item" onclick="addBookmark()">🔖 添加書籤</div>
  <div class="context-menu-divider"></div>
  <div class="context-menu-item danger" onclick="deleteMsg()">🗑️ 刪除消息</div>
</div>
<!-- 確認框 -->
<div class="modal" id="confirm-modal">
  <div class="modal-title" id="confirm-title">確認</div>
  <div class="modal-content" id="confirm-content">確定要執行此操作嗎？</div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('confirm-modal')">取消</button>
    <button class="modal-btn confirm" id="confirm-btn" onclick="confirmAction()">確定</button>
  </div>
</div>
<!-- 輸入框 -->
<div class="modal" id="input-modal">
  <div class="modal-title" id="input-title">輸入</div>
  <div class="modal-content" id="input-desc"></div>
  <input type="text" class="modal-input" id="modal-input" placeholder="">
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('input-modal')">取消</button>
    <button class="modal-btn confirm" onclick="confirmInput()">確定</button>
  </div>
</div>
<!-- 新建故事 -->
<div class="modal" id="new-story-modal" style="max-width:400px">
  <div class="modal-title">新建故事</div>
  <div class="form-group"><label class="form-label">故事標題</label><input type="text" class="form-input" id="new-title" placeholder="輸入故事標題"></div>
  <div class="form-group"><label class="form-label">簡介（可選）</label><textarea class="form-textarea" id="new-desc" placeholder="簡單描述這個故事..."></textarea></div>
  <div class="form-group"><label class="form-label">標籤（空格分隔）</label><input type="text" class="form-input" id="new-tags" placeholder="宮鬥 古風 戀愛"></div>
  <div class="form-group"><label class="form-label">綁定指令</label><select class="form-select" id="new-inst"><option value="">不綁定指令</option></select></div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('new-story-modal')">取消</button>
    <button class="modal-btn confirm" onclick="saveNewStory()">創建</button>
  </div>
</div>
<!-- API設置 -->
<div class="modal" id="api-modal" style="max-width:400px">
  <div class="modal-title">API 設置</div>
  <div class="form-group"><label class="form-label">預設名稱</label><input type="text" class="form-input" id="api-name" placeholder="例如: Claude API"></div>
  <div class="form-group"><label class="form-label">API 類型</label><select class="form-select" id="api-type" onchange="updateApiFields()"><option value="anthropic">Anthropic (Claude)</option><option value="openai">OpenAI (GPT)</option><option value="custom">自定義 API</option></select></div>
  <div class="form-group"><label class="form-label">API Key</label><input type="password" class="form-input" id="api-key" placeholder="sk-..."></div>
  <div class="form-group"><label class="form-label">模型</label><input type="text" class="form-input" id="api-model" list="model-list" placeholder="選擇或輸入模型名稱"><datalist id="model-list"><option value="claude-sonnet-4-20250514">Claude Sonnet 4</option><option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option><option value="claude-3-opus-20240229">Claude 3 Opus</option></datalist></div>
  <div class="form-group hidden" id="api-url-group"><label class="form-label">API URL</label><input type="text" class="form-input" id="api-url" placeholder="https://api.example.com"><div style="margin-top:6px"><label style="font-size:12px;color:var(--text-secondary);display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="api-url-autocomplete" checked> 自動補全 /v1/chat/completions</label></div></div>
  <div class="form-group"><button type="button" class="action-btn secondary" style="width:100%" onclick="testApi()">🔗 測試連接</button><div id="api-test-result" style="margin-top:8px;font-size:12px;display:none"></div></div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('api-modal')">取消</button>
    <button class="modal-btn confirm" onclick="saveApi()">保存</button>
  </div>
</div>
<!-- Toast -->
<div class="toast" id="toast"><span id="toast-text"></span></div>
<!-- Loading -->
<div class="loading" id="loading"><div class="loading-spinner"></div><div class="loading-text" id="loading-text">處理中...</div></div>
<!-- 上下文設置 Modal -->
<div class="modal" id="context-modal">
  <div class="modal-title">上下文設置</div>
  <div class="form-group">
    <label class="form-label">上下文消息數量</label>
    <p style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">發送給 AI 的歷史消息數量，越多越能理解上下文，但會消耗更多 Token</p>
    <input type="number" class="form-input" id="context-count" min="1" max="500" placeholder="輸入數量，例如：20">
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">建議範圍：10-50，最大支持 500</div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('context-modal')">取消</button>
    <button class="modal-btn confirm" onclick="saveContextSettings()">保存</button>
  </div>
</div>
<!-- 最大 Token Modal -->
<div class="modal" id="max-tokens-modal">
  <div class="modal-title">最大生成長度</div>
  <div class="form-group">
    <label class="form-label">Max Tokens</label>
    <p style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">AI 單次回復的最大長度，越大回復越長但也越慢</p>
    <input type="number" class="form-input" id="max-tokens-input" min="100" placeholder="輸入數量，例如：4096">
    <div style="font-size:11px;color:var(--text-tertiary);margin-top:4px">建議範圍：1024-8192，可根據模型支持自行調整</div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('max-tokens-modal')">取消</button>
    <button class="modal-btn confirm" onclick="saveMaxTokensSettings()">保存</button>
  </div>
</div>
<!-- 打字機效果 Modal -->
<div class="modal" id="typing-modal">
  <div class="modal-title">打字機效果</div>
  <div class="form-group">
    <label class="form-label">打字速度</label>
    <p style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px">每個字顯示的間隔時間，0 為關閉打字機效果</p>
    <select class="form-select" id="typing-speed-select">
      <option value="0">關閉</option>
      <option value="10">10ms（快速）</option>
      <option value="20">20ms</option>
      <option value="30">30ms（推薦）</option>
      <option value="50">50ms</option>
      <option value="80">80ms（慢速）</option>
    </select>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('typing-modal')">取消</button>
    <button class="modal-btn confirm" onclick="saveTypingSpeedSettings()">保存</button>
  </div>
</div>
<!-- 編輯消息 Modal -->
<div class="modal" id="edit-msg-modal" style="max-width:min(90%,400px)">
  <div class="modal-title">編輯消息</div>
  <div class="form-group">
    <textarea class="form-input" id="edit-msg-content" style="min-height:200px;resize:vertical" placeholder="編輯消息內容..."></textarea>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('edit-msg-modal')">取消</button>
    <button class="modal-btn confirm" onclick="saveEditMsg()">保存</button>
  </div>
</div>
<!-- 重新生成 Modal -->
<div class="modal" id="regen-modal">
  <div class="modal-title">🔄 重新生成</div>
  <div class="form-group">
    <label class="form-label">補充說明（可選）</label>
    <textarea class="form-input" id="regen-note" style="min-height:80px" placeholder="例如：描寫更細膩一些、語氣更強硬..."></textarea>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('regen-modal')">取消</button>
    <button class="modal-btn confirm" onclick="doRegenerate()">重新生成</button>
  </div>
</div>
<!-- 記憶管理 Modal -->
<div class="modal" id="memory-modal">
  <div class="modal-title">🧠 記憶管理</div>
  <div style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">
    當對話過長時，可以壓縮舊消息來節省 Token。壓縮後的摘要會作為上下文發送給 AI。
  </div>
  <div class="form-group">
    <label class="form-label">當前狀態</label>
    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;font-size:13px">
      <div>總消息數：<span id="memory-msg-count">0</span> 條</div>
      <div>已壓縮：<span id="memory-compressed">0</span> 條</div>
      <div>摘要數：<span id="memory-summary-count">0</span> 條</div>
    </div>
  </div>
  <div class="form-group">
    <label class="form-label">壓縮選項</label>
    <select class="form-select" id="compress-count">
      <option value="10">壓縮最早 10 條消息</option>
      <option value="20">壓縮最早 20 條消息</option>
      <option value="50">壓縮最早 50 條消息</option>
      <option value="all">壓縮所有舊消息（保留最近20條）</option>
    </select>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('memory-modal')">取消</button>
    <button class="modal-btn confirm" onclick="compressMemory()">壓縮記憶</button>
  </div>
</div>
<!-- 查找替換 Modal -->
<div class="modal" id="find-replace-modal">
  <div class="modal-title">🔍 查找與替換</div>
  <div class="form-group">
    <label class="form-label">查找</label>
    <input type="text" class="form-input" id="find-text" placeholder="輸入要查找的文字">
  </div>
  <div class="form-group">
    <label class="form-label">替換為</label>
    <input type="text" class="form-input" id="replace-text" placeholder="輸入替換後的文字">
  </div>
  <div class="form-group">
    <label style="font-size:13px;color:var(--text-secondary);display:flex;align-items:center;gap:6px;cursor:pointer">
      <input type="checkbox" id="find-case-sensitive"> 區分大小寫
    </label>
  </div>
  <div id="find-result" style="font-size:13px;color:var(--text-tertiary);margin-bottom:12px"></div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('find-replace-modal')">關閉</button>
    <button class="modal-btn secondary" onclick="findNext()">查找下一個</button>
    <button class="modal-btn confirm" onclick="replaceAll()">全部替換</button>
  </div>
</div>
<!-- 統計面板 Modal -->
<div class="modal" id="stats-modal">
  <div class="modal-title">📊 統計面板</div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;text-align:center">
      <div style="font-size:24px;font-weight:bold;color:var(--primary)" id="stats-chars">0</div>
      <div style="font-size:12px;color:var(--text-tertiary)">總字數</div>
    </div>
    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;text-align:center">
      <div style="font-size:24px;font-weight:bold;color:var(--primary)" id="stats-msgs">0</div>
      <div style="font-size:12px;color:var(--text-tertiary)">消息數</div>
    </div>
    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;text-align:center">
      <div style="font-size:24px;font-weight:bold;color:var(--primary)" id="stats-tokens">0</div>
      <div style="font-size:12px;color:var(--text-tertiary)">總 Tokens</div>
    </div>
    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;text-align:center">
      <div style="font-size:24px;font-weight:bold;color:var(--primary)" id="stats-time">0h</div>
      <div style="font-size:12px;color:var(--text-tertiary)">遊玩時長</div>
    </div>
  </div>
  <div style="margin-top:16px;padding:12px;background:var(--bg-tertiary);border-radius:8px;font-size:13px">
    <div style="margin-bottom:8px"><strong>用戶輸入：</strong><span id="stats-user-chars">0</span> 字</div>
    <div><strong>AI 生成：</strong><span id="stats-ai-chars">0</span> 字</div>
  </div>
  <div class="modal-actions">
    <button class="modal-btn confirm" onclick="closeModal('stats-modal')">關閉</button>
  </div>
</div>
<!-- 添加章節 Modal -->
<div class="modal" id="chapter-modal">
  <div class="modal-title">📑 添加章節</div>
  <div class="form-group">
    <label class="form-label">章節標題</label>
    <input type="text" class="form-input" id="chapter-title" placeholder="例如：第一章・入宮">
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('chapter-modal')">取消</button>
    <button class="modal-btn confirm" onclick="saveChapter()">保存</button>
  </div>
</div>
<!-- 添加書籤 Modal -->
<div class="modal" id="bookmark-modal">
  <div class="modal-title">🔖 添加書籤</div>
  <div class="form-group">
    <label class="form-label">書籤名稱</label>
    <input type="text" class="form-input" id="bookmark-name" placeholder="例如：重要劇情點">
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('bookmark-modal')">取消</button>
    <button class="modal-btn confirm" onclick="saveBookmark()">保存</button>
  </div>
</div>
<!-- 添加標籤 Modal -->
<div class="modal" id="tag-modal">
  <div class="modal-title">🏷️ 添加劇情標籤</div>
  <div class="form-group">
    <label class="form-label">標籤類型</label>
    <select class="form-select" id="tag-type">
      <option value="key">🔑 關鍵劇情</option>
      <option value="scene">🎬 名場面</option>
      <option value="clue">🔍 線索</option>
      <option value="turning">🔄 轉折點</option>
      <option value="emotion">💕 情感戲</option>
    </select>
  </div>
  <div class="form-group">
    <label class="form-label">備註（可選）</label>
    <input type="text" class="form-input" id="tag-note" placeholder="簡短描述">
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('tag-modal')">取消</button>
    <button class="modal-btn confirm" onclick="savePlotTag()">保存</button>
  </div>
</div>
<!-- 創建分支 Modal -->
<div class="modal" id="branch-modal">
  <div class="modal-title">🔀 創建分支</div>
  <div class="form-group">
    <label class="form-label">分支名稱</label>
    <input type="text" class="form-input" id="branch-name" placeholder="例如：選擇幫助夜寒">
  </div>
  <div class="form-group">
    <label class="form-label">分支描述（可選）</label>
    <textarea class="form-input" id="branch-desc" style="min-height:60px" placeholder="這個分支的特點..."></textarea>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('branch-modal')">取消</button>
    <button class="modal-btn confirm" onclick="saveBranch()">創建</button>
  </div>
</div>
<!-- AI 一致性檢查 Modal -->
<div class="modal" id="ai-check-modal" style="max-width:min(90%,400px)">
  <div class="modal-title">🔍 AI 一致性檢查</div>
  <div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">
    AI 將分析故事內容，檢查是否存在設定矛盾、時間線錯誤、角色行為不一致等問題。
  </div>
  <div id="ai-check-result" style="background:var(--bg-tertiary);padding:12px;border-radius:8px;min-height:100px;max-height:300px;overflow-y:auto;font-size:13px;white-space:pre-wrap">
    點擊「開始檢查」進行分析...
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('ai-check-modal')">關閉</button>
    <button class="modal-btn confirm" onclick="doAiConsistencyCheck()">開始檢查</button>
  </div>
</div>
<!-- AI 章節總結 Modal -->
<div class="modal" id="ai-summary-modal" style="max-width:min(90%,400px)">
  <div class="modal-title">📝 AI 章節總結</div>
  <div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">
    AI 將自動生成當前故事進度的摘要，包括主要事件、角色狀態變化等。
  </div>
  <div id="ai-summary-result" style="background:var(--bg-tertiary);padding:12px;border-radius:8px;min-height:100px;max-height:300px;overflow-y:auto;font-size:13px;white-space:pre-wrap">
    點擊「生成總結」開始...
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('ai-summary-modal')">關閉</button>
    <button class="modal-btn secondary" onclick="copySummary()">複製</button>
    <button class="modal-btn confirm" onclick="doAiChapterSummary()">生成總結</button>
  </div>
</div>
<!-- AI 行動建議 Modal -->
<div class="modal" id="ai-suggest-modal" style="max-width:min(90%,400px)">
  <div class="modal-title">💡 AI 行動建議</div>
  <div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">
    卡關了？讓 AI 為你提供一些可能的行動方向。
  </div>
  <div id="ai-suggest-result" style="background:var(--bg-tertiary);padding:12px;border-radius:8px;min-height:100px;max-height:300px;overflow-y:auto;font-size:13px;white-space:pre-wrap">
    點擊「獲取建議」開始...
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('ai-suggest-modal')">關閉</button>
    <button class="modal-btn confirm" onclick="doAiSuggestions()">獲取建議</button>
  </div>
</div>
<!-- 高級搜索 Modal -->
<div class="modal" id="advanced-search-modal">
  <div class="modal-title">🔍 高級搜索</div>
  <div class="form-group">
    <label class="form-label">關鍵詞</label>
    <input type="text" class="form-input" id="adv-search-keyword" placeholder="輸入搜索關鍵詞">
  </div>
  <div class="form-group">
    <label class="form-label">搜索範圍</label>
    <select class="form-select" id="adv-search-scope">
      <option value="all">全部內容</option>
      <option value="user">僅用戶輸入</option>
      <option value="ai">僅 AI 回復</option>
    </select>
  </div>
  <div class="form-group">
    <label style="font-size:13px;color:var(--text-secondary);display:flex;align-items:center;gap:6px;cursor:pointer">
      <input type="checkbox" id="adv-search-case"> 區分大小寫
    </label>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('advanced-search-modal')">取消</button>
    <button class="modal-btn confirm" onclick="doAdvancedSearch()">搜索</button>
  </div>
</div>
<!-- 資料編輯 Modal -->
<div class="modal" id="lore-modal">
  <div class="modal-title">📖 資料設定</div>
  <div class="form-group">
    <label class="form-label">名稱</label>
    <input type="text" class="form-input" id="lore-name" placeholder="例如：夜寒、鳳儀宮">
  </div>
  <div class="form-group">
    <label class="form-label">類型</label>
    <select class="form-select" id="lore-category">
      <option value="character">👥 角色</option>
      <option value="location">🗺️ 地點</option>
      <option value="item">📦 物品</option>
      <option value="setting">📜 設定</option>
    </select>
  </div>
  <div class="form-group">
    <label class="form-label">簡介</label>
    <input type="text" class="form-input" id="lore-desc" placeholder="簡短描述">
  </div>
  <div class="form-group">
    <label class="form-label">詳細內容</label>
    <textarea class="form-input" id="lore-content-input" style="min-height:100px" placeholder="詳細設定內容，會作為上下文發送給 AI"></textarea>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('lore-modal')">取消</button>
    <button class="modal-btn confirm" onclick="saveLore()">保存</button>
  </div>
</div>
<!-- 時間軸編輯 Modal -->
<div class="modal" id="timeline-modal">
  <div class="modal-title">📅 添加時間點</div>
  <div class="form-group">
    <label class="form-label">時間標記</label>
    <input type="text" class="form-input" id="timeline-label" placeholder="例如：昭鳳元年・一月二日">
  </div>
  <div class="form-group">
    <label class="form-label">事件描述</label>
    <textarea class="form-input" id="timeline-event" style="min-height:60px" placeholder="這個時間點發生了什麼"></textarea>
  </div>
  <div class="form-group">
    <label style="font-size:13px;color:var(--text-secondary);display:flex;align-items:center;gap:6px;cursor:pointer">
      <input type="checkbox" id="timeline-set-current" checked> 設為當前故事時間
    </label>
  </div>
  <div class="modal-actions">
    <button class="modal-btn cancel" onclick="closeModal('timeline-modal')">取消</button>
    <button class="modal-btn confirm" onclick="saveTimeline()">保存</button>
  </div>
</div>
<!-- iOS 安裝指引 Modal -->
<div class="modal" id="ios-install-modal">
  <div class="modal-title">📱 在 iPhone 上安裝</div>
  <div class="modal-content" style="text-align:center">
    <p style="margin-bottom:16px;font-size:15px">請按照以下步驟安裝到主畫面：</p>
    <div style="text-align:left;background:var(--bg-tertiary);padding:16px;border-radius:8px;margin-bottom:16px">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
        <span style="font-size:24px">1️⃣</span>
        <span>點擊底部的 <strong>分享按鈕</strong> <span style="font-size:18px">⬆️</span></span>
      </div>
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
        <span style="font-size:24px">2️⃣</span>
        <span>向下滑動，點擊 <strong>「加入主畫面」</strong></span>
      </div>
      <div style="display:flex;align-items:center;gap:12px">
        <span style="font-size:24px">3️⃣</span>
        <span>點擊 <strong>「新增」</strong> 完成安裝</span>
      </div>
    </div>
    <p style="font-size:12px;color:var(--text-tertiary)">安裝後，織夢會像普通 App 一樣出現在您的主畫面</p>
  </div>
  <div class="modal-actions">
    <button class="modal-btn confirm" onclick="closeModal('ios-install-modal')">知道了</button>
  </div>
</div>
<!-- 隱藏輸入 -->
<input type="file" id="file-input" accept=".md,.txt,.json" style="display:none">
<input type="file" id="import-input" accept=".json" style="display:none">
<script>
// 全局狀態
let db, story=null, msgs=[], hist=['view-stories'], generating=false, typingCtrl=null, selMsgId=null, confirmCb=null, inputCb=null, editApiId=null;
let settings={theme:'dark',screen:'phone',consist:true,summary:true,suggest:true,typingSpeed:30,contextCount:20,maxTokens:4096,sendKey:'enter'};

// 初始化
document.addEventListener('DOMContentLoaded',async()=>{
  await initDB();
  await loadSettings();
  await renderStories();
  await renderInst();
  await renderApi();
  updateTime();
  setInterval(updateTime,60000);
});

// 數據庫
async function initDB(){
  db=new Dexie('ZhimengDB');
  db.version(1).stores({
    stories:'id,title,createdAt,updatedAt,isPinned',
    messages:'id,storyId,branchId,[storyId+branchId],createdAt',
    branches:'id,storyId,parentBranchId,createdAt',
    instructions:'id,createdAt',
    storyInstructions:'[storyId+instructionId],storyId,instructionId',
    loreEntries:'id,storyId,category,createdAt',
    foreshadowing:'id,storyId,messageId,isResolved,createdAt',
    events:'id,storyId,messageId,createdAt',
    characterStates:'id,storyId,loreEntryId',
    timeline:'id,storyId,messageId,order',
    saves:'id,storyId,slotIndex,isAuto,createdAt',
    apiPresets:'id,isActive,createdAt',
    settings:'key',
    // 新增表
    chapters:'id,storyId,messageId,order,createdAt',
    bookmarks:'id,storyId,messageId,createdAt',
    plotTags:'id,storyId,messageId,type,createdAt'
  });
  await db.open();
}

// 設置
async function loadSettings(){
  try{
    const s=await db.settings.toArray();
    s.forEach(x=>{if(x.key in settings)settings[x.key]=x.value});
    applySettings();
  }catch(e){}
}
async function saveSetting(k,v){await db.settings.put({key:k,value:v});settings[k]=v;}
function applySettings(){
  document.documentElement.setAttribute('data-theme',settings.theme);
  document.getElementById('theme-val').textContent=settings.theme==='dark'?'深色模式 ›':'淺色模式 ›';
  const app=document.getElementById('app');
  if(settings.screen==='fullscreen'){app.classList.add('fullscreen');document.getElementById('screen-val').textContent='全屏模式 ›';}
  else{app.classList.remove('fullscreen');document.getElementById('screen-val').textContent='手機模擬器 ›';}
  ['consist','summary','suggest'].forEach(k=>{const t=document.getElementById('tog-'+k);if(t){if(settings[k])t.classList.add('active');else t.classList.remove('active');}});
  // 新增設置項的顯示
  const ctxVal=document.getElementById('context-val');if(ctxVal)ctxVal.textContent=settings.contextCount+'條消息 ›';
  const maxVal=document.getElementById('max-tokens-val');if(maxVal)maxVal.textContent=settings.maxTokens+' ›';
  const typVal=document.getElementById('typing-speed-val');if(typVal)typVal.textContent=settings.typingSpeed===0?'關閉 ›':settings.typingSpeed+'ms ›';
  const keyVal=document.getElementById('send-key-val');if(keyVal)keyVal.textContent=settings.sendKey==='enter'?'Enter ›':'Ctrl+Enter ›';
}
function toggleTheme(){settings.theme=settings.theme==='dark'?'light':'dark';saveSetting('theme',settings.theme);applySettings();toast('主題已切換');}
function toggleScreen(){settings.screen=settings.screen==='phone'?'fullscreen':'phone';saveSetting('screen',settings.screen);applySettings();}
function toggleSet(k){settings[k]=!settings[k];saveSetting(k,settings[k]);applySettings();}
function toggleSendKey(){settings.sendKey=settings.sendKey==='enter'?'ctrl+enter':'enter';saveSetting('sendKey',settings.sendKey);applySettings();toast('發送快捷鍵已切換');}

// 處理輸入框按鍵事件
function handleInputKey(event){
  if(event.key==='Enter'){
    if(settings.sendKey==='ctrl+enter'){
      if(event.ctrlKey||event.metaKey){
        event.preventDefault();
        send();
      }
    }else{
      // 默認 Enter 發送
      if(!event.ctrlKey&&!event.metaKey&&!event.shiftKey){
        event.preventDefault();
        send();
      }
    }
  }
}

// 上下文設置
function showContextSettings(){
  document.getElementById('context-count').value=settings.contextCount||20;
  showModal('context-modal');
}
function saveContextSettings(){
  const val=parseInt(document.getElementById('context-count').value)||20;
  settings.contextCount=Math.max(1,Math.min(500,val));
  saveSetting('contextCount',settings.contextCount);
  applySettings();
  closeModal('context-modal');
  toast('上下文設置已保存');
}

// 最大 Token 設置
function showMaxTokensSettings(){
  document.getElementById('max-tokens-input').value=settings.maxTokens||4096;
  showModal('max-tokens-modal');
}
function saveMaxTokensSettings(){
  const val=parseInt(document.getElementById('max-tokens-input').value)||4096;
  settings.maxTokens=Math.max(100,val);
  saveSetting('maxTokens',settings.maxTokens);
  applySettings();
  closeModal('max-tokens-modal');
  toast('最大生成長度已保存');
}

// 打字機效果設置
function showTypingSpeedSettings(){
  document.getElementById('typing-speed-select').value=settings.typingSpeed||30;
  showModal('typing-modal');
}
function saveTypingSpeedSettings(){
  settings.typingSpeed=parseInt(document.getElementById('typing-speed-select').value);
  saveSetting('typingSpeed',settings.typingSpeed);
  applySettings();
  closeModal('typing-modal');
  toast('打字機效果已保存');
}

// 時間
function updateTime(){const n=new Date();document.getElementById('status-time').textContent=`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;}

// 導航
function goTo(id){
  const cur=document.querySelector('.view.active'),tar=document.getElementById(id);
  if(!tar||cur===tar)return;
  hist.push(id);
  cur.classList.remove('active');cur.classList.add('out');
  tar.classList.add('active');
  setTimeout(()=>cur.classList.remove('out'),300);
  // 載入數據
  if(id==='view-lore')renderLore();
  else if(id==='view-timeline')renderTimeline();
  else if(id==='view-foreshadow')renderForeshadow();
  else if(id==='view-saves')renderSaves();
  else if(id==='view-api')renderApi();
  else if(id==='view-chapters')renderChapters();
  else if(id==='view-bookmarks')renderBookmarks();
  else if(id==='view-branches')renderBranches();
}
function goBack(){
  if(hist.length>1){
    hist.pop();
    const prev=hist[hist.length-1];
    const cur=document.querySelector('.view.active'),tar=document.getElementById(prev);
    cur.classList.remove('active');tar.classList.add('active');
  }
}
function switchTab(t){
  document.querySelectorAll('.tab-bar .tab-item').forEach(x=>x.classList.remove('active'));
  if(t==='stories'){goTo('view-stories');document.querySelectorAll('.tab-bar')[0]?.querySelector('.tab-item')?.classList.add('active');}
  else if(t==='instructions'){goTo('view-instructions');}
  else if(t==='settings'){goTo('view-settings');}
}

// 故事列表
async function renderStories(){
  const c=document.getElementById('story-list');
  let list=await db.stories.orderBy('updatedAt').reverse().toArray();
  list.sort((a,b)=>(a.isPinned&&!b.isPinned)?-1:(!a.isPinned&&b.isPinned)?1:0);
  if(!list.length){c.innerHTML=`<div class="empty"><div class="empty-icon">📚</div><div class="empty-title">還沒有故事</div><div class="empty-desc">點擊右上角 ➕ 創建你的第一個互動故事</div><button class="empty-btn" onclick="createStory()">創建故事</button></div>`;return;}
  c.innerHTML=list.map(s=>{
    const t=timeAgo(s.updatedAt),stats=s.statistics||{totalChars:0},tags=(s.tags||[]).map(x=>`<span class="tag">${esc(x)}</span>`).join('');
    return `<div class="card ${s.isPinned?'pinned':''}" onclick="openStory('${s.id}')" oncontextmenu="event.preventDefault();toast('故事菜單')"><div class="card-cover">${s.cover||'📖'}</div><div class="card-info"><div class="card-header"><span class="card-title">${esc(s.title)}</span><span class="card-time">${t}</span></div><div class="card-preview">${esc(s.preview||'開始你的冒險...')}</div><div class="card-meta">${s.instructionName?`<span class="card-instruction">📜 ${esc(s.instructionName)}</span>`:''}<span class="card-stats">📊 ${fmtNum(stats.totalChars)}字</span></div>${tags?`<div class="card-tags">${tags}</div>`:''}</div></div>`;
  }).join('');
}
function filterStories(){const q=document.getElementById('story-search').value.toLowerCase();document.querySelectorAll('#story-list .card').forEach(c=>{const t=c.querySelector('.card-title')?.textContent.toLowerCase()||'';c.style.display=t.includes(q)?'':'none';});}

async function createStory(){
  const insts=await db.instructions.toArray();
  const sel=document.getElementById('new-inst');
  sel.innerHTML='<option value="">不綁定指令</option>'+insts.map(i=>`<option value="${i.id}">${esc(i.name)}</option>`).join('');
  document.getElementById('new-title').value='';
  document.getElementById('new-desc').value='';
  document.getElementById('new-tags').value='';
  showModal('new-story-modal');
}
async function saveNewStory(){
  const title=document.getElementById('new-title').value.trim();
  if(!title){toast('請輸入故事標題','warning');return;}
  const desc=document.getElementById('new-desc').value.trim();
  const tagsStr=document.getElementById('new-tags').value.trim();
  const tags=tagsStr?tagsStr.split(/\s+/):[];
  const instId=document.getElementById('new-inst').value;
  const storyId=crypto.randomUUID(),branchId='main_'+crypto.randomUUID(),now=Date.now();
  const s={id:storyId,title,description:desc,cover:'📖',tags,currentBranchId:branchId,currentMessageId:null,storyTime:'',isPinned:false,preview:'',createdAt:now,updatedAt:now,statistics:{totalChars:0,totalMessages:0},draft:'',autoSave:{enabled:true,interval:20,maxCount:5}};
  if(instId){const inst=await db.instructions.get(instId);if(inst){s.instructionName=inst.name;await db.storyInstructions.put({storyId,instructionId:instId,order:0});}}
  await db.branches.put({id:branchId,storyId,name:'主線',parentBranchId:null,createdAt:now});
  await db.stories.put(s);
  closeModal('new-story-modal');
  toast('故事創建成功！','success');
  await renderStories();
  openStory(storyId);
}

async function openStory(id){
  showLoading('載入故事...');
  try{
    story=await db.stories.get(id);
    if(!story){toast('故事不存在','error');hideLoading();return;}
    msgs=await db.messages.where('[storyId+branchId]').equals([id,story.currentBranchId]).sortBy('createdAt');
    document.getElementById('reading-title').textContent=story.title;
    renderMsgs();
    goTo('view-reading');
    hideLoading();
  }catch(e){console.error(e);toast('載入失敗','error');hideLoading();}
}
function renderMsgs(){
  const c=document.getElementById('content-area');
  if(!msgs.length){c.innerHTML=`<div class="empty" style="padding:60px 20px"><div class="empty-icon">✨</div><div class="empty-title">故事即將開始</div><div class="empty-desc">輸入你的第一個行動，或點擊「繼續」讓AI開始講述...</div></div>`;updateProgress();return;}
  let html='',lastTime=null;
  msgs.forEach(m=>{
    if(m.storyTime&&m.storyTime!==lastTime){html+=`<div class="time-div">${esc(m.storyTime)}</div>`;lastTime=m.storyTime;}
    const isUser=m.role==='user',content=marked.parse(m.content||'');
    html+=`<div class="msg ${isUser?'user':''}" data-id="${m.id}" oncontextmenu="showMsgMenu(event,'${m.id}')">${content}${m.tokens?`<div style="text-align:right;font-size:11px;color:var(--text-tertiary);margin-top:8px;font-family:sans-serif">${m.tokens} tokens</div>`:''}</div>`;
  });
  c.innerHTML=html;
  c.scrollTop=c.scrollHeight;
  updateProgress();
}
function updateProgress(){const n=msgs.length;document.getElementById('progress-fill').style.width=(n>0?100:0)+'%';document.getElementById('progress-text').textContent=n>0?n+'條':'0%';}

// 發送消息
async function send(){
  const input=document.getElementById('user-input'),content=input.value.trim();
  if(!content||generating)return;
  if(!story){toast('請先選擇故事','warning');return;}
  generating=true;
  document.getElementById('send-btn').disabled=true;
  const userMsgId=crypto.randomUUID();
  const userMsg={id:userMsgId,storyId:story.id,branchId:story.currentBranchId,role:'user',content,createdAt:Date.now()};
  await db.messages.put(userMsg);
  msgs.push(userMsg);
  input.value='';
  renderMsgs();
  showTyping();
  try{
    const resp=await callAI(content);
    hideTyping();
    const aiMsgId=crypto.randomUUID();
    const aiMsg={id:aiMsgId,storyId:story.id,branchId:story.currentBranchId,role:'assistant',content:resp.content,tokens:resp.tokens||0,storyTime:story.storyTime||'',createdAt:Date.now()};
    await db.messages.put(aiMsg);
    msgs.push(aiMsg);
    await db.stories.update(story.id,{updatedAt:Date.now(),preview:resp.content.slice(0,100),currentMessageId:aiMsgId,'statistics.totalMessages':msgs.length,'statistics.totalChars':(story.statistics?.totalChars||0)+resp.content.length});
    await typewriter(aiMsg);
  }catch(e){console.error(e);hideTyping();toast('生成失敗: '+e.message,'error');}
  generating=false;
  document.getElementById('send-btn').disabled=false;
}
function sendCmd(cmd){document.getElementById('user-input').value=cmd;send();}

async function callAI(content){
  const preset=await db.apiPresets.filter(p=>p.isActive).first();
  if(!preset){throw new Error('請先配置並選擇一個 API 預設');}
  if(!preset.apiKey){throw new Error('API Key 未設置');}
  if(!preset.model){throw new Error('模型未設置');}
  console.log('Using API preset:', preset.name, preset.type, preset.model);
  const sysPrompt=await buildSysPrompt();
  const contextCount = settings.contextCount || 20;
  const messages=msgs.slice(-contextCount).map(m=>({role:m.role,content:m.content}));
  if(!messages.length||messages[messages.length-1].content!==content)messages.push({role:'user',content});
  if(preset.type==='anthropic')return await callAnthropic(preset,sysPrompt,messages);
  else if(preset.type==='openai')return await callOpenAI(preset,sysPrompt,messages);
  else return await callCustom(preset,sysPrompt,messages);
}
// 別名
async function callApi(content){ return await callAI(content); }
async function callAnthropic(p,sys,msgs){
  console.log('Calling Anthropic API with model:', p.model);
  let r;
  try {
    r = await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      mode: 'cors',
      credentials: 'omit',
      cache: 'no-cache',
      headers:{
        'Content-Type':'application/json',
        'x-api-key':p.apiKey,
        'anthropic-version':'2023-06-01',
        'anthropic-dangerous-direct-browser-access':'true'
      },
      body:JSON.stringify({model:p.model,max_tokens:settings.maxTokens||4096,system:sys,messages:msgs})
    });
  } catch(e) {
    console.error('Fetch error:', e);
    const errMsg = e.message || e.toString() || '';
    if(errMsg.includes('Load failed') || errMsg.includes('Failed to fetch')) {
      throw new Error('網絡錯誤 - 請檢查網絡連接或 API 服務狀態');
    }
    throw new Error('網絡請求失敗: ' + errMsg);
  }
  
  const text = await r.text();
  console.log('API Response status:', r.status, 'body:', text.slice(0, 500));
  
  if(!r.ok){
    try {
      const e = JSON.parse(text);
      throw new Error(e.error?.message || `API錯誤 (${r.status})`);
    } catch(parseErr) {
      if(parseErr.message.includes('API錯誤')) throw parseErr;
      throw new Error(`API錯誤 (${r.status}): ${text.slice(0, 200)}`);
    }
  }
  
  try {
    const d = JSON.parse(text);
    if(!d.content || !d.content[0]){throw new Error('API返回格式錯誤');}
    return {content: d.content[0].text, tokens: d.usage?.output_tokens || 0};
  } catch(parseErr) {
    if(parseErr.message.includes('API')) throw parseErr;
    console.error('JSON parse error:', parseErr, 'Response:', text);
    throw new Error('JSON解析失敗，API返回: ' + text.slice(0, 100));
  }
}
async function callOpenAI(p,sys,msgs){
  console.log('Calling OpenAI API with model:', p.model);
  const allMsgs=[{role:'system',content:sys},...msgs];
  let r;
  try {
    r = await fetch('https://api.openai.com/v1/chat/completions',{
      method:'POST',
      mode: 'cors',
      credentials: 'omit',
      cache: 'no-cache',
      headers:{
        'Content-Type':'application/json',
        'Authorization':`Bearer ${p.apiKey}`
      },
      body:JSON.stringify({model:p.model,messages:allMsgs,max_tokens:settings.maxTokens||4096})
    });
  } catch(e) {
    console.error('Fetch error:', e);
    const errMsg = e.message || e.toString() || '';
    if(errMsg.includes('Load failed') || errMsg.includes('Failed to fetch')) {
      throw new Error('網絡錯誤 - 請檢查網絡連接或 API 服務狀態');
    }
    throw new Error('網絡請求失敗: ' + errMsg);
  }
  
  const text = await r.text();
  console.log('API Response status:', r.status, 'body:', text.slice(0, 500));
  
  if(!r.ok){
    try {
      const e = JSON.parse(text);
      throw new Error(e.error?.message || `API錯誤 (${r.status})`);
    } catch(parseErr) {
      if(parseErr.message.includes('API錯誤')) throw parseErr;
      throw new Error(`API錯誤 (${r.status}): ${text.slice(0, 200)}`);
    }
  }
  
  try {
    const d = JSON.parse(text);
    if(!d.choices || !d.choices[0]){throw new Error('API返回格式錯誤');}
    return {content: d.choices[0].message.content, tokens: d.usage?.completion_tokens || 0};
  } catch(parseErr) {
    if(parseErr.message.includes('API')) throw parseErr;
    console.error('JSON parse error:', parseErr, 'Response:', text);
    throw new Error('JSON解析失敗，API返回: ' + text.slice(0, 100));
  }
}
// 自動補全 API URL 路徑
function normalizeApiUrl(url, autoComplete = true) {
  if(!url) return url;
  url = url.trim();
  // 自動添加 https:// 協議
  if(!url.startsWith('http://') && !url.startsWith('https://')) {
    url = 'https://' + url;
  }
  // 移除尾部斜線
  url = url.replace(/\/+$/, '');
  
  // 如果不自動補全，直接返回
  if(!autoComplete) return url;
  
  // 如果已經包含完整路徑，直接返回
  if(url.includes('/v1/chat/completions') || url.includes('/v1/messages')) {
    return url;
  }
  // 如果只是基礎 URL，自動補全 OpenAI 兼容路徑
  if(url.endsWith('/v1')) {
    return url + '/chat/completions';
  }
  // 否則補全完整路徑
  return url + '/v1/chat/completions';
}

async function callCustom(p,sys,msgs){
  const autoComplete = p.urlAutoComplete !== false; // 默認為 true
  const apiUrl = normalizeApiUrl(p.url, autoComplete);
  console.log('Calling Custom API:', p.url, '→', apiUrl, '(autoComplete:', autoComplete, ') model:', p.model);
  if(!apiUrl){throw new Error('自定義 API URL 未設置');}
  
  // OpenAI 兼容格式：system 放在 messages 數組的第一個
  const allMsgs = [];
  if(sys) {
    allMsgs.push({role: 'system', content: sys});
  }
  allMsgs.push(...msgs);
  
  // 創建超時控制（60秒）
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 60000);
  
  let r;
  try {
    r = await fetch(apiUrl,{
      method:'POST',
      signal: controller.signal,
      mode: 'cors',
      credentials: 'omit',
      cache: 'no-cache',
      headers:{
        'Content-Type':'application/json',
        'Authorization':`Bearer ${p.apiKey}`
      },
      body:JSON.stringify({
        model: p.model,
        messages: allMsgs,
        max_tokens: settings.maxTokens || 4096
      })
    });
    clearTimeout(timeoutId);
  } catch(e) {
    clearTimeout(timeoutId);
    console.error('Fetch error:', e);
    const errMsg = e.message || e.toString() || '';
    if(e.name === 'AbortError') {
      throw new Error('請求超時（60秒）- 請檢查網絡連接');
    } else if(errMsg.includes('Load failed') || errMsg.includes('Failed to fetch') || errMsg.includes('NetworkError')) {
      throw new Error('網絡錯誤 - API 服務可能不支持瀏覽器直接調用（CORS），請確認 API 已開啟跨域支持');
    }
    throw new Error('網絡請求失敗: ' + errMsg);
  }
  
  const text = await r.text();
  console.log('API Response status:', r.status, 'body:', text.slice(0, 500));
  
  if(!r.ok){
    try {
      const e = JSON.parse(text);
      throw new Error(e.error?.message || `API錯誤 (${r.status})`);
    } catch(parseErr) {
      if(parseErr.message.includes('API錯誤')) throw parseErr;
      throw new Error(`API錯誤 (${r.status}): ${text.slice(0, 200)}`);
    }
  }
  
  try {
    const d = JSON.parse(text);
    const content = d.choices?.[0]?.message?.content || d.content?.[0]?.text || d.response || d.text || '';
    if(!content){throw new Error('API返回內容為空');}
    return {content, tokens: d.usage?.completion_tokens || 0};
  } catch(parseErr) {
    console.error('JSON parse error:', parseErr, 'Response:', text);
    throw new Error('JSON解析失敗，API返回: ' + text.slice(0, 100));
  }
}
async function buildSysPrompt(){
  if(!story)return'';
  let p='';
  const bindings=await db.storyInstructions.where('storyId').equals(story.id).toArray();
  for(const b of bindings){const i=await db.instructions.get(b.instructionId);if(i)p+=i.content+'\n\n';}
  const lore=await db.loreEntries.where('storyId').equals(story.id).filter(e=>e.isSelected).toArray();
  if(lore.length){p+='\n### 參考資料\n';for(const e of lore){p+=`\n#### ${e.name}\n${e.content}\n`;}}
  if(story.storyTime)p+=`\n### 當前時間\n${story.storyTime}\n`;
  const fs=await db.foreshadowing.where('storyId').equals(story.id).filter(f=>!f.isResolved).toArray();
  if(fs.length){p+='\n### 待回收伏筆\n';fs.forEach(f=>p+=`- ${f.title}：${f.description}\n`);}
  return p;
}

// 打字機效果
function showTyping(){const c=document.getElementById('content-area'),d=document.createElement('div');d.id='typing';d.className='typing';d.innerHTML='<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';c.appendChild(d);c.scrollTop=c.scrollHeight;}
function hideTyping(){const t=document.getElementById('typing');if(t)t.remove();}
async function typewriter(m){
  const c=document.getElementById('content-area'),d=document.createElement('div');
  d.className='msg';d.dataset.id=m.id;d.oncontextmenu=e=>showMsgMenu(e,m.id);
  c.appendChild(d);
  const text=m.content,speed=settings.typingSpeed||0;
  
  // 如果速度為 0，直接顯示全部內容
  if(speed===0){
    d.innerHTML=marked.parse(text);
    if(m.tokens)d.innerHTML+=`<div style="text-align:right;font-size:11px;color:var(--text-tertiary);margin-top:8px">${m.tokens} tokens</div>`;
    c.scrollTop=c.scrollHeight;
    return;
  }
  
  let i=0;
  return new Promise(resolve=>{
    typingCtrl={cancelled:false};
    function type(){
      if(typingCtrl.cancelled){d.innerHTML=marked.parse(text);if(m.tokens)d.innerHTML+=`<div style="text-align:right;font-size:11px;color:var(--text-tertiary);margin-top:8px">${m.tokens} tokens</div>`;resolve();return;}
      if(i<text.length){d.innerHTML=`<span>${marked.parse(text.slice(0,i+1))}</span><span class="typing-cursor"></span>`;c.scrollTop=c.scrollHeight;i++;setTimeout(type,speed);}
      else{d.innerHTML=marked.parse(text);if(m.tokens)d.innerHTML+=`<div style="text-align:right;font-size:11px;color:var(--text-tertiary);margin-top:8px">${m.tokens} tokens</div>`;resolve();}
    }
    type();
  });
}
document.getElementById('content-area')?.addEventListener('click',()=>{if(typingCtrl&&!typingCtrl.cancelled)typingCtrl.cancelled=true;});

// 資料庫
async function renderLore(){
  if(!story)return;
  const c=document.getElementById('lore-list');
  const entries=await db.loreEntries.where('storyId').equals(story.id).toArray();
  const grouped={character:[],location:[],item:[],setting:[]};
  entries.forEach(e=>{if(grouped[e.category])grouped[e.category].push(e);});
  const labels={character:{icon:'👥',label:'角色'},location:{icon:'🗺️',label:'地點'},item:{icon:'📦',label:'物品'},setting:{icon:'📜',label:'設定'}};
  let html='',selCount=0;
  for(const[cat,items]of Object.entries(grouped)){
    if(!items.length)continue;
    const{icon,label}=labels[cat];
    html+=`<div class="lore-section"><div class="lore-header" onclick="toggleLoreSection(this)"><div class="lore-header-left"><span>${icon}</span><span>${label}</span><span class="lore-count">(${items.length})</span></div><span class="lore-toggle">▼</span></div><div class="lore-list">`;
    for(const e of items){
      if(e.isSelected)selCount++;
      html+=`<div class="lore-item" onclick="toggleLoreSel('${e.id}')"><div class="lore-checkbox ${e.isSelected?'checked':''}" data-id="${e.id}"></div><div class="lore-icon ${cat.slice(0,3)}">${e.icon||icon}</div><div class="lore-content"><div class="lore-name">${esc(e.name)}</div><div class="lore-desc">${esc(e.description||'')}</div></div><div class="lore-actions" onclick="event.stopPropagation()"><span onclick="editLore('${e.id}')">✏️</span><span onclick="deleteLore('${e.id}')">🗑️</span></div></div>`;
    }
    html+='</div></div>';
  }
  if(!html)html='<div class="empty"><div class="empty-icon">📖</div><div class="empty-title">資料庫為空</div><div class="empty-desc">點擊右上角添加角色、地點等設定</div><button class="action-btn primary" style="margin-top:12px" onclick="addLore()">➕ 添加資料</button></div>';
  c.innerHTML=html;
  document.getElementById('lore-count').textContent=`已選 ${selCount} 項`;
}
function toggleLoreSection(h){h.querySelector('.lore-toggle').classList.toggle('collapsed');h.nextElementSibling.classList.toggle('collapsed');}
async function toggleLoreSel(id){const e=await db.loreEntries.get(id);if(e){await db.loreEntries.update(id,{isSelected:!e.isSelected});renderLore();}}

let editLoreId=null;
function addLore(){
  if(!story){toast('請先選擇故事','warning');return;}
  editLoreId=null;
  document.getElementById('lore-name').value='';
  document.getElementById('lore-category').value='character';
  document.getElementById('lore-desc').value='';
  document.getElementById('lore-content-input').value='';
  showModal('lore-modal');
}
async function editLore(id){
  const e=await db.loreEntries.get(id);
  if(!e)return;
  editLoreId=id;
  document.getElementById('lore-name').value=e.name||'';
  document.getElementById('lore-category').value=e.category||'character';
  document.getElementById('lore-desc').value=e.description||'';
  document.getElementById('lore-content-input').value=e.content||'';
  showModal('lore-modal');
}
async function saveLore(){
  const name=document.getElementById('lore-name').value.trim();
  const category=document.getElementById('lore-category').value;
  const description=document.getElementById('lore-desc').value.trim();
  const content=document.getElementById('lore-content-input').value.trim();
  if(!name){toast('請輸入名稱','warning');return;}
  const entry={
    id:editLoreId||crypto.randomUUID(),
    storyId:story.id,
    name,category,description,content,
    isSelected:false,
    createdAt:Date.now()
  };
  await db.loreEntries.put(entry);
  closeModal('lore-modal');
  toast(editLoreId?'資料已更新':'資料已添加','success');
  renderLore();
}
async function deleteLore(id){
  showConfirm('確定要刪除這條資料嗎？',async()=>{
    await db.loreEntries.delete(id);
    toast('資料已刪除','success');
    renderLore();
  });
}

// 資料搜索
async function filterLore(){
  const keyword=document.getElementById('lore-search').value.trim().toLowerCase();
  if(!story)return;
  const c=document.getElementById('lore-list');
  const entries=await db.loreEntries.where('storyId').equals(story.id).toArray();
  
  // 過濾
  const filtered=keyword?entries.filter(e=>
    e.name.toLowerCase().includes(keyword)||
    (e.description||'').toLowerCase().includes(keyword)||
    (e.content||'').toLowerCase().includes(keyword)
  ):entries;
  
  const grouped={character:[],location:[],item:[],setting:[]};
  filtered.forEach(e=>{if(grouped[e.category])grouped[e.category].push(e);});
  const labels={character:{icon:'👥',label:'角色'},location:{icon:'🗺️',label:'地點'},item:{icon:'📦',label:'物品'},setting:{icon:'📜',label:'設定'}};
  let html='',selCount=0;
  for(const[cat,items]of Object.entries(grouped)){
    if(!items.length)continue;
    const{icon,label}=labels[cat];
    html+=`<div class="lore-section"><div class="lore-header" onclick="toggleLoreSection(this)"><div class="lore-header-left"><span>${icon}</span><span>${label}</span><span class="lore-count">(${items.length})</span></div><span class="lore-toggle">▼</span></div><div class="lore-list">`;
    for(const e of items){
      if(e.isSelected)selCount++;
      html+=`<div class="lore-item" onclick="toggleLoreSel('${e.id}')"><div class="lore-checkbox ${e.isSelected?'checked':''}" data-id="${e.id}"></div><div class="lore-icon ${cat.slice(0,3)}">${e.icon||icon}</div><div class="lore-content"><div class="lore-name">${esc(e.name)}</div><div class="lore-desc">${esc(e.description||'')}</div></div><div class="lore-actions" onclick="event.stopPropagation()"><span onclick="editLore('${e.id}')">✏️</span><span onclick="deleteLore('${e.id}')">🗑️</span></div></div>`;
    }
    html+='</div></div>';
  }
  if(!html){
    if(keyword)html='<div class="empty"><div class="empty-icon">🔍</div><div class="empty-title">未找到匹配資料</div></div>';
    else html='<div class="empty"><div class="empty-icon">📖</div><div class="empty-title">資料庫為空</div><div class="empty-desc">點擊右上角添加角色、地點等設定</div><button class="action-btn primary" style="margin-top:12px" onclick="addLore()">➕ 添加資料</button></div>';
  }
  c.innerHTML=html;
  document.getElementById('lore-count').textContent=`已選 ${selCount} 項`;
}

// 搜索功能
function doContentSearch(){
  const keyword=document.getElementById('content-search').value.trim().toLowerCase();
  const c=document.getElementById('search-results');
  if(!keyword){
    c.innerHTML='<div class="empty"><div class="empty-icon">🔍</div><div class="empty-title">輸入關鍵詞搜索</div></div>';
    return;
  }
  const results=msgs.filter(m=>m.content.toLowerCase().includes(keyword));
  if(!results.length){
    c.innerHTML='<div class="empty"><div class="empty-icon">🔍</div><div class="empty-title">未找到匹配內容</div></div>';
    return;
  }
  c.innerHTML=results.map(m=>{
    const preview=m.content.slice(0,150);
    const highlighted=preview.replace(new RegExp(keyword,'gi'),match=>`<mark style="background:var(--warning);color:black;padding:0 2px;border-radius:2px">${match}</mark>`);
    return `<div class="card" onclick="jumpToMessage('${m.id}')">
      <div class="card-cover" style="background:${m.role==='user'?'var(--primary)':'var(--bg-tertiary)'}">${m.role==='user'?'👤':'🤖'}</div>
      <div class="card-info">
        <div class="card-header"><div class="card-title">${m.role==='user'?'用戶':'AI'}</div><div class="card-time">${fmtDate(m.createdAt)}</div></div>
        <div class="card-preview">${highlighted}...</div>
      </div>
    </div>`;
  }).join('');
}
function showAdvancedSearch(){
  document.getElementById('adv-search-keyword').value=document.getElementById('content-search').value;
  showModal('advanced-search-modal');
}
function doAdvancedSearch(){
  const keyword=document.getElementById('adv-search-keyword').value.trim().toLowerCase();
  const scope=document.getElementById('adv-search-scope').value;
  const caseSensitive=document.getElementById('adv-search-case').checked;
  if(!keyword){toast('請輸入關鍵詞','warning');return;}
  
  closeModal('advanced-search-modal');
  const c=document.getElementById('search-results');
  
  let filtered=msgs;
  if(scope==='user')filtered=msgs.filter(m=>m.role==='user');
  else if(scope==='ai')filtered=msgs.filter(m=>m.role==='assistant');
  
  const results=filtered.filter(m=>{
    const content=caseSensitive?m.content:m.content.toLowerCase();
    const search=caseSensitive?keyword:keyword.toLowerCase();
    return content.includes(search);
  });
  
  if(!results.length){
    c.innerHTML='<div class="empty"><div class="empty-icon">🔍</div><div class="empty-title">未找到匹配內容</div></div>';
    return;
  }
  
  c.innerHTML=`<div style="padding:8px;color:var(--text-secondary);font-size:13px">找到 ${results.length} 條結果</div>`+results.map(m=>{
    const preview=m.content.slice(0,150);
    return `<div class="card" onclick="jumpToMessage('${m.id}')">
      <div class="card-cover" style="background:${m.role==='user'?'var(--primary)':'var(--bg-tertiary)'}">${m.role==='user'?'👤':'🤖'}</div>
      <div class="card-info">
        <div class="card-header"><div class="card-title">${m.role==='user'?'用戶':'AI'}</div><div class="card-time">${fmtDate(m.createdAt)}</div></div>
        <div class="card-preview">${esc(preview)}...</div>
      </div>
    </div>`;
  }).join('');
}
function jumpToMessage(msgId){
  goBack();
  setTimeout(()=>{
    const el=document.querySelector(`.msg[data-id="${msgId}"]`);
    if(el){el.scrollIntoView({behavior:'smooth',block:'center'});el.style.animation='highlight 1s';}
  },300);
}

// 時間軸
async function renderTimeline(){
  if(!story)return;
  const c=document.getElementById('timeline-content');
  const tl=await db.timeline.where('storyId').equals(story.id).sortBy('order');
  let html=`<div class="timeline-current"><span>📅</span><span class="timeline-label">當前時間：</span><span class="timeline-value">${esc(story.storyTime||'未設定')}</span></div>`;
  if(!tl.length)html+='<div class="empty" style="padding:40px 20px"><div class="empty-icon">📅</div><div class="empty-title">時間軸為空</div></div>';
  else{
    html+='<div class="timeline-list">';
    tl.forEach(t=>{
      const cur=t.timeLabel===story.storyTime;
      const evts=(t.events||[]).map(e=>`<div class="timeline-event"><div class="timeline-event-dot"></div><span>${esc(e)}</span></div>`).join('');
      html+=`<div class="timeline-item ${cur?'current':''}"><div class="timeline-date">${esc(t.timeLabel)} ${cur?'← 當前':''}</div><div class="timeline-events">${evts}</div></div>`;
    });
    html+='</div>';
  }
  html+='<button class="action-btn primary" style="width:100%;margin-top:16px" onclick="addTimeline()">➕ 添加時間點</button>';
  c.innerHTML=html;
}

// 時間軸功能
function addTimeline(){
  if(!story){toast('請先選擇故事','warning');return;}
  document.getElementById('timeline-label').value='';
  document.getElementById('timeline-event').value='';
  document.getElementById('timeline-set-current').checked=true;
  showModal('timeline-modal');
}
async function saveTimeline(){
  const label=document.getElementById('timeline-label').value.trim();
  const event=document.getElementById('timeline-event').value.trim();
  const setCurrent=document.getElementById('timeline-set-current').checked;
  if(!label){toast('請輸入時間標記','warning');return;}
  
  // 查找是否已存在相同時間點
  const existing=await db.timeline.where('storyId').equals(story.id).filter(t=>t.timeLabel===label).first();
  if(existing){
    // 添加事件到現有時間點
    const events=existing.events||[];
    if(event)events.push(event);
    await db.timeline.update(existing.id,{events});
  }else{
    // 創建新時間點
    const count=await db.timeline.where('storyId').equals(story.id).count();
    const tl={
      id:crypto.randomUUID(),
      storyId:story.id,
      timeLabel:label,
      events:event?[event]:[],
      order:count,
      messageId:msgs[msgs.length-1]?.id,
      createdAt:Date.now()
    };
    await db.timeline.add(tl);
  }
  
  // 設為當前時間
  if(setCurrent){
    story.storyTime=label;
    await db.stories.update(story.id,{storyTime:label});
  }
  
  closeModal('timeline-modal');
  toast('時間點已添加','success');
  renderTimeline();
}

async function timeJump(){
  if(!story){toast('請先選擇故事','warning');return;}
  showInputDialog('時間跳躍','輸入要跳轉到的時間（例如：三天後、一月十日）',async(input)=>{
    if(!input)return;
    showLoading('正在讓 AI 處理時間跳躍...');
    try{
      const prompt=`故事時間從「${story.storyTime||'未知'}」跳躍到「${input}」。
請簡短描述這段時間內可能發生的事情（2-3句話），以及當前的場景狀況。
保持與故事風格一致。`;
      const resp=await callApi(prompt);
      hideLoading();
      
      // 更新故事時間
      story.storyTime=input;
      await db.stories.update(story.id,{storyTime:input});
      
      // 添加到時間軸
      const count=await db.timeline.where('storyId').equals(story.id).count();
      await db.timeline.add({
        id:crypto.randomUUID(),
        storyId:story.id,
        timeLabel:input,
        events:['時間跳躍'],
        order:count,
        createdAt:Date.now()
      });
      
      // 添加 AI 生成的內容作為消息
      const aiMsg={id:crypto.randomUUID(),storyId:story.id,branchId:story.currentBranchId,role:'assistant',content:`───── ${input} ─────\n\n${resp.content}`,tokens:resp.tokens,createdAt:Date.now()};
      await db.messages.add(aiMsg);
      msgs.push(aiMsg);
      renderContent();
      
      toast('時間跳躍完成','success');
      renderTimeline();
    }catch(e){
      hideLoading();
      toast('時間跳躍失敗: '+e.message,'error');
    }
  });
}

// 伏筆/事件
let fTab='foreshadow';
async function renderForeshadow(){
  if(!story)return;
  const c=document.getElementById('foreshadow-content');
  if(fTab==='foreshadow'){
    const fs=await db.foreshadowing.where('storyId').equals(story.id).toArray();
    const unres=fs.filter(f=>!f.isResolved),res=fs.filter(f=>f.isResolved);
    let html='<div class="section-title"><span>📌</span><span>未回收的伏筆</span></div>';
    if(!unres.length)html+='<div style="text-align:center;padding:20px;color:var(--text-tertiary)">暫無</div>';
    else unres.forEach(f=>{const w=f.mentionCount>30;html+=`<div class="f-card ${w?'warning':''}"><div class="f-card-header"><span class="f-card-icon">${w?'⚠️':'💜'}</span><span class="f-card-title">${esc(f.title)}</span></div><div class="f-card-desc">${esc(f.description)}</div><div class="f-card-meta"><span>📍 ${esc(f.timeLabel||'')}</span><span>已過 ${f.mentionCount||0} 條對話</span></div></div>`;});
    if(res.length){html+=`<div class="section-title" style="margin-top:20px"><span>✅</span><span>已回收 (${res.length})</span></div>`;res.forEach(f=>{html+=`<div class="f-card resolved"><div class="f-card-header"><span class="f-card-icon">✓</span><span class="f-card-title">${esc(f.title)}</span></div><div class="f-card-desc">已回收</div></div>`;});}
    c.innerHTML=html;
  }else{
    const evts=await db.events.where('storyId').equals(story.id).reverse().toArray();
    let html='<div class="section-title"><span>📋</span><span>重要事件記錄</span></div>';
    if(!evts.length)html+='<div style="text-align:center;padding:40px;color:var(--text-tertiary)">暫無</div>';
    else evts.forEach(e=>{const icons={character_change:'💀',relation_change:'🤝',plot_twist:'⚡',other:'📝'};html+=`<div class="f-card"><div class="f-card-header"><span class="f-card-icon">${icons[e.eventType]||'📝'}</span><span class="f-card-title">${esc(e.title)}</span></div><div class="f-card-desc">${esc(e.description)}</div><div class="f-card-meta"><span>📍 ${esc(e.storyTime||'')}</span></div></div>`;});
    c.innerHTML=html;
  }
}
function switchFTab(t,el){fTab=t;document.querySelectorAll('#view-foreshadow .tab-btn').forEach(b=>b.classList.remove('active'));el.classList.add('active');renderForeshadow();}

// 添加伏筆或事件
function addForeshadowOrEvent(){
  if(!story){toast('請先選擇故事','warning');return;}
  if(fTab==='foreshadow'){
    showInputDialog('添加伏筆','輸入伏筆標題',async(title)=>{
      if(!title)return;
      showInputDialog('伏筆描述','描述這個伏筆的內容（可選）',async(desc)=>{
        const f={id:crypto.randomUUID(),storyId:story.id,messageId:msgs[msgs.length-1]?.id,title,description:desc||'',isResolved:false,mentionCount:0,timeLabel:story.storyTime,createdAt:Date.now()};
        await db.foreshadowing.add(f);
        toast('伏筆已添加','success');
        renderForeshadow();
      });
    });
  }else{
    showInputDialog('添加事件','輸入事件標題',async(title)=>{
      if(!title)return;
      showInputDialog('事件描述','描述這個事件（可選）',async(desc)=>{
        const e={id:crypto.randomUUID(),storyId:story.id,messageId:msgs[msgs.length-1]?.id,title,description:desc||'',eventType:'other',storyTime:story.storyTime,createdAt:Date.now()};
        await db.events.add(e);
        toast('事件已添加','success');
        renderForeshadow();
      });
    });
  }
}

// AI 分析伏筆
async function aiAnalyzeForeshadow(){
  if(!story){toast('請先選擇故事','warning');return;}
  showLoading('AI 分析中...');
  try{
    const fs=await db.foreshadowing.where('storyId').equals(story.id).filter(f=>!f.isResolved).toArray();
    const prompt=`請分析以下故事中的伏筆，判斷哪些可能需要回收，並給出回收建議：

當前伏筆：
${fs.map(f=>`- ${f.title}：${f.description||'無描述'}（已過${f.mentionCount||0}條對話）`).join('\n')}

最近的故事內容：
${msgs.slice(-10).map(m=>m.content.slice(0,200)).join('\n\n')}

請指出：
1. 哪些伏筆可能被遺忘了需要儘快回收
2. 哪些伏筆與當前劇情相關可以自然回收
3. 如何優雅地回收這些伏筆`;
    const resp=await callApi(prompt);
    hideLoading();
    showAlert('AI 伏筆分析',resp.content);
  }catch(e){
    hideLoading();
    toast('分析失敗: '+e.message,'error');
  }
}

// 顯示警告/信息彈窗
function showAlert(title,content){
  showConfirm(content,null,false,title);
}

// 存檔
async function renderSaves(){
  if(!story)return;
  const c=document.getElementById('saves-content');
  const saves=await db.saves.where('storyId').equals(story.id).reverse().toArray();
  const manual=saves.filter(s=>!s.isAuto),auto=saves.filter(s=>s.isAuto);
  let html=`<div class="section-title"><span>💾</span><span>手動存檔 (${manual.length}/8)</span></div>`;
  if(!manual.length)html+='<div style="text-align:center;padding:20px;color:var(--text-tertiary)">暫無</div>';
  else manual.forEach(s=>html+=renderSaveCard(s));
  html+=`<div class="section-title" style="margin-top:20px"><span>🔄</span><span>自動存檔 (${auto.length}/5)</span></div>`;
  if(!auto.length)html+='<div style="text-align:center;padding:20px;color:var(--text-tertiary)">暫無</div>';
  else auto.forEach(s=>html+=renderSaveCard(s,true));
  c.innerHTML=html;
}
function renderSaveCard(s,isAuto=false){
  const t=timeAgo(s.createdAt),tagCls=s.labelColor==='#EF4444'?'be':s.labelColor==='#F59E0B'?'key':'';
  return `<div class="save-card"><div class="save-card-header"><div class="save-card-title">${isAuto?`自動 #${s.slotIndex}`:`存檔 ${s.slotIndex}`}${s.label?`<span class="save-card-tag ${tagCls}">${esc(s.label)}</span>`:''}</div></div><div class="save-card-preview">${esc(s.preview||'')}</div><div class="save-card-meta"><span>📍 ${esc(s.storyTime||'')}</span><span>🕐 ${t}</span></div><div class="save-card-actions"><button class="action-btn primary" onclick="loadSave('${s.id}')">讀取</button>${isAuto?`<button class="action-btn secondary" onclick="toast('轉為手動')">轉為手動</button>`:`<button class="action-btn secondary" onclick="toast('覆蓋')">覆蓋</button>`}<button class="action-btn secondary" onclick="deleteSave('${s.id}')">🗑️</button></div></div>`;
}
async function createSave(){
  if(!story||!msgs.length){toast('沒有可保存的內容','warning');return;}
  const existing=await db.saves.where('storyId').equals(story.id).filter(s=>!s.isAuto).toArray();
  if(existing.length>=8){toast('存檔槽位已滿','warning');return;}
  const slot=existing.length+1,last=msgs[msgs.length-1];
  const save={id:crypto.randomUUID(),storyId:story.id,slotIndex:slot,isAuto:false,label:'',preview:last?.content?.slice(0,100)||'',storyTime:story.storyTime||'',branchId:story.currentBranchId,messageId:last?.id,createdAt:Date.now()};
  await db.saves.put(save);
  toast('存檔創建成功！','success');
  renderSaves();
}
async function loadSave(id){showConfirm('確定要讀取此存檔嗎？當前進度將丟失。',async()=>{showLoading('讀取存檔...');try{const s=await db.saves.get(id);if(!s)throw new Error('存檔不存在');await db.stories.update(story.id,{currentBranchId:s.branchId,currentMessageId:s.messageId,storyTime:s.storyTime});await openStory(story.id);toast('存檔讀取成功！','success');}catch(e){toast('讀取失敗: '+e.message,'error');}hideLoading();});}
async function deleteSave(id){showConfirm('確定要刪除此存檔嗎？',async()=>{await db.saves.delete(id);toast('存檔已刪除','success');renderSaves();});}

// 指令
async function renderInst(){
  const c=document.getElementById('inst-list');
  const list=await db.instructions.toArray();
  if(!list.length){c.innerHTML='<div class="empty"><div class="empty-icon">📜</div><div class="empty-title">還沒有指令</div><div class="empty-desc">導入 .md 或 .txt 文件作為設定指令</div><button class="empty-btn" onclick="importInst()">導入指令</button></div>';return;}
  c.innerHTML=list.map(i=>`<div class="inst-card"><div class="inst-header"><div class="inst-icon">📄</div><div class="inst-info"><div class="inst-name">${esc(i.name)}</div><div class="inst-meta">${fmtNum(i.content?.length||0)} 字</div><div class="inst-binding">綁定：${i.boundStoryName||'未綁定'}</div></div></div>${i.content?`<div class="inst-preview">${esc(i.content.slice(0,100))}...</div>`:''}<div class="inst-actions"><button class="action-btn secondary" onclick="toast('預覽')">預覽</button><button class="action-btn secondary" onclick="toast('編輯')">編輯</button><button class="action-btn secondary" onclick="deleteInst('${i.id}')">🗑️</button></div></div>`).join('');
}
function importInst(){
  const input=document.getElementById('file-input');
  input.onchange=async e=>{
    const f=e.target.files[0];if(!f)return;
    const content=await f.text();
    const inst={id:crypto.randomUUID(),name:f.name,content,createdAt:Date.now()};
    await db.instructions.put(inst);
    toast('指令導入成功！','success');
    renderInst();
    input.value='';
  };
  input.click();
}
async function deleteInst(id){showConfirm('確定要刪除此指令嗎？',async()=>{await db.instructions.delete(id);await db.storyInstructions.where('instructionId').equals(id).delete();toast('指令已刪除','success');renderInst();});}

// API預設
async function renderApi(){
  const c=document.getElementById('api-list');if(!c)return;
  const list=await db.apiPresets.toArray();
  if(!list.length){c.innerHTML='<div class="empty"><div class="empty-icon">🤖</div><div class="empty-title">未配置 API</div><div class="empty-desc">添加 Claude 或 OpenAI API 來開始</div><button class="empty-btn" onclick="addApi()">添加 API</button></div>';return;}
  c.innerHTML=list.map(p=>`<div class="api-card ${p.isActive?'active':''}"><div class="api-header" onclick="selectApi('${p.id}')"><span class="api-name">${esc(p.name)}</span>${p.isActive?'<span class="api-badge">使用中</span>':''}</div><div class="api-info" onclick="selectApi('${p.id}')">${p.type==='anthropic'?'Anthropic':p.type==='openai'?'OpenAI':'自定義'} · ${esc(p.model)}</div><div class="api-actions" style="display:flex;gap:8px;margin-top:10px"><button class="action-btn secondary" onclick="editApi('${p.id}')">✏️ 編輯</button><button class="action-btn secondary" onclick="deleteApi('${p.id}')" style="color:var(--error)">🗑️ 刪除</button></div></div>`).join('')+`<div style="text-align:center;margin-top:16px"><button class="action-btn primary" style="width:auto;padding:12px 24px" onclick="addApi()">➕ 添加新預設</button></div>`;
}
function addApi(){
  editApiId=null;
  document.getElementById('api-name').value='';
  document.getElementById('api-type').value='anthropic';
  document.getElementById('api-key').value='';
  document.getElementById('api-model').value='';
  document.getElementById('api-url').value='';
  // 重置自動補全復選框為選中狀態
  const autoCompleteCheckbox = document.getElementById('api-url-autocomplete');
  if(autoCompleteCheckbox) autoCompleteCheckbox.checked = true;
  updateApiFields();
  showModal('api-modal');
}
async function editApi(id){
  const p=await db.apiPresets.get(id);
  if(!p)return;
  editApiId=id;
  document.getElementById('api-name').value=p.name||'';
  document.getElementById('api-type').value=p.type||'anthropic';
  document.getElementById('api-key').value=p.apiKey||'';
  document.getElementById('api-url').value=p.url||'';
  updateApiFields();
  document.getElementById('api-model').value=p.model||'';
  // 加載自動補全設置
  const autoCompleteCheckbox = document.getElementById('api-url-autocomplete');
  if(autoCompleteCheckbox) autoCompleteCheckbox.checked = p.urlAutoComplete !== false;
  showModal('api-modal');
}
async function deleteApi(id){
  showConfirm('確定要刪除此 API 預設嗎？',async()=>{
    const p=await db.apiPresets.get(id);
    await db.apiPresets.delete(id);
    if(p&&p.isActive){
      const first=await db.apiPresets.toCollection().first();
      if(first)await db.apiPresets.update(first.id,{isActive:true});
    }
    toast('API 預設已刪除','success');
    renderApi();
  });
}
function updateApiFields(){
  const t=document.getElementById('api-type').value,m=document.getElementById('api-model'),dl=document.getElementById('model-list'),u=document.getElementById('api-url-group');
  if(t==='anthropic'){
    dl.innerHTML='<option value="claude-sonnet-4-20250514">Claude Sonnet 4</option><option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option><option value="claude-3-opus-20240229">Claude 3 Opus</option><option value="claude-3-5-haiku-20241022">Claude 3.5 Haiku</option>';
    m.placeholder='選擇或輸入模型名稱';
    u.classList.add('hidden');
  }else if(t==='openai'){
    dl.innerHTML='<option value="gpt-4o">GPT-4o</option><option value="gpt-4o-mini">GPT-4o Mini</option><option value="gpt-4-turbo">GPT-4 Turbo</option><option value="gpt-3.5-turbo">GPT-3.5 Turbo</option><option value="o1">o1</option><option value="o1-mini">o1-mini</option>';
    m.placeholder='選擇或輸入模型名稱';
    u.classList.add('hidden');
  }else{
    dl.innerHTML='';
    m.placeholder='輸入模型名稱';
    u.classList.remove('hidden');
  }
}
async function saveApi(){
  const name=document.getElementById('api-name').value.trim(),type=document.getElementById('api-type').value,apiKey=document.getElementById('api-key').value.trim(),model=document.getElementById('api-model').value.trim(),url=document.getElementById('api-url').value.trim();
  const urlAutoComplete = document.getElementById('api-url-autocomplete')?.checked ?? true;
  if(!name||!apiKey){toast('請填寫名稱和 API Key','warning');return;}
  if(!model){toast('請輸入或選擇模型','warning');return;}
  if(type==='custom'&&!url){toast('請輸入 API URL','warning');return;}
  
  // 如果是編輯，保留原本的 isActive 狀態；如果是新建，設為 true 並取消其他的激活狀態
  let isActive = true;
  if(editApiId){
    const existing = await db.apiPresets.get(editApiId);
    isActive = existing?.isActive || false;
  } else {
    // 新建時，取消其他 API 的激活狀態，讓新的成為激活狀態
    await db.apiPresets.toCollection().modify({isActive: false});
  }
  
  const p={id:editApiId||crypto.randomUUID(),name,type,apiKey,model,url:type==='custom'?url:'',urlAutoComplete,isActive,createdAt:Date.now()};
  await db.apiPresets.put(p);
  closeModal('api-modal');
  toast('API 預設已保存' + (isActive ? '（已激活）' : ''), 'success');
  renderApi();
}
async function testApi(){
  const type=document.getElementById('api-type').value,apiKey=document.getElementById('api-key').value.trim(),model=document.getElementById('api-model').value.trim(),url=document.getElementById('api-url').value.trim();
  const resultEl=document.getElementById('api-test-result');
  resultEl.style.display='block';
  resultEl.style.color='var(--text-secondary)';
  resultEl.innerHTML='<span class="typing"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></span> 測試連接中...';
  if(!apiKey){resultEl.style.color='var(--error)';resultEl.textContent='❌ 請先填寫 API Key';return;}
  if(!model){resultEl.style.color='var(--error)';resultEl.textContent='❌ 請先填寫模型名稱';return;}
  
  // 創建超時控制
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 30000);
  
  try{
    let r;
    // iOS 兼容性：明確設置 mode 和 credentials
    const fetchOptions = { 
      signal: controller.signal,
      method: 'POST',
      mode: 'cors',
      credentials: 'omit',
      cache: 'no-cache'
    };
    
    if(type==='anthropic'){
      r=await fetch('https://api.anthropic.com/v1/messages',{
        ...fetchOptions,
        headers:{
          'Content-Type':'application/json',
          'x-api-key':apiKey,
          'anthropic-version':'2023-06-01',
          'anthropic-dangerous-direct-browser-access':'true'
        },
        body:JSON.stringify({model:model,max_tokens:10,messages:[{role:'user',content:'Hi'}]})
      });
    }else if(type==='openai'){
      r=await fetch('https://api.openai.com/v1/chat/completions',{
        ...fetchOptions,
        headers:{
          'Content-Type':'application/json',
          'Authorization':`Bearer ${apiKey}`
        },
        body:JSON.stringify({model:model,messages:[{role:'user',content:'Hi'}],max_tokens:10})
      });
    }else{
      if(!url){resultEl.style.color='var(--error)';resultEl.textContent='❌ 請先填寫 API URL';return;}
      const autoComplete = document.getElementById('api-url-autocomplete')?.checked ?? true;
      const apiUrl = normalizeApiUrl(url, autoComplete);
      console.log('Testing Custom API:', url, '→', apiUrl, '(autoComplete:', autoComplete, ')');
      r=await fetch(apiUrl,{
        ...fetchOptions,
        headers:{
          'Content-Type':'application/json',
          'Authorization':`Bearer ${apiKey}`
        },
        body:JSON.stringify({model:model,messages:[{role:'user',content:'Hi'}],max_tokens:10})
      });
    }
    clearTimeout(timeoutId);
    const text = await r.text();
    console.log('Test API response:', r.status, text.slice(0, 500));
    if(r.ok){
      try {
        const d = JSON.parse(text);
        const hasValidStructure = d.choices?.[0]?.message !== undefined || d.content?.[0] !== undefined;
        if(hasValidStructure) {
          resultEl.style.color='var(--success)';
          resultEl.textContent='✅ 連接成功！API 可正常使用';
        } else {
          resultEl.style.color='var(--warning)';
          resultEl.textContent='⚠️ 連接成功但返回格式異常';
        }
      } catch(e) {
        resultEl.style.color='var(--error)';
        resultEl.textContent='❌ 返回非JSON: ' + text.slice(0, 50);
      }
    }else{
      try {
        const e = JSON.parse(text);
        resultEl.style.color='var(--error)';
        resultEl.textContent='❌ ' + (e.error?.message || `HTTP ${r.status}`);
      } catch(e) {
        resultEl.style.color='var(--error)';
        resultEl.textContent='❌ HTTP ' + r.status + ': ' + text.slice(0, 50);
      }
    }
  }catch(e){
    clearTimeout(timeoutId);
    resultEl.style.color='var(--error)';
    console.error('Test API error:', e);
    const errMsg = e.message || e.toString() || '未知錯誤';
    if(e.name === 'AbortError') {
      resultEl.innerHTML='❌ 連接超時（30秒）<br><span style="font-size:11px;color:var(--text-tertiary)">請檢查網絡或 URL 是否正確</span>';
    } else if(errMsg.includes('Load failed') || errMsg.includes('Failed to fetch') || errMsg.includes('NetworkError') || e.name === 'TypeError') {
      // 檢測是否為 iOS
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      let hint = '瀏覽器安全策略阻止了請求。';
      if(isIOS) {
        hint += '<br>iOS 設備可能需要：<br>• 檢查 Safari 設置中的「阻止跨網站追蹤」<br>• 嘗試關閉「隱私瀏覽」模式';
      }
      hint += '<br>• 確認 API 服務已開啟 CORS 支持';
      resultEl.innerHTML='❌ 連接失敗<br><span style="font-size:11px;color:var(--text-tertiary)">' + hint + '</span>';
    } else {
      resultEl.innerHTML='❌ 連接失敗: ' + errMsg;
    }
  }
}
async function selectApi(id){await db.apiPresets.toCollection().modify({isActive:false});await db.apiPresets.update(id,{isActive:true});toast('已切換 API','success');renderApi();}

// 沉浸模式
let immIdx=0,immPars=[];
function enterImm(){
  if(!msgs.length){toast('沒有內容','warning');return;}
  closeAll();
  immPars=msgs.filter(m=>m.role==='assistant').map(m=>m.content);
  immIdx=0;
  document.getElementById('immersive').classList.add('active');
  showImm();
}
function showImm(){const c=document.getElementById('immersive-content');if(immIdx<immPars.length){c.innerHTML=marked.parse(immPars[immIdx]);document.getElementById('imm-progress').style.width=((immIdx+1)/immPars.length*100)+'%';}}
function nextImm(){immIdx++;if(immIdx>=immPars.length){exitImm();return;}showImm();}
function exitImm(){document.getElementById('immersive').classList.remove('active');}

// 面板和菜單
function showSheet(){
  document.getElementById('overlay').classList.add('active');
  const sheet=document.getElementById('sheet');
  // 全屏模式下不限制寬度
  if(settings.screen==='fullscreen'){
    sheet.style.maxWidth='100%';
  }else{
    sheet.style.maxWidth='420px';
  }
  sheet.classList.add('active');
}
function showMore(e){e.stopPropagation();const m=document.getElementById('more-menu');m.style.top='100px';m.style.right='16px';m.classList.add('active');}
function showMsgMenu(e,id){e.preventDefault();e.stopPropagation();selMsgId=id;const m=document.getElementById('msg-menu');m.style.top=Math.min(e.clientY,window.innerHeight-300)+'px';m.style.left=Math.min(e.clientX,window.innerWidth-180)+'px';m.classList.add('active');}
function hideMenu(){document.querySelectorAll('.context-menu').forEach(m=>m.classList.remove('active'));}
function closeAll(){document.getElementById('overlay').classList.remove('active');document.getElementById('sheet').classList.remove('active');hideMenu();}
document.addEventListener('click',e=>{if(!e.target.closest('.context-menu')&&!e.target.closest('.nav-btn'))hideMenu();});

// Modal
function showModal(id){document.getElementById('overlay').classList.add('active');document.getElementById(id).classList.add('active');}
function closeModal(id){document.getElementById('overlay').classList.remove('active');document.getElementById(id).classList.remove('active');}
function showConfirm(msg,cb,danger=false,title='確認'){document.getElementById('confirm-title').textContent=title;document.getElementById('confirm-content').textContent=msg;document.getElementById('confirm-content').style.whiteSpace=title==='確認'?'normal':'pre-wrap';const b=document.getElementById('confirm-btn');b.className=danger?'modal-btn danger':'modal-btn confirm';b.style.display=cb?'':'none';confirmCb=cb;showModal('confirm-modal');}
function confirmAction(){closeModal('confirm-modal');if(confirmCb){confirmCb();confirmCb=null;}}
function showInputDialog(title,ph,cb){document.getElementById('input-title').textContent=title;document.getElementById('modal-input').placeholder=ph;document.getElementById('modal-input').value='';inputCb=cb;showModal('input-modal');}
function confirmInput(){const v=document.getElementById('modal-input').value.trim();closeModal('input-modal');if(inputCb){inputCb(v);inputCb=null;}}

// 消息操作
async function markForeshadow(){hideMenu();showInputDialog('標記伏筆','輸入伏筆標題',async t=>{if(!t)return;const f={id:crypto.randomUUID(),storyId:story.id,messageId:selMsgId,title:t,description:'',isResolved:false,mentionCount:0,createdAt:Date.now()};await db.foreshadowing.put(f);toast('伏筆已標記','success');});}
function copyMsg(){hideMenu();const m=msgs.find(x=>x.id===selMsgId);if(m){navigator.clipboard.writeText(m.content);toast('已複製','success');}}

// 刪除消息
function deleteMsg(){
  hideMenu();
  showConfirm('確定要刪除這條消息嗎？此操作不可撤銷。',async()=>{
    const idx=msgs.findIndex(m=>m.id===selMsgId);
    if(idx===-1)return;
    await db.messages.delete(selMsgId);
    msgs.splice(idx,1);
    const el=document.querySelector(`.msg[data-id="${selMsgId}"]`);
    if(el)el.remove();
    toast('消息已刪除','success');
  });
}

// 編輯消息
function editMsg(){
  hideMenu();
  const m=msgs.find(x=>x.id===selMsgId);
  if(!m)return;
  document.getElementById('edit-msg-content').value=m.content;
  showModal('edit-msg-modal');
}
async function saveEditMsg(){
  const content=document.getElementById('edit-msg-content').value.trim();
  if(!content){toast('內容不能為空','warning');return;}
  const m=msgs.find(x=>x.id===selMsgId);
  if(!m)return;
  m.content=content;
  await db.messages.update(selMsgId,{content});
  const el=document.querySelector(`.msg[data-id="${selMsgId}"]`);
  if(el)el.innerHTML=marked.parse(content);
  closeModal('edit-msg-modal');
  toast('消息已更新','success');
}

// 重新生成
function regenerateMsg(){
  hideMenu();
  const m=msgs.find(x=>x.id===selMsgId);
  if(!m||m.role!=='assistant'){toast('只能重新生成 AI 消息','warning');return;}
  document.getElementById('regen-note').value='';
  showModal('regen-modal');
}
async function doRegenerate(){
  closeModal('regen-modal');
  if(generating){toast('正在生成中','warning');return;}
  const note=document.getElementById('regen-note').value.trim();
  const idx=msgs.findIndex(m=>m.id===selMsgId);
  if(idx===-1)return;
  
  // 找到這條消息之前的用戶消息
  let userMsg='';
  for(let i=idx-1;i>=0;i--){
    if(msgs[i].role==='user'){userMsg=msgs[i].content;break;}
  }
  if(note)userMsg+='\n\n[補充說明：'+note+']';
  
  // 刪除當前消息
  await db.messages.delete(selMsgId);
  msgs.splice(idx,1);
  const el=document.querySelector(`.msg[data-id="${selMsgId}"]`);
  if(el)el.remove();
  
  // 重新生成
  generating=true;
  showTyping();
  try{
    const resp=await callApi(userMsg);
    hideTyping();
    const aiMsg={id:crypto.randomUUID(),storyId:story.id,branchId:story.currentBranchId,role:'assistant',content:resp.content,tokens:resp.tokens,createdAt:Date.now()};
    await db.messages.add(aiMsg);
    msgs.push(aiMsg);
    await typewriter(aiMsg);
    toast('重新生成完成','success');
  }catch(e){
    hideTyping();
    toast('生成失敗: '+e.message,'error');
  }
  generating=false;
}

// 回溯到此
function rollbackTo(){
  hideMenu();
  const idx=msgs.findIndex(m=>m.id===selMsgId);
  if(idx===-1)return;
  const deleteCount=msgs.length-idx-1;
  if(deleteCount===0){toast('已經是最新消息','info');return;}
  showConfirm(`確定要回溯到此消息嗎？將刪除之後的 ${deleteCount} 條消息。`,async()=>{
    const toDelete=msgs.slice(idx+1).map(m=>m.id);
    await db.messages.bulkDelete(toDelete);
    msgs=msgs.slice(0,idx+1);
    renderContent();
    toast('已回溯','success');
  });
}

// 記憶管理
function showMemoryManager(){
  closeAll();
  if(!story){toast('請先選擇故事','warning');return;}
  document.getElementById('memory-msg-count').textContent=msgs.length;
  document.getElementById('memory-compressed').textContent=story.compressedCount||0;
  document.getElementById('memory-summary-count').textContent=story.summaries?.length||0;
  showModal('memory-modal');
}
async function compressMemory(){
  const option=document.getElementById('compress-count').value;
  let count=parseInt(option)||10;
  if(option==='all')count=Math.max(0,msgs.length-20);
  if(count<=0){toast('沒有可壓縮的消息','info');closeModal('memory-modal');return;}
  
  showLoading('壓縮記憶中...');
  try{
    // 獲取要壓縮的消息
    const toCompress=msgs.slice(0,count);
    const summary='【記憶摘要】\n'+toCompress.map(m=>(m.role==='user'?'用戶：':'AI：')+m.content.slice(0,100)).join('\n');
    
    // 刪除舊消息
    const ids=toCompress.map(m=>m.id);
    await db.messages.bulkDelete(ids);
    msgs=msgs.slice(count);
    
    // 保存摘要到故事
    const summaries=story.summaries||[];
    summaries.push({content:summary,createdAt:Date.now(),count});
    await db.stories.update(story.id,{summaries,compressedCount:(story.compressedCount||0)+count});
    story.summaries=summaries;
    story.compressedCount=(story.compressedCount||0)+count;
    
    renderContent();
    hideLoading();
    closeModal('memory-modal');
    toast(`已壓縮 ${count} 條消息`,'success');
  }catch(e){
    hideLoading();
    toast('壓縮失敗: '+e.message,'error');
  }
}

// 查找替換
function showFindReplace(){
  closeAll();
  if(!story){toast('請先選擇故事','warning');return;}
  document.getElementById('find-text').value='';
  document.getElementById('replace-text').value='';
  document.getElementById('find-result').textContent='';
  showModal('find-replace-modal');
}
function findNext(){
  const find=document.getElementById('find-text').value;
  if(!find){toast('請輸入查找內容','warning');return;}
  const caseSensitive=document.getElementById('find-case-sensitive').checked;
  let count=0;
  msgs.forEach(m=>{
    const content=caseSensitive?m.content:m.content.toLowerCase();
    const search=caseSensitive?find:find.toLowerCase();
    const matches=(content.match(new RegExp(search.replace(/[.*+?^${}()|[\]\\]/g,'\\\\$&'),'g'))||[]).length;
    count+=matches;
  });
  document.getElementById('find-result').textContent=`找到 ${count} 處匹配`;
}
async function replaceAll(){
  const find=document.getElementById('find-text').value;
  const replace=document.getElementById('replace-text').value;
  if(!find){toast('請輸入查找內容','warning');return;}
  
  const caseSensitive=document.getElementById('find-case-sensitive').checked;
  const regex=new RegExp(find.replace(/[.*+?^${}()|[\]\\]/g,'\\\\$&'),caseSensitive?'g':'gi');
  let count=0;
  
  for(const m of msgs){
    const newContent=m.content.replace(regex,(match)=>{count++;return replace;});
    if(newContent!==m.content){
      m.content=newContent;
      await db.messages.update(m.id,{content:newContent});
    }
  }
  
  if(count>0){
    renderContent();
    document.getElementById('find-result').textContent=`已替換 ${count} 處`;
    toast(`已替換 ${count} 處`,'success');
  }else{
    document.getElementById('find-result').textContent='未找到匹配內容';
  }
}

// 統計面板
function showStats(){
  closeAll();
  if(!story){toast('請先選擇故事','warning');return;}
  
  let totalChars=0,userChars=0,aiChars=0,totalTokens=0;
  msgs.forEach(m=>{
    totalChars+=m.content.length;
    if(m.role==='user')userChars+=m.content.length;
    else aiChars+=m.content.length;
    totalTokens+=(m.tokens||0);
  });
  
  document.getElementById('stats-chars').textContent=fmtNum(totalChars);
  document.getElementById('stats-msgs').textContent=msgs.length;
  document.getElementById('stats-tokens').textContent=fmtNum(totalTokens);
  document.getElementById('stats-time').textContent=Math.round((story.statistics?.playTimeMinutes||0)/60)+'h';
  document.getElementById('stats-user-chars').textContent=fmtNum(userChars);
  document.getElementById('stats-ai-chars').textContent=fmtNum(aiChars);
  
  showModal('stats-modal');
}

// 導出故事
function exportStory(){
  closeAll();
  if(!story){toast('請先選擇故事','warning');return;}
  
  let content='# '+story.title+'\n\n';
  if(story.description)content+='> '+story.description+'\n\n';
  content+='---\n\n';
  
  msgs.forEach(m=>{
    if(m.role==='user')content+='**【玩家】** '+m.content+'\n\n';
    else content+=m.content+'\n\n---\n\n';
  });
  
  const blob=new Blob([content],{type:'text/markdown'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=story.title+'.md';
  a.click();
  URL.revokeObjectURL(url);
  toast('故事已導出','success');
}

// ============ 章節管理 ============
async function renderChapters(){
  if(!story)return;
  const c=document.getElementById('chapter-list');
  const chapters=await db.chapters.where('storyId').equals(story.id).sortBy('order');
  if(!chapters.length){
    c.innerHTML='<div class="empty"><div class="empty-icon">📑</div><div class="empty-title">暫無章節</div><div class="empty-desc">點擊右上角添加章節標記</div></div>';
    return;
  }
  c.innerHTML=chapters.map((ch,i)=>{
    const msg=msgs.find(m=>m.id===ch.messageId);
    const preview=msg?.content?.slice(0,50)||'';
    return `<div class="card" onclick="jumpToChapter('${ch.id}')">
      <div class="card-cover" style="background:linear-gradient(135deg,var(--primary),var(--info))">📑</div>
      <div class="card-info">
        <div class="card-header"><div class="card-title">${esc(ch.title)}</div><div class="card-time">${fmtDate(ch.createdAt)}</div></div>
        <div class="card-preview">${esc(preview)}...</div>
        <div class="card-meta"><span class="card-stats">第 ${i+1} 章</span></div>
      </div>
    </div>`;
  }).join('')+'<button class="action-btn secondary" style="width:100%;margin-top:12px" onclick="addChapter()">➕ 添加章節</button>';
}
function addChapter(){
  if(!story){toast('請先選擇故事','warning');return;}
  if(!selMsgId&&msgs.length>0)selMsgId=msgs[msgs.length-1].id;
  document.getElementById('chapter-title').value='';
  showModal('chapter-modal');
}
async function saveChapter(){
  const title=document.getElementById('chapter-title').value.trim();
  if(!title){toast('請輸入章節標題','warning');return;}
  const chapters=await db.chapters.where('storyId').equals(story.id).toArray();
  const ch={id:crypto.randomUUID(),storyId:story.id,messageId:selMsgId||msgs[msgs.length-1]?.id,title,order:chapters.length,createdAt:Date.now()};
  await db.chapters.add(ch);
  closeModal('chapter-modal');
  toast('章節已添加','success');
  renderChapters();
}
async function jumpToChapter(chId){
  const ch=await db.chapters.get(chId);
  if(!ch)return;
  goBack();
  setTimeout(()=>{
    const el=document.querySelector(`.msg[data-id="${ch.messageId}"]`);
    if(el)el.scrollIntoView({behavior:'smooth',block:'center'});
  },300);
}

// ============ 書籤管理 ============
async function renderBookmarks(){
  if(!story)return;
  const c=document.getElementById('bookmark-list');
  const bookmarks=await db.bookmarks.where('storyId').equals(story.id).reverse().sortBy('createdAt');
  if(!bookmarks.length){
    c.innerHTML='<div class="empty"><div class="empty-icon">🔖</div><div class="empty-title">暫無書籤</div><div class="empty-desc">長按消息可添加書籤</div></div>';
    return;
  }
  c.innerHTML=bookmarks.map(bm=>{
    const msg=msgs.find(m=>m.id===bm.messageId);
    const preview=msg?.content?.slice(0,80)||'';
    return `<div class="card" onclick="jumpToBookmark('${bm.id}')">
      <div class="card-cover" style="background:linear-gradient(135deg,var(--warning),var(--primary))">🔖</div>
      <div class="card-info">
        <div class="card-header"><div class="card-title">${esc(bm.name)}</div><div class="card-time">${fmtDate(bm.createdAt)}</div></div>
        <div class="card-preview">${esc(preview)}...</div>
      </div>
      <div style="position:absolute;right:12px;top:50%;transform:translateY(-50%)" onclick="event.stopPropagation();deleteBookmark('${bm.id}')">🗑️</div>
    </div>`;
  }).join('');
}
function addBookmark(){
  hideMenu();
  if(!selMsgId){toast('請先選擇消息','warning');return;}
  document.getElementById('bookmark-name').value='';
  showModal('bookmark-modal');
}
async function saveBookmark(){
  const name=document.getElementById('bookmark-name').value.trim()||'書籤 '+(await db.bookmarks.where('storyId').equals(story.id).count()+1);
  const bm={id:crypto.randomUUID(),storyId:story.id,messageId:selMsgId,name,createdAt:Date.now()};
  await db.bookmarks.add(bm);
  closeModal('bookmark-modal');
  toast('書籤已添加','success');
}
async function jumpToBookmark(bmId){
  const bm=await db.bookmarks.get(bmId);
  if(!bm)return;
  goBack();
  setTimeout(()=>{
    const el=document.querySelector(`.msg[data-id="${bm.messageId}"]`);
    if(el){el.scrollIntoView({behavior:'smooth',block:'center'});el.style.animation='highlight 1s';}
  },300);
}
async function deleteBookmark(id){await db.bookmarks.delete(id);toast('書籤已刪除','success');renderBookmarks();}

// ============ 劇情標籤 ============
function addPlotTag(){
  hideMenu();
  if(!selMsgId){toast('請先選擇消息','warning');return;}
  document.getElementById('tag-note').value='';
  showModal('tag-modal');
}
async function savePlotTag(){
  const type=document.getElementById('tag-type').value;
  const note=document.getElementById('tag-note').value.trim();
  const tag={id:crypto.randomUUID(),storyId:story.id,messageId:selMsgId,type,note,createdAt:Date.now()};
  await db.plotTags.add(tag);
  closeModal('tag-modal');
  toast('標籤已添加','success');
  // 在消息上顯示標籤
  const el=document.querySelector(`.msg[data-id="${selMsgId}"]`);
  if(el){
    const labels={key:'🔑關鍵',scene:'🎬名場面',clue:'🔍線索',turning:'🔄轉折',emotion:'💕情感'};
    let tagEl=el.querySelector('.plot-tags');
    if(!tagEl){tagEl=document.createElement('div');tagEl.className='plot-tags';tagEl.style.cssText='margin-top:8px;display:flex;gap:4px;flex-wrap:wrap';el.appendChild(tagEl);}
    tagEl.innerHTML+=`<span style="font-size:10px;padding:2px 6px;background:var(--bg-tertiary);border-radius:4px;color:var(--primary)">${labels[type]||type}</span>`;
  }
}

// ============ 分支管理 ============
async function renderBranches(){
  if(!story)return;
  const c=document.getElementById('branch-list');
  const branches=await db.branches.where('storyId').equals(story.id).toArray();
  if(!branches.length){
    // 創建默認主分支
    const main={id:'branch_main',storyId:story.id,name:'主線',description:'',parentBranchId:null,createdAt:Date.now()};
    await db.branches.add(main);
    branches.push(main);
  }
  c.innerHTML=branches.map(br=>{
    const isActive=br.id===story.currentBranchId;
    return `<div class="card ${isActive?'selected':''}" onclick="switchBranch('${br.id}')">
      <div class="card-cover" style="background:linear-gradient(135deg,${isActive?'var(--success)':'var(--bg-tertiary)'},var(--primary))">🔀</div>
      <div class="card-info">
        <div class="card-header"><div class="card-title">${esc(br.name)}</div>${isActive?'<span class="api-badge">當前</span>':''}</div>
        <div class="card-preview">${esc(br.description||'無描述')}</div>
        <div class="card-meta"><span class="card-stats">${fmtDate(br.createdAt)}</span></div>
      </div>
    </div>`;
  }).join('')+'<button class="action-btn primary" style="width:100%;margin-top:12px" onclick="createBranch()">➕ 創建新分支</button>';
}
function createBranch(){
  if(!story){toast('請先選擇故事','warning');return;}
  document.getElementById('branch-name').value='';
  document.getElementById('branch-desc').value='';
  showModal('branch-modal');
}
async function saveBranch(){
  const name=document.getElementById('branch-name').value.trim();
  if(!name){toast('請輸入分支名稱','warning');return;}
  const desc=document.getElementById('branch-desc').value.trim();
  const br={id:crypto.randomUUID(),storyId:story.id,name,description:desc,parentBranchId:story.currentBranchId,forkMessageId:msgs[msgs.length-1]?.id,createdAt:Date.now()};
  await db.branches.add(br);
  // 複製當前分支的消息到新分支
  const currentMsgs=await db.messages.where('[storyId+branchId]').equals([story.id,story.currentBranchId]).toArray();
  const newMsgs=currentMsgs.map(m=>({...m,id:crypto.randomUUID(),branchId:br.id}));
  await db.messages.bulkAdd(newMsgs);
  closeModal('branch-modal');
  toast('分支已創建','success');
  renderBranches();
}
async function switchBranch(brId){
  if(brId===story.currentBranchId)return;
  story.currentBranchId=brId;
  await db.stories.update(story.id,{currentBranchId:brId});
  msgs=await db.messages.where('[storyId+branchId]').equals([story.id,brId]).sortBy('createdAt');
  renderContent();
  toast('已切換分支','success');
  renderBranches();
}

// ============ AI 功能 ============
function aiConsistencyCheck(){
  if(!story||!msgs.length){toast('請先選擇有內容的故事','warning');return;}
  document.getElementById('ai-check-result').textContent='點擊「開始檢查」進行分析...';
  showModal('ai-check-modal');
}
async function doAiConsistencyCheck(){
  const resultEl=document.getElementById('ai-check-result');
  resultEl.textContent='分析中，請稍候...';
  
  const prompt=`你是一個故事一致性檢查助手。請分析以下故事內容，檢查是否存在：
1. 設定矛盾（角色性格、能力、背景不一致）
2. 時間線錯誤（事件順序不合理）
3. 角色行為不一致（與之前建立的性格不符）
4. 邏輯漏洞（情節不合理）

請列出發現的問題，並給出具體位置和修改建議。如果沒有問題，請說明故事整體一致性良好。

故事內容：
${msgs.slice(-30).map(m=>(m.role==='user'?'【玩家】':'【AI】')+m.content).join('\n\n')}`;

  try{
    const resp=await callApi(prompt);
    resultEl.textContent=resp.content;
  }catch(e){
    resultEl.textContent='檢查失敗: '+e.message;
  }
}

function aiChapterSummary(){
  if(!story||!msgs.length){toast('請先選擇有內容的故事','warning');return;}
  document.getElementById('ai-summary-result').textContent='點擊「生成總結」開始...';
  showModal('ai-summary-modal');
}
async function doAiChapterSummary(){
  const resultEl=document.getElementById('ai-summary-result');
  resultEl.textContent='生成中，請稍候...';
  
  const prompt=`請為以下故事內容生成一個簡潔的章節總結，包括：
1. 主要事件概述（3-5句話）
2. 重要角色狀態變化
3. 關鍵決策點
4. 未解決的伏筆/懸念

故事內容：
${msgs.slice(-50).map(m=>(m.role==='user'?'【玩家】':'【AI】')+m.content).join('\n\n')}`;

  try{
    const resp=await callApi(prompt);
    resultEl.textContent=resp.content;
  }catch(e){
    resultEl.textContent='生成失敗: '+e.message;
  }
}
function copySummary(){
  const text=document.getElementById('ai-summary-result').textContent;
  navigator.clipboard.writeText(text);
  toast('已複製到剪貼板','success');
}

function aiSuggestions(){
  if(!story||!msgs.length){toast('請先選擇有內容的故事','warning');return;}
  document.getElementById('ai-suggest-result').textContent='點擊「獲取建議」開始...';
  showModal('ai-suggest-modal');
}
async function doAiSuggestions(){
  const resultEl=document.getElementById('ai-suggest-result');
  resultEl.textContent='思考中，請稍候...';
  
  const prompt=`基於以下故事的當前進展，請為玩家提供 3-5 個可能的行動建議。每個建議應該：
1. 符合當前情境
2. 有不同的風險/收益傾向
3. 能推動劇情發展

請用簡潔的方式列出建議，每個建議附上簡短的可能後果預測。

當前故事進展：
${msgs.slice(-20).map(m=>(m.role==='user'?'【玩家】':'【AI】')+m.content).join('\n\n')}`;

  try{
    const resp=await callApi(prompt);
    resultEl.textContent=resp.content;
  }catch(e){
    resultEl.textContent='獲取建議失敗: '+e.message;
  }
}

// 數據導入導出
async function exportAll(){
  showLoading('導出中...');
  try{
    const data={version:'3.0',exportedAt:Date.now(),stories:await db.stories.toArray(),messages:await db.messages.toArray(),branches:await db.branches.toArray(),instructions:await db.instructions.toArray(),loreEntries:await db.loreEntries.toArray(),foreshadowing:await db.foreshadowing.toArray(),events:await db.events.toArray(),saves:await db.saves.toArray(),apiPresets:await db.apiPresets.toArray(),settings:await db.settings.toArray()};
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;a.download=`zhimeng_backup_${new Date().toISOString().slice(0,10)}.json`;a.click();
    URL.revokeObjectURL(url);
    toast('數據導出成功！','success');
  }catch(e){toast('導出失敗: '+e.message,'error');}
  hideLoading();
}
function importAll(){
  const input=document.getElementById('import-input');
  input.onchange=async e=>{
    const f=e.target.files[0];if(!f)return;
    showLoading('導入中...');
    try{
      const text=await f.text(),data=JSON.parse(text);
      if(!data.version||!data.stories)throw new Error('無效的備份文件');
      if(data.stories)await db.stories.bulkPut(data.stories);
      if(data.messages)await db.messages.bulkPut(data.messages);
      if(data.branches)await db.branches.bulkPut(data.branches);
      if(data.instructions)await db.instructions.bulkPut(data.instructions);
      if(data.loreEntries)await db.loreEntries.bulkPut(data.loreEntries);
      if(data.foreshadowing)await db.foreshadowing.bulkPut(data.foreshadowing);
      if(data.events)await db.events.bulkPut(data.events);
      if(data.saves)await db.saves.bulkPut(data.saves);
      if(data.apiPresets)await db.apiPresets.bulkPut(data.apiPresets);
      if(data.settings)await db.settings.bulkPut(data.settings);
      await loadSettings();await renderStories();await renderInst();
      toast('數據導入成功！','success');
    }catch(e){toast('導入失敗: '+e.message,'error');}
    hideLoading();input.value='';
  };
  input.click();
}
function clearAll(){showConfirm('確定要清空所有數據嗎？此操作不可恢復！',async()=>{showLoading('清空中...');try{await db.delete();await initDB();await renderStories();await renderInst();toast('數據已清空','success');}catch(e){toast('清空失敗: '+e.message,'error');}hideLoading();},true);}

// Toast & Loading
function toast(msg,type=''){const t=document.getElementById('toast');document.getElementById('toast-text').textContent=msg;t.className='toast active '+type;setTimeout(()=>t.classList.remove('active'),2500);}
function showLoading(txt='處理中...'){document.getElementById('loading-text').textContent=txt;document.getElementById('loading').classList.add('active');}
function hideLoading(){document.getElementById('loading').classList.remove('active');}

// 工具函數
function esc(t){if(!t)return'';const d=document.createElement('div');d.textContent=t;return d.innerHTML;}
function fmtNum(n){return n>=10000?(n/10000).toFixed(1)+'萬':n.toLocaleString();}
function timeAgo(ts){const d=Date.now()-ts,m=Math.floor(d/60000),h=Math.floor(d/3600000),dy=Math.floor(d/86400000);if(m<1)return'剛剛';if(m<60)return m+'分鐘前';if(h<24)return h+'小時前';if(dy<7)return dy+'天前';const dt=new Date(ts);return(dt.getMonth()+1)+'/'+dt.getDate();}

console.log('織夢 v3.0 - AI互動小說閱讀器 準備就緒！');

// PWA 支持
let deferredPrompt = null;

// 註冊 Service Worker (使用內嵌方式)
if ('serviceWorker' in navigator) {
  const swCode = `
    const CACHE_NAME = 'zhimeng-v3';
    const urlsToCache = [self.location.href];
    
    self.addEventListener('install', e => {
      e.waitUntil(
        caches.open(CACHE_NAME)
          .then(cache => cache.addAll(urlsToCache))
          .then(() => self.skipWaiting())
      );
    });
    
    self.addEventListener('activate', e => {
      e.waitUntil(
        caches.keys().then(names => 
          Promise.all(names.filter(n => n !== CACHE_NAME).map(n => caches.delete(n)))
        ).then(() => self.clients.claim())
      );
    });
    
    self.addEventListener('fetch', e => {
      if (e.request.method !== 'GET') return;
      e.respondWith(
        caches.match(e.request).then(cached => {
          const fetchPromise = fetch(e.request).then(response => {
            if (response.ok) {
              const clone = response.clone();
              caches.open(CACHE_NAME).then(cache => cache.put(e.request, clone));
            }
            return response;
          }).catch(() => cached);
          return cached || fetchPromise;
        })
      );
    });
  `;
  
  const swBlob = new Blob([swCode], {type: 'application/javascript'});
  const swUrl = URL.createObjectURL(swBlob);
  
  navigator.serviceWorker.register(swUrl, {scope: './'})
    .then(reg => console.log('ServiceWorker 註冊成功:', reg.scope))
    .catch(err => console.log('ServiceWorker 註冊失敗 (正常，本地文件可能不支持):', err));
}

// 創建並注入 manifest
const manifest = {
  "name": "織夢 - AI互動小說閱讀器",
  "short_name": "織夢",
  "description": "AI互動小說閱讀器 - 創建你的專屬故事",
  "start_url": "./",
  "display": "standalone",
  "background_color": "#0F0F1A",
  "theme_color": "#8B7CF7",
  "orientation": "portrait",
  "icons": [
    {
      "src": "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect fill='%238B7CF7' width='512' height='512' rx='80'/><text x='256' y='340' text-anchor='middle' fill='white' font-size='280' font-family='serif'>織</text></svg>",
      "sizes": "512x512",
      "type": "image/svg+xml",
      "purpose": "any maskable"
    },
    {
      "src": "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%238B7CF7' width='192' height='192' rx='30'/><text x='96' y='130' text-anchor='middle' fill='white' font-size='110' font-family='serif'>織</text></svg>",
      "sizes": "192x192",
      "type": "image/svg+xml"
    }
  ]
};

const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
const manifestUrl = URL.createObjectURL(manifestBlob);
const manifestLink = document.createElement('link');
manifestLink.rel = 'manifest';
manifestLink.href = manifestUrl;
document.head.appendChild(manifestLink);

// 監聽安裝提示事件
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  // 更新安裝狀態顯示
  const statusEl = document.getElementById('pwa-install-status');
  if (statusEl) statusEl.textContent = '可安裝 ›';
  // 顯示安裝提示
  showInstallBanner();
});

// 監聽安裝完成
window.addEventListener('appinstalled', () => {
  console.log('PWA 已安裝');
  deferredPrompt = null;
  const statusEl = document.getElementById('pwa-install-status');
  if (statusEl) statusEl.textContent = '✓ 已安裝';
});

// 顯示安裝提示橫幅
function showInstallBanner() {
  // 檢查是否已經安裝或已經顯示過
  if (window.matchMedia('(display-mode: standalone)').matches) return;
  if (localStorage.getItem('pwa-install-dismissed')) return;
  
  const banner = document.createElement('div');
  banner.id = 'install-banner';
  banner.innerHTML = `
    <div style="position:fixed;bottom:80px;left:16px;right:16px;max-width:388px;margin:0 auto;background:linear-gradient(135deg,var(--primary-dark),var(--primary));padding:16px;border-radius:12px;box-shadow:0 4px 20px rgba(139,124,247,0.4);z-index:1000;display:flex;align-items:center;gap:12px;">
      <div style="font-size:32px">📱</div>
      <div style="flex:1">
        <div style="font-size:14px;font-weight:600;color:white;margin-bottom:4px">安裝到主畫面</div>
        <div style="font-size:12px;color:rgba(255,255,255,0.8)">像 App 一樣使用織夢</div>
      </div>
      <button onclick="installPWA()" style="padding:8px 16px;background:white;color:var(--primary);border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer">安裝</button>
      <button onclick="dismissInstallBanner()" style="padding:8px;background:transparent;color:rgba(255,255,255,0.8);border:none;font-size:18px;cursor:pointer">×</button>
    </div>
  `;
  document.body.appendChild(banner);
}

// 調試 API 連接
async function debugApiTest() {
  const testUrl = 'https://api.deepseek.com/v1/chat/completions';
  const info = {
    userAgent: navigator.userAgent,
    platform: navigator.platform,
    isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent),
    isAndroid: /Android/.test(navigator.userAgent),
    isSafari: /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent),
    isChrome: /Chrome/.test(navigator.userAgent),
    location: window.location.href,
    protocol: window.location.protocol,
    online: navigator.onLine
  };
  
  let result = `📱 設備信息：\n`;
  result += `• 平台: ${info.platform}\n`;
  result += `• iOS: ${info.isIOS}\n`;
  result += `• Safari: ${info.isSafari}\n`;
  result += `• Chrome: ${info.isChrome}\n`;
  result += `• 在線: ${info.online}\n`;
  result += `• 協議: ${info.protocol}\n\n`;
  
  result += `🔗 測試連接到: ${testUrl}\n\n`;
  
  // 測試 1: 簡單 GET 請求
  result += `測試 1: HEAD 請求...\n`;
  try {
    const r1 = await fetch(testUrl, { method: 'HEAD', mode: 'cors' });
    result += `✅ HEAD 成功: ${r1.status}\n\n`;
  } catch(e) {
    result += `❌ HEAD 失敗: ${e.name} - ${e.message}\n\n`;
  }
  
  // 測試 2: POST 請求（無 body）
  result += `測試 2: POST 請求（無認證）...\n`;
  try {
    const r2 = await fetch(testUrl, { 
      method: 'POST', 
      mode: 'cors',
      credentials: 'omit',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({})
    });
    const t2 = await r2.text();
    result += `✅ POST 狀態: ${r2.status}\n`;
    result += `響應: ${t2.slice(0, 100)}...\n\n`;
  } catch(e) {
    result += `❌ POST 失敗: ${e.name} - ${e.message}\n`;
    result += `錯誤類型: ${e.constructor.name}\n\n`;
  }
  
  // 測試 3: 測試另一個 API
  const testUrl2 = 'https://httpbin.org/post';
  result += `測試 3: httpbin.org（CORS 測試服務）...\n`;
  try {
    const r3 = await fetch(testUrl2, { 
      method: 'POST', 
      mode: 'cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ test: 'hello' })
    });
    const t3 = await r3.text();
    result += `✅ httpbin 成功: ${r3.status}\n`;
    result += `響應: ${t3.slice(0, 80)}...\n\n`;
  } catch(e) {
    result += `❌ httpbin 失敗: ${e.name} - ${e.message}\n\n`;
  }
  
  // 顯示結果
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.style.cssText = 'max-width:90%;max-height:80vh;overflow:auto;white-space:pre-wrap;font-family:monospace;font-size:12px;text-align:left;';
  modal.innerHTML = `
    <div class="modal-title">🔧 API 調試結果</div>
    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;margin-bottom:16px;max-height:50vh;overflow:auto;">${result}</div>
    <div class="modal-actions">
      <button class="modal-btn confirm" onclick="this.closest('.modal').remove();document.getElementById('overlay').classList.remove('active')">關閉</button>
    </div>
  `;
  document.getElementById('overlay').classList.add('active');
  document.body.appendChild(modal);
}

// 安裝 PWA
async function installPWA() {
  if (!deferredPrompt) {
    // 對於 iOS，顯示手動安裝指引
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    if (isIOS) {
      showModal('ios-install-modal');
    } else {
      toast('請使用瀏覽器菜單中的「加入主畫面」功能', 'info');
    }
    dismissInstallBanner();
    return;
  }
  
  deferredPrompt.prompt();
  const result = await deferredPrompt.userChoice;
  console.log('安裝結果:', result.outcome);
  deferredPrompt = null;
  dismissInstallBanner();
  
  if (result.outcome === 'accepted') {
    toast('🎉 安裝成功！', 'success');
  }
}

// 關閉安裝橫幅
function dismissInstallBanner() {
  const banner = document.getElementById('install-banner');
  if (banner) banner.remove();
  localStorage.setItem('pwa-install-dismissed', 'true');
}

// 檢測是否以 PWA 模式運行
if (window.matchMedia('(display-mode: standalone)').matches) {
  console.log('正在以 PWA 模式運行');
  // 更新安裝狀態
  setTimeout(() => {
    const statusEl = document.getElementById('pwa-install-status');
    if (statusEl) statusEl.textContent = '✓ 已安裝';
  }, 100);
}

// 更新狀態欄時間
function updateStatusTime() {
  const now = new Date();
  const hours = now.getHours().toString().padStart(2, '0');
  const mins = now.getMinutes().toString().padStart(2, '0');
  const timeEl = document.getElementById('status-time');
  if (timeEl) timeEl.textContent = `${hours}:${mins}`;
}
updateStatusTime();
setInterval(updateStatusTime, 60000);
</script>
</body>
</html>
